// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell_abap/bootstrap/evo/abap.xhrlogon.LibLoader","./abap.bootstrap.utils","./abap.request.startup","./abap.request.pageset","./abap.xhrlogon.handler","./abap.theme.handler","sap/ushell/EventHub","sap/ui/performance/trace/initTraces","sap/base/util/ObjectPath","sap/base/Log","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell/bootstrap/common/common.util","./SAPCompanionConditionSetter"],function(e,t,a,n,r,i,o,s,l,u,c,p,g){"use strict";var f={};var m=new RegExp("^(#)?([A-Za-z0-9_]+)-([A-Za-z0-9_]+)"),h,d;function v(e){function t(e){if(!e){return false}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0||e.indexOf("Action-search")===0}function a(){return window["sap-ushell_abap-bootstrap-abap-noInitialTarget"]!==undefined}var n=e.match(m);var r=n&&n[2];var i=n&&n[3];var o=e&&!t(e)&&!a()&&r&&i;return o}function b(){var e,a=t.getLocationHref(),n=a.indexOf("#");if(n<0){return""}e=decodeURI(a.slice(n+1));return e}function P(){var e=b(),t=e.indexOf("&/");return t<0?e:e.slice(0,t)}function S(){return sap.ui.require("sap/ushell/Container")}function C(e){var t=e.match(m);return t?{semanticObject:t[2],action:t[3]}:undefined}function y(e){if(!e||e==="#"){return true}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0}function F(e){if(e===undefined){return undefined}try{return JSON.parse(JSON.stringify(e))}catch(e){u.error("Could not clone object",null,"sap.ushell_abap.bootstrap");return undefined}}function A(e){return e.indexOf("sap_")===0}function T(e,t){u.debug("setSapui5Settings()",JSON.stringify(e),"sap.ushell_abap.bootstrap.abap");const a=sap.ui.require("sap/base/i18n/Formatting");const n=sap.ui.require("sap/base/i18n/Localization");if(e.language){n.setLanguage(e.language,e.ABAPLanguage)}if(e.legacyDateFormat){a.setABAPDateFormat(e.legacyDateFormat)}if(e.legacyDateCalendarCustomizing){a.setCustomIslamicCalendarData(e.legacyDateCalendarCustomizing)}if(e.legacyNumberFormat){a.setABAPNumberFormat(e.legacyNumberFormat)}if(e.legacyTimeFormat){a.setABAPTimeFormat(e.legacyTimeFormat)}if(typeof t==="object"){a.addCustomCurrencies(t)}if(e.useTimeZoneIana&&e.timeZoneIana!==""){n.setTimezone(e.timeZoneIana)}}function w(e){(l.get("sap-ushell-config.services.Container.adapter.config")||l.create("sap-ushell-config.services.Container.adapter.config")).bootTheme=F(e)}function _(e){if(!e){u.error("extractSystemThemeRoot: mandatory parameter oStartupServiceResult not supplied")}if(e.themeRoot){return e.themeRoot}if(e.client){u.warning("Theme root was not contained in startup service result. A fallback to /sap/public/bc/themes/~client-<client number> is used",null,"sap.ushell_abap.bootstrap");return"/sap/public/bc/themes/~client-"+e.client}u.error("extractSystemThemeRoot: Could not determine system theme root")}function x(e){var t,a;if(e&&e.userProfile&&e.userProfile.filter){t=e.userProfile.filter(function(e){return e.id==="THEME"});a=t.length?t[0]:{};if(a.value){return a.value}}if(e&&e.theme){return e.theme}return""}function L(e,t){if(e&&A(e)){return""}return t}function I(e,t){var a;a=x(e);return{theme:a,root:L(a,t)}}function O(e){var a,n;a=t.getUrlParameterValue("sap-theme")||t.getUrlParameterValue("sap-ui-theme");if(a){if(a.indexOf("@")>0){n=a.split("@",2);return{theme:n[0],root:n[1]}}return{theme:a,root:L(a,e)}}return undefined}function R(){const e=c.getParameterMap();return e["sap-theme"]?.[0]||e["sap-ui-theme"]?.[0]}function D(e){var t=e;var a=e.indexOf("@");if(a>=0){var n=t.slice(a+1);return i.isThemeRootSafe(n)}return true}function H(e,t){var a;var n={};var r;var i=R();if(i&&D(i)){a=O(t);r=a;u.debug(`theme: URL theme = "${r.theme}"  theme root = "${r.root}"`,null,"sap.ushell_abap.bootstrap")}else if(e){r=e;u.debug(`theme: startup service theme = "${r.theme}"  theme root = "${r.root}"`,null,"sap.ushell_abap.bootstrap");if(i){const e=r.theme;sap.ui.require("sap/ui/core/Core").ready(()=>sap.ui.require("sap/ui/core/Theming").setTheme(e))}}else{n.theme=l.get("sap-ui-config.theme");if(n.theme){n.root=l.get("sap-ui-config.themeRoots."+n.theme||"");if(!n.root){n.root=L(n.theme,t)}r={theme:n.theme,root:n.root};u.debug(`theme: html file theme = "${r.theme}"  theme root = "${r.root}"`,null,"sap.ushell_abap.bootstrap")}else{r={theme:"",root:""};u.error("Could not determine theme",null,"sap.ushell_abap.bootstrap")}}w(r);return r}function M(e){const a=c.getParameterMap();const n=t.getUrlParameterValue("sap-locale",a);const r={services:{}};const i=l.get("sap-ushell-config.services.SupportTicket.config.enabled");if(i!==false){r.services.SupportTicket={config:{enabled:e.isEmbReportingActive===true}}}r.services.ClientSideTargetResolution={adapter:{config:{services:{targetMappings:e?.services?.targetMappings}}}};r.services.LaunchPage={adapter:{config:{services:{targetMappings:e?.services?.targetMappings,launchPage:e?.services?.pbFioriHome}}}};r.services.VisualizationDataProvider={adapter:{module:"sap.ushell_abap.adapters.abap.FlpLaunchPageAdapter",config:{services:{targetMappings:e?.services?.targetMappings,launchPage:e?.services?.pbFioriHome}}}};r.services.PageBuilding={adapter:{config:{services:{pageBuilding:e?.services?.pbFioriHome}}}};r.services.Personalization={adapter:{config:{services:{personalization:e?.services?.personalization}}}};let o={};if(!n){o={language:e.languageBcp47||e.language,ABAPLanguage:e.language,legacyDateFormat:e.dateFormat,legacyDateCalendarCustomizing:e.tislcal,legacyNumberFormat:e.numberFormat===""?" ":e.numberFormat,legacyTimeFormat:e.timeFormat}}let s=l.get("sap-ushell-config.ui5.timeZoneFromServerInUI5");if(s===undefined){s=false;l.set("startupConfig.timeZoneFromServerInUI5",s,r);l.set("ushell.ui5.timeZoneFromServerInUI5",s)}let u=l.get("sap-ushell-config.startupConfig.timeZone");if(u===undefined){u="";l.set("startupConfig.timeZone",u,r)}o.useTimeZoneIana=s;o.timeZoneIana=u;const g=p.getV2ServiceMigrationConfig(r);p.mergeConfig(window["sap-ushell-config"],g,true);p.mergeConfig(window["sap-ushell-config"],r,true);H(d,h);T(o,e.currencyFormats)}function q(e){var t=f._getShellHash(),n=b(),r=C(t),i=[r],o={},s={},u;var c=l.get("sap-ushell-config.services.AppState.config")||l.create("sap-ushell-config.services.AppState.config");var p=l.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||l.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");function g(e,t){var a=t.match(e);var n=[];if(!a){return}n=a[2].toString().split("=");s[n[0]]=n[1]}function m(e,t,a,n,r){if(t&&t[r]&&a&&a[n]){e[a[n]]=t[r]}}if(v(t)){g(/(\?|&)(sap-xapp-state=[A-Z0-9]+)/,t);g(/(\?|&)(sap-intent-param=[A-Z0-9]+)/,t);g(/(\?|&)(sap-system=[A-Z0-9]+)/,t);g(/(\?|&|[/])(sap-iapp-state=[A-Z0-9]+)/,n);u=a.requestDirectStart(e,r,s);c.initialAppStatesPromise=u.then(function(e){m(o,e,s,"sap-intent-param","iparState");m(o,e,s,"sap-iapp-state","iappState");m(o,e,s,"sap-xapp-state","xappState");c.initialAppStates=o;return Promise.resolve(o)});p.initialSegmentPromise=u.then(function(e){if(e.targetMappings){return Promise.resolve([i,e.targetMappings,e.systemAliases,e.urlTemplates])}return Promise.resolve(null)})}else{c.initialAppStatesPromise=Promise.resolve({});p.initialSegmentPromise=Promise.resolve(null)}}function z(){var e=new Promise(function(e,t){var a,n;n=function(){u.info("Direct application start: resolving component waitFor promise after shell renderer created event fired.");e();S().detachRendererCreatedEvent(n)};o.once("ShellNavigationInitialized").do(function(){a=S().getRendererInternal();if(a){u.info("Direct application start: resolving component waitFor promise immediately (shell renderer already created).");e()}else{S().attachRendererCreatedEvent(n)}})});return e}function Z(){g.run().catch(()=>{u.info("SAPCompanion conditions could not be set.")});var t=f._getShellHash();if(y(t)&&window["sap-ushell-config"].ushell&&window["sap-ushell-config"].ushell.spaces&&window["sap-ushell-config"].ushell.spaces.enabled){f._loadPage(t)}e.getLib().then(function(e){var t=e.FrameLogonManager.getInstance();S().oFrameLogonManager=t});if(v(t)){var a,n;window["sap-ushell-async-libs-promise-directstart"]=new Promise(function(e,t){a=e;n=t});window["sap-ushell-async-libs-promise-directstart"].catch(function(e){});S().getServiceAsync("NavTargetResolutionInternal").then(function(e){e.resolveHashFragment("#"+f._getShellHash()).done(function(e){sap.ui.require(["sap/ushell/services/AppConfiguration"],function(r){r.setCurrentApplication(e);if(e&&e.ui5ComponentName){S().getServiceAsync("Ui5ComponentLoader").then(function(r){r.createComponent(e,C(t),z(),"Application").done(function(e){a({resolvedHashFragment:e,dependenciesLoaded:true})}).fail(function(e){n(e)})})}else{a({resolvedHashFragment:e,dependenciesLoaded:false})}})}).fail(function(e){n(e)})})}}function N(e){if(e&&e.indexOf("Shell-appfinder")===0){return}S().getServiceAsync("PersonalizationV2").then(async function(e){var t={container:"sap.ushell.cdm3-1.personalization",item:"data"};var a={validity:"Infinity",keyCategory:e.KeyCategory.GENERATED_KEY,writeFrequency:e.WriteFrequency.HIGH,clientStorageAllowed:false};const n=await e.getPersonalizer(t,a);return n.getPersData()});sap.ui.require(["sap/ushell/components/pages/controller/PagesAndSpaceId"],function(t){var a=t.getPageAndSpaceId(e);var n=S().getServiceAsync("PagePersistence");Promise.all([a,n]).then(function(e){var t=e[0];var a=e[1];a.getPage(t.pageId)}).catch(function(e){u.error(e)})})}function E(e){r.initXhrLogon(window["sap-ushell-config"]);s();a.requestStartupConfig().then(function(e){var t=f._getShellHash();(l.get("sap-ushell-config.services.Container.adapter")||l.create("sap-ushell-config.services.Container.adapter")).config=e;var r=l.get("sap-ushell-config.services.LaunchPage.adapter.config")||l.create("sap-ushell-config.services.LaunchPage.adapter.config");var i=l.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||l.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");if(l.get("sap-ushell-config.ushell.spaces.enabled")){l.set("sap-ushell-config.services.VisualizationDataProvider.adapter.config",r);l.set("sap-ushell-config.services.NavigationDataProvider.adapter.config",i)}q(e);h=_(e);d=I(e,h);if(!R()&&d){u.debug("theme: load theme from startup service via window",null,"sap.ushell_abap.bootstrap")}if(y(t)&&!l.get("sap-ushell-config.ushell.spaces.enabled")){n.requestPageSet(e)}var o=a.requestFullTM(e);i.navTargetDataPromise=o;r.compactTMPromise=o;l.set("sap-ushell-config.services.FlpLaunchPage.adapter.config.compactTMPromise",o);return Promise.resolve(e)},function(e){u.error("start_up request failed: "+e,null,"sap.ushell_abap.bootstrap");return Promise.resolve({})}).then(function(t){M(t);e()})}f.start=E;f.afterBootstrap=Z;f._getShellHash=P;f._getFullShellHash=b;f._createWaitForRendererCreatedPromise=z;f._loadPage=N;return f});
//# sourceMappingURL=boottask.js.map