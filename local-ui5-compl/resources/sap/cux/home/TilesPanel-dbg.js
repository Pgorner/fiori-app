/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
"use strict";sap.ui.define(["sap/f/GridContainer","sap/f/GridContainerItemLayoutData","sap/m/Button","sap/m/CustomListItem","sap/m/Dialog","sap/m/HBox","sap/m/HeaderContainer","sap/m/IllustratedMessage","sap/m/Label","sap/m/List","sap/m/ObjectIdentifier","sap/m/Title","sap/m/library","sap/ui/core/EventBus","sap/ui/core/Icon","sap/ui/core/Lib","sap/ui/core/dnd/DragDropInfo","sap/ui/core/library","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/Container","sap/ushell/api/S4MyHome","./BasePanel","./MenuItem","./utils/AppManager","./utils/Constants","./utils/Device","./utils/DragDropUtils","./utils/FESRUtil"],function(t,e,i,n,s,a,o,r,l,d,c,u,g,p,h,m,f,I,v,_,y,S,T,A,P,F,M,D,B){"use strict";function C(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function x(t,e){try{var i=t()}catch(t){return e(t)}if(i&&i.then){return i.then(void 0,e)}return i}const z=g["ButtonType"];const b=I["dnd"];const E=C(T);const $=C(A);const w=C(P);const H=F["DEFAULT_BG_COLOR"];const L=F["END_USER_COLORS"];const R=F["MYHOME_PAGE_ID"];const V=F["MYINSIGHT_SECTION_ID"];const U=F["SETTINGS_PANELS_KEYS"];const N=M["DeviceType"];const j=M["fetchElementProperties"];const k=D["attachKeyboardHandler"];const O=B["addFESRId"];const W=B["addFESRSemanticStepName"];const G=B["FESR_EVENTS"];var K=function(t){t["REFRESH"]="tiles-refresh";t["ADD_APPS"]="tiles-addSmartApps";t["EDIT_TILES"]="tiles-editTiles";return t}(K||{});var Y=function(t){t["Standard"]="standard";t["StandardWide"]="standardWide";return t}(Y||{});const J=()=>_.last("/core/shell/enablePersonalization")||_.last("/core/catalog/enabled");const q=E.extend("sap.cux.home.TilesPanel",{metadata:{library:"sap.cux.home",properties:{title:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"},key:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"},fullScreenName:{type:"string",group:"Misc",defaultValue:"SI1",visibility:"hidden"}},defaultAggregation:"tiles",aggregations:{tiles:{type:"sap.cux.home.App",multiple:true,singularName:"tile",visibility:"hidden"}},events:{handleHidePanel:{parameters:{}},handleUnhidePanel:{parameters:{}}}},constructor:function t(e,i){E.prototype.constructor.call(this,e,i);this._insightsSectionTitle=this._i18nBundle.getText("insights");this._addFromFavDialogId=`${this.getId()}-addFromFavDialog`},init:function t(){try{const t=this;E.prototype.init.call(t);t._controlMap=new Map;t._oData={tiles:[],activateInsightsTiles:true};t._controlModel=new v(t._oData);t.appManagerInstance=w.getInstance();t.setProperty("title",`${t._i18nBundle?.getText("insights")} ${t._i18nBundle.getText("insightsTilesTitle")}`);const e=new $(K.REFRESH,{title:t._i18nBundle.getText("refresh"),icon:"sap-icon://refresh",press:()=>void t.refreshData(true)});O(e,"tilesRefresh");const n=new $(K.ADD_APPS,{title:t._i18nBundle.getText("addSmartApps"),icon:"sap-icon://duplicate",press:()=>void t._handleAddFromFavApps()});O(n,"smartAppsDialog");const s=new $(K.EDIT_TILES,{title:t._i18nBundle.getText("editLinkTiles"),icon:"sap-icon://edit",press:e=>t.handleEditTiles(e)});O(s,"manageTiles");t.menuItems=[e,n,s];const a=new i({id:`${t.getId()}-addTilesButton`,text:t._i18nBundle.getText("appFinderLink"),press:()=>void t._handleAddFromFavApps()});O(a,"smartAppsDialog");t.actionButtons=[a];t._setupHeader();return Promise.resolve(y.getServiceAsync("VisualizationInstantiation")).then(function(e){t.VizInstantiationService=e;t.oEventBus=p.getInstance();t.oEventBus.subscribe("importChannel","tilesImport",function(e,i,n){try{return Promise.resolve(t.appManagerInstance.createInsightSection(t._i18nBundle.getText("insightsTiles"))).then(function(){return Promise.resolve(t._addSectionViz(n,V)).then(function(){t._adjustLayout();t._importdone()})})}catch(t){return Promise.reject(t)}},t);t._toggleTileActivity()})}catch(t){return Promise.reject(t)}},_toggleTileActivity:function t(){const e=this;const i=function(t){try{const i=t.getParameter("isMyHomeRoute");e._controlModel.setProperty("/activateInsightsTiles",i);const n=function(){if(i){return Promise.resolve(e.refreshData(true)).then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}};S.attachRouteMatched({},i,this)},_addSectionViz:function t(e,i){return e.reduce((t,e)=>t.then(()=>{if(e.isBookmark){return this.appManagerInstance.addBookMark(e)}else{return i?this.appManagerInstance.addVisualization(e.vizId,i):this.appManagerInstance.addVisualization(e.vizId)}}),Promise.resolve())},_importdone:function t(){const e={status:true};this.oEventBus.publish("importChannel","tilesImported",e)},_setupHeader:function t(){this.menuItems.forEach(t=>this.addAggregation("menuItems",t));this.actionButtons.forEach(t=>this.addAggregation("actionButtons",t));this.setProperty("enableFullScreen",true)},renderPanel:function t(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;try{let i=false;const n=this;function s(t){return i?t:Promise.resolve()}const a=x(function(){if(!n.tilesContainer||e){n._createWrapperFlexBox();return Promise.resolve(n.refreshData()).then(function(t){i=true;return t})}},function(t){n.fireHandleHidePanel()});return Promise.resolve(a&&a.then?a.then(s):s(a))}catch(o){return Promise.reject(o)}},refreshData:function t(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;try{const t=this;return Promise.resolve(t.appManagerInstance.fetchInsightApps(true,t._insightsSectionTitle)).then(function(i){function n(){t._controlModel.setProperty("/tiles",t.aInsightsApps);if(t.aInsightsApps?.length){t.fireHandleUnhidePanel();if(e&&t.tilesContainer){const e=t.tilesContainer.getMetadata().getDefaultAggregationName();const i=t.tilesContainer.getAggregation(e)||[];i.forEach(t=>t.refresh?.())}t.fireHandleUnhidePanel();t._getInsightsContainer().updatePanelsItemCount(t.aInsightsApps.length,t.getMetadata().getName());if(t.getProperty("title")){t.setProperty("title",`${t._i18nBundle?.getText("insights")} ${t._i18nBundle.getText("insightsTilesTitle")} (${t.aInsightsApps.length})`)}}else{t.fireHandleHidePanel()}t._adjustLayout()}t.aInsightsApps=i;const s=t.aInsightsApps.some(t=>t.isSmartBusinessTile);const a=function(){if(s){return Promise.resolve(m.load({name:"sap.cloudfnd.smartbusiness.lib.reusetiles"})).then(function(){})}}();return a&&a.then?a.then(n):n(a)})}catch(t){return Promise.reject(t)}},_createWrapperFlexBox:function i(){if(!this.tilesContainer){if(this.getDeviceType()===N.Mobile){this.tilesContainer=new o(`${this.getId()}-insightsTilesMobileContainer`,{scrollStep:0,scrollStepByItem:1,gridLayout:true,scrollTime:1e3,showDividers:false}).addStyleClass("sectionMarginTopTilesInsight sapMHeaderContainerAlign sapMHeaderContainerMarginBottom tilesBoxShadow")}else{this.tilesContainer=new t(`${this.getId()}-insightsTilesContainer`,{}).addStyleClass("insightTiles sapUiSmallMarginTop sapUiSmallMarginBottom")}this.tilesContainer.setModel(this._controlModel);const i=this.tilesContainer.getMetadata().getDefaultAggregationName();this.tilesContainer.bindAggregation(i,{path:"/tiles",factory:(t,i)=>{const n=i.getObject(),s=this.VizInstantiationService.instantiateVisualization(n.visualization);s.setLayoutData?.(new e({minRows:2,columns:s.getDisplayFormat?.()===Y.Standard?2:4}));s?.bindProperty?.("active","/activateInsightsTiles");return s}});this.tilesContainer.addDragDropConfig(new f({sourceAggregation:"items",targetAggregation:"items",dropPosition:b.DropPosition.Between,dropLayout:b.DropLayout.Horizontal,drop:t=>this._handleTilesDnd(t)})).attachBrowserEvent("keydown",t=>{const e=t.metaKey||t.ctrlKey;void k(t,e,t=>this._handleTilesDnd(t))})}this._addContent(this.tilesContainer)},_handleTilesDnd:function t(e){const i=e.getParameter?.("dropPosition"),n=e?.getParameter?.("draggedControl"),s=e.getParameter("droppedControl"),a=n.getParent()?.indexOfItem(n);let o=n.getParent()?.indexOfItem(s);if(i==="Before"&&a===o-1){o--}else if(i==="After"&&a===o+1){o++}if(a!==o){void this._DragnDropTiles(a,o,i)}},_DragnDropTiles:function t(e,i,n){try{const t=this;if(n==="Before"&&e<i){i--}else if(n==="After"&&e>i){i++}const s=t.aInsightsApps[i],a=t.aInsightsApps.splice(e,1)[0];t.aInsightsApps.splice(i,0,a);const o={pageId:R,sourceSectionIndex:a.persConfig?.sectionIndex,sourceVisualizationIndex:a.persConfig?.visualizationIndex,targetSectionIndex:s.persConfig?.sectionIndex,targetVisualizationIndex:s.persConfig?.visualizationIndex};t._controlModel.setProperty("/tiles",t.aInsightsApps);return Promise.resolve(t.appManagerInstance.moveVisualization(o)).then(function(){return Promise.resolve(t.renderPanel(true)).then(function(){})})}catch(t){return Promise.reject(t)}},handleEditTiles:function t(e){let i=e.getSource().getParent()||this;if(i?.isA("sap.cux.home.TilesPanel")){i=i.getParent()}i?._getLayout().openSettingsDialog(U.INSIGHTS_TILES)},handleRemoveActions:function t(){this.setProperty("title","");this.setProperty("enableSettings",false);this.setProperty("enableFullScreen",false);this.removeAllAggregation("actionButtons");this.removeAllAggregation("menuItems")},handleAddActions:function t(){this.setProperty("title",`${this._i18nBundle?.getText("insights")} ${this._i18nBundle.getText("insightsTilesTitle")} (${this.aInsightsApps.length})`);this.setProperty("enableSettings",true);this.setProperty("enableFullScreen",true);this._setupHeader()},_closeAddFromFavDialog:function t(){this._controlMap.get(this._addFromFavDialogId)?.close()},navigateToAppFinder:function t(e){try{return Promise.resolve(y.getServiceAsync("Navigation")).then(function(t){const i={pageID:R,sectionID:V};if(e){i.sectionID=e}return Promise.resolve(t.navigate({target:{shellHash:`Shell-appfinder?&/catalog/${JSON.stringify(i)}`}})).then(function(){})})}catch(t){return Promise.reject(t)}},_getLegendColor:function t(e){return L().find(t=>t.value===e)||H()},_handleAddFromFavApps:function t(){try{const t=this;return Promise.resolve(t._getFavToAdd()).then(function(e){const i=t._generateAddFromFavAppsDialog();t._controlMap.get(`${t._addFromFavDialogId}-errorMessage`)?.setVisible(e.length===0);t._generateAddFromFavAppsListItems(e);i.open()})}catch(t){return Promise.reject(t)}},_getFavToAdd:function t(){try{const t=this;return Promise.resolve(t.appManagerInstance.fetchFavVizs(false,true)).then(function(e){const i=e.filter(function(t){return t.isCount||t.isSmartBusinessTile});const n=i.filter(e=>{const i=t.aInsightsApps.findIndex(function(t){return!e.visualization?.isBookmark&&t.visualization?.vizId===e.visualization?.vizId||e.visualization?.isBookmark&&t.visualization?.targetURL===e.visualization?.targetURL});return i===-1});return n})}catch(t){return Promise.reject(t)}},_getSelectedInsights:function t(){const e=this._controlMap.get(`${this._addFromFavDialogId}-list`);return e.getSelectedItems()||[]},_generateAddFromFavAppsListItems:function t(e){const i=this._addFromFavDialogId;const s=this._controlMap.get(`${i}-list`);if(e.length){s.destroyItems();const t=e.map((t,e)=>new n({id:`${i}-listItem-${e}`,content:[new a({id:`${i}-listItem-${e}-content`,alignItems:"Center",items:[new h({id:`${i}-listItem-${e}-content-icon`,src:t.icon,backgroundColor:this._getLegendColor(t.BGColor||"").value,color:"white",width:"2.25rem",height:"2.25rem",size:"1.25rem"}).addStyleClass("sapUiRoundedBorder sapUiTinyMargin"),new c({id:`${i}-listItem-${e}-content-identifier`,title:t.title,text:t.subtitle,tooltip:t.title}).addStyleClass("sapUiTinyMargin")]})]}).addStyleClass("sapUiContentPadding").data("app",t));t.forEach(t=>s.addItem(t))}s?.setVisible(e.length!==0)},_generateAddFromFavAppsDialog:function t(){const e=this._addFromFavDialogId;if(!this._controlMap.get(e)){const t=(t,e)=>{const n=new i(t,{icon:"sap-icon://action",text:this._i18nBundle.getText("appFinderBtn"),press:()=>{this._closeAddFromFavDialog();void this.navigateToAppFinder()},visible:J(),type:e||z.Default});W(n,G.PRESS,"tilesAppFinder");return n};const n=()=>{const t=this._getSelectedInsights();this._controlMap.get(`${e}-addBtn`).setEnabled(t.length>0)};this._controlMap.set(`${e}-list`,new d({id:`${e}-list`,mode:"MultiSelect",selectionChange:n}));const o=new i({id:`${e}-addBtn`,text:this._i18nBundle.getText("addBtn"),type:"Emphasized",press:()=>{void this._addFromFavApps()},enabled:false});W(o,G.PRESS,"addSmartApps");this._controlMap.set(`${e}-addBtn`,o);this._controlMap.set(`${e}-errorMessage`,new r({id:`${e}-errorMessage`,illustrationSize:"Spot",illustrationType:"sapIllus-AddDimensions",title:this._i18nBundle.getText("noAppsTitle"),description:this._i18nBundle.getText("tilesSectionNoDataDescription"),visible:true}).addStyleClass("sapUiLargeMarginTop"));this._controlMap.set(e,new s(e,{title:this._i18nBundle.getText("addSmartApps"),content:[new l({id:`${e}-label`,text:this._i18nBundle.getText("suggTileDialogLabel"),wrapping:true}).addStyleClass("sapMTitleAlign sapUiTinyMarginTopBottom sapUiSmallMarginBeginEnd"),new a({id:`${e}-textContainer`,justifyContent:"SpaceBetween",alignItems:"Center",items:[new u({id:`${e}-text`,text:this._i18nBundle.getText("suggTileDialogTitle")}),t(`${e}-addAppsBtn`,z.Transparent)]}).addStyleClass("sapUiTinyMarginTop dialogHeader sapUiSmallMarginBeginEnd"),this._controlMap.get(`${e}-list`),this._controlMap.get(`${e}-errorMessage`)],contentWidth:"42.75rem",contentHeight:"32.5rem",endButton:new i({text:this._i18nBundle.getText("closeBtn"),press:this._closeAddFromFavDialog.bind(this)}),escapeHandler:this._closeAddFromFavDialog.bind(this),buttons:[this._controlMap.get(`${e}-addBtn`),new i({id:`${e}-cancelBtn`,text:this._i18nBundle.getText("cancelBtn"),press:this._closeAddFromFavDialog.bind(this)})]}).addStyleClass("sapContrastPlus sapCuxAddFromInsightsDialog"))}return this._controlMap.get(e)},_addFromFavApps:function t(){try{const t=this;const e=t._controlMap.get(t._addFromFavDialogId);e.setBusy(true);const i=t._getSelectedInsights();return Promise.resolve(i.reduce(function(e,i){return Promise.resolve(e).then(function(){const e=i.data("app");const n={pageId:R,sourceSectionIndex:e.persConfig?.sectionIndex,sourceVisualizationIndex:e.persConfig?.visualizationIndex,targetSectionIndex:t.appManagerInstance.insightsSectionIndex,targetVisualizationIndex:-1};if(e.visualization?.displayFormatHint!=="standard"&&e.visualization?.displayFormatHint!=="standardWide"){if(e.visualization?.supportedDisplayFormats?.includes("standard")){e.visualization.displayFormatHint="standard"}else if(e.visualization?.supportedDisplayFormats?.includes("standardWide")){e.visualization.displayFormatHint="standardWide"}}if(!e.visualization?.vizId){e.visualization.vizId=e.visualization?.targetURL||""}const s=function(){if(e.visualization?.isBookmark===true){return Promise.resolve(t.appManagerInstance.addBookMark(e.visualization,n)).then(function(){})}else{return Promise.resolve(t.appManagerInstance.addVisualization(e.visualization?.vizId,V)).then(function(){})}}();if(s&&s.then)return s.then(function(){})})},Promise.resolve())).then(function(){return Promise.resolve(t.refreshData()).then(function(){e.setBusy(false);e.close()})})}catch(t){return Promise.reject(t)}},_calculateVisibleTileCount:function t(e){const i=this._getInsightsContainer()?._getLayout()?.getDomRef();const n=e||[];let s=0;if(i&&n.length){const t=i.childNodes[0];const e=j(t,["width","padding-left","padding-right"]);let a=e.width-e["padding-left"]-e["padding-right"];const o={};o[Y.Standard]=176+16;o[Y.StandardWide]=368+16;let r=o[n[s].visualization?.displayFormatHint||Y.Standard];do{a-=r;++s;r=o[n[s]&&n[s].visualization?.displayFormatHint||Y.Standard]}while(a>r)}return s||1},_adjustLayout:function t(){const e=this._getInsightsContainer()?._getLayout();const i=this.getProperty("enableFullScreen");const n=this.getDeviceType()===N.Mobile;if(e&&i){const t=n?this.aInsightsApps?.length:this._calculateVisibleTileCount(this.aInsightsApps);const i=e._getCurrentExpandedElementName()===this.getProperty("fullScreenName");this._controlModel.setProperty("/tiles",i?this.aInsightsApps:this.aInsightsApps?.slice(0,t));this._getInsightsContainer()?.toggleFullScreenElements(this,this.aInsightsApps?.length>t,i)}},_getInsightsContainer:function t(){if(!this.insightsContainer){this.insightsContainer=this.getParent()}return this.insightsContainer}});q.tilesMenuItems=K;q.DisplayFormat=Y;return q});
//# sourceMappingURL=TilesPanel-dbg.js.map