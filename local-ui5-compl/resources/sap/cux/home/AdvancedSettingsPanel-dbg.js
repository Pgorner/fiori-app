/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
"use strict";sap.ui.define(["sap/base/Log","sap/insights/CardHelper","sap/m/Button","sap/m/CheckBox","sap/m/CustomListItem","sap/m/HBox","sap/m/IconTabBar","sap/m/IconTabFilter","sap/m/Input","sap/m/Label","sap/m/library","sap/m/List","sap/m/MessageStrip","sap/m/MessageToast","sap/m/ObjectStatus","sap/m/OverflowToolbar","sap/m/Panel","sap/m/Text","sap/m/Title","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/VBox","sap/ui/core/Element","sap/ui/core/EventBus","sap/ui/core/library","sap/ui/layout/form/SimpleForm","sap/ui/model/json/JSONModel","sap/ui/unified/FileUploader","sap/ushell/Container","./BaseSettingsPanel","./utils/AppManager","./utils/Constants","./utils/FESRUtil","./utils/HttpHelper","./utils/PageManager","./utils/PersonalisationUtils","./utils/UshellPersonalizer"],function(t,e,s,n,o,i,r,a,l,p,c,d,u,h,g,m,f,I,P,x,S,T,E,v,b,C,y,B,M,_,w,z,U,A,R,F,L){"use strict";function N(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function O(t,e){try{var s=t()}catch(t){return e(t)}if(s&&s.then){return s.then(void 0,e)}return s}const D=c["FlexAlignItems"];const V=c["ToolbarStyle"];const H=b["ValueState"];const j=N(_);const k=N(w);const $=z["FEATURE_TOGGLES"];const X=z["SETTINGS_PANELS_KEYS"];const G=U["addFESRSemanticStepName"];const J=U["FESR_EVENTS"];const K=N(A);const q=N(R);const Y=N(F);const W=N(L);var Z=function(t){t["IMPORT"]="import";t["EXPORT"]="export";return t}(Z||{});const Q="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/";const tt=Q+"insights_cards_repo_srv/0001/";const et=tt+"INSIGHTS_CARDS/com.sap.gateway.srvd.ui2.insights_cards_repo_srv.v0001.importExport?";const st="AZHJGRIT78TG7Y65RF6EPFJ9U";const nt=j.extend("sap.cux.home.AdvancedSettingsPanel",{metadata:{events:{sectionsImported:{}}},init:function t(){j.prototype.init.call(this);this.setProperty("key",X.ADVANCED);this.setProperty("title",this._i18nBundle.getText("advancedSettings"));this.setProperty("icon","sap-icon://grid");this.oEventBus=v.getInstance();this.oAppManagerInstance=k.getInstance();this.oSectionsImported={};this.oUserPersonalization={export:{sections:[],fileName:"MY_HOME",sectionsSelected:false,error:false},import:{sections:[],sectionsSelected:false,error:false},selectedTab:"export",showNoImport:false};this.oControlModel=new y(this.oUserPersonalization);this.addAggregation("content",this.getContent());this.addInnerContent();this.attachPanelNavigated(()=>{const t=this;void function(){try{if(!t.oPageManagerInstance){t.oPageManagerInstance=q.getInstance(Y.getPersContainerId(t._getPanel()),Y.getOwnerComponent(t._getPanel()))}t.oEventBus.subscribe("importChannel","tilesImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("insightsTiles",!o)},t);t.oEventBus.subscribe("importChannel","appsImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("favApps",!o)},t);t.oEventBus.subscribe("importChannel","favPagesImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("pages",!o)},t);t.oEventBus.subscribe("importChannel","cardsImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("insightsCards",!o)},t);t.oDetailPage=E.getElementById(t.getProperty("key")+"-detail-page");void t._setRecommendationSettingsPanel();return Promise.resolve(t.loadUserPersonalizationData()).then(function(){t.oImportBtn.setEnabled(t.oUserPersonalization.import.sectionsSelected);t.enableDisableActions(t.oUserPersonalization.selectedTab);t.setImportExportList();t.oExportMessage.setText(t.oUserPersonalization.export.errorMessage?String(t.oUserPersonalization.export.errorMessage):"");t.oExportMessage.setType(t.oUserPersonalization.export.errorType);t.oExportMessage.setProperty("visible",t.oUserPersonalization.export.error,true);t.oFileNameInput.setValue(String(t.oUserPersonalization.export.fileName));t.oImportMessage.setText(t.oUserPersonalization.import.errorMessage?String(t.oUserPersonalization.import.errorMessage):"");t.oImportMessage.setType(t.oUserPersonalization.import.errorType);t.oImportMessage.setProperty("visible",t.oUserPersonalization.import.error,true)})}catch(t){return Promise.reject(t)}}()})},setImportExportList:function t(){if(!this.oExportList){this.oExportList=this.setExportSectionList();this._importExportPanel.addContent(this.oExportList)}else{this.oExportList.invalidate()}if(!this.oImportList){this.oImportList=this.setImportSectionList();this._importExportPanel.addContent(this.oImportList)}else{this.oImportList.invalidate()}},enableDisableActions:function t(e){this.oImportExportTab?.setSelectedKey(e);this.oImportBtn?.setVisible(e===Z.IMPORT);this.oExportBtn?.setVisible(e===Z.EXPORT);if(this.oUserPersonalization.import.sectionsSelected&&e===Z.IMPORT){this.oImportBtn.setEnabled(true)}else{this.oImportBtn.setEnabled(false)}if(e===Z.EXPORT&&this.oUserPersonalization.export.fileName&&this.oUserPersonalization.export.sections?.length&&this.oUserPersonalization.export.sectionsSelected){this.oExportBtn.setEnabled(true)}else{this.oExportBtn.setEnabled(false)}},setExportImportValues:function t(e){if(e===Z.EXPORT){this.oExportMessage.setText(this.oUserPersonalization.export.errorMessage?String(this.oUserPersonalization.export.errorMessage):"");this.oExportMessage.setType(this.oUserPersonalization.export.errorType);this.oExportMessage.setProperty("visible",this.oUserPersonalization.export.error,true)}else if(e===Z.IMPORT){this.oImportMessage.setText(this.oUserPersonalization.import.errorMessage?String(this.oUserPersonalization.export.errorMessage):"");this.oImportMessage.setType(this.oUserPersonalization.import.errorType);this.oImportMessage.setProperty("visible",this.oUserPersonalization.import.error,true)}},getContent:function t(){if(!this.oContentVBox){this.oContentVBox=new T(this.getId()+"--idAdvancedVBox",{items:[new I(this.getId()+"--idPersonalizationSubheader",{text:this._i18nBundle.getText("advancedSettingsSubheader")}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginTop"),this._getImportExportPanel()]})}return this.oContentVBox},_getImportExportPanel:function t(){if(!this._importExportPanel){this._importExportPanel=new f(`${this.getId()}-importExportPanel`,{headerToolbar:new m(`${this.getId()}-importExportPanelToolbar`,{style:V.Clear,content:[new I(`${this.getId()}-importExportPanelToolbarText`,{text:this._i18nBundle.getText("importAndExportPanelHeader")}),new S(`${this.getId()}-importExportPanelToolbarSpacer`),this._getImportButton(),this._getExportButton()]}),headerText:this._i18nBundle.getText("importAndExportPanelHeader"),expanded:true,expandable:true,content:[]}).addStyleClass("sapUiSmallMarginTop")}return this._importExportPanel},_getImportButton:function t(){if(!this.oImportBtn){this.oImportBtn=new s({id:`${this.getId()}-importBtn`,text:this._i18nBundle.getText("import"),type:"Transparent",press:()=>{void this.onImportPress()},visible:false});G(this._getExportButton(),J.PRESS,"importBtn")}return this.oImportBtn},_getExportButton:function t(){if(!this.oExportBtn){this.oExportBtn=new s({id:`${this.getId()}-exportBtn`,text:this._i18nBundle.getText("export"),type:"Transparent",press:this.onExportPress.bind(this),visible:true});G(this.oExportBtn,J.PRESS,"exportBtn")}return this.oExportBtn},addInnerContent:function t(){if(!this.oImportExportTab){this.oImportExportTab=new r(this.getId()+"--idImportExportTab",{expandable:false,backgroundDesign:"Transparent",selectedKey:this.oSelectedTab?this.oSelectedTab:"export",select:this.onImportExportTabSelect.bind(this)});const t=new a(this.getId()+"--idExportTab",{key:"export",text:this._i18nBundle.getText("exportFile")});G(t,J.SELECT,"exportTab");this.oExportMessage=new u(this.getId()+"--idExportMessageStrip",{showIcon:true,visible:false}).addStyleClass("sapUiNoMarginBegin sapUiTinyMarginBottom");const e=new I(this.getId()+"--idExportText",{text:this._i18nBundle.getText("exportText")}).addStyleClass("advancePadding");const n=new i(this.getId()+"--idFileInputContainer",{alignItems:"Center"}).addStyleClass("sapUiSmallMargin");const o=new p(this.getId()+"--idFilenameLabel",{text:this._i18nBundle.getText("exportFileNameLabel"),labelFor:"idTitleFilenameInput",required:true,showColon:true}).addStyleClass("sapUiSmallMarginEnd");this.oFileNameInput=new l(this.getId()+"--idFileNameInput",{ariaLabelledBy:["idExportText","idFilenameLabel"],required:true,width:"13rem",liveChange:this.onFileNameInputChange.bind(this),value:""});n.addItem(o);n.addItem(this.oFileNameInput);t.addContent(this.oExportMessage);t.addContent(e);t.addContent(n);const c=new a(this.getId()+"--idImportTab",{key:"import",text:this._i18nBundle.getText("importFile")});G(c,J.SELECT,"importTab");this.oImportMessage=new u(this.getId()+"--idImportMessageStrip",{text:"{advsettings>/import/errorMessage}",type:"{advsettings>/import/errorType}",showIcon:true,visible:false}).addStyleClass("sapUiNoMarginBegin sapUiTinyMarginBottom");const d=new I(this.getId()+"--idImportText",{text:this._i18nBundle.getText("importText")}).addStyleClass("advancePadding");const h=new C(this.getId()+"--idImportSimpleForm",{editable:true,layout:"ResponsiveGridLayout",labelSpanS:4,labelSpanM:4});const g=new B(this.getId()+"--idImportFileUploader",{tooltip:this._i18nBundle.getText("uploadImportFile"),fileType:["txt"],change:t=>{void this.onFileImport(t)},maximumFileSize:25,sameFilenameAllowed:true,width:"80%",ariaLabelledBy:["idImportText"],buttonText:this._i18nBundle.getText("importFileUploaderButton")});h.addContent(g);c.addContent(this.oImportMessage);c.addContent(d);c.addContent(h);const m=new a(this.getId()+"--idClassicImportTab",{key:"classicImport",text:this._i18nBundle.getText("classicImport")});G(m,J.SELECT,"classicImportTab");const f=new I(this.getId()+"--idClassicImportText",{text:this._i18nBundle.getText("classicImportText")}).addStyleClass("sapUiSmallMarginBottom advancePadding");const P=new s(this.getId()+"--resetImportAppsNow",{text:this._i18nBundle.getText("resetButton"),press:this.onResetImportApps.bind(this)}).addStyleClass("resetButtonPadding");G(P,J.PRESS,"resetImportApps");m.addContent(f);m.addContent(P);this.oImportExportTab.addItem(t);this.oImportExportTab.addItem(c);this.oImportExportTab.addItem(m);this._importExportPanel.addContent(this.oImportExportTab);this._importExportPanel.addContent(this.setExportSectionList())}},setExportSectionList:function t(){const e=new d(this.getId()+"--idExportSectionsList",{width:"calc(100% - 2rem)",growingThreshold:50,includeItemInSelection:true,visible:"{= ${advsettings>/selectedTab} === 'export'}"}).addStyleClass("sapUiSmallMarginBegin");const s=new x(this.getId()+"--idExportSectionsListToolbar",{content:[new P(this.getId()+"--idExportSectionsListHeaderText",{text:this._i18nBundle.getText("sectionExportListHeader")}).addStyleClass("sectionTitle")]});e.setHeaderToolbar(s);e.setModel(this.oControlModel,"advsettings");e.bindItems({path:"advsettings>/export/sections",template:new o({content:[new i({alignItems:"Center",items:[new n(this.getId()+"--idExportListItemCheck",{select:this.onSectionsSelectionChange.bind(this,false),selected:"{advsettings>selected}",enabled:"{advsettings>enabled}"}),new I(this.getId()+"--idExportListItemText",{text:"{advsettings>title}"}).addStyleClass("sapUiTinyMarginTop")],width:"100%"})]})});this.oExportList=e;return e},setImportSectionList:function t(){const e=new d(this.getId()+"--idImportSectionsList",{width:"calc(100% - 2rem)",growingThreshold:50,includeItemInSelection:true,visible:"{= ${advsettings>/selectedTab} === 'import' && (${advsettings>/import/sections/length} > 0 || ${advsettings>/showNoImport})}"}).addStyleClass("sapUiSmallMarginBegin");const s=new x(this.getId()+"--idImportSectionsListToolbar",{content:[new P(this.getId()+"--idImportSectionsListHeaderText",{text:this._i18nBundle.getText("sectionImportListHeader")}).addStyleClass("sectionTitle")]});e.setHeaderToolbar(s);e.setModel(this.oControlModel,"advsettings");e.bindItems({path:"advsettings>/import/sections",template:new o({content:[new i({justifyContent:"SpaceBetween",items:[new i({items:[new n(this.getId()+"--idImportListItemCheck",{select:this.onSectionsSelectionChange.bind(this,true),selected:"{advsettings>selected}",enabled:"{advsettings>enabled}"}),new I(this.getId()+"--idImportListItemText",{text:"{advsettings>title}"}).addStyleClass("sapUiTinyMarginTop")]}),new i({items:[new g(this.getId()+"--idImportItemStatus",{icon:"{= ${advsettings>status} === 'Success' ? 'sap-icon://status-positive' : 'sap-icon://status-negative' }",state:"{advsettings>status}",visible:"{= ${advsettings>status} !== 'None'}"}).addStyleClass("sapUiSmallMarginEnd sapUiTinyMarginTop")]})],width:"100%"})]})});return e},onSectionsSelectionChange:function t(e){const s=e?this.oImportList.getItems():this.oExportList.getItems();let n=false;let o,i;const r=s.some(function(t){if(!e){o=t.getAggregation("content");i=o[0].getItems()[0];n=i.getSelected()}else{o=t.getAggregation("content");const e=o[0].getItems()[0];i=e.getItems()[0];n=i.getSelected()}return n});this.oControlModel.setProperty((e?"/import":"/export")+"/sectionsSelected",r);this.enableDisableActions(e?"import":"export")},onImportPress:function e(){try{const e=this;e.attachEvent("sectionsImported",()=>{e.oDetailPage.setBusy(false);e.oControlModel.setProperty("/import/sectionsSelected",false)});e.oImportBtn.setEnabled(false);e.oDetailPage.setBusy(true);e.handleUserPersonalizationError(Z.IMPORT,false,"","");const s=e.oUserPersonalization.import.data;const n=O(function(){return Promise.resolve(e.importSections(s)).then(function(t){const s=t.some(t=>t.status===H.Error);if(s){e.handleUserPersonalizationError(Z.IMPORT,true,String(e._i18nBundle.getText("userPersonalizationImportError")),"Warning")}e.oControlModel.setProperty("/import/sections",t)})},function(s){t.error("importpress",String(s));e.handleUserPersonalizationError(Z.IMPORT,true,String(e._i18nBundle.getText("userPersonalizationImportError")),"Error")});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},importSections:function e(s){const n=[];const o=[];const i=this.oControlModel.getProperty("/import/sections");n.push(()=>this.importApps(s));n.push(()=>this.importTiles(s));n.push(()=>this.importFavPages(s));o.push(n.reduce((t,e)=>t.then(()=>e()),Promise.resolve()));o.push(this.importCards(s));return Promise.all(o).then(()=>i).catch(e=>{t.error("import failed",String(e));return[]})},importApps:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.apps&&e?.apps.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("favApps")))){this.oSectionsImported[String(this._i18nBundle.getText("favApps"))]=false;this.oEventBus.publish("importChannel","appsImport",e.apps);t()}else{this.oSectionsImported[String(this._i18nBundle.getText("favApps"))]=true;this.updateImportStatus("favApps");t()}})},importTiles:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.tiles&&e.tiles.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("insightsTiles")))){this.oSectionsImported[String(this._i18nBundle.getText("insightsTiles"))]=false;this.oEventBus.publish("importChannel","tilesImport",e.tiles);t()}else{this.oSectionsImported[String(this._i18nBundle.getText("insightsTiles"))]=true;this.updateImportStatus("insightsTiles");t()}})},importFavPages:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.favouritePages&&e.favouritePages.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("pages")))){this.oSectionsImported[String(this._i18nBundle.getText("pages"))]=false;this.oEventBus.publish("importChannel","favPagesImport",e.favouritePages);t()}else{this.oSectionsImported[String(this._i18nBundle.getText("pages"))]=true;this.updateImportStatus("pages");t()}})},importCards:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.cards&&e.cards.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("insightsCards")))){this.oSectionsImported[String(this._i18nBundle.getText("insightsCards"))]=false;this.oEventBus.publish("importChannel","cardsImport",e.cards);t()}else{this.oSectionsImported[String(this._i18nBundle.getText("insightsCards"))]=true;this.updateImportStatus("insightsCards");t()}})},updateImportStatus:function t(e,s){const n=String(this._i18nBundle.getText(e));const o=this.oControlModel.getProperty("/import/sections");const i=o.find(function(t){return t.title===n});if(i){if(s!==undefined){i.status=s?H.Error:H.Success}else{i.status=H.None}if(i.status===H.Success){i.enabled=false}}this.oSectionsImported[n]=true;const r=Object.keys(this.oSectionsImported);const a=r.every(t=>this.oSectionsImported[t]);if(a){this.fireEvent("sectionsImported")}},resetImportModel:function t(e){this.oControlModel.setProperty("/import/sections",[]);this.oControlModel.setProperty("/import/sectionsSelected",false);this.oControlModel.setProperty("/import/error",false);if(e){this.oControlModel.setProperty("/selectedTab","export");E.getElementById(this.getId()+"--idImportFileUploader")?.setValue("")}},getDeltaSectionViz:function e(s){try{const e=this;return Promise.resolve(O(function(){return Promise.resolve(e.oAppManagerInstance._getSections(true)).then(function(t){s.forEach(e=>{let s;if(e.default){s=t.find(t=>t.default)}else{s=t.find(t=>t.id===e.id)}if(s){const t=e.visualizations?.filter(t=>s.visualizations?.every(e=>e.isBookmark?e.targetURL!==t.targetURL:e.vizId!==t.vizId));e.visualizations=t}});return s})},function(e){t.error("Error occurred while fetching delta section visualizations:"+String(e));return[]}))}catch(t){return Promise.reject(t)}},getDeltaAuthSectionViz:function e(s){if(s&&s.length){return this.getDeltaSectionViz(s).then(t=>this.filterAuthSectionViz(t)).catch(e=>{t.error(String(e));return[]})}return Promise.resolve([])},filterAuthSectionViz:function t(e){try{const t=function(){return M.getServiceAsync("SearchableContent").then(function(t){return t.getApps({includeAppsWithoutVisualizations:false})})};const s=function(t,e){const s=[];e?.forEach(function(e){for(let n of t){const t=n;const o=t.visualizations.find(function(t){return t.vizId===e.vizId||e.isBookmark&&t.target&&e.target?.action===t.target.action&&e.target?.semanticObject===t.target.semanticObject});if(o){o.displayFormatHint=e.displayFormatHint!=="standard"?String(e.displayFormatHint):String(o.displayFormatHint);s.push(e.isBookmark?e:o);break}}});return s};return Promise.resolve(t().then(function(t){return e.map(function(e){e.visualizations=s(t,e.visualizations);return e})}))}catch(t){return Promise.reject(t)}},filterAuthFavPages:function t(e){try{let s=false;const n=this;function o(t){return s?t:Promise.resolve([])}const i=function(){if(e&&e.length>0){return Promise.resolve(n.oPageManagerInstance.fetchAllAvailablePages().then(function(t){return e.filter(function(e){return t.filter(function(t){return t.pageId===e.pageId&&t.spaceId===e.spaceId}).length})})).then(function(t){s=true;return t})}}();return Promise.resolve(i&&i.then?i.then(o):o(i))}catch(r){return Promise.reject(r)}},filterAuthCards:function t(e){try{let s=false;function n(t){return s?t:Promise.resolve([])}const o=function(t,e){return t.find(function(t){return t.resolutionResult&&t.resolutionResult.applicationDependencies&&e["sap.insights"]&&t.resolutionResult.applicationDependencies.name===e["sap.insights"].parentAppId})};const i=function(t,e){if(e){return t.isNavigationSupported([{target:{semanticObject:e.semanticObject,action:e.action}}]).then(function(t){return t[0].supported||false})}return Promise.resolve(false)};const r=function(){if(e&&e.length>0){return Promise.resolve(Promise.all([M.getServiceAsync("ClientSideTargetResolution"),M.getServiceAsync("Navigation")]).then(function(t){const s=t[0];const n=t[1];const r=s._oAdapter._aInbounds||[];return e.reduce(function(t,e){return Promise.resolve(t).then(function(t){const s=o(r,e);return Promise.resolve(i(n,s)).then(function(s){if(s){t.push(e)}return t})})},Promise.resolve([]))})).then(function(t){s=true;return t})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(a){return Promise.reject(a)}},onFileImport:function e(s){this.handleUserPersonalizationError(Z.IMPORT,false,"","");this.resetImportModel();this.oDetailPage.setBusy(true);const n=s.getParameter("files");const o=n&&n[0];return this.readFileContent(o).then(t=>{const e=window.btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}));return K.Post(et,{fileContent:e}).then(t=>{if(t&&t.error){throw new Error(t.error)}if(t&&t.value&&t.value.length){const e=t.value[0].fileContent;const s=JSON.parse(e);if(s.host===window.location.host){const t=s.sections||[];t.push({id:st,visualizations:s.tiles||[]});return this.filterAuthorizedImportData(t,s)}else{this.handleUserPersonalizationError(Z.IMPORT,true,String(this._i18nBundle.getText("importSourceErrorMessage")),"");return Promise.resolve()}}})}).catch(e=>{t.error(String(e));this.handleUserPersonalizationError(Z.IMPORT,true,"","")}).finally(()=>{this.oDetailPage.setBusy(false);this.enableDisableActions(Z.IMPORT)})},filterAuthorizedImportData:function t(e,s){return Promise.all([this.getDeltaAuthSectionViz(e),this.filterAuthFavPages(s.favouritePages),this.filterAuthCards(s.cards),this.getInsightCards()]).then(t=>{const e=t[0];const n=t[1];const o=t[2];const i=t[3].getProperty("/cardCount");s.apps=e.filter(function(t){return t.id!==st});s.tiles=(e.find(function(t){return t.id===st})||{}).visualizations||[];s.favouritePages=n;s.cards=o||[];const r=i+Number(o?.length);if(r>99){this.handleUserPersonalizationError(Z.IMPORT,true,String(this._i18nBundle.getText("importCardCountErrorMessage")),"")}let a=this.getImportedSections(s,Z.IMPORT,i);a=a.map(function(t){t.status=H.None;return t});this.oUserPersonalization.import.data=s;this.oControlModel.setProperty("/import/sections",a);this.oControlModel.setProperty("/import/sectionsSelected",this.getSelectedSections(a).length>0);this.oControlModel.setProperty("/showNoImport",a.length===0)})},readFileContent:function t(e){return new Promise(function(t,s){if(e&&window.FileReader){const s=new FileReader;s.onload=function(e){const s=e.target;t(s?.result)};const n=e;s.readAsText(n)}else{s(new Error("Error"))}})},_getPersonalizationData:function t(){try{const e=this;function s(){return Promise.resolve(e.oPersonalizerInstance.read()).then(function(t){e.persData=t||{};return e.persData})}const n=function(){if(!e.oPersonalizerInstance){return Promise.resolve(W.getInstance(Y.getPersContainerId(e._getPanel()),Y.getOwnerComponent(e._getPanel()))).then(function(t){e.oPersonalizerInstance=t})}}();return Promise.resolve(n&&n.then?n.then(s):s(n))}catch(o){return Promise.reject(o)}},loadUserPersonalizationData:function t(){try{const t=this;t.oExportList.setBusy(true);return Promise.resolve(t._getPersonalizationData()).then(function(e){return Promise.resolve(Promise.all([t.oAppManagerInstance._getSections(true),t.oAppManagerInstance.fetchInsightApps(true,t._i18nBundle.getText("insights")),t.getInsightCards()])).then(function(s){let[n,o,i]=s;const r=n,a=r.filter(function(t){return t.id!==st&&t.visualizations?.length});const l=i&&i.getProperty("/visibleCards")?i.getProperty("/visibleCards").map(t=>t.descriptorContent):[];const p={apps:a,tiles:o,favouritePages:e.favouritePages,cards:l,personalization:e};const c=t.getImportedSections(p,Z.EXPORT,0);t.oUserPersonalization.export.data=p;t.oUserPersonalization.export.sections=c;t.oUserPersonalization.export.sectionsSelected=t.getSelectedSections(c).length>0;t.oControlModel.refresh();t.oExportList.setBusy(false)})})}catch(t){return Promise.reject(t)}},getSelectedSections:function t(e){return e.filter(function(t){return t.selected&&t.enabled})||[]},isSectionSelected:function t(e,s){const n=e.find(function(t){return t.title===s});return!!(n&&n.selected&&n.enabled)},getImportedSections:function t(e,s,n){const o=(s===Z.IMPORT?this.getDeltaFavPages(e.favouritePages):e.favouritePages)||[],i=e.apps&&e.apps.some(function(t){return t&&t.visualizations&&t.visualizations.length>0});return[{title:this._i18nBundle.getText("favApps"),selected:i,enabled:i},{title:this._i18nBundle.getText("pages"),selected:o.length>0,enabled:o.length>0},{title:this._i18nBundle.getText("insightsTiles"),selected:e.tiles&&e.tiles.length>0,enabled:e.tiles&&e.tiles.length>0},{title:this._i18nBundle.getText("insightsCards"),selected:e.cards&&e.cards.length>0&&e.cards.length+n<=99,enabled:e.cards&&e.cards.length>0&&e.cards.length+n<=99}]},getDeltaFavPages:function t(e){const s=this.persData.favouritePages||[];if(s.length!==e.length){return e}return e.filter(function(t){return!s.find(function(e){return t.pageId===e.pageId&&t.spaceId===e.spaceId})})},getInsightCards:function t(){try{const t=this;return Promise.resolve(O(function(){return Promise.resolve(e.getServiceAsync()).then(function(e){t.cardHelperInstance=e;return Promise.resolve(t.cardHelperInstance._getUserAllCardModel()).then(function(t){const e=t.getProperty("/cards");const s=e.filter(function(t){return t.visibility});t.setProperty("/visibleCards",s);return t})})},function(t){throw t}))}catch(t){return Promise.reject(t)}},onExportPress:function e(){this.handleUserPersonalizationError(Z.EXPORT,false,"","");const s=this.oControlModel.getProperty("/export/fileName"),n=this.oControlModel.getProperty("/export/sections"),o=this.oUserPersonalization.export.data;const i=this.getExportFileContent(o,n);sap.ui.require(["sap/ui/core/util/File"],e=>{try{e.save(JSON.stringify(i),s,"txt","text/plain","utf-8");h.show(String(this._i18nBundle.getText("userPersonalizationExportSuccess")))}catch(e){t.error(e instanceof Error?e.message:String(e));if(e instanceof Error&&e?.name!==undefined&&e.name!=="AbortError"){this.handleUserPersonalizationError(Z.EXPORT,true,"","")}}})},getExportFileContent:function t(e,s){const n=e?.personalization,o={host:window.location.host,createdDate:new Date,sections:[],groupInfo:[],tiles:[],cards:[],favouritePages:[]};if(this.isSectionSelected(s,this._i18nBundle.getText("favApps"))){o.sections=e?.apps||[];o.groupInfo=n?.favoriteApps||[]}if(this.isSectionSelected(s,this._i18nBundle.getText("pages"))){o.favouritePages=n?.favouritePages||[]}if(this.isSectionSelected(s,this._i18nBundle.getText("insightsTiles"))){o.tiles=e?.tiles||[]}return o},handleUserPersonalizationError:function t(e,s,n,o){const i=this._i18nBundle.getText(e===Z.IMPORT?"importErrorMessage":"exportErrorMessage");this.oControlModel.setProperty("/"+e+"/error",s,undefined,true);this.oControlModel.setProperty("/"+e+"/errorMessage",n||i,undefined,true);this.oControlModel.setProperty("/"+e+"/errorType",o||"Error",undefined,true);this.setExportImportValues(e)},onImportExportTabSelect:function t(e){const s=e.getParameter("selectedKey");this.oSelectedTab=s;this.oControlModel.setProperty("/selectedTab",s);this.oExportList.setVisible(s==="export");this.oImportBtn.setVisible(s==="import");this.oExportBtn.setVisible(s==="export");this.oImportBtn.setEnabled(this.oUserPersonalization.import.sectionsSelected);this.oExportBtn.setEnabled(this.oUserPersonalization.export.sectionsSelected);this.oExportBtn.setEnabled(!!(this.oUserPersonalization.export.fileName&&this.oUserPersonalization.export.sections&&this.oUserPersonalization.export.sections.length>0&&this.oUserPersonalization.export.sectionsSelected))},onFileNameInputChange:function t(e){const s=e.getParameter("value")?.trim();const n=e.getSource();let o=H.None;let i="";if(!s||!s.length){o=H.Error;i=String(this._i18nBundle.getText("invalidExportFileName"))}n.setValueState(o);n.setValueStateText(i);this.oControlModel.setProperty("/export/fileName",s);this.enableDisableActions(Z.EXPORT)},onResetImportApps:function t(){this.oEventBus.publish("importChannel","resetImported")},_getRecommendationSettingsPanel:function t(){try{const t=this;return Promise.resolve(t._getPersonalizationData()).then(function(e){if(!t._recommendationSettingsPanel){const s=t.getId()+"--recommendationSettingsPanel";t._recommendationSettingsPanel=new f(s,{headerText:t._i18nBundle.getText("recommendationSettingsHeader"),expanded:true,expandable:true,content:[new I({id:`${s}-container-subHeader`,text:t._i18nBundle.getText("recommendationSettingsSubHeader")}),new i({id:`${s}-container`,items:[new n({id:`${s}-container-checkBox`,selected:e.showRecommendation??true,select:e=>t.onRecommendationSettingChange(e)}),new I({id:`${s}-container-label`,text:t._i18nBundle.getText("recommendationSettingsCheckboxLabel")})],alignItems:D.Center}).addStyleClass("sapUiSmallMarginTop")]}).addStyleClass("sapUiSmallMarginTop")}return t._recommendationSettingsPanel})}catch(t){return Promise.reject(t)}},_setRecommendationSettingsPanel:function t(){try{const t=this;t.oDetailPage.setBusy(true);return Promise.resolve(t.oAppManagerInstance.isFeatureEnabled($.RECOMMENDATION)).then(function(e){function s(){t.oDetailPage.setBusy(false)}const n=function(){if(e){return Promise.resolve(t._getRecommendationSettingsPanel()).then(function(e){t.oContentVBox.addItem(e)})}}();return n&&n.then?n.then(s):s(n)})}catch(t){return Promise.reject(t)}},onRecommendationSettingChange:function t(e){try{const t=this;const s=e.getParameter("selected");t.oEventBus.publish("importChannel","recommendationSettingChanged",{showRecommendation:s});return Promise.resolve(t._getPersonalizationData()).then(function(e){void t.oPersonalizerInstance.write({...e,showRecommendation:s})})}catch(t){return Promise.reject(t)}}});nt.ImportExportType=Z;return nt});
//# sourceMappingURL=AdvancedSettingsPanel-dbg.js.map