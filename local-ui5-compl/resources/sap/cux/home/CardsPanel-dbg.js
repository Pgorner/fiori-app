/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
"use strict";sap.ui.define(["sap/base/Log","sap/f/GridContainer","sap/f/GridContainerSettings","sap/fe/navigation/SelectionVariant","sap/insights/CardHelper","sap/insights/base/InMemoryCachingHost","sap/m/HBox","sap/m/HeaderContainer","sap/m/VBox","sap/ui/core/EventBus","sap/ui/core/dnd/DragDropInfo","sap/ui/core/library","sap/ui/integration/widgets/Card","sap/ui/model/json/JSONModel","sap/ushell/Container","sap/ushell/api/S4MyHome","./BasePanel","./MenuItem","./utils/AppManager","./utils/Constants","./utils/Device","./utils/DragDropUtils","./utils/FESRUtil","./utils/PersonalisationUtils","./utils/UshellPersonalizer"],function(e,t,n,r,s,i,a,o,c,d,l,u,h,g,f,p,m,C,P,y,v,_,S,b,I){"use strict";function M(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function E(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const A=u["dnd"];function w(e,t){try{var n=e()}catch(e){return t(true,e)}if(n&&n.then){return n.then(t.bind(null,false),t.bind(null,true))}return t(false,n)}const D=M(m);const T=M(C);const x=M(P);const H=y["FEATURE_TOGGLES"];const R=y["SETTINGS_PANELS_KEYS"];const B=v["DeviceType"];const O=v["fetchElementProperties"];const V=_["attachKeyboardHandler"];const j=S["addFESRId"];const N=M(b);const F=M(I);var L=function(e){e["REFRESH"]="cards-refresh";e["EDIT_CARDS"]="cards-editCards";return e}(L||{});const k="showRecommendation";let $=false;const z=D.extend("sap.cux.home.CardsPanel",{metadata:{library:"sap.cux.home",properties:{title:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"},key:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"},fullScreenName:{type:"string",group:"Misc",defaultValue:"SI2",visibility:"hidden"}},defaultAggregation:"cards",aggregations:{cards:{type:"sap.ui.integration.widgets.Card",multiple:true,singularName:"card",visibility:"hidden"}},events:{handleHidePanel:{parameters:{}},handleUnhidePanel:{parameters:{}}}},constructor:function e(t,n){D.prototype.constructor.call(this,t,n);this.aVisibleCardInstances=[];this.cardsInViewport=[];this._appSwitched=false;this.appManagerInstance=x.getInstance()},init:function e(){try{const e=this;D.prototype.init.call(e);e.setProperty("title",`${e._i18nBundle?.getText("insights")} ${e._i18nBundle.getText("insightsCardsTitle")}`);e.cardWidth=e.getDeviceType()===B.Mobile?"17rem":"22rem";e.cardHeight=e.getDeviceType()===B.Mobile?"25.5rem":"33rem";e._oData={userVisibleCards:[],userAllCards:[]};e._controlModel=new g(e._oData);const t=new T(`${e.getId()}-${L.REFRESH}`,{title:e._i18nBundle.getText("refresh"),icon:"sap-icon://refresh",press:()=>e.refreshCards()});j(t,"cardsRefresh");const n=new T(`${e.getId()}-${L.EDIT_CARDS}`,{title:e._i18nBundle.getText("manageCards"),icon:"sap-icon://edit",press:t=>e._handleEditCards(t)});j(n,"manageCards");e.menuItems=[t,n];e.oEventBus=d.getInstance();e.oEventBus.subscribe("importChannel","cardsImport",function(t,n,r){try{return Promise.resolve(e._createCards(r)).then(function(){return Promise.resolve(e.rerenderCards()).then(function(){e._importdone()})})}catch(e){return Promise.reject(e)}},e);e._setupHeader();return Promise.resolve(s.getServiceAsync()).then(function(t){e.cardHelperInstance=t;if(!$){e._addRuntimeHost()}e._toggleCardActivity()})}catch(e){return Promise.reject(e)}},_toggleCardActivity:function e(){const t=this;const n=function(e){try{const n=e.getParameter("isMyHomeRoute");const r=function(){if(n){const e=function(){if(t._appSwitched){return Promise.resolve(t.rerenderCards()).then(function(){t._appSwitched=false})}}();if(e&&e.then)return e.then(function(){})}else{t._appSwitched=true}}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};p.attachRouteMatched({},n,this)},_createCards:function e(t){try{const e=this;return Promise.resolve(e.cardHelperInstance?._createCards(t)).then(function(){return e.rerenderCards()})}catch(e){return Promise.reject(e)}},_getManifestEntryFromCard:function e(t,n){const r=t;const s=t.getManifestEntry(n);if(s){return Promise.resolve(s)}else{if(!r._pManifestReady){r._pManifestReady=new Promise(e=>{t.attachManifestReady(()=>{e(t.getManifestEntry(n))})})}return r._pManifestReady}},_addRuntimeHost:function e(){const t=this,n=this,r=this,s=this,a=this;this.runtimeHost=new i("runtimeHost",{action:function(e){try{const n=e.getParameter("type");let r=e.getParameter("parameters")||{};const s=function(){if(n==="Navigation"&&r.ibnTarget){e.preventDefault();const n=e.getParameter("card")||{},s=n?.getManifestEntry("sap.card")||{},i=s?.header?.actions||[];let a;if(s?.configuration?.parameters?._semanticDateRangeSetting?.value){a=JSON.parse(s.configuration.parameters._semanticDateRangeSetting.value)}if(a&&Object.keys(a).length){r=t.cardHelperInstance.processSemanticDate(r,s)}let o=t.getContentActions(s)||[];const c=i[0]||{},d=o[0]||{};const l=!!(c?.parameters&&typeof c.parameters==="string"&&c.parameters.indexOf("{= extension.formatters.addPropertyValueToAppState")>-1||d?.parameters&&typeof d.parameters==="string"&&d.parameters.indexOf("{= extension.formatters.addPropertyValueToAppState")>-1);t._manageOldCardExtension(l,e,r);return Promise.resolve(f.getServiceAsync("Navigation")).then(function(e){return Promise.resolve(e.navigate({target:r.ibnTarget,params:r.ibnParams})).then(function(){})})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},actions:[{type:"Custom",text:this._i18nBundle?.getText("refresh"),icon:"sap-icon://refresh",action:e=>{this._refreshCardData(e)},visible:function(e){try{return Promise.resolve(n._getManifestEntryFromCard(e,"sap.insights")).then(function(e){return e&&!e.cacheType})}catch(e){return Promise.reject(e)}}},{type:"Custom",text:this._i18nBundle?.getText("viewFilteredBy"),icon:"sap-icon://filter",action:e=>{const t=e.getManifestEntry("sap.app").id;this.getParent()?._getLayout().openSettingsDialog(R.INSIGHTS_CARDS,{cardId:t})},visible:function(e){try{return Promise.resolve(r._getManifestEntryFromCard(e,"sap.insights")).then(function(t){if(t){const t=e.getManifestEntry("sap.card")?.configuration?.parameters;const n=t?._relevantODataFilters?.value||[];const r=n?.length;const s=t?._relevantODataParameters?.value||[];const i=s?.length;const a=e.getManifestEntry("sap.app").dataSources;const o=a?.filterService;const c=o?.settings;return!!((r||i)&&c&&c.odataVersion==="2.0")}else{return false}})}catch(e){return Promise.reject(e)}}},{type:"Custom",text:this._i18nBundle?.getText("navigateToParent"),icon:"sap-icon://display-more",visible:function(e){try{return Promise.resolve(s._getManifestEntryFromCard(e,"sap.insights").then(function(t){try{if(t){return Promise.resolve(s.cardHelperInstance.getParentAppDetails({descriptorContent:e.getManifestEntry("/")})).then(function(e){if(e.semanticObject&&e.action){return Promise.resolve(f.getServiceAsync("Navigation")).then(function(t){const n=[{target:{semanticObject:e.semanticObject,action:e.action}}];return Promise.resolve(t.isNavigationSupported(n)).then(function(e){const t=e;return t[0].supported||false})})}else{return true}})}else{return Promise.resolve(false)}}catch(e){return Promise.reject(e)}}))}catch(e){return Promise.reject(e)}},action:function(e){try{return Promise.resolve(a.cardHelperInstance.getParentAppDetails({descriptorContent:e.getManifestEntry("/")})).then(function(e){const t=e.semanticURL||e.semanticObject;return Promise.resolve(f.getServiceAsync("Navigation")).then(function(e){return Promise.resolve(e.navigate({target:{shellHash:t}})).then(function(){})})})}catch(e){return Promise.reject(e)}}}]});$=true},_manageOldCardExtension:function e(t,n,s){if(t){const e=new r;const t=n.getParameter("card").getCombinedParameters();(t?._relevantODataParameters).forEach(e=>{if(s.ibnParams){s.ibnParams[e]=t[e]}});(t?._relevantODataFilters).forEach(n=>{const r=JSON.parse(t[n]);const i=r.SelectOptions[0];const a=i.Ranges;if(a?.length===1&&a[0].Sign==="I"&&a[0].Option==="EQ"){if(s.ibnParams){s.ibnParams[n]=a[0].Low}}else if(a?.length>0){e.massAddSelectOption(n,a)}});const i=JSON.parse(s?.ibnParams?.["sap-xapp-state-data"]);i.selectionVariant=e.toJSONObject();if(s.ibnParams){s.ibnParams["sap-xapp-state-data"]=JSON.stringify(i)}}},getContentActions:function e(t){if(t.type==="List"){return t?.content?.item?.actions}else if(t.type==="Table"){return t?.content?.row?.actions}else{return t?.content?.actions}},_importdone:function e(){const t={status:true};this.oEventBus.publish("importChannel","cardsImported",t)},_refreshCardData:function e(t){sap.ui.require(["sap/insights/base/CacheData"],e=>{const n=t.getManifestEntry("sap.app").id;const r=e.getInstance();r.clearCache(n);t.refreshData()})},_setupHeader:function e(){this.menuItems?.forEach(e=>this.addAggregation("menuItems",e));this.actionButtons?.forEach(e=>this.addAggregation("actionButtons",e));this.setProperty("enableFullScreen",true)},renderPanel:function e(){try{const e=this;return Promise.resolve(e.rerenderCards()).then(function(){})}catch(e){return Promise.reject(e)}},rerenderCards:function t(){try{const t=this;const n=w(function(){return E(function(){t.cardsContainer?.setBusy(true);return Promise.resolve(t.cardHelperInstance?._getUserVisibleCardModel()).then(function(e){const n=e.getProperty("/cards");t._controlModel.setProperty("/userVisibleCards",n);const r=function(){if(n?.length){t._showCards(n)}else{return Promise.resolve(t._checkForRecommendationCards()).then(function(){})}}();if(r&&r.then)return r.then(function(){})})},function(n){if(n instanceof Error){e.error(n.message)}t.fireHandleHidePanel()})},function(e,n){t.cardsContainer?.setBusy(false);t._adjustLayout();if(e)throw n;return n});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},_checkForRecommendationCards:function e(){try{const e=this;return Promise.resolve(e._getPersonalization()).then(function(t){e.oPersonalizer=t;return Promise.resolve(e.oPersonalizer.read()).then(function(t){let n=false;function r(t){if(n)return t;e.fireHandleHidePanel()}const s=t?.[k];const i=function(){if(s===undefined){return Promise.resolve(e.appManagerInstance.getRecommenedCards()).then(function(t){if(t){const r=e._handleRecommendationCards(t);n=true;return r}})}}();return i&&i.then?i.then(r):r(i)})})}catch(e){return Promise.reject(e)}},_handleRecommendationCards:function e(t){try{const e=this;const n=t.map(e=>e.descriptorContent);return Promise.resolve(e.cardHelperInstance?._createCards(n)).then(function(){return Promise.resolve(e._updateRecommendationStatus()).then(function(){return e.rerenderCards()})})}catch(e){return Promise.reject(e)}},_showCards:function e(r){this.fireHandleUnhidePanel();this.getParent()?.updatePanelsItemCount(r.length,this.getMetadata().getName());if(this.getProperty("title")){this.setProperty("title",`${this._i18nBundle?.getText("insights")} ${this._i18nBundle.getText("insightsCardsTitle")} (${r.length})`)}if(!this.cardsContainer){if(this.getDeviceType()===B.Mobile){this.cardsContainer=new o(`${this.getId()}-insightsCardsMobileFlexBox`,{scrollStep:0,scrollStepByItem:1,gridLayout:true,scrollTime:1e3,showDividers:false,visible:this.getDeviceType()===B.Mobile})}else{this.cardsContainerSettings=new n({columnSize:this.cardWidth,rowSize:this.cardHeight,gap:"1rem"});this.cardsContainer=new t(`${this.getId()}-insightsCardsFlexBox`,{}).addStyleClass("sapUiSmallMarginTop").setLayout(this.cardsContainerSettings)}this.cardsContainer.addDragDropConfig(new l({sourceAggregation:"items",targetAggregation:"items",dropPosition:A.DropPosition.Between,dropLayout:A.DropLayout.Horizontal,drop:e=>void this._handleCardsDnd(e)})).attachBrowserEvent("keydown",e=>{const t=e.metaKey||e.ctrlKey;void V(e,t,e=>this._handleCardsDnd(e))});this._addContent(this.cardsContainer)}else{const e=this.cardsContainer.getMetadata().getDefaultAggregationName();this.cardsContainer.removeAllAggregation(e);this.aVisibleCardInstances=[];this.cardsInViewport=[]}r.forEach(e=>{const t=e.descriptorContent;const n=new h({width:this.cardWidth,height:this.cardHeight,manifest:t,host:this.runtimeHost});this.aVisibleCardInstances.push(n);this.addAggregation("cards",n,true);const r=[n];const s=t["sap.card"].type;if(s==="Table"||s==="List"){const e=new a({width:this.cardWidth,height:"2rem"}).addStyleClass("insightsCardOverflowTop");const t=new a({height:"0"}).addStyleClass("sapMFlexBoxJustifyCenter");t.addItem(e);r.push(t)}const i=new c({direction:"Column",justifyContent:"Center",items:r});const o=this.cardsContainer.getMetadata().getDefaultAggregationName();this.cardsContainer.addAggregation(o,i)});this.cardsContainer.setBusy(false)},_handleEditCards:function e(t){let n=t.getSource().getParent()||this;if(n?.isA("sap.cux.home.CardsPanel")){n=n.getParent()}n?._getLayout().openSettingsDialog(R.INSIGHTS_CARDS)},handleRemoveActions:function e(){this.setProperty("title","");this.setProperty("enableSettings",false);this.setProperty("enableFullScreen",false);this.removeAllAggregation("actionButtons");this.removeAllAggregation("menuItems")},handleAddActions:function e(){this.setProperty("title",`${this._i18nBundle?.getText("insights")} ${this._i18nBundle.getText("insightsCardsTitle")} (${this._controlModel.getProperty("/userVisibleCards")?.length})`);this.setProperty("enableSettings",true);this.setProperty("enableFullScreen",true);this._setupHeader()},refreshCards:function e(){this.aVisibleCardInstances.forEach(e=>e.refreshData())},_handleCardsDnd:function t(n){try{const t=this;const r=n.getParameter("dropPosition"),s=n.getParameter("draggedControl"),i=s.getParent()?.indexOfItem(s),a=n.getParameter("droppedControl"),o=s.getParent().indexOfItem(a);t.cardsContainer?.setBusy(true);return Promise.resolve(E(function(){const e=function(){if(!t._controlModel.getProperty("/userAllCards").length){return Promise.resolve(t.cardHelperInstance._getUserAllCardModel()).then(function(e){t._controlModel.setProperty("/userAllCards",e.getProperty("/cards"));return Promise.resolve(t.updateCardList(r,o,i)).then(function(){})})}else{return Promise.resolve(t.updateCardList(r,o,i)).then(function(){})}}();if(e&&e.then)return e.then(function(){})},function(n){if(n instanceof Error){e.error(n.message)}t.cardsContainer?.setBusy(false)}))}catch(e){return Promise.reject(e)}},updateCardList:function e(t,n,r){try{const e=this;const s=e._controlModel.getProperty("/userVisibleCards"),i=e._controlModel.getProperty("/userAllCards"),a=s[r]?.rank,o=s[n]?.rank;let c=i.findIndex(e=>e.rank===a),d=i.findIndex(e=>e.rank===o);if(t==="Before"&&r===n-1||t==="After"&&r===n+1||r===n){e.cardsContainer?.setBusy(false);return Promise.resolve()}if(t==="Before"&&c<d){d--}else if(t==="After"&&c>d){d++}const l=function(){if(c!==d){const t=e.cardHelperInstance.handleDndCardsRanking(c,d,i);return Promise.resolve(e.cardHelperInstance._updateMultipleCards(t,"PUT")).then(function(){e._sortCardsOnRank(i);e._controlModel.setProperty("/userAllCards",i);e._controlModel.setProperty("/userVisibleCards",i.filter(e=>e.visibility));return Promise.resolve(e.rerenderCards()).then(function(){})})}else{e.cardsContainer?.setBusy(false)}}();return Promise.resolve(l&&l.then?l.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},_sortCardsOnRank:function e(t){t.sort((e,t)=>{if(e.rank&&t.rank){if(e.rank<t.rank){return-1}else if(e.rank>t.rank){return 1}}return 0})},_getPersonalization:function e(){const t=N.getPersContainerId(this);const n=N.getOwnerComponent(this);return F.getInstance(t,n)},_updateRecommendationStatus:function e(){try{const e=this;return Promise.resolve(e.appManagerInstance.isFeatureEnabled(H.RECOMMENDATION)).then(function(t){return function(){if(t){function n(){return Promise.resolve(e.oPersonalizer.read()).then(function(t){if(!t){t={}}t.showRecommendation=true;return e.oPersonalizer.write(t)})}const r=function(){if(!e.oPersonalizer){return Promise.resolve(e._getPersonalization()).then(function(t){e.oPersonalizer=t})}}();return r&&r.then?r.then(n):n(r)}}()})}catch(e){return Promise.reject(e)}},_calculateVisibleCardCount:function e(){const t=this.getParent()._getLayout().getDomRef();const n=this.getDeviceType();let r=1;if(t){const e=t.childNodes[0];const s=O(e,["width","padding-left","padding-right"]);const i=s.width-s["padding-left"]-s["padding-right"];let a=n===B.Mobile?17:this._calculateCardWidth(i);r=n===B.Mobile?this.aVisibleCardInstances.length:Math.floor(i/(a*16+14));this.cardWidth=`${a}rem`}return r},_calculateCardWidth:function e(t){const n=304;const r=352;const s=14;let i=1;let a=n;while(t/i>=n+s){a=t/i;i+=1}a-=s;a=a>r?r:a;return a/16},_adjustLayout:function e(){const t=this.getParent()?._getLayout();const n=this.getProperty("enableFullScreen");let r=this.cardWidth;if(t&&n){const e=t._getCurrentExpandedElementName()===this.getProperty("fullScreenName");const n=e?this.aVisibleCardInstances.length:this._calculateVisibleCardCount();if(n!==this.cardsInViewport.length){this.cardsInViewport=this.aVisibleCardInstances.slice(0,n);const e=this.cardsContainer.getMetadata().getDefaultAggregationName();this.cardsContainer.removeAllAggregation(e);this.cardsInViewport.forEach(e=>{const t=e.getManifest();const n=t["sap.card"]?.type;let r;if(n==="Table"||n==="List"){const e=new a({width:this.cardWidth,height:"2rem"}).addStyleClass("insightsCardOverflowLayer insightsCardOverflowTop");r=new a({height:"0"}).addStyleClass("sapMFlexBoxJustifyCenter");r.addItem(e)}const s=new c({direction:"Column",justifyContent:"Center",items:[e]});if(r){s.addItem(r)}const i=this.cardsContainer.getMetadata().getDefaultAggregationName();this.cardsContainer.addAggregation(i,s)})}this.getParent()?.toggleFullScreenElements(this,this.aVisibleCardInstances.length>n,e)}else{this.cardWidth=this.getDeviceType()===B.Mobile?"17rem":"22rem"}if(r!==this.cardWidth){this.aVisibleCardInstances.forEach(e=>e.setWidth(this.cardWidth));this.cardsContainerSettings?.setColumnSize(this.cardWidth)}}});z.cardsMenuItems=L;return z});
//# sourceMappingURL=CardsPanel-dbg.js.map