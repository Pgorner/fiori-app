/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
"use strict";sap.ui.define(["sap/base/Log","sap/base/i18n/Formatting","sap/m/ActionTile","sap/m/ActionTileContent","sap/m/Button","sap/m/ContentConfig","sap/m/Link","sap/m/List","sap/m/MessageBox","sap/m/Popover","sap/m/StandardListItem","sap/m/TileAttribute","sap/m/library","sap/ui/core/Locale","sap/ui/core/format/DateFormat","sap/ui/core/format/NumberFormat","./MenuItem","./ToDoPanel","./utils/DecisionDialog","./utils/Device","./utils/FESRUtil"],function(t,e,n,o,i,s,r,a,c,u,l,f,d,p,h,g,m,_,b,y,P){"use strict";function T(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function D(t,e){try{var n=t()}catch(t){return e(t)}if(n&&n.then){return n.then(void 0,e)}return n}const C=d["ButtonType"];const v=d["ContentConfigType"];const A=d["LoadState"];const I=d["PlacementType"];const x=d["URLHelper"];const S=T(m);const k=T(_);const w=T(b);const E=b["getIconFrameBadge"];const B=b["getIconFrameBadgeValueState"];const R=y["fetchElementProperties"];const $=P["addFESRId"];const U=P["addFESRSemanticStepName"];const O=P["FESR_EVENTS"];var N=function(t){t["CURRENCYVALUE"]="CURRENCYVALUE";t["CURRENCYCODE"]="CURRENCYCODE";t["USER"]="USER";return t}(N||{});var L=function(t){t["TextFirst"]="TextFirst";t["TextLast"]="TextLast";t["TextOnly"]="TextOnly";t["TextSeparate"]="TextSeparate";return t}(L||{});const M={CARD_HEIGHT:{1:220,2:272,3:324,4:376}};function V(t,e){const n=[];for(let o=0;o<t.length;o+=e){n.push(t.slice(o,o+e))}return n}const F=k.extend("sap.cux.home.TaskPanel",{metadata:{library:"sap.cux.home",properties:{enableActions:{type:"boolean",group:"Data",defaultValue:false,visibility:"public"},customAttributeUrl:{type:"string",group:"Data",defaultValue:"",visibility:"public"}}},constructor:function t(e,n){k.prototype.constructor.call(this,e,n)},init:function t(){k.prototype.init.call(this);this._customAttributeMap={};this._taskDefinitionMap={};this.setProperty("key","tasks");this.setProperty("title",this._i18nBundle.getText("tasksTabTitle"));const e=new S(`${this.getId()}-view-tasks-btn`,{title:this._i18nBundle.getText("viewAllTasksTitle"),icon:"sap-icon://inbox",press:this._onPressViewAll.bind(this)});this.insertAggregation("menuItems",e,0);$(e,"goToTaskSitution")},generateRequestUrls:function t(e){const n=[this.getCountUrl(),`${this.getDataUrl()},CustomAttributeData&$expand=CustomAttributeData&$skip=0&$top=${e}`];const o=this.getCustomAttributeUrl();if(o){n.push(o)}return n},generateCardTemplate:function t(e,a){const c=a.getObject().attributes?.map((t,n)=>new f(`${e}-${n}-attribute`,{label:t.label,contentConfig:new s(`${e}-${n}-contentConfig`,{type:t.type,text:t.text,href:t.href})}));return new n(`${e}-actionTile`,{mode:"ActionMode",frameType:"TwoByOne",pressEnabled:true,enableIconFrame:true,enableDynamicHeight:true,enableNavigationButton:true,headerImage:"sap-icon://workflow-tasks",badgeIcon:E(a.getProperty("Priority")),badgeValueState:B(a.getProperty("Priority")),header:a.getProperty("TaskTitle"),state:a.getProperty("status"),priority:this._toPriority(a.getProperty("Priority")),priorityText:this._toPriorityText(this._toPriority(a.getProperty("Priority"))),press:t=>this._onPressTask(t),tileContent:[new o(`${e}-actionTileContent`,{headerLink:(()=>{const t=new r({text:a.getProperty("CreatedByName"),press:t=>{void this._onClickCreatedBy(t)}});U(t,O.PRESS,"MST:ContactDetails");return t})(),attributes:c})],actionButtons:[(()=>{const t=new i(`${e}-view-btn`,{text:this._i18nBundle.getText("viewButton"),press:t=>t.getSource().getParent().firePress(),visible:a.getProperty("actions/length")===0});U(t,O.PRESS,"todoActionBtn");return t})(),(()=>{const t=new i(`${e}-approve-btn`,{text:a.getProperty("actions/0/text"),type:a.getProperty("actions/0/type"),press:()=>this._onActionButtonPress(a.getProperty("actions/0/pressHandler")),visible:a.getProperty("actions/0")!==undefined}).addStyleClass("sapUiTinyMarginEnd");U(t,O.PRESS,"todoActionBtn");return t})(),(()=>{const t=new i(`${e}-reject-btn`,{text:a.getProperty("actions/1/text"),type:a.getProperty("actions/1/type"),press:()=>this._onActionButtonPress(a.getProperty("actions/1/pressHandler")),visible:a.getProperty("actions/1")!==undefined}).addStyleClass("sapUiTinyMarginEnd");U(t,O.PRESS,"todoActionBtn");return t})(),(()=>{const t=new i(`${e}-overflow-btn`,{icon:"sap-icon://overflow",type:C.Transparent,press:t=>this._onOverflowButtonPress(t,a),visible:a.getProperty("actions/length")>=3});U(t,O.PRESS,"todoActBtnOverflow");return t})()]})},_onOverflowButtonPress:function t(e,n){const o=n.getProperty("actions").slice(2);this._getOverflowButtonPopover(o).openBy(e.getSource())},_getOverflowButtonPopover:function t(e){if(!this._overflowPopover){this._overflowList=new a(`${this.getId()}-overflowList`);this._overflowPopover=new u(`${this.getId()}-overflowPopover`,{showHeader:false,content:this._overflowList,placement:I.VerticalPreferredBottom})}this._setupOverflowList(e);return this._overflowPopover},_setupOverflowList:function t(e){this._overflowList.destroyItems();e.forEach((t,e)=>{const n=new l(`action-${e}`,{title:t.text,type:"Active",press:()=>this._onActionButtonPress(t.pressHandler)});U(n,O.PRESS,"todoActionBtn");this._overflowList.addItem(n)})},_onActionButtonPress:function t(e){e(this._loadCards.bind(this))},_getCustomAttributes:function t(e){const n=[];const o=4;const i=this._customAttributeMap[e.TaskDefinitionID]||[];for(let t of i){const o=t;const i=e.CustomAttributeData?.results;const s=i.find(t=>t.Name===o.name);let r="";if(s&&!o.referenced){const t={label:o.label+":",type:v.Text};if(o.format){r=this._formatCustomAttribute(o,i)}else if(o.textArrangement){r=this._arrangeText(s,o.textArrangement)}else{r=o.type==="Edm.DateTime"?this._formatDate(s.Value):s.Value}t.text=r||"-";n.push(t)}}this._addCommonAttributes(n,e);return n.slice(0,o)},_arrangeText:function t(e,n){const o=e.Value.trim();const i=e.ValueText.trim();let s="";switch(n){case L.TextFirst:s=`${i} (${o})`;break;case L.TextLast:s=`${o} (${i})`;break;case L.TextOnly:s=`${i}`;break;case L.TextSeparate:s=`${o}`;break;default:s=`${i} ${o})`;break}return s},_formatCustomAttribute:function t(e){let n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];const o=t=>n.find(e=>e.Name===t);const i=e.format?.toUpperCase();const s=o(e.name);let r=s?.Value;if(i===N.CURRENCYVALUE&&e.reference){const t=o(e.reference);if(t){const e=g.getCurrencyInstance();r=e.format(parseFloat(s?.Value),t.Value)}}else if(i===N.USER){r=s?.FormattedValue||s?.Value}return r},_addCommonAttributes:function t(e,n){if(n.CompletionDeadline){e.push({label:this._i18nBundle.getText("dueDate")+":",text:this._formatDate(n.CompletionDeadline,"MMM dd, YYYY hh:mm a"),type:v.Text})}if(n.CreatedOn){e.push({label:this._i18nBundle.getText("createdOn")+":",text:this._formatDate(n.CreatedOn),type:v.Text})}},_formatDate:function t(n){let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:e.getDatePattern("short")||"dd/MM/yyyy";const i=new p(e.getLanguageTag().language);const s=h.getDateTimeInstance({pattern:o},i);const r=this._getParsedTime(n);let a="";if(!isNaN(r)){a=s.format(new Date(r))}return a},_getParsedTime:function t(e){if(e==null||e==="00000000"){return NaN}if(typeof e==="number"){return e}const n=/\/(Date)\((\d+)\)\//;const o=/^\d{8}$/;const i=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([+-])(\d{2}):(\d{2}))?$/;const s=e.match(n);if(s){return parseInt(s[2],10)}if(o.test(e)&&this._isValidDate(e)){const t=h.getDateInstance().parse(e);return t instanceof Date?t.getTime():NaN}const r=e.match(i);if(r){return new Date(e).getTime()}return NaN},_isValidDate:function t(e){if(e.length!==8){return false}const n=parseInt(e.slice(0,4),10);const o=parseInt(e.slice(4,6),10)-1;const i=parseInt(e.slice(6),10);const s=new Date(n,o,i);return s.getFullYear()===n&&s.getMonth()===o&&s.getDate()===i},_onPressTask:function t(e){const n=e.getSource();const o=n.getBindingContext();const i=o?.getProperty("status");const s=this._getTaskUrl(o?.getProperty("SAP__Origin"),o?.getProperty("InstanceID"));if(!this._disableNavigation){if(i!==A.Loading){x.redirect(s,false)}}},_getTaskUrl:function t(e,n){const o=`?showAdditionalAttributes=true&/detail/${e}/${n}/TaskCollection(SAP__Origin='${e}',InstanceID='${n}')`;return this.getTargetAppUrl()+o},_onClickCreatedBy:function e(n){try{const e=this;const o=n.getParameter("link");const{SAP__Origin:i,CreatedBy:s,TaskTitle:r,CreatedByName:a,InstanceID:u}=n.getSource().getBindingContext()?.getObject();const l=e._getTaskUrl(i,u);const f=(t,n)=>{let{subject:o,body:i}=n;x.triggerEmail(t,o,i);setTimeout(()=>{e._disableNavigation=false},0)};const d=new URL(window.location.href);d.hash=l;const p=d.toString();e._disableNavigation=true;return Promise.resolve(e._fetchUserDetailsIfRequired(i,s)).then(function(n){if(n.Email){sap.ui.require(["sap/suite/ui/commons/collaboration/ServiceContainer"],function(e){try{return Promise.resolve(e.getServiceAsync()).then(function(e){const i=function(){if(e.enableContactsCollaboration){const i=D(function(){return Promise.resolve(e.enableContactsCollaboration(n.Email,{subject:r,body:encodeURIComponent(p)})).then(function(t){const e=t;e.openBy(o)})},function(e){t.error(e instanceof Error?e.message:String(e));f(n.Email,{subject:r,body:p})});if(i&&i.then)return i.then(function(){})}else{f(n.Email,{subject:r,body:p})}}();if(i&&i.then)return i.then(function(){})})}catch(t){return Promise.reject(t)}})}else{c.warning(e._i18nBundle.getText("noEmail",[a]));setTimeout(()=>{e._disableNavigation=false},0)}})}catch(t){return Promise.reject(t)}},_fetchUserDetailsIfRequired:function t(e,n){this.userInfo=this.userInfo||{};if(Object.keys(this.userInfo).includes(n)){return Promise.resolve(this.userInfo[n])}else{return this._fetchUserInfo(e,n)}},_fetchUserInfo:function e(n,o){try{const e=this;return Promise.resolve(D(function(){return Promise.resolve(fetch(`/sap/opu/odata/IWPGW/TASKPROCESSING;mo;v=2/UserInfoCollection(SAP__Origin='${n}',UniqueName='${o}')?$format=json`)).then(function(t){if(!t.ok){throw new Error(`Failed to Fetch User Info for: ${o}`)}return Promise.resolve(t.json()).then(function(t){const{d:n}=t;e.userInfo[o]=n;return e.userInfo[o]})})},function(e){t.error(e instanceof Error?e.message:String(e));return{}}))}catch(t){return Promise.reject(t)}},onDataReceived:function t(e,n){try{const t=this;const[o,i]=e;t._extractCustomAttributes(i);const s=function(){if(!n||n&&!n.onlyCount){return Promise.resolve(t._updateTasks(o)).then(function(e){t._oData.displayTiles=t._oData.tiles=e})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},_updateTasks:function t(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];try{const t=this;let n=t._addCustomAttributes(e);const o=function(){if(t.getEnableActions()){const e=t._getTaskDefintions(n);return Promise.resolve(t._downloadDecisionOptions(e)).then(function(){n=t._addActions(n)})}}();return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(t){return Promise.reject(t)}},_addCustomAttributes:function t(e){return e.map(t=>({...t,attributes:this._getCustomAttributes(t)}))},_addActions:function t(e){return e.map(t=>{const e=t.SAP__Origin+t.TaskDefinitionID;return{...t,actions:this._taskDefinitionMap[e]?w.getTaskActions(t,this.getBaseUrl(),this._taskDefinitionMap,this._i18nBundle):[]}})},_downloadDecisionOptions:function t(e){try{const t=this;const n=[];const o=Object.keys(e).reduce((o,i)=>{if(!Object.keys(t._taskDefinitionMap).includes(i)){n.push(i);t._taskDefinitionMap[i]=[];const{SAP__Origin:s,InstanceID:r}=e[i];o.push(`DecisionOptions?SAP__Origin='${s}'&InstanceID='${r}'`)}return o},[]);const i=function(){if(o.length){t._clearRequests();t.requests.push({baseURL:t.getBaseUrl(),requestURLs:o,success:e=>{e.forEach((e,o)=>{t._taskDefinitionMap[n[o]]=e});return Promise.resolve()}});return Promise.resolve(t._submitBatch()).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},_getTaskDefintions:function t(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];const n={};e.forEach(t=>{const e=t.SAP__Origin+t.TaskDefinitionID;if(!n[e]){n[e]={SAP__Origin:t.SAP__Origin,InstanceID:t.InstanceID,TaskDefinitionID:t.TaskDefinitionID}}});return n},_extractCustomAttributes:function t(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];e.forEach(t=>{const e=t.CustomAttributeDefinitionData?.results||[];this._customAttributeMap[t.TaskDefinitionID]=e.filter(t=>t.Rank>0).sort((t,e)=>e.Rank-t.Rank).map(t=>({name:t.Name,label:t.Label,type:t.Type,format:t.Format,reference:t.Reference,referenced:t.Referenced,textArrangement:t.TextArrangement}))})},getNoDataText:function t(){return this._i18nBundle.getText("noTaskTitle")},getVerticalCardCount:function t(e,n){const o=R(e,["height","padding-top"]);const i=this.calculateTitleHeight();const s=o.height-o["padding-top"]*2-i;const r=this.getHorizontalCardCount(e);const a=n?.isPlaceholder;const c=16;let u=0;let l=0;if(this._isLoaded()){const t=V(this._oData.tiles,r);const e=t.map(function(t){const e=t.reduce(function(t,e){e.attributes=e.attributes||[];return e.attributes.length>t?e.attributes.length:t},1);const n=Math.min(e,4);return M.CARD_HEIGHT[n]+c}.bind(this));for(let t of e){if(u+t<s){u+=t;l++}else{break}}}else{l=Math.floor(s/M.CARD_HEIGHT[a?"4":"1"])}return Math.max(l,2)}});return F});
//# sourceMappingURL=TaskPanel-dbg.js.map