/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
"use strict";sap.ui.define(["sap/base/Log","sap/m/SlideTile","sap/ui/core/EventBus","sap/ui/core/format/DateFormat","sap/ui/model/xml/XMLModel","sap/ushell/Container","./BaseNewsPanel","./MenuItem","./NewsGroup","./NewsItem","./library","./utils/FESRUtil","./utils/PersonalisationUtils","./utils/UshellPersonalizer"],function(e,t,n,s,r,o,i,a,u,l,c,d,h,f){"use strict";function m(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function g(e,t,n){if(!e.s){if(n instanceof w){if(n.s){if(t&1){t=n.s}n=n.v}else{n.o=g.bind(null,e,t);return}}if(n&&n.then){n.then(g.bind(null,e,t),g.bind(null,e,2));return}e.s=t;e.v=n;const s=e.o;if(s){s(e)}}}const p=m(i);const w=function(){function e(){}e.prototype.then=function(t,n){const s=new e;const r=this.s;if(r){const e=r&1?t:n;if(e){try{g(s,1,e(this.v))}catch(e){g(s,2,e)}return s}else{return this}}this.o=function(e){try{const r=e.v;if(e.s&1){g(s,1,t?t(r):r)}else if(n){g(s,1,n(r))}else{g(s,2,r)}}catch(e){g(s,2,e)}};return s};return e}();function N(e){return e instanceof w&&e.s&1}function F(e,t,n){var s;for(;;){var r=e();if(N(r)){r=r.v}if(!r){return o}if(r.then){s=0;break}var o=n();if(o&&o.then){if(N(o)){o=o.s}else{s=1;break}}if(t){var i=t();if(i&&i.then&&!N(i)){s=2;break}}}var a=new w;var u=g.bind(null,a,2);(s===0?r.then(c):s===1?o.then(l):i.then(d)).then(void 0,u);return a;function l(s){o=s;do{if(t){i=t();if(i&&i.then&&!N(i)){i.then(d).then(void 0,u);return}}r=e();if(!r||N(r)&&!r.v){g(a,1,o);return}if(r.then){r.then(c).then(void 0,u);return}o=n();if(N(o)){o=o.v}}while(!o||!o.then);o.then(l).then(void 0,u)}function c(e){if(e){o=n();if(o&&o.then){o.then(l).then(void 0,u)}else{l(o)}}else{g(a,1,o)}}function d(){if(r=e()){if(r.then){r.then(c).then(void 0,u)}else{c(r)}}else{g(a,1,o)}}}const v=m(a);function y(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const P=m(u);const C=m(l);const T=c["NewsType"];const b=d["addFESRId"];const E=m(h);const A=m(f);const I="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/",D=I+"insights_read_srv/0001/"+"NEWS_FEED",S=I+"insights_read_srv/0001/"+"NewsFeedColumnTranslation",x=D+"/$count",M=7,L=function(e,t){return Array.from({length:t},function(t,n){return e+"/"+(n+1)+".jpg"})};const U={TITLE:"LineOfBusiness",LINK:"WhatsNewDocument",VALIDITY:"ValidAsOf",PREPARATION_REQUIRED:"PreparationRequired",EXCLUDE_FIELDS:["ChangeId","LineNumber","LineOfBusiness","SolutionArea","Title","Description","Type","ValidAsOf","WhatsNewDocument","Link"],IMAGE_URL:"sap/cux/home/img/CustomNewsFeed/",FESR_STEP_NAME:"custNewsSlide-press",EMPTY_DATA_ERROR_CODE:"NODATA"},R={"Application Platform and Infrastructure":L("ApplicationPlatformandInfrastructure",3),"Asset Management":L("AssetManagement",3),"Cross Applications":L("CrossApplications",3),Finance:L("Finance",3),Manufacturing:L("Manufacturing",3),"R&D / Engineering":L("RnDandEngineering",3),Sales:L("Sales",3),"Sourcing and Procurement":L("SourcingandProcurement",3),"Supply Chain":L("SupplyChain",3),default:["default.jpg"]};const _=p.extend("sap.cux.home.NewsPanel",{metadata:{library:"sap.cux.home",properties:{url:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},type:{type:"sap.cux.home.NewsType",group:"Misc",visibility:"public",defaultValue:T.RSS},customFeedKey:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},customFileName:{type:"string",group:"Misc",defaultValue:""},showCustom:{type:"boolean",group:"Misc",defaultValue:false},newsAvailable:{type:"boolean",group:"Misc",defaultValue:true,visibility:"hidden"}},aggregations:{newsGroup:{type:"sap.cux.home.NewsGroup",singularName:"newsGroup",multiple:true,visibility:"hidden"}}},constructor:function e(t,n){p.prototype.constructor.call(this,t,n)},init:function e(){p.prototype.init.call(this);this.oNewsTile=new t(this.getId()+"--idNewsSlide",{displayTime:2e4,width:"100%",height:"17rem"}).addStyleClass("newsTileMaxWidth sapUiSmallMarginTop sapUiSmallMarginBottom");this.getNewsWrapper().addContent(this.oNewsTile);this.setProperty("title",this._i18nBundle.getText("newsTitle"));this._eventBus=n.getInstance();const s=new v(`${this.getId()}-manageNews`,{title:this._i18nBundle.getText("mngNews"),icon:"sap-icon://edit",press:this.handleEditNews.bind(this)});this.addAggregation("menuItems",s);b(s,"manageNews")},getData:function e(){try{const e=this;const t=e.getUrl();const n=function(){if(t&&!e.getProperty("showCustom")){return Promise.resolve(e.initializeXmlModel(t)).then(function(t){e.oNewsModel=t;e.oNewsTile.setModel(e.oNewsModel)})}else{const t=function(){if(e.getProperty("showCustom")){e.bNewsLoad=e.bNewsLoad||false;return Promise.resolve(A.getInstance(E.getPersContainerId(e),E.getOwnerComponent(e))).then(function(t){e.oPersonalizer=t;return Promise.resolve(e.oPersonalizer.read()).then(function(t){e.oPersData=t;const n=e.getCustomFeedKey();if(n){void e.setCustomNewsFeed(n)}else{e.handleFeedError()}})})}else{e.handleFeedError()}}();if(t&&t.then)return t.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},getCustomFeedKey:function e(){const t=this.getProperty("customFeedKey");if(t){return t}else{return this.oPersData?.oAdaptationData?.customNewsFeedKey}},getUrl:function e(){return this.getProperty("url")},initializeXmlModel:function e(t){try{const e=this;const n=e.getParent();return Promise.resolve(new Promise(s=>{const o=new r(t);o.setDefaultBindingMode("OneWay");o.attachRequestCompleted(t=>{void function(){try{if(!e.bNewsLoad){n?.panelLoadedFn("News",{loaded:true,count:M});e.bNewsLoad=true}const r=t.getSource().getData();return Promise.resolve(e.loadNewsFeed(r,0)).then(function(){e._eventBus.publish("KeyUserChanges","newsFeedLoadFailed",{showError:false,date:new Date});s(o)})}catch(e){return Promise.reject(e)}}()});o.attachRequestFailed(()=>{e.handleFeedError();if(!e.bNewsLoad){n?.panelLoadedFn("News",{loaded:false,count:0});e.bNewsLoad=true}e._eventBus.publish("KeyUserChanges","newsFeedLoadFailed",{showError:true,date:new Date});s(o)})}))}catch(e){return Promise.reject(e)}},loadNewsFeed:function e(t,n){try{const s=this;function r(){if(!!t?.querySelector("rss")&&!!t?.querySelector("item")){o={path:"/channel/item/",length:n||M}}else if(!!t?.querySelector("feed")&&!!t?.querySelector("entry")){o={path:"/entry/",length:n||M}}else if(!!t?.querySelector("customFeed")&&!!t?.querySelector("item")){o={path:"/item/",length:n||M}}else{s.handleFeedError();return}s.bindNewsTile(s.oNewsTile,o)}let o;const i=function(){if(!t?.querySelector("customFeed")){return Promise.resolve(s.extractAllImageUrls(t,n||M)).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(a){return Promise.reject(a)}},handleFeedError:function e(){if(this.getProperty("showCustom")){this.generateErrorMessage().setVisible(true);this.oNewsTile.setVisible(false)}else{(this.getNewsWrapper()?.getParent()).setVisible(false);this.setProperty("newsAvailable",false)}},setURL:function e(t){try{const e=this;e.setProperty("showCustom",false);e.setProperty("newsAvailable",true);e.generateErrorMessage().setVisible(false);(e.getNewsWrapper()?.getParent()).setVisible(true);e.oNewsTile.setVisible(true);e.setProperty("url",t);return Promise.resolve(e.getData()).then(function(){})}catch(e){return Promise.reject(e)}},bindNewsTile:function e(t,n){if(n){t.bindAggregation("tiles",{path:n.path,length:n.length,templateShareable:false,factory:(e,t)=>{const n=t.getObject();let s;if(n.getElementsByTagName("link").length>0){s=new C("",{url:n.getElementsByTagName("link")[0].textContent,title:n.getElementsByTagName("title")[0].textContent,subTitle:n.getElementsByTagName("description")[0].textContent,imageUrl:n.getElementsByTagName("imageUrl")[0].textContent,footer:this.formatDate(n.getElementsByTagName("pubDate")[0].textContent)})}else{s=new P("",{title:n.getElementsByTagName("title")[0].textContent,subTitle:this._i18nBundle.getText("newsFeedDescription"),imageUrl:n.getElementsByTagName("imageUrl")[0].textContent,footer:n.getElementsByTagName("footer")[0].textContent})}this.addAggregation("newsItems",s,true);return s.getTile()}})}},extractAllImageUrls:function e(t,n){try{const e=this;let s=0;const r=F(function(){return s<n},function(){return s++},function(){const n=t?.getElementsByTagName("item")[s];return Promise.resolve(e.extractImage(n.getElementsByTagName("link")[0].textContent)).then(function(e){const s=t.createElement("imageUrl");s.textContent=e;n.appendChild(s)})});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},formatDate:function e(t){return this.toRelativeDateTime(new Date(t))},getFavNewsFeed:function e(){return this.aFavNewsFeed},extractImage:function e(t){const n=()=>{const e=sap.ui.require.toUrl("sap.cux.home/src/sap/cux/home/utils/");this.image=this.image?this.image+1:1;this.image=this.image<9?this.image:1;return`${e}/imgNews/${this.image}.jpg`};return fetch(t).then(e=>e.text()).then(e=>{const t=e.match(/<meta[^>]*property=["']og:image["'][^>]*content=["']([^"']+)["'][^>]*>/i);return Array.isArray(t)&&t[1]?t[1]:n()}).catch(n)},toRelativeDateTime:function e(t){const n=s.getDateTimeInstance({style:"medium",relative:true,relativeStyle:"short"});return n.format(new Date(t))},setCustomNewsFeed:function t(n){try{const t=this;return Promise.resolve(y(function(){t.oNewsTile.setVisible(true);t.generateErrorMessage().setVisible(false);return Promise.resolve(t.oPersonalizer?.read()).then(function(e){t.oPersData=e;t.aFavNewsFeed=t.oPersData?.favNewsFeed||{items:[]};return Promise.resolve(Promise.all([t.getCustomNewsFeedCount(n),t.getCustomNewsFeed(n,t.aFavNewsFeed.showAllPreparationRequired)])).then(function(e){let[n,s]=e;if(s.length===0||n===0){throw new Error}if(t.aFavNewsFeed?.items?.length){s=s.filter(e=>t.aFavNewsFeed?.items.includes(e.title))}else if(t.aFavNewsFeed?.items?.length===0){throw new Error("Error: No news feed available")}t.loadCustomNewsFeed(s)})})},function(n){e.error(n);t.handleFeedError()}))}catch(e){return Promise.reject(e)}},getCustomNewsFeedCount:function e(t){try{const n=this;function s(e){return i?e:Promise.resolve(e.json()).then(r)}function r(e){n.pCustomNewsFeedCount[o]=i?e:e;return n.pCustomNewsFeedCount[o]}let o=encodeURI(x+"?$filter=ChangeId"+" eq "+"'"+t+"'");n.pCustomNewsFeedCount=n.pCustomNewsFeedCount?n.pCustomNewsFeedCount:{};const i=n.pCustomNewsFeedCount[o]!==undefined;return Promise.resolve(i?s(r(n.pCustomNewsFeedCount[o])):Promise.resolve(fetch(o)).then(s))}catch(a){return Promise.reject(a)}},getCustomNewsFeed:function t(n,s){try{const t=this;return Promise.resolve(y(function(){const e=t.getNewsFeedDetailsUrl({changeId:n,showAllPreparationRequired:s});t.pCustomNewsFeed=t.pCustomNewsFeed?t.pCustomNewsFeed:{};t.pCustomNewsFeed[e]=t.pCustomNewsFeed[e]!==undefined?t.pCustomNewsFeed[e]:t.getAuthNewsFeed(e);return Promise.resolve(t.pCustomNewsFeed[e]).then(function(e){const n={};const s=[];if(e?.length>0){e.forEach(e=>{const r=e[U.TITLE];if(!n[r.value]){s.push({title:r.value,footer:e[U.VALIDITY].value,imageUrl:t.getCustomFeedImage(r.value)});n[r.value]=r.value}})}return s})},function(t){e.error(t);throw new Error(t)}))}catch(e){return Promise.reject(e)}},getNewsFeedDetailsUrl:function e(t){let n=D+"?$filter=ChangeId eq "+"'"+t.changeId+"'";n=t.title?n+" and LineOfBusiness eq "+"'"+encodeURI(t.title)+"'":n;n=t.showAllPreparationRequired?n+" and PreparationRequired eq true":n;return n+"&$top=999"},getAuthNewsFeed:function t(n){try{const t=this;return Promise.resolve(y(function(){return Promise.resolve(Promise.all([t.getAllAvailableApps(),t.getNewsFeedDetails(n)])).then(function(e){let[n,s]=e;return n.length===0?s:t.arrangeNewsFeeds(s,n)})},function(t){e.error(t)}))}catch(e){return Promise.reject(e)}},arrangeNewsFeeds:function e(t,n){const s=[];t.forEach(e=>{if(e.Category.value!=="App"||!e.ImpactedArtifacts.value){s.push(e)}else{const t=e.ImpactedArtifacts.value.split("\n");for(let r of t){const t=r;if(t&&this.isAuthFeed(n,r)){s.push(e);break}}}});return s},isAuthFeed:function e(t,n){const s="|";if(n.includes(s)){const e=n.split(s);const r=(e[e.length-1]||"").trim();if(r){const e=t.findIndex(e=>r===e?.signature?.parameters["sap-fiori-id"]?.defaultValue?.value);return e>-1}}return true},getAllAvailableApps:function t(){try{return Promise.resolve(y(function(){return Promise.resolve(o.getServiceAsync("ClientSideTargetResolution")).then(function(e){return e?._oAdapter._aInbounds||[]})},function(t){if(t instanceof Error){e.error(t.message)}return[]}))}catch(e){return Promise.reject(e)}},getNewsFeedDetails:function e(t){try{const n=this;function s(e){return o?e:Promise.resolve(e.json()).then(r)}function r(e){n.pNewsFeed[t]=o?e:e;const s=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1 $2");return Promise.resolve(Promise.all([n.pNewsFeed[t],n.getTranslatedText(n.getCustomFeedKey())])).then(function(e){let[t,r]=e;const o=JSON.parse(JSON.stringify(t.value||[]));const i=JSON.parse(JSON.stringify(r.value||[]));return o.map(e=>{const t=Object.keys(e);const r=[];t.forEach(t=>{const n=i.find(e=>e?.ColumnName?.toUpperCase()===t.toUpperCase());const o=n?.TranslatedName||s(t);e[t]={label:o,value:e[t]};if(!U.EXCLUDE_FIELDS.includes(t)){r.push(e[t])}});e.Link={label:n._i18nBundle.getText("readMoreLink"),value:e[U.LINK],text:"Link"};e.expanded=o.length===1;e.expandFields=r;return e})})}n.pNewsFeed=n.pNewsFeed?n.pNewsFeed:{};const o=n.pNewsFeed[t]!==undefined;return Promise.resolve(o?s(r(n.pNewsFeed[t])):Promise.resolve(fetch(t)).then(s))}catch(i){return Promise.reject(i)}},getTranslatedText:function t(n){try{const t=this;return Promise.resolve(y(function(){function e(e){return o?e:Promise.resolve(e.json()).then(s)}function s(e){t.pCustomNewsFeed[r]=o?e:e;return t.pCustomNewsFeed[r]}const r=S+"?$filter=Changeid eq '"+n+"'";t.pCustomNewsFeed=t.pCustomNewsFeed?t.pCustomNewsFeed:{};const o=t.pCustomNewsFeed[r]!==undefined;return o?e(s(t.pCustomNewsFeed[r])):Promise.resolve(fetch(r)).then(e)},function(t){if(t instanceof Error){e.error(t.message)}return[]}))}catch(e){return Promise.reject(e)}},loadCustomNewsFeed:function e(t){const n=this.parseJsonToXml(JSON.parse(JSON.stringify(t)));const s=this.getParent();if(!this.oNewsModel){this.oNewsModel=new r(n);if(!this.bNewsLoad){s?.panelLoadedFn("News",{loaded:true,count:M});this.bNewsLoad=true}this.oNewsTile.setModel(this.oNewsModel)}else{this.oNewsModel.setData(n)}void this.loadNewsFeed(n,t.length)},parseJsonToXml:function e(t){const n=e=>e.map(e=>({item:e}));const s=e=>{let t="";let n;for(n in e){const r=e[n];if(r){if(typeof r==="object"){t+=`<${n}>${s(r)}</${n}>`}else{t+=`<${n}>${r}</${n}>`}}}return t.replace(/<\/?\d+>/g,"")};const r=JSON.parse(JSON.stringify(n(t)));let o="<?xml version='1.0' encoding='UTF-8'?>";const i="customFeed";o+=`<${i}>`;o+=s(r);o+=`</${i}>`;o=o.replaceAll("&","&amp;");const a=new DOMParser;return a.parseFromString(o,"text/xml")},getCustomFeedImage:function e(t){const n=sap.ui.require.toUrl(U.IMAGE_URL);let s=n+R.default[0];const r=R[t]||[];let o=0;if(r.length>0){const e=new window.Uint32Array(1);window.crypto.getRandomValues(e);o=e[0]%3;s=n+r[o]}return s}});return _});
//# sourceMappingURL=NewsPanel.js.map