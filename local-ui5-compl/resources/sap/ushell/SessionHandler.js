// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/EventBus","sap/ushell/resources","sap/ushell/Config","sap/ushell/utils","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/ui/model/json/JSONModel","sap/m/VBox","sap/ui/core/library","sap/m/library","sap/ushell/ui/launchpad/LoadingDialog","sap/ui/thirdparty/jquery","sap/ui/util/Storage","sap/base/Log","sap/ushell/EventHub","sap/ui/core/Core","sap/ushell/components/applicationIntegration/application/PostMessageUtils","sap/ushell/Container"],function(e,i,t,n,s,o,a,r,u,l,d,c,jQuery,h,m,g,f,v,p){"use strict";var S=d.ButtonType;var T=l.ValueState;var b=false;var I=function(l){var d=this;var f=false;var I=false;this.init=function(e){m.debug("SessionHandler.oConfig.sessionTimeoutIntervalInMinutes: "+e.sessionTimeoutIntervalInMinutes,"","SessionHandler");m.debug("SessionHandler.oConfig.sessionTimeoutReminderInMinutes: "+e.sessionTimeoutReminderInMinutes,"","SessionHandler");m.debug("SessionHandler.oConfig.enableAutomaticSignout: "+e.enableAutomaticSignout,"","SessionHandler");if(e.enableAutomaticSignout===undefined){e.enableAutomaticSignout=false}if(e.sessionTimeoutReminderInMinutes===undefined){e.sessionTimeoutReminderInMinutes=0}if(e.sessionTimeoutIntervalInMinutes<=e.sessionTimeoutReminderInMinutes){e.sessionTimeoutReminderInMinutes=e.sessionTimeoutReminderInMinutes-1<0?0:e.sessionTimeoutReminderInMinutes-1;m.error("sessionTimeoutReminderInMinutes needs to be higher than sessionTimeoutIntervalInMinutes. sessionTimeoutReminderInMinutes adapted to: "+e.sessionTimeoutReminderInMinutes,"SessionHandler")}this.oConfig=e;this.oModel=new r;this.putTimestampInStorage(this._getCurrentDate());this.initLogout();this._fnOnVisibilityChange=this.onVisibilityChange.bind(this);p.getServiceAsync("AppLifeCycle").then(function(i){this.oAppLifeCycleService=i;this.attachUserEvents();if(e.sessionTimeoutIntervalInMinutes>0){this.attachVisibilityEvents();this.initSessionTimeout()}if(e.sessionTimeoutTileStopRefreshIntervalInMinutes>0){this.initTileRequestTimeout()}g.on("nwbcUserIsActive").do(this.userActivityHandler.bind(this));f=true}.bind(this))};this.initLogout=function(){if(I===false){p.registerLogout(this.logout);this._registerCommHandlers();I=true}};this.initSessionTimeout=function(){this.oModel.setProperty("/SessionRemainingTimeInSeconds",this.oConfig.sessionTimeoutReminderInMinutes*60);this.counter=0;this.oKeepAliveDialog=undefined;this.notifyServer();this.monitorUserIsInactive()};this._registerCommHandlers=function(){var e=()=>{if(f===true){d.userActivityHandler()}return(new jQuery.Deferred).resolve().promise()};l.registerShellCommunicationHandler({"sap.ushell.sessionHandler":{oRequestCalls:{logout:{isActiveOnly:false,distributionType:["URL"]},extendSessionEvent:{isActiveOnly:false,distributionType:["all"]}},oServiceCalls:{notifyUserActive:{executeServiceCallFn:e},extendSessionEvent:{executeServiceCallFn:e}}}})};this.monitorUserIsInactive=function(e){m.debug("SessionHandler.monitorInactiveUser : Check started","*****","SessionHandler");e=typeof e!=="undefined"?e:true;var i=this.timeLastInteraction();var t=this.timePopup();var n=this.timeNow();var s=this.timeOver();var o=t-n;var a=n-i;m.debug("SessionHandler.monitorUserIsInactive :: time since last interaction : "+a,"","SessionHandler");m.debug("SessionHandler.monitorUserIsInactive :: remaining time until dialog : "+o,"","SessionHandler");if(n<t&&e){var r=setTimeout(this.monitorUserIsInactive.bind(this),o*1e3);this.oMonitorUserIsInactiveTimer=this.oMonitorUserIsInactiveTimer||r;return}if(n>=t&&n<s&&this.oConfig.sessionTimeoutReminderInMinutes>0){this.detachUserEvents();this.detachVisibilityEvents();this.oContinueWorkingDialog=this.createContinueWorkingDialog();this.oContinueWorkingDialog.open();m.debug("SessionHandler.monitorUserIsInactive :: Dialog opened","","SessionHandler");this.monitorCountdown(true);this._createSystemNotification()}if(n>=s){m.debug("SessionHandler.monitorUserIsInactive :: Session over detected","","SessionHandler");this.handleSessionOver();return}m.debug("SessionHandler.monitorInactiveUser :: Check done","*****","SessionHandler")};this.handleSessionOver=function(){clearTimeout(this.notifyServerTimer);e.getInstance().publish("launchpad","sessionTimeout");if(this.oConfig.enableAutomaticSignout===true){m.debug("SessionHandler.handleSessionOver :: Automatic signout gets initiated","","SessionHandler");p.defaultLogout()}else{m.debug("SessionHandler.handleSessionOver :: Session expired dialog gets opened","","SessionHandler");this.createSessionExpiredDialog().open()}};this.notifyServer=function(){var e=this._getCurrentDate()-new Date(this.getTimestampFromStorage());var i=e/(1e3*60);var t=this.oConfig.sessionTimeoutIntervalInMinutes*30*1e3;if(i<=this.oConfig.sessionTimeoutIntervalInMinutes){p.sessionKeepAlive();v.postMessageToMultipleIframes("sap.ushell.sessionHandler","extendSessionEvent",{})}else{}this.notifyServerTimer=setTimeout(this.notifyServer.bind(this),n.sanitizeTimeoutDelay(t))};this.monitorCountdown=function(e){if(e){m.debug("SessionHandler.monitorCountdown :: Initiated from outside","*****","SessionHandler")}else{m.debug("SessionHandler.monitorCountdown :: Initiated from internal call","**","SessionHandler")}var i=this.timeLastInteraction();var t=this.timePopup();var n=this.timeNow();var s=this.timeOver();var o=n-i;m.debug("SessionHandler.monitorCountdown :: timeNow : "+n,"","SessionHandler");m.debug("SessionHandler.monitorCountdown :: iTimeLastInteraction : "+i,"","SessionHandler");m.debug("SessionHandler.monitorCountdown :: timeSinceLastInteraction : "+o,"","SessionHandler");m.debug("SessionHandler.monitorCountdown :: iTimeOver : "+s,"","SessionHandler");if(n<t){m.debug("SessionHandler.monitorCountdown :: Auto-click","<=","SessionHandler");this.continueWorkingButtonPressHandler(true);return}var a=s-n;if(a>0){m.debug("SessionHandler.monitorCountdown :: Remaining seconds : "+a+" - iTimeOver : "+s,"","SessionHandler");this.oModel.setProperty("/SessionRemainingTimeInSeconds",a);this.remainingTimer=setTimeout(this.monitorCountdown.bind(this,false),500);return}if(a<=0){if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close()}this.handleSessionOver()}};this.initTileRequestTimeout=function(){this.checkStopBackendRequestRemainingTime();this.bBackendRequestsActive=true};this.checkStopBackendRequestRemainingTime=function(){var e=this._getCurrentDate()-new Date(this.getTimestampFromStorage());var i=e/(1e3*60);var t=this.oConfig.sessionTimeoutTileStopRefreshIntervalInMinutes;var s=(t-i)*60*1e3;if(i<t){setTimeout(this.checkStopBackendRequestRemainingTime.bind(this),n.sanitizeTimeoutDelay(s))}else if(t>0){this._setConnectionActive(false)}};this._setConnectionActive=function(i){if(i){setTimeout(this.checkStopBackendRequestRemainingTime.bind(this),0)}if(this.bBackendRequestsActive===i){return}e.getInstance().publish("launchpad","setConnectionToServer",{active:i});if(!t.last("/core/spaces/enabled")){if(i){this._setTilesVisibleOnHomepage()}else{this._setTilesInvisibleOnHomepage()}}this.bBackendRequestsActive=i};this._setTilesVisibleOnHomepage=function(){sap.ui.require(["sap/ushell/utils"],function(e){e.handleTilesVisibility()})};this._setTilesInvisibleOnHomepage=function(){return new Promise(function(i,t){return p.getServiceAsync("FlpLaunchPage").then(function(t){t.getGroups().then(function(n){var s=e.getInstance();n.forEach(function(e){t.getGroupTiles(e).forEach(function(e){t.setTileVisible(e,false)})});s.publish("launchpad","visibleTilesChanged",[]);i()})})})};this.getLocalStorage=function(){if(this.oLocalStorage===undefined){var e=new h(this.oConfig&&this.oConfig.sessionType||h.Type.local);if(this._isLocalStorageSupported(e)){this.oLocalStorage=e}else{this.oLocalStorage=false}}return this.oLocalStorage};this._isLocalStorageSupported=function(e){var i;try{i=e.isSupported()}catch(e){i=false}if(!i){m.warning("SessionHandler._isLocalStorageSupported :: Failed to instantiate local storage handler: "+"Might be disabled by the browser!","","SessionHandler")}return i};this._createSystemNotification=function(){var e=function(){var e=this.oModel.getProperty("/SessionRemainingTimeInSeconds");var t=new Notification(i.i18n.getText("sessionTimeoutMessage_title"),{body:this.continueWorkingFormatter(e)});t.onclick=function(e){window.focus()}}.bind(this);if(!("Notification"in window)){return}else if(Notification.permission==="granted"){e()}else if(Notification.permission!=="denied"){Notification.requestPermission().then(function(i){if(i==="granted"){e()}})}};this.continueWorkingFormatter=function(e){var t=e>60;var n;var s=t?i.i18n.getText("sessionTimeoutMessage_units_minutes"):i.i18n.getText("sessionTimeoutMessage_units_seconds");var o=t?Math.ceil(e/60):e;if(d.oConfig.enableAutomaticSignout){n=i.i18n.getText("sessionTimeoutMessage_kioskMode_main",[o,s])}else{n=i.i18n.getText("sessionTimeoutMessage_main",[o,s])}return n};this.createContinueWorkingDialog=function(){m.debug("SessionHandler.createContinueWorkingDialog :: Continue working dialog being created","","SessionHandler");this.oMessageVBox=new u;this.oSessionKeepAliveLabel=new a({text:{parts:["/SessionRemainingTimeInSeconds"],formatter:this.continueWorkingFormatter}});this.oMessageVBox.addItem(this.oSessionKeepAliveLabel);if(this.oConfig.enableAutomaticSignout===false){this.oLostDataReminder=new a({text:i.i18n.getText("sessionTimeoutMessage_unsavedData")});this.oMessageVBox.addItem(this.oLostDataReminder)}this.oSessionKeepAliveLabel.setModel(this.oModel);this.oSessionKeepAliveDialog=new s("sapUshellKeepAliveDialog",{title:i.i18n.getText("sessionTimeoutMessage_title"),type:"Message",state:T.Warning,content:this.oMessageVBox,beginButton:this.createContinueWorkingButton(),afterClose:function(){this.oSessionKeepAliveDialog.destroy()}.bind(this)}).addStyleClass("sapContrastPlus");if(this.oConfig.enableAutomaticSignout===true){this.oSignOutButton=new o({text:i.i18n.getText("logoutBtn_title"),tooltip:i.i18n.getText("logoutBtn_tooltip"),press:p.defaultLogout.bind(p)});this.oSessionKeepAliveDialog.setEndButton(this.oSignOutButton)}return this.oSessionKeepAliveDialog};this.createContinueWorkingButton=function(){return new o({text:i.i18n.getText("sessionTimeoutMessage_continue_button_title"),type:S.Emphasized,press:d.continueWorkingButtonPressHandler.bind(d,false)})};this.continueWorkingButtonPressHandler=function(e){m.debug("SessionHandler.continueWorkingButtonPressHandler :: Session was extended"+e?"automatically":"by user","","SessionHandler");if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close()}clearTimeout(this.remainingTimer);if(!e){this.putTimestampInStorage(this._getCurrentDate())}this.monitorUserIsInactive();this.attachUserEvents();this.attachVisibilityEvents();v.postMessageToMultipleIframes("sap.ushell.sessionHandler","extendSessionEvent",{})};this.createSessionExpiredDialog=function(){this.oSessionExpiredDialog=new s("sapUshellSessionTimedOutDialog",{title:i.i18n.getText("sessionExpiredMessage_title"),type:"Message",state:T.Warning,content:new a({text:i.i18n.getText("sessionExpiredMessage_main")}),beginButton:this.createReloadButton(),afterClose:function(){this.oSessionExpiredDialog.destroy()}.bind(this)}).addStyleClass("sapContrastPlus");return this.oSessionExpiredDialog};this.createReloadButton=function(){return new o({text:i.i18n.getText("sessionExpiredMessage_reloadPage_button_title"),press:function(){d.oSessionExpiredDialog.close();location.reload()}})};this.attachUserEvents=function(){jQuery(document).on("mousedown.sessionTimeout mousemove.sessionTimeout",this.userActivityHandler.bind(this));jQuery(document).on("keyup.sessionTimeout",this.userActivityHandler.bind(this));jQuery(document).on("touchstart.sessionTimeout",this.userActivityHandler.bind(this));this.oAppLifeCycleService.attachAppLoaded({},this.userActivityHandler,this)};this.detachUserEvents=function(){jQuery(document).off("mousedown.sessionTimeout mousemove.sessionTimeout");jQuery(document).off("keydown.sessionTimeout");jQuery(document).off("touchstart.sessionTimeout");this.oAppLifeCycleService.detachAppLoaded(this.userActivityHandler,this)};this.onVisibilityChange=function(e){if(e.target&&e.target.visibilityState==="visible"){this.monitorUserIsInactive(false)}};this.attachVisibilityEvents=function(){document.addEventListener("visibilitychange",this._fnOnVisibilityChange)};this.detachVisibilityEvents=function(){document.removeEventListener("visibilitychange",this._fnOnVisibilityChange)};this.putTimestampInStorage=function(e){m.debug("SessionHandler.putTimestampInStorage :: Timestamp is "+e,"","SessionHandler");var i=this.getLocalStorage();if(i){i.put("lastActivityTime",e);if(this.bBackendRequestsActive===false){this._setConnectionActive(true)}}};this.getTimestampFromStorage=function(){var e=this.getLocalStorage();if(e){return e.get("lastActivityTime")}return null};this.timeNow=function(){return Math.floor(Date.now()/1e3)};this.timeLastInteraction=function(){return Math.floor(new Date(this.getTimestampFromStorage()).getTime()/1e3)};this.timeOver=function(){return Math.floor(this.timeLastInteraction()+this.oConfig.sessionTimeoutIntervalInMinutes*60)};this.timePopup=function(){return Math.floor(this.timeLastInteraction()+this.oConfig.sessionTimeoutIntervalInMinutes*60-this.oConfig.sessionTimeoutReminderInMinutes*60)};this.userActivityHandler=function(){if(this.oUserActivityTimer!==undefined){return}this.oUserActivityTimer=setTimeout(function(){m.debug("SessionHandler.userActivityHandler :: Timed time stamp update","","SessionHandler");d.putTimestampInStorage(d._getCurrentDate());d.oUserActivityTimer=undefined},1e3)};this._getCurrentDate=function(){return new Date};this.logout=function(){return new Promise(function(e){m.debug("SessionHandler.logout :: Logout initiated","","SessionHandler");function t(t){if(f===true){d.detachUserEvents();d.detachVisibilityEvents()}if(d.oUserActivityTimer){clearTimeout(d.oUserActivityTimer)}if(d.remainingTimer){clearTimeout(d.remainingTimer)}if(d.notifyServerTimer){clearTimeout(d.notifyServerTimer)}t.openLoadingScreen();t.showAppInfo(i.i18n.getText("beforeLogoutMsg"),null);p.setDirtyFlag(false);e()}var n=new c({text:""});var s;v.postMessageToMultipleIframes("sap.ushell.sessionHandler","logout",{},true).then(async function(){if(b===false){b=true;window.clearTimeout(s);t(n)}});s=window.setTimeout(async function(){b=true;t(n)},4e3)})}};return I},false);
//# sourceMappingURL=SessionHandler.js.map