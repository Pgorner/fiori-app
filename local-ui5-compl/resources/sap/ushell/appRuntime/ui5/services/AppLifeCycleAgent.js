// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/UriParameters","sap/base/assert","sap/ui/core/EventBus","sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/EventHub","sap/ui/thirdparty/hasher","sap/ushell/utils/UrlParsing","sap/ushell/resources","sap/ushell/appRuntime/ui5/services/Container","sap/ushell/appRuntime/ui5/AppRuntimeContext","sap/ushell/appRuntime/ui5/AppCommunicationMgr","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/ushell/appRuntime/ui5/performance/FesrEnhancer"],function(e,t,n,s,r,a,i,p,o,u,l,c,f,d,h,g,m){"use strict";function A(){var A=this,v,y,I=true,C={},b,S={},P={},R={},w={},N,F,L,H;this.init=function(e,t,n,s,r,a){this.resetCurrentApp();v=e;b=t;F=n;if(s!==undefined){I=s}this.addAppInfoToCache(r,a);h.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return A.create(t)}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return A.destroy(t)}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return A.store(t)}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return A.restore(t)}}}}});o.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&P[e.componentId]){P[e.componentId]=e.disable}});this._sendAppRuntimeSetup();if(!c.browserI18n){c.browserI18n=c.getTranslationModel(window.navigator.language).getResourceBundle()}H=c.browserI18n.getText("dataLossExternalMessage");window.onbeforeunload=function(){if(f.getDirtyFlag()){return H}return undefined}};this._sendAppRuntimeSetup=()=>{const e={isStateful:true,isKeepAlive:true,isIframeValid:true,session:{bLogoutSupport:true}};const t={session:{bLogoutSupport:true}};g.postMessageToFLP("sap.ushell.services.appLifeCycle.setup",window["sap-ushell-config"]?.ui5appruntime?.config?.stateful===false?t:e)};this.create=function(e){return new Promise(function(t,o){var c,f,h,g,v="",y;m.startInteraction();c=e.body.sUrl;if(d.getIsScube()){h=n.fromURL(c).get("sap-remote-intent");s(typeof h==="string","AppLifeCycleAgent::create - sAppIntent must be string");if(e.body.sHash.indexOf("Shell-startIntent")===0){g=l.parseShellHash(e.body.sHash);v=g.params["sap-shell-so"]+"-"+g.params["sap-shell-action"]}}else{f=n.fromURL(c).get("sap-ui-app-id");s(typeof f==="string","AppLifeCycleAgent::create - sAppId must be string")}u.disableCFLPUpdate=true;u.replaceHash("");u.replaceHash(e.body.sHash);u.disableCFLPUpdate=false;if(i.browser.chrome){p.show(0)}if(L){L._resetBackNavigationCallback()}r.getInstance().publish("launchpad","appOpening",{});A.getAppInfo(f,c,h).then(function(e){let n;if(Object.keys(S).length>0){if(d.getIsScube()&&v.length>0){n=t=>S[t].sAppIntent===v&&S[t].ui5ComponentName===e.oResolvedHashFragment.ui5ComponentName}else{n=t=>S[t].ui5ComponentName&&S[t].ui5ComponentName===e?.oResolvedHashFragment?.ui5ComponentName}y=Object.keys(S).find(n);if(y){A.destroy({body:{sCacheId:y}},true)}}A.expandSapIntentParams(new a(c).query(true)).then(function(n){b(f,n,e.oResolvedHashFragment,h,e.oParsedHash).then(function(e){F(e);r.getInstance().publish("sap.ushell","appOpened",{});t({deletedKeepAliveId:y})})})})})};this.destroy=function(t,n){function s(t){var n=t.sId||"<unknown>";try{t.destroy()}catch(t){e.error("exception when trying to close sapui5 application with id '"+n+"' when running inside the appruntime iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",t.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}var a=t.body.sCacheId;if(N.oApp===undefined&&a===undefined){g.postMessageToFLP("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}if(a&&S[a]){if(S[a].oApp===N.oApp){this.resetCurrentApp()}delete P[S[a].oApp.sId];s(S[a].oApp);delete S[a]}else if(N.oApp){delete P[N.oApp.sId];s(N.oApp);this.resetCurrentApp()}f.cleanDirtyStateProviderArray();if(L){L._resetBackNavigationCallback()}m.setAppShortId();r.getInstance().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.store=function(e){var t=e.body.sCacheId,n=this.cloneCurrentAppEntry(N),s;if(N.oApp===undefined){g.postMessageToFLP("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}S[t]=n;if(L){w[t]=L._getBackNavigationCallback()}s=n.oApp.getComponentInstance();n.oApp.setVisible(false);R[t]=f.getAsyncDirtyStateProviders();f.cleanDirtyStateProviderArray();if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.deactivate()}else{if(s.suspend){s.suspend()}if(s.getRouter&&s.getRouter()){s.getRouter().stop()}}}r.getInstance().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.restore=function(e){var t=e.body.sCacheId,n=S[t],s=n.oApp.getComponentInstance(),a=P[n.oApp.sId];u.disableCFLPUpdate=true;u.replaceHash("");u.replaceHash(e.body.sHash);u.disableCFLPUpdate=false;r.getInstance().publish("launchpad","appOpening",{});n.oApp.setVisible(true);if(R[t]){f.setAsyncDirtyStateProviders(R[t])}if(L){L.setBackNavigation(w[t])}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.activate()}else{if(s.restore){s.restore()}if(s.getRouter&&s.getRouter()&&s.getRouter().initialize){if(a===false){s.getRouter().initialize()}else{s.getRouter().initialize(true)}}}N=this.cloneCurrentAppEntry(n)}r.getInstance().publish("sap.ushell","appOpened",{});setTimeout(function(){g.postMessageToFLP("sap.ushell.services.AppLifeCycle.setNewAppInfo",{info:n.oAppAttributes})},500);return Promise.resolve()};this.expandSapIntentParams=function(e){return new Promise(function(n,s){if(e.hasOwnProperty("sap-intent-param")){var r=e["sap-intent-param"];g.postMessageToFLP("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:r}).then(function(s){delete e["sap-intent-param"];var r=t({},e,new a("?"+s).query(true),true);n(r)},function(t){n(e)})}else{n(e)}})};this.addAppParamsToIntent=function(e,t){return A.expandSapIntentParams(new a(e).query(true)).then(function(e){return A.getApplicationParameters(e)})};this.getApplicationParameters=function(e){return new Promise(function(t){var n,s,r;function i(e,t){var n="";if(e&&e.length>0){n=(e.startsWith("?")?"":"?")+e}if(t&&t.length>0){n+=(n.length>0?"&":"?")+t}return n}if(e.hasOwnProperty("sap-startup-params")){n=new a("?"+e["sap-startup-params"]).query(true);if(n.hasOwnProperty("sap-intent-param")){s=n["sap-intent-param"];delete n["sap-intent-param"]}r=new a("?").query(n).toString();if(s){g.postMessageToFLP("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:s}).then(function(e){t(i(r,e))},function(e){t(i(r))})}else{t(i(r))}}else{t("")}})};this.getAppInfo=function(e,t,n){return new Promise(function(s){if(n){A.addAppParamsToIntent(t,n).then(function(e){if(e.length>0){e=new a(e).removeSearch("sap-remote-system").removeSearch("sap-ushell-defaultedParameterNames").toString()}f.getServiceAsync("NavTargetResolutionInternal").then(function(t){t.resolveHashFragmentLocal("#"+n+e).done(function(t){var r=l.parseShellHash("#"+n+e);s({oResolvedHashFragment:t,oParsedHash:r})}).fail(function(e){})})})}else{var r=function(){y.getAppInfo(e,t).then(function(t){A.addAppInfoToCache(e,t);s({oResolvedHashFragment:t})})};if(I===true&&C[e]){s({oResolvedHashFragment:JSON.parse(JSON.stringify(C[e]))})}else if(y){r()}else{sap.ui.require([v.replace(/\./g,"/")],function(e){y=e;r()})}}})};this.addAppInfoToCache=function(e,t){if(e&&t&&I===true&&C[e]===undefined){C[e]=JSON.parse(JSON.stringify(t))}};this.setCurrentApp=function(e,t,n){this.resetCurrentApp();N.oApp=e;N.sAppIntent=t;N.ui5ComponentName=n;if(N.oApp){P[N.oApp.sId]=true}};this.setCurrentAppAttributes=function(e){N.oAppAttributes=e};this.resetCurrentApp=function(){N={oApp:undefined,sAppIntent:undefined,ui5ComponentName:undefined,oAppAttributes:{}}};this.cloneCurrentAppEntry=function(e){return{oApp:e.oApp,sAppIntent:e.sAppIntent,ui5ComponentName:e.ui5ComponentName,oAppAttributes:e.oAppAttributes}};this.setShellUIService=function(e){L=e};this.checkDataLossAndContinue=function(){if(f.getDirtyFlag()){if(window.confirm(H)){f.setDirtyFlag(false);return true}return false}return true}}return new A},true);
//# sourceMappingURL=AppLifeCycleAgent.js.map