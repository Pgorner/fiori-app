// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Element","sap/ui/core/EventBus","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/UIComponent","sap/ui/Device","sap/m/library","sap/m/Popover","sap/ushell/EventHub","sap/ushell/library","sap/ushell/resources","sap/ushell/utils","sap/ushell/ui/shell/ShellHeadItem","sap/ushell/Container","sap/ushell/state/ShellModel"],function(t,i,e,o,n,s,a,r,c,l,f,h,u,d,p,g){"use strict";var N=r.PlacementType;var v=f.FloatingNumberType;function b(){return i.getElementById("NotificationsCountButton")}return s.extend("sap.ushell.components.shell.Notifications.Component",{metadata:{version:"1.132.1",library:"sap.ushell.components.shell.Notifications",dependencies:{libs:["sap.m"]}},createContent:function(){this._aTimeouts=[];this.oRenderer=p.getRendererInternal("fiori2");this.oConfigModel=g.getConfigModel();p.getServiceAsync("NotificationsV2").then(function(t){this.oNotificationsService=t;if(this.oNotificationsService.isEnabled()===true){e.getInstance().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);this.oConfigModel.setProperty("/enableNotifications",true);this.oNotificationsService.init();if(this.oRenderer.getShellConfig().enableNotificationsUI===true){this.oConfigModel.setProperty("/enableNotificationsUI",true);this.oNotificationsService.registerNotificationsUpdateCallback(this._updateCount.bind(this),true)}this._createNotificationButton(this.oConfigModel);l.on("showNotifications").do(this._toggleNotifications.bind(this))}}.bind(this))},_createNotificationButton:function(t){var i=new d({id:"NotificationsCountButton",tooltip:h.i18n.getText("notificationsBtn_title"),icon:o.getIconURI("bell"),text:h.i18n.getText("notificationsBtn_title"),ariaLabel:h.i18n.getText("notificationsBtn_title"),ariaHaspopup:"dialog",enabled:true,selected:false,visible:"{configModel>/enableNotifications}",floatingNumber:"{configModel>/notificationsCount}",floatingNumberMaxValue:a.system.phone?99:999,floatingNumberType:v.Notifications,press:function(){l.emit("showNotifications",Date.now())}});i.setModel(t,"configModel");i.setModel(h.i18nModel,"i18n");this.oRenderer.showHeaderEndItem([i.getId()],false,["home","app"])},_handleAlerts:function(t,i,e){(e||[]).forEach(this.handleNotification.bind(this))},handleNotification:function(t){var i=this.oRenderer.addRightFloatingContainerItem({press:function(){if(this.oPopover){this.oPopover.close()}if(window.hasher.getHash()!==t.NavigationTargetObject+"-"+t.NavigationTargetAction){if(t.NavigationTargetObject&&t.NavigationTargetAction){u.toExternalWithParameters(t.NavigationTargetObject,t.NavigationTargetAction,t.NavigationTargetParams)}}this.oNotificationsService.markRead(t.Id)}.bind(this),close:function(){this.oRenderer.removeRightFloatingContainerItem(i.getId(),true)}.bind(this),datetime:h.i18n.getText("notification_arrival_time_now"),title:t.SensitiveText?t.SensitiveText:t.Text,description:t.SubTitle,unread:t.IsRead,priority:"High",hideShowMoreButton:true},true,true);this.oRenderer.showRightFloatingContainer(true);var e=setTimeout(function(){this.oRenderer.removeRightFloatingContainerItem(i.getId(),true)}.bind(this),5200);this._aTimeouts.push(e)},_updateCount:function(){this.oNotificationsService.getUnseenNotificationsCount().then(function(t){this.oConfigModel.setProperty("/notificationsCount",parseInt(t,10))}.bind(this)).catch(function(i){t.error("Notifications - call to notificationsService.getCount failed: ",i)})},_getPopover:function(){if(!this._oNotificationsPopoverPromise){this._oNotificationsPopoverPromise=new Promise(function(t,i){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(e){e.create({id:"notificationsView",viewName:"sap.ushell.components.shell.Notifications.Notifications",viewData:{notificationsService:this.oNotificationsService}}).then(function(i){var e=i.byId("notificationIconTabBar");e.setAriaTexts({headerLabel:h.i18n.getText("Notifications.Popover.IconTabBar.Header.AriaLabel")});var o=i.byId("sapUshellNotificationsListDate");o.enhanceAccessibilityState=function(t,i){i.hidden=true;return i};var s=i.byId("sapUshellNotificationsListPriority");s.enhanceAccessibilityState=function(t,i){i.hidden=true;return i};var a=i.byId("sapUshellNotificationsListType");a.enhanceAccessibilityState=function(t,i){i.hidden=true;return i};var r=new c("shellNotificationsPopover",{showHeader:false,placement:N.Bottom,showArrow:true,content:i,beforeClose:function(t){t.getSource().getContent()[0].invalidate();this._resetCount()}.bind(this)});r._oAriaLabelledByText=new n(r.getId()+"-labelledBy",{text:h.i18n.getText("NotificationToggleButton.NoNewNotifications")}).toStatic();r.addDependent(r._oAriaLabelledByText);r.addAriaLabelledBy(r._oAriaLabelledByText);r.addStyleClass("sapUshellNotificationsPopup");r.addStyleClass("sapContrastPlus");t(r)}.bind(this)).catch(i)}.bind(this))}.bind(this))}return this._oNotificationsPopoverPromise},_toggleNotifications:function(t){this._getPopover().then(function(e){var o=b();if(!o.$().width()){o=i.getElementById("endItemsOverflowBtn")}if(e.isOpen()){e.close()}else if(t!==false){this._resetCount();e.openBy(o)}}.bind(this))},_resetCount:function(){this.oConfigModel.setProperty("/notificationsCount",0);this.oNotificationsService.notificationsSeen()},exit:function(){e.getInstance().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);if(this.oNotificationsService&&this.oNotificationsService.isEnabled()===true){this.oNotificationsService.destroy()}this.oNotificationsService=null;var t=b();if(t){this.oRenderer.hideHeaderEndItem(t,false);t.destroy()}this.oRenderer=null;var o=i.getElementById("notificationsView");if(o){o.destroy();o=null}this._aTimeouts.forEach(window.clearTimeout)}})});
//# sourceMappingURL=Component.js.map