// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/ushell/Container","sap/ushell/EventHub","sap/ui/model/json/JSONModel"],function(e,t,n,i,o,r,a,s,p,d,c,l,u){"use strict";var h=t.dnd.RelativeDropPosition;var g=t.InvisibleMessageMode;return n.extend("sap.ushell.components.shell.NavigationBarMenu.controller.NavigationBarMenu",{onInit:function(){this.pMenuServicePromise=c.getServiceAsync("Menu");this._oInvisibleMessageInstance=e.getInstance();this.oViewConfigurationModel=new u({enableMenuBarNavigation:true,contextMenu:{enableMoveDown:false,enableMoveUp:false,enablePin:false}});this.getView().setModel(this.oViewConfigurationModel,"viewConfiguration");this._oEventHubListener=l.on("enableMenuBarNavigation").do(e=>{this.oViewConfigurationModel.setProperty("/enableMenuBarNavigation",e)})},onExit:function(){if(this._oInvisibleMessageInstance){this._oInvisibleMessageInstance.destroy()}this._oEventHubListener.off()},_onPinnedSpacesUpdateFinished:function(e){var t=p.i18n.getText("NavigationBarMenu.PinnedSpaces.Title",[e.getParameter("total")||0]);this.byId("PinnedSpacesTreeTitle").setText(t)},openNavigationBarMenuPopover:function(e){const t=e.getSource();if(!this._pPopoverPromise){this._pPopoverPromise=o.load({type:"XML",id:this.getView().getId(),controller:this,name:"sap.ushell.components.shell.NavigationBarMenu.view.NavigationBarMenuPopover"}).then(e=>{this.oModel=this.getOwnerComponent().oPropagatedProperties.oModels.menu;e.setModel(this.oModel,"spaces");this.getView().addDependent(e);return e})}this._pPopoverPromise.then(e=>{this._bindPinnedSpaces().then(()=>{e.openBy(t)})})},closeNavigationBarMenuPopover:function(){this._pPopoverPromise.then(function(e){e.close()})},_configureContextMenuEnablement:function(e){const t=e.getParameter("listItem");if(!t){return}const n=e.getSource();const i=n.getItems();const o=n.indexOfItem(t);const r=n.getId().includes("PinnedSpaces");const a=t.getBindingContext("spaces");const s=a.getProperty("pinned")!==undefined;this.oViewConfigurationModel.setProperty("/contextMenu/enableMoveUp",r&&o>0);this.oViewConfigurationModel.setProperty("/contextMenu/enableMoveDown",r&&o<i.length-1);this.oViewConfigurationModel.setProperty("/contextMenu/enablePin",s)},_moveSpaceUp:function(e){if(this._handleSpacesSwap(true)){e.preventDefault();e.stopPropagation?.()}},_moveSpaceDown:function(e){if(this._handleSpacesSwap(false)){e.preventDefault();e.stopPropagation?.()}},handlePinButtonPress:function(e){const t=e.getSource();const n=t.getBindingContext("spaces").getPath();const i=this.oModel.getProperty(n+"/pinned");if(!i){this._pinSpace(n)}else{this._unpinSpace(n,true)}if(!t.getId().includes("PinnedSpaces")){return}const o=this.byId("NavigationBarMenuPopover");o.focus();const r=this.byId("PinnedSpaces");const a={onAfterRendering:()=>{r.focus();r.removeEventDelegate(a)}};r.addEventDelegate(a)},unpinAllSpaces:function(){var e=this.byId("PinnedSpaces");var t=e.getModel("spaces").getData();t=t.map(function(e){e.pinnedSortOrder=parseInt(e.pinnedSortOrder,10);return e});var n=t.sort(function(e,t){if(e.pinnedSortOrder<t.pinnedSortOrder){return-1}if(e.pinnedSortOrder>t.pinnedSortOrder){return 1}return 0});var i;var o=false;for(var r=0;r<n.length;++r){i=n[r];if(o){i.pinned=false;i.pinnedSortOrder="-1"}else{i.pinnedSortOrder=""+i.pinnedSortOrder;if(i.type==="separator"){o=true}}}this._savePinnedSpaces()},rearrangePinnedSpaces:function(e){var t=e.getParameter("draggedControl").getBindingContext("spaces");var n=this.oModel.getProperty(t.getPath()).pinnedSortOrder;var i=e.getParameter("droppedControl");var o=i.getBindingContext("spaces");var r=this.oModel.getProperty(o.getPath()).pinnedSortOrder;var a=e.getParameter("dropPosition");var s=r+(a===h.After?1:0);this._rearrangePinnedSpaces(n,s,i,a)},_rearrangePinnedSpaces:function(e,t,n,i){this.pMenuServicePromise.then(function(o){o.moveMenuEntry(e,t);var r=this.byId("PinnedSpaces");var a={onAfterRendering:function(){var o=r.getItems();var s=r.indexOfItem(n);var p;if(e<t){p=s-(i===h.Before?1:0)}else{p=s+(i===h.After?1:0)}var d=o[p];if(d){d.focus()}n.removeEventDelegate(a)}};n.addEventDelegate(a);var s=p.i18n.getText("NavigationBarMenu.PinnedSpaces.Moved");this._oInvisibleMessageInstance.announce(s,g.Polite);this._savePinnedSpaces()}.bind(this))},_bindPinnedSpaces:function(){var e=this.byId("PinnedSpaces");if(!this._pCustomTreeItemPromise){this._pCustomTreeItemPromise=o.load({type:"XML",async:true,controller:this,name:"sap.ushell.components.shell.NavigationBarMenu.view.CustomTreeItem"}).then(function(t){t.addEventDelegate({onsapdownmodifiers:this._moveSpaceDown.bind(this),onsapupmodifiers:this._moveSpaceUp.bind(this)});e.bindItems({path:"spaces>/",filters:[new r({path:"pinned",operator:a.EQ,value1:true}),new r({path:"type",operator:a.NE,value1:"separator"}),new r({path:"isHomeEntry",operator:a.EQ,value1:false})],sorter:[new s({path:"pinnedSortOrder",descending:false})],parameters:{arrayNames:["menuEntries"]},template:t,templateShareable:false})}.bind(this))}return this._pCustomTreeItemPromise},_handleSpacesSwap:function(e){const t=this.byId("PinnedSpaces");const n=t.getItems();let i;for(let t=0;t<n.length;++t){i=n[t];if(document.activeElement!==i.getFocusDomRef()){continue}const o=i.getBindingContext("spaces");const r=this.oModel.getProperty(o.getPath()).pinnedSortOrder;const a=n[e?t-1:t+1];if(!a){return false}const s=a.getBindingContext("spaces");const p=this.oModel.getProperty(s.getPath()).pinnedSortOrder;this._rearrangePinnedSpaces(r,e?p:p+1,a,e?h.Before:h.After);return true}},allSpacesFactory:function(e,t){var n=t.getModel().getProperty(t.getPath());var i=n.menuEntries||[];var o=this.byId("AllSpaces").getDependents()[0].clone(e);o.setType("Active");o.attachPress(this.onMenuItemSelection,this);if(i.length<1){o.addStyleClass("sapMTreeItemBaseLeaf")}if(n.type==="separator"||n.isHomeEntry){o.setVisible(false)}return o},_unpinSpace:function(e,t){this.oModel.setProperty(e+"/pinned",false);this.oModel.setProperty(e+"/pinnedSortOrder","-1");if(t){this._savePinnedSpaces()}},_pinSpace:function(e){var t=this.byId("PinnedSpaces").getItems().length;var n=2;if(t>0){var i=this.byId("PinnedSpaces").getItems()[t-1];var o=i.getBindingContextPath("spaces");n=this.oModel.getProperty(o+"/pinnedSortOrder")+1}this.oModel.setProperty(e+"/pinnedSortOrder",n);this.oModel.setProperty(e+"/pinned",true);this._savePinnedSpaces()},_performNavigation:function(e){return c.getServiceAsync("Navigation").then(function(t){var n={};e.parameters.forEach(function(e){if(e.name&&e.value){n[e.name]=[e.value]}});return t.navigate({target:{semanticObject:e.semanticObject,action:e.action},params:n})})},_openURL:function(e){d.openURL(e.url,"_blank")},onMenuItemSelection:function(e){var t=e.getSource();var n=t.getBindingContextPath("spaces");var i=this.oModel.getProperty(n);var o=e.getParameter("id").includes("AllSpaces");if(!o){return}if(t.isLeaf()){if(i.type==="IBN"){this._performNavigation(i.target).then(this.closeNavigationBarMenuPopover.bind(this))}if(i.type==="URL"){this._openURL(i.target);this.closeNavigationBarMenuPopover()}return}},_savePinnedSpaces:function(){this.pMenuServicePromise.then(function(e){this.oModel.refresh(true);return e.savePersonalization()}.bind(this))}})});
//# sourceMappingURL=NavigationBarMenu.controller.js.map