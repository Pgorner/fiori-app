// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/EventBus","sap/ushell/library","sap/ui/core/mvc/Controller","sap/ushell/components/tiles/utils","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/utils/WindowUtils","sap/m/library","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/Log","sap/ushell/utils/DynamicTileRequest","sap/ushell/utils/UrlParsing","sap/ushell/utils","sap/ushell/EventHub","sap/ushell/Container"],function(e,t,i,a,r,s,n,o,l,jQuery,g,p,u,c,f,d){"use strict";var _=o.GenericTileScope;var v=o.GenericTileMode;var h=t.AppType;var y="sap.ushell.components.tiles.applauncherdynamic.DynamicTile";return i.extend(y,{_aDoables:[],oDataRequest:null,sConfigNavigationTargetUrlOld:"",REFRESH_INTERVAL_MIN:10,constructTargetUrlWithSapSystem:function(e,t){var i;if(t){if(u.isIntentUrl(e)){i=u.parseShellHash(e);if(!i.params){i.params={}}i.params["sap-system"]=t;e="#"+u.constructShellHash(i)}else{e+=(e.indexOf("?")<0?"?":"&")+"sap-system="+t}}return e},onInit:function(){var t=this;var i=this.getView();var r=i.getViewData();var n=r.chip;var o=a.getAppLauncherConfig(n,n.configurationUi.isEnabled(),false);var p=o.navigation_target_url;var u=n.url.getApplicationSystem();this.sConfigNavigationTargetUrlOld=o.navigation_target_url;g.setLevel(2,y);this.bIsRequestCompleted=false;this.navigationTargetUrl=this.constructTargetUrlWithSapSystem(p,u);var c=new l({sizeBehavior:s.last("/core/home/sizeBehavior"),wrappingType:s.last("/core/home/wrappingType"),config:o,mode:o.display_mode||v.ContentMode,data:a.getDataToDisplay(o,{number:n.preview&&n.preview.isEnabled()?1234:"..."}),nav:{navigation_target_url:n.configurationUi&&n.configurationUi.isEnabled()?"":this.navigationTargetUrl},search:{display_highlight_terms:[]}});i.setModel(c);this._aDoables.push(s.on("/core/home/sizeBehavior").do(function(e){c.setProperty("/sizeBehavior",e)}));if(n.types){n.types.attachSetType(function(e){if(t.tileType!==e){if(e==="link"){c.setProperty("/mode",v.LineMode)}else{c.setProperty("/mode",c.getProperty("/config/display_mode")||v.ContentMode)}t.tileType=e}})}if(!this.tileType){this.tileType="tile"}if(n.search){var f=i.getModel().getProperty("/config/display_search_keywords");var _=f.split(/[, ]+/).filter(function(e,t){return e&&e!==""});if(o.display_title_text&&o.display_title_text!==""&&_.indexOf(o.display_title_text)===-1){_.push(o.display_title_text)}if(o.display_subtitle_text&&o.display_subtitle_text!==""&&_.indexOf(o.display_subtitle_text)===-1){_.push(o.display_subtitle_text)}if(o.display_info_text&&o.display_info_text!==""&&_.indexOf(o.display_info_text)===-1){_.push(o.display_info_text)}if(o.display_number_unit&&o.display_number_unit!==""&&_.indexOf(o.display_number_unit)===-1){_.push(o.display_number_unit)}n.search.setKeywords(_);n.search.attachHighlight(function(e){i.getModel().setProperty("/search/display_highlight_terms",e)})}if(n.bag&&n.bag.attachBagsUpdated){n.bag.attachBagsUpdated(function(e){if(e.indexOf("tileProperties")>-1){a._updateTilePropertiesTexts(i,n.bag.getBag("tileProperties"))}})}if(n.configuration&&n.configuration.attachConfigurationUpdated){n.configuration.attachConfigurationUpdated(function(e){if(e.indexOf("tileConfiguration")>-1){a._updateTileConfiguration(i,n.configuration.getParameterValueAsString("tileConfiguration"))}})}if(n.preview){n.preview.setTargetUrl(this.navigationTargetUrl);n.preview.setPreviewIcon(o.display_icon_url);n.preview.setPreviewTitle(o.display_title_text);if(n.preview.setPreviewSubtitle&&typeof n.preview.setPreviewSubtitle==="function"){n.preview.setPreviewSubtitle(o.display_subtitle_text)}}if(n.configurationUi.isEnabled()){n.configurationUi.setAsyncUiProvider(function(){return a.getConfigurationUi(i,"sap.ushell.components.tiles.applauncherdynamic.Configuration").then(function(e){n.configurationUi.attachCancel(t.onCancelConfiguration.bind(null,e));n.configurationUi.attachSave(t.onSaveConfiguration.bind(null,e));return e})});this.getView().getContent()[0].setTooltip(a.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"))}else if(!n.preview||!n.preview.isEnabled()){if(!u){d.addRemoteSystemForServiceUrl(o.service_url)}this.bNeedsRefresh=true;this.iNrOfTimerRunning=0}if(n.refresh){n.refresh.attachRefresh(this.refreshHandler.bind(this))}if(n.visible){n.visible.attachVisible(this.visibleHandler.bind(this))}if(n.actions){var h;var b=o.actions;if(b){h=b.slice()}else{h=[]}if(s.last("/core/shell/enablePersonalization")){var m=c.getProperty("/mode")===v.LineMode?"link":"tile";var T=a.getTileSettingsAction(c,this.onSaveRuntimeSettings.bind(this),m);h.push(T)}n.actions.setActionsProvider(function(){return h})}e.getInstance().subscribe("launchpad","sessionTimeout",this._clearRequest,this)},stopRequests:function(){if(this.oDataRequest){if(this.oDataRequest.abort()){this.bNeedsRefresh=true}}},_clearRequest:function(){this.stopRequests();clearTimeout(this.timer)},onExit:function(){if(this.oDataRequest){this._clearRequest();this.oDataRequest.destroy()}e.getInstance().unsubscribe("launchpad","sessionTimeout",this._clearRequest,this);this._aDoables.forEach(function(e){e.off()});this._aDoables=[]},onPress:function(e){var t=this.getView();var i=t.getViewData();var a=t.getModel();var r=a.getProperty("/nav/navigation_target_url");var o=i.chip;var l=a.getProperty("/config");if(e.getSource().getScope&&e.getSource().getScope()===_.Display){if(o.configurationUi.isEnabled()){o.configurationUi.display()}else if(r){f.emit("UITracer.trace",{reason:"LaunchApp",source:"Tile",data:{targetUrl:r}});if(r[0]==="#"){hasher.setHash(r)}else{var g=s.last("/core/shell/enableRecentActivity")&&s.last("/core/shell/enableRecentActivityLogging");if(g){var p={title:l.display_title_text,appType:h.URL,url:l.navigation_target_url,appId:l.navigation_target_url};d.getRendererInternal("fiori2").logRecentActivity(p)}n.openURL(r,"_blank")}}}},onSaveRuntimeSettings:function(e){var t=this.getView();var i=t.getModel();var a=t.getViewData().chip;var r=i.getProperty("/config");var s=e.getModel();r.display_title_text=s.getProperty("/title")||"";r.display_subtitle_text=s.getProperty("/subtitle")||"";r.display_info_text=s.getProperty("/info")||"";r.display_search_keywords=s.getProperty("/keywords")||"";var n=a.bag.getBag("tileProperties");n.setText("display_title_text",r.display_title_text);n.setText("display_subtitle_text",r.display_subtitle_text);n.setText("display_info_text",r.display_info_text);n.setText("display_search_keywords",r.display_search_keywords);function o(e){g.error(e,null,y)}n.save(function(){g.debug("property bag 'tileProperties' saved successfully");i.setProperty("/config",r);i.setProperty("/data/display_title_text",r.display_title_text);i.setProperty("/data/display_subtitle_text",r.display_subtitle_text);i.setProperty("/data/display_info_text",r.display_info_text);i.refresh()},o)},onSaveConfiguration:function(e){var t=new jQuery.Deferred;var i=e.getModel();var r=i.getProperty("/tileModel");var s=e.getViewData().chip;var n=a.tileActionsRows2TileActionsArray(i.getProperty("/config/tile_actions_rows"));var o={display_icon_url:i.getProperty("/config/display_icon_url"),display_number_unit:i.getProperty("/config/display_number_unit"),service_url:i.getProperty("/config/service_url"),service_refresh_interval:i.getProperty("/config/service_refresh_interval"),navigation_use_semantic_object:i.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:i.getProperty("/config/navigation_target_url"),navigation_semantic_object:(i.getProperty("/config/navigation_semantic_object")||"").trim(),navigation_semantic_action:(i.getProperty("/config/navigation_semantic_action")||"").trim(),navigation_semantic_parameters:(i.getProperty("/config/navigation_semantic_parameters")||"").trim(),display_search_keywords:i.getProperty("/config/display_search_keywords")};var p=a.checkInputOnSaveConfig(e);if(!p){p=a.checkTileActions(e)}if(p){t.reject("mandatory_fields_missing");return t.promise()}if(o.navigation_use_semantic_object){o.navigation_target_url=a.getSemanticNavigationUrl(o);i.setProperty("/config/navigation_target_url",o.navigation_target_url)}var u=s.bag.getBag("tileProperties");u.setText("display_title_text",i.getProperty("/config/display_title_text"));u.setText("display_subtitle_text",i.getProperty("/config/display_subtitle_text"));u.setText("display_info_text",i.getProperty("/config/display_info_text"));u.setText("display_search_keywords",o.display_search_keywords);var c=s.bag.getBag("tileNavigationActions");a.populateTileNavigationActionsBag(c,n);function f(e,i){g.error(e,null,y);t.reject(e,i)}s.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(o)},function(){var i=a.getAppLauncherConfig(s,false,false);var n=a.getAppLauncherConfig(s,true,false);var o=new l({config:i,tileModel:r});e.setModel(o);r.setData({data:n,nav:{navigation_target_url:""}},false);if(s.preview){s.preview.setTargetUrl(i.navigation_target_url);s.preview.setPreviewIcon(i.display_icon_url);s.preview.setPreviewTitle(i.display_title_text);if(s.preview.setPreviewSubtitle&&typeof s.preview.setPreviewSubtitle==="function"){s.preview.setPreviewSubtitle(i.display_subtitle_text)}}u.save(function(){g.debug("property bag 'tileProperties' saved successfully");if(s.title){s.title.setTitle(i.display_title_text,function(){t.resolve()},f)}else{t.resolve()}},f);c.save(function(){g.debug("property bag 'navigationProperties' saved successfully")},f)},f);return t.promise()},successHandlerFn:function(e){var t=this.getView();var i=t.getModel();var r=i.getProperty("/config");var s=i.getProperty("/config/navigation_target_url");var n=i.getProperty("/config/service_refresh_interval");var o=i.getProperty("/config/service_url");var l=t.getViewData();var p=l.chip;var u=p.url.getApplicationSystem();if(l.properties&&l.properties.info){if(typeof e==="object"){e.info=l.properties.info}}var c=a.getDataToDisplay(r,e);i.setProperty("/data",c);if(this.sConfigNavigationTargetUrlOld!==s){this.navigationTargetUrl=this.constructTargetUrlWithSapSystem(s,u);this.sConfigNavigationTargetUrlOld=this.navigationTargetUrl}i.setProperty("/nav/navigation_target_url",a.addParamsToUrl(this.navigationTargetUrl,c));if(n>0){n=Math.max(n,this.REFRESH_INTERVAL_MIN);g.info("Wait "+n+" seconds before calling "+o+" again",null,y);this.refeshAfterInterval(n)}},errorHandlerFn:function(e,t){var i=this.getView();var a=i.getModel();var r=a.getProperty("/config/service_url");var s=e&&e.message?e.message:e;if(e.statusText==="Abort"||e.aborted===true){g.info("Data request from service "+r+" was aborted",null,y)}else{if(e.response){s+=" - "+e.response.statusCode+" "+e.response.statusText}var n=t?g.warning:g.error;n("Failed to update data via service\n service URL: "+r+"\n "+s,null,y);this._setTileIntoErrorState()}},_setTileIntoErrorState:function(){var e=a.getResourceBundleModel().getResourceBundle();var t=this.getView().getModel();var i=t.getProperty("/config");t.setProperty("/data",a.getDataToDisplay(i,{number:"???",info:e.getText("dynamic_data.error"),infoState:"Critical"}))},onCancelConfiguration:function(e){var t=e.getViewData();var i=e.getModel();var r=i.getProperty("/tileModel");var s=t.chip;var n=a.getAppLauncherConfig(s,false,false);i.setData({config:n,tileModel:r},false)},loadData:function(){var e=this.getView();var t=e.getViewData().chip;var i=e.getModel();var a=i.getProperty("/config/service_url");if(/;o=([;/?]|$)/.test(a)){a=t.url.addSystemToServiceUrl(a)}if(!a){g.error("No service URL given!",y);this._setTileIntoErrorState();return}if(!this.oDataRequest||this.oDataRequest.sUrl!==a){if(this.oDataRequest){this.oDataRequest.destroy()}this.sRequestUrl=a;var r={dataSource:i.getProperty("/config/data_source")};this.oDataRequest=new p(a,this.successHandlerFn.bind(this),this.errorHandlerFn.bind(this),"",r)}else if(this.oDataRequest){this.oDataRequest.refresh()}},refreshTile:function(){var e=this.getView();var t=e.getViewData();var i=t.chip.visible.isVisible();if(i&&this.bNeedsRefresh){this.bNeedsRefresh=false;this.loadData()}},refeshAfterInterval:function(e){this.iNrOfTimerRunning++;this.timer=window.setTimeout(function(){this.iNrOfTimerRunning--;if(this.iNrOfTimerRunning===0){this.bNeedsRefresh=true;this.refreshTile()}}.bind(this),c.sanitizeTimeoutDelay(e*1e3))},refreshHandler:function(){this.bNeedsRefresh=true;this.refreshTile()},visibleHandler:function(e){if(e){this.refreshTile()}else{this.stopRequests()}},formatters:{leanURL:n.getLeanURL.bind(n)}})});
//# sourceMappingURL=DynamicTile.controller.js.map