//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Element","sap/ui/core/Fragment","sap/ui/core/EventBus","sap/ushell/library","sap/ui/core/mvc/Controller","sap/ui/events/KeyCodes","sap/m/GenericTile","sap/ushell/resources","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/m/library","sap/m/MessageToast","sap/ushell/components/pages/StateManager","sap/ushell/EventHub","sap/ushell/utils","sap/m/Button","sap/base/strings/capitalize","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ushell/components/pages/controller/PagesAndSpaceId","sap/ushell/components/pages/MyHomeImport","sap/ui/thirdparty/hasher","sap/base/Log","sap/ushell/ui/launchpad/ActionItem","sap/ushell/ui/launchpad/Section","sap/ushell/Container","sap/ui/dom/jquery/Focusable"],function(e,t,i,n,a,o,r,s,l,d,g,u,c,h,p,m,v,f,P,_,S,M,C,y,b,A){"use strict";var I=g.LoadState;var w=n.DisplayFormat;return a.extend("sap.ushell.components.pages.controller.Pages",{onInit:function(){this._setPerformanceMark("FLP-PagesRuntime-onInit");this._oVisualizationInstantiationServicePromise=A.getServiceAsync("VisualizationInstantiation");this._oURLParsingService=A.getServiceAsync("URLParsing");this._oViewSettingsModel=new l({sizeBehavior:d.last("/core/home/sizeBehavior"),actionModeActive:false,actionModeEditActive:false,showHideButton:d.last("/core/catalog/enableHideGroups"),showAddButton:d.last("/core/catalog/enabled"),personalizationEnabled:d.last("/core/shell/enablePersonalization"),addToMyHomeOnly:false,gridContainerGap:[],gridContainerRowSize:[]});this.getView().setModel(this._oViewSettingsModel,"viewSettings");this._sMyHomePageId=d.last("/core/spaces/myHome/myHomePageId");this._aConfigListeners=d.on("/core/home/sizeBehavior").do(function(e){this._oViewSettingsModel.setProperty("/sizeBehavior",e)}.bind(this));this._oErrorPageModel=new l({title:"",description:"",details:"",pageAndSpaceId:"",technicalError:""});this.getView().setModel(this._oErrorPageModel,"errorPage");this.oInitFinishedPromise=Promise.all([this._oVisualizationInstantiationServicePromise,this.getOwnerComponent().getPagesService()]).then(function(e){this._oVisualizationInstantiationService=e[0];this.getView().setModel(e[1].getModel())}.bind(this));var e=A.getRendererInternal();this.bIsHomeIntentRootIntent=p.isFlpHomeIntent(e.getShellConfig().rootIntent);this.oErrorPage=this.byId("errorPage");this.oEmptyPage=this.byId("emptyPage");this.oPagesNavContainer=this.byId("pagesNavContainer");this.oPagesRuntimeNavContainer=this.byId("pagesRuntimeNavContainer");this.oPagesRuntimeNavContainer.to(this.oEmptyPage);c.init(this.oPagesRuntimeNavContainer,this.oPagesNavContainer);this.oEventHubListener=h.once("PagesRuntimeRendered").do(this._onFirstPageRendering.bind(this));this._oEventBus=i.getInstance();this._oEventBus.subscribe("launchpad","shellFloatingContainerIsDocked",this._handleUshellContainerDocked,this);this._oEventBus.subscribe("launchpad","shellFloatingContainerIsUnDocked",this._handleUshellContainerDocked,this);this.oVisualizationInstantiationListener=h.on("VizInstanceLoaded").do(function(){this._setPerformanceMark("FLP-TTI-Homepage");if(!this.oVisualizationInstantiationListenerTimeout){this.oVisualizationInstantiationListenerTimeout=setTimeout(function(){this.oVisualizationInstantiationListener.off()}.bind(this),5e3)}}.bind(this));this.fnBoundSetGridContainerSizes=this._setGridContainerSizes.bind(this);d.on("/core/home/sizeBehavior").do(this.fnBoundSetGridContainerSizes);h.on("themeChanged").do(this.fnBoundSetGridContainerSizes);this.sCurrentTargetPageId="";this._oInitPromise=this._openFLPPage().then(function(){if(!document.activeElement||document.activeElement===document.body){var t=this.oPagesNavContainer.getCurrentPage();var i=t&&t.getContent()[0];var n=i&&i.getSections()[0];if(n){n.focus()}else{var a=this.oPagesNavContainer.$().firstFocusableDomRef();if(a){a.focus()}}}if(!this.getOwnerComponent().getNavigationDisabled()){this.oContainerRouter=e.getRouter();this.oContainerRouter.getRoute("home").attachMatched(this.onRouteMatched.bind(this,true));this.oContainerRouter.getRoute("openFLPPage").attachMatched(this.onRouteMatched.bind(this,false))}}.bind(this))},_setGridContainerSizes:async function(){var e=d.last("/core/home/sizeBehavior");var t=this.getView().getModel("viewSettings");var i=e==="Small"?"_sap_ushell_Tile_SpacingXS":"_sap_ushell_Tile_Spacing";var n=e==="Small"?"_sap_ushell_Tile_SpacingXS":"_sap_ushell_Tile_SpacingS";const[a,o,r]=await p.getThemingParameters([i,"_sap_ushell_Tile_SpacingXS",n]);t.setProperty("/gridContainerGap/gridContainerGap",this._formatNumericThemeParam(a));t.setProperty("/gridContainerGap/gridContainerGapXS",this._formatNumericThemeParam(o));t.setProperty("/gridContainerGap/gridContainerGapS",this._formatNumericThemeParam(r));t.setProperty("/gridContainerGap/gridContainerGapM",this._formatNumericThemeParam(a));t.setProperty("/gridContainerGap/gridContainerGapL",this._formatNumericThemeParam(a));t.setProperty("/gridContainerGap/gridContainerGapXL",this._formatNumericThemeParam(a));var s=e==="Small"?"_sap_ushell_Tile_WidthXS":"_sap_ushell_Tile_Width";var l=e==="Small"?"_sap_ushell_Tile_WidthXS":"_sap_ushell_Tile_WidthS";const[g,u,c]=await p.getThemingParameters([s,"_sap_ushell_Tile_WidthXS",l]);t.setProperty("/gridContainerRowSize/gridContainerRowSize",this._formatNumericThemeParam(g));t.setProperty("/gridContainerRowSize/gridContainerRowSizeXS",this._formatNumericThemeParam(u));t.setProperty("/gridContainerRowSize/gridContainerRowSizeS",this._formatNumericThemeParam(c));t.setProperty("/gridContainerRowSize/gridContainerRowSizeM",this._formatNumericThemeParam(g));t.setProperty("/gridContainerRowSize/gridContainerRowSizeL",this._formatNumericThemeParam(g));t.setProperty("/gridContainerRowSize/gridContainerRowSizeXL",this._formatNumericThemeParam(g))},_formatNumericThemeParam:function(e){if(e&&e.indexOf(".")===0){e="0"+e}return e},_isMyHomeEnabled:function(){return d.last("/core/spaces/myHome/userEnabled")&&d.last("/core/spaces/myHome/enabled")},_getMyHomeTitle:function(){return A.getServiceAsync("Menu").then(function(e){return e.getMyHomeSpace()}).then(function(e){if(!e||!e.children.length){return""}return e.children[0].label})},_onFirstPageRendering:function(){var e=d.last("/core/shell/enablePersonalization");var t=this._isMyHomeEnabled();if(e){this._createActionModeButton()}else if(t){this._getMyHomeTitle().then(this._createActionModeButton.bind(this))}h.emit("firstSegmentCompleteLoaded",true)},_updateHomeUri:function(e){const t=d.last("/core/shellHeader/rootIntent");if(d.last("/core/spaces/homeNavigationTarget")==="origin_page"){var i=e?encodeURI(e.hash):t;d.emit("/core/shellHeader/homeUri","#"+i)}},onRouteMatched:function(t){var i=d.last("/core/homeApp/enabled");var n=i&&t;C.debug("cep/editMode: on Route matched","Page runtime");this._removeMyHomePage();if(!n){this._openFLPPage()}else{this._cancelActionMode();this.oPagesRuntimeNavContainer.to(this.oEmptyPage);this._updateHomeUri(undefined);d.emit("/core/spaces/currentSpaceAndPage",undefined)}var a=e.getElementById("ActionModeBtn");if(!a){return}var o=A.getRendererInternal("fiori2");var r=this._getStateInfoActionModeButton();if(n){if(this._moveEditActionToHeader()){o.hideHeaderEndItem(a.getId(),r.bCurrentState,r.aStates)}else{o.hideActionButton(a.getId(),r.bCurrentState,r.aStates)}return}if(!t&&i){if(this._moveEditActionToHeader()){o.showHeaderEndItem(a.getId(),r.bCurrentState,r.aStates)}else{o.showActionButton(a.getId(),r.bCurrentState,r.aStates)}return}if(!this.bIsHomeIntentRootIntent){if(this._moveEditActionToHeader()){o.showHeaderEndItem(a.getId(),r.bCurrentState,r.aStates)}else{o.showActionButton(a.getId(),r.bCurrentState,r.aStates)}}},_setPerformanceMark:function(e){p.setPerformanceMark(e,{bUseUniqueMark:true,bUseLastMark:true})},_setActionButtonText:function(t){t=t||this._sActionModeTextId;if(!t){return}this._sActionModeTextId=t;this._getMyHomeTitle().then(function(i){var n=e.getElementById("ActionModeBtn");if(n){var a=s.i18n.getText(t,[i]);n.setText(a);n.setTooltip(a)}})},_setActionModeLogic:function(e){var t=false;var i=false;if(d.last("/core/shell/enablePersonalization")){t=true}else if(e){t=true;this._setActionButtonText("PageRuntime.EditModeForPage.Activate")}else if(this._isMyHomeEnabled()){i=true;this._setActionButtonText("PageRuntime.EditModeForPage.AddTilesToMyHome")}this._oViewSettingsModel.setProperty("/personalizationEnabled",t);this._oViewSettingsModel.setProperty("/addToMyHomeOnly",i)},_openFLPPage:function(){return _.getPageAndSpaceId().then(({pageId:e,spaceId:t})=>{this.sCurrentTargetPageId=e;this.sCurrentTargetSpaceId=t;return Promise.all([this.oInitFinishedPromise,A.getServiceAsync("Menu")]).then(i=>{const n=i[1];return n.isSpacePageAssigned(t,e)}).then(e=>{if(!e){return Promise.reject("The combination of space and page is not assigned to the user.")}return this.getOwnerComponent().getPagesService()}).then(t=>{C.debug("cep/editMode: load Page: "+e,"Page runtime");return t.loadPage(e)}).then(async()=>{C.debug("cep/editMode: load Page: show action mode button "+e,"Page runtime");this._showActionModeButton();if(this.sCurrentTargetPageId===e){const i=this._isMyHomeRouteActive();this._setActionModeLogic(i);let n=Promise.resolve();if(i&&this._isMyHomePageEmpty()){n=this._navigateToInitialMyHome()}else{n=this._navigate(e,t)}await n;return this._onAfterPageNavigated(e,t)}}).catch(i=>this.navigateToErrorPage(i,e,t))}).catch(this.navigateToErrorPage.bind(this))},navigateToErrorPage:function(e,t,i){C.debug("cep/editMode: open FLP Page: Handle errors","Page runtime");if(e instanceof Error){this._oErrorPageModel.setProperty("/details",e.toString());this._oErrorPageModel.setProperty("/title",s.i18n.getText("PageRuntime.GeneralError.Text"));this._oErrorPageModel.setProperty("/technicalError",e.toString());this._oErrorPageModel.setProperty("/pageAndSpaceId","")}else if(t&&i){this._oErrorPageModel.setProperty("/title",s.i18n.getText("PageRuntime.CannotLoadPage.Title"));this._oErrorPageModel.setProperty("/details",s.i18n.getText("PageRuntime.CannotLoadPage.Details",[JSON.stringify(e)]));this._oErrorPageModel.setProperty("/pageAndSpaceId",s.i18n.getText("PageRuntime.CannotLoadPage.PageAndSpaceId",[t,i]));this._oErrorPageModel.setProperty("/technicalError",JSON.stringify(e))}else{this._oErrorPageModel.setProperty("/title",s.i18n.getText("PageRuntime.GeneralError.Text"));this._oErrorPageModel.setProperty("/details",s.i18n.getText("PageRuntime.CannotLoadPage.SystemErrorMessagePrefix",[JSON.stringify(e)]));this._oErrorPageModel.setProperty("/technicalError",JSON.stringify(e));this._oErrorPageModel.setProperty("/pageAndSpaceId","")}this._oErrorPageModel.setProperty("/description","");this.oPagesRuntimeNavContainer.to(this.oErrorPage);this._hideActionModeButton();this._cancelActionMode();this._onAfterPageNavigated()},_navigate:function(e,t,i){var n=this.oPagesNavContainer.getPages().find(function(t){return e===t.data("pageId")});if(!n){return Promise.reject()}var a;return A.getServiceAsync("Menu").then(function(e){a=e;return Promise.all([a.hasMultiplePages(t),a.isPinned(t)])}).then(function(o){var r=o[0];var s=o[1];var l=this.oPagesNavContainer.getCurrentPage()===n;this.oPagesNavContainer.to(n);this.oPagesRuntimeNavContainer.to(this.oPagesNavContainer);if(!l&&!i){this._cancelActionMode()}a.getSpaceAndPageTitles(t,e).then(function(e){var t=n.getContent()[0];var i=r||!s;if(i){t.setTitle(this._formatPageTitle(e.pageTitle,e.spaceTitle,r,!s))}t.setShowTitle(i);var a={pageTitle:e.pageTitle,spaceTitle:e.spaceTitle,hash:M.getHash()};this._updateHomeUri(a);d.emit("/core/spaces/currentSpaceAndPage",a)}.bind(this))}.bind(this))},_navigateToInitialMyHome:function(){if(!this._pLoadMyHomeView){this._pLoadMyHomeView=new Promise(function(e,t){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(i){i.create({id:"sapUshellMyHomePage",viewName:"sap.ushell.components.pages.view.MyHomeStart"}).then(function(t){t.getController().connect({onEdit:this.pressActionModeButton.bind(this),onOpenDialog:this.openMyHomeImportDialog.bind(this)});e(t)}.bind(this)).catch(t)}.bind(this),t)}.bind(this))}return this._pLoadMyHomeView.then(function(e){this._cancelActionMode();this.oPagesRuntimeNavContainer.insertPage(e,0);this.oPagesRuntimeNavContainer.to(e)}.bind(this))},_onAfterPageNavigated:function(){if(this.sCurrentTargetPageId&&this.sCurrentTargetSpaceId){h.emit("PageRendered",{time:Date.now(),pageId:this.sCurrentTargetPageId,spaceId:this.sCurrentTargetSpaceId})}if(!h.last("PagesRuntimeRendered")){h.emit("PagesRuntimeRendered",true)}else{h.emit("CloseFesrRecord",Date.now())}},_pressViewDetailsButton:function(){if(!this._oDialog){t.load({name:"sap.ushell.components.pages.fragment.DialogPageNotExists",controller:this}).then(function(e){this._oDialog=e;this.getView().addDependent(this._oDialog);this._oDialog.open()}.bind(this))}else{this._oDialog.open()}},_onDialogClose:function(){this._oDialog.close()},_copyToClipboard:function(){let e;if(this._oErrorPageModel.getProperty("/pageAndSpaceId")){e=this._oErrorPageModel.getProperty("/technicalError")+"\n"+this._oErrorPageModel.getProperty("/pageAndSpaceId")}else{e=this._oErrorPageModel.getProperty("/technicalError")}var t=p.copyToClipboard(e);if(t){u.show(s.i18n.getText("PageRuntime.CannotLoadPage.CopySuccess"),{closeOnBrowserNavigation:false})}else{u.show(s.i18n.getText("PageRuntime.CannotLoadPage.CopyFail"),{closeOnBrowserNavigation:false})}},_sectionFactory:function(e,t){return new b({title:"{title}",sizeBehavior:"{viewSettings>/sizeBehavior}",dataHelpId:"Section-{id}",ariaLabel:{parts:[{path:"title"},{value:t.getPath()},{path:"viewSettings>/actionModeEditActive"}],formatter:this._formatSectionAriaLabel.bind(this)},default:"{default}",visualizations:{path:"visualizations",factory:this._visualizationFactory.bind(this),key:"id"},gridContainerGap:"{viewSettings>/gridContainerGap/gridContainerGap}",gridContainerGapXS:"{viewSettings>/gridContainerGap/gridContainerGapXS}",gridContainerGapS:"{viewSettings>/gridContainerGap/gridContainerGapS}",gridContainerGapM:"{viewSettings>/gridContainerGap/gridContainerGapM}",gridContainerGapL:"{viewSettings>/gridContainerGap/gridContainerGapL}",gridContainerGapXL:"{viewSettings>/gridContainerGap/gridContainerGapXL}",gridContainerRowSize:"{viewSettings>/gridContainerRowSize/gridContainerRowSize}",gridContainerRowSizeXS:"{viewSettings>/gridContainerRowSize/gridContainerRowSizeXS}",gridContainerRowSizeS:"{viewSettings>/gridContainerRowSize/gridContainerRowSizeS}",gridContainerRowSizeM:"{viewSettings>/gridContainerRowSize/gridContainerRowSizeM}",gridContainerRowSizeL:"{viewSettings>/gridContainerRowSize/gridContainerRowSizeL}",gridContainerRowSizeXL:"{viewSettings>/gridContainerRowSize/gridContainerRowSizeXL}",enableGridBreakpoints:false,enableGridContainerQuery:"{viewSettings>/ushellContainerDocked}",editable:"{viewSettings>/actionModeEditActive}",add:this.handleEditModeAction.bind(this,"addVisualization"),delete:this.handleEditModeAction.bind(this,"deleteSection"),reset:this.handleEditModeAction.bind(this,"resetSection"),sectionVisibilityChange:this.handleEditModeAction.bind(this,"changeSectionVisibility"),titleChange:this.handleEditModeAction.bind(this,"changeSectionTitle"),enableVisualizationReordering:"{viewSettings>/personalizationEnabled}",areaDragEnter:this.onAreaDragEnter.bind(this),visualizationDrop:this.moveVisualization.bind(this),showSection:"{visible}",visible:"{= !!${visualizations}.length || ${viewSettings>/actionModeEditActive} }",noVisualizationsText:"{i18n>PageRuntime.EditMode.EmptySection}",showNoVisualizationsText:true,enableAddButton:"{viewSettings>/showAddButton}",enableResetButton:{parts:["id","preset"],formatter:this._sectionEnableReset.bind(this)},enableDeleteButton:{parts:["id","preset"],formatter:this._sectionEnableDelete.bind(this)},enableShowHideButton:"{viewSettings>/showHideButton}"}).addStyleClass("sapContrastPlus")},_visualizationFactory:function(e,t){if(this._oVisualizationInstantiationService){var i=t.getObject();var n=t.getPath();var a=n.replace(/\/visualizations\/\d*\/?$/,"");var o=a.replace(/\/sections\/\d*\/?$/,"");var s=t.getModel().getProperty(o);var l=this._oVisualizationInstantiationService.instantiateVisualization(i);l.attachPress(this.onVisualizationPress,this);l.bindEditable("viewSettings>/actionModeActive");if(l.bindRemovable){l.bindRemovable("viewSettings>/actionModeEditActive")}this._addTileActions(l,s?s.id:"");l.attachBeforeActionSheetOpen(function(){var e=this._createMoveTileActionButton(l,s);if(e){l.attachEventOnce("afterActionSheetClose",function(){l.removeTileAction(e)})}}.bind(this));var d=t.getPath().split("/")[2];var g=!!c.getPageVisibility("/pages/"+d);l.setActive(g);return l}return new r({state:I.Failed})},_addTileActions:function(e,t){var i=e.getAvailableDisplayFormats();var n=d.last("/core/shell/enablePersonalization");var a=this._isMyHomeEnabled();var o=t===this._sMyHomePageId;if(n||o){for(var r=0;r<i.length;r++){e.addTileAction(new m({text:"{i18n>VisualizationInstance.ConvertTo"+v(i[r])+"Action}",press:[i[r],this._updateVisualizationDisplayFormat,this]}))}}if(a&&!o){e.addTileAction(new m({text:"{i18n>addToMyHome_action}",press:[e,this._addToMyHome,this]}))}},_createMoveTileActionButton:function(e,t){var i=t?t.id:"";var n=i===this._sMyHomePageId;var a=d.last("/core/shell/enablePersonalization");var o=t.sections.filter(function(e){return!e.default});var r=e.getParent().getBindingContext().getProperty("default");if((a||n)&&o.length>=(r?1:2)){var l=new m({text:s.i18n.getText("moveTile_action"),press:[e,this._openMoveVisualizationDialog,this]});e.addTileAction(l);return l}},_openMoveVisualizationDialog:function(e,t){this._oVizInstanceToBeMoved=t;var i=t.getBindingContext().getPath();var n=i.split("/");var a=t.getParent().getBindingContext().getProperty("id");var o="/pages/"+n[2]+"/sections";if(!this._oMoveVisualizationDialogPromise){this._oMoveVisualizationDialogPromise=new Promise(function(e){sap.ui.require(["sap/ui/core/Fragment"],function(t){t.load({name:"sap.ushell.components.pages.MoveVisualization",controller:this}).then(function(t){this.getView().addDependent(t);e(t)}.bind(this))}.bind(this))}.bind(this))}return this._oMoveVisualizationDialogPromise.then(function(e){e.bindObject({path:o});e.getBinding("items").filter([new f("default",P.EQ,false),new f("id",P.NE,a)]);e.open()})},_addToMyHome:function(e,t){var i=t.getBindingContext().getObject();return this.getOwnerComponent().getPagesService().then(function(e){return e.copyVisualization(this._sMyHomePageId,null,i)}.bind(this)).then(function(){u.show(s.i18n.getText("PageRuntime.Message.VisualizationAddedToMyHome"))})},_confirmSelect:function(e){var t=this._oVizInstanceToBeMoved.getBindingContext().getPath();var i=t.split("/");var n=i[2];var a=i[4];var o=i[6];var r=e.getParameter("selectedItem").getBindingContext().getPath();var s=r.split("/");var l=s[4];var d=this._getAncestorControl(this._oVizInstanceToBeMoved,"sap.ushell.ui.launchpad.Section");var g=this._getAncestorControl(this._oVizInstanceToBeMoved,"sap.ushell.ui.launchpad.Page");var c=g.getSections();var h=c[l];var p=d.getItemPosition(this._oVizInstanceToBeMoved).area;this._oVizInstanceToBeMoved=null;var m=this.getOwnerComponent();return m.getPagesService().then(function(e){return e.moveVisualization(n,a,o,l,-1)}).then(function(e){var t=h.getVisualizations()[e.visualizationIndex];if(t){h.focusVisualization(t)}var i=this._getVizMoveMessage(a,l,p,p);u.show(i)}.bind(this))},_onMoveTileSearch:function(e){var t=e.getParameter("value");var i=new f("title",P.Contains,t);var n=new f("default",P.EQ,false);var a=e.getParameter("itemsBinding");a.filter([i,n])},_onMoveTileDialogClose:function(e){this._oVizInstanceToBeMoved=null},_getVizInstanceById:function(e,t,i){var n=this.byId("pagesNavContainer");var a=n.getPages().find(function(t){return t.getBindingContext().getObject().id===e});if(!a){return null}var o=a.getContent()[0];var r=o.getSections().find(function(e){return e.getBindingContext().getObject().id===t});if(!r){return null}var s=r.getVisualizations().find(function(e){return e.getBindingContext().getObject().id===i});return s||null},_updateVisualizationDisplayFormat:function(e,t){var i=e.getSource().getBindingContext();var n=i.getPath();var a=n.split("/");var o;var r=a[4];var s=a[4];var l=this.getOwnerComponent();return l.getPagesService().then(function(e){o=e.getModel().getProperty(n).displayFormatHint;var i={displayFormatHint:t};return e.updateVisualization(a[2],a[4],a[6],i)}).then(function(e){var i=this._getVizInstanceById(e.pageId,e.sectionId,e.vizRefId);var n=this._getAncestorControl(i,"sap.ushell.ui.launchpad.Section");if(n){n.focusVisualization(i)}var a=this._getVizMoveMessage(r,s,o,t);u.show(a)}.bind(this))},onVisualizationPress:function(e){var t=e.getParameter("scope");var i=e.getParameter("action");var n=e.getSource();var a=n.getBindingContext();var o=a.getPath();var r=o.split("/");var l=this._getAncestorControl(n,"sap.ushell.ui.launchpad.Section");if(t==="Display"&&i==="Press"){c.addVisualizationForRefresh(n)}else if(t==="Actions"&&i==="Remove"){return this.getOwnerComponent().getPagesService().then(function(e){var t=l.getItemPosition(n);e.deleteVisualization(r[2],r[4],r[6]);u.show(s.i18n.getText("PageRuntime.Message.VisualizationRemoved"));l._focusItem(t)})}return Promise.resolve()},onExit:function(){this.oContainerRouter.getRoute("home").detachMatched(this.onRouteMatched,this);this.oContainerRouter.getRoute("openFLPPage").detachMatched(this.onRouteMatched,this);this._aConfigListeners.off();this.oEventHubListener.off();this._oEventBus.unsubscribe("launchpad","shellFloatingContainerIsDocked",this._handleUshellContainerDocked,this);this._oEventBus.unsubscribe("launchpad","shellFloatingContainerIsUnDocked",this._handleUshellContainerDocked,this);c.exit();var t=e.getElementById("ActionModeBtn");if(t){t.destroy()}},_hideActionModeButton:function(){var t=e.getElementById("ActionModeBtn");C.debug("cep/editMode: hide Action Mode Button","Page runtime");if(t){t.setVisible(false)}},_showActionModeButton:function(){var t=e.getElementById("ActionModeBtn");if(t){t.setVisible(true)}},_moveEditActionToHeader:function(){var e=A.getRendererInternal("fiori2");var t=e.getShellConfig().moveEditHomePageActionToShellHeader;return t&&d.last("/core/shell/enablePersonalization")},_createActionModeButton:function(e){var t=e?s.i18n.getText("PageRuntime.EditModeForPage.Activate",[e]):s.i18n.getText("PageRuntime.EditMode.Activate");var i={id:"ActionModeBtn",text:t,icon:"sap-icon://edit",press:[this.pressActionModeButton,this]};C.debug("cep/editMode: create Action Mode Button","Page runtime");if(this._moveEditActionToHeader()){i.tooltip=t;this._createHeaderActionModeButton(i)}else{this._createUserActionModeButton(i)}},_createHeaderActionModeButton:function(e){sap.ui.require(["sap/ushell/ui/shell/ShellHeadItem"],function(t){var i=new t(e);if(d.last("/core/extension/enableHelp")){i.addStyleClass("help-id-ActionModeBtn")}var n=A.getRendererInternal("fiori2");var a=this._getStateInfoActionModeButton();n.showHeaderEndItem(i.getId(),a.bCurrentState,a.aStates)}.bind(this))},_getStateInfoActionModeButton:function(){if(!this.bIsHomeIntentRootIntent){return{bCurrentState:true,aStates:null}}return{bCurrentState:false,aStates:["home"]}},_createUserActionModeButton:function(e){var t=this._getStateInfoActionModeButton();new y(e);var i={controlType:"sap.ushell.ui.launchpad.ActionItem",oControlProperties:e,bIsVisible:true,bCurrentState:t.bCurrentState,aStates:t.aStates};var n=A.getRendererInternal("fiori2");n.addUserAction(i).done(function(e){if(d.last("/core/extension/enableHelp")){e.addStyleClass("help-id-ActionModeBtn")}this._setActionButtonText()}.bind(this))},pressActionModeButton:function(){var e=this.getView().getModel("viewSettings");var t=e.getProperty("/actionModeActive");var i=e.getProperty("/personalizationEnabled");var n=e.getProperty("/addToMyHomeOnly");sap.ui.require(["sap/ushell/components/pages/ActionMode"],function(e){if(t){e.cancel();return}else if(i||n||this._isMyHomeRouteActive()){e.start(this,n?s.i18n.getText("PageRuntime.EditMode.ExitAddTilesMode"):null)}}.bind(this))},_cancelActionMode:function(){var e=this.getView().getModel("viewSettings").getProperty("/actionModeActive");if(e){sap.ui.require(["sap/ushell/components/pages/ActionMode"],function(e){e.cancel()})}},handleEditModeAction:function(e,t){var i=t.getSource();var n=t.getParameters();sap.ui.require(["sap/ushell/components/pages/ActionMode"],function(a){C.debug("cep/editMode: handle Edit Mode Action","Page runtime");a[e](t,i,n)})},_getAncestorControl:function(e,t){if(e&&e.isA&&e.isA(t)){return e}else if(e&&e.getParent){return this._getAncestorControl(e.getParent(),t)}return null},moveVisualization:function(e){var t=e.getParameter("draggedControl");var i=e.getParameter("droppedControl");var n=e.getParameter("dropPosition");var a=e.getParameter("browserEvent");var r=a&&a.keyCode;var s=this._getAncestorControl(t,"sap.ushell.ui.launchpad.Page");var l=parseInt(t.getBindingContext().getPath().split("/")[2],10);var d=this._getAncestorControl(t,"sap.ushell.ui.launchpad.Section");var g=s.indexOfSection(d);var c=d.indexOfVisualization(t);var h=d.getVisualizations()[c];var p=d.getItemPosition(h);var m;var v;var f;var P;var _;if(!i){var S=e.mParameters.browserEvent.keyCode===o.ARROW_UP;var M=s.getSections();v=g;while(true){v=S?--v:++v;m=M[v];if(!m||m.getDefault()){h.invalidate();return Promise.resolve()}if(m.getShowSection()||m.getEditable()){f=m.getClosestCompactItemIndex(t.getDomRef(),S);P=m.getVisualizations()[f];_=m.getItemPosition(P);if(_.area!==p.area){_=p}break}}}else{if(i.isA("sap.ushell.ui.launchpad.section.CompactArea")){var C=i.getItems();if(C.length){i=C[C.length-1];n="After"}}m=this._getAncestorControl(i,"sap.ushell.ui.launchpad.Section");v=s.indexOfSection(m);if(m.getDefault()&&!d.getDefault()){h.invalidate();return Promise.resolve()}f=m.indexOfVisualization(i);P=m.getVisualizations()[f];_=m.getItemPosition(P);if(_.index===-1){_.area=p.area}if(g===v){if(n==="Before"&&c<f){f--}else if(n==="After"&&c>f){f++}if(c===f&&_.area===p.area){h.invalidate();return Promise.resolve()}}else if(n==="After"){f++}}if(g!==v&&(r===o.ARROW_UP||r===o.ARROW_DOWN)&&p.index>_.index){f++}var y;var b=this.getOwnerComponent();return b.getPagesService().then(function(e){y=e;y.enableImplicitSave(false);return y.moveVisualization(l,g,c,v,f)}).then(function(e){f=e.visualizationIndex;if(p.area!==_.area){var t={displayFormatHint:_.area};return y.updateVisualization(l,v,f,t)}return Promise.resolve()}).then(function(){return y.savePersonalization()}).then(function(){var e=m.getVisualizations()[f];if(e){m.focusVisualization(e);e.invalidate()}var t=this._getVizMoveMessage(g,v,p.area,_.area);u.show(t)}.bind(this)).finally(function(){y.enableImplicitSave(true)})},_getVizMoveMessage:function(e,t,i,n){if(e===t){if(i!==n){return s.i18n.getText("PageRuntime.Message.VisualizationConverted")}}if(i===n){return s.i18n.getText("PageRuntime.Message.VisualizationMoved")}return s.i18n.getText("PageRuntime.Message.VisualizationMovedAndConverted")},onDragEnter:function(e){var t=e.getParameter("dragSession").getDropControl();if(t.getDefault()){e.preventDefault()}},onAreaDragEnter:function(e){var t=e.getParameter("sourceArea");var i=e.getParameter("targetArea");if(t===i){return}var n=e.getParameter("dragControl");var a=n.getAvailableDisplayFormats();if(a.indexOf(i)===-1){if(i===w.Standard&&a.indexOf(w.StandardWide)>-1){return}if(i===w.Flat&&a.indexOf(w.FlatWide)>-1){return}e.getParameter("originalEvent").preventDefault()}},_handleUshellContainerDocked:function(e,t){this._oViewSettingsModel.setProperty("/ushellContainerDocked",t==="shellFloatingContainerIsDocked")},_isMyHomeRouteActive:function(){return d.last("/core/spaces/myHome/enabled")&&d.last("/core/spaces/myHome/userEnabled")&&d.last("/core/spaces/myHome/myHomeSpaceId")===this.sCurrentTargetSpaceId},_getMyHomePageData:function(){var e=this.getView().getModel().getProperty("/pages")||[];for(var t=0;t<e.length;t++){if(e[t]&&e[t].id==="SAP_BASIS_PG_UI_MYHOME"){return e[t]}}return null},_isMyHomePageEmpty:function(){var e=this._getMyHomePageData();if(e&&e.sections){return e.sections.every(function(e){var t=e.visualizations;return!(t&&t.length)})}return false},handleMyHomeActionMode:function(e){if(this._isMyHomeRouteActive()){if(e){return this._enterMyHomeActionMode()}else if(this._isMyHomePageEmpty()){return this._navigateToInitialMyHome()}}return Promise.resolve()},_enterMyHomeActionMode:function(){return Promise.all([this._navigate(this.sCurrentTargetPageId,this.sCurrentTargetSpaceId,true),S.isImportEnabled()]).then(function(e){if(!e[1]){if(this._pMessageStrip){this._pMessageStrip.then(function(e){e.setVisible(false)})}return Promise.resolve()}if(!this._pMessageStrip){this._pMessageStrip=new Promise(function(e,t){sap.ui.require(["sap/ui/core/Fragment"],function(i){i.load({name:"sap.ushell.components.pages.view.MessageStrip",controller:this}).then(function(t){h.on("importBookmarksFlag").do(function(e){t.setVisible(!!e)});t.addStyleClass("sapUiSmallMarginBottom");e(t)}).catch(t)}.bind(this),t)}.bind(this))}return this._pMessageStrip.then(function(e){this.oPagesNavContainer.getCurrentPage().getContent()[0].setMessageStrip(e)}.bind(this))}.bind(this))},openMyHomeImportDialog:function(){if(!this._pLoadImportDialog){this._pLoadImportDialog=new Promise(function(e,t){sap.ui.require(["sap/ushell/components/pages/controller/ImportDialog.controller"],function(t){e(new t)},t)})}return this._pLoadImportDialog.then(function(e){return e.open()})},onImportDialogPress:function(){this.openMyHomeImportDialog()},onMessageStripClose:function(){S.setImportEnabled(false);sap.ui.require(["sap/m/MessageBox"],function(e){e.information(s.i18n.getText("MyHome.InitialPage.MessageStrip.Popup"))})},_removeMyHomePage:function(){this.oPagesNavContainer.removePage("sapUshellMyHomePage")},_formatSectionAriaLabel:function(e,t,i){if(e&&e.trim()){return s.i18n.getText("Section.Description",[e])}if(!t){return""}const n=t.split("/");if(n.length!==5){return""}const a=`/${n[1]}/${n[2]}/${n[3]}`;let o=this.getView().getModel().getProperty(a);const r=this.getView().getModel().getProperty(t);if(!o||o.length===0){return""}if(!r){return""}let l;if(!i){o=o.filter(e=>e.visible&&e.visualizations&&e.visualizations.length>0)}l=o.indexOf(r);if(l<0){return""}return s.i18n.getText("Section.Description.EmptySectionAriaLabel",[l+1])},_sectionEnableReset:function(e,t){if(e===d.last("/core/spaces/myHome/presetSectionId")){return false}return t},_sectionEnableDelete:function(e,t){if(e===d.last("/core/spaces/myHome/presetSectionId")){return false}return!t},hideRuntime:function(){C.debug("cep/editMode: navigate to empty page","Page runtime");this._hideActionModeButton();this.oPagesRuntimeNavContainer.to(this.oEmptyPage)},_formatPageTitle:function(e,t,i,n){if(i&&n){return t+" - "+e}else if(n){return t}return e}})});
//# sourceMappingURL=PageRuntime.controller.js.map