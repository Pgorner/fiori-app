// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/EventBus","sap/ushell/components/container/ApplicationContainer","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ushell/utils","sap/ushell/UI5ComponentType","sap/base/Log","sap/base/util/ObjectPath","sap/ushell/Config","sap/ushell/Container"],function(e,t,r,i,n,a,s,o,p){"use strict";var l,c,u,f=t.getMetadata().getJSONKeys();function g(){var f=this;this.handleMessageEvent=function(e,r,n,s){var o=r.data;if(s===undefined){s=false}if(typeof o==="string"){try{o=JSON.parse(r.data)}catch(e){a.debug("Message received from origin '"+r.origin+"' cannot be parsed: "+e,o,"sap.ushell.components.container.ApplicationContainer");return}}if(o.action==="pro54_setGlobalDirty"&&localStorage.getItem(e.globalDirtyStorageKey)===p.DirtyState.PENDING){if(!t.prototype._isTrustedPostMessageSource(e,r)){a.warning("Received message from untrusted origin: "+r.origin,o,"sap.ushell.components.container.ApplicationContainer");return}a.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+e.globalDirtyStorageKey+" value: "+o.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");i.localStorageSetItem(e.globalDirtyStorageKey,o.parameters.globalDirty,true)}else{f.handleServiceMessageEvent(e,r,o,n,s)}};this.handleServiceMessageEvent=function(e,n,o,l,c){var u=s.get("sap-ushell-config.services.PostMessage.config")||s.create("sap-ushell-config.services.PostMessage.config"),f=o&&o.service,g,d,y,h,v=false,m=r.getAPIs(),A;a.debug("Received post message request from origin '"+n.origin+"': "+JSON.stringify(o),null,"sap.ushell.components.container.ApplicationContainer");if(c===undefined){c=false}if(o.type!=="request"||!f){return}if(f==="sap.ushell.services.MessageBroker"){if(c===true){f=f.concat("._execute")}else{return}}if(f.indexOf("sap.ushell.services.appLifeCycle")===0){f=f.replace(/appLifeCycle/gi,"AppLifeCycle")}for(var b in m){if(m.hasOwnProperty(b)){if(f.indexOf(b+".")!==-1){d=m[b];y=b;v=true;break}}}if(v===false){if(l.bPluginsStatusChecked===false||l.bKeepMessagesForPlugins===true){l.bApiRegistered=false}else{C("error",{code:-1,message:"Unknown service name: '"+f+"'"})}return}A=f.indexOf("user.postapi.")===0;g=f.split(".")[3];if(u&&u.enabled===false){a.warning("Received message for "+g+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return}if(c===false&&!t.prototype._isTrustedPostMessageSource(e,n)){a.warning("Received message from untrusted origin '"+n.origin+"': "+JSON.stringify(n.data),null,"sap.ushell.components.container.ApplicationContainer");return}function S(t,r){var i;if(r===true){i={oMessage:n,oMessageData:o}}else{i={matchesLocalSid:M,getLocalSystemInSidForma:R,storeSapSystemData:I,sendResponseMessage:C,oMessage:n,oMessageData:o,oContainer:e}}try{t(i).then(e=>{var t=e&&e.hasOwnProperty("_noresponse_")?true:false;if(!t){C("success",{result:e})}},e=>{let t;let r=e;if(e instanceof Error){r=e.message;t=e.stack}C("error",{message:r,stack:t})})}catch(e){C("error",{message:e.message,stack:e.stack})}}function C(e,t){var r=JSON.stringify({type:"response",service:o.service,request_id:o.request_id,status:e,body:t});a.debug("Sending post message response to origin ' "+n.origin+"': "+r,null,"sap.ushell.components.container.ApplicationContainer");if(typeof n.source!=="object"||n.source===null){a.debug("Cannot send response message to origin ' "+n.origin,"`source` member of request message is not an object","sap.ushell.components.container.ApplicationContainer");return}n.source.postMessage(r,n.origin)}function I(e,t){var r,n,s,o=[e.id];if(arguments.length>1){o.unshift(t)}try{s=JSON.stringify(e)}catch(e){a.error("Cannot stringify and store expanded system data: "+e)}if(s){n=i.getLocalStorage();r=i.generateLocalStorageKey("sap-system-data",o);n.setItem(r,s)}}function R(){var e=p.getLogonSystem();var t=e.getName();var r=e.getClient();return"sid("+t+"."+r+")"}function M(e){return R().toLowerCase()===e.toLowerCase()}h=d.oServiceCalls[f.replace(y+".","")];if(h&&h.executeServiceCallFn){S(h.executeServiceCallFn,A)}else{C("error",{code:-1,message:"Unknown service name: '"+f+"'"})}};this.init=function(e,t){c=e;u=t};this.restoreArray=function(e){var t=[],r=0;while(e[r]){t.push(e[r]);r++}return t};this._createWaitForRendererCreatedPromise=function(){var e,t;t=p.getRendererInternal();if(t){a.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[]}e=new Promise(function(e,r){var i;i=function(){a.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");e();p.detachRendererCreatedEvent(i)};t=p.getRendererInternal();if(t){a.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");e()}else{p.attachRendererCreatedEvent(i)}});return[e]};this.createComponent=async function(e,t){const r=await p.getServiceAsync("Ui5ComponentLoader");await i.promisify(r.createComponent(e,t,f._createWaitForRendererCreatedPromise(),n.Application))};this.stripURL=function(e){var t=e.indexOf("?"),r=e.indexOf("#"),i;if(t>=0){i=e.substr(0,t)}else if(r>=0){i=e.substr(0,r)}else{i=e}return i};this.createApplicationContainer=function(e,r){var i={};this._cleanTargetResolution(r,i);l=new t(e,r);this._restoreTargetResolution(r,i);if(l.setBlueBoxCapabilities){l.setProperty("blueBoxCapabilities",{},true)}if(l.setCurrentAppId){l.setProperty("currentAppId",e,true)}if(l.setCurrentAppUrl){l.setProperty("currentAppUrl",r.url,true)}if(r.appCapabilities){l.setProperty("frameworkId",r.appCapabilities.appFrameworkId,true)}if(l.setCurrentAppTargetResolution){l.setProperty("currentAppTargetResolution",r,true)}l.setHandleMessageEvent(this.handleMessageEvent);c.addNewBlueBox(l,r);return l};this.active=function(e){if(e){if(e.active){e.active()}}};this.restore=function(t){var r;if(t.container&&t.container._getIFrame&&t.container._getIFrame()!=undefined){u.postMessageToIframeApp(t.container,"sap.ushell.appRuntime","keepAliveAppShow",{},false)}if(t.app){e.getInstance().publish("sap.ushell","appKeepAliveActivate",t.appTarget);if(t.app.getUrl){r=t.app.getUrl();l=c.getBlueBoxByUrl(this.stripURL(r));if(l){c.restoreApp(l.sApplication)}}if(t.app.isKeepAliveSupported&&t.app.isKeepAliveSupported()===true){t.app.activate()}else{if(t.app.restore){t.app.restore()}if(t.app.getRouter&&t.app.getRouter()&&t.app.getRouter().initialize){if(t.enableRouterRetrigger===false){t.app.getRouter().initialize()}else{t.app.getRouter().initialize(true)}}if(t.app.setInitialConfiguration){t.app.setInitialConfiguration()}}l=t.app}};this.store=function(t){var r;if(t.container&&t.container._getIFrame&&t.container._getIFrame()!=undefined){u.postMessageToIframeApp(t.container,"sap.ushell.appRuntime","keepAliveAppHide",{},false)}if(t.app){e.getInstance().publish("sap.ushell","appKeepAliveDeactivate",t.appTarget);if(t.app.getUrl){r=t.app.getUrl();l=c.getBlueBoxByUrl(this.stripURL(r));if(l){c.storeApp(l.sApplication)}}if(t.app.isKeepAliveSupported&&t.app.isKeepAliveSupported()===true){t.app.deactivate()}else{if(t.app.suspend){t.app.suspend()}if(t.app.getRouter&&t.app.getRouter()){t.app.getRouter().stop()}}}};this.destroy=function(e){if(!e){return}if(e.getUrl){const t=e.getUrl();const r=c.getBlueBoxByUrl(this.stripURL(t));if(c.isStatefulContainer(r)){c.destroyApp(r.sApplication);return}}if(e.destroy){try{e.destroy()}catch(t){a.error("exception when trying to close sapui5 application with id '"+(e.sId||"<unknown>")+"'. This error must be fixed in order for FLP to operate properly.\n",t.stack,"sap.ushell.components.applicationIntegration.application.Application::destroy")}}};this.setActiveAppContainer=function(e){l=e};this.getActiveAppContainer=function(){return l};function g(e){try{var t=e.data;if(typeof t==="string"&&t.indexOf("sap.ushell.services.MessageBroker")>0){try{t=JSON.parse(e.data);if(typeof t==="object"&&t.type==="request"&&t.service==="sap.ushell.services.MessageBroker"){p.getServiceAsync("MessageBroker").then(function(t){var r=t.getAcceptedOrigins().find(function(t){return t===e.origin});if(r===undefined){return}f.handleMessageEvent(undefined,e,{},true)})}}catch(e){return}}}catch(e){a.error(e.message,e.stack)}}if(o.last("/core/shell/enableMessageBroker")&&p.isInitialized()){p.getServiceAsync("MessageBroker").then(function(e){addEventListener("message",g.bind(f))})}}g.prototype._cleanTargetResolution=function(e,t){var r;if(e){for(r in e){if(!f.hasOwnProperty(r)){t[r]=e[r];delete e[r]}}}};g.prototype._restoreTargetResolution=function(e,t){var r;if(e){for(r in t){e[r]=t[r]}}};g.prototype.isActiveOnly=function(e,t){return r.isActiveOnly(e,t)};g.prototype.isAppTypeSupported=function(e,t,i){var n=r._getPostMesageInterface(t,i);return this.isAppTypeSupportedByPolicy(e,n)};g.prototype.isAppTypeSupportedByPolicy=function(e,t){if(e&&e.getAdditionalInformation&&e.getAdditionalInformation().startsWith("SAPUI5.Component=")){return false}var r=t;if(!r||!r.distributionType){return false}if(r.distributionType.indexOf("all")>=0){return true}if(r.distributionType.indexOf("URL")>=0){return false}if(e.getApplicationType&&r.distributionType.indexOf(e.getApplicationType())>=0){return true}return false};g.prototype.registerShellCommunicationHandler=function(e){r.registerShellCommunicationHandler(e)};g.prototype._getPostMesageInterface=function(e,t){return r._getPostMesageInterface(e,t)};return new g},true);
//# sourceMappingURL=Application.js.map