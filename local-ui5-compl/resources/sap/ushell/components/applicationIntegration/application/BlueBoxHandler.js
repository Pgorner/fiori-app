// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/Deferred","sap/ui/core/EventBus","sap/ushell/components/applicationIntegration/application/BlueBoxesCache","sap/ushell/components/applicationIntegration/application/PostMessageUtils","sap/ui/thirdparty/hasher","sap/ushell/utils","sap/ushell/Container"],function(e,t,s,r,i,a,p){"use strict";function n(){const e=[{service:"sap.ushell.services.AppLifeCycle",action:"create"},{service:"sap.ushell.services.AppLifeCycle",action:"destroy"}];this.STATEFUL_TYPES={FLP_V2_KEEP_ALIVE:-2,GUI_V1_KEEP_ALIVE:-1,NOT_SUPPORTED:0,GUI_V1:1,FLP_V2:2};this.init=function(){s.init()};this.addNewBlueBox=function(e,t){if(!e||!t){return}s.add(t.url,e);e.setProperty("blueBoxCapabilities",{},true)};this.deleteBlueBoxByUrl=function(e){s.remove(e)};this.deleteBlueBoxByContainer=function(e){s.removeByContainer(e)};this.getBlueBoxesCount=function(){return s.getLength()+s.getPoolLength()};this.getBlueBoxByUrl=function(e){return s.get(e)};this.getBlueBoxById=function(e){return s.getByApplicationContainerId(e)};this.removeCapabilities=function(e,t){if(!e||!s.isApplicationContainerActive(e)){return}e.removeBlueBoxCapabilities(t);if(this.isStatefulContainer(e)){e.setProperty("statefulType",this.STATEFUL_TYPES.FLP_V2_KEEP_ALIVE,true)}};this.statefulCreateApp=async function(e,s,n,l,u){let o;e.setProperty("reservedParameters",l.reservedParameters,true);e.setProperty("currentAppUrl",s,true);e.setProperty("currentAppId",n,true);e.setProperty("currentAppTargetResolution",l,true);if(e._checkNwbcUrlAdjustment){s=e._checkNwbcUrlAdjustment(e,l.applicationType,s)}const c={sCacheId:n,sUrl:s,sHash:i.getHash()};if(s.indexOf("sap-iframe-hint=GUI")>0||s.indexOf("sap-iframe-hint=WDA")>0||s.indexOf("sap-iframe-hint=WCF")>0){var f=a.getParamKeys(s);if(f.aAppStateNamesArray.length>0){try{const e=await p.getServiceAsync("Navigation");const t=await e.getAppStateData(f.aAppStateKeysArray);o={};f.aAppStateNamesArray.forEach((e,s)=>{if(t[s]){o[e]=t[s]}})}catch{}}else{o={}}}if(o){o["sap-flp-url"]=p.getFLPUrl(true);o["system-alias"]=e.getSystemAlias();c["sap-flp-params"]=o}t.getInstance().publish("launchpad","appOpening",l);const h=e.hasStyleClass("hidden");if(h){e.addStyleClass("sapUShellApplicationContainerIframeHiddenButActive");e.removeStyleClass("hidden")}const y=await r.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","create",c,true);if(h){e.addStyleClass("hidden");e.removeStyleClass("sapUShellApplicationContainerIframeHiddenButActive")}const A=await p.getServiceAsync("AppLifeCycle");if(u===true){A.prepareCurrentAppObject("URL",undefined,false,e)}t.getInstance().publish("sap.ushell","appOpened",l);return y?.body?.result};this.statefulDestroyApp=async function(e,s){const i=e.getCurrentAppTargetResolution();e.setProperty("currentAppUrl","",true);e.setProperty("currentAppId","",true);e.setProperty("currentAppTargetResolution",undefined,true);p.setAsyncDirtyStateProvider(undefined);await r.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","destroy",{sCacheId:s},true);t.getInstance().publish("sap.ushell","appClosed",i)};this.statefulStoreKeepAliveApp=async function(e,s){const i=e.getCurrentAppTargetResolution();e.setProperty("currentAppUrl","",true);e.setProperty("currentAppId","",true);e.setProperty("currentAppTargetResolution",undefined,true);p.setAsyncDirtyStateProvider(undefined);await r.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","store",{sCacheId:s},true);t.getInstance().publish("sap.ushell","appClosed",i)};this.statefulRestoreKeepAliveApp=async function(e,s,a,n,l){e.setProperty("currentAppUrl",s,true);e.setProperty("currentAppId",a,true);e.setProperty("currentAppTargetResolution",n,true);t.getInstance().publish("launchpad","appOpening",n);await r.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","restore",{sCacheId:a,sUrl:n.url,sHash:i.getHash()},true);if(l){const t=await p.getServiceAsync("AppLifeCycle");t.prepareCurrentAppObject("URL",undefined,false,e)}t.getInstance().publish("sap.ushell","appOpened",n)};this.isCapabilitySupported=function(e,t,s){if(!e){return false}return e.supportsBlueBoxCapabilities([{service:t,action:s}])};this.isReusableContainer=function(e){if(!e){return false}return e.getStatefulType()!==this.STATEFUL_TYPES.NOT_SUPPORTED};this.isStatefulContainer=function(e){if(!e){return false}return e.supportsBlueBoxCapabilities([{service:"sap.ushell.services.AppLifeCycle",action:"create"},{service:"sap.ushell.services.appLifeCycle",action:"destroy"}])};this.isStatefulContainerSupportingKeepAlive=function(e){if(!e){return false}return e.supportsBlueBoxCapabilities([{service:"sap.ushell.services.AppLifeCycle",action:"create"},{service:"sap.ushell.services.appLifeCycle",action:"destroy"},{service:"sap.ushell.services.appLifeCycle",action:"store"},{service:"sap.ushell.services.appLifeCycle",action:"restore"}])};this.isIframeIsValidSupported=function(e){return e.supportsBlueBoxCapabilities([{service:"sap.ushell.services.appRuntime",action:"iframeIsValid"}])};this.isStatefulContainerInKeepAlivePool=function(e){return!!(e&&e.getStatefulType()<this.STATEFUL_TYPES.NOT_SUPPORTED)};this.findFreeContainerForNewKeepAliveApp=function(t){if(!t){return}if(!a.isSAPLegacyApplicationType(t.applicationType,t.appCapabilities?.appFrameworkId)){return}let r=s.getFromPool(t.url);if(!r){r=s.get(t.url,true);if(r&&r.getStatefulType()>this.STATEFUL_TYPES.NOT_SUPPORTED){s.removeByContainer(r);if(r.getStatefulType()===this.STATEFUL_TYPES.FLP_V2){r.removeBlueBoxCapabilities(e);r.setProperty("statefulType",this.STATEFUL_TYPES.FLP_V2_KEEP_ALIVE,true)}else{r.setProperty("statefulType",this.STATEFUL_TYPES.GUI_V1_KEEP_ALIVE,true)}}}if(r){s.add(t.url,r);r.setProperty("currentAppUrl","",true);r.setProperty("isFetchedFromCache",true,true);r.setProperty("isKeepAlive",true,true)}return r};this.returnUnusedKeepAliveContainer=function(t){if(!t){return}if(this.isStatefulContainerSupportingKeepAlive(t)){return}if(t.getStatefulType()<this.STATEFUL_TYPES.NOT_SUPPORTED){const r=s.moveKeepAliveToPool(t);if(!r){t.setProperty("isKeepAlive",false,true);if(t.getStatefulType()===this.STATEFUL_TYPES.FLP_V2_KEEP_ALIVE){t.addBlueBoxCapabilities(e);t.setProperty("statefulType",this.STATEFUL_TYPES.FLP_V2,true)}else{t.setProperty("statefulType",this.STATEFUL_TYPES.GUI_V1,true)}}t.setProperty("currentAppUrl","",true);t.setProperty("isFetchedFromCache",false,true)}};this.getStatefulContainerType=function(e,t){var r=s.get(e,t);if(r){return r.getStatefulType()}return this.STATEFUL_TYPES.NOT_SUPPORTED};this.forEach=function(e){s.forEach(e)};this.destroyApp=function(e){r.postMessageToMultipleIframes("sap.ushell.services.appLifeCycle","destroy",{appId:e})};this.storeApp=function(e){r.postMessageToMultipleIframes("sap.ushell.services.appLifeCycle","store",{appId:e,sHash:i.getHash()})};this.restoreApp=function(e){r.postMessageToMultipleIframes("sap.ushell.services.appLifeCycle","restore",{appId:e,sHash:i.getHash()})};this._getStorageForDebug=function(){return{oBlueBoxesCache:s._getStorageForDebug()}};this._destroyAllApplicationContainer=function(){this.forEach(e=>{this.deleteBlueBoxByContainer(e);e.destroy()})}}return new n},true);
//# sourceMappingURL=BlueBoxHandler.js.map