// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/renderer/History","sap/base/Log","sap/base/util/extend","sap/base/util/isPlainObject","sap/m/InstanceManager","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/EventBus","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/Device","sap/ui/performance/trace/Interaction","sap/ui/thirdparty/hasher","sap/ui/thirdparty/jquery","sap/ushell/bootstrap/SchedulingAgent","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/components/applicationIntegration/relatedServices/RelatedServices","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/library","sap/ushell/performance/FesrEnhancer","sap/ushell/renderer/LogonFrameProvider","sap/ushell/resources","sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/utils/WindowUtils","sap/ushell/renderer/ShellLayout","sap/ushell/renderer/utils","sap/base/util/ObjectPath","sap/ushell/Container","sap/ushell/state/ShellModel","sap/ushell/state/StateManager","sap/ushell/renderers/fiori2/LogonFrameProvider","sap/ushell/renderers/fiori2/History","sap/ushell/components/applicationIntegration/configuration/AppMeta","sap/ushell/ui5service/ShellUIServiceFactory"],(e,t,n,i,a,o,s,r,l,c,h,g,d,p,u,jQuery,f,y,m,v,w,b,S,C,_,I,A,H,N,E,P,T,F,M,D,R,L,B,k)=>{"use strict";const x=E.ShellArea;const U=l.routing.HistoryDirection;const O=b.AppType;const W=D.LaunchpadState;const V=D.Operation;const $=D.ShellMode;const{Standalone:z,Embedded:j,Minimal:q}=$;let K=true;let G=false;const Q={embedded:0,newWindowThenEmbedded:1,newWindow:1,replace:0};const X={embedded:"embedded",newWindowThenEmbedded:"newWindowThenEmbedded",newWindow:"newWindow",replace:"replace"};let Y={};S.init();const J="Shell.controller";const Z="[FesrFlp]";return c.extend("sap.ushell.renderer.Shell",{_aDoables:[],addDoable:function(e){this._aDoables.push(e)},_aDanglingControls:[],addDanglingControl:function(e){this._aDanglingControls.push(e)},_aDanglingBindings:[],addDanglingBinding:function(e){this._aDanglingBindings.push(e)},removeDanglingBinding:function(e){const t=this._aDanglingBindings.findIndex(t=>t===e);if(t>-1){this._aDanglingBindings.splice(t,1)}},_aPendingInitializations:[],addPendingInitialization:function(e){this._aPendingInitializations.push(e);return e},awaitPendingInitializations:function(){const e=this._aPendingInitializations.length;return Promise.allSettled(this._aPendingInitializations).then(()=>{const t=this._aPendingInitializations.length;if(e<t){return this.awaitPendingInitializations()}})},onComponentTargetDisplay:function(e){const t=e.getParameters();const n=t.control;const i=t.object;if(this.bRestorePreviousHash){this.bRestorePreviousHash=false}n.navTo("centerViewPort",i.getId(),"show")},onInit:function(){const t=o.getOwnerComponentFor(this.getView()).getRouter();t.getTarget("home").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("appfinder").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("contentfinder").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("pages").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("workpages").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("runtimeSwitcher").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("wzsearch").attachDisplay(this.onComponentTargetDisplay,this);if(v.last("/core/homeApp/enabled")){t.getTarget("homeapp").attachDisplay(this.onComponentTargetDisplay,this)}t.oHashChanger=h.getInstance();t.initialize(true);this.bEnableHashChange=true;K=true;const n=this.getView();const i=n.getViewData()||{};const a=window.matchMedia("(min-width: 600px)");const l=i.config||{};n.setModel(this._getConfigModel(),"configModel");n.setModel(M.getModel(),"shellModel");this._bindTabTitle();v.emit("/core/shell/model/personalization",v.last("/core/shell/enablePersonalization"));function c(e){v.emit("/core/shell/model/isPhoneWidth",!e.matches)}if(a.addListener){a.addListener(c);c(a)}n.setModel(_.i18nModel,"i18n");r.getInstance().subscribe("externalSearch",this.externalSearchTriggered,this);r.getInstance().subscribe("sap.ushell","appOpened",this.onAppOpened,this);r.getInstance().subscribe("ESHSearchFinished",this._logSearchActivity,this);this._setConfigurationToModel();this._registerAndCreateEventHubDoables();k.attachBackNavigationChanged(this._onBackNavigationChanged,this);this.history=e;this.oViewPortContainer=s.getElementById("viewPortContainer");y.init(this.oViewPortContainer,l.disableHomeAppCache);Promise.all([F.getServiceAsync("ShellNavigationInternal"),F.getServiceAsync("AppLifeCycle")]).then(e=>{const n=e[0];this._oAppLifeCycleService=e[1];this._initShellNavigationInternal(n,this._oAppLifeCycleService,t)});F.setLogonFrameProvider(this._getLogonFrameProvider());if(d.system.desktop){sap.ui.require(["sap/ushell/renderer/AccessKeysHandler"],e=>{e.init()})}window.onbeforeunload=function(){if(F&&F.getDirtyFlag()&&!(d.browser.name===d.browser.BROWSER.INTERNET_EXPLORER&&y.getCurrentApplication().container.getApplicationType()==="NWBC")){if(!_.browserI18n){_.browserI18n=_.getTranslationModel(window.navigator.language).getResourceBundle()}return _.browserI18n.getText("dataLossExternalMessage")}return};if(v.last("/core/shell/model/contentDensity")){B._applyContentDensityClass()}if(Y.enableOnlineStatus){sap.ui.require(["sap/ushell/ui5service/UserStatus"],e=>{this.oUserStatus=new e({scopeObject:this.getOwnerComponent(),scopeType:"component"})})}if(!l.disableSignOut&&(l.sessionTimeoutTileStopRefreshIntervalInMinutes>0||l.sessionTimeoutReminderInMinutes>0)){this._createSessionHandler(l)}if(d.system.desktop){sap.ui.require(["sap/ushell/renderer/AccessKeysHandler"],e=>{n.waitForShellLayout().then(()=>{const t=document.getElementById(x.NavigationBar);t.addEventListener("focusin",()=>{e.bFocusOnShell=false;e.bFocusPassedToExternalHandlerFirstTime=false});t.addEventListener("focusout",()=>{e.bFocusOnShell=true;e.bFocusPassedToExternalHandlerFirstTime=true});const n=document.getElementById(x.RendererRootView);n.addEventListener("focusin",()=>{e.bFocusOnShell=false;e.bFocusPassedToExternalHandlerFirstTime=false});n.addEventListener("focusout",()=>{e.bFocusOnShell=true;e.bFocusPassedToExternalHandlerFirstTime=true})})})}},_initShellNavigationInternal:function(e,t,n){this.oShellNavigationInternal=e;this.oShellNavigationInternal.registerPrivateFilters(t);this.oShellNavigationInternal.registerExtraRouter(n);this.oShellNavigationInternal.registerNavigationFilter(this._handleEmptyHash.bind(this));this.oShellNavigationInternal.init(this.doHashChange.bind(this));this.oShellNavigationInternal.registerNavigationFilter(this._disableSourceAppRouter.bind(this));this.oShellNavigationInternal.registerNavigationFilter(this.handleDataLoss.bind(this));this.oShellNavigationInternal.registerNavigationFilter(this._unblockUI.bind(this));y.registerHandleHashChange(this.oShellNavigationInternal);w.emit("ShellNavigationInitialized",Date.now())},_bindTabTitle:function(){const e=M.getModel().bindProperty("/application/title");e.attachChange(()=>{const t=e.getValue();if(t){I.setWindowTitle(t)}});this._aDanglingBindings.push(e)},_getConfigModel:function(){return M.getConfigModel()},getViewPortContainer:function(){return s.getElementById("viewPortContainer")},_registerAndCreateEventHubDoables:function(){[w.once("CenterViewPointContentRendered").do(this._loadCoreExt.bind(this)),w.once("PagesRuntimeRendered").do(this._loadCoreExt.bind(this)),w.once("AppRendered").do(this._loadCoreExtNonUI5.bind(this)),w.on("toggleContentDensity").do(this.toggleContentDensity.bind(this)),w.once("CoreResourcesComplementLoaded").do(this._onCoreResourcesComplementLoaded.bind(this)),w.once("loadRendererExtensions").do(this._loadRendererExtensionPlugins.bind(this)),w.once("loadWarmupPlugins").do(this._loadWarmupPlugins.bind(this)),w.once("loadTrackingActivitiesSetting").do(this._loadTrackingActivitiesSetting.bind(this))].forEach(e=>{this.addDoable(e)})},_onBackNavigationChanged:function(e){const t=e.getParameters().data;const n=D.getShellMode();const i=D.getLaunchpadState();if(t){m.setNavigateBack(t);if(i===W.App&&[q,z,j].includes(n)){F.getRendererInternal("fiori2").showHeaderItem("backBtn",true)}}else{m.resetNavigateBack()}},toggleContentDensity:function(e){const t=e.contentDensity==="compact";B._applyContentDensityByPriority(t,true)},_handleEmptyHash:function(e){e=typeof e==="string"?e:"";e=e.split("?")[0];if(e.length===0){const e=this.getView()?this.getView().getViewData():{};Y=e.config||{};if(Y.migrationConfig){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}if(Y.rootIntent){window.setTimeout(()=>{window.hasher.setHash(Y.rootIntent)},0);return this.oShellNavigationInternal.NavigationFilterStatus.Abandon}}return this.oShellNavigationInternal.NavigationFilterStatus.Continue},_unblockUI:function(){s.getElementById("shell-header")?.setBlocked?.(false);s.getElementById("menubar")?.setBlocked?.(false);return this.oShellNavigationInternal.NavigationFilterStatus.Continue},_notifyAsyncStep:function(){return p.notifyAsyncStep()},_setConfigurationToModel:function(){const e=this.getView().getViewData();if(e){Y=e.config||{}}if(Y){if(Y.states){t.error("The 'states' configuration was discontinued")}if(Y.enableSetTheme!==undefined){this._getConfigModel().setProperty("/setTheme",Y.enableSetTheme)}this._getConfigModel().setProperty("/contentDensity",Y.enableContentDensity===undefined?true:Y.enableContentDensity);if(Y.migrationConfig!==undefined){this._getConfigModel().setProperty("/migrationConfig",Y.migrationConfig)}if(Y.enableUserDefaultParameters!==undefined){this._getConfigModel().setProperty("/userDefaultParameters",Y.enableUserDefaultParameters)}if(Y.disableHomeAppCache!==undefined){this._getConfigModel().setProperty("/disableHomeAppCache",Y.disableHomeAppCache)}this._getConfigModel().setProperty("/enableHelp",v.last("/core/extension/enableHelp"));this._getConfigModel().setProperty("/searchAvailable",Y.enableSearch!==false);if(Y.title!==undefined){this.setHeaderTitle(Y.title)}}},_loadTrackingActivitiesSetting:async function(e){try{let t=await this._getPersData({container:"flp.settings.FlpSettings",item:"userActivitesTracking"});if(t===undefined){t=true}this._getConfigModel().setProperty("/enableTrackingActivity",t);w.emit("StepDone",e.stepName)}catch(n){t.error("Failed to load tracking activities state from the personalization, tracking activities is disabled",n,"sap.ushell.components.flp.settings.FlpSettings");this._getConfigModel().setProperty("/enableTrackingActivity",false);w.emit("StepDone",e.stepName)}},_getPreviousPageDirty:function(){return G},_setPreviousPageDirty:function(e){G=e},getModelConfiguration:function(){const e=this.getView().getViewData();let t;if(e){const i=e.config||{};t=n({},i)}delete t.applications;return t},_getLogonFrameProvider:function(){return C},onExit:function(){K=true;this._aDoables.forEach(e=>{e.off()});this._aDoables=[];k.detachBackNavigationChanged(this._onBackNavigationChanged,this);this._aDanglingControls.forEach(e=>{e.destroy()});this._aDanglingControls=[];this._aDanglingBindings.forEach(e=>{e.destroy()});this._aDanglingBindings=[];r.getInstance().unsubscribe("externalSearch",this.externalSearchTriggered,this);r.getInstance().unsubscribe("ESHSearchFinished",this._logSearchActivity,this);r.getInstance().unsubscribe("sap.ushell","appOpened",this.onAppOpened,this);if(this.oShellNavigationInternal&&this.oShellNavigationInternal.hashChanger){this.oShellNavigationInternal.hashChanger.destroy()}sap.ui.require("sap/ushell/UserActivityLog")?.deactivate();D.destroy(true)},_getCurrentAppRouter:function(){const e=this._oAppLifeCycleService;const t=e&&e.getCurrentApplication&&e.getCurrentApplication();const n=t&&t.componentInstance;if(n){return n.getRouter()}return null},_disableSourceAppRouter:function(e,t){if(!this.bEnableHashChange||this.bRestorePreviousHash){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const n=this.oShellNavigationInternal.hashChanger.isInnerAppNavigation(e,t);if(!n){const e=this._getCurrentAppRouter();if(e&&e.isInitialized()){e.stop()}}return this.oShellNavigationInternal.NavigationFilterStatus.Continue},_resumeAppRouterIgnoringCurrentHash:function(){const e=this._getCurrentAppRouter();if(e){e.initialize(true)}},handleDataLoss:function(e,t){const n=this.oShellNavigationInternal.hashChanger;const i=n.getReloadApplication();if(this.bReloadApplication!==null&&this.bReloadApplication!==undefined){n.setReloadApplication(this.bReloadApplication);this.bReloadApplication=null}if(t===""||u.disableBlueBoxHashChangeTrigger===true){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}if(!this.bEnableHashChange&&!this.bRedoNavigation){this.bEnableHashChange=true;return this.oShellNavigationInternal.NavigationFilterStatus.Custom}if(this.bRestorePreviousHash){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}if(this.bRedoNavigation){this.bRedoNavigation=false;this.bEnableHashChange=true;this.bExplaceNavigation=false;return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const a=H.parseShellHash(e);const o=F.getRendererInternal()._isBuiltInIntent(a);const s=a.params["sap-ushell-navmode"];const r=s&&s[0];if(!o&&(this.bExplaceNavigation||r==="explace"||r==="frameless")){this.bExplaceNavigation=false;return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const l=F.getDirtyFlag();const c=F.isAsyncDirtyStateProviderSet();if(!c&&!l){G=l;return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const h=g.getInstance().getHistoryStateOffset()<0;this._oLastDataLossPromise=Promise.all([this._waitForHash(t),F.getServiceAsync("NavTargetResolutionInternal"),F.getDirtyFlagsAsync()]).then(async t=>{const n=t[1];const a=t[2];G=a;if(!a){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo");return}if(o){if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}return}const s=`#${e}`;try{const t=await n.resolveHashFragment(s);const a=t.targetNavigationMode==="explace"||t.targetNavigationMode==="frameless";const o=h&&t.navigationMode===X.newWindowThenEmbedded;if(a&&!o){this.bExplaceNavigation=true;this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}else if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this.bReloadApplication=i;this._restoreHashUsingAction(e,"redo")}}catch{this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}});return this._restoreHashUsingAction(t,"undo")},_waitForHash:function(e){const t=`#${e}`;return new Promise(e=>{function n(){const i=t===decodeURIComponent(window.location.hash);if(i){window.removeEventListener("hashchange",n);e()}}window.addEventListener("hashchange",n)})},_handleDirtyStateUserConfirm:function(){t.debug(`${Z} Interaction Start`,"_handleDirtyStateUserConfirm",J);const e=this._notifyAsyncStep();if(window.confirm(_.i18n.getText("dataLossInternalMessage"))){F.setDirtyFlag(false);t.debug(`${Z} Interaction End`,"_handleDirtyStateUserConfirm",J);e();G=true;return true}t.debug(`${Z} Interaction End`,"_handleDirtyStateUserConfirm",J);e();return false},_restoreHashUsingAction:function(e,t){const n=this.oShellNavigationInternal.wasHistoryEntryReplaced();const i=this._getRestoreHashStrategy(n,t);this._resumeAppRouterIgnoringCurrentHash();return this._restoreHash(i,e)},_getRestoreHashStrategy:function(e,t){if(e){return{strategy:"replaceHash",stepCount:0}}let n;let i=g.getInstance().getHistoryStateOffset();if(i===undefined||i>=0){i=1}else if(i<0){i=-1}if(t==="undo"){if(i<0){n="historyForward"}else{n="historyBack"}this.sLastUndoStrategy=n}else{switch(this.sLastUndoStrategy){case"historyBack":n="historyForward";break;case"historyForward":n="historyBack";break;default:n="replaceHash"}}return{strategy:n,stepCount:1}},_restoreHash:function(e,t){const n={status:this.oShellNavigationInternal.NavigationFilterStatus.Custom,hash:""};switch(e.strategy){case"historyBack":this.bEnableHashChange=false;this._windowHistoryBack(e.stepCount);break;case"historyForward":this.bEnableHashChange=false;this._windowHistoryForward(e.stepCount);break;case"replaceHash":this.bEnableHashChange=false;u.replaceHash(t);break;default:throw new Error("Cannot execute unknown navigation strategy")}return n},_setEnableHashChange:function(e){this.bEnableHashChange=e},_logRecentActivity:async function(e){if(!this.oInitialEnableTrackingPromise){if(v.last("/core/shell/model/enableTrackingActivity")!==undefined){this.oInitialEnableTrackingPromise=Promise.resolve()}else{this.oInitialEnableTrackingPromise=new Promise(e=>{v.once("/core/shell/model/enableTrackingActivity").do(e)})}}await this.oInitialEnableTrackingPromise;if(v.last("/core/shell/model/enableTrackingActivity")){const t=await F.getServiceAsync("UserRecents");return t.addActivity(e)}t.warning("Tracking is not enabled",null,"sap.ushell.renderer.Shell.controller");throw new Error("Tracking is not enabled")},doHashChange:function(e,n,i,a,o){t.debug(`${Z} Interaction Start`,"doHashChange",J);A.setPerformanceMark("FLP-ShellController-doHashChange-begin");w.emit("trackHashChange",e);const r=new jQuery.Deferred;this._bWasHistoryEntryReplaced=this.oShellNavigationInternal.wasHistoryEntryReplaced();this.oShellNavigationInternal.resetHistoryEntryReplaced();if(!this.bEnableHashChange){this.bEnableHashChange=true;r.resolve();return r.promise()}if(this.bRestorePreviousHash){this.bRestorePreviousHash=false;r.resolve();return r.promise()}const l=H.ensureLeadingHash(e);const c=H.ensureLeadingHash(i);if(o){t.error(`Error when parsing the hash: '${l}'`,o);this.hashChangeFailure(this.history.getHistoryLength(),o.message,null,"sap.ushell.renderer.Shell.controller",false).then(r.resolve.bind(r)).catch(r.reject.bind(r));return r.promise()}const h=s.getElementById("sapUshellDashboardPage");if(h){h.setBlocked(true);h.setBusy(true)}const g=this._notifyAsyncStep();this._doHashChange(l,n,c).catch(()=>{w.emit("doHashChangeError",Date.now())}).finally(()=>{t.debug(`${Z} Interaction End`,"doHashChange",J);g();if(h){h.setBlocked(false);h.setBusy(false)}r.resolve()});return r.promise()},_doHashChange:async function(e,n,i){const a=this.history.getHistoryLength();this.history.hashChange(e,i);const o=I.getCurrentApplication();try{const s=await this._resolveHashFragment(e);if(!s&&window.QUnit!==undefined){return}const r=s.resolvedHashFragment;const l=s.parsedShellHash;if(r.navigationMode===null){if(A.isColdStart()){window.hasher.setHash("");return}this.bEnableHashChange=false;this.history.pop();this._windowHistoryBack(1);return}await y.storeAppExtensions();D.stallChanges();const c=await this._openAppViaNWBC(r,o);if(c===true){this.logOpenAppAction(r,n).catch(()=>{t.info("NWBC application was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});D.applyStalledChanges();return}if(r.navigationMode===X.newWindow){this.logOpenAppAction(r,n).catch(()=>{t.info("Application in new window was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});await this._openAppExplace(r,o);D.applyStalledChanges();return}const h=this._rewriteRootIntentForMigrationConfig(r,e);if(h){D.applyStalledChanges();return}try{const s=this.oShellNavigationInternal.isInitialNavigation();try{await this._openAppInplace(l,e,r,i,n,o)}catch(n){t.error(`Application initialization for intent "${e}" failed.`,n);const i=I.getMetadata(r);this.oShellNavigationInternal.setIsInitialNavigation(s);await this.hashChangeFailure(a,n.name,n.message,i?i.title:"",false)}}catch(n){t.error("Failed to open application",n,"sap.ushell.renderer.Shell.controller");const i=_.i18n.getText("cannot_load_ui5_component_details",[e]);const s=`Failed to load UI5 component for navigation intent "${e}"`;I.setCurrentApplication(o);await this.hashChangeFailure(a,{title:_.i18n.getText("error"),message:_.i18n.getText("failed_to_open_ui5_component"),technicalMessage:s},{info:i,technicalMessage:`${n.message}\n${n.stack}`},"sap.ushell.renderer.Shell.controller",false)}}catch(n){t.error("Hash change handling failed. Could not open app.",n,"sap.ushell.renderer.Shell.controller");const i=_.i18n.getText("cannot_resolve_navigation_target_details",[e]);const o=`Failed to resolve navigation target "${e}". This is most likely caused by an incorrect SAP Fiori launchpad content configuration or by missing role assignment.`;await this.hashChangeFailure(a,{title:_.i18n.getText("error"),message:_.i18n.getText("failed_to_open_app_missing_configuration_or_role_assignment"),technicalMessage:o},{info:i,fixedShellHash:e,technicalMessage:n.message},"sap.ushell.renderer.Shell.controller",false);throw n}},_rewriteRootIntentForMigrationConfig:function(e,t){if(v.last("/core/shell/model/migrationConfig")){Y.migrationConfig=false;this._getConfigModel().setProperty("/migrationConfig",false);if(e&&t==="#"){Y.rootIntent=""}else if(t==="#"){window.setTimeout(()=>{window.hasher.setHash(Y.rootIntent)},0);return true}}return false},_openAppExplace:async function(e,t){const[n]=await A.requireAsync(["sap/ushell/components/container/ApplicationContainer"]);e.url=n.prototype._checkNwbcUrlAdjustment(undefined,e.applicationType,e.url,true);r.getInstance().publish("launchpad","appOpening",e);const i=N.openURL(e.url);if(!i&&!this._checkWindowLocationSearch("workzone-mobile-app=true")){const e=_.i18n.getText("fail_to_start_app_popup_blocker",[window.location.hostname]);this.delayedMessageError(e)}r.getInstance().publish("sap.ushell","appOpened",e);this._restorePreviousHashAfterOpenNewWindow(e,t)},_closeAllDialogs:function(){if(a&&K){a.closeAllDialogs();a.closeAllPopovers()}K=true},_resolveHashFragment:async function(e){const n=H.parseShellHash(e)||{};const i=this._getConfig();let a;if(window["sap-ushell-async-libs-promise-directstart"]){try{const e=await window["sap-ushell-async-libs-promise-directstart"];delete window["sap-ushell-async-libs-promise-directstart"];a=e.resolvedHashFragment}catch(e){delete window["sap-ushell-async-libs-promise-directstart"];throw e}}else{const t=await F.getServiceAsync("NavTargetResolutionInternal");a=await A.promisify(t.resolveHashFragment(e))}if(!a&&window.QUnit!==undefined&&!window._bTestNullNavigationMode){return}if(!a){a={navigationMode:null}}I.setCurrentApplication(a);const o=H.getBasicHash(e);if(i?.applications?.[o]){a.applicationConfiguration=i.applications[o]}a.sFixedShellHash=e;if(`${n.semanticObject}-${n.action}`===i.rootIntent){a.navigationMode=X.embedded}if(a.navigationMode!==null&&!a.navigationMode){t.error("Mandatory member 'navigationMode' is missing in the resolution result! Temporarily set to 'embedded' for further processing...","sap.ushell.renderer.Shell.controller");a.navigationMode=X.embedded}this._setEffectiveNavigationMode(a);A.setPerformanceMark("FLP-ShellController-resolveHashFragment-end");return{resolvedHashFragment:a,parsedShellHash:n}},_setEffectiveNavigationMode:function(e){if(!e){return}const t=e.navigationMode;if(t===X.newWindowThenEmbedded){if(A.isColdStart()||g.getInstance().getDirection()===U.Backwards){e.navigationMode=X.embedded}else{e.navigationMode=X.newWindow;if(!A.isNativeWebGuiNavigation(e)){e.applicationType="URL";e.url=this._getCurrentLocationHash()}}return}if(t===X.newWindow&&A.isColdStart()){if(this._hasAppCapabilitiesNavigationMode(e)&&e.appCapabilities.navigationMode===X.embedded){e.navigationMode=X.embedded;return e}e.navigationMode=X.replace;return}if(t===X.newWindow&&this._hasAppCapabilitiesNavigationMode(e)&&e.appCapabilities.navigationMode===X.embedded){e.url=this._getCurrentLocationHash()}},_hasAppCapabilitiesNavigationMode:function(e){return A.isPlainObject(e.appCapabilities)&&e.appCapabilities.hasOwnProperty("navigationMode")},_usesNavigationRedirect:async function(e){if(!e){return false}const n=e.getInstance({});if(!n){return false}if(typeof n.navigationRedirect!=="function"){return false}const i=n.navigationRedirect();if(!i||typeof i.then!=="function"){return false}try{const e=await A.promisify(i);t.warning(`Performing navigation redirect to hash "${e}"`);n.destroy();this.history.pop();const a=await F.getServiceAsync("ShellNavigationInternal");a.toExternal({target:{shellHash:e}},undefined,false);return true}catch{return false}},_openAppInplace:async function(e,t,n,i,a,o){const s=this._isFLPIntent(i);const r=!!a;this._closeAllDialogs();await y.handleBeforeCreateApp(t,n,s,r);await y.handleCreateApp(t,e,n,s,r);const l=v.last("/core/extension/SupportTicket");if(l){A.awaitTimeout(0).then(()=>A.requireAsync("sap/ushell/UserActivityLog")).then(([e])=>{e.activate()})}const c=n.navigationMode;if(c===X.embedded){if(!A.isColdStart()&&!this._bWasHistoryEntryReplaced){this.oShellNavigationInternal.setIsInitialNavigation(false)}const a=await this._usesNavigationRedirect(n.componentHandle);if(a){return}y.resetGlobalShellUIService();const r=this._getConfig();const l=H.getBasicHash(t);await y.handleCreateApplicationContainer(l,e,n,i,s);y.navToCurrentApp();B.setAppIcons();const c=t==="#"||r.rootIntent&&l===H.getBasicHash(r.rootIntent);y.switchViewState(c?W.Home:W.App,l,n.applicationType,n.explicitNavMode);await y.handleAfterNavigate(n,o);const h=I.getMetadata(n);w.emit("CloseFesrRecord",{time:Date.now(),technicalName:h.technicalName});return}if(c===X.replace){this.oShellNavigationInternal.setIsInitialNavigation(false);this.bEnableHashChange=false;this._changeWindowLocation(n.url);return}await this.hashChangeFailure(this.history.getHistoryLength(),`Navigation mode '${c}' was not recognized`,null,"sap.ushell.renderer.Shell.controller",false)},_openAppViaNWBC:async function(e,n){const i=e&&(A.isNativeWebGuiNavigation(e)||e.nativeNWBCNavigation);if(!i){return false}const a=A.getPrivateEpcm();const o=Q[e.navigationMode];let s;if(A.hasNavigationModeCapability()){s=o||Q[X.embedded]}const l=await this._appendUserIdToUrl("sap-user",e.url);const c=await A.appendSapShellParam(l);const h=e.applicationType;const g=e?.appCapabilities?.appFrameworkId;let d;try{if(A.isSAPLegacyApplicationType(h,g)){const t=Object.create(null);const n=await F.getServiceAsync("Navigation");const i=A.getParamKeys(c);if(i.aAppStateNamesArray.length>0){const e=await n.getAppStateData(i.aAppStateKeysArray);i.aAppStateNamesArray.forEach((n,i)=>{if(e[i]){t[n]=e[i]}})}t["sap-flp-url"]=F.getFLPUrl(true);t["system-alias"]=e.systemAlias;d=[{name:"sap-flp-params",value:JSON.stringify(t)}]}}catch{}try{r.getInstance().publish("launchpad","appOpening",e);if(!a.doNavigate(c,s,undefined,undefined,undefined,undefined,undefined,d)){return false}r.getInstance().publish("sap.ushell","appOpened",e);await this._restoreAfterNwbcNavigation(e,n);if(this._oAppLifeCycleService.getCurrentApplication()&&this._oAppLifeCycleService.getCurrentApplication().homePage){this._setMenuVisible(true);this._setSideNavigationVisible(true)}return true}catch(n){if(n.stack){t.error(`Application initialization failed due to an Exception:\n${n.stack}`)}await this.hashChangeFailure(this.history.getHistoryLength(),n.name,n.message,e.text,false);return false}},_restoreAfterNwbcNavigation:async function(e,t){if(this.history.getHistoryLength()===1&&!this._oAppLifeCycleService.getCurrentApplication()){const e=await F.getServiceAsync("Navigation");e.navigate({target:{shellHash:"#"},writeHistory:false});return}this._restorePreviousHashAfterOpenNewWindow(e,t)},_appendUserIdToUrl:async function(e,t){const n=await F.getServiceAsync("UserInfo");const i=n.getUser().getId();const a=t.indexOf("?")>=0?"&":"?";return`${t+a+e}=${i}`},_restorePreviousHashAfterOpenNewWindow:function(e,t){this.history.pop();const n=e.componentHandle&&e.componentHandle.getInstance&&e.componentHandle.getInstance({});if(n){n.destroy()}this._resumeAppRouterIgnoringCurrentHash();this.bRestorePreviousHash=true;this._windowHistoryBack(1);I.setCurrentApplication(t);w.emit("openedAppInNewWindow",Date.now())},_isShellHomeIntent:function(e){return e==="#"||e===Y.rootIntent},_saveHomePageComponent:function(){if(this.oHomeApp){return}const e="sap.ushell";function t(n,i,a){this.oHomeApp=a.component;r.getInstance().unsubscribe(e,"appComponentLoaded",t,this)}r.getInstance().subscribe(e,"appComponentLoaded",t,this)},hashChangeFailure:async function(e,t,n,i,a){D.discardStalledChanges();if(A.isPlainObject(t)){this.reportError(t.technicalMessage,n.technicalMessage,i);const e=await F.getServiceAsync("MessageInternal");e.show(e.Type.ERROR,t.message,{title:t.title,details:n})}else{this.reportError(t,n,i);this.delayedMessageError(_.i18n.getText("fail_to_start_app_try_later"))}K=false;this._resumeAppRouterIgnoringCurrentHash();if(e===0){window.hasher.setHash("")}else if(new URLSearchParams(window.location.search).get("bFallbackToShellHome")){window.hasher.setHash("")}else{this.bEnableHashChange=a;F.setDirtyFlag(G);this._windowHistoryBack(1)}},reportError:function(e,n,i){t.error(e,n,i)},delayedMessageError:async function(e){try{await A.awaitTimeout(0);const t=await F.getServiceAsync("MessageInternal");t.error(e)}catch{}},_checkWindowLocationSearch:function(e){return window.location.search.indexOf(e)>-1},_windowHistoryBack:function(e){window.history.go(-1*e)},_windowHistoryForward:function(e){window.history.go(e)},_changeWindowLocation:function(e){window.location.href=e},_setMenuVisible:function(e){const t=document.getElementById(x.NavigationBar);if(!t){return}e=e||v.last("/core/menu/enabled")&&v.last("/core/menu/position")==="Top"&&v.last("/core/menu/visibleInAllStates");t.classList.toggle("sapUshellShellHidden",!e)},_setSideNavigationVisible:function(e){const t=document.getElementById(x.SideNavigation);if(!t){return}e=e||v.last("/core/menu/enabled")&&v.last("/core/menu/position")==="Side"&&v.last("/core/menu/visibleInAllStates");t.classList.toggle("sapUshellShellHidden",!e)},onAppOpened:function(e,n,i){if(i.targetNavigationMode!=="explace"&&i.targetNavigationMode!=="frameless"){this._setMenuVisible(false)}this._setSideNavigationVisible(true);const a=this.oShellNavigationInternal.hashChanger.getAppHash();const o=a?`&/${a}`:null;this.logOpenAppAction(i,o).catch(()=>{t.info("Opened application was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});this._notifyUITracer(i)},externalSearchTriggered:function(e,t,n){v.emit("/core/shell/model/searchTerm",n.searchTerm);n.query=n.searchTerm},onBeforeNavigate:function(e){const t=e.getParameter("to");const n=this.getOwnerComponent();const i=t===n.byId("Shell-home-component-container");const a=t===n.byId("pages-component-container");const o=t===n.byId("homeApp-component-container");const s=t===n.byId("workPageRuntime-component-container");const r=t===n.byId("runtimeSwitcher-component-container");const l=i||a||o||s||r;y.onBeforeNavigate(e.getParameter("fromId"),e.getParameter("from"),e.getParameter("toId"),e.getParameter("to"));this._setMenuVisible(l);this._setSideNavigationVisible(l)},onAfterNavigate:function(e){const t=e.mParameters?e.mParameters.toId:undefined;const n=s.getElementById("sapUshellDashboardPage");if(n){n.setBlocked(false);n.setBusy(false)}y.onAfterNavigate(e.getParameter("fromId"),e.getParameter("from"),t,e.getParameter("to"));r.getInstance().publish("sap.ushell","navigated",{})},logOpenAppAction:async function(e,t){const n=v.last("/core/shell/enableRecentActivity")&&v.last("/core/shell/enableRecentActivityLogging");if(!n){throw new Error("Tracking of RecentActivity is disabled.")}const i=I.getMetadata(e);const a=e.sFixedShellHash||this._getCurrentLocationHash();const o={title:i.title,appType:O.APP,url:t?a+t:a};const s=H.parseShellHash(a);if(s){o.appId=`#${H.constructShellHash({semanticObject:s.semanticObject,action:s.action})}`}else{o.appId=a}if(a&&a.indexOf("#Action-search")===-1&&a.indexOf("#Shell-startIntent")===-1){await A.awaitTimeout(1500);await this._logRecentActivity(o);return}throw new Error("RecentActivity was not logged.")},_notifyUITracer:function(e){try{const t=e.reservedParameters?.["sap-fiori-id"]?.[0]||e.reservedParameters?.["sap-ui-app-id-hint"]?.[0]||e.ui5ComponentName;w.emit("UITracer.trace",{reason:"NavigateApp",source:"Intent",data:{applicationId:t||"",applicationType:e.applicationType||"",hash:e.sFixedShellHash||"",targetNavigationMode:e.targetNavigationMode||"",providerId:e.contentProviderId||"",targetUrl:e.url||""}})}catch(e){t.warning("Could not emit UITracer.trace event",e,"sap.ushell.renderer.Shell.controller")}},_logSearchActivity:function(){if(v.last("/core/shell/enableRecentActivity")&&v.last("/core/shell/enableRecentActivityLogging")){let e="";try{e=s.getElementById("searchFieldInShell-input").getModel().getLastSearchTerm()}catch(e){t.error("Shell: last search term is not available to log a recent activity")}this._logRecentActivity({appId:"#Action-search",appType:O.SEARCH,title:e,url:`#${window.hasher.getHash()}`}).catch(()=>{t.info("Search activity was not logged.",undefined,"sap.ushell.renderer.Shell.controller")})}},_loadCoreExtNonUI5:function(e){if(e&&e.applicationType!=="SAPUI5"){this._loadCoreExt()}},_onCoreResourcesComplementLoaded:function(){A.setPerformanceMark("SchedulingAgent-StartOfFlow");const e=this.getView();if(e){e.createPostCoreExtControls()}f._initialize();w.emit("startScheduler")},_loadRendererExtensionPlugins:async function(e){const t=new URLSearchParams(window.location.search);const n=t.get("sap-ushell-xx-pluginmode")==="delayed";const i=await F.getServiceAsync("PluginManager");if(n){await A.awaitTimeout(5e3)}i.loadPlugins("RendererExtensions").always(function t(){w.emit("StepDone",e.stepName)})},_loadWarmupPlugins:async function(e){const n=await F.getServiceAsync("PluginManager");n.loadPlugins("AppWarmup").always(()=>{t.debug("WARMUP plugins loaded",null,"sap.ushell.renderer.Shell");w.emit("StepDone",e.stepName);A.setPerformanceMark("SchedulingAgent-EndOfFlow");A.setPerformanceMeasure("SchedulingAgentTotalTime","SchedulingAgent-StartOfFlow","SchedulingAgent-EndOfFlow")})},_loadCoreExt:async function(){await F.getServiceAsync("Ui5ComponentLoader");w.emit("loadCoreResourcesComplement",Date.now())},getRightFloatingContainerVisibility:function(){const e=this.getView().getRightFloatingContainer();return e&&e.getVisible()},setHeaderTitle:function(e){D.updateAllBaseStates("header.secondTitle",V.Set,e||"")},setNavigationBar:function(e){e.placeAt(x.NavigationBar,"only");this.addDanglingControl(e)},setSideNavigation:function(e){e.placeAt(x.SideNavigation,"only");this.addDanglingControl(e)},setShellShapes:function(e){if(e.placeAt){e.placeAt(x.ShellShapes,"only");this.addDanglingControl(e)}else if(e instanceof Node){document.getElementById(x.ShellShapes).appendChild(e)}},setFooter:function(e){if(typeof e!=="object"||!e.getId){throw new Error("oFooter value is invalid")}const n=this.getFooterId();if(n){t.warning(`You can only set one footer. Replacing existing footer "${n}", with the new footer "${e.getId()}".`)}D.updateAllBaseStates("footer.content",V.Set,e.getId());e.placeAt(x.Footer,"only");this.addDanglingControl(e);if(e._applyContextClassFor){e._applyContextClassFor("footer")}},getFooterId:function(){return M.getModel().getProperty("/footer/content")},removeFooter:function(){const e=this.getFooterId();if(e){const t=s.getElementById(e);if(t&&t.destroy){t.destroy()}}D.updateAllBaseStates("footer.content",V.Set,"")},addUserPreferencesEntry:function(e,t){this._validateUserPrefEntryConfiguration(e,t);this._updateUserPrefModel(e,t)},_validateUserPrefEntryConfiguration:function(e,t){if(!e||typeof e!=="object"){throw new Error("object oConfig was not provided")}if(!e.title){throw new Error("title was not provided")}if(!e.value){throw new Error("value was not provided")}if(typeof e.entryHelpID!=="undefined"){if(typeof e.entryHelpID!=="string"){throw new Error("entryHelpID type is invalid")}else if(e.entryHelpID===""){throw new Error("entryHelpID should not be an empty string")}}if(e.title&&typeof e.title!=="string"){throw new Error("title type is invalid")}if(typeof e.value!=="function"&&typeof e.value!=="string"&&typeof e.value!=="number"){throw new Error("value type is invalid")}["onSave","content","onCancel"].forEach(t=>{if(e[t]&&typeof e[t]!=="function"){throw new Error(`"${t}" type is "${typeof e[t]}" but should be a function`)}});if(t){[{name:"groupingId",type:"string"},{name:"groupingTabTitle",type:"string"},{name:"groupingTabHelpId",type:"string"}].forEach(t=>{if(!e[t.name]){throw new Error(`${t.name} is missing`)}else if(typeof e[t.name]!==t.type){throw new Error(`"${t.name}" type is "${typeof e[t.name]}" but should be a "${t.type}"`)}})}},_createSessionHandler:function(e){const t=2e4;sap.ui.require(["sap/ushell/SessionHandler"],n=>{this.oSessionHandler=new n(y);this.oSessionHandler.initLogout();window.setTimeout(()=>{this.oSessionHandler.init({sessionTimeoutReminderInMinutes:e.sessionTimeoutReminderInMinutes,sessionTimeoutIntervalInMinutes:e.sessionTimeoutIntervalInMinutes,sessionTimeoutTileStopRefreshIntervalInMinutes:e.sessionTimeoutTileStopRefreshIntervalInMinutes,enableAutomaticSignout:e.enableAutomaticSignout})},t)})},_getSessionHandler:function(){return this.oSessionHandler},_navBack:function(){this.setUserActionsMenuSelected(false);m.navigateBack()},_updateUserPrefModel:function(e,t){const n=this._getModelEntryFromEntryObject(e);let i=v.last("/core/userPreferences/entries")||[];if(t){n.groupingEnablement=true;n.groupingId=e.groupingId;n.groupingTabTitle=e.groupingTabTitle;n.groupingTabHelpId=e.groupingTabHelpId}i.push(n);i=this._reorderUserPrefEntries(i);v.emit("/core/userPreferences/entries",i)},_getModelEntryFromEntryObject:function(e){return{id:A._getUid(),entryHelpID:e.entryHelpID,title:e.title,valueArgument:e.value,valueResult:null,onSave:e.onSave,onCancel:e.onCancel,contentFunc:e.content,contentResult:null,icon:e.icon,provideEmptyWrapper:e.provideEmptyWrapper}},_reorderUserPrefEntries:function(e){const t=[];const n=["userAccountEntry","themes","language","notificationsEntry","homepageEntry","spacesEntry","userActivitiesEntry","userDefaultEntry"];const i={};for(let t=e.length-1;t>=0;t--){if(n.indexOf(e[t].id)!==-1){const n=e.splice(t,1)[0];i[n.id]=n}}n.forEach(e=>{const n=i[e];if(n){t.push(n)}});return t.concat(e)},_getConfig:function(){return Y||{}},_getPersData:async function(e){const t=o.getOwnerComponentFor(this.getView());const n=await F.getServiceAsync("PersonalizationV2");const i={keyCategory:n.KeyCategory.FIXED_KEY,writeFrequency:n.WriteFrequency.LOW,clientStorageAllowed:true};const a=await n.getPersonalizer(e,i,t);return a.getPersData()},_getCurrentLocationHash:function(){return window.location.hash},setUserActionsMenuSelected:function(e){w.emit("showUserActionsMenu",e)},setNotificationsSelected:function(e){w.emit("showNotifications",e)},_isFLPIntent:function(e){const t=H.getBasicHash(e);const n=["Shell-home","Shell-appfinder","Launchpad-openFLPPage","Launchpad-openWorkPage"];return n.some(e=>t===e)}})});
//# sourceMappingURL=Shell.controller.js.map