// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Formatting","sap/base/util/deepExtend","sap/base/util/isEmptyObject","sap/ui/core/CalendarType","sap/ui/core/Lib","sap/ui/core/Supportability","sap/ui/core/format/DateFormat","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/v4/ODataUtils","sap/ushell/User","sap/ushell/utils","sap/ushell/Container"],function(e,t,n,a,r,s,i,l,c,o,u,f,d){"use strict";const m="sap.ushell.services.ReferenceResolver";function g(){this.getValue=async function(e){let n;if(e==="User.env.sap-ui-legacy-date-format"){n=t.getABAPDateFormat()}if(e==="User.env.sap-ui-legacy-number-format"){n=t.getABAPNumberFormat()}if(e==="User.env.sap-ui-legacy-time-format"){n=t.getABAPTimeFormat()}if(e==="User.env.sap-language"){n=d.getUser().getLanguage()}if(e==="User.env.sap-languagebcp47"){n=d.getUser().getLanguageBcp47()}if(e==="User.env.sap-accessibility"){n=d.getUser().getAccessibilityMode()?"X":undefined}if(e==="User.env.sap-statistics"){n=i.isStatisticsEnabled()?"true":undefined}if(e==="User.env.sap-theme"){n=d.getUser().getTheme(u.prototype.constants.themeFormat.THEME_NAME_PLUS_URL)}if(e==="User.env.sap-theme-name"){n=d.getUser().getTheme()}if(e==="User.env.sap-theme-NWBC"){n=d.getUser().getTheme(u.prototype.constants.themeFormat.NWBC)}return{value:n}}}function h(t,i,u){this._getUserEnvReferenceResolver=function(){if(!this.oUserEnvReferenceResolver){this.oUserEnvReferenceResolver=new g}return this.oUserEnvReferenceResolver};this.resolveReferences=async function(t,n){const r=[];let s=true;const i={};const l={};const c=t.map(t=>{let n;if(t.indexOf("User.env.")===0){n=t;l[n]=1}if(t.indexOf("UserDefault.")===0){n=this._extractAnyUserDefaultReferenceName(t);i[n]=1}if(typeof n!=="string"){s=false;e.error(`'${t}' is not a legal reference name`,null,m)}return{full:t,name:n}});if(!s){throw new Error("One or more references could not be resolved")}if(!n){const e=await d.getServiceAsync("ClientSideTargetResolution");n=await e.getSystemContext()}const o=await d.getServiceAsync("UserDefaultParameters");Object.keys(i).forEach(e=>{r.push(o.getValue(e,n))});const u=this._getUserEnvReferenceResolver();Object.keys(l).forEach(e=>{r.push(u.getValue(e))});const f=await Promise.all(r);const g={};let h=0;Object.keys(i).forEach(e=>{i[e]=f[h];h=h+1});Object.keys(l).forEach(e=>{l[e]=f[h];h=h+1});c.forEach(e=>{let t;if(e.full.indexOf("UserDefault.extended.")===0){t=this.mergeSimpleAndExtended(i[e.name]);if(!a(t)){g[e.full]=t}else{g[e.full]=undefined}}else if(e.full.indexOf("UserDefault.")===0){g[e.full]=i[e.name].value}else if(e.full.indexOf("User.env.")===0){g[e.full]=l[e.name].value}});return g};this._extractAnyUserDefaultReferenceName=function(e){const t=this.extractExtendedUserDefaultReferenceName(e);if(typeof t==="string"){return t}return this.extractUserDefaultReferenceName(e)};this.extractExtendedUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.extended.")!==0){return undefined}return e.replace(/^UserDefault[.]extended[.]/,"")};this.extractUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.")!==0||e.indexOf("UserDefault.extended.")===0){return undefined}return e.replace(/^UserDefault[.]/,"")};this.mergeSimpleAndExtended=function(e){const t=n({},e.extendedValue);if(typeof e.value==="string"){if(!Array.isArray(t.Ranges)){t.Ranges=[]}t.Ranges.push({Sign:"I",Option:"EQ",Low:e.value,High:null})}return t};function h(e){const t=/{([^}%]*%%[^%]+%%)}?/g;const n=/([^%]*)%%/;const a=/%%([^%]+)%%/;const r=[];let s=t.exec(e);while(s){const i=n.exec(s[1]);const l=a.exec(s[1]);r.push({edmType:i[1],name:l[1]});s=t.exec(e)}return r}this._extractUrlPlaceholders=function(e,t){let n,a;const r=[];n=/[^(?]*/.exec(e);a=n===null?[]:h(n[0]);a.forEach(e=>{r.push(e.name)});n=/[(?][^]*/.exec(e);a=n===null?[]:h(n[0]);const s=a.filter(e=>{const n=e.name;if(t.test(n)){return true}r.push(n);return false});return{extractedReferences:s,ignoredReferences:r}};this._replaceUrlPlaceholders=function(e,t,n){let a=e;const r=[];const s=n?o.formatLiteral.bind(o):c.formatValue.bind(c);t.forEach(e=>{const t=e.name;let n=null;let i=false;while(n!==a){n=a;if(e.value!==undefined){const n=s(e.value,e.edmType);a=a.replace(`{${e.edmType}%%${t}%%}`,window.encodeURIComponent(n))}else{i=true;a=a.replace(`{${e.edmType}%%${t}%%}`,"")}}if(i){r.push(t)}});return{resolvedUrl:a,placeholdersWithoutValue:r}};this.resolveUserDefaultParameters=async function(e,t){const n=this._extractUrlPlaceholders(e,/^UserDefault\.(?!extended\.).+/);const a=n.extractedReferences;const r=n.ignoredReferences;if(a.length===0){return{url:e,defaultsWithoutValue:[],ignoredReferences:r}}const s=a.map(e=>e.name);const i=await this.resolveReferences(s,t);a.forEach(e=>{e.value=i[e.name]});const l=this._replaceUrlPlaceholders(e,a);return{url:l.resolvedUrl,defaultsWithoutValue:l.placeholdersWithoutValue,ignoredReferences:r}};this._loadDynamicDateRange=async function(){await s.load("sap.ui.unified");const[e]=await f.requireAsync(["sap/m/DynamicDateRange"]);return e};this._rSemanticDateRangeRegex=/^DynamicDate\..+/;this.resolveSemanticDateRanges=async function(t,n){const a=this._extractUrlPlaceholders(t,this._rSemanticDateRangeRegex);const r=a.extractedReferences;const s=a.ignoredReferences;if(r.length===0){return{url:t,hasSemanticDateRanges:false,invalidSemanticDates:[],ignoredReferences:s}}const i=["2.0","4.0"];if(!n||!i.includes(n)){throw new Error(`Invalid OData version: ${n}`)}const l=n==="4.0";const c=await this._resolveSemanticDateRanges(r,l);const o=this._replaceUrlPlaceholders(t,c,l);if(e.getLevel()>=e.Level.DEBUG){const a=c.filter(e=>"value"in e);e.debug("Resolving semantic date ranges \n"+`- OData Version: ${n}\n`+`- URL: ${t}\n`+`- ignoring references: ${JSON.stringify(s,null,4)}\n`+`- resolved semantic date ranges: ${JSON.stringify(a,null,4)}\n`+`- invalid semantic date ranges:${JSON.stringify(o.placeholdersWithoutValue,null,4)}\n`+`- final URL: ${o.resolvedUrl}`,null,m)}return{url:o.resolvedUrl,hasSemanticDateRanges:r.length>0,invalidSemanticDates:o.placeholdersWithoutValue,ignoredReferences:s}};this._resolveSemanticDateRanges=async function(e,t){const n=this._getDateTimeFormatters();const a=await this._loadDynamicDateRange();return e.map(e=>{const r={name:e.name,edmType:e.edmType};const s=e.name.split(".");const i={operator:s[1],values:[]};let l;if(s.length===3){l=s[2]}else if(s.length===4){i.values.push(s[2]);l=s[3]}else if(s.length===5){i.values=s.slice(2,4);l=s[4]}let c;try{c=a.toDates(i)}catch(e){return r}if(s.length>=3&&l!=="start"&&l!=="end"){return r}let o;if(l==="end"){o=c[1]}else{o=c[0]}if(!o){return r}switch(e.edmType){case"Edm.String":r.value=n.string.format(o);break;case"Edm.Date":r.value=n.date.format(o);break;case"Edm.DateTime":o.setUTCFullYear(o.getFullYear(),o.getMonth(),o.getDate());o.setUTCHours(0,0,0,0);r.value=o;break;case"Edm.DateTimeOffset":if(t){r.value=n.dateTimeOffsetV4.format(o,true)}else{r.value=o}break;default:break}return r})};this._getDateTimeFormatters=function(){if(!this._oDateTimeFormatters){this._oDateTimeFormatters={string:l.getDateInstance({pattern:"yyyyMMdd",calendarType:r.Gregorian}),date:l.getDateInstance({pattern:"yyyy-MM-dd",calendarType:r.Gregorian}),dateTimeOffsetV4:l.getDateInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss'.'SSS'Z'",calendarType:r.Gregorian})}}return this._oDateTimeFormatters};this.hasSemanticDateRanges=function(e){const t=this._extractUrlPlaceholders(e,this._rSemanticDateRangeRegex);return t.extractedReferences.length>0}}h.hasNoAdapter=true;return h},true);
//# sourceMappingURL=ReferenceResolver.js.map