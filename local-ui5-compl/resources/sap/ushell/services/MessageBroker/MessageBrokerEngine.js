// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ushell/components/applicationIntegration/application/PostMessageUtils"],function(e,s,n){"use strict";var r=true,t={},i={},a={},l={};t[window.location.origin]=true;var c=function(){this.setEnabled=function(e){r=e};this.processPostMessage=function(s){if(!r){return Promise.reject()}var n=s.oMessageData,t=n.body,i=s.oMessage,a=i.origin,l=i.source;t.requestId=n.request_id;if(!l){var c="Missing iframe object in PostMessage request";e.error(c,null,"sap.ushell.services.MessageBroker");return Promise.reject(c)}return this._handlePostMessageRequest(t,l,a)};this.connect=function(s){var n;if(!r){return Promise.reject()}if(typeof s!=="string"||!s.length){n="Missing required parameter client id"}else if(a[s]){n="Client is already connected"}else{a[s]=true;return Promise.resolve()}e.error(n,null,"sap.ushell.services.MessageBroker");return Promise.reject(n)};this.disconnect=function(s){var n;if(!r){return Promise.reject()}if(typeof s!=="string"||!s.length){n="Missing required parameter client id"}else if(!a[s]){n="Client is already disconnected"}else{for(var t in i){var c=i[t];for(var o in c){var u=c[o];if(u.clientId===s){c.splice(o,1);break}}}if(l[s]&&l[s].channels.length){this._emitEvent("clientUnsubscribed",s,l[s].channels);delete l[s]}delete a[s];return Promise.resolve()}e.error(n,null,"sap.ushell.services.MessageBroker");return Promise.reject(n)};this.subscribe=function(s,t,c,o,u,d){var h,f="clientSubscribed",g=[],v=false;if(!r){return Promise.reject()}if(typeof s!=="string"||!s.length||!t.length||typeof u!=="object"&&(typeof c!=="function"||typeof o!=="function")){h="Missing required parameter(s)"}else if(!a[s]){h="Client is not connected"}else{for(var p in t){var m=t[p];var b={clientId:s,subscribedChannels:t,messageCallback:c,clientConnectionCallback:o,iframe:u||{},origin:d||"",isUI5:!u};if(!i[m.channelId]){i[m.channelId]=[]}var I=i[m.channelId].find(function(e){return e.clientId===s});if(!I){i[m.channelId].push(b)}if(l[s]){var M=l[s].channels.find(function(e){return e.channelId===m.channelId});if(!M){l[s].channels.push(m)}}}if(!l[s]){v=true;var P={clientId:s,channels:t};l[s]=P;g=Object.values(l).filter(function(e){return e.clientId!==s})}if(Object.keys(l).length>1){this._emitEvent(f,s,t)}if(v){setTimeout(function(){if(g.length){g.forEach(function(e){if(!u){o(f,e.clientId,e.channels)}else{var s={clientId:e.clientId,channels:e.channels,channelId:"sap.ushell.MessageBroker",messageName:f};var r=this._buildPostMessageObject("event",s);n.postMessageToIframeObject(r,u,d,false)}}.bind(this))}}.bind(this),1e3)}return Promise.resolve()}e.error(h,null,"sap.ushell.services.MessageBroker");return Promise.reject(h)};this.unsubscribe=function(s,n){var t;if(!r){return Promise.reject()}if(typeof s!=="string"||!s.length||!Array.isArray(n)||!n.length){t="Missing required parameter(s)";e.error(t,null,"sap.ushell.services.MessageBroker");return Promise.reject(t)}if(!a[s]){t="Client is not connected";e.error(t,null,"sap.ushell.services.MessageBroker");return Promise.reject(t)}for(var c in n){var o=n[c];if(i[o.channelId]){var u=i[o.channelId];for(var d in u){var h=u[d];if(h.clientId===s){var f=l[s].channels;l[s].channels=f.filter(function(e){return e.channelId!==o.channelId});u.splice(d,1);break}}}else{var g="Unknown channel Id: "+o.channelId;e.warning(g,null,"sap.ushell.services.MessageBroker")}}this._emitEvent("clientUnsubscribed",s,n);return Promise.resolve()};this.publish=function(s,n,t,l,c,o){var u,d=[];if(!r){return Promise.reject()}if(!a[n]){u="Client is not connected";e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)}if(!i[s]){u="Unknown channel Id: "+s;e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)}var h=i[s].find(function(e){return e.clientId===n});if(!h){u="Client is not subscribed to the provided channel";e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)}for(var f in c){var g=c[f];if(g==="*"){d=i[s].concat();break}else{var v=i[s].find(function(e){return e.clientId===g});if(v){d.push(this._deepCopy(v))}}}if(d.length){this._sendMessage(d,s,t,l,n,o);return Promise.resolve()}u="Target client(s) not found in the provided channel";e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)};this.addAcceptedOrigin=function(s){if(!r){return}if(typeof s==="string"&&s.length>0){t[s]=true;if(s.startsWith("https:")&&s.endsWith(":443")){t[s.substring(0,s.length-4)]=true}}else{e.warning("Missing required parameter sOrigin",null,"sap.ushell.services.MessageBroker")}};this.removeAcceptedOrigin=function(e){if(!r){return}delete t[e]};this.getAcceptedOrigins=function(){if(!r){return}return Object.keys(t)};this.getSubscribedClients=function(){if(!r){return}return this._deepCopy(i)};this._emitEvent=function(e,s,r){var t={};for(var a in i){var l=i[a];for(var c in l){var o=l[c];if(o.clientId!==s&&!t[o.clientId]){var u={clientId:s,channels:r};if(o.isUI5!==false){o.clientConnectionCallback(e,s,r)}else{u.channelId="sap.ushell.MessageBroker";u.messageName=e;var d=this._buildPostMessageObject("event",u);n.postMessageToIframeObject(d,o.iframe,o.origin,false)}t[o.clientId]=true}}}};this._sendMessage=function(e,s,r,t,i,a){for(var l in e){var c=e[l];if(c.clientId!==i){if(c.isUI5!==false){c.messageCallback(i,s,t,a)}else{var o={clientId:i,channelId:s,messageName:t,data:a};var u=this._buildPostMessageObject("request",o);n.postMessageToIframeObject(u,c.iframe,c.origin,false)}}}};this._callApi=function(e,s){return this[e].apply(this,s)};this._handlePostMessageRequest=function(e,s,r){return new Promise(function(t,i){var a=e.clientId,l=e.channelId,c=e.requestId,o=e.messageName,u=e.subscribedChannels,d=e.targetClientIds,h=e.data;var f={connect:[a],disconnect:[a],subscribe:[a,u,null,null,s,r],unsubscribe:[a,u],publish:[l,a,c,o,d,h]};var g={channelId:l,clientId:a,messageName:o,requestId:c};var v=this._buildPostMessageObject("response",g);o=f[o]?o:"publish";this._callApi(o,f[o]).then(function(){if(o!=="publish"){v.body.status="accepted";n.postMessageToIframeObject(v,s,r,false)}t({_noresponse_:true})}).catch(function(e){i(e)})}.bind(this))};this._buildPostMessageObject=function(e,s){var r="sap.ushell.services.MessageBroker",t={request:{channelId:s.channelId,clientId:s.clientId,messageName:s.messageName},response:{channelId:s.channelId,clientId:s.clientId,correlationMessageId:s.requestId,messageName:s.messageName},event:{channelId:s.channelId,clientId:s.clientId,messageName:s.messageName}};switch(e){case"event":t.event.channels=s.channels;break;case"request":if(s.data){t[e].data=s.data}break}var i={request:[r,t.request],response:[r,s.requestId,t.response,true],event:[r,t.event]};var a=e==="response"?n.createPostMessageResponse:n.createPostMessageRequest;return a.apply(this,i[e])};this._buildFunctionName=function(e,s){s=s.charAt(0).toUpperCase()+s.substring(1);return e+s};this._deepCopy=function(e){return s(e)}};return new c},false);
//# sourceMappingURL=MessageBrokerEngine.js.map