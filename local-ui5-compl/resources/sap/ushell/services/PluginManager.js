// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/components/applicationIntegration/application/PostMessageAPIInterface","sap/ushell/services/PluginManager/Extensions","sap/ushell/UI5ComponentType","sap/ushell/utils","sap/ushell/Container"],function(e,jQuery,n,i,t,o,r){"use strict";var s="sap.ushell.services.PluginManager";var a="sap-ushell-plugin-type";var l="RendererExtensions";var u="sap.ushell.components.shell.defaults";var g=[l,"UserDefaults","UserImage","AppWarmup"];function c(c,f,p){var h=this;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};this._sPluginAgentsNames="";this._oConfig=p&&p.config||{};if(this._oConfig.isBlueBox===undefined){this._oConfig.isBlueBox=false}g.forEach(function(e){h._oPluginCollection[e]={};h._oCategoryLoadingProgress[e]=new jQuery.Deferred});this._handlePluginCreation=function(n,i,t,r){var a=this;var l=a._oPluginCollection[n][i];o.setPerformanceMark("FLP -- PluginManager.loadPlugin["+n+"]["+i+"]");try{if(l.hasOwnProperty("component")){if(a._mInitializedComponentPromise.hasOwnProperty(l.component)){a._mInitializedComponentPromise[l.component].then(function(){a._instantiateComponent(l,t,r)},function(){a._instantiateComponent(l,t,r)})}else{a._mInitializedComponentPromise[l.component]=a._instantiateComponent(l,t,r)}}else{e.error("Invalid plugin configuration. The plugin "+i+" must contain a <component> key",s)}}catch(n){e.error("Error while loading bootstrap plugin: "+l.component||"",s);if(t){t.reject(n)}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js"};this._handleXhrAuthentication=function(n,i){var t;if(n&&["true",true,"X"].indexOf(n["sap-ushell-xhr-authentication"])>-1){if(!i){e.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,s);return jQuery.when()}if(n.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){t=parseInt(n["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(t)){e.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",i,"': '",n["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,s)}else{r.setXhrLogonTimeout(i,t)}}return jQuery.ajax(i+"/"+this._getFileNameForXhrAuth(),{dataType:"text"})}return jQuery.when()};this._instantiateComponent=function(n,o,a){var l=new jQuery.Deferred;var u=JSON.parse(JSON.stringify(n));var g={ui5ComponentName:u.component,url:u.url,getExtensions:i.bind(null,n.component)};function c(n){return function(i){n=n||"Cannot create UI5 plugin component: (componentId/appdescrId :"+g.ui5ComponentName+")\n"+i+" properties "+JSON.stringify(g)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";i=i||"";e.error(n,i.stack,s);if(o){o.reject.apply(this,arguments)}l.reject.apply(this,arguments)}}u.name=u.component;delete u.component;g.applicationDependencies=u;if(u.config){g.applicationConfiguration=u.config;delete u.config}g.loadDefaultDependencies=false;if(a!==undefined){g.oPostMessageInterface=a}r.getServiceAsync("Ui5ComponentLoader").then(function(e){this._handleXhrAuthentication(g.applicationConfiguration,u.url).done(function(){e.createComponent(g,{},[],t.Plugin).done(function(e){if(o){o.resolve(e)}l.resolve.apply(this,arguments)}).fail(c())}).fail(c("XHR logon for FLP plugin failed"))}.bind(this)).catch(c());return l.promise()};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(g))};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection))};this.registerPlugins=async function(n){let i;if(!n){return}if(this._oConfig.isBlueBox===true){i=new URLSearchParams(window.location.search).get("sap-plugins");if(i&&i.length>0){i=","+i+","}else{i=undefined}}const t=await this._addPluginsIntoCollection(n,i);try{if(this._oConfig.isBlueBox!==true){this._buildNamesOfPluginsWithAgents()}}catch(n){e.error("failed to build plugin agents names list",n.message||n.toString(),"sap.ushell.services.PluginManager")}t.forEach(e=>{if(Object.hasOwn(this._oCategoryLoadingProgress,e)&&this._oCategoryLoadingProgress[e].state()==="resolved"){this.loadPlugins(e)}})};this._addPluginsIntoCollection=async function(n,i=""){var t=[];for(const r of Object.keys(n).sort()){const u=n[r]||{};const c=u.config||{};const f=c[a]||"";u.enabled??=true;if(u.enabled===false){continue}if(!this._isFormFactorSupported(u)){e.info(`Plugin '${r}' filtered from result: form factor not supported`);continue}if(this._oConfig.isBlueBox===true&&c["sap-plugin-agent"]===true){const e=c["sap-plugin-agent-id"]||r;if(!i.includes(`,${e},`)){continue}}if(Object.hasOwn(u,"module")){const n=(u.module||"").replace(/\./g,"/");e.error(`Plugin ${r} cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.`,s);try{await o.requireAsync([n])}catch(i){e.error(`Plugin module ${n} is not found.`)}continue}if(Object.hasOwn(c,a)){if(g.includes(f)){if(!t.includes(f)){t.push(f)}this._oPluginCollection[f][r]=JSON.parse(JSON.stringify(u))}else{e.warning(`Plugin ${r} will not be inserted into the plugin collection of the PluginManager, because of unsupported category ${f}`,s)}}else{this._oPluginCollection[l][r]=JSON.parse(JSON.stringify(u));if(!t.includes(l)){t.push(l)}}}return t};this._isFormFactorSupported=function(e){var n=e.deviceTypes;var i=o.getFormFactor();if(n&&n[i]===false){return false}return true};this.getPluginLoadingPromise=function(e){if(this._oCategoryLoadingProgress.hasOwnProperty(e)){return this._oCategoryLoadingProgress[e].promise()}};this.loadPlugins=function(i){var t=this;var r;o.setPerformanceMark("FLP -- PluginManager.startLoadPlugins["+i+"]");if(i===l){r=n.getInterface()}if(g&&Array.prototype.indexOf.call(g,i)!==-1){if(t._oCategoryLoadingProgress[i].pluginLoadingTriggered===undefined){t._oCategoryLoadingProgress[i].pluginLoadingTriggered=true}if(Object.keys(t._oPluginCollection[i]).length>0){var a=[];var c=Object.keys(t._oPluginCollection[i]);if(new URLSearchParams(window.location.search).get("sap-ushell-xx-pluginmode")==="discard"&&(i==="RendererExtensions"||i==="AppWarmup")){c=c.filter(function(e){return t._oPluginCollection[i][e].component===u})}c.forEach(function(e){var n=t._oPluginCollection[i][e];if(!n.loaded){n.loaded=true;var o=new jQuery.Deferred;a.push(o.promise());t._handlePluginCreation(i,e,o,r)}});if(a.length>0){Promise.allSettled(a.map(function(e,n){return new Promise(function(i){var t={pluginName:c[n],success:true};e.done(function(){i(t)}).fail(function(e){t.success=false;t.error=e;i(t)})})})).then(function(e){o.setPerformanceMark("FLP -- PluginManager.endLoadPlugins["+i+"]");t._oCategoryLoadingProgress[i].resolve(e.map(function(e){return e.value}))})}}else{t._oCategoryLoadingProgress[i].resolve()}}else{e.error("Plugins with category "+i+" cannot be loaded by the PluginManager",s);t._oCategoryLoadingProgress[i].reject("Plugins with category "+i+" cannot be loaded by the PluginManager")}return t._oCategoryLoadingProgress[i].promise()};this._buildNamesOfPluginsWithAgents=function(){var e=this;var n="";Object.keys(e._oPluginCollection).forEach(function(i){Object.keys(e._oPluginCollection[i]).forEach(function(t){var o=e._oPluginCollection[i][t];if(o&&o.enabled&&o.enabled===true){if(o.config&&o.config["sap-plugin-agent"]===true){n+=(o.config["sap-plugin-agent-id"]||t)+","}}})});if(n.endsWith(",")){n=n.slice(0,-1)}this._sPluginAgentsNames=n};this._getNamesOfPluginsWithAgents=function(){return this._sPluginAgentsNames}}c.hasNoAdapter=true;return c},true);
//# sourceMappingURL=PluginManager.js.map