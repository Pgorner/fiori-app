// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ui/thirdparty/URI","sap/ushell/ApplicationType/systemAlias","sap/ushell/ApplicationType/utils","sap/ushell/services/ClientSideTargetResolution/ParameterMapping","sap/ushell/services/ClientSideTargetResolution/Utils"],function(e,t,s,r,a,n,i){"use strict";function u(e,t){t.forEach(function(t){delete e[t]})}function o(e,t){return t&&t.signature&&t.signature&&t.signature.parameters&&t.signature.parameters[e]&&t.signature.parameters[e].required===true}function p(e,t){var s=o("DYNP_OKCODE",t)||o("DYNP_NO1ST",t);var r=[];if(s){return[]}var a=l(e);function n(e){return e.toUpperCase()}var i=Object.keys(a).map(n).sort();function u(e,t){if(e.length!==t.length){return false}return e.every(function(s,r){return e[r]===t[r]})}if(u(["DYNP_NO1ST","DYNP_OKCODE"],i)||u(["DYNP_OKCODE"],i)||u(["DYNP_NO1ST"],i)){r=Object.keys(a)}return r}function l(e){var t=i.filterObject(e,c);return t}function c(e,t){var s;if(arguments.length===1){s=e.split(/[=](.+)?/);if(s.length>1){return c.apply(null,s)}}return!(e.indexOf("sap-")===0||e.indexOf("saml")===0||e.charAt(0)==="~")}function m(e,t,s){var r=e.inbound,n=r&&r.resolutionResult,i;if(!(!r||!n||!n["sap.gui"]||!(n.applicationType==="TR"))){i=S(e,t,s)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/~canvas;")>=0)||!(n.url.indexOf("app/transaction/APB_LPD_CALL_")===-1))){i=g(e,t,s)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/~canvas;")>=0)||!(n.url.indexOf("app/transaction/APB_LPD_CALL_")>=0))){i=P(e,t,s)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/its/webgui")>=0)||!(n.url.indexOf("APB_LPD_CALL_")===-1))){i=h(e,t,s)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/its/webgui")>=0)||!(n.url.indexOf("APB_LPD_CALL_")!==-1))){i=v(e,t,s)}if(i){return i.then(function(t){if(t.url){t.url=a.appendParametersToUrl("sap-iframe-hint=GUI",t.url)}t.extendedInfo=a.getExtendedInfo(e);a.checkOpenWithPost(e,t);a.addKeepAliveToURLTemplateResult(t);return t})}throw new Error("Cannot generate TR resolution result")}function f(e,t,a,n){var i,u;e=encodeURIComponent(e);i="/gui/sap/its/webgui?%7etransaction="+e+"&%7enosplash=1";u=new s(i);return r.spliceSapSystemIntoURI(u,r.LOCAL_SYSTEM_ALIAS,t,a,"NATIVEWEBGUI",r.SYSTEM_ALIAS_SEMANTICS.apply,n)}function d(e,t,s,r){var n,i="P_OBJECT"+r,u=132;var o=a.getURLParsing().privparamsToString(t,"%25","%21");if(!o){return e}var p="";y("P_OBJECT",e,s,r,function(e){var t=e.replace(i,"");p=decodeURIComponent(t);if(p.length>0){p=p+"%25"}return i});o=p+o;var l={pObjX:"",pObject:""};o.match(new RegExp(".{1,"+u+"}","g")).map(function(e){return encodeURIComponent(e)}).forEach(function(e,t){var a="P_OBJECT";var n="pObject";if(t>0){a="P_OBJ"+t;n="pObjX"}var i=l[n].length===0?"":s;l[n]=l[n]+i+a+r+e});n=[l.pObjX,l.pObject].filter(function(e){return e.length>0}).join(s);var c=y("P_OBJECT",e,s,r,function(e){return n});if(c.found){return c.query}return e+(e.length===0?"":s)+n}function y(e,t,s,r,a){var n=false,i=e+r;var u=t.split(s).map(function(e){if(e.indexOf(i)!==0){return e}n=true;return a(e)}).filter(function(e){return typeof e!=="undefined"}).join(s);return{found:n,query:u}}function v(e,n,i){var u=e.inbound,o=u&&u.resolutionResult,p={};var l=new s(n);var c=t({},e.mappedIntentParamsPlusSimpleDefaults);var m=c["sap-system"]&&c["sap-system"][0];var f=c["sap-system-src"]&&c["sap-system-src"][0];p["sap-system"]=m;delete c["sap-system"];if(typeof f==="string"){p["sap-system-src"]=f;delete c["sap-system-src"]}return r.spliceSapSystemIntoURI(l,o.systemAlias,m,f,"NATIVEWEBGUI",o.systemAliasSemantics||r.SYSTEM_ALIAS_SEMANTICS.applied,i).then(function(e){var t=e.search();var s=t.split("&").map(function(e){var t;if(e.indexOf("?%7etransaction")===0||e.indexOf("%7etransaction")===0){t=d(e,c,"%3b","%3d");return t}return e}).join("&");e.search(s);["additionalInformation","applicationDependencies"].forEach(function(e){if(u.resolutionResult.hasOwnProperty(e)){p[e]=u.resolutionResult[e]}});p.url=e.toString();p.text=u.title;p.applicationType="TR";a.setSystemAlias(p,u.resolutionResult);return p})}function S(e,t,s){var r=e.inbound,i=r&&r.resolutionResult,u=e.mappedIntentParamsPlusSimpleDefaults||{};var o=i.systemAlias;if(u["sap-system"]){o=u["sap-system"][0]}var p;if(u["sap-system-src"]){p=u["sap-system-src"][0]}return f(r.resolutionResult["sap.gui"].transaction,o,p,s).then(function(t){n.mapParameterNamesAndRemoveObjects(e);var s=R(e.inbound,e.mappedIntentParamsPlusSimpleDefaults,t);if(s&&e.inbound&&e.inbound.resolutionResult&&e.inbound.resolutionResult["sap.platform.runtime"]){s["sap.platform.runtime"]=e.inbound.resolutionResult["sap.platform.runtime"]}s["sap-system"]=o;a.setSystemAlias(s,r.resolutionResult);return s})}function P(e,n,i){var u=e.inbound,o=u&&u.resolutionResult;var p={};var l=new s(n);var c=t({},e.mappedIntentParamsPlusSimpleDefaults);var m=c["sap-system"]&&c["sap-system"][0];var f=c["sap-system-src"]&&c["sap-system-src"][0];p["sap-system"]=m;delete c["sap-system"];if(typeof f==="string"){p["sap-system-src"]=f;delete c["sap-system-src"]}return r.spliceSapSystemIntoURI(l,o.systemAlias,m,f,"WEBGUI",o.systemAliasSemantics||r.SYSTEM_ALIAS_SEMANTICS.applied,i).then(function(e){var t=e.search();t=d(t,c,"&","=");e.search(t);["additionalInformation","applicationDependencies"].forEach(function(e){if(u.resolutionResult.hasOwnProperty(e)){p[e]=u.resolutionResult[e]}});p.url=e.toString();p.text=u.title;p.applicationType="NWBC";a.setSystemAlias(p,u.resolutionResult);return p})}function g(e,n,i){var o=e.inbound,l=o&&o.resolutionResult;var c={};var m=new s(n);var f=t({},e.mappedIntentParamsPlusSimpleDefaults);var d=f["sap-system"]&&f["sap-system"][0];var y=f["sap-system-src"]&&f["sap-system-src"][0];c["sap-system"]=d;delete f["sap-system"];if(typeof y==="string"){c["sap-system-src"]=y;delete f["sap-system-src"]}var v=p(f,o||{});u(f,v);return r.spliceSapSystemIntoURI(m,l.systemAlias,d,y,"WEBGUI",c.systemAliasSemantics||r.SYSTEM_ALIAS_SEMANTICS.applied,i).then(function(e){var t=a.getURLParsing().paramsToString(f);var s=e.search();if(t){s=s+(s.indexOf("?")<0?"?":"&")+t}e.search(s);["additionalInformation","applicationDependencies"].forEach(function(e){if(o.resolutionResult.hasOwnProperty(e)){c[e]=o.resolutionResult[e]}});c.url=e.toString();c.text=o.title;c.applicationType="NWBC";a.setSystemAlias(c,o.resolutionResult);return c})}function h(e,a,n){var i=e.inbound,u=i&&i.resolutionResult,o={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true,"sap-system-src":true};var p=new s(a);var l=t({},e.mappedIntentParamsPlusSimpleDefaults);var c=l["sap-system"]&&l["sap-system"][0];var m=l["sap-system-src"]&&l["sap-system-src"][0];Object.keys(l).forEach(function(e){if(o[e.toLowerCase()]){delete l[e]}});return r.spliceSapSystemIntoURI(p,u.systemAlias,c,m,"NATIVEWEBGUI",u.systemAliasSemantics||r.SYSTEM_ALIAS_SEMANTICS.applied,n).then(function(t){var s=R(e.inbound,e.mappedIntentParamsPlusSimpleDefaults,t);return s})}function R(s,r,n){var i={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var o={};var l=t({},r);var m=l["sap-system"]&&l["sap-system"][0];var f=l["sap-system-src"]&&l["sap-system-src"][0];o["sap-system"]=m;if(typeof f==="string"){o["sap-system-src"]=f}Object.keys(l).forEach(function(e){if(i[e.toLowerCase()]){delete l[e]}});var d=p(l,s||{});u(l,d);var y=b(l);u(l,Object.keys(y));var v=n.search();var S=v.split("&").map(function(t){var s;if(!c(t)){if(t.indexOf("=")>=0){s=t.split("=");if(!y.hasOwnProperty(s[0])){y[s[0]]=s[1]}}else{e.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+t+"'","sap.ushell.services.ClientSideTargetResolution")}return undefined}var r;if(t.indexOf("?%7etransaction")===0||t.indexOf("%7etransaction")===0){r=I(t,l,"%3b","%3d");return r}return t}).filter(function(e){return typeof e!=="undefined"}).join("&");var P=a.getURLParsing().paramsToString(y);S=[S,P.replace("~","%7e")].join("&");n.search(S);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(e){if(s.resolutionResult.hasOwnProperty(e)){o[e]=s.resolutionResult[e]}});o.url=n.toString();o.text=s.title;o.applicationType="TR";a.setSystemAlias(o,s.resolutionResult);return o}function b(e){var t;t=i.filterObject(e,function(e,t){return!c(e,t)});return t}function O(e){var t="^(.+?)(%20|(%20)(.+))?$",s=new RegExp(t,"i"),r,a={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var n=e.split("=");if(n.length>2){return{error:"Found more than one assignment ('=') in the transaction query parameter",details:"Only one '=' sign is expected in "+e}}if(n.length<2||typeof n[1]==="undefined"||n[1].length===0){return{error:"The transaction query parameter must specify at least the transaction name",details:"Got "+e+" instead."}}a.transactionParamName=n[0];r=n[1];var i=r.match(s);if(!i){return{error:"Cannot parse ~transaction query parameter value.",details:r+" should match /"+t+"/"}}a.transactionCode=i[1];if(i[2]&&i[2]!=="%20"){var u=i[4]||"";u.split("%3b").forEach(function(e){var t=e.split("%3d"),s=t[0];if(s&&typeof s==="string"&&s.length>0){a.parameters.push({name:s,value:t[1]})}})}a.hasParameters=false;if(a.parameters.length>0){a.hasParameters=true;a.transactionCode=a.transactionCode.replace(/^[*]/,"")}return a}function I(t,s){var r=O(t);if(r.error){e.error(r.error,r.details,"sap.ushell.services.ClientSideTargetResolution");return t}var n=r.parameters.map(function(e){return e.name.toUpperCase()+"%3d"+e.value});const i=T(s);var u={};Object.keys(s).forEach(function(e){u[e.toUpperCase()]=s[e]});var o=a.getURLParsing().privparamsToString(u,"%3b","%3d");if(o){if(Object.keys(s).length>0){o+="%3b"}n.push(o)}var p=n.length>0;return r.transactionParamName+"="+(p&&(i===""||i==="1")?"*":"")+r.transactionCode+(p?"%20":"")+n.join("%3b")}function T(e){let t="";if(e.hasOwnProperty("DYNP_SKIP_SEL_SCREEN")){let s=e["DYNP_SKIP_SEL_SCREEN"][0];delete e["DYNP_SKIP_SEL_SCREEN"];if(s===""||s===" "||s==="0"||s===0||typeof s==="string"&&s.toLowerCase()==="false"){t="0"}else if(s==="1"||s===1||typeof s==="string"&&s.toLowerCase()==="true"){t="1"}}return t}function E(e,t,s){return new Promise(function(r,i){var u;if(e.params["sap-system-src"]){u=e.params["sap-system-src"][0]}var o=e.params["sap-system"]?e.params["sap-system"][0]:undefined;var p=e.params["sap-ui2-tcode"]?e.params["sap-ui2-tcode"][0]:undefined;f(p,o,u,s).then(function(e){delete t.intentParamsPlusAllDefaults["sap-ui2-tcode"];n.mapParameterNamesAndRemoveObjects(t);var s=R(t.inbound,t.mappedIntentParamsPlusSimpleDefaults,e);if(s&&t.inbound&&t.inbound.resolutionResult&&t.inbound.resolutionResult["sap.platform.runtime"]){s["sap.platform.runtime"]=t.inbound.resolutionResult["sap.platform.runtime"]}s["sap-system"]=o;s.text=p;s.url=a.appendParametersToUrl("sap-iframe-hint=GUI",s.url);r(s)}).catch(function(e){i(e)})})}return{generateTRResolutionResult:m,resolveEasyAccessMenuIntentWebgui:E,getUnnecessaryWebguiParameters:p,removeObjectKey:u,getExplicitSkipSelectionScreenParameter:T,injectEffectiveParametersIntoWebguiQueryParam:I,injectEffectiveParametersIntoWebguiPobjectParam:d,amendGuiParam:y,parseWebguiTransactionQueryParam:O,getWebguiNonBusinessParameters:b,getWebguiBusinessParameters:l,isWebguiBusinessParameter:c,buildNativeWebGuiURI:f,constructFullWebguiResolutionResult:S}});
//# sourceMappingURL=guiResolution.js.map