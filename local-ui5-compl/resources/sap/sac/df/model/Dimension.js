/*!
* SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
*/
sap.ui.define("sap/sac/df/model/Dimension",["sap/ui/base/Object","sap/sac/df/model/MemberFilter","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library","sap/sac/df/utils/ResourceBundle","sap/sac/df/utils/ListHelper","sap/sac/df/types/DisplayType","sap/sac/df/utils/SyncActionHelper","sap/sac/df/types/DimensionType"],function(e,t,i,r,n,s,a,o,l){"use strict";var m=e.extend("sap.sac.df.model.Dimension",{constructor:function(e,n){Object.assign(this,Object.getPrototypeOf(this));var o=this;this._DataProvider=e;this._FFDimension=n;var m=this._FFDimension.getAxisType();if(m!==r.AxisType.COLUMNS&&m!==r.AxisType.ROWS&&m!==r.AxisType.FREE){return null}var u=this._FFDimension.getAxis();var F=this._FFDimension.isMeasureStructure();var c=this._FFDimension.isStructure();if(!this._FFDimension.getExternalName()||this._FFDimension.getExternalName().trim()===""){this._FFDimension.getExternalName=this._FFDimension.getName}this._createMemberFilter=function(){this.MemberFilter=[];if(this._FFDimension.isStructure()||this._FFDimension.isMeasureStructure()){this.MemberFilter=this._createMemberFilterForStructures()}else{this.MemberFilter=i.map(this._FFDimension.getFilter()&&s.arrayFromList(this._FFDimension.getFilter()),e=>t._createFromFFFilter(e,this._FFDimension.getFilter()))}};this._getDisplayType=function(e){switch(e){case r.FilterDisplayInfo.ID:return a.Key;case r.FilterDisplayInfo.DESCRIPTION:return a.Text;case r.FilterDisplayInfo.ID_AND_DESCRIPTION:return a.KeyText;case r.FilterDisplayInfo.DESCRIPTION_AND_ID:return a.TextKey}};this._createMemberFilterForStructures=function(){var e=this._FFDimension.getFilter()&&s.arrayFromList(this._FFDimension.getFilter());if(e){return i.map(e,e=>{const r=i.find(o.getStructureMembers(),t=>t.Key===e.getLow().getString());const n=e.getSetSign().getName?e.getSetSign().getName():e.getSetSign();const s=e.getComparisonOperator().getName();const a=t.getUI5OperatorFromFFOperator({Sign:n,Operator:s});return this._createMemberFilterFromStructureMember(r,a)})}};this._createMemberFilterFromStructureMember=function(e,i){return new t([e.Key],[e.Name],[e.Description],i)};if(F){h(this);this.Members=p(this._FFDimension)}else if(c&&!F){y(this);this.Members=p(this._FFDimension)}var g=!!this._FFDimension.getFilter();Object.assign(this,{Name:this._FFDimension.getExternalName(),TechName:this._FFDimension.getName(),Description:this._FFDimension.getText(),Axis:u.getName(),Type:this._FFDimension.getDimensionType().getName(),HierarchyActive:this._FFDimension.isHierarchyActive(),HasFilter:g,SortDirection:d(this._FFDimension),Position:u.getDimensionIndex(this._FFDimension.getName()),LastPosition:u.getDimensionCount()-1,IsStructure:this._FFDimension.isStructure(),IsMeasureStructure:this._FFDimension.isMeasureStructure(),ValueType:f(this._FFDimension),DisplayType:r.FilterDisplayInfo.getDimensionDisplayInfo(this._FFDimension),FilterDisplayType:null,SemanticObject:this._FFDimension.getSemanticObject(),MemberFilter:[],SupportedOperators:D(o._FFDimension).filter(Boolean)});o._createMemberFilter();if(this._FFDimension.getFilter()&&this.FilterDisplayType!==this._FFDimension.getFilter().getUiSettings(r.QContextType.SELECTOR).getDisplayInfo()){this.FilterDisplayType=this._getDisplayType(this._FFDimension.getFilter().getUiSettings(r.QContextType.SELECTOR).getDisplayInfo())}else{this.FilterDisplayType=this._getDisplayType(this.DisplayType)}function D(e){if(e&&e.getFilterCapabilities()){let n=e.getFlatKeyField();if(!!n&&e.getFilterCapabilities().getFilterCapabilitiesByField(n)){const a=s.arrayFromList(e.getFilterCapabilities().getFilterCapabilitiesByField(n).getSupportedComparisonOperators(r.SetSign.INCLUDING));if(a){return i.map(a,function(e){if(e&&e.getName()){return t.getUI5OperatorFromFFOperator({Sign:"INCLUDING",Operator:e.getName()})}})}}}return["EQ"]}function p(e){var t=e.getDisplayKeyField();return i.map(s.arrayFromList(e.getAllStructureMembers()),function(i){return _(i,e,t)})}function h(e){e._FFDimension.getExternalName=i.constant(l.MeasureStructure);e.addMemberFilterByKey=function(e){var i=this.getStructureMember(e);if(i){var r=new t([i.Key],[i.Name],[i.Description]);return new Promise(e=>{this.addMemberFilter(r);e()})}};e.removeMemberFilterByKey=function(e){var i=this.getStructureMember(e);if(i){var r=new t([i.Key],[i.Name],[i.Description]);return new Promise(e=>{this.removeMemberFilter(r);e()})}};e.setMemberFilterByKey=function(e){var i=this.getStructureMember(e);if(r){var r=new t([i.Key],[i.Name],[i.Description]);var n=[r];return new Promise(e=>{this.setMemberFilter(n);e()})}};e.getStructureMembers=function(){return e.Members};e.getStructureMember=function(t){return i.find(e.getStructureMembers(),function(e){return e&&e.Name===t})};e.setScalingFactor=function(t,i){return e._DataProvider.getMeasure(t).setScalingFactor(i)};e.getScalingFactor=function(t){return e._DataProvider.getMeasure(t).getScalingFactor()};e.setDecimalPlaces=function(t,i){return e._DataProvider.getMeasure(t).setDecimalPlaces(i)};e.getDecimalPlaces=function(t){return e._DataProvider.getMeasure(t).getDecimalPlaces()}}function y(e){e._FFDimension.getExternalName=i.constant(l.StructureDimension);e.addMemberFilterByKey=function(e){var i=this.getStructureMember(e);if(r){var r=new t([i.Key],[i.Name],[i.Description]);return new Promise(e=>{this.addMemberFilter(r);e()})}};e.removeMemberFilterByKey=function(e){var i=this.getStructureMember(e);if(r){var r=new t([i.Key],[i.Name],[i.Description]);return new Promise(e=>{this.removeMemberFilter(r);e()})}};e.setMemberFilterByKey=function(e){var i=this.getStructureMember(e);if(i){var r=new t([i.Key],[i.Name],[i.Description]);var n=[r];return new Promise(e=>{this.setMemberFilter(n);e()})}};e.getStructureMembers=function(){return e.Members};e.getStructureMember=function(t){return i.find(e.getStructureMembers(),function(e){return e.Name===t})};e.setScalingFactor=function(){};e.getScalingFactor=function(){};e.setDecimalPlaces=function(){};e.getDecimalPlaces=function(){}}function _(e,t,i){return{Key:e.getFieldValue(t.getKeyField()).getValue().getString(),Name:e.getFieldValue(t.getDisplayKeyField())?e.getFieldValue(i).getValue().getString():e.getName(),TechName:e.getName(),Description:e.getText(),SemanticObject:e.getSemanticObject()}}function d(e){var t=o._DataProvider._getQueryModel().getSortingManager();if(t.supportsDimensionSorting(e,null)&&e.hasSorting()){return e.getResultSetSorting().getDirection().getName()}else{return null}}function f(e){var t=r.XValueType.STRING;var i=e.getFlatKeyField();if(i&&(i.getValueType().isNumber()||r.QFilterUtil.supportsDateRangeFilter(i))){t=i.getValueType()}return t.getName()}}});m.prototype.searchMember=function(e,i,n,s,a,o){const l=this;if(n===undefined){n=true}if(s===undefined){s=true}if(a===undefined){o=false;a=1}const m=this._FFDimension;const u=r.XList.create();const F=r.XList.create();const c=m.getDimension();const g=c.getTextField();if(g){F.add(g);if(n){u.add(g)}}if(c.getDisplayKeyField()&&s){u.add(c.getDisplayKeyField())}return r.QFactory.createDimensionValueHelpWizard(m).withReadMode(r.QMemberReadMode.BOOKED).withPaging(0,a).withMainKeyAndTextFields().searchPromise(e,s,n,o,i).then(function(r){const n=m.getHierarchyName();return t.createFromFFValueHelpNode(r,n,!i?e:null)}).onCatch(function(e){l._DataProvider.addMessages(e)})};m.prototype.toRows=function(){this._DataProvider._executeModelOperation(()=>{this._DataProvider._FFDataProvider.getActions().getAxisActions().moveDimensionToAxis(this.TechName,r.AxisType.ROWS)});return this};m.prototype.toColumns=function(){this._DataProvider._executeModelOperation(()=>{this._DataProvider._FFDataProvider.getActions().getAxisActions().moveDimensionToAxis(this.TechName,r.AxisType.COLUMNS)});return this};m.prototype.moveUp=function(){this._DataProvider._executeModelOperation(()=>{var e=this._FFDimension.getAxis();var t=e.getDimensionIndex(this._FFDimension.getName())-1;e.insert(t,this._FFDimension)});return this};m.prototype.moveDown=function(){this._DataProvider._executeModelOperation(()=>{var e=this._FFDimension.getAxis();var t=e.getDimensionIndex(this._FFDimension.getName())+1;e.insert(t,this._FFDimension)});return this};m.prototype.getMemberFilter=function(){return this.MemberFilter};m.prototype._applyMemberFilter=function(e){const n=t._condenseDimensionMemberFilter(e,i.clone(this._FFDimension.getFilter()),this._FFDimension);this._DataProvider._getQueryModel().queueEventing();r.QFilterUtil.clearSelectionsInContainerByDimension(this.TechName,this._DataProvider._getQueryModel().getFilter().getDynamicFilter());r.FilterDialogValueUtils.updateDynamicFilter(this._FFDimension,n);this._DataProvider._getQueryModel().resumeEventing();this._createMemberFilter();this._DataProvider._triggerDataProviderPropertyUpdate()};m.prototype.setMemberFilter=function(e){return this._applyMemberFilter(e)};m.prototype.removeMemberFilter=function(e){var t=i.filter(i.clone(this.getMemberFilter()),function(t){return!i.isEqual(e.InternalKey,t.InternalKey)});if(t.length>0){return new Promise(e=>{this._applyMemberFilter(t);e()})}else{return new Promise(e=>{this.clearMemberFilter();e()})}};m.prototype.clearMemberFilter=function(){return new Promise(e=>{this._applyMemberFilter([]);e()})};m.prototype.addMemberFilterByKey=function(e){var i=new t([e]);return new Promise(e=>{this.addMemberFilter(i);e()})};m.prototype.setMemberFilterByKey=function(e){var i=[new t([e])];return new Promise(e=>{this.setMemberFilter(i);e()})};m.prototype.removeMemberFilterByKey=function(e){return new Promise(i=>{this.removeMemberFilter(new t([e]));i()})};m.prototype.addMemberFilter=function(e){let t=i.clone(this.getMemberFilter())||[];t.push(e);return new Promise(e=>{this.setMemberFilter(t);e()})};m.prototype.sort=function(e,t,n){this._DataProvider._executeModelOperation(()=>{var s=this._DataProvider._getQueryModel().getDimensionByName(this.TechName);if(this.IsStructure){var a=this._DataProvider._getQueryManager().getConvenienceCommands();a.clearSort(null,null);a.sortByMeasure(i.find(this.Members,e=>e.Name===n).TechName,r.XSortDirection[e])}else{s.getResultSetSorting().setDirection(r.XSortDirection[e]);if(t){s.getResultSetSorting().setSortType(r.SortType[t])}}});return this};m.prototype.removeDrilldown=function(){this._DataProvider._executeModelOperation(()=>{this._DataProvider._getQueryModel().getAxis(r.AxisType.FREE).add(this._FFDimension)});return this};m.prototype.setDisplayHierarchy=function(e,t,i){this._DataProvider._executeModelOperation(()=>{if(t){this._FFDimension.setHierarchyName(t);if(i){this._FFDimension.setHierarchyVersion(i)}}this._FFDimension.setHierarchyActive(e)});return this};m.prototype.readHierarchy=function(e){var t=this;var s=this._DataProvider._getQueryManager().getValueHelpProvider();var a=this._FFDimension.getInitialDrillLevel();this._FFDimension.setSelectorInitialDrillLevel(e);var l=new Promise((e,i)=>{s.processValueHelp(t._FFDimension,r.SyncType.NON_BLOCKING,{onValuehelpExecuted:function(t){return t.hasErrors()?i(o.reject(t.getErrors())):e(t.getData())}},null,null)});return l.then(e=>{function r(e){if(!e){return{}}var t=e.getChildren();return{Name:e.getName(),Text:e.getDimensionMember().getText()||e.getDimensionMember(e.getDimension().getHierarchyDisplayKeyField()).getValue().getString(),hierNodes:t?i.map(t.getListFromImplementation(),r):null}}t._FFDimension.setSelectorInitialDrillLevel(a);var s=i.filter(e.getListFromImplementation(),e=>!e.getParentNode());return s.length===1?r(s[0]):{Name:"$Root",Text:n.getText("ARTIFICIAL_ROOT"),hierNodes:i.map(s,r)}})};m.setDimensionDisplay=function(e){this._DataProvider._executeModelOperation(()=>{var t=this._FFDimension.getDisplayKeyField()||this._FFDimension.getKeyField();var r=this._FFDimension.getTextField();var n=this._FFDimension.getResultSetFields();var o=i.filter(s.arrayFromList(n).map(e=>e),e=>e!==this._FFDimension.getKeyField()&&e!==this._FFDimension.getTextField()&&e!==this._FFDimension.getDisplayKeyField());n.clear();switch(e){case a.Key:n.add(t);break;case a.Text:n.add(r);break;case a.KeyText:n.add(t);n.add(r);break;case a.TextKey:n.add(r);n.add(t);break}i.forEach(o,e=>{n.add(e)})});return this};m.prototype.openPropertyDialog=function(){var e=this;return new Promise(function(t){var i=r.ProgramRunner.createRunner(e._DataProvider._Model.getApplication().getProcess(),r.OuDimensionDialog2.DEFAULT_PROGRAM_NAME);i.setStringArgument(r.OuDimensionDialog2.PARAM_DIMENSION_NAME,e.TechName);var n=r.ProgramStartData.create();n.putXObject(r.DfOuDialogProgram.PRG_DATA_QUERY_MANAGER,e._DataProvider._getQueryManager());n.putXObject(r.DfOuDialogProgram.PRG_DATA_OK_PROCEDURE,{execute:function(){t(true)}});n.putXObject(r.DfOuDialogProgram.PRG_DATA_CANCEL_PROCEDURE,{execute:function(){t(false)}});i.setProgramStartData(n);return i.runProgram()}).then(function(t){if(t){e._DataProvider._executeModelOperation()}})};m.prototype.openValueHelpDialog=function(){let e=this;let t;if(!this._DataProvider._getQueryModel().getFilter().getDynamicFilter().isCartesianProduct()){throw new Error("Filter to complex")}return Promise.resolve().then(()=>new Promise(e=>{const i=r.FilterDialogProgramRunnerFactory.createForDimensionFilter(this._DataProvider._Model.getApplication().getProcess(),this._DataProvider._getQueryManager(),this._FFDimension.getName(),n.getText("SELECTOR",[this.Description]));i.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_DEFAULT_SELECTION,r.FilterDialogValueFactory.createSelectionFromFilter(this._FFDimension,this._FFDimension.getFilter()));i.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_LISTENER_CLOSE,{onFilterDialogOk:function(t){e(t)},onFilterDialogCancel:function(){e(null)}});i.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_LISTENER_BEFORE_FILTER_CHANGE,{onBeforeChange:function(e){t=e.getDisplayInfo()}});i.runProgram()})).then(i=>{let n=e._FFDimension.getFilter();if(t){this.FilterDisplayType=this._getDisplayType(t);if(n){n.getUiSettings(r.QContextType.SELECTOR).setDisplayInfo(t)}}if(i){this._createMemberFilter();this._DataProvider._triggerDataProviderPropertyUpdate()}return!!i})};return m});
//# sourceMappingURL=Dimension.js.map