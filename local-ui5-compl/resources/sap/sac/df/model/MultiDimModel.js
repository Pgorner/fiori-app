/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/model/MultiDimModel",["sap/base/i18n/Formatting","sap/base/i18n/Localization","sap/ui/model/Model","sap/ui/model/json/JSONModel","sap/base/Log","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ListHelper","sap/sac/df/model/internal/_DFKernel","sap/sac/df/model/internal/SystemLandscape","sap/sac/df/model/DataProvider","sap/sac/df/model/VariableGroup","sap/sac/df/model/Configuration","sap/sac/df/utils/ResourceBundle","sap/ui/core/Configuration","sap/ui/model/BindingMode","sap/sac/df/utils/MetaPathHelper","sap/sac/df/types/VisualizationType","sap/sac/df/model/extensions/contextMenu/ContextMenuProviderRegistry","sap/sac/df/model/extensions/styling/GridStylingTemplateRegistry","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library"],function(e,t,r,a,i,o,s,n,d,u,l,p,g,c,P,h,f,m,v,y,D){"use strict";var S=a.extend("sap.sac.df.model.MultiDimModel",{constructor:function(e){Object.assign(this,Object.getPrototypeOf(this));r.call(this);var t=this;this.VariableGroupMapping={};this._metadataCacheEnabled=e&&e.metadataCacheEnabled||false;e.widgetCatalogPath=e.widgetCatalogPath||"vfs/analyticalwidgets/";this._SystemSettings={systemLandscape:e&&e.systemLandscape||d,systemType:e&&e.systemType||"BW",masterSystem:e&&e.masterSystem||"local"+(e&&e.systemType||"BW"),clientIdentifier:e&&e.clientIdentifier,keepAliveInterval:e&&e.keepAliveInterval,widgetCatalogPath:e.widgetCatalogPath};this.initCompletedPromise=this._getUserProfile().then(e=>n.init({systemSettings:this._SystemSettings,userProfile:e})).then(function(e){t.kernelProgram=e;t._setupSharedDataSpace();D.XLocalizationCenter.setExternalAdapter(g);D.XLocalizationCenter.getCenter().setProductive(true)}).then(function(){t._StylingProviderRegistry={Grid:new v(t)};t._ContextMenuProviderRegistry=new m(t);t.setData({DataProviders:{},VariableGroups:{},Messages:[],Configuration:{}});t.checkUpdate()});t._openSettingDialog=function(){let e=D.SuSettingsDialog.createRunnerForConfigurationType(this.getApplication().getProcess(),D.CoConfigurationType.OTHER);e.setBooleanArgument(D.SuSettingsDialog.PARAM_USER_MODE,true);e.setStringArgument(D.SuSettingsDialog.PARAM_CONFIGURATION_NAMES,"ValueHelpDialogConfiguration");e.runProgram()};t._setupSharedDataSpace=function(){var e=this.getSession();var t=e.getSharedDataSpace(D.OuDataProviderCommandPlugin.DEFAULT_SHARED_SPACE_NAME);if(!t){e.createSharedDataSpace(D.OuDataProviderCommandPlugin.DEFAULT_SHARED_SPACE_NAME)}};t._addMessages=function(e){this.setMessages(y.map(y.groupBy(y.concat(this.getMessages(),e),"Text"),e=>e[0]));return this.checkUpdate()};var a=this.initCompletedPromise.then(()=>{this.Configuration=new p(this,e.Configuration,e.ConfigurationURI);return this.Configuration.applyConfiguration()}).then(()=>{const t=e&&e.Widgets||[];var r=[];y.forEach(t,(e,t)=>{var a=this.addDataProviderFromWidget(t,e.WidgetId);r.push(a)});return Promise.all(r)}).then(()=>{var r=[];const a=e&&e.DataProviders||[];y.forEach(a,(e,a)=>{var i=this.addDataProvider(a,e.dataSourceName,e.systemName,e.packageName,e.schemaName,e.dataSourceType,e.startWithAutoFetch);y.forEach(e.Visualizations,(e,t)=>{i.then(a=>{r.push(a.addVisualization(t,f[e.type]))})});r.push(e.synchronize?i.then(()=>t.getDataProvider(a).synchronize()):i)});return Promise.all(r).then(()=>t).catch(function(e){t._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})});t.metadataLoaded=()=>a;t.loaded=t.metadataLoaded;t.annotationsLoaded=t.metadataLoaded;t.attachMetadataFailed=y.constant(null);t.fireMetadataFailed=y.constant(null);t.dataLoaded=y.constant(null);t.attachPropertyChange(function(e){if(e.getParameter("path").includes("/AutoFetchEnabled")){t.getDataProvider(e.getParameter("path").split(h.PathTo.DataProviders+"/")[1].split("/AutoFetchEnabled")[0]).setAutoFetchEnabled(e.getParameter("value"))}})},_getUserProfile:function(){const r=new a({defaults:{dateFormat:"MM/DD/YYYY",groupingSeparator:".",decimalSeparator:",",timeFormat:"24hrs"},header:{language:"EN"}});r.setProperty("/header/language",t.getLanguage());const i=e.getCustomLocaleData();if(i&&i["dateFormats-medium"]){r.setProperty("/defaults/dateFormat",i["dateFormats-medium"])}const o=e.getNumberSymbol("decimal");if(o){r.setProperty("/defaults/decimalSeparator",o)}const s=e.getNumberSymbol("group");if(s){r.setProperty("/defaults/groupingSeparator",s)}if(o&&s){r.setProperty("/defaults/groupingSeparator",s)}let n;const d=sap.ui.require("sap/ushell/Container");if(d&&d.getServiceAsync){n=d.getServiceAsync("UserInfo")}else{n=Promise.resolve(null)}return n.then(e=>{if(e){r.setProperty("/username",e.getId());r.setProperty("/header/mail",e.getEmail());r.setProperty("/header/firstName",e.getFirstName());r.setProperty("/header/lastName",e.getLastName());r.setProperty("/header/fullName",e.getFullName())}return JSON.stringify(r.getData())})},getSession:function(){if(!this.kernelProgram){i.error("Kernel not initialized");return null}return this.kernelProgram.getSession()},getApplication:function(){if(!this.kernelProgram){i.error("Kernel not initialized");return null}return this.kernelProgram.getApplication()},getStylingProvider:function(){return this._StylingProvider},_updateVariableGroups:function(e){y.forEach(this.getVariableGroups(),function(t){t.updateVariableGroup(e)})}});S.prototype.fireDataProviderUpdated=function(e){this.fireEvent("dataProviderUpdated",e);return S};S.prototype.addDataProviderFromWidget=function(e,t){var r=this;return r.initCompletedPromise.then(r.removeDataProvider(e)).then(function(){const a=new u(r,e);r.setProperty(h.PathTo.DataProviders+"/"+e,a);return a._createFFDataProviderFromWidget(t)}).then(function(t){r.fireDataProviderAdded({dataProviderName:e});return t}).then(function(e){return e}).catch(function(e){r._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};S.prototype.addDataProvider=function(e,t,r,a,i,o,s){var n=this;let d=y.isUndefined(s)?true:s;return n.initCompletedPromise.then(n.removeDataProvider(e)).then(function(){const s=new u(n,e);n.setProperty(h.PathTo.DataProviders+"/"+e,s);return s._createFFDataProvider(t,r,a,i,o)}).then(function(t){t._FFDataProvider?.getResulting().setAutoFetchActive(d);n.setProperty(h.PathTo.DataProviders+"/"+e+"/AutoFetchEnabled",d);n._updateVariableGroups(true);n.fireDataProviderAdded({dataProviderName:e});return t}).then(function(e){return e}).catch(function(e){n._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};S.prototype.fireDataProviderAdded=function(e){this.fireEvent("dataProviderAdded",e);return S};S.prototype.fireDataProviderRemoved=function(e){this.fireEvent("dataProviderRemoved",e);return S};S.prototype.fireVariableGroupsAdded=function(e){this.fireEvent("variableGroupsAdded",e);return S};S.prototype.fireStylingTemplateActivated=function(e){this.fireEvent("stylingTemplateActivated",e);return S};S.prototype.getDataProvider=function(e){return this.getProperty(h.PathTo.DataProviders+"/"+e)};S.prototype.getDataProviders=function(){return this.getProperty(h.PathTo.DataProviders)};S.prototype.removeDataProvider=function(e){var t=this;var r=this.getDataProvider(e);this.setProperty(h.PathTo.DataProviders+"/"+e,null);if(r){return r.logoff&&r.logoff().then(function(){t._updateVariableGroups();t.fireDataProviderRemoved({dataProviderName:e})}).catch(function(e){return Promise.resolve(e)})}else{return Promise.resolve()}};S.prototype.getVariableGroups=function(){return this.getProperty(h.PathTo.VariableGroups)};S.prototype.getVariableGroup=function(e){return this.getProperty(h.PathTo.VariableGroups+"/"+e)};S.prototype.createVariableGroup=function(e,t,r){return new l(this,e,t,r)};S.prototype.setVariableGroups=function(e){y.forEach(e,e=>{this.setProperty(h.PathTo.VariableGroups+"/"+e.Name,e)});this.fireVariableGroupsAdded();return Promise.resolve(e)};S.prototype.propagateVariableGroupValues=function(e){var t=this;var r=[];var a=this.getDataProvider(e);const i=this.getVariableGroups();const o=i.length>0&&i[0].MergedVariable.DataProviderName;if(o!==e){y.forEach(i,function(r){var i=t.VariableGroupMapping[r.Name];y.forEach(i,function(t){if(t.DataProviderName===e){a.getVariable(t.Name)._transferMemberFilterFromAnotherVariable(r.MergedVariable)}})});this.checkUpdate()}return Promise.all(r)};S.prototype.setMessages=function(e){return this.setProperty(h.PathTo.Messages,e)};S.prototype.getMessages=function(){return this.getProperty(h.PathTo.Messages)};S.prototype.getConfiguration=function(){return this.getProperty(h.PathTo.Configuration)};S.prototype.logoff=function(){return Promise.all(y.invokeMap(this.getDataProvider(),"logoff"))};S.prototype.resetModel=function(){if(!this.bSkipDeserialization){var e=this;var t=[];y.forEach(this.getDataProviders(),function(e){t.push(e.resetToMetaData())});return Promise.all(t).then(function(){e._updateVariableGroups()})}};S.prototype.serialize=function(e){var t=e==="INA_REPOSITORY_DELTA"?D.QModelFormat.INA_REPOSITORY_DELTA:D.QModelFormat.INA_REPOSITORY;return{AssignedFilters:this.getProperty("/AssignedFilters"),DataProviders:y.reduce(this.getDataProviders(),function(e,r){e[r.Name]=r.serialize(t);return e},{})}};S.prototype.deserialize=function(e,t){if(!this.bSkipDeserialization){var r=this;var a=this.getDataProviders();var i=t==="INA_REPOSITORY_DELTA"?D.QModelFormat.INA_REPOSITORY_DELTA:D.QModelFormat.INA_REPOSITORY;this.setProperty(h.PathTo.DataProviders,a||{});return this.initCompletedPromise.then(function(){var t=[];r.setProperty("/AssignedFilters",e.AssignedFilters);y.forEach(e.DataProviders,function(o,s){let n=a[s];if(n&&n._FFDataProvider){t.push(n.deserialize(o,i))}else{r.attachEvent("dataProviderAdded",null,function(t){const a=e.DataProviders[t.getParameter("dataProviderName")];if(a){return Promise.resolve(r.getDataProvider(t.getParameter("dataProviderName")).deserialize(a,i))}})}});return Promise.all(t)}).then(function(){r._updateVariableGroups();return r.checkUpdate()})}};S.prototype.skipDeserialization=function(e){this.bSkipDeserialization=e};S.prototype.getGridStylingTemplateRegistry=function(){return this._StylingProviderRegistry.Grid};S.prototype.getContextMenuProviderRegistry=function(){return this._ContextMenuProviderRegistry};S.M_EVENTS={variableGroupsAdded:"variableGroupsAdded",dataProviderAdded:"dataProviderAdded",dataProviderUpdated:"dataProviderUpdated",dataProviderRemoved:"dataProviderRemoved",loaded:"loaded",dataLoaded:"dataLoaded",stylingTemplateActivated:"stylingTemplateActivated"};S.M_PROPERTIES={DataProviders:"DataProviders",VariableGroups:"VariableGroups",Messages:"Messages"};return S});
//# sourceMappingURL=MultiDimModel.js.map