/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/FlexAnalysis",["sap/sac/df/types/SystemType","sap/ui/core/Control","sap/base/Log","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/sac/df/model/MultiDimModel","sap/sac/df/firefly/library"],function(t,e,i,r,jQuery,a,n){"use strict";var o="GalaxyDataStudio";var s="empty";var l=e.extend("sap.sac.df.FlexAnalysis",{metadata:{properties:{title:{type:"string"},showTitle:{type:"boolean",defaultValue:false},autoUpdate:{type:"boolean",defaultValue:true},configurationURI:{type:"string"},configObject:{type:"object"},configId:{type:"string"},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},hideDesignPanel:{type:"boolean",defaultValue:true},hideStylePanel:{type:"boolean",defaultValue:true},hideMenuBar:{type:"boolean",defaultValue:true},hideStatusBar:{type:"boolean",defaultValue:true},hideToolBar:{type:"boolean",defaultValue:true},hideFilterLine:{type:"boolean",defaultValue:false},hideSideNavigation:{type:"boolean",defaultValue:false},hideLandingPage:{type:"boolean",defaultValue:true},systemName:{type:"string"},dataSource:{type:"string",defaultValue:"$datasource"},systemType:{type:"sap.sac.df.types.SystemType",defaultValue:t.BW},keepAliveInterval:{type:"int",defaultValue:0},clientIdentifier:{type:"string"},dataProvider:{type:"any",bindable:true},multiDimModelId:{type:"string",defaultValue:"om"},metaPath:{type:"string"},implicitVariableHandling:{type:"boolean",defaultValue:true,bindable:false},styleTemplateName:{type:"string"}},events:{onCellClick:{parameters:{cellContext:{type:"object"}}}},aggregations:{customPanels:{type:"sap.ui.core.Control",multiple:true}},defaultAggregation:"customPanels"},logActive:false,init:function(){this.programContainerID=this.getId()+"--program";this.programContainer=jQuery('<div id="'+this.programContainerID+'"/>');this.log("Created")},renderer:{apiVersion:2,render:function(t,e){if(e._error){t.openStart("span",e.getId()+"-error");t.openEnd();t.text(e._error.toString());t.close("span")}else{t.openStart("div",e);t.style("flex","auto");t.style("width",e.getWidth());t.style("height",e.getHeight());t.attr("data-sap-ui-preserve",e.getId());t.openEnd();t.close("div")}}},onAfterRendering:function(){if(e.prototype.onAfterRendering){e.prototype.onAfterRendering.apply(this,arguments)}var t=this.$();this.programContainer.appendTo(t);if(this.closed){t.css("visibility","hidden")}this.log("On after rendering");if(!this.isProgramRunning){this.runProgram()}t.css("position","relative")},_getDataProvider:function(){return this.getMetaPath()&&this.getMetaPath().split(">")&&this._getMultiDimModel()&&this._getMultiDimModel().getProperty(this.getMetaPath().split(">")[1])},_getDataProviderName:function(){return this._getDataProvider()&&this._getDataProvider().Name},_getMultiDimModel:function(){return this.getMetaPath()&&this.getMetaPath().split(">")&&this.getModel(this.getMetaPath().split(">")[0])},_getMultiDimModelId:function(){return this.getMetaPath()&&this.getMetaPath().split(">")[0]},_getDefaultContextMenuProvider:function(){return this._getMultiDimModel().getContextMenuProviderRegistry().getDefaultProvider()},setMetaPath:function(t){this.closed=false;return this.setProperty("metaPath",t)},updateProgramSettings:function(){this.log("Update program settings");var t=this.program.getProcess().getApplication();t.setClientInfo(null,this.getClientIdentifier(),null);this.program.setShowToolbar(!this.getHideToolBar());var e=this.program.getActiveDocument();e.setFilterLineVisible(!this.getHideFilterLine());e.setDesignerPanelVisible(!this.getHideDesignPanel());e.setStylePanelVisible(!this.getHideStylePanel());e.setSideNavigationVisible(!this.getHideSideNavigation());this._setDocumentAutoUpdatesEnabled();this.updateStyleTemplate();this.updateTitle()},registerCustomPanels:function(){var t=this.getCustomPanels();t.forEach(function(t){this.program.registerCustomPanel(t)}.bind(this))},onUiStateChange:function(t){this.log("UI state changed");var e=t.convertToNative();if(e){var i=e[n.AuGdsQbConstants.QD_UI_STATE_OPEN_PANELS];if(i){var r=n.AuGdsPanelType.DESIGNER.getName();var a=Object.prototype.hasOwnProperty.call(i,r)?i[r]:false;this.setProperty("hideDesignPanel",!a,true);var o=n.AuGdsPanelType.STYLE.getName();var s=Object.prototype.hasOwnProperty.call(i,o)?i[o]:false;this.setProperty("hideStylePanel",!s,true)}if(Object.prototype.hasOwnProperty.call(e,n.AuGdsQbConstants.QD_UI_STATE_AUTO_UPDATE)){if(this._getDataProvider()&&this.program.getActiveDocument().isAutoUpdatesEnabled()!==this._getDataProvider().getAutoFetchEnabled()){this._getDataProvider().setProperty("/AutoFetchEnabled",this.program.getActiveDocument().isAutoUpdatesEnabled())}}}},registerUiStateChange:function(){var t=this.program.getActiveDocument();if(t&&t.addUiStateChangeCallback){t.addUiStateChangeCallback(this.onUiStateChange.bind(this))}},updateTitle:function(){if(this.program){var t=this.program.getActiveDocument();if(typeof this.getTitle()=="string"){t.setDocumentTitle(this.getTitle())}t.createQueryDetailsIfNeeded();t.setTableTitleVisible(this.getShowTitle())}},runProgram:async function(){this.log("Run UI5 program");this.isProgramRunning=true;this._error=undefined;try{await this._initModel();const t=this._getMultiDimModel();this.oProgramRunner=n.ProgramRunner.createRunner(t.getSession(),o);await this._processConfigURI();this._setClientArgs();this.oProgramRunner.setNativeAnchorId(this.programContainerID);this.oProgramRunner.runProgram().onThen(t=>{this.log("GDS created");this.program=t;if(this._getDataProvider()?._FFDataProvider){this._setDataProvider()}this.registerCustomPanels();this.registerUiStateChange();this.program.registerDynamicMenuActionsProvider("UI5ContextMenuProvider",this._getDefaultContextMenuProvider());if(this.program.getActiveDocument().getTableView()&&!this.program.getActiveDocument().getTableView().m_onclickConsumer){this.program.getActiveDocument().getTableView().setOnclickConsumer(this._fireOnCellClick.bind(this))}this.updateTitle();this.updateProgramSettings()}).onCatch(t=>{throw new Error(t)})}catch{this._handleInitalisationErrors()}},_fireOnCellClick:function(t){this.fireOnCellClick({cellContext:this._getDefaultContextMenuProvider().convertCellClickContext(t)})},_setDataProvider:function(){if(this._getDataProvider()&&this.program&&this.program.getActiveDocument()){this._setDocumentAutoUpdatesEnabled();this.program.getActiveDocument().setExternalDataProvider(this._getDataProvider()._FFDataProvider)}},exit:function(){if(this.oProgramRunner){this._cleanUpProgram()}},getProgram:function(){return this.program},setPanelVisible:function(t,e){if(this.program){var i=this.program.getActiveDocument();if(i&&i.setPanelVisible){var r=n.AuGdsPanelType.lookup(t);if(r){i.setPanelVisible(r,e)}else{throw new Error("Cannot resolve panel type to adjust visibility!")}}}},setDataProvider:function(t){this.setMetaPath(this.getMultiDimModelId()+">/DataProviders/"+t)},addContextMenuAction:function(t,e){this._getDefaultContextMenuProvider().registerAction(t,e)},setSelectedDataCell:function(t,e){const i=this.program.getActiveDocument().getTableView().getActiveTableContainer();try{const r=i.getRowIndexForTupleIndex(t);const a=i.getColumnIndexForTupleIndex(e);if(r>=0&&a>=0){this.program.getActiveDocument().setSelectedCell(r,a)}}catch(t){console.log(t.message)}},clearCellSelection:function(){this.program.getActiveDocument().clearSelection()},setHideFilterLine:function(t){this.setProperty("hideFilterLine",t,true);if(this.program){this.program.getActiveDocument().setFilterLineVisible(!t)}return this},setStyleTemplateName:function(t){this.setProperty("styleTemplateName",t,true);this.updateStyleTemplate();return this},setAutoUpdate:function(t){if(this._getDataProvider()){this._getDataProvider().setAutoFetchEnabled(t)}return this},setHideToolBar:function(t){this.setProperty("hideToolBar",t,true);if(this.program){this.program.setShowToolbar(!t)}return this},setTitle:function(t){this.setProperty("title",t,true);this.updateTitle();return this},setShowTitle:function(t){this.setProperty("showTitle",t,true);this.updateTitle();return this},setHideSideNavigation:function(t){this.setProperty("hideSideNavigation",t,true);if(this.program){this.program.getActiveDocument().setSideNavigationVisible(!t)}return this},setHideDesignPanel:function(t){this.setProperty("hideDesignPanel",t,true);if(this.program){this.program.getActiveDocument().setDesignerPanelVisible(!t)}return this},setHideStylePanel:function(t){this.setProperty("hideStylePanel",t,true);if(this.program){this.program.getActiveDocument().setStylePanelVisible(!t)}return this},_cleanUpProgram:function(){n.XObjectExt.release(this.oProgramRunner);n.XObjectExt.release(this.program);this.oProgramRunner=null;this.program=null;this.isProgramRunning=false},_initModel:function(){const t=this;t.log("Start init model");let e;const i=t._getMultiDimModel();if(i){i.attachEvent("dataProviderAdded",null,function(t){const e=t.getParameter("dataProviderName");this.log("DP added '"+e+"'");if(e===this._getDataProviderName()){this._setDataProvider()}},t);i.attachEvent("dataProviderRemoved",null,function(e){const i=e.getParameter("dataProviderName");t.log("DP removed '"+i+"'");if(this.program&&this.program.getActiveDocument()){this.program.getActiveDocument().getQueryController().reset()}},t);i.attachEvent("dataProviderUpdated",null,e=>{const i=e.getParameter("dataProviderName");if(i===t._getDataProviderName()){t._setDocumentAutoUpdatesEnabled()}},t);i.attachEvent("requestFailed",null,e=>{const i=e.getParameter("infoObject");if(i===t._getDataProviderName()){t._requestInError=true}},t);i.attachEvent("requestCompleted",null,e=>{const i=e.getParameter("infoObject");if(i===t._getDataProviderName()){if(t._requestInError){t._requestInError=false;t.updateStyleTemplate()}}},t);e=i.loaded()}else{t._requestInError=true;e=Promise.reject(`Multidimensional Model <${t._getMultiDimModelId()}> is unknown!`)}return e},_setDocumentAutoUpdatesEnabled:function(){if(this._getDataProvider()&&this.program&&this.program.getActiveDocument()){if(this.program.getActiveDocument().isAutoUpdatesEnabled()!==this._getDataProvider().getAutoFetchEnabled()){this.program.getActiveDocument().setAutoUpdatesEnabled(!!this._getDataProvider().getAutoFetchEnabled())}}},_setClientArgs:function(){this.log("setClientArgs");this.oProgramRunner.setStringArgument(n.AuGdsConstants.GDF_FILE_DOC_TYPE,this.getDocType());this.oProgramRunner.setStringArgument(n.AuGdsConstants.PARAM_SYSTEM,this._getSystemName());this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_MULTI_DOCUMENTS,false);this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_STATUS_BAR,this.getHideStatusBar());this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_MENU_BAR,this.getHideMenuBar());this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_TOOLBAR,this.getHideToolBar());this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_QUERY_BUILDER_MULTI_VIEWS,false);this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_QUERY_BUILDER_AUTO_OPEN_DATA_SOURCE_PICKER,false);this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_IMPLICIT_VARIABLE_HANDLING,this.getImplicitVariableHandling());this.oProgramRunner.setBooleanArgument(n.AuGdsConstants.PARAM_SUPPRESS_LANDING_PAGE,this.getHideLandingPage());this.oProgramRunner.setStringArgument(n.AuGdsConstants.PARAM_INTEGRATION,"ui5");this.oProgramRunner.setStringArgument(n.AuGdsConstants.PARAM_MODE,n.AuGdsConstants.VALUE_MODE_SAP_UI5_GA)},_handleInitalisationErrors:function(t){this._error=t;this.invalidate()},getDocType:function(){return"QueryBuilder"},_getSystemName:function(){var t=this.getSystemName();if(t&&t.startsWith("$")){t=this.getUrlParams("system")}return t?t:"local"+this.getSystemType()},_updateSupportedPanelsConfiguration:function(t,e){var i=this.getCustomPanels();if(i.length){var r=i.map(function(t){return t.getPanelId()}),a="/QueryBuilder/SideNavigation/SupportedPanels",n=t.getProperty(a);if(n){n=n.concat(r)}else{n=r}t.setProperty(a,n);if(e){t.setProperty("/QueryBuilder/PanelSettings/StylePanel/ConditionalFormatting",false)}}},_processConfigURI:function(){const t=this.oProgramRunner;return new Promise(t=>{const e=this.getConfigObject();if(e){t(JSON.stringify(e))}else{let e=this.getConfigurationURI();let i=this.getConfigId();let a=false;if(i){if(i==="reviewbooklet-op"){a=true;i="reviewbooklet"}e=sap.ui.require.toUrl("sap/sac/df/fa/configs/"+i+"-config.json")}if(!e){e=sap.ui.require.toUrl("sap/sac/df/fa/configs/sap-ui5-config.json")}const n=new r(e);n.attachRequestCompleted(e=>{const i=e.getSource();this._updateSupportedPanelsConfiguration(i,a);t(JSON.stringify(i.getData()))})}}).then(e=>{if(e){t.setStringArgument(n.AuGdsConstants.PARAM_GDS_CONFIGURATION,e)}})},getUrlParams:function(t){return(window.location.href.split(t+"=")[1]||"").split("&")[0]},log:function(t){if(this.logActive){console.log(this.getId()+": "+t)}},updateStyleTemplate:function(){if(this.program){var t=this.program.getActiveDocument();if(t.getTableView()&&t.getTableView().getTableDefinition()){var e=this.getStyleTemplateName();if(!e){return}var i=t.getTableView().getTableDefinition();if(e===s){if(i.getLinkedDefinition("FA")){i.unlinkDefinition("FA")}}else{var r=this._getMultiDimModel().getStylingProvider().getTemplate(e);if(r.getStyleForDataProvider&&this._getDataProvider()){r=r.getStyleForDataProvider(this._getDataProvider())}var a=n.QFactory.createTableDefinition();a.deserializeFromElementExt(n.QModelFormat.INA_REPOSITORY,new n.NativeJsonProxyElement(r));i.putLinkedDefinition("FA",a)}t.getTableView().reRenderTableStyling()}}}});return l});
//# sourceMappingURL=FlexAnalysis.js.map