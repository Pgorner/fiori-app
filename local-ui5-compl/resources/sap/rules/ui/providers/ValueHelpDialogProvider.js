/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/rules/ui/Constants","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/table/Column","sap/m/Text","sap/ui/core/library","sap/base/i18n/Formatting","sap/ui/core/format/DateFormat","sap/ui/comp/smartfilterbar/SmartFilterBar","sap/ui/model/odata/v2/ODataModel","sap/ui/comp/smartfilterbar/ControlConfiguration","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Label","sap/ui/core/Lib","sap/ui/core/Element"],function(e,t,a,r,l,i,s,o,n,u,d,p,c,h,f,g,v){"use strict";var F={};F._createCpValueHelp=function(e,t,a,r){this.oBundle=v.getResourceBundleFor("sap.rules.ui.i18n");var l=false;var i="";if(e&&e.valueListObject){this.basicMode=true;this.valueHelpMetadata=e.valueListObject.metadata;i=e.expressionLanguage.getModel().sServiceUrl}else{this.advancedMode=true;this.valueHelpMetadata=e.metadata;var o=this.getExpressionTokens();if(o&&o.length>0){l=o[o.length-1].tokenType!=="whitespace"}i=p.getElementById(this.getExpressionLanguage()).getModel().sServiceUrl}this.businessDataType=this.valueHelpMetadata.businessDataType;this.serviceUrl=this.valueHelpMetadata.serviceURL;this.attributeId=this.valueHelpMetadata.attributeId;this.dataObjectId=this.valueHelpMetadata.dataObjectId;this.vocabularyId=this.valueHelpMetadata.vocabularyId;this._updateModal(true);if(this.oDialog){this.oDialog.destroy()}s.BusyIndicator.show(0);this._createDialog(i,e,t,this.businessDataType,l,a,r)};F._createDialog=function(e,t,a,r,l,i,s){this._createValueHelpDialog(e,t,a,r,l,i,s);this._createSmartFilterBar(e,t);this.oValueHelpDialog.setFilterBar(this.oFilterBar);this.oValueHelpDialog.open();this.oValueHelpDialog.getTable().setBusy(true)};F._createValueHelpDialogOLD=function(t,r,s){var o=this;var n=new a(t.results);this.oValueHelpDialog=new ValueHelpDialog({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:o.oBundle.getText("valueHelpTitle"),key:"Name",descriptionKey:"Description",beforeOpen:function(){this.oValueHelpDialog.setModel(n,"valueHelpModel");this.oValueHelpDialog.getTable().addColumn(new l({label:new i({text:o.oBundle.getText("valueHelpKeyColumnHeader")}),template:new i({text:"{valueHelpModel>Value}"})})).addColumn(new l({label:new i({text:o.oBundle.getText("valueHelpDescriptionColumnHeader")}),template:new i({text:"{valueHelpModel>Description}"})})).bindRows({path:"valueHelpModel>/"})},ok:function(t){var a=t.getParameter("tokens")[0].data("row");var r=a.Value;if(s===e.DATE_BUSINESS_TYPE){r=o._formatDate(r)}if(r){o.sKey=r;o.setIntructionToken(r);o.valueHelpCtrl.setValue(r);o.valueHelpCtrl.fireChange()}this.oValueHelpDialog.close();o._updateModal(false);o.focus(o.codeMirror)},cancel:function(){o._updateModal(false);this.oValueHelpDialog.close();o.focus(o.codeMirror)},afterClose:function(){o._updateModal(false);this.oValueHelpDialog.destroy();o.focus(o.codeMirror)}});this.oValueHelpDialog.setModel(n);this.oValueHelpDialog.open()};F._createValueHelpDialog=function(t,a,r,l,i,o,n){var u=this;var d=a.expressionLanguage.getModel();var c="Attributes(Id='"+this.attributeId+"',VocabularyId='"+this.vocabularyId+"',DataObjectId='"+this.dataObjectId+"')";if(c.includes(":")){c=c=c.replace(":","%3A")}this.attributeName=d.oData[c].Name;s.BusyIndicator.show(0);this.oValueHelpDialog=new ValueHelpDialog({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:u.attributeName,resizable:false,beforeOpen:function(){u._bindTable(t,a)},ok:function(t){var a=t.getParameter("tokens")[0].data("row");var s=a.Value;if(l===e.DATE_BUSINESS_TYPE){s=u._formatDate(s)}if(l===e.NUMBER){s=parseInt(s)}if(u.basicMode){var d=p.getElementById("valueHelpCtrl");d.setValue(s);d.fireChange()}else{u.setTextOnCursor(s,r,o,l,i,n)}u._updateModal(false);u.oValueHelpDialog.close();u.focus(u.codeMirror)},cancel:function(){u._updateModal(false);u.oValueHelpDialog.close();u.focus(u.codeMirror)},afterClose:function(){u._updateModal(false);u.oValueHelpDialog.destroy();u.focus(u.codeMirror);u.oFilterBar.destroy();s.BusyIndicator.hide()}})};F.setTextOnCursor=function(e,t,a,r,l,i){function s(e,t){var a=e+1;for(var r=a;r<t.length;r++){if(t[r].length===0){a++}else{break}}return a}var o="String",n="Date",u="Timestamp",d="Time";var c;var h=r===o||r===n||r===u||r===d?"'"+e+"'":e;var f=this.getExpressionTokens();var g=this.getValue().split("\n");var v=-1;var F={start:{line:t.line,ch:t.ch},end:{line:t.line,ch:t.ch}};for(var m=0;m<f.length;m++){v=f[m].start===0?s(v,g):v;if(v===t.line&&f[m].end>t.ch||f[m].end>=t.ch&&i){F.start.ch=f[m].start;F.end.ch=f[m].end;a=true;break}}if(a){this.codeMirror.replaceRange(h,F.start,F.end);c=this.codeMirror.findPosH(F.start,h.length,"char",true);this.codeMirror.setCursor(c)}else{h=l?" "+h:h;this.codeMirror.replaceRange(h,t);c=this.codeMirror.findPosH(t,h.length,"char",true);this.codeMirror.setCursor(c)}var b=p.getElementById(this.getExpressionLanguage());this.getFormattingTokens(b);this.ValueHelpRequested=false};F.focus=function(){if(this.codeMirror){var e=this.codeMirror.getLine(this.codeMirror.lastLine());var t=e.length;this.codeMirror.setCursor({line:this.codeMirror.lastLine(),ch:t});this.codeMirror.focus()}};F._updateModal=function(e){var t=p.getElementById("popover");if(t){t.setModal(e)}};F._formatDate=function(e){var a=o.getLanguageTag();var r=t.getInstance(a);this.oFormatDate=n.getInstance({pattern:r.getDatePattern("short"),calendarType:s.CalendarType.Gregorian},a);return this.oFormatDate.format(this.oFormatDate.parse(e))};F._createSmartFilterBar=function(e,t){var a=this;if(this.basicMode){this.entitySet=t.valueListObject.metadata.entitySet;t=t.valueListObject}else{this.entitySet=t.metadata.entitySet}this.oFilterBar=new u({entitySet:a.entitySet,enableBasicSearch:true,advancedMode:true,filterBarExpanded:true,search:function(){a.onSearch(e,t)},filterChange:function(e){a.setValueStateFilter(e)},controlConfiguration:[a._createControlConfiguration()]});var r=new d(e);this.oFilterBar.setModel(r)};F._createControlConfiguration=function(){var e=[new c({hasValueHelpDialog:true,key:"Value",label:"Value",visibleInAdvancedArea:true,width:"100px",index:1}),new c({hasValueHelpDialog:true,key:"Description",label:"Description",visibleInAdvancedArea:true,width:"100px",index:2}),new c({hasValueHelpDialog:true,key:"VocabularyId",label:"VocabularyId",width:"100px",visible:false,index:3}),new c({hasValueHelpDialog:true,key:"DataObjectId",label:"DataObjectId",visible:false,width:"100px",groupId:"abc",index:4}),new c({hasValueHelpDialog:true,key:"AttributeId",label:"AttributeId",visible:false,width:"100px",index:5}),new c({hasValueHelpDialog:true,key:"Version",label:"Version",visible:false,width:"100px",index:6})];return e};F.onSearch=function(e,t){this.oValueHelpDialog.getTable().setBusy(true);this._unBindTable();this._bindTable(e,t)};F._bindTable=function(t,a){var r=this.serviceUrl;var l=this._fetchFilterParams(a);var i={valueHelp:{collection:r,properties:[e.PROPERTY_VALUE,e.PROPERTY_DESCRIPTION]}};var s=this.oValueHelpDialog.getTable();s.setThreshold(10);for(var o=0;o<i.valueHelp.properties.length;o++){this._addValueHelpColumn(i.valueHelp.properties[o],s)}var n=new d(t);s.setModel(n);s.bindRows(i.valueHelp.collection,null,l);s.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this)};F._handleRowsDataReceived=function(e){var t=this;var a=e.getParameter("data");if(jQuery.isEmptyObject(a)||a&&a.results&&a.results.length===0){this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("no_data"))}else{this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("searching"))}this.oValueHelpDialog.getTable().setBusy(false)};F._addValueHelpColumn=function(t,a){var r=(new l).setLabel(new g({text:t}));if(t===e.PROPERTY_VALUE){r.setSortProperty(t)}a.addColumn(r.setTemplate((new i).bindProperty("text",t)))};F._unBindTable=function(){var e=this.oValueHelpDialog.getTable();e.destroyColumns();e.unbindRows()};F._fetchFilterParams=function(e){var t=this;var a=[];var r=[new h("AttributeId",f.EQ,this.attributeId),new h("DataObjectId",f.EQ,this.dataObjectId),new h("VocabularyId",f.EQ,this.vocabularyId)];var l=this.oFilterBar.getFilters();var i=this.oFilterBar.getParameters();if(!jQuery.isEmptyObject(i)&&l&&l.length>0){i=this.oFilterBar.getParameters().custom.search;a=this._getSearchFilters(i);l=t._formatFilterParams(l);r.push(new h({filters:[new h(l),new h(a)],and:true}))}else if(!jQuery.isEmptyObject(i)){i=this.oFilterBar.getParameters().custom.search;a=this._getSearchFilters(i);r.push(a)}else if(l&&l.length>0){l=t._formatFilterParams(l);r.push(l[0])}return r};F._formatFilterParams=function(e){var t=this;if(e[0]&&e.length===1&&e[0].aFilters[0]&&e[0].aFilters[0].sOperator){e=t._formatSingleFilter(e)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=t._formatMultiFilter(e,0,true);e=t._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=t._formatMultiFilter(e,0,true);e=t._formatMultiFilter(e,1,false)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[1].aFilters[0]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=t._formatMultiFilter(e,0,false);e=t._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=t._formatMultiFilter(e,0,false);e=t._formatMultiFilter(e,1,false)}return e};F._formatSingleFilter=function(t){var a=this;var r=null;for(var l=0;l<t[0].aFilters.length;l++){if(t[0].aFilters[l].sOperator==="Contains"){t[0].aFilters[l].sOperator="EQ"}else if(t[0].aFilters[l].sOperator==="BT"){var i=a._manageParam(t[0].aFilters[l].sPath,t[0].aFilters[l].sOperator,t[0].aFilters[l].oValue1,t[0].aFilters[l].oValue2);delete t[0].aFilters[l];t[0].aFilters[l]=i}else if(t[0].aFilters[l].sOperator==="StartsWith"){r=t[0].aFilters[l].sPath===e.PROPERTY_VALUE?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(t[0].aFilters[l].sOperator+" operator not supported")}else if(t[0].aFilters[l].sOperator==="EndsWith"){r=t[0].aFilters[l].sPath===e.PROPERTY_VALUE?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(t[0].aFilters[l].sOperator+" operator not supported")}}return t};F._formatMultiFilter=function(t,a,r){var l=this;var i=null;var s=[];if(r){s=t[0].aFilters[a].aFilters[0].aFilters}else{s=t[0].aFilters[a].aFilters}for(var o=0;o<s.length;o++){if(s[o].sOperator==="Contains"){s[o].sOperator="EQ"}else if(s[o].sOperator==="BT"){var n=l._manageParam(s[o].sPath,s[o].sOperator,s[o].oValue1,s[o].oValue2);delete s[o];s[o]=n}else if(s[o].sOperator==="StartsWith"){i=s[o].sPath===e.PROPERTY_VALUE?this._valueFieldValue:this._valueFieldDescription;i.setValueState("Error");i.setValueStateText(s[o].sOperator+" operator not supported")}else if(s[o].sOperator==="EndsWith"){i=s[o].sPath===e.PROPERTY_VALUE?this._valueFieldValue:this._valueFieldDescription;i.setValueState("Error");i.setValueStateText(s[o].sOperator+" operator not supported")}}return t};F._manageParam=function(e,t,a,r){var l=[];if(a&&r){l=new h({filters:[new h(e,f.GT,a),new h(e,f.LT,r)],and:true})}return l};F._getSearchFilters=function(t){return new h({filters:[new h(e.PROPERTY_VALUE,f.EQ,t),new h(e.PROPERTY_DESCRIPTION,f.EQ,t)],and:false})};F.setValueStateFilter=function(e){var t=e.getSource().sId;this._valueFieldValue=p.getElementById(t+"-filterItemControlA_-Value");if(this._valueFieldValue){this._valueFieldValue.setValueState("None");this._valueFieldValue.setValueStateText("")}this._valueFieldDescription=p.getElementById(t+"-filterItemControlA_-Description");if(this._valueFieldDescription){this._valueFieldDescription.setValueState("None");this._valueFieldDescription.setValueStateText("")}};return F},true);
//# sourceMappingURL=ValueHelpDialogProvider.js.map