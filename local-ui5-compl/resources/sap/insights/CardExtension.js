/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 * This extension is for OVP Analytical cards delivered in 2208.
 */
sap.ui.define(["sap/ui/integration/Extension","sap/ui/core/format/NumberFormat","sap/fe/navigation/SelectionVariant","sap/base/Log","sap/ui/core/format/DateFormat","sap/ui/core/library","sap/m/library","sap/ui/integration/util/Utils","sap/m/DynamicDateUtil","sap/fe/navigation/NavError","sap/insights/utils/UrlGenerateHelper","sap/insights/utils/AppConstants","sap/ui/core/date/UI5Date","sap/ui/core/Lib"],function(e,t,r,a,i,n,s,o,l,f,u,c,m,g){"use strict";var p=n.ValueState;var v=s.ValueColor;var d={StateValues:{None:"None",Negative:"Error",Critical:"Warning",Positive:"Success"},ColorValues:{None:"Neutral",Negative:"Error",Critical:"Critical",Positive:"Good"}};var h=a.getLogger("sap.insights.CardExtension");var b=function(e,t){return e&&e.indexOf(t,e.length-t.length)!==-1};var S=function(e,t){var r;if(t){r=t.None;if(e&&e.EnumMember){var a=e.EnumMember;if(b(a,"Negative")){r=t.Negative}else if(b(a,"Critical")){r=t.Critical}else if(b(a,"Positive")){r=t.Positive}}}return r};var N=function(e,t,r,a,i,n,s){var o={};o.EnumMember="None";var l=Number.NEGATIVE_INFINITY;var f=Number.POSITIVE_INFINITY;if(!i&&i!==0&&(r||r===0)){i=r}if(!n&&n!==0&&(a||a===0)){n=a}if(!r&&r!==0){r=l}if(!a&&a!==0){a=f}if(e!==undefined){e=Number(e);if(b(t,"Minimize")||b(t,"Minimizing")){if((n||n===0)&&(a||a===0)){if(e<=parseFloat(n)){o.EnumMember="Positive"}else if(e>parseFloat(a)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}else if(b(t,"Maximize")||b(t,"Maximizing")){if((i||i===0)&&(r||r===0)){if(e>=parseFloat(i)){o.EnumMember="Positive"}else if(e<parseFloat(r)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}else if(b(t,"Target")){if((n||n===0)&&(a||a===0)&&(i||i===0)&&(r||r===0)){if(e>=parseFloat(i)&&e<=parseFloat(n)){o.EnumMember="Positive"}else if(e<parseFloat(r)||e>parseFloat(a)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}}return S(o,s)};var O=function(e,t,r,a){if(!e||!t){return}e=Number(e);if(!a&&e-t>=0){return"Up"}if(!r&&e-t<=0){return"Down"}if(t&&a&&e-t>=a){return"Up"}if(t&&r&&e-t<=r){return"Down"}};var P=function(e,r,a){var i=r||{},n=e;var s=t.getFloatInstance({minFractionDigits:i.NumberOfFractionalDigits,maxFractionDigits:i.NumberOfFractionalDigits,style:"short",showScale:true,shortRefNumber:n});var o=s.format(Number(n)),l=s.getScale()||"";if(!a&&o){var f=o[o.length-1];return f===l?o.slice(0,o.length-1):o}if(a&&i.percentageAvailable){return l+"%"}if(a&&!i.percentageAvailable){return l}return""};var y=function(){var e=this.getCard().getCombinedParameters();return e._headerDataUrl};var D=function(){var e=this.getCard().getCombinedParameters();return e._contentDataUrl};var I=function(e,r,a){var i,n,s;if(isNaN(+e)){return""}if(e==0){s=r}else{s=e}if(a.NumberOfFractionalDigits){n=+a.NumberOfFractionalDigits}if(r){i=r}else if(a.manifestTarget){i=a.manifestTarget}if(!n||n<0){n=0}else if(n>2){n=2}if(i){var o=t.getFloatInstance({minFractionDigits:n,maxFractionDigits:n,style:"short",showScale:true,shortRefNumber:s});return o.format(+i)}};var C=function(e,r,a){var i,n;if(isNaN(+e)){return""}e=+e;if(a.NumberOfFractionalDigits){i=+a.NumberOfFractionalDigits}if(r){n=+r}else if(a.manifestTarget){n=+a.manifestTarget}if(!i||i<0){i=0}else if(i>2){i=2}if(n){var s=(e-n)/n;var o=t.getPercentInstance({style:"short",minFractionDigits:i,maxFractionDigits:i,showScale:true});return o.format(s)}};var F=function(e){var t={};t.EnumMember="None";if(Number(e)===1){t.EnumMember="Negative"}else if(Number(e)===2){t.EnumMember="Critical"}else if(Number(e)===3){t.EnumMember="Positive"}return S(t,d.ColorValues)};var w=function(){var e=arguments[arguments.length-1];var t=1;return N(arguments[0],e.sImprovementDirection,e.bIsDeviationLowBinding?arguments[t++]:e.deviationLow,e.bIsDeviationHighBinding?arguments[t++]:e.deviationHigh,e.bIsToleranceLowBinding?arguments[t++]:e.toleranceLow,e.bIsToleranceHighBinding?arguments[t++]:e.toleranceHigh,e.oCriticalityConfigValues)};var E=function(){var e=arguments[arguments.length-1];var t=1;return O(arguments[0],e.bIsRefValBinding?arguments[t++]:e.referenceValue,e.bIsDownDiffBinding?arguments[t++]:e.downDifference,e.bIsUpDiffBinding?arguments[t++]:e.upDifference)};var V=function(e){var t;var r=arguments[arguments.length-1],a=r&&r.propertyType;switch(a){case"yearmonth":var i=parseInt(e.substr(0,4),10),n=e.substr(4),s=parseInt(n,10)-1;t=m.getInstance(Date.UTC(i,s));break;case"yearquarter":var i=parseInt(e.substr(0,4),10),o=e.substr(4),l=parseInt(o,10)*3-2,s=l-1;t=m.getInstance(Date.UTC(i,s));break;case"yearweek":var i=parseInt(e.substr(0,4),10),f=e.substr(4),u=1+(parseInt(f,10)-1)*7;t=m.getInstance(Date.UTC(i,0,u));break;default:break}return t};var M=function(e,t){if(e){var r=o.parseJsonDateTime(e);return i.getInstance(t).format(m.getInstance(r),t.bUTC)}};var T=function(e){if(e){var r=t.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});return r.format(Number(e))}};var x=function(){var e=arguments[0],r=arguments[1],a=Number(arguments[2]),i=arguments[3];var n=t.getCurrencyInstance({style:"short",showMeasure:true,shortRefNumber:e.scaleFactor,minFractionDigits:e.numberOfFractionalDigits,maxFractionDigits:e.numberOfFractionalDigits});var s=n.format(a,i);if(!r){return s}else{var o=arguments[arguments.length-1];return s+" ("+o+")"}};var U=function(e,r,a,i,n){var s;if(e){e.maxFractionDigits=e.numberOfFractionalDigits||0;e.minFractionDigits=e.numberOfFractionalDigits||0;e.style=e.style||"short";e.showScale=e.showScale||true;e.shortRefNumber=e.scaleFactor;s=t.getFloatInstance(e)}var o=[];if(!isNaN(parseFloat(a))&&s){o.push(s.format(a))}else{o.push(a)}if(!isNaN(parseFloat(i))&&s){o.push(s.format(i))}else{o.push(i)}if(!isNaN(parseFloat(n))&&s){o.push(s.format(n))}else{o.push(n)}var l="";if(r&&r.length){r.forEach(function(e){if(typeof e==="number"){l=l+o[e]}else{l=l+e}})}return l};var A=function(e,t){if(t==="state"){switch(String(e)){case"1":case"Error":return p.Error;case"2":case"Warning":return p.Warning;case"3":case"Success":return p.Success;default:return p.None}}if(t==="color"){switch(String(e)){case"1":case"Error":return v.Error;case"2":case"Critical":return v.Critical;case"3":case"Good":return v.Good;default:return v.Neutral}}};var H=function(e,t,r){var a;if(r&&r.indexOf("sap.ui.model.odata.v4.ODataModel")>-1){a=this.getCard().getModel().getProperty("/content/value")||this.getCard().getModel().getProperty("/value")||[]}else{a=this.getCard().getModel().getProperty("/content/d/results")||this.getCard().getModel().getProperty("/d/results")||[]}var i=a.map(function(t){return t[e]});if(i.indexOf("0")===-1){i.push(0)}return Math[t].apply(Math,i)};var L=function(e,t,r){var a=1;var i=2;var n=4;for(var s in e){if(e.hasOwnProperty(s)){var o=e[s];if(o instanceof Date){o=o.toJSON()}else if(Array.isArray(o)||o&&typeof o==="object"){o=JSON.stringify(o)}else if(typeof o==="number"||typeof o==="boolean"){o=o.toString()}if(o===""){if(r&a){h.info("Semantic attribute "+s+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue}}if(o===null){if(r&i){throw new h.error("NavigationHandler.INVALID_INPUT")}else{h.warning("Semantic attribute "+s+" is null and ignored for mix in to selection variant");continue}}if(o===undefined){if(r&n){throw new h.error("NavigationHandler.INVALID_INPUT")}else{h.warning("Semantic attribute "+s+" is undefined and ignored for mix in to selection variant");continue}}if(typeof o==="string"||o instanceof String){t.addSelectOption(s,"I","EQ",o)}else{throw new h.error("NavigationHandler.INVALID_INPUT")}}}return t};var J=function(e,t,a){var i=new r(t);var n=new r;if(i.getFilterContextUrl()){n.setFilterContextUrl(i.getFilterContextUrl())}if(i.getParameterContextUrl()){n.setParameterContextUrl(i.getParameterContextUrl())}if(Array.isArray(e)){e.forEach(function(e){L(e,n,a)})}else{L(e,n,a)}var s=i.getParameterNames();var o;for(o=0;o<s.length;o++){if(!n.getSelectOption(s[o])){n.addSelectOption(s[o],"I","EQ",i.getParameter(s[o]))}}var l=i.getSelectOptionsPropertyNames();for(o=0;o<l.length;o++){var f=i.getSelectOption(l[o]);if(!n.getSelectOption(l[o])){for(var u=0;u<f.length;u++){n.addSelectOption(l[o],f[u].Sign,f[u].Option,f[u].Low,f[u].High)}}}return n};function _(e){if(e){if(e.hasOwnProperty("SelectionVariantID")){delete e.SelectionVariantID}else if(e.hasOwnProperty("PresentationVariantID")){delete e.PresentationVariantID}delete e.Text;delete e.ODataFilterExpression;delete e.Version;delete e.FilterContextUrl;delete e.ParameterContextUrl;return e}return e}var k=function(e){try{if(JSON.parse(e)){return true}}catch(e){return false}};var B=function(e){var t=e&&e.length===1,r=e&&e[0];return t&&r["Option"]==="EQ"&&!r["High"]&&r["Low"]&&r["Sign"]==="I"};function R(e,t){var a=this.getCard().getManifestEntry("sap.card"),i=a&&a.configuration.parameters,n=new r,s=i._relevantODataFilters.value||[];e=e&&JSON.parse(e);var o=e&&e.sensitiveProps,l=a&&a.header.actions[0].parameters.ibnParams,f=a&&a.content.actions[0].parameters.ibnParams;s.forEach(function(e){var t=k(i[e].value);if(t&&!(o&&o[e])){var r=JSON.parse(i[e].value);var a=r.SelectOptions.Ranges;if(a&&a.length){var s=B(a);if(l[e]&&f[e]){if(s){l[e]=a[0].Low;f[e]=a[0].Low}else if(!s){delete f[e];delete l[e];n.massAddSelectOption(e,a)}}else{n.massAddSelectOption(e,a)}}}});if(t){var u=Object.keys(t)||[];for(var c=0;c<u.length;c++){if(o&&o[u[c]]||u[c]==="__metadata"){delete t[u[c]]}}var m=J(t,n&&n.toJSONObject());m=_(m.toJSONObject());e.selectionVariant=m}if(e&&e.sensitiveProps){delete e.sensitiveProps}return JSON.stringify(e)}var j=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS'Z'''",calendarType:"Gregorian"});if(e){var r=t.format(e,true);return String(r).replace(/'/g,"")}};var G=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS''",calendarType:"Gregorian"});var r=e instanceof Date?e:m.getInstance(e);var a=t.format(r);return String(a).replace(/'/g,"")};function Q(e,t,r,a,i,n){var s=l.toDates(e)||[];var o=s[0]&&s[0].oDate;var f=s[1]&&s[1].oDate;var u="",c="";if(a["sap:filter-restriction"]==="single-value"){if(t==="datetime"){u=G(o);if(u&&n&&n.ibnParams){n.ibnParams[r]=u}}else if(t==="string"){u=j(o);if(u&&n&&n.ibnParams){n.ibnParams[r]=u}}i.massAddSelectOption(r,[{Sign:"I",Option:"EQ",Low:u,High:null}])}else if(a["sap:filter-restriction"]==="interval"){if(t==="datetime"){u=G(o);c=G(f);if(u&&c){i.massAddSelectOption(r,[{Sign:"I",Option:"BT",Low:u,High:c}])}}else if(t==="string"){u=j(o);c=j(f);if(u&&c){i.massAddSelectOption(r,[{Sign:"I",Option:"BT",Low:u,High:c}])}}}}function q(e){var t={};var a;if(typeof e==="string"){a=new r(e)}else if(typeof e==="object"){a=e}else{throw new f("NavigationHandler.INVALID_INPUT")}var i=a.getSelectOptionsPropertyNames();for(var n=0;n<i.length;n++){var s=a.getSelectOption(i[n]);if(s.length===1&&s[0].Sign==="I"&&s[0].Option==="EQ"){t[i[n]]=s[0].Low}}var o=a.getParameterNames();for(var n=0;n<o.length;n++){var l=a.getParameter(o[n]);t[o[n]]=l}return t}function z(e,t){var a=this.getCard().getManifestEntry("sap.card"),i=a&&a.configuration.parameters,n=new r,s=i._relevantODataFilters.value||[],o=e&&JSON.parse(e)||{},l=o&&o.parameters,f=l&&l.ibnParams,u=f&&f.sensitiveProps,m=o&&o.sensitiveProps,g=i._semanticDateRangeSetting,p,v=[];if(g){p=JSON.parse(g.value);v=Object.keys(p)||[]}var d={};if(v.length){v.forEach(function(e){var t=i[e]||{};var r=k(t.value)?JSON.parse(t.value):t.value;var a=t.type;var s="";var l=t.description&&JSON.parse(t.description),f=l&&l.operator,g=u&&u[e]||m&&m.includes(e);if(c.DATE_OPTIONS.DATE_LIST.includes(f)&&!g){var v=r&&r.SelectOptions&&r.SelectOptions[0]&&r.SelectOptions[0].Ranges;if(v&&v.length){n.massAddSelectOption(e,v)}else{if(a==="datetime"){s=G(r)}else if(a==="string"){s=r.toString()}n.massAddSelectOption(e,[{Sign:"I",Option:"EQ",Low:s,High:null}])}}else if(f&&!g){Q(l,a,e,p[e],n,o)}})}i._relevantODataParameters.value.forEach(function(e){var t=u&&u[e]||m&&m.includes(e);if(i[e]&&i[e].value&&!v.includes(e)&&!t){if(f){f[e]=i[e].value}else if(o&&o.ibnParams){o.ibnParams[e]=i[e].value}n.massAddSelectOption(e,[{Sign:"I",Option:"EQ",Low:i[e].value,High:null}])}});s.forEach(function(e){var t=k(i[e].value);if(t&&v.indexOf(e)===-1&&(u&&!u[e]||m&&!m.includes(e))){var r=JSON.parse(i[e].value);var a=r.SelectOptions&&r.SelectOptions.Ranges||r.SelectOptions&&r.SelectOptions[0]&&r.SelectOptions[0].Ranges;if(a&&a.length){var s=B(a);if(s){if(f){f[e]=a[0].Low}else if(o&&o.ibnParams){o.ibnParams[e]=a[0].Low}}else{if(f&&f[e]&&!s){delete f[e]}}n.massAddSelectOption(e,a)}}});var h=t||{};var b=Object.keys(h)||[];for(var S=0;S<b.length;S++){if(u&&u[b[S]]||m&&m.includes(b[S])||b[S]==="__metadata"){delete h[b[S]]}}var N=J(h,n&&n.toJSONObject());var O=q(N);N=_(N.toJSONObject());if(f&&f.presentationVariant){d["presentationVariant"]=f.presentationVariant}else if(o&&o.ibnParams&&o.ibnParams.presentationVariant){d["presentationVariant"]=o.ibnParams.presentationVariant}if(N.Parameters.length||N.SelectOptions.length){d["selectionVariant"]=N}if(l&&!l.ibnParams){l.ibnParams={}}if(d["selectionVariant"]||d["presentationVariant"]){if(l&&l.ibnParams){l.ibnParams["sap-xapp-state-data"]=JSON.stringify(d)}else if(o&&o.ibnParams){o.ibnParams["sap-xapp-state-data"]=JSON.stringify(d)}}if(f&&f.sensitiveProps){delete f.sensitiveProps}if(o&&o.sensitiveProps){delete o.sensitiveProps}for(var P in O){if(l&&l.ibnParams){l.ibnParams[P]=O[P]}else if(o&&o.ibnParams){o.ibnParams[P]=O[P]}}if(f){delete f.selectionVariant;delete f.presentationVariant}if(o&&o.ibnParams&&o.ibnParams.presentationVariant){delete o.ibnParams.presentationVariant}return o.parameters?o.parameters:o}function W(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=Z(e,"header");return t}function Y(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=e.descriptorContent["sap.card"]["configuration"]["csrfTokens"]["token1"].data.request.url;var r=Z(e,"content");if(e.descriptorContent["sap.card"]["data"]["request"]&&e.descriptorContent["sap.card"]["data"]["request"]["batch"]){return r}return t+"/"+r}function Z(e,t){var r=u.processPrivateParams(e,null,true);if(t==="header"&&r.header){return r.header}else if(t==="content"&&r.content){return r.content}}function K(){var e=window["sap-ushell-config"],t=e&&e.ushell,r=t&&t.homeApp;return!!r}var X=e.extend("sap.insights.CardExtension",{init:function(){e.prototype.init.apply(this,arguments);e.prototype.setFormatters.apply(this,[{kpiformatter:P,formatHeaderUrl:y.bind(this),formatContentUrl:D.bind(this),returnPercentageChange:C,targetValueFormatter:I,kpiValueCriticality:F,formatValueColor:w,formatTrendIcon:E,formatDateValue:V,addPropertyValueToAppState:R.bind(this),getNavigationContext:z.bind(this),formatDate:M,formatNumber:U,formatCurrency:x,formatHeaderCount:T,formatCriticality:A,getMinMax:H.bind(this),formatHeaderDataUrlForSemanticDate:W.bind(this),formatContentDataUrlForSemanticDate:Y.bind(this)}])},loadDependencies:function(){var e=this.getCard(),t=e.getManifestEntry("/sap.card/type"),r=[];if(!K()){r.push(new Promise(function(e){sap.ui.require(["sap/insights/HandleNonS4Environment"],function(t){t.initialize(this);e()}.bind(this))}.bind(this)))}if(t==="Analytical"){r.push(g.load({name:"sap.viz"}).then(function(){return new Promise(function(e){sap.ui.require(["sap/insights/OVPChartFormatter"],function(t){t.registerCustomFormatters();e()})})}))}return Promise.all(r)}});X.prototype.addFormatters=function(e,t){if(!e||e===""){a.error("Namespace missing.");return this}var r=this.getProperty("formatters");r[e]=t;return this.setFormatters(r)};X.prototype.setFormatters=function(){a.error("Use of setFormatters is prohibited, instead use addFormatters method.");return this};return X});
//# sourceMappingURL=CardExtension.js.map