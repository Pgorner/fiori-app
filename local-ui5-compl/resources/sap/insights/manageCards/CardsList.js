/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/core/Control","sap/ui/core/Icon","sap/ui/core/dnd/DragDropInfo","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/resource/ResourceModel","sap/ui/integration/widgets/Card","sap/m/MessageStrip","sap/m/FlexBox","sap/m/HBox","sap/m/VBox","sap/m/Text","sap/m/Button","sap/m/ToggleButton","sap/m/Title","sap/m/SearchField","sap/m/ScrollContainer","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/CheckBox","sap/m/Link","sap/m/MessageBox","sap/m/FormattedText","sap/m/MessageToast","sap/m/Popover","sap/m/Page","sap/m/Label","sap/m/Switch","../CardHelper","../utils/CardRanking","../base/InMemoryCachingHost","sap/m/IllustratedMessage","sap/ui/model/BindingMode","../utils/CardPreviewManager","../utils/DeviceType","../utils/AppConstants","sap/ui/performance/trace/FESRHelper","../utils/CardDndConfig","../utils/InsightsUtils"],function(e,t,i,s,a,r,n,o,l,d,h,g,p,u,c,C,f,m,x,b,y,B,v,T,w,I,_,S,P,M,V,F,A,H,L,R,D,E,k,N,W,U){"use strict";var O=e.getLogger("sap.insights.manageCards.CardsList");var j;var z;var K=i.extend("sap.insights.manageCards.CardsList",{metadata:{properties:{enableResetAllCards:{type:"boolean",group:"Behavior",defaultValue:false},_count:{type:"int",group:"Appearance",defaultValue:0},_visibleCount:{type:"int",group:"Appearance",defaultValue:0},_dtCards:{type:"array",group:"Appearance",defaultValue:[]}},aggregations:{_page:{type:"sap.m.Page",multiple:false,visibility:"hidden"}},events:{listPress:{allowPreventDefault:true,parameters:{manifest:"string",listRefresh:"array"}}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.style("height","100%");e.style("width","100%");e.openEnd();e.renderControl(t.getAggregation("_page"));e.close("div");return}}});K.prototype.init=function(){this._oWrapperFlexBox=new h(this.getId()+"--flexContainerCardsContent",{alignItems:"Start",justifyContent:"Start",height:"100%",width:"100%",direction:"Column",busy:"{/isLoading}"}).addStyleClass("flexContainerCards");this.i18Bundle=new o({bundle:U.getResourceBundle()}).getResourceBundle();var e=new P(this.getId()+"--insightCardPage",{title:this.i18Bundle.getText("insightsCards"),showHeader:true,backgroundDesign:"List",enableScrolling:false,content:this._oWrapperFlexBox,titleLevel:"H3"});this.setAggregation("_page",e);this.host=new H("CardListHost")};K.prototype._handleModelChange=function(){if(this.getModel()){var e=this.getModel().getProperty("/cards");if(e.length>0){this._setHeaderStaticControls();this._setProperties();this._createTableContent();if(this.oNoCardVBox){this.oNoCardVBox.setVisible(false)}}else{this._createNoCardContent()}}};K.prototype._setHeaderStaticControls=function(){if(!this.oMessageStrip){this.oMessageStrip=new d(this.getId()+"--insightMaxCardMsg",{text:this.i18Bundle.getText("insightMaxCardText"),type:"Warning",showIcon:true});this.oTextMessage=new u(this.getId()+"--insightCardText",{text:this.i18Bundle.getText("insightCardTabText"),textAlign:"Begin",width:"100%"}).addStyleClass("sapUiSmallMarginTop");this.oMessageVBox=new p(this.getId()+"--insightCardMessageVBox",{alignItems:"Start",width:"calc(100% - 2rem)",items:[this.oMessageStrip,this.oTextMessage]}).addStyleClass("sapUiSmallMarginTop sapUiSmallMarginBegin");this.oCardListHeaderHBox=new g(this.getId()+"--insightCardListHeaderVBox",{width:"calc(100% - 2rem)",alignItems:"Center"}).addStyleClass("sapUiSmallMarginTop sapUiSmallMarginBegin insightsCardTitleFlex");this.oCardCountTitle=new f(this.getId()+"--availableInsightsCardsTitle",{titleStyle:"H4"});this.oCardListHeaderHBox.addItem(this.oCardCountTitle);var e=new g(this.getId()+"--insightCardSearchHBox",{width:"100%",justifyContent:"End"});var t=new g(this.getId()+"--insightCardVisFilterHBox",{width:"50%",alignItems:"Center",justifyContent:"End"});t.addItem(new M(this.getId()+"--showVisibleOnlyLabel",{text:this.i18Bundle.getText("cardsVisibleFilter")}));this._oVisibleFilterSwitch=new V(this.getId()+"--insightCardSwitchBtn",{customTextOn:" ",customTextOff:" ",ariaLabelledBy:[this.getId()+"--availableInsightsCardsTitle",this.getId()+"--showVisibleOnlyLabel"],change:this._handleVisibleFilterChange.bind(this)});N.setSemanticStepname(this._oVisibleFilterSwitch,"change","visibleFilterSwitch");t.addItem(this._oVisibleFilterSwitch);e.addItem(t);this._oSearchField=new m(this.getId()+"--insightCardSearch",{liveChange:this._onCardSearch.bind(this),width:"100%"});e.addItem(this._oSearchField);this.oCardListHeaderHBox.addItem(e);this._oWrapperFlexBox.addItem(this.oMessageVBox);this._oWrapperFlexBox.addItem(this.oCardListHeaderHBox)}else{this.oMessageVBox.setVisible(true);this.oCardListHeaderHBox.setVisible(true)}};K.prototype._applyFilters=function(e,t){var i;var s=[];if(t){i=new r("visibility",n.EQ,true);s.push(i)}if(this._oSearchField.getValue()){i=new r("descriptorContent/sap.card/header/title",n.Contains,e);s.push(i)}var a=this._oTable.getBinding("items");a.filter(s,"Application")};K.prototype._handleVisibleFilterChange=function(e){var t=e.getSource().getState();this._applyFilters(this._oSearchField.getValue(),t)};K.prototype._createResetBox=function(){if(!this.oRefreshHBox){this.oRefreshHBox=new g(this.getId()+"--insightCardMessageHBox",{alignItems:"Center"});this.oRefreshHBox.addItem(new u(this.getId()+"--insightsRefreshText",{text:this.i18Bundle.getText("refreshText")}));this.oRefreshBtn=new c(this.getId()+"--insightsRefreshIcon",{tooltip:this.i18Bundle.getText("refresh"),icon:"sap-icon://refresh",type:"Transparent",press:this._refreshCardList.bind(this),ariaLabelledBy:[this.getId()+"--insightsRefreshText"]});this.oRefreshHBox.addItem(this.oRefreshBtn);N.setSemanticStepname(this.oRefreshBtn,"press","refreshCards");this.oMessageVBox.addItem(this.oRefreshHBox)}else{this.oRefreshHBox.setVisible(true)}};K.prototype._setProperties=function(){var e=this.getModel().getProperty("/cards");this.setProperty("_count",e.length);var t=e.filter(function(e){return e.descriptorContent["sap.insights"].isDtCardCopy});this.setProperty("_dtCards",t);var i=e.filter(function(e){return e.visibility});this.setProperty("_visibleCount",i.length);this.bEnableResetAll=this.getEnableResetAllCards();if(this.getProperty("_visibleCount")>9){this.oMessageStrip.setVisible(true);this.oTextMessage.setVisible(false)}else{this.oTextMessage.setVisible(true);this.oMessageStrip.setVisible(false)}this.oCardCountTitle.addStyleClass("editInsightsTitleFontSize");this.oCardCountTitle.setText(this.i18Bundle.getText("availableCards")+" ("+this.getProperty("_visibleCount")+"/"+this.getProperty("_count")+")");if(this.bEnableResetAll||this.getProperty("_dtCards").length>0){this._createResetBox()}else if(this.oRefreshHBox){this.oRefreshHBox.setVisible(false)}if(this._oTable){this._oTable.updateAggregation("items")}};K.prototype._createNoCardContent=function(){if(!this.oNoCardVBox){var e=new L(this.getId()+"--editInsightNoInsightsCardsMsg",{illustrationSize:"Auto",illustrationType:"sapIllus-SimpleEmptyList",title:this.i18Bundle.getText("editInsightsEmptyCardTitle"),description:this.i18Bundle.getText("editInsightsEmptyCardSubTitle")}).addStyleClass("sapFIllustratedMessageAlign sapFFrequentIllustratedMessageAlign sapUiMargin-24Top");var t=new x(this.getId()+"--idNoCardCardsScrollContainer",{vertical:true,horizontal:false,height:"100%",width:"100%",content:[e]});this.oNoCardVBox=new p(this.getId()+"--idNoCardVBox",{height:"100%",width:"100%",items:[t]});this._oWrapperFlexBox.addItem(this.oNoCardVBox)}else{this.oNoCardVBox.setVisible(true)}if(this.oCardListHeaderHBox){this.oCardListHeaderHBox.setVisible(false)}if(this.oMessageVBox){this.oMessageVBox.setVisible(false)}if(this.oTableFlexBox){this.oTableFlexBox.setVisible(false)}};K.prototype._handleTableItemsChange=function(e){if(e&&e.getParameters()&&e.getParameters().reason!=="filter"){this._handleModelChange()}};K.prototype._createTableContent=function(){if(!this.oTableFlexBox){this.oTableFlexBox=new h(this.getId()+"--editInsightsCardsFlex",{alignItems:"Start",justifyContent:"Start",height:"100%",width:"calc(100% - 2rem)",direction:"Row"}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginTop flexContainerCards");this.oTableVBox=new p(this.getId()+"--insightsCardsVBox",{height:"100%",width:"100%",justifyContent:"Start",direction:"Column"});this.oScrollContainer=new x(this.getId()+"--idCardsScrollContainer",{vertical:true,horizontal:false,height:"100%",width:"100%",content:this._createTable()});this.oTableVBox.addItem(this.oScrollContainer);this.oTableFlexBox.addItem(this.oTableVBox);this._oWrapperFlexBox.addItem(this.oTableFlexBox);this._oTable.getBinding("items").attachChange(this._handleTableItemsChange.bind(this))}else{this.oTableFlexBox.setVisible(true)}};K.prototype._onCardSearch=function(e,t){var i=e?e.getSource().getValue():t;this._applyFilters(i,this._oVisibleFilterSwitch.getState())};K.prototype._createTable=function(){if(!this._oTable){this._oTable=new b(this.getId()+"--insightsCardsListTable",{ariaLabelledBy:"availableInsightsCardsTitle",columns:[new y(this.getId()+"--idTableDnDIconColumn",{hAlign:"Center",width:"5%"}),new y(this.getId()+"--idSectionTitleColumn",{width:E.getDialogBasedDevice()!==k.DEVICE_TYPES.Mobile?"85%":"81%"}),new y(this.getId()+"--idSectionVisColumn",{width:E.getDialogBasedDevice()!==k.DEVICE_TYPES.Mobile?"10%":"14%"})],updateFinished:function(){if(j>=0){this.getItems()[j].focus()}if(z){var e=this.getItems().findIndex(function(e){return e.getBindingContextPath()===z});if(e>=0){this.getItems()[e].getCells()[2].getItems()[0].focus()}}}}).addStyleClass("sapContrastPlus");this._oTable.bindAggregation("items",{path:"/cards",length:100,factory:this._generateTableColumnsTemplate.bind(this)});this._oTable.addDragDropConfig(new a({sourceAggregation:"items",targetAggregation:"items",drop:this._handleDrop.bind(this)}));this._oTable.attachBrowserEvent("keydown",this._attachDndHandler.bind(this,this._oTable,this._handleDrop.bind(this)))}return this._oTable};K.prototype._generateTableColumnsTemplate=function(){var e=new B({press:this._handleCardListItemPress.bind(this),type:"Navigation"}).addStyleClass("insightsListItem insightsListMargin");var t=new g({items:[new s({src:"sap-icon://BusinessSuiteInAppSymbols/icon-grip"}).addStyleClass("insightsDndIcon")]});var i=new p({items:[new T({text:"{descriptorContent/sap.card/header/title}",wrapping:true,press:this._showCardPreviewPopover.bind(this)}),new g({visible:"{= ${descriptorContent/sap.card/header/subTitle} ? true : false }",items:[new u({text:"{descriptorContent/sap.card/header/subTitle}"})]}).addStyleClass("cardsSubTitleMargin")]}).addStyleClass("cardsTitlePadding");var a=new g({items:[new C({type:{path:"visibility",formatter:function(e){return e==true?"Emphasized":"Default"}},pressed:{path:"visibility",mode:"TwoWay",formatter:function(e){return!e}},enabled:{path:"visibility",mode:"TwoWay",formatter:function(e){if(e==false&&this.getProperty("_visibleCount")>=10){return false}return true}.bind(this)},press:this._handleCardVisibilityToggle.bind(this),icon:"sap-icon://show",tooltip:{path:"visibility",formatter:function(e){return e==true?this.i18Bundle.getText("hideBtn"):this.i18Bundle.getText("showBtn")}.bind(this)}})]});e.addCell(t);e.addCell(i);e.addCell(a);return e};K.prototype._refreshCardList=function(){var e;if(this.bEnableResetAll){e=this.i18Bundle.getText("deleteAllCardsMsg")}else{var t=this.getProperty("_dtCards");var i="<p>"+this.i18Bundle.getText("refreshAllCards")+"</p>";i+="<ul>";t.forEach(function(e){i+='<li class="sapUiTinyMarginBottom">'+e.descriptorContent["sap.card"].header.title+"</li>"});i+="</ul>";e=new I({htmlText:i})}w.show(e,{icon:w.Icon.WARNING,title:this.i18Bundle.getText("refresh"),actions:[w.Action.OK,w.Action.CANCEL],emphasizedAction:w.Action.OK,onClose:function(e){if(e===w.Action.OK){F.getServiceAsync().then(function(e){return e._refreshUserCards(this.bEnableResetAll).then(function(){this.cardListRefreshed=true;return this._handleModelChange()}.bind(this))}.bind(this))}}.bind(this)})};K.prototype._handleCardListItemPress=function(e,t){if(e){this.currentCardPreviewPath=e.getSource().getBindingContextPath()}else if(t){this.currentCardPreviewPath=t.getBindingContextPath()}var i=this.getModel().getProperty(this.currentCardPreviewPath);var s=this.getProperty("_dtCards");if(this.cardListRefreshed&&s.length){this.fireListPress({manifest:JSON.stringify(i),listRefresh:s.map(e=>e.descriptorContent["sap.app"]["id"])})}else{this.fireListPress({manifest:JSON.stringify(i)})}this.cardListRefreshed=false};K.prototype._handleCardVisibilityToggle=function(e){this._oWrapperFlexBox.setBusy(true);var t=e.getSource();z=t.getBindingContext().sPath;var i=t.getBindingContext().getPath();var s=this.getModel().getProperty(i);var a=!s.visibility;s.visibility=a;s.descriptorContent["sap.insights"].visible=a;F.getServiceAsync().then(function(e){e._updateCard(s.descriptorContent,true).then(function(){this._oWrapperFlexBox.setBusy(false);this._handleModelChange();if(this._oTable){this._oTable.updateAggregation("items");this._applyFilters(this._oSearchField.getValue(),this._oVisibleFilterSwitch.getState())}return}.bind(this)).catch(function(e){this._oWrapperFlexBox.setBusy(false);_.show(e.message);O.error(e.message)}.bind(this))}.bind(this))};K.prototype._showCardPreviewPopover=function(e){var t=this.getModel();var i=e.getSource().getParent().getBindingContext().getPath();var s=t.getProperty(i);var a=e.getSource();var r=new p({alignItems:"Center",justifyContent:"Center"}).addStyleClass("sapUiSmallMargin");var n=new l({manifest:D.getCardPreviewManifest(s.descriptorContent),width:"17rem",height:"23.5rem",host:this.host});r.addItem(n);var o=new S({title:this.i18Bundle.getText("preview"),placement:"VerticalPreferredBottom",initialFocus:"idCardPreviewPopover",showHeader:true}).addStyleClass("sapContrastPlus previewPopoverBackground");o.addContent(r);o.openBy(a)};K.prototype._handleDrop=function(e){var t=e.getParameter?e.getParameter("draggedControl"):e.draggedControl,i=t.getParent().indexOfItem(t),s=e.getParameter?e.getParameter("droppedControl"):e.droppedControl,a=t.getParent().indexOfItem(s);if(i!==a){var r=this._oTable.getItems()[i].getBindingContext().getObject().rank,n=this._oTable.getItems()[a].getBindingContext().getObject().rank,o=this.getModel().getProperty("/cards");var l=o.findIndex(function(e){return e.rank===r});var d=o.findIndex(function(e){return e.rank===n});var h=W.updateCardsRanking(l,d,o);try{this._oWrapperFlexBox.setBusy(true);F.getServiceAsync().then(function(e){e._updateMultipleCards(h,"PUT").then(function(){var e=this.getModel().getProperty("/cards");e[l].descriptorContent["sap.insights"].ranking=e[l].rank;e=e.sort(function(e,t){if(e.rank<t.rank){return-1}return 1});this.getModel().setProperty("/cards",e);this._oWrapperFlexBox.setBusy(false)}.bind(this))}.bind(this))}catch(e){this._oWrapperFlexBox.setBusy(false);O.error(e.message)}}};K.prototype._attachDndHandler=function(e,i,s){var a=s.metaKey||s.ctrlKey;if(a&&(s.key==="ArrowUp"||s.key==="ArrowDown")){s.preventDefault();var r=s.key==="ArrowUp"?"Before":"After";var n=e.getItems();var o=t.getCurrentFocusedControlId();var l=n.findIndex(e=>e.getId()===o);if(l>=0&&l<n.length){var d=s.key==="ArrowDown"?l+1:l-1;if(d>=0&&d<n.length){var h=n[l];var g=n[d];var p={draggedControl:h,droppedControl:g,dropPosition:r};j=d;i(p)}n.forEach(function(e,t){e.tabIndex=t===d?0:-1})}}};return K});
//# sourceMappingURL=CardsList.js.map