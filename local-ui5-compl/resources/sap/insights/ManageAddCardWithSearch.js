/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Control","sap/m/Button","sap/m/Dialog","sap/ui/model/resource/ResourceModel","./utils/InsightsUtils","./base/InMemoryCachingHost","sap/ui/integration/widgets/Card","sap/m/VBox","sap/m/HBox","sap/m/ScrollContainer","./utils/AppConstants","./utils/CardSkeletonManifest","sap/m/MessageToast","sap/base/Log","sap/m/IllustratedMessage","sap/ui/performance/trace/FESRHelper","sap/m/Title","sap/m/Label","sap/m/FlexBox","sap/m/Panel","sap/m/Toolbar","sap/m/TextArea","sap/m/Text","sap/m/MessageStrip","sap/ui/core/Icon","sap/m/MessageBox"],function(e,t,s,i,a,n,r,o,l,d,g,h,u,p,c,f,B,y,T,C,x,m,_,S,I,w){"use strict";var v=JSON.parse(JSON.stringify(h));var b=e.extend("sap.insights.ManageAddCardWithSearch",{metadata:{events:{onAddButtonPress:{parameters:{manifest:{type:"string"}}}},aggregations:{_queryDialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"}}}});b.prototype.init=function(){this.i18Bundle=new i({bundle:a.getResourceBundle()}).getResourceBundle();this._createStaticControls();this._getQueryDialog()};b.prototype._getQueryDialog=function(){if(!this.getAggregation("_queryDialog")){var e=new s({title:this.i18Bundle.getText("addToInsights"),content:[this._getOuterVbox()],showHeader:true,contentHeight:"41.1rem",contentWidth:"59.3rem",verticalScrolling:false,horizontalScrolling:false,afterClose:this.resetDialog.bind(this,true),escapeHandler:this.closeDialog.bind(this),afterOpen:this.afterOpenDialog.bind(this),beginButton:this._getAddButton(),endButton:this._getCancelButton()});this.setAggregation("_queryDialog",e,true)}return this.getAggregation("_queryDialog")};b.prototype._createStaticControls=function(){var e={};e.host=new n(this.getId()+"--transactionalCardHost",{action:function(e){var t=e.getParameter("card")||{};this.oManifest=t.getManifest()}.bind(this)});e.searchedCard=new r(this.getId()+"--searchedCard",{manifest:v,manifestApplied:this._setAriaTextOnManifest.bind(this),width:"19rem",height:"33.5rem",host:e.host,previewMode:"Abstract",visible:true});e.oAddButton=new t(this.getId()+"--addButton",{text:this.i18Bundle.getText("INT_DIALOG_Ok"),press:this.addCard.bind(this),type:"Emphasized",enabled:false,width:"2.75rem"});f.setSemanticStepname(e.oAddButton,"press",g.FESR_AIGENERATE_ADD_CARD);e.oCancelButton=new t(this.getId()+"--cancelButton",{text:this.i18Bundle.getText("cancelButton"),press:this.closeDialog.bind(this)});e.messageStripHbox=this._createMessageStripHBox();e.oNoCardMessage=new c(this.getId()+"--editInsightNoInsightsCardsMsg",{illustrationSize:"Dialog",illustrationType:"sapIllus-SimpleEmptyList",description:" "}).addStyleClass("sapFIllustratedMessageAlign sapFFrequentIllustratedMessageAlign");e.noCardBox=new o(this.getId()+"--illusCardVbox",{alignItems:"Center",height:"100%",renderType:"Bare",justifyContent:"Center",items:[e.oNoCardMessage],visible:false}).addStyleClass("aiErrorPadding");var s=new _(this.getId()+"--label",{text:this.i18Bundle.getText("typed_text_label"),wrapping:true}).addStyleClass("sapUiSmallMarginBeginEnd sapUiSmallMarginTop");e.oTextBox=new m(this.getId()+"--textBox",{width:"calc(100% - 2rem)",height:"7rem",placeholder:this.i18Bundle.getText("SAMPLE_QUERY_MSG")+" "+this.i18Bundle.getText("SAMPLE_QUERY_TEXT"),liveChange:this.onChange.bind(this)}).addStyleClass("sapUiSmallMarginBeginEnd sapUiSmallMarginTop sapUiTinyMarginBottom");e.oTextBox.attachBrowserEvent("keydown",function(e){if(e.keyCode===13){this._onSearch()}}.bind(this));e.oRegenerateButton=new t(this.getId()+"--searchButton",{type:"Default",icon:"sap-icon://ai",text:this.i18Bundle.getText("GO"),press:this._onSearch.bind(this),enabled:false}).addStyleClass("sapUiSmallMarginBegin");f.setSemanticStepname(e.oRegenerateButton,"press",g.FESR_AIGENERATE_CARD);e.oClearButton=new t(this.getId()+"--clearButton",{type:"Transparent",text:this.i18Bundle.getText("Clear"),enabled:false,press:this._onClear.bind(this)}).addStyleClass("sapUiTinyMarginBegin sapUiSmallMarginEnd");var i=new l(this.getId()+"--buttonHBox",{width:"100%",alignItems:"End",renderType:"Bare",justifyContent:"End",items:[e.oRegenerateButton,e.oClearButton]});var a=new I(this.getId()+"--helpIcon",{src:"sap-icon://sys-help",size:"0.875rem",height:"0.875rem",color:"Neutral"});var h=new y(this.getId()+"--sampleQueryLabel",{text:this.i18Bundle.getText("SAMPLE_QUERY")}).addStyleClass("sapUiTinyMarginBegin");var u=new l(this.getId()+"--queryHbox",{width:"calc(100% - 1rem)",justifyContent:"Start",backgroundDesign:"Transparent",renderType:"Bare",alignItems:"Center",items:[a,h]}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginTop");var p=new T(this.getId()+"--defaultPreviewFormFlex",{height:"100%",width:"50%",direction:"Column",renderType:"Bare",items:[s,e.oTextBox,i,u,this._createSampleQueryListBox()]});var w=new B(this.getId()+"--defaultPreviewCardText",{text:this.i18Bundle.getText("INT_DIALOG_TITLE_CardPreview"),textAlign:"Left"}).addStyleClass("sapUiSmallMarginTop sapUiTinyMarginBottom");var b=new l(this.getId()+"--defaultPreviewHBox",{width:"100%",height:"100%",justifyContent:"Start",backgroundDesign:"Transparent",renderType:"Bare",items:[w]}).addStyleClass("sapUiTinyMarginBegin");var M=new x(this.getId()+"--defaultPreviewToolBar",{width:"100%",height:"2.5rem",style:"Clear",design:"Auto",content:[b]}).addStyleClass("sapThemeBaseBG");var A=new l(this.getId()+"--insightsCardOverflowInnerHBox",{}).addStyleClass("insightsCardOverflowLayer insightsPreviewCardOverLay insightsPreviewOVPOverLayPositionLS");e.oInsightsCardOverflowLayer=new l(this.getId()+"--insightsCardOverflowLayer",{height:"0",visible:false,items:[A]}).addStyleClass("sapMFlexBoxJustifyCenter");var D=new o(this.getId()+"--defaultPreviewVBox",{height:"100%",alignItems:"Center",backgroundDesign:"Transparent",justifyContent:"SpaceAround",items:[e.searchedCard,e.oInsightsCardOverflowLayer,e.messageStripHbox]});var E=new C(this.getId()+"--defaultPreviewPanel",{expanded:false,height:"100%",backgroundDesign:"Transparent",content:[D]});e.oDefaultPreviewPanelFlex=new T(this.getId()+"--defaultPreviewPanelFlex",{height:"100%",backgroundDesign:"Transparent",renderType:"Bare",justifyContent:"Center",items:[E]});var R=new S(this.getId()+"--busyMessageStrip",{text:this.i18Bundle.getText("CARD_GENERATE_MSG"),showIcon:true,showCloseButton:false});e.busyMessageBox=new l(this.getId()+"--busyMessageBox",{alignItems:"Center",renderType:"Bare",width:"calc(100% - 2rem)",height:"3rem",visible:false,justifyContent:"Start",backgroundDesign:"Transparent",items:[R]}).addStyleClass("sapUiSmallMarginBeginEnd sapUiTinyMarginBottom");var O=new d(this.getId()+"--defaultPreviewScroll",{vertical:true,horizontal:false,height:"100%",content:[M,e.busyMessageBox,e.oDefaultPreviewPanelFlex,e.noCardBox]});var P=new T(this.getId()+"--defaultPreviewFlex",{height:"100%",width:"50%",direction:"Column",renderType:"Bare",items:[O]}).addStyleClass("sapMPageBgStandard");e.oDefaultVBox=new o(this.getId()+"--defaultVBox",{height:"100%",width:"100%",direction:"Row",justifyContent:"SpaceBetween",items:[p,P]});this._setAccessMethods(e)};b.prototype._createMessageStripHBox=function(){var e=new _(this.getId()+"--messageAIText",{text:this.i18Bundle.getText("addCardsAIInfo"),width:"6.3rem"}).addStyleClass("sapThemeHighlight-asColor");var t=new y(this.getId()+"--messageAIVerificationText",{text:this.i18Bundle.getText("addVerifyInfo")});var s=new l(this.getId()+"--messageHBox",{alignItems:"Center",renderType:"Bare",width:"19rem",height:"1rem",visible:false,justifyContent:"Start",backgroundDesign:"Transparent",items:[e,t]}).addStyleClass("sapUiTinyMarginTop");return s};b.prototype._createSampleQueryListBox=function(){var e=new y(this.getId()+"--queryListItem1",{showColon:false,text:this.i18Bundle.getText("QUERY_LIST_ITEM1"),wrapping:true}).addStyleClass("aiDialogText sapUiTinyMarginEnd sapUiTinyMarginTop");var t=new y(this.getId()+"--queryListItem2",{showColon:false,text:this.i18Bundle.getText("QUERY_LIST_ITEM2"),wrapping:true}).addStyleClass("aiDialogText sapUiTinyMarginEnd");var s=new y(this.getId()+"--queryListItem3",{showColon:false,text:this.i18Bundle.getText("QUERY_LIST_ITEM3"),wrapping:true}).addStyleClass("aiDialogText sapUiTinyMarginEnd");var i=new o(this.getId()+"--sampleQueryListBox",{alignItems:"Start",justifyContent:"Start",backgroundDesign:"Transparent",renderType:"Bare",items:[e,t,s]}).addStyleClass("sapUiSmallMarginBegin");return i};b.prototype._setAccessMethods=function(e){this._getSearchedCard=function(){return e&&e.searchedCard};this._getAddButton=function(){return e&&e.oAddButton};this._getCancelButton=function(){return e&&e.oCancelButton};this._enableFocusAddButton=function(t){if(e&&e.oAddButton){e.oAddButton.setEnabled(t);if(t){setTimeout(function(){e.oAddButton.focus()},0)}}};this._getTextBox=function(){return e&&e.oTextBox};this._setMessageStripOverflowVisibility=function(t){if(e&&e.messageStripHbox&&e.oInsightsCardOverflowLayer){e.messageStripHbox.setVisible(t);e.oInsightsCardOverflowLayer.setVisible(t)}};this._getNoCardMessage=function(){return e&&e.oNoCardMessage};this._getDefaultPreviewPanelFlex=function(){return e&&e.oDefaultPreviewPanelFlex};this._toggleCardBox=function(t){e.oDefaultPreviewPanelFlex.setVisible(t);e.noCardBox.setVisible(!t)};this._toggleButtonAndText=function(t){e.oTextBox.setEnabled(t);e.busyMessageBox.setVisible(!t);e.oRegenerateButton.setEnabled(t);this._enableClearButton(t)};this._enableClearButton=function(t){e.oClearButton.setEnabled(t)};this._enableRegenerateButton=function(t){e.oRegenerateButton.setEnabled(t)};this._getOuterVbox=function(){return e&&e.oDefaultVBox}};b.prototype._onClear=function(){this.resetDialog(true);u.show(this.i18Bundle.getText("Query_Deleted"));this._getTextBox().focus()};b.prototype.addCard=function(){var e=this._getSearchedCard()&&this._getSearchedCard().getManifest();this.getAggregation("_queryDialog").setBusy(true);sap.ui.require(["sap/insights/CardHelper"],function(t){t.getServiceAsync().then(function(t){t._createCard(e).then(function(e){this.getAggregation("_queryDialog").setBusy(false);u.show(this.i18Bundle.getText("Card_Created"));this.closeDialog();if(!e["sap.insights"].visible){w.information(this.i18Bundle.getText("INT_CARD_LIMIT_MESSAGEBOX"),{styleClass:"msgBoxAlign"})}if(this.hasListeners("onAddButtonPress")){this.fireOnAddButtonPress()}}.bind(this))}.bind(this)).catch(function(e){this.getAggregation("_queryDialog").setBusy(false);p.error(e.message);u.show(e.message)}.bind(this))}.bind(this))};b.prototype.closeDialog=function(){this._getQueryDialog().close()};b.prototype.openDialog=function(){this._getQueryDialog().open()};b.prototype.afterOpenDialog=function(){this._getTextBox().focus()};b.prototype._setAriaTextOnManifest=function(e){var t=e.getSource()._ariaText.getText();var s=this.i18Bundle.getText("INT_DIALOG_TITLE_CardPreview");e.getSource()._ariaText.setText(s+t);var i=e.getSource().getManifest()["sap.app"];if(i&&!(i.title===v["sap.app"].title)){e.getSource().setPreviewMode("Off")}};b.prototype.onChange=function(){var e=this._getTextBox().getValue();if(e&&e.trim().length){this._enableRegenerateButton(true);this._enableClearButton(true)}else{this.resetDialog()}};b.prototype._onSearch=function(){var e=this._getTextBox().getValue();if(e&&e.trim().length){this._startGenerate=true;this._getCancelButton().focus();this._toggleButtonAndText(false);this.resetDialog();var t={UserInput:e};fetch(g.AI_INSIGHTCARD_BASEURL,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(e){var s=e.headers.get("X-CSRF-Token");return fetch(g.ADD_AI_INSIGHTCARD_COMPLETEURL,{method:g.POST,headers:{"X-CSRF-Token":s,"content-type":"application/json;odata.metadata=minimal;charset=utf-8"},body:JSON.stringify(t)})}).then(function(e){if(!e.ok){return e.json().then(function(e){return Promise.reject({message:e.message||e.error.message})})}return e.json()}).then(function(e){if(this._startGenerate){this._toggleButtonAndText(true);var t="";if(e&&e.CardManifest){t=JSON.parse(e.CardManifest)}if(t){var s=this._getSearchedCard();s.setManifest(t);this._enableFocusAddButton(true);this._setMessageStripOverflowVisibility(true);this._toggleCardBox(true)}this._startGenerate=false}}.bind(this)).catch(function(e){if(this._startGenerate){this._toggleButtonAndText(true);p.error(e.message);var t=/\((\d{2})\d*\)\s*(.*)/;var s=e.message.match(t);var i="",a="";if(s){i=s[1];a=s[2]}var n=this.setErrorMessage(i,a);var r=this._getNoCardMessage();r.setTitle(n.title);r.setDescription(n.description);r.setIllustrationType(n.type);this._toggleCardBox(false);setTimeout(function(){this._getTextBox().focus()}.bind(this),0);this._startGenerate=false}}.bind(this))}else{this._getTextBox().focus()}};b.prototype.setErrorMessage=function(e,t){var s={type1:"sapIllus-SimpleConnection",type2:"sapIllus-SimpleNotFoundMagnifier",type3:"sapIllus-SimpleEmptyDoc",type4:"sapIllus-SimpleError"};var i={type:"",title:"",description:t};switch(e){case"10":i.type=s.type1;i.title=this.i18Bundle.getText("ERRORCODE_TITLE1");break;case"20":i.type=s.type2;i.title=this.i18Bundle.getText("ERRORCODE_TITLE2");break;case"30":i.type=s.type3;i.title=this.i18Bundle.getText("ERRORCODE_TITLE3");break;default:i.type=s.type4;i.title=this.i18Bundle.getText("ERRORCODE_TITLE4");break}return i};b.prototype.resetDialog=function(e){if(e){this._getTextBox().setValue("");this._getNoCardMessage().setDescription(" ");this._toggleButtonAndText(true);this._startGenerate=false}this._setMessageStripOverflowVisibility(false);const t={"/sap.card/header/dataTimestamp":""};var s=this._getSearchedCard();s.setManifestChanges([t]);s.setManifest(v);s.setPreviewMode("Abstract");this._toggleCardBox(true);this._enableFocusAddButton(false);this._enableClearButton(false);this._enableRegenerateButton(false)};return b});
//# sourceMappingURL=ManageAddCardWithSearch.js.map