/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","./AppConstants","./InsightsUtils"],function(t,e,n,r){"use strict";var s=t.extend("sap.insights.utils.BatchHelper",{});var i=e.getLogger("sap.insights.utils.BatchHelper");var a;function o(t,e){var r="INSIGHTS_CARDS";this.url=e==="POST"?r:r+"('"+t.id+"')";this.mOptions={};this.batchRequests=[];this.payload=t;this.boundary="batch_id_"+Date.now()+"_01";this.mOptions.headers={};this.mOptions.method=e||n.PUT;this.mOptions.headers["content-type"]="multipart/mixed;boundary="+this.boundary;this.mOptions.headers["X-CSRF-Token"]=a;return this}function h(){return fetch(n.REPO_BASE_URL,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(t){var e=t.headers.get("X-CSRF-Token");if(t.ok&&e){return e}var n=r.getResourceBundle().getText("tokenFetchError");i.error(n);throw new Error(n)})}o.prototype.addRequest=function(t){this.batchRequests.push(t)};o.prototype._constructBody=function(){var t="--"+this.boundary;var e="\r\n";var n="Content-Type:application/http"+e+"Content-Transfer-Encoding:binary"+e;var r="changeset_001";var s="--"+r;var i="Content-Type: multipart/mixed; boundary="+r+e;var a=t+e+i;a+=e+s;for(var o=0;o<this.batchRequests.length;o++){var h=this.batchRequests[o];a+=e+n;a+="Content-ID: "+(o+1)+e+e;a+=h.mOptions.method+" "+h.url+" HTTP/1.1 "+e;a+="sap-context-accept: header"+e+"Content-Type:application/json"+e+e;a+=JSON.stringify(this.batchRequests[o].payload)+e+e;a+=s;if(o===this.batchRequests.length-1){a+="--"+e;a+=t+"--"}}return a};function u(t){var e=[];var n=[];var r=[];try{n=t.split("\r\n")}catch(t){throw new Error}n.forEach(function(t){if(t!==""){r.push(t)}});var s="";for(var i=1;i<r.length-1;i++){s=r[i].includes("Content-Type: ")?r[i].split("Content-Type: ")[1]:s;if(r[i+1].includes(r[0])){if(s==="application/json"){r[i]=JSON.parse(r[i]);e.push(r[i])}else{e.push(r[i])}}}return e}s.createMultipartRequest=function(t,e){return h().then(function(n){this.url="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/insights_cards_repo_srv/001/$batch";this.batchRequests=[];var r;a=n;for(var s=0;s<t.length;s++){var i=t[s];var h=new o(i,e);if(!r){r=h}r.addRequest(h)}return this.fetchData(r)}.bind(this))};s.fetchData=function(t){t.mOptions.body=t._constructBody();t.mOptions.method="POST";return fetch(this.url,t.mOptions).then(function(t){if(t.ok===false){throw new Error}return t.text()}).then(function(t){return u(t)})};return s});
//# sourceMappingURL=BatchHelper.js.map