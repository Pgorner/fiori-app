/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
"use strict";sap.ui.define(["sap/cards/ap/generator/odata/v2/MetadataAnalyzer","sap/cards/ap/generator/odata/v4/MetadataAnalyzer","sap/ui/VersionInfo","sap/ui/core/Element","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/v4/ODataUtils","../odata/ODataUtils","../types/CommonTypes","../utils/CommonUtils","./ApplicationInfo","./Batch","./I18nHelper","./PropertyExpression"],function(e,t,n,a,r,o,i,s,c,u,p,l,d){"use strict";const f=function(e,t){try{if(!e){return Promise.resolve()}const a=t.getManifest()["sap.app"].id;return Promise.resolve(n.load({library:"sap.ui.core"})).then(function(t){const n=t;e["sap.insights"]={templateName:"ObjectPage",parentAppId:a,cardType:"LEAN_DT",versions:{ui5:n.version+"-"+n.buildTimestamp}}})}catch(e){return Promise.reject(e)}};const m=e["getPropertyReference"];const h=t["getPropertyReferenceKey"];const g=i["getDataType"];const y=i["isODataV4Model"];const v=s["ColorIndicator"];const E=c["getColorForGroup"];const x=u["ApplicationInfo"];const O=u["ODataModelVersion"];const _=p["updateManifestWithExpandQueryParams"];const b=p["updateManifestWithSelectQueryParams"];const S=l["resolveI18nTextFromResourceModel"];const C=d["extractPathExpressionWithoutUOM"];const I=d["extractPathWithoutUOM"];const M=d["extractPropertyConfigurationWithoutTextArrangement"];const A=d["getTextArrangementFromCardManifest"];const $=d["hasFormatter"];const P=d["isExpression"];const T=d["isI18nExpression"];const Q=d["updateAndGetSelectedFormatters"];let D;const V=[];function F(e){const{title:t,subTitle:n,description:a,service:r,serviceModel:o,sapAppId:i,sapCoreVersionInfo:s,entitySetName:c,data:u}=e;const p=y(o);const l=p?"/content/":"/content/d/";const d=p?"/header/":"/header/d/";const f=p?h(o,c):m(o,c);const v={};f.forEach(e=>{v[e.name]={type:g(e.type),value:u[e.name]}});const E=f.map(e=>e.name);D={_version:"1.15.0","sap.app":{id:i,type:"card",i18n:"../../../i18n/i18n.properties",title:t,subTitle:n,description:a,applicationVersion:{version:"1.0.0"}},"sap.ui":{technology:"UI5",icons:{icon:"sap-icon://switch-classes"}},"sap.card":{extension:"module:sap/cards/ap/common/extensions/BaseIntegrationCardExtension",type:"Object",configuration:{parameters:{...v,_contentSelectQuery:{value:E?.length?`$select=${E.join(",")}`:""},_headerSelectQuery:{value:E?.length?`$select=${E.join(",")}`:""},_contentExpandQuery:{value:""},_headerExpandQuery:{value:""},_entitySet:{type:"string",value:c}},destinations:{service:{name:"(default)",defaultUrl:"/"}},csrfTokens:{token1:{data:{request:{url:`{{destinations.service}}${r}`,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}}},data:{request:{url:`{{destinations.service}}${r}/$batch`,method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}","Accept-Language":"{{parameters.LOCALE}}"},batch:{header:{method:"GET",url:U(),headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"},retryAfter:30},content:{method:"GET",url:L(),headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"}}}}},header:{data:{path:d},type:"Numeric",title:t,subTitle:n,unitOfMeasurement:"",mainIndicator:{number:"",unit:""}},content:{data:{path:l},groups:[]}},"sap.ui5":{_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}},"sap.insights":{templateName:"ObjectPage",parentAppId:i,cardType:"LEAN_DT",versions:{ui5:s.version+"-"+s.buildTimestamp}}};return D}function N(){const{rootComponent:e,entitySet:t}=x.getInstance().fetchDetails();const n=e.getModel();const a=[];const i=y(n);if(i){const e=h(n,t);e.forEach(e=>{const t=o.formatLiteral(`{{parameters.${e.name}}}`,e.type);a.push(`${e.name}=${t}`)})}else{const e=m(n,t);e.forEach(e=>{const t=r.formatValue(`{{parameters.${e.name}}}`,e.type,true);a.push(`${e.name}=${t}`)})}return a.join(",")}function U(){return`{{parameters._entitySet}}(${N()})?{{parameters._headerSelectQuery}}{{parameters._headerExpandQuery}}`}function L(){return`{{parameters._entitySet}}(${N()})?{{parameters._contentSelectQuery}}{{parameters._contentExpandQuery}}`}function j(){return D||{}}function W(e,t){D={...e};b(D);t&&_(D);const n=a.getElementById("cardGeneratorDialog--cardPreview");if(n){n.setBaseUrl("./");n.setManifest(D);n.refresh()}}function k(e){const t=e.getProperty("/configuration/groups");const n=e?.getProperty("/configuration/mainIndicatorOptions/criticality");const a=t.map(function(e){const t=e?.items?.filter(function(e){return e.name}).map(e=>{const t=n?.filter(t=>t.name===e.name);let a;if(t?.[0]?.criticality){const e=t[0]?.activeCalculation?t[0]:t[0]?.criticality;a=E(e)}const r={label:e.label,value:e.value,name:e.name};if(a){r.state=a;r.type="Status"}if(e.hasActions){r["actions"]=e.actions}return r});return{title:e.title,items:t?t:[]}});D["sap.card"].content.groups=a;W(D,e)}function G(e,t,n){if(T(e)){return S(e,t)}if(P(e)&&!$(e)){const t=I(e);return n.find(e=>e.name===t)?.labelWithValue??""}if(P(e)&&$(e)){const t=C(e);const a=Q(t);B(a);return n.find(e=>e.name===a.property)?.labelWithValue??""}return e}function R(e){const t=e["sap.card"].header.mainIndicator;let n="";let a={referenceValue:"",downDifference:"",upDifference:""};const r=[];const o=e["sap.card"].content.groups;if(o.length>0){w(e,r)}if(!t||!t.number){return{mainIndicatorStatusKey:"",mainIndicatorNavigationSelectedKey:"",criticalityOptions:r,navigationValue:"",trendOptions:a}}const{propertyPath:i,formatterExpression:s}=M(t.number,e);const c=t.state;if(s.length){const e=s.map(Q);e.forEach(B)}if(P(i)&&!$(i)){n=I(i)}if(t.trend&&t.trend!=="None"){const e=t.trend;const n=/"referenceValue":(\d+),"downDifference":(\d+),"upDifference":(\d+)/;const r=e.match(n);if(r){a={referenceValue:r[1]||"",downDifference:r[2]||"",upDifference:r[3]||""}}}if(P(i)&&$(i)){const e=C(i);const t=Q(e);B(t);n=t.property||""}let u={criticality:"",name:"",activeCalculation:false};if(c&&$(c)){const e=C(c);const t=Q(e);B(t);u={criticality:"{"+t.property+"}",name:n,activeCalculation:false}}else if(c&&c!=="None"){u={criticality:c,name:n,activeCalculation:false}}if(u.name.length){K(r,u)}let p="";let l=n;if(n.includes("/")){l=n.split("/")[0];p=n.split("/")[1]}return{mainIndicatorStatusKey:l,mainIndicatorNavigationSelectedKey:p,criticalityOptions:r,navigationValue:n,trendOptions:a}}function w(e,t){const n=e["sap.card"].content.groups;n.forEach(e=>{e.items.forEach(e=>{if(e.state){const n=q(e.state);const a={criticality:n,name:e.name,activeCalculation:false};K(t,a)}})})}function K(e,t){const n=e.some(e=>e.name===t.name);if(!n){e.push(t)}}function q(e){if(e&&$(e)){const t=C(e);const n=Q(t);B(n);return"{"+n.property+"}"}if(e&&e in v){return v[e]}return v.None}function z(e){const t=e["sap.card"].header.sideIndicators||[];if(t.length===0||!t[0].number){return{targetValue:"",targetUnit:"",deviationValue:"",deviationUnit:""}}const[n={},a={}]=t;const{number:r="",unit:o=""}=n;const{number:i="",unit:s=""}=a;return{targetValue:r,targetUnit:o,deviationValue:i,deviationUnit:s}}function B(e){if(V.length===0||!V.find(t=>t.property===e.property)){V.push({...e})}}function H(e,t){const{formatterExpression:n}=M(e,t);if(n.length){const e=n.map(Q);e.forEach(B)}return e}function J(e,t){const n=e["sap.card"].content.groups;if(n.length===0){return[]}return n.map(n=>({title:S(n.title,t),items:n.items.map(n=>{const a={label:S(n.label,t),value:H(n.value,e),name:n.name,isEnabled:true,isNavigationEnabled:false};if(n.state){a.type="Status";a.state=n.state}return a})}))}function X(e,t){const n=e["sap.card"];const a=x.getInstance();const r=a.getRootComponent();const o=r.getModel();const{odataModel:i,entitySet:s}=a.fetchDetails();const c=[];if(i===O.V4){h(o,s).forEach(e=>c.push(e.name))}else{m(o,s).forEach(e=>c.push(e.name))}if(!n.configuration){n.configuration={parameters:{}}}if(!n.configuration.parameters){n.configuration.parameters={}}const u=n.configuration.parameters;u["_propertyFormatting"]={};const p=t.getProperty("/configuration/advancedFormattingOptions/textArrangements");const l={};p.forEach(e=>{if(Object.keys(e).length>0){const{name:t,arrangementType:n,value:a}=e;l[t]={arrangements:{text:{[n]:true,path:a}}}}});if(Object.keys(l).length>0){u["_propertyFormatting"]=l}u["_mandatoryODataParameters"]={value:c};u["_entitySet"]={value:s,type:"string"};c.forEach(e=>{u[e]={type:g(e),value:""}})}const Y=e=>{const t=JSON.parse(JSON.stringify(e));const n=t["sap.card"].data?.request?.batch;const a="?{{parameters._headerSelectQuery}}";const r="?{{parameters._contentSelectQuery}}";const o="{{parameters._headerExpandQuery}}";const i="{{parameters._contentExpandQuery}}";const s=n?.header?.url;const c=n?.content?.url;if(s?.indexOf(a)===-1){n.header.url=`${n.header.url}${a}${o}`}else if(s?.indexOf(o)===-1){n.header.url=`${n.header.url}${o}`}if(c?.indexOf(r)===-1){n.content.url=`${n.content.url}${r}${i}`}else if(c?.indexOf(i)===-1){n.content.url=`${n.content.url}${i}`}const u=t["sap.card"].configuration?.parameters;u._contentSelectQuery=u?._contentSelectQuery??{value:""};u._headerSelectQuery=u?._headerSelectQuery??{value:""};u._contentExpandQuery=u?._contentExpandQuery??{value:""};u._headerExpandQuery=u?._headerExpandQuery??{value:""};return t};const Z=(e,t)=>{const n=x.getInstance();const a=n.getRootComponent();const r=a.getModel();const{odataModel:o,entitySet:i}=n.fetchDetails();const s=o===O.V4?h(r,i):m(r,i);const c=e["sap.card"];if(!c.configuration){c.configuration={parameters:{}}}if(!c.configuration.parameters){c.configuration.parameters={}}const u=c.configuration.parameters;u["_entitySet"]={value:i,type:"string"};s.forEach(e=>{u[e.name]={type:g(e.type),value:t[e.name]}})};function ee(e){const t=e["sap.card"].header.data;if(t?.path&&t.path!=="/header/d/"){t.path="/header/d/"}}const te=(e,t)=>{if(!e){return e}e=Y(e);const n=e["sap.card"].data.request?.batch;if(n!==undefined){n.header.url=U();n.content.url=L()}e["sap.app"].id=x.getInstance().fetchDetails().componentName;e["sap.app"].i18n=e["sap.app"].i18n||"../../../i18n/i18n.properties";Z(e,t);ee(e);return e};function ne(e,t,n){const a=e["sap.card"].header.title??"";const r=e["sap.card"].header.subTitle??"";const o=e["sap.card"].header.unitOfMeasurement??"";V.splice(0,V.length);const i=A(e);return{title:G(a,t,n),subtitle:G(r,t,n),headerUOM:G(o,t,n),mainIndicatorOptions:R(e),sideIndicatorOptions:z(e),groups:J(e,t),formatterConfigurationFromCardManifest:V,textArrangementsFromCardManifest:i}}var ae={__esModule:true};ae.createInitialManifest=F;ae.getCurrentCardManifest=j;ae.renderCardPreview=W;ae.updateCardGroups=k;ae.resolvePropertyLabelFromExpression=G;ae.getCriticallityStateForGroup=q;ae.enhanceManifestWithInsights=f;ae.enhanceManifestWithConfigurationParameters=X;ae.addQueryParametersToManifest=Y;ae.updateExistingCardManifest=te;ae.parseCard=ne;return ae});
//# sourceMappingURL=IntegrationCardHelper-dbg.js.map