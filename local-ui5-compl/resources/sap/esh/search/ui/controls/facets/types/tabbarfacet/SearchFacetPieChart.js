/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../../../../i18n","sap/ui/thirdparty/d3","sap/ui/core/Control","../../FacetTypeUI","sap/ui/core/Element"],function(t,e,i,n,a){"use strict";function s(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const r=s(t);const l=n["FacetTypeUI"];const d=i.extend("sap.esh.search.ui.controls.SearchFacetPieChart",{renderer:{apiVersion:2,render(t,e){t.openStart("div",e);t.attr("role","figure");t.openEnd();t.close("div");e.PieChart=h}},metadata:{properties:{oSearchFacetDialog:{type:"object"}},aggregations:{items:{type:"sap.esh.search.ui.FacetItem",multiple:true}}},constructor:function t(n,a){i.prototype.constructor.call(this,n,a);this.iMissingCnt=0;d.d3=e},getFacetIndex:function t(){let e=this.getDomRef();let i;while(e){if(e.classList.contains("sapUshellSearchFacetIconTabBar")){i=e;break}e=e.parentElement}if(!i){return-1}const n=document.querySelectorAll(".sapUshellSearchFacetIconTabBar");for(let t=0;t<n.length;++t){const e=n.item(t);if(e===i){return t}}return-1},getFacetIndexByIdForLargePieChart:function t(e){let i=-1;const n=$("#"+e).parent().parent()[0];const a=n.id;const s=$(".searchFacetLargeChartContainer");for(let t=0;t<s.length;t++){const e=s[t].id;if(e===a){i=t;break}}return i},getPieChartIndexByFacetIndex:function t(e){let i;let n=-1;let a=0;for(let t=0;t<e;t++){i=$($(".sapUshellSearchFacetIconTabBar")[t]).find(".sapMLIBContent")[1].firstChild["id"];if(i.match(/pieChart/)!==null){a++}}n=a;return n},getSumSelected:function t(e){let i;let n=0;if(e){for(let t=0;t<e.length;t++){if(e[t].facetType===l.Attribute){for(let a=0;a<e[t].items.length;a++){i=e[t].items[a].value;if(i&&e[t].items[a].selected){n+=i}}}}}return n},getDataForPieChart:function t(e,i,n){const a=[];let s=[];let d;let h=0;let o=-1;let c="";const g=i.oData.count;let u=g;let f=0;this.iMissingCnt=0;for(let t=0;t<e.length;t++){if(e[t].facetType===l.Attribute){o++;if(e[t].totalCount){u=e[t].totalCount}s=[];f=0;for(let i=0;i<e[t].items.length;i++){d={};h=e[t].items[i].value;if(h){c=""+h;f+=h;d.filterCondition=e[t].items[i].filterCondition;d.dimension=e[t].items[i].facetTitle;d.label=e[t].items[i].label;d.selected=e[t].items[i].selected;d.filterLabel=e[t].items[i].label;d.id=e[t].items[i].label;d.value=h;d.valueLabel=e[t].items[i].valueLabel;if(c){d.tooltip=e[t].items[i].label+": "+h}else{d.tooltip=e[t].items[i].label}d.filtered=false;d.removed=false;d.fill="#007CAA";d.maxLabelLength=30;s.push(d)}else if(o===n){this.iMissingCnt++}}const i=Math.round(f/u*100);let l=100-i;if(l>0){if(l===100){l=99}const t=18*f/350;const e=""+l;d={};d.filterCondition=null;d.dimension="";d.label=e;d.id="perc_missing";d.value=t;d.valueLabel=e;d.tooltip=r.getText("facetPieChartOverflowText",[e]);d.filtered=false;d.removed=false;d.fill="transparent";d.stroke="none";d.maxLabelLength=30;s.push(d)}a.push(s)}}return a},getDataForPieChartLarge:function t(e){const i=[];let n=0;let a=0;let s;for(let t=0;t<e.length;t++){n=e[t].value;if(n){s={};a=a+n;s.filterCondition=e[t].filterCondition;s.dimension=e[t].facetAttribute;s.label=e[t].label;s.selected=e[t].selected;s.filterLabel=e[t].label;s.id=e[t].label;s.value=n;s.valueLabel=e[t].valueLabel;s.tooltip=e[t].label+"\t: "+n;s.filtered=false;s.removed=false;s.fill="#007CAA";s.maxLabelLength=30;i.push(s)}}return i},directUpdate:function t(e,i,n,a){let s;const r=[];const l=20;const d=null;s=this.getModel();if(!s){s=this.getParent().getModel()}a.pieChartParentClass="sapUshellSearchFacetPieChartLarge";a.height=a.relevantContainerHeight;a.labelHideThreshold=1e-6;$(i).parent().parent().height(a.height);a.width=$(i).parent().parent().width();this.chartElements=this.getDataForPieChartLarge(e);const o=new h(i,a,d,s);for(let t=0;t<l;t++){if(this.chartElements[t]){r.push(this.chartElements[t])}}o.update(r)},isFacetPanel:function t(){let e=this.getDomRef();while(e){if(e.classList.contains("sapUshellSearchFacetTabBar")){return true}e=e.parentElement}return false},onAfterRendering:function t(){const e=this;let i,n,s,l,d,h;const o=null;const c={};l=this.getModel();if(!l){l=this.getParent().getModel("facets")}if(l){d=$("#"+this["sId"])[0];if(this.isFacetPanel()){c.pieChartParentClass="sapUshellSearchFacetPieChart";h=this.getFacetIndex();d.className=c.pieChartParentClass;i=this.getDataForPieChart(l.oData.facets,l,h);n=i[h];const t=n.map(t=>t.tooltip);this.getDomRef().setAttribute("aria-label",t.join("; "));const g=this.getBindingContext().getObject();this.getDomRef().setAttribute("data-test-id-facet-dimension-value",`${g.title}-${g.dimension}`);s=new this.PieChart(d,c,o,l);s.update(n);const u=$(this.getDomRef()).closest(".sapUshellSearchFacetIconTabBar").find(".sapUshellSearchFacetInfoZeile")[0];const f=a.getElementById(u.id);if(e.iMissingCnt>0){f.setVisible(true);const t=r.getText("infoZeileNumberMoreSelected",[e.iMissingCnt]);f.setText(t);f.rerender()}else{f.setVisible(false)}}else if($(d)[0].className==="largeChart2piechart"){$(d).attr("tabindex","0")}}}});d.isIE=function t(){if(navigator.appName==="Microsoft Internet Explorer"){return true}return false};class h{application;parent;model;chartElements;options;svg;svgArcs;svgLabels;oldArcs;clickedSegment;firstUpdate;xOrigin;yOrigin;tweenGenArc;tweenGenText;arcSequence;constructor(t,e,i,n){this.init(t,e,i,n)}init(t,e,i,n){this.parent=t;this.application=i;this.model=n;this.chartElements=[];const a=d.d3.select(t);let s=$(t).innerHeight();const r=$(t).innerWidth();if(e.height>s){s=e.height}const l=Math.min(r,s)/2;this.options={"dimension-pie":"YEAR",backgroundWidth:r,backgroundHeight:s,width:r,height:s,innerRadius:0,outerRadius:l*.8,tweenGen:h.Tweens.tweenGenSimple,tweenGenText:h.Tweens.tweenGenSimpleText,arcCalculator:h.generateHistoricalArcCalculator(this),animationduration:1500,labelHideThreshold:.05,easing:"linear",pieChartClass:"sap-piechart",pieChartParentClass:"sapUshellSearchFacetPieChart",color:"blue",strokewidth:1,strokewidthHover:3,padding4click:7,multipleselectable:true,oSearchFacetDialog:null};if(e){for(const t in e){this.options[t]=e[t]}}this.createAttributeService(h,"innerRadius",function(){this.init()});this.createAttributeService(h,"outerRadius",function(){this.init()});this.createAttributeService(h,"tweenGen",function(){this.init()});this.createAttributeService(h,"tweenGenText",function(){this.init()});this.createAttributeService(h,"width",function(){this.init()});this.createAttributeService(h,"height",function(){this.init()});this.createAttributeService(h,"animationduration");this.createAttributeService(h,"labelHideThreshold");this.createAttributeService(h,"arcCalculator");const o=Math.round(this.options.width/2);const c=Math.round(this.options.height/2);this.svg=a.append("svg:svg").attr("width",r).attr("height",s).attr("id",t.id+"_svg").append("svg:g").attr("transform","translate("+o+","+c+")");this.svgArcs=this.svg.append("svg:g");this.svgLabels=this.svg.append("svg:g");this.svg.attr("class",this.options.pieChartClass);this.inittween();this.oldArcs=[];this.clickedSegment={};this.firstUpdate=true}getParent(){return this.parent}static Tweens=function(){const t={tweenGenSimple:undefined,tweenGenSimpleText:undefined,translateStr4Padding:undefined,tweenGenEcstasy:undefined,tweenGenLSD:undefined};t.tweenGenSimple=function(t,e,i,n,a,s){const r={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:n,outerRadius:a};const l={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:n,outerRadius:a};const h=d.d3.interpolate(r,l);return function(t){return s(h(t))}};t.tweenGenSimpleText=function(e,i,n,a,s,r,l){let h=" ";if(e.labelElement.childNodes[1]&&e.labelElement.childNodes[1].childNodes[0]&&e.labelElement.childNodes[1].childNodes[0].data){h=e.labelElement.childNodes[1].childNodes[0].data}const c=new o(r.options.width,r.options.height,e.oldArc.startAngle,e.oldArc.endAngle,r.options.outerRadius,e.labelElement.childNodes[1].getBBox().width,e.labelElement.childNodes[1].getBBox().height,r.svgArcGen(e).centroid(e),h,r.svg);c.update();const g=[c.x,c.y];const u=new o(r.options.width,r.options.height,e.startAngle,e.endAngle,r.options.outerRadius,e.labelElement.childNodes[1].getBBox().width,e.labelElement.childNodes[1].getBBox().height,r.svgArcGen(e).centroid(e),h,r.svg);u.update();if(u.labelWidth<e.labelElement.childNodes[1].getBBox().width){r.adjustLabelWidth(e.labelElement,u.labelWidth)}const f=[u.x,u.y];const p=d.d3.interpolateArray(g,f);const A=function(i){let n;if(l){n=t.translateStr4Padding(e.startAngle,e.endAngle,r.options.padding4click,i[0],i[1])}else{n="translate("+i+")"}return n};return function(t){return A(p(t))}};t.translateStr4Padding=function(t,e,i,n,a){const s=e-t;let r=i*Math.sin(s/2);let l=-(i*Math.cos(s/2));const d=r*Math.cos(t)-l*Math.sin(t);l=r*Math.sin(t)+l*Math.cos(t);r=d;const h="translate("+(n+r)+", "+(a+l)+")";return h};t.tweenGenEcstasy=function(t,e,i,n,a,s){const r=Math.round((n+a)/2);let l;let h;if(e%2){l=a;h=r}else{l=r;h=n}let o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:n,outerRadius:a};let c={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:h,outerRadius:l};const g=d.d3.interpolate(o,c);o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:h,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:h,outerRadius:l};const u=d.d3.interpolate(o,c);o={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:h,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:n,outerRadius:a};const f=d.d3.interpolate(o,c);return function(t){if(t<=.25){return s(g(t*4))}if(t<=.75){return s(u((t-.25)*2))}return s(f((t-.75)*4))}};t.tweenGenLSD=function(t,e,i,n,a,s){const r=Math.round((n+a)/2);let l;let h;if(e%2){l=a;h=r}else{l=r;h=n}let o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:n,outerRadius:a};let c={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:h,outerRadius:l};const g=d.d3.interpolate(o,c);o={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:h,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.startAngle+(t.oldArc.endAngle-t.oldArc.startAngle),innerRadius:h,outerRadius:l};const u=d.d3.interpolate(o,c);o={startAngle:t.startAngle,endAngle:t.startAngle+(t.oldArc.endAngle-t.oldArc.startAngle),innerRadius:h,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:h,outerRadius:l};const f=d.d3.interpolate(o,c);o={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:h,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:n,outerRadius:a};const p=d.d3.interpolate(o,c);return function(t){if(t<=.25){return s(g(t*4))}if(t<=.5){return s(u((t-.25)*4))}if(t<=.75){return s(f((t-.5)*4))}return s(p((t-.75)*4))}};return t}();createAttributeService(t,e,i){t.prototype[e]=function(t){if(t===null){return this.options[e]}this.options[e]=t;if(i){i.call(this)}return this}}inittween(){const t=this;t.xOrigin=Math.round(t.options.width/2);t.yOrigin=Math.round(t.options.height/2);t.svg.attr("width",this.options.width).attr("height",this.options.height);this.tweenGenArc=function(e,i,n){return t.options.tweenGen(e,i,n,t.options.innerRadius,t.options.outerRadius,t.svgArcGen(e))};this.tweenGenText=function(e,i,n,a){return t.options.tweenGenText(e,i,n,t.options.innerRadius,t.options.outerRadius,t,a)}}update(t){this.notAnimatedUpdate(t)}notAnimatedUpdate(t){const e=this;let i=[];if(!t){return}this.chartElements=t;e.svgArcs.selectAll("path").remove();e.svgLabels.selectAll("g").remove();let n=0;for(let e=0;e<t.length;++e){n+=t[e].value}for(let e=0;e<t.length;++e){t[e].percentage=t[e].value/n}i=this.options.arcCalculator.calculateNewArcsOnly(t);let a=this.svgArcs.selectAll("path").data(i,h.getIdOfArc);if(!a.exit().empty()){a.exit().remove()}if(!a.empty()){a.attr("d",function(t){const i=e.svgArcGen(t);return i(t)}).attr("transform",function(t){let i;if(t.data.selected){i=h.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,0,0)}else{i="translate(0,0)"}return i}).style("stroke",function(t){let e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected||t.data.hovered){e="#dadada"}else{e="white"}return e}).style("stroke-width",function(t){let i;if(t.data.selected||t.data.hovered){i=e.options.strokewidthHover}else{i=e.options.strokewidth}return i}).style("opacity",function(t){let e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e}).each(function(t){while(this.hasChildNodes()){this.removeChild(this.lastChild)}d.d3.select(this).append("svg:title").text(""+t.data.tooltip)})}a.enter().append("svg:path").attr("data-label",t=>t.data.label).attr("transform",function(t){let i;if(t.data.selected){e.clickedSegment[t.data.id]=this;i=h.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,0,0)}return i}).attr("shape-rendering","geometricPrecision").attr("tabindex","0").style("stroke",function(t){let e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected||t.data.hovered){e="#dadada"}else{e="white"}return e}).style("stroke-width",function(t){let i;if(t.data.selected||t.data.hovered){i=e.options.strokewidthHover}else{i=e.options.strokewidth}return i}).style("opacity",function(t){let e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e}).attr("fill",function(t){return t.data.fill}).on("keydown",function(){const t=d.d3.event;const e=t.keyCode||t.which;if(e==32){t.target.__onclick()}}).on("click",function(t,i){let n;if(t.data.click&&t.data.pieupdateuionly===false){const n=t.data.click(t,i);if(!e.options.multipleselectable&&!n){return}}let a,s;let r;const l=e.getLabelElementtbyLabel(t.data.label);if(l){let i=" ";if(l.childNodes[1]&&l.childNodes[1].childNodes[0]&&l.childNodes[1].childNodes[0].data){i=l.childNodes[1].childNodes[0].data}r=new o(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,l.childNodes[1].getBoundingClientRect().width,l.childNodes[1].getBoundingClientRect().height,e.svgArcGen(t).centroid(t),i,e.svg);r.update();if(r.labelWidth<l.childNodes[1].getBoundingClientRect().width){e.adjustLabelWidth(l,r.labelWidth)}}if(t.data.selected){if(!e.options.multipleselectable&&Object.keys(e.clickedSegment).length>0){delete e.clickedSegment[t.data.id]}a="translate(0,0)";if(l){s="translate("+r.x+","+r.y+")"}t.data.selected=false;if(e.options.oSearchFacetDialog){n={};n.cnt=e.getNumberOfClickedSegments();n.dataObject=t.data;e.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(n)}else{e.model.removeFilterCondition(t.data.filterCondition,true)}}else{if(!e.options.multipleselectable){if(Object.keys(e.clickedSegment).length>0){for(const t in e.clickedSegment){const i=e.clickedSegment[t];if(typeof i.__onclick==="function"){i.__data__.data.pieupdateuionly=true;i.__onclick.apply(i)}delete e.clickedSegment[t]}}if(Object.keys(e.clickedSegment).length<1){e.clickedSegment[t.data.id]=this}}a=h.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,0,0);if(l){s=h.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,r.x,r.y)}t.data.selected=true;if(t.data.filterCondition){if(e.options.oSearchFacetDialog){n={};n.cnt=e.getNumberOfClickedSegments();n.dataObject=t.data;e.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(n)}else{e.model.addFilterCondition(t.data.filterCondition,true)}}}d.d3.select(this).transition().duration(1e3).ease(d.d3.ease("elastic")).attr("transform",a).style("stroke",t=>{let e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected){e="#dadada"}else{e="white"}return e}).style("stroke-width",t=>{let i;if(t.data.selected){i=e.options.strokewidthHover}else{i=e.options.strokewidth}return i}).style("opacity",t=>{let e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e});const c=e.getLabelElementtbyLabel(t.data.label);if(c){d.d3.select(c).transition().duration(1e3).ease(d.d3.ease("elastic")).attr("transform",s)}}).on("mouseover",function(t,i){if(!e.options.multipleselectable&&Object.keys(e.clickedSegment).length>0){return}if(t.data.selected||t.data.hovered){return}if(t.data.mouseover){const n=t.data.mouseover(t,i);if(!e.options.multipleselectable&&!n){return}}}).on("mouseout",function(t,i){if(t.data.selected){d.d3.select(this).style("opacity",1)}if(!e.options.multipleselectable&&Object.keys(e.clickedSegment).length>0){return}if(t.data.selected){return}if(t.data.mouseout){const n=t.data.mouseout(t,i);if(!e.options.multipleselectable&&!n){return}}}).attr("d",t=>{const i=e.svgArcGen(t);return i(t)}).append("svg:title").text(t=>""+t.data.tooltip);a=e.svgLabels.selectAll("g").data(i,h.getIdOfArc);if(!a.exit().empty()){a.exit().remove()}if(!a.empty()){a.style("opacity",function(t){if(t.removed||t.data.percentage<e.options.labelHideThreshold){return 0}return 1}).attr("transform",function(t){let i;let n;if(this.childNodes[1]&&this.childNodes[1].childNodes[0]){n=new o(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,e.svgArcGen(t).centroid(t),t.data.label,e.svg)}else{n=new o(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,e.svgArcGen(t).centroid(t)," ",e.svg)}n.update();if(n.labelWidth<this.childNodes[1].getBoundingClientRect().width){e.adjustLabelWidth(this,n.labelWidth)}if(t.data.selected){i=h.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,n.x,n.y)}else{i="translate("+n.x+","+n.y+")"}return i})}if(!a.enter().empty()){const t=a.enter().append("svg:g").style("opacity",0);t.append("svg:text").attr("class","labelshadow").attr("text-anchor","middle").text(function(t){return""+t.data.label}).style("pointer-events","none");t.append("svg:text").attr("class","label").attr("text-anchor","middle").text(function(t){return""+t.data.label}).style("pointer-events","none");t.style("opacity",function(t){if(t.removed||t.data.percentage<e.options.labelHideThreshold){return 0}return 1}).attr("transform",function(t){let i;const n=new o(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,e.svgArcGen(t).centroid(t),t.data.label,e.svg);n.update();if(n.labelWidth<this.childNodes[1].getBoundingClientRect().width){e.adjustLabelWidth(this,n.labelWidth)}if(t.data.selected){i=h.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,n.x,n.y)}else{i="translate("+n.x+","+n.y+")"}return i})}e.oldArcs=h.removeDeletedArcs(i)}getNumberOfClickedSegments(){let t=0;const e=this.chartElements;for(let i=0;i<e.length;i++){if(e[i].selected===true){t++}}return t}adjustLabelWidth(t,e){const i=t.childNodes[0];const n=t.childNodes[1];if(e<=0){i.childNodes[0].data="";n.childNodes[0].data="";return}let a=i.childNodes[0].data.length;i.childNodes[0].data+="...";let s="";while(i.getBBox().width>e){s=i.childNodes[0].data;s=s.substr(0,a-1)+s.substr(a,3);i.childNodes[0].data=s;a--;if(a<=0){i.childNodes[0].data="";break}}n.childNodes[0].data=i.childNodes[0].data}getArcsWithLabel(t){const e=[];for(let i=0;i<t.length;++i){const n=t[i];if(n.data.percentage>this.options.labelHideThreshold){e.push(n)}}return e}svgArcGen(...t){const e=this;const i=d.d3.svg.arc().innerRadius(function(){return e.options.innerRadius}).outerRadius(function(){return e.options.outerRadius}).startAngle(t=>t.startAngle).endAngle(t=>t.endAngle);return i}getArcElementtbyLabel(t){let e=this;e.svgArcs.selectAll("g").each(function(i){if(i.data.label===t){e=this}return});return e}getLabelElementtbyLabel(t){let e=this;e.svgLabels.selectAll("g").each(function(i){if(i.data.label===t){e=this}});return e}static removeDeletedArcs(t){const e=[];for(let i=0;i<t.length;++i){const n=t[i];if(!n.removed){e.push(n)}}return e}static createZeroArc(t,e){return{startAngle:t,endAngle:t,data:e,removed:true}}insertAfter(t,e,i){let n;if(e>=0){const a=t[e];n=h.createZeroArc(a.endAngle,i.data)}else{n=h.createZeroArc(0,i.data)}n.oldArc=i;t.splice(e+1,0,n)}static getIdOfArc(t){return t.data.id}static arcsGen=function(){return d.d3.layout.pie().value(function(t){return t.value}).sort(null)};static getIndexById(t,e){for(let i=0;i<t.length;++i){const n=t[i];if(h.getIdOfArc(n)===e){return i}}return null}static add2arcSequence(t,e){if(d.isIE()){const i=function(t){e.getIndex(t.id)};t.forEach(i)}return t}static translateStr4Padding(t,e,i,n,a){const s=e-t;let r=i*Math.sin(s/2);let l=-(i*Math.cos(s/2));const d=r*Math.cos(t)-l*Math.sin(t);l=r*Math.sin(t)+l*Math.cos(t);r=d;const h="translate("+(n+r)+", "+(a+l)+")";return h}generateDefaultArcCalculator(){return new u(this)}calculateNewArcsOnly(t){t=t.slice();h.add2arcSequence(t,this.arcSequence);t.sort((t,e)=>this.arcSequence.getIndex(t.id)-this.arcSequence.getIndex(e.id));const e=h.arcsGen()(t);return e}calculateArcs(t,e){const i=h.arcsGen()(e);this.insertMissingArcs(t,i,true);this.insertMissingArcs(i,t,false);return i}insertMissingArcs(t,e,i){let n=-1;for(let a=0;a<e.length;++a){const s=e[a];const r=h.getIndexById(t,s.data.id);let l;if(r!==null){l=t[r];l.oldArc=s;n=r;continue}else{if(i){n=this.determineInsertIndex(t,n,e,a)}let r;if(n>=0){const e=t[n];r=h.createZeroArc(e.endAngle,s.data)}else{r=h.createZeroArc(0,s.data)}r.oldArc=s;t.splice(n+1,0,r);n++}}}determineInsertIndex(t,e,i,n){const a=i[n];const s=this.arcSequence.getIndex(a.data.id);let r;for(r=e+1;r<t.length;++r){const e=this.arcSequence.getIndex(t[r].data.id);if(e>s){break}if(h.getIndexById(i,t[r].data.id)!==null){break}}return r-1}static generateHistoricalArcCalculator(t,...e){return new g(t,e)}}class o{x;y;backgroundWidth;backgroundHeight;startAngle;endAngle;r;labelPaddingX;labelPaddingY;radiusPadding;labelWidth;labelHeight;outsetMin;outsetMax;outsetStep;apexAngle;startLabelWidth;d3centroid;text;svgBackground;translateStr;debug;constructor(t,e,i,n,a,s,r,l,d,h){this.backgroundWidth=t;this.backgroundHeight=e;this.startAngle=i;this.endAngle=n;this.r=a;this.labelPaddingX=3;this.labelPaddingY=3;this.radiusPadding=4.24;this.labelWidth=s+2*this.labelPaddingX;this.labelHeight=r;this.outsetMin=.3;this.outsetMax=1.2;this.outsetStep=.025;this.apexAngle=n-i;this.startLabelWidth=this.labelWidth;this.d3centroid=l;this.text=d;this.svgBackground=h;this.debug=false;this.labelHeight=this.labelHeight+2*this.labelPaddingY;const o=Math.round(this.backgroundWidth/2);const c=Math.round(this.backgroundHeight/2);this.translateStr="translate("+o+","+c+")"}update(){let t=Math.max(this.outsetMin,Math.sin(this.apexAngle/2)/(this.apexAngle/2)*2/3);let e=true;let i=Math.max(100,this.labelWidth*2,1/this.outsetStep);let n=0;let a;do{e=true;a=this.calc(t,this.labelWidth);if(t>this.outsetMax||t<this.outsetMin){break}if(this.labelWidth<0){break}let s,r,l,d;if(n===0){s=this.calc(t+this.outsetStep,this.labelWidth);r=this.calc(t-this.outsetStep,this.labelWidth);l=this.value(s,a);d=this.value(r,a);if(l<d&&d>.5){n=-1;t+=this.outsetStep*n;e=false}else if(l>.5||a.labelWidth<=0){n=1;t+=this.outsetStep*n;e=false}}else{s=this.calc(t+this.outsetStep*n,this.labelWidth);l=this.value(s,a);if(l>.5||a.labelWidth<=0){t+=this.outsetStep*n;e=false}}i--}while(!e&&i>0&&!isNaN(t));a=this.calc(t,this.labelWidth);this.labelWidth=a.labelWidth;const s=a.x;const r=a.y;this.svgBackground.select("circle.centroid").remove();if(this.debug){this.svgBackground.append("svg:circle").attr("class","centroid").attr("cx",a.centroidX).attr("cy",a.centroidY).attr("r",2).style("fill","blue")}this.svgBackground.selectAll("line.helper").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",r-this.labelHeight/2).attr("y2",r-this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",r+this.labelHeight/2).attr("y2",r+this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.startAngle)*(this.r+this.radiusPadding)).attr("x2",this.isStartAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.endAngle)*(this.r+this.radiusPadding)).attr("x2",this.isEndAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding))}if(this.labelWidth<2*this.labelPaddingX){this.labelWidth=0}else if(this.labelWidth<this.startLabelWidth){this.labelWidth=this.labelWidth-2*this.labelPaddingX}this.x=isNaN(s)?0:s;this.y=isNaN(s)?0:r}calc(t,e){let i,n,a,s,r,l;if(this.startAngle-this.endAngle+2*Math.PI<1e-9){i=0;n=0;s=this.backgroundWidth/2;a=-this.backgroundWidth/2;l=-this.r;r=this.r}else{i=Math.sin(this.apexAngle/2)*this.r*t;n=Math.cos(this.apexAngle/2)*-this.r*t;const e=i*Math.cos(this.startAngle)-n*Math.sin(this.startAngle);n=i*Math.sin(this.startAngle)+n*Math.cos(this.startAngle);i=e;const d=n-this.labelHeight/2;const h=n+this.labelHeight/2;a=Math.max(this.calcLeftBorder(i,d),this.calcLeftBorder(i,h),-this.backgroundWidth/2);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))>1e-9&&i>0&&d<=0&&h>=0){a=Math.max(a,0)}if(!this.doesFitHeight(a,d,h,i<0,true)){a=this.backgroundWidth/2}s=Math.min(this.calcRightBorder(i,d),this.calcRightBorder(i,h),this.backgroundWidth/2);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))>1e-9&&i<0&&d<=0&&h>=0){s=Math.min(s,0)}if(!this.doesFitHeight(s,d,h,i<0,false)){s=-this.backgroundWidth/2}let o=this.calcPerimeterBorder(1,n-this.labelHeight/2);if(o<i){o=this.backgroundWidth/2}let c=this.calcPerimeterBorder(1,n+this.labelHeight/2);if(c<i){c=this.backgroundWidth/2}r=Math.min(o,c,s);let g=this.calcPerimeterBorder(-1,n-this.labelHeight/2);if(g>i){g=-this.backgroundWidth/2}let u=this.calcPerimeterBorder(-1,n+this.labelHeight/2);if(u>i){u=-this.backgroundWidth/2}l=Math.max(g,u,a);if(isNaN(r)){r=s}if(isNaN(l)){l=a}}this.svgBackground.select("line.left").remove();this.svgBackground.select("line.right").remove();this.svgBackground.select("line.perimeterLeft").remove();this.svgBackground.select("line.perimeterRight").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","left").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",a).attr("x2",a);this.svgBackground.append("svg:line").attr("class","right").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",s).attr("x2",s);this.svgBackground.append("svg:line").attr("class","perimeterLeft").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",l).attr("x2",l);this.svgBackground.append("svg:line").attr("class","perimeterRight").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",r).attr("x2",r)}const d=e;e=Math.min(e,Math.floor(s-a));let h=i;h=Math.max(h,l+e/2);h=Math.min(h,r-e/2);if(h-e/2<l-1e-9||h+e/2>r+1e-9){h=(l+r)/2}if(i>=0){h=Math.max(h,a+e/2);h=Math.min(h,s-e/2)}else{h=Math.min(h,s-e/2);h=Math.max(h,a-e/2)}const o=n;return{x:h,y:o,labelWidth:e,labelShortened:e!==d,xSpace:s-a,centroidX:i,centroidY:n,asymmetry:Math.abs(h-i)}}value(t,e){if(t.labelWidth<0){return-1e4}if(t.labelWidth<e.labelWidth){return-100}if(t.labelWidth>e.labelWidth){return(t.labelWidth-e.labelWidth)*1e3}if(e.labelShortened&&t.labelWidth===e.labelWidth){return(t.xSpace-e.xSpace)*100}return 0}doesFitHeight(t,e,i,n,a){let s=-Math.cos(this.startAngle)*(this.r+this.radiusPadding);let r=-Math.cos(this.endAngle)*(this.r+this.radiusPadding);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){s=-this.backgroundHeight/2;r=this.backgroundHeight/2}else if(t===0){s=-this.backgroundHeight/2;r=this.backgroundHeight/2}else if(t>0){if(!this.isStartAngleOnRight()){s=-this.backgroundHeight/2}else if(t<=Math.sin(this.startAngle)*(this.r+this.radiusPadding)){s=t/-Math.tan(this.startAngle)}if(!this.isEndAngleOnRight()){r=this.backgroundHeight/2}else if(t<=Math.sin(this.endAngle)*(this.r+this.radiusPadding)){r=t/-Math.tan(this.endAngle)}if(n&&!a&&s>=i){s=-this.backgroundHeight/2}if(n&&!a&&r<=e){r=this.backgroundHeight/2}}else{if(this.isStartAngleOnRight()){s=this.backgroundHeight/2}else if(t>Math.sin(this.startAngle)*(this.r+this.radiusPadding)){s=t/-Math.tan(this.startAngle)}if(this.isEndAngleOnRight()){r=-this.backgroundHeight/2}else if(t>Math.sin(this.endAngle)*(this.r+this.radiusPadding)){r=t/-Math.tan(this.endAngle)}if(!n&&a&&r>=i){r=-this.backgroundHeight/2}if(!n&&a&&s<=e){s=this.backgroundHeight/2}}if(!a){this.svgBackground.selectAll(".rightBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","rightBorder").attr("x",t-3).attr("y",s-3).attr("width",6).attr("height",6).style("fill","green");this.svgBackground.append("svg:circle").attr("class","rightBorder").attr("cx",t).attr("cy",r).attr("this.r",3).style("fill","green")}}else{this.svgBackground.selectAll(".leftBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","leftBorder").attr("x",t-3).attr("y",s-3).attr("width",6).attr("height",6).style("fill","red");this.svgBackground.append("svg:circle").attr("class","leftBorder").attr("cx",t).attr("cy",r).attr("this.r",3).style("fill","red")}}return e>=Math.min(s,r)-1e-9&&i<=Math.max(s,r)+1e-9}calcLeftBorder(t,e){let i=-this.backgroundWidth/2;if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){return i}if(e<=0){if(e>-Math.cos(this.startAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.startAngle)*-e}}else if(e<-Math.cos(this.endAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.endAngle)*-e}return i}calcRightBorder(t,e){let i=this.backgroundWidth/2;if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){return i}if(e>=0){if(-e>Math.cos(this.startAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.startAngle)*-e}}else if(-e<Math.cos(this.endAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.endAngle)*-e}return i}calcPerimeterBorder(t,e){let i=t>0?this.backgroundWidth/2:-this.backgroundWidth/2;i=Math.sqrt(this.r*this.r-e*e);if(t<0){i*=-1}return i}isStartAngleOnRight(){return this.startAngle>0&&this.startAngle<=2*Math.PI/360*180}isEndAngleOnRight(){return this.endAngle%(2*Math.PI)<2*Math.PI/360*180}}class c{maxIndex;objectMap;constructor(...t){this.init(t)}init(...t){this.maxIndex=0;this.objectMap={}}getIndex(t){let e=this.objectMap[t];if(typeof e!=="undefined"){return e}e=this.maxIndex;this.maxIndex++;this.objectMap[t]=e;return e}}class g{_pieChart;constructor(t,...e){this._pieChart=t;this.init(t,e)}init(t,...e){t.arcSequence=new c(e)}calculateNewArcsOnly(t){t=t.slice();h.add2arcSequence(t,this._pieChart.arcSequence);const e=h.arcsGen()(t);return e}calculateArcs(t,e){e=e.slice();h.add2arcSequence(e,this._pieChart.arcSequence);e.sort(function(t,e){return this._pieChart.arcSequence.getIndex(t.id)-this._pieChart.arcSequence.getIndex(e.id)});const i=h.arcsGen()(e);this.insertMissingArcs(t,i);this.insertMissingArcs(i,t);return i}insertMissingArcs(t,e){let i=0;for(let n=0;n<e.length;++n){const a=e[n];const s=this._pieChart.arcSequence.getIndex(a.data.id);let r;let l=false;for(;i<t.length;++i){r=t[i];const e=this._pieChart.arcSequence.getIndex(r.data.id);if(e===s){l=true;break}if(e>s){break}}if(l){r.oldArc=a}else{let e;if(i-1>=0&&i-1<t.length){const n=t[i-1];e=h.createZeroArc(n.endAngle,a.data)}else{e=h.createZeroArc(0,a.data)}t.splice(i,0,e);e.oldArc=a}i++}}}class u{constructor(t,...e){this.init(t,e)}init(t,...e){t.arcSequence=new c(e)}}return d})})();
//# sourceMappingURL=SearchFacetPieChart.js.map