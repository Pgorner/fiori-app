/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../../core/errors","../../core/util","../../sina/ComparisonOperator","../../sina/ComplexCondition","../../sina/SearchQuery","../../sina/SearchResultSetItemAttribute","../../sina/SimpleCondition","../../sina/UserCategoryDataSource","../AbstractProvider","./template","./template2"],function(t,e,i,r,s,a,o,l,n,u,c){"use strict";const h=t["ForcedBySearchTermTestError"];const d=t["NotImplementedError"];const f=e["escapeRegExp"];const m=i["ComparisonOperator"];const g=r["ComplexCondition"];const S=s["SearchQuery"];const p=a["SearchResultSetItemAttribute"];const y=o["SimpleCondition"];const b=l["UserCategoryDataSource"];const C=n["AbstractProvider"];const v=u["createTemplate"];const F=c["createTemplate"];class I extends C{static dataSourceIds={All:"All",Urban_Legends:"Urban_Legends",Folklorists:"Folklorists",Publications:"Publications",Scientists:"Scientists",Mysterious_Sightings:"Mysterious_Sightings"};id;searchQuery;templateProvider;constructor(){super();this.id="sample"}async initAsync(t){this.sina=t.sina;this.templateProvider=v;if(document.location.href.indexOf("use=sample1")>0){this.templateProvider=F}const e=this.templateProvider(this);e._init(e);const i=Promise.resolve({capabilities:this.sina._createCapabilities({fuzzy:false})});return i}getSuggestionList(t){const e=this._stringify(t);const i=new RegExp('"valueFormatted":"([^{/]+?)","valueHighlighted',"g");let r=e.match(i).map(t=>t.replace(i,"$1"));const s=r.toString().split(/\W/);r=r.concat(s);r=r.filter(function(t,e){if(t!==""){return r.indexOf(t)==e}});return r}_stringify(t){let e=[];const i=JSON.stringify(t,function(t,i){if(typeof i==="object"&&i!==null){if(e.indexOf(i)!==-1){return undefined}e.push(i)}return i});e=null;return i}applyFilters(t,e){const i=[];if(e.filter.rootCondition instanceof y){}else{if(e.filter.rootCondition.conditions.length===0||e.filter.rootCondition.conditions[0]instanceof y||e.filter.rootCondition.conditions[0]instanceof g&&e.filter.rootCondition.conditions[0].conditions.length===0){if(e.filter.dataSource instanceof b){const i=e.filter.dataSource.subDataSources;if(i){return t.filter(t=>i.find(e=>e.id===t.dataSource.id))}}return t}}const r=[];const s=[];if(e.filter.rootCondition instanceof y){const t=e.filter.rootCondition;r.push({attribute:t.attribute,operator:t.operator,value:t.value,fits:false});s.push(t.attribute)}else{for(let t=0;t<e.filter.rootCondition.conditions.length;t++){const i=e.filter.rootCondition.conditions[t].conditions;if(i){for(let t=0;t<i.length;t++){r.push({attribute:i[t].attribute,value:i[t].value,operator:i[t].operator,fits:false});s.push(i[t].attribute)}}}}let a=false;for(let e=0;e<t.length;e++){const o=t[e];const l=[];for(let t=0;t<r.length;t++){a=false;for(let e=0;e<o.detailAttributes.length;e++){const i=o.detailAttributes[e];if(i instanceof p){if(i.id===r[t].attribute&&this.checkFilterValueMatch(i.value,r[t].value,r[t].operator)){a=true}}}for(let e=0;e<o.titleAttributes.length;e++){const i=o.titleAttributes[e];if(i instanceof p){if(i.id===r[t].attribute&&this.checkFilterValueMatch(i.value,r[t].value,r[t].operator)){a=true}}}r[t].fits=a;l.push(a)}if(l.toString().match(/false/)===null){i.push(o)}else{const t=[];const e=s.filter(function(t,e){return s.indexOf(t)==e});for(let i=0;i<e.length;i++){a=false;const s=e[i];for(let t=0;t<r.length;t++){if(r[t].attribute===s&&r[t].fits===true){a=true;break}}t.push(a)}if(t.toString().match(/false/)===null){i.push(o)}}}return i}checkFilterValueMatch(t,e,i){switch(i){case m.Co:{return t.toLowerCase().includes(e.toLowerCase())}case m.Eq:{return e===t}case m.Ne:{return e!==t}case m.Gt:{return e>t}case m.Ge:{return e>=t}case m.Lt:{return e<t}case m.Le:{return e<=t}default:{return t===e}}return false}adjustHighlights(t,e){const i=[];let r="";for(let s=0;s<t.length;s++){const a=t[s];let o=true;r="";a.titleHighlighted=this.addHighlight(a.title,e);if(a.titleHighlighted!==a.title){o=false}for(let i=0;i<t[s].detailAttributes.length;i++){const a=t[s].detailAttributes[i];r=a.metadata.type;if(r==="String"||r==="Integer"){a.valueHighlighted=this.addHighlight(a.valueFormatted,e);if(a.valueHighlighted!==a.valueFormatted){o=false}}}for(let i=0;i<t[s].titleAttributes.length;i++){const a=t[s].titleAttributes[i];r=a.metadata.type;if(r==="String"||r==="Integer"||r==="ImageUrl"){a.valueHighlighted=this.addHighlight(a.valueFormatted,e);if(a.valueHighlighted!==a.valueFormatted){o=false}}}if(o===false||e==="*"||e===""){i.push(a)}}return i}addHighlight(t,e){if(typeof t!=="string"||typeof e!=="string"){return t}const i=t.toLowerCase().indexOf(e.toLowerCase());if(i>-1){const r=i+e.length;const s=t.substring(0,i)+"<b>"+t.substring(i,r)+"</b>"+t.substring(r);return s}return t}addSuvLinkToSearchResultItem(t,e,i){const r=this.sina._createSuvNavTargetResolver();if(!e){e="/resources/sap/esh/search/ui/sinaNexTS/providers/sample/docs/folklorist_authors_and_publications.suv"}if(!i){i=[]}const s={};s.obj={suvThumbnailAttribute:t,suvTargetMimeTypeAttribute:{value:"application/vnd.sap.universal-viewer+suv"},suvTargetUrlAttribute:{value:e}};r.resolveSuvNavTargets(null,s,i)}async executeSearchQuery(t){this.searchQuery=t;return new Promise(e=>{let i;const r=this.templateProvider(this);const s=r.searchResultSetItemArray;const a=r.searchResultSetItemArray2;let o=s.concat(a);let l;if(r.searchResultSetItemArray3){l=r.searchResultSetItemArray3;o=o.concat(l)}const n=t.filter.searchTerm;const u=t.filter.dataSource.id;const c=t.filter.dataSource.type;const d=this.generateFacets(t);if(n===h.forcedBySearchTerm){throw new h}let f;if(u===I.dataSourceIds.Scientists||u===I.dataSourceIds.Folklorists){f=this.adjustHighlights(s,n);f=this.applyFilters(f,t);i=this.sina._createSearchResultSet({items:f,facets:d,query:t,title:"",totalCount:f.length})}else if(u===I.dataSourceIds.Mysterious_Sightings||u===I.dataSourceIds.Urban_Legends){f=this.adjustHighlights(a,n);f=this.applyFilters(f,t);i=this.sina._createSearchResultSet({items:f,facets:d,query:t,title:"",totalCount:f.length})}else if(u==="Publications"){f=this.adjustHighlights(l,n);f=this.applyFilters(f,t);i=this.sina._createSearchResultSet({items:f,facets:d,query:t,title:"",totalCount:f.length})}else if(u===I.dataSourceIds.All||c===this.sina.DataSourceType.UserCategory){d[0].items.forEach(t=>{t.measureValue=0;t.measureValueFormatted=""});f=this.adjustHighlights(s,n);f=this.applyFilters(f,t);const e=f.length;f=this.adjustHighlights(a,n);f=this.applyFilters(f,t);const r=f.length;let u=0;if(l){f=this.adjustHighlights(l,n);f=this.applyFilters(f,t);u=f.length}d[0].items[0].measureValue=e;d[0].items[0].measureValueFormatted=""+e;d[0].items[1].measureValue=r;d[0].items[1].measureValueFormatted=""+r;if(l&&d[0].items.length>2){d[0].items[2].measureValue=u;d[0].items[2].measureValueFormatted=""+u}d[0].items=d[0].items.filter(t=>t.measureValue>0);f=this.adjustHighlights(o,n);f=this.applyFilters(f,t);const c=[];for(let e=t.skip;e<t.skip+t.top&&e<f.length;e++){c.push(f[e])}i=this.sina._createSearchResultSet({items:c,facets:d,query:t,title:"",totalCount:f.length})}e(i)})}executeHierarchyQuery(t){throw new d}async executeSuggestionQuery(t){const e=t.filter.searchTerm;const i=this.templateProvider(this);const r=i.searchResultSetItemArray.concat(i.searchResultSetItemArray2).concat(i.searchResultSetItemArray3);const s=this.getSuggestionList(r);const a=new RegExp(`^${f(e)}`,"gi");const o=s.filter(t=>t.match(a));const l=[];const n=e=>{const i=this.sina.SuggestionCalculationMode.Data;const r=t.filter.clone();r.setSearchTerm(e);return this.sina._createSearchTermSuggestion({searchTerm:e,calculationMode:i,filter:r,label:e})};for(let t=0;t<o.length;t++){l.push(n(o[t]))}const u=this.sina._createSuggestionResultSet({title:"Suggestions",query:t,items:l});return new Promise(function(t){t(u)})}async executeChartQuery(t){const e=this.generateFacets(t);let i=1;if(t.dimension==="LOCATION"||e.length===1){i=0}return new Promise(function(t){t(e[i])})}getChartResultSetItemsForLocations(t){const e=[];let i;const r=[];let s,a,o,l,n;for(a=0;a<t.length;a++){n=t[a].detailAttributes;for(o=0;o<n.length;o++){if(n[o].id==="LOCATION"){i=n[o].value;if(r.indexOf(i)===-1){r.push(i);s=this.sina._createChartResultSetItem({filterCondition:this.sina.createSimpleCondition({attribute:"LOCATION",attributeLabel:"Location",operator:this.sina.ComparisonOperator.Eq,value:i}),dimensionValueFormatted:i,measureValue:1,measureValueFormatted:"1"});e.push(s)}else{for(l=0;l<e.length;l++){if(e[l].filterCondition.value===i){e[l].measureValue=e[l].measureValue+1;e[l].measureValueFormatted=""+e[l].measureValue}}}}}}return e}getChartResultSetItemsForPublications(t){const e=[];let i;const r=[];let s,a,o,l,n;for(a=0;a<t.length;a++){n=t[a].detailAttributes;for(o=0;o<n.length;o++){if(n[o].id==="PUBLICATION"){i=n[o].value;if(r.indexOf(i)===-1){r.push(i);s=this.sina._createChartResultSetItem({filterCondition:this.sina.createSimpleCondition({attribute:"PUBLICATION",attributeLabel:"Publication",operator:this.sina.ComparisonOperator.Eq,value:i}),dimensionValueFormatted:i,measureValue:1,measureValueFormatted:"1"});e.push(s)}else{for(l=0;l<e.length;l++){if(e[l].filterCondition.value===i){e[l].measureValue=e[l].measureValue+1;e[l].measureValueFormatted=""+e[l].measureValue}}}}}}return e}getSientistOrFolkloristFacet(t,e){let i;const r=[];let s,a,o,l,n,u;const c=[];for(a=0;a<e.length;a++){n=e[a].titleAttributes;if(t.filter.dataSource.id===I.dataSourceIds.Mysterious_Sightings||t.filter.dataSource.id===I.dataSourceIds.Urban_Legends||t.filter.dataSource.id===I.dataSourceIds.Publications){n=e[a].detailAttributes}for(o=0;o<n.length;o++){if(n[o].id==="SCIENTIST"||n[o].id==="FOLKLORIST"){i=n[o].value;u=n[o].id;if(r.indexOf(i)===-1){r.push(i);s=this.sina._createChartResultSetItem({filterCondition:this.sina.createSimpleCondition({attribute:n[o].id,attributeLabel:n[o].label,operator:this.sina.ComparisonOperator.Eq,value:i}),dimensionValueFormatted:i,measureValue:1,measureValueFormatted:"1"});c.push(s)}else{for(l=0;l<c.length;l++){if(c[l].filterCondition.value===i){c[l].measureValue=c[l].measureValue+1;c[l].measureValueFormatted=""+c[l].measureValue}}}}}}return[c,u]}getTopFacetOnly(t){const e=t.filter.sina.allDataSource;const i=[this.sina._createDataSourceResultSetItem({dataSource:t.filter.sina.dataSources[1],dimensionValueFormatted:e.labelPlural,measureValue:4,measureValueFormatted:"4"}),this.sina._createDataSourceResultSetItem({dataSource:t.filter.sina.dataSources[2],dimensionValueFormatted:e.labelPlural,measureValue:5,measureValueFormatted:"5"})];if(t.filter.sina.dataSources[3]){i[2]=this.sina._createDataSourceResultSetItem({dataSource:t.filter.sina.dataSources[3],dimensionValueFormatted:e.labelPlural,measureValue:1,measureValueFormatted:"1"})}const r=[this.sina._createDataSourceResultSet({title:t.filter.dataSource.label,items:i,query:t})];return r}generateFacets(t){if(t.filter.dataSource.id===I.dataSourceIds.All||t.filter.dataSource.type===this.sina.DataSourceType.UserCategory||t instanceof S&&(t.calculateFacets===undefined||t.calculateFacets===false)){return this.getTopFacetOnly(t)}const e=[];let i;const r=this.templateProvider(this);const s=this.sina.createFilter({searchTerm:this.searchQuery.filter.searchTerm,dataSource:this.searchQuery.filter.dataSource,rootCondition:this.searchQuery.filter.rootCondition.clone()});let a=[];let o;if(t.filter.dataSource.id===I.dataSourceIds.Publications){o=r.searchResultSetItemArray3}else if(t.filter.dataSource.id===I.dataSourceIds.Scientists||t.filter.dataSource.id===I.dataSourceIds.Folklorists){o=r.searchResultSetItemArray}else if(t.filter.dataSource.id===I.dataSourceIds.Urban_Legends||t.filter.dataSource.id===I.dataSourceIds.Mysterious_Sightings){o=r.searchResultSetItemArray2}if(t.filter.dataSource.id===I.dataSourceIds.Scientists||t.filter.dataSource.id===I.dataSourceIds.Mysterious_Sightings){a=this.getChartResultSetItemsForLocations(o);i=this.sina._createChartResultSet({items:a,query:this.sina.createChartQuery({filter:s,dimension:"LOCATION"}),title:"Locations"});e.push(i)}const l=this.getSientistOrFolkloristFacet(t,o);a=l[0];const n=l[1];i=this.sina._createChartResultSet({items:a,query:this.sina.createChartQuery({filter:s,dimension:n}),title:n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()+"s"});e.push(i);return e}}var V={__esModule:true};V.Provider=I;return V})})();
//# sourceMappingURL=Provider.js.map