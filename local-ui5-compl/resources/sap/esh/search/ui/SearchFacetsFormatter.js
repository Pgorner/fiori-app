/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["./error/ErrorHandler","./hierarchydynamic/SearchHierarchyDynamicFacetsFormatter","./hierarchystatic/SearchHierarchyStaticFacetsFormatter","./Facet","./FacetItem","./sinaNexTS/sina/ComparisonOperator","./controls/facets/FacetTypeUI"],function(e,t,a,r,i,o,c){"use strict";function n(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const s=n(e);const u=n(t);const l=n(a);const d=n(r);const h=n(i);const f=o["ComparisonOperator"];const S=c["FacetTypeUI"];class p{searchFacetDialogModel;errorHandler;hierarchyDynamicFacetsFormatter;hierarchyStaticFacetsFormatter;treeQuickSelectDataSourceFacet;constructor(e){this.searchFacetDialogModel=e;this.errorHandler=s.getInstance();this.hierarchyDynamicFacetsFormatter=new u(e);this.hierarchyStaticFacetsFormatter=new l(e)}_getAncestorDataSources(e){const t=[];const a=e.dataSourceTree.findNode(e.getProperty("/uiFilter/dataSource"));if(a){const e=a.getAncestors().reverse();for(let a=0;a<e.length;a++){const r=e[a].dataSource;const i=new h({label:r.labelPlural,icon:r.icon||"sap-icon://none",filterCondition:r,level:0,value:e[a].count?e[a].count.toString():""});t.push(i)}}return t}_getSiblingDataSources(e,t){const a=[];const r=e.getProperty("/uiFilter/dataSource");const i=e.dataSourceTree.findNode(r);let o;if(i.parent&&!i.unsureWhetherNodeisBelowRoot){o=i.parent.getChildren()}else{o=[]}if(o.length===0){o.push(i)}for(let i=0,c=o.length;i<c;i++){const c=o[i].dataSource;const n=new h({label:c.labelPlural,icon:c.icon||"sap-icon://none",value:o[i].count,filterCondition:c,selected:r===c,level:t});a.push(n);if(n.selected){a.push(...this._getChildrenDataSources(e,t+1))}}return a}_getChildrenDataSources(e,t){const a=[];const r=e.getProperty("/uiFilter/dataSource");const i=e.dataSourceTree.findNode(r).getChildren();for(let e=0,r=i.length;e<r;e++){const r=i[e].dataSource;const o=new h({label:r.labelPlural,icon:r.icon||"sap-icon://none",value:i[e].count?i[e].count.toString():"",filterCondition:r,selected:false,level:t});a.push(o)}return a}getDataSourceFacetFromTree(e){const t=new d({facetType:S.DataSource,title:"Search In"});const a=e.getProperty("/uiFilter/dataSource");const r=this._getAncestorDataSources(e);t.items.push(...r);const i=this._getSiblingDataSources(e,e.allDataSource===a?0:1);t.items.push(...i);return t}_createFacetItemsFromConditionGroup(e,t){const a=[];for(let r=0;r<t.conditions.length;r++){const i=t.conditions[r];for(let t=0;t<i.conditions.length;t++){const r=i.conditions[t];let o;if(r.type===this.searchFacetDialogModel.sinaNext.ConditionType.Simple){o=r.attribute;if(e.getAttributeMetadata(o).isHierarchy){continue}a.push(new h({facetAttribute:o,label:this._formatLabel(r.valueLabel,r.operator),filterCondition:r,selected:true}))}else{o=r.conditions[0].attribute;if(e.getAttributeMetadata(o).isHierarchy){continue}a.push(new h({facetAttribute:o,label:r.valueLabel,filterCondition:r,selected:true}))}}}return a}_formatLabel(e,t){let a;switch(t){case f.Bw:a=e+"*";break;case f.Ew:a="*"+e;break;case f.Co:a="*"+e+"*";break;default:a=e;break}return a}getAttributeFacetsFromPerspective(e,t){const a=t.getDataSource();if(a.type===t.sinaNext.DataSourceType.Category){return Promise.resolve([])}const r=e.facets.filter(function(e){return e&&e.type&&e.type===t.sinaNext.FacetType.Chart});const i=[];const o={};for(const a of r){const r=new d({title:a.title,facetType:S.Attribute,dimension:a.query.dimension,totalCount:e.totalCount});if(a.items.length===0){continue}for(let e=0;e<a.items.length;e++){const i=a.items[e];let o="";if(typeof t.config.checkAndSetSpaceIcon==="function"){o=t.config.checkAndSetSpaceIcon(i.icon,a.query.dimension)}else{o=i.icon}const c=new h({facetAttribute:a.query.dimension,label:this._formatLabel(i.dimensionValueFormatted,i.filterCondition.operator),value:i.measureValue,filterCondition:i.filterCondition,icon:o});c.facetTitle=a.title;c["serverSideItem"]=true;r.items.push(c)}o[a.query.dimension]=r;i.push(r)}this.addDataTypeToClientSideFacets(i,t);const c={};const n=this._createFacetItemsFromConditionGroup(a,t.getProperty("/uiFilter/rootCondition"));for(let e=0,t=n.length;e<t;e++){const t=n[e];const a=o[t.facetAttribute];if(a){const e=i.indexOf(a);if(e>0){i.splice(e,1);i.splice(0,0,a)}for(let e=0,r=a.items.length;e<r;e++){const r=a.items[e];if(t.filterCondition.equals(r.filterCondition)){r.selected=true}}}c[t.facetAttribute]=a}return Promise.resolve(i)}addDataTypeToClientSideFacets(e,t){const a=t.getDataSource();for(let t=0;t<e.length;t++){const r=e[t];try{const e=a.getAttributeMetadata(r.dimension);r.dataType=e.type}catch(e){this.errorHandler.onError(e)}}}addQuickSelectDataSourceFacet(e,t){if(e.config.quickSelectDataSources.length===0){return}const a=e.config.quickSelectDataSources[0];let r;if(a.type==="quickSelectDataSourceTreeNode"){r=this.createTreeQuickSelectDataSourceFacet(e)}else{r=this.createListQuickSelectDataSourceFacet(e)}t.push(r)}createListQuickSelectDataSourceFacet(e){return{facetType:S.QuickSelectDataSource,items:e.config.quickSelectDataSources.map(e=>({type:"quickSelectDataSourceListItem",dataSource:e}))}}createTreeQuickSelectDataSourceFacet(e){if(!this.treeQuickSelectDataSourceFacet){this.treeQuickSelectDataSourceFacet={facetType:S.QuickSelectDataSource,items:[{type:"quickSelectDataSourceTreeNode",children:e.config.quickSelectDataSources.map(e=>this.createTreeNodeQuickSelectDataSource(e))}]}}const t=this.treeQuickSelectDataSourceFacet.items[0];this.expandPathToSelectedDataSource(e,t);return this.treeQuickSelectDataSourceFacet}expandPathToSelectedDataSource(e,t){function a(e,t){const a=[];function r(e,i){e=e.slice();e.push(i);if(i.getDataSource&&i.getDataSource()===t){a.push(e);return}if(!i.children){return}for(const t of i.children){r(e,t)}}r([],e);return a}const r=a(t,e.getDataSource());for(const e of r){for(let t=0;t<e.length-1;++t){const a=e[t];a.expanded=true}}}createTreeNodeQuickSelectDataSource(e){let t=[];if(e.children){t=e.children.map(e=>this.createTreeNodeQuickSelectDataSource(e))}return{expanded:false,type:"quickSelectDataSourceTreeNode",label:e.dataSource.labelPlural,icon:e.dataSource.icon,getDataSource:()=>e.dataSource,dataSourceId:e.dataSource.id,children:t,toggleExpand:function(){this.expanded=!this.expanded}}}async getFacets(e,t,a){const r=[];r.push(this.getDataSourceFacetFromTree(a));this.addQuickSelectDataSourceFacet(a,r);if(e===a.appDataSource||e.type===a.sinaNext.DataSourceType.Category){this.sortFacets(r,a);this.setFacetIndex(r);return r}if(!t){this.sortFacets(r,a);this.setFacetIndex(r);return r}const i=await this.hierarchyDynamicFacetsFormatter.getFacets(t,a);r.push(...i);const o=await this.hierarchyStaticFacetsFormatter.getFacets(t);r.push(...o);const c=await this.getAttributeFacetsFromPerspective(t,a);r.push(...c);this.sortFacets(r,a);this.setFacetIndex(r);return r}setFacetIndex(e){for(let t=0;t<e.length;++t){const a=e[t];if(a.setFacetIndex){a.setFacetIndex(t)}else{a.facetIndex=t}}}sortFacets(e,t){const a={[S.DataSource]:-2e3,[S.QuickSelectDataSource]:-1e3,[S.HierarchyStatic]:100,[S.Hierarchy]:1e3,[S.Attribute]:1e3};for(let r=0;r<e.length;++r){const i=e[r];i.position=r;i.position+=a[i.facetType];if(t.config.searchInAttibuteFacetPostion&&typeof t.config.searchInAttibuteFacetPostion[i.dimension]!=="undefined"){i.position=t.config.searchInAttibuteFacetPostion[i.dimension];continue}if(i.facetType===S.Attribute||i.facetType===S.Hierarchy){if(t.getFilterRootCondition().containsAttribute(i.dimension)){i.position-=500}}}e.sort((e,t)=>e.position-t.position)}getDialogFacetsFromMetaData(e,t){const a=[];const r=this.getAttributeDialogFacetsFromMetaData(e,t);a.push(...r);const i=this.hierarchyDynamicFacetsFormatter.getFacetsFromMetadata(e,t);a.push(...i);a.sort(function(e,t){return e.title.localeCompare(t.title)});this.setFacetIndex(a);return a}getAttributeDialogFacetsFromMetaData(e,t){const a=jQuery.map(e.attributeMetadataMap,function(e){return e});const r=[];for(const e of a){if((e.usage.Facet||e.usage.AdvancedSearch)&&e.isHierarchy!==true){const a=new d({title:e.label,facetType:S.Attribute,dimension:e.id,dataType:e.type,matchingStrategy:e.matchingStrategy});if(t.config.showSpaceFacetInShowMoreDialog){if(t.config.showSpaceFacetInShowMoreDialog(e.id)===false){a.visible=false}}const i=this._createFacetItemsFromConditionGroup(t.getDataSource(),t.getProperty("/uiFilter/rootCondition"));let o=0;for(let e=0,t=i.length;e<t;e++){const t=i[e];t.visible=a.visible;if(t.facetAttribute===a.dimension){o++;a.items.splice(0,0,t)}}a["count"]=o;r.push(a)}}return r}getDialogFacetsFromChartQuery(e,t,a,r){const i=new d({dimension:a});if(e){for(let t=0;t<e.items.length;t++){const a=e.items[t];const r=new h({value:a.measureValue,filterCondition:a.filterCondition,label:a.dimensionValueFormatted,facetAttribute:e.query.dimension});i.items.push(r)}let a;if(r){a=r}else{a=this._createFacetItemsFromConditionGroup(t.getDataSource(),t.getProperty("/uiFilter/rootCondition"))}for(let e=0,t=a.length;e<t;e++){const t=a[e];if(t.facetAttribute===i.dimension){let e=false;for(let a=0,r=i.items.length;a<r;a++){const r=i.items[a];if(t.filterCondition.equals(r.filterCondition)){r.selected=true;e=true}}if(!e){i.items.splice(i.items.length,0,t);if(t.filterCondition.userDefined){t.advanced=true}else{t.listed=true;t.value="";t.valueLabel=""}}else{t.listed=true}}}}return i}hasDialogFacetsFromMetaData(e){const t=e.getDataSource();const a=jQuery.map(t.attributeMetadataMap,e=>e);let r=false;for(const e of a){if(e.usage){if(e.usage.Facet||e.usage.AdvancedSearch){r=true;break}}}return r}handleDataSourceChanged(){this.hierarchyDynamicFacetsFormatter.handleDataSourceChanged();this.hierarchyStaticFacetsFormatter.handleDataSourceChanged()}destroy(){this.hierarchyDynamicFacetsFormatter.destroy();this.hierarchyDynamicFacetsFormatter=null;this.hierarchyStaticFacetsFormatter.destroy();this.hierarchyStaticFacetsFormatter=null}}return p})})();
//# sourceMappingURL=SearchFacetsFormatter.js.map