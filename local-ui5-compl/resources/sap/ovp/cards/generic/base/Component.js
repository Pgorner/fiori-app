/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/ViewType","sap/base/util/merge","sap/ovp/app/OVPUtils","sap/ovp/app/OVPLogger","sap/ui/base/Object","sap/ui/core/Component","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/Lib","sap/ui/core/mvc/View"],function(t,e,a,n,i,o,r,s,l,p,d,c,u,f){"use strict";var v=new l("OVP.generic.base.Component");return t.extend("sap.ovp.cards.generic.base.Component",{metadata:{properties:{contentFragment:{type:"string"},controllerName:{type:"string",defaultValue:"sap.ovp.cards.generic.Card"},headerExtensionFragment:{type:"string"},contentPosition:{type:"string",defaultValue:"Middle"},headerFragment:{type:"string",defaultValue:"sap.ovp.cards.generic.Header"},footerFragment:{type:"string"},identificationAnnotationPath:{type:"string",defaultValue:"com.sap.vocabularies.UI.v1.Identification"},selectionAnnotationPath:{type:"string"},filters:{type:"object"},parameters:{type:"object"},addODataSelect:{type:"boolean",defaultValue:false},enableAddToInsights:{type:"boolean",defaultValue:false}},version:"1.132.0",library:"sap.ovp",includes:[],dependencies:{libs:[],components:[]},config:{},interfaces:["sap.ui.core.IAsyncContentCreation"]},setSelectionVariant:function(t,e){if(/^@/.test(t)){t=t.slice(1)}e.selectionAnnotationPath=t},getCustomizing:function(t){return d.getCustomizing(this,{type:t})},setPresentationVariant:function(t,e,a,n){if(/^@/.test(t)&&!n){t=t.slice(1)}e.presentationAnnotationPath=t;var i=t.split("/");var o=i.length===1?a[t].Visualizations:a[i[0]][i[1]][i[2]].Visualizations;var r;for(r=0;r<o.length;r++){var s=n?o[r].$AnnotationPath:o[r].AnnotationPath;if(s){if(/^@/.test(s)){s=s.slice(1)}if(/.LineItem/.test(s)){e.annotationPath=s;break}}}for(r=0;r<o.length;r++){var s=n?o[r].$AnnotationPath:o[r].AnnotationPath;if(s){if(/^@/.test(s)){s=s.slice(1)}if(/.Chart/.test(s)){e.chartAnnotationPath=s;break}}}},setDataPointAnnotationPath:function(t,e){if(/^@/.test(t)){t=t.slice(1)}e.dataPointAnnotationPath=t},getCustomPreprocessor:function(){},getPreprocessors:function(t){var i=this.getComponentData(),o=i.settings,l=i.model,p,d,c,u,f;if(o.description&&!o.subTitle){o.subTitle=o.description}var v=a.isODataV4(l);if(l&&v){p=l&&l.getMetaModel();var h="/"+o.entitySet;var d=p.getObject(h);f=p.createBindingContext(h);if(d&&d["$Type"]){c=p.createBindingContext("/"+d["$Type"]);var g="/"+d["$Type"]+"/@";u=p.getObject(g)}}else if(l&&o.entitySet){p=l&&l.getMetaModel();var m=p.getODataEntitySet(o.entitySet);var y=p.getODataEntitySet(o.entitySet,true);d=p.getODataEntityType(m.entityType);f=p.createBindingContext(y);c=p.createBindingContext(d.$path)}var C=this._getCardPropertyDefaults();var P=this._completeLayoutDefaults(C,o);var b,D;if(i.appComponent&&i.appComponent.getModel("ui")&&i.appComponent.getModel("ui").oData){var A=i.appComponent.getModel("ui").oData;b=A.showDateInRelativeFormat;D=A.disableTableCardFlexibility}else{if(i.showDateInRelativeFormat){b=i.showDateInRelativeFormat}if(i.disableTableCardFlexibility){D=i.disableTableCardFlexibility}}if(i.ovpCardsAsApi&&i.parentView&&typeof i.parentView.getViewName==="function"&&i.parentView.getViewName()!=="sap.ovp.cards.rta.SettingsDialog"){i.settings.enableAddToInsights=false}var V=i&&i.appComponent&&i.appComponent.ovpConfig||{};var I=true;if(i.ovpCardsAsApi){I=false}var T=V.bInsightDTEnabled||V.bInsightRTEnabled||false;if(V.isTeamsModeActive){T=false}var M={metaModel:p,entityType:d,webkitSupport:n.browser.webkit,layoutDetail:P&&P.cardLayout?P.cardLayout.containerLayout:"fixed",bInsightDTEnabled:V.bInsightDTEnabled||false,bInsightRTEnabled:V.bInsightRTEnabled||false,bInsightEnabled:T,showDateInRelativeFormat:b,disableTableCardFlexibility:D,cardId:i.cardId,enableAdditionalActionsManageCards:I};var S=null;if(!!i&&!!i.cardId){var L=i.mainComponent;if(!!L){S=L._getCardFromManifest(i.cardId)?L._getCardFromManifest(i.cardId).template:null}else{S=i.template}if(!!S){M.template=S}if(M.template==="sap.ovp.cards.charts.analytical"){M.enableOVPCardAsAPI=i.ovpCardsAsApi||false}var O=["sap.ovp.cards.v4.charts.analytical","sap.ovp.cards.v4.table","sap.ovp.cards.v4.list"];if(V.enableV4Insight&&O.includes(S)){i.settings.enableAddToInsights=true}}C.densityStyle=a._setCardpropertyDensityAttribute();if(i.errorReason){var w=i.errorReason;var R=w.getParameters?w.getParameters():w.mParameters;var x="sapIllus-UnableToLoad";if(R&&R.response){C.errorStatusCode=R.response.statusCode;C.errorStatusText=R.response.statusText;C.responseText=R.response.responseText;C.sMessageIcon=R.response.sIcon?R.response.sIcon:x}}if(P){M.cardLayout=P.cardLayout}if(C.state!=="Error"){if(o&&o.kpiAnnotationPath){var F=d[o.kpiAnnotationPath];var k=C.contentFragment;if(F&&["sap.ovp.cards.charts.analytical.analyticalChart","sap.ovp.cards.v4.charts.analytical.analyticalChart","sap.ovp.cards.charts.smart.analyticalChart"].includes(k)){var B=F.SelectionVariant&&F.SelectionVariant.Path?F.SelectionVariant.Path:o.kpiAnnotationPath+"/SelectionVariant";if(B){this.setSelectionVariant(B,o)}var _=F.Detail&&F.Detail.DefaultPresentationVariant&&F.Detail.DefaultPresentationVariant.Path?F.Detail.DefaultPresentationVariant.Path:o.kpiAnnotationPath+"/Detail/DefaultPresentationVariant";if(_){this.setPresentationVariant(_,o,d,v)}var E=F.DataPoint&&F.DataPoint.Path?F.DataPoint.Path:o.kpiAnnotationPath+"/DataPoint";if(E){this.setDataPointAnnotationPath(E,o)}}}else if(o&&o.selectionPresentationAnnotationPath){var U=v?"@"+o.selectionPresentationAnnotationPath:o.selectionPresentationAnnotationPath;var j=v?u[U]:d[U];if(j){var B=j.SelectionVariant&&(v?j.SelectionVariant.$Path:j.SelectionVariant.Path);if(B){this.setSelectionVariant(B,o)}var _=j.PresentationVariant&&(v?j.PresentationVariant.$Path:j.PresentationVariant.Path);if(_){var N=v?u:d;this.setPresentationVariant(_,o,N,v)}}}}if(i.ovpCardsAsApi&&o.ignoreSelectionVariant){o.selectionAnnotationPath="";var $=[];for(var H=0;!!o.filters&&H<o.filters.length;H++){$.push({id:"headerFilterText--"+(H+1),index:H})}o.idForExternalFilters=$}if(!!M.entityType&&!!o.selectionAnnotationPath&&!!M.entityType[o.selectionAnnotationPath]){var z=M.entityType[o.selectionAnnotationPath].SelectOptions;for(var K=0;!!z&&K<z.length;K++){z[K].id="headerFilterText--"+(K+1)}M.entityType[o.selectionAnnotationPath].SelectOptions=z}if((M.template==="sap.ovp.cards.linklist"||M.template==="sap.ovp.cards.v4.linklist")&&!!o.staticContent){for(var X=0;X<o.staticContent.length;X++){o.staticContent[X].id="linkListItem--"+(X+1)}if(o.staticContent){C.showRefresh=false}}else if(M.template==="sap.ovp.cards.charts.analytical"||M.template==="sap.ovp.cards.v4.charts.analytical"){o.dataStep=o.dataStep?o.dataStep:10}C=s.merge(true,{},M,C,o);var q=new e(C);var G={xml:{bindingContexts:{entityType:c,entitySet:f},models:{device:a.deviceModel,entityType:p,entitySet:p,ovpMeta:p,ovpCardProperties:q,ovplibResourceBundle:t,ovpConstants:a.ovpConstantModel},ovpCardProperties:q,dataModel:l,_ovpCache:{}}};return r({},this.getCustomPreprocessor(),G)},_completeLayoutDefaults:function(t,e){var a={},n=this.getComponentData(),i=null,o=null;if(n.appComponent){i=n.appComponent.getOvpConfig()}if(!i){return null}if(i.containerLayout==="resizable"&&n.cardId&&t.contentFragment!=="sap.ovp.cards.quickview.Quickview"){o=n.appComponent.getDashboardLayoutUtil();var r=n.cardId;var s=o.aCards.filter(function(t){return t.id===r});a.cardLayout=s[0].dashboardLayout;a.cardLayout.containerLayout=i.containerLayout;a.cardLayout.iRowHeightPx=o.ROW_HEIGHT_PX;a.cardLayout.iCardBorderPx=o.CARD_BORDER_PX;a.cardLayout.headerHeight=s[0].dashboardLayout.headerHeight}return a},_getCardPropertyDefaults:function(){var t={};var e=this.getMetadata().getAllProperties();var a;for(var n in e){a=e[n];if(a.defaultValue!==undefined){t[a.name]=a.defaultValue}}return t},getOvplibResourceBundle:function(){if(!this.ovplibResourceBundle){var t=u.getResourceBundleFor("sap.ovp");this.ovplibResourceBundle=t?new i({bundleUrl:t.oUrlInfo.url}):null}return this.ovplibResourceBundle},_getCacheKeys:function(){var t=this.getComponentData&&this.getComponentData();if(t.ovpCardsAsApi){return}if(t.appComponent&&!p.isA(t.appComponent,"sap.ui.base.ManagedObject")){return}var e=t&&t.settings&&t.settings.isObjectStream;if(e){return}var a=t&&t.model;if(a){var n=[];if(a.metadataLoaded&&typeof a.metadataLoaded==="function"){var i=a.metadataLoaded().then(function(t){var e;if(t&&t.lastModified){e=new Date(t.lastModified).getTime()+""}else{v.error("No valid cache key segment last modification date provided by the OData Model");e=(new Date).getTime()+""}return e});n.push(i)}if(a.annotationsLoaded&&typeof a.metadataLoaded==="function"){var o=a.annotationsLoaded().then(function(t){var e=0;if(t){for(var a=0;a<t.length;a++){if(t[a].lastModified){var n=new Date(t[a].lastModified).getTime();if(n>e){e=n}}}}if(e===0){v.error("No valid cache key segment last modification date provided by OData annotations");e=(new Date).getTime()}return e+""});n.push(o)}return n}},createContent:function(){var t=this.getComponentData&&this.getComponentData();var e=t.model;var n;var i;var r=t&&t.mainComponent;var s=r&&r.oModelViewMap;var l=t&&t.modelName;var p=function(){if(e&&l){e.bIncludeInCurrentBatch=false;if(s&&l&&s[l]&&s[l][t.cardId]){delete s[l][t.cardId];if(Object.keys(s[l]).length>0){e.bIncludeInCurrentBatch=true}}}};if(t&&t.mainComponent){n=t.mainComponent._getOvplibResourceBundle()}else{n=this.getOvplibResourceBundle()}i=this.getPreprocessors(n);var d=this._getCardPropertyDefaults().state;var c=t.cardId+(d?d:"Original");if(!d){c=c+(t.settings.selectedKey?"_Tab"+t.settings.selectedKey:"")}if(t.appComponent&&typeof t.appComponent.createId==="function"){c=t.appComponent.createId(c)}var u={preprocessors:i,type:o.XML,viewName:a.isODataV4(e)?"sap.ovp.cards.v4.generic.Card":"sap.ovp.cards.generic.Card",async:true,id:c};var v=this._getCacheKeys();if(v&&v.length&&v.length>0){u.cache={keys:v}}return f.create(u).then(function(a){if(e&&e.bUseBatch){p()}a.setModel(e);if(t.i18n){a.setModel(t.i18n,"@i18n")}a.setModel(i.xml.ovpCardProperties,"ovpCardProperties");a.setModel(n,"ovplibResourceBundle");return a})}})});
//# sourceMappingURL=Component.js.map