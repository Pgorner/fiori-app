/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/CommonUtils","sap/ovp/cards/AnnotationHelper","sap/ovp/app/OVPUtils","sap/ovp/app/OVPLogger","sap/ovp/cards/NavigationHelper","sap/ovp/insights/IntegrationCard","sap/m/MessageBox","sap/ovp/app/resources","sap/ovp/cards/ViewCacheHelper"],function(e,jQuery,t,a,i,n,s,o,r,d,p,g,l){"use strict";var h=new o("ovp.cards.generic.base.list.BaseList");return e.extend("sap.ovp.cards.generic.base.list",{counter:0,minMaxModel:{},bdataLoadedToEnableAddToInsight:false,onInit:function(){e.prototype.onInit.apply(this,arguments);this.counter=0;this.minMaxModel=new t;this.minMaxModel.setData({minValue:0,maxValue:0});this.getView().setModel(this.minMaxModel,"minMaxModel")},onContactDetailsLinkPress:function(e){var t,a,i;a=e.getSource();t=a.getParent().getAggregation("items")[0];i=a.getBindingContext();if(!i){return}t.bindElement(i.getPath());t.openBy(a)},onAfterRendering:function(){e.prototype.onAfterRendering.apply(this,arguments);var t=this.getCardPropertiesModel().getProperty("/imageSupported");var i=this.getCardPropertiesModel().getProperty("/densityStyle");if(t){var n=this.byId("ovpList");n.attachUpdateFinished(function(){this._addImageCss(i)}.bind(this))}if(!a.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var s=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var o=Math.max(s.dashboardLayout.headerHeight,this.getHeaderHeight());var r=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var d=document.getElementById(r);if(!s.dashboardLayout.autoSpan){d.getElementsByClassName("sapOvpWrapper")[0].style.height=s.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX-(o+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px"}if(s.dashboardLayout.showOnlyHeader){d.classList.add("sapOvpMinHeightContainer")}}var p=this.getCardItemsBinding();if(p&&p.getPath()){p.attachDataReceived(this.onDataReceived.bind(this))}var g=this.byId("ovpList");if(g){g.attachBrowserEvent("click",this.updateControlPressed.bind(this))}},onDataReceived:function(){this.bdataLoadedToEnableAddToInsight=true},_addImageCss:function(e){var t=this.byId("ovpList");var a=t.getItems();var i=false;var n=t.getDomRef().getAttribute("class");if(e==="cozy"){n=n+" sapOvpListImageCozy"}else{n=n+" sapOvpListImageCompact"}t.getDomRef().setAttribute("class",n);a.forEach(function(e){if(e.getIcon().indexOf("icon")!=-1){i=true}});a.forEach(function(t){var a=t.getDomRef();var n;if(a&&a.children[0]&&a.children[0].children[0]){n=a.children[0].children[0]}var s=t.getDescription();var o=t.getIcon();var r=i;var d=t.getTitle();var p=d.split(" ").map(function(e){return e?e[0].toUpperCase():""}).join("").substring(0,2);if(o!=""&&o.indexOf("icon")==-1){i=false}if(i&&a&&a.children[0]){jQuery(a.children[0]).addClass("sapOvpIconListItem")}else if(a&&a.children[0]){jQuery(a.children[0]).addClass("sapOvpImageListItem")}if(n&&e==="cozy"&&i===false){if(n){var g=n.getAttribute("class");g=g+" sapOvpImageCozy";n.setAttribute("class",g)}}var l="";if(i===true&&s===""){l=e==="compact"?"sapOvpListWithIconNoDescCompact":"sapOvpListWithIconNoDescCozy"}else if(i===false&&s===""){l=e==="compact"?"sapOvpListWithImageNoDescCompact":"sapOvpListWithImageNoDescCozy"}else{l=e==="compact"?"sapOvpListWithImageIconCompact":"sapOvpListWithImageIconCozy"}t.addStyleClass(l);if(a&&a.children[0]&&o===""&&a.children[0].id!=="ovpIconImagePlaceHolder"){var h=document.createElement("div");h.innerText=p;h.setAttribute("id","ovpIconImagePlaceHolder");h.className=i===true?"sapOvpIconPlaceHolder":"sapOvpImagePlaceHolder";if(i===false&&e==="cozy"){h.className=h.className+" sapOvpImageCozy"}a.insertBefore(h,a.children[0])}i=r})},onListItemPress:function(e){var t=s.bCRTLPressed?s.constants.explace:s.constants.inplace;s.bCRTLPressed=false;if(a.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(e)}}else{var n=r.getEntityNavigationEntries(e.getSource().getBindingContext(),this.getModel(),this.getEntityType(),this.getCardPropertiesModel(),this.getCardPropertiesModel().getProperty("/annotationPath"));this.doNavigation(e.getSource().getBindingContext(),n[0],t)}},getCardItemsBinding:function(){var e=this.getView().byId("ovpList");return e&&e.getBinding("items")},_getMinMaxObjectFromContext:function(e){this.counter++;var t=this.getModel();var a=i.isODataV4(t);var s=a?this.getEntitySet():this.getEntityType(),o=this.getCardPropertiesModel().getProperty("/annotationPath"),o=a?"@"+o:o,r=a?this.getMetaModel().getData(o).$Annotations[s.$Type][o]:s[o],d=a?this.getMetaModel().createBindingContext("/"+s.$Type+"/@"+o):this.getMetaModel().createBindingContext(s.$path+"/"+o),p={minValue:0,maxValue:0};var g=n.isFirstDataPointPercentageUnit(d,r);if(g){p.minValue=0;p.maxValue=100;p.isPercentage=true;return p}var l=n.getFirstDataPointValue(d,r),h=this.getView().byId("ovpList"),c=h.getBinding("items"),v=c.getCurrentContexts();for(var m=0;e?m<e:m<v.length;m++){if(v[m]){var u=a?v[m].getValue(l):t.getOriginalProperty(l,v[m]),f=parseFloat(u,10);if(f<p.minValue){p.minValue=f}else if(f>p.maxValue){p.maxValue=f}}}return p},_updateMinMaxModel:function(e){var t=this._getMinMaxObjectFromContext(e);this.minMaxModel.setData({minValue:t.minValue,maxValue:t.maxValue,isPercentage:t.isPercentage||false});this.minMaxModel.refresh();return t},returnBarChartValue:function(e){this._updateMinMaxModel();var t=parseFloat(e,10);return t},getCardItemBindingInfo:function(){var e=this.getView().byId("ovpList");return e.getBindingInfo("items")},resizeCard:function(e,t){var a,i,n;try{var s=document.getElementById(this.oDashboardLayoutUtil.getCardDomId(this.cardId)),o=this.getCardItemBindingInfo(),r=this.getHeaderHeight(),d=this.getView(),p=d.byId("ovpCardContentContainer").getDomRef();if(e.showOnlyHeader){p.classList.add("sapOvpContentHidden");a=0}else{p.classList.remove("sapOvpContentHidden");n=r+t.dropDownHeight;i=e.rowSpan*e.iRowHeightPx-n;a=Math.abs(Math.floor(i/t.itemHeight));s.style.height=e.rowSpan*e.iRowHeightPx+"px"}p.style.height=e.rowSpan*e.iRowHeightPx-(r+2*e.iCardBorderPx)+"px";if(a!==o.length){o.length=a;e.noOfItems=o.length;this._updateMinMaxModel(o.length);this.getCardItemsBinding().refresh();var g=this.getCardPropertiesModel().getProperty("/tabs");if(g&&g.length>0){l.clearViewCacheForTabbedCard(d)}}else{this._handleCountHeader()}}catch(e){h.warning("OVP resize: "+this.cardId+" catch "+e.toString())}},onShowInsightCardPreview:function(){var e=this.getView();var t=e.getController();var a=t.oCardComponentData;var i=this;if(this.checkIBNNavigationExistsForCard()){d.showCard({entitySet:t.entitySet,entityType:t.entityType,cardComponentName:"List",cardComponentData:a,cardComponent:t.oCardComponent,itemBindingInfo:i.getCardItemBindingInfo(),view:e}).then(function(e){i.saveGeneratedCardManifest(e)})}else{p.error(g.getText("INT_IBN_NAVIGATION_NOT_FOUND_ERROR_MESSAGE_TEXT"),{details:g.getText("INT_IBN_NAVIGATION_NOT_FOUND_ERROR_MESSAGE_VIEW_DETAILS_TEXT")})}},onExit:function(){e.prototype.onExit.apply(this,arguments)}})});
//# sourceMappingURL=BaseList.controller.js.map