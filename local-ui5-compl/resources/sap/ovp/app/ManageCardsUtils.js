/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ui/core/Fragment","sap/ovp/cards/PersonalizationUtils","sap/ovp/cards/CommonUtils"],function(a,e,r,t,i,s){"use strict";return a.extend("sap.ovp.app.ManageCardsUtils",{constructor:function(a){if(!a){throw new Error("Main Controller is required to initialize ManageCardsUtil")}},onManageCardsMenuButtonPress:function(){this.aManageCardsDialogModelState=[];var a=s.getApp();var d=this;var n={onManageCardOkButtonPressed:function(e){if(e.getParameters().reason==="Ok"){var r=a.byId("manageCardsSelectionPanel").getP13nData();var t=a.getUIModel().getProperty("/aOrderedCards");var s=[];var n=r.length;for(var o=0;o<n;o++){if(r[o].visible!==t[o].visible){s.push({changeType:"visibility",content:{cardId:r[o].id,visibility:r[o].visible},isUserDependent:true})}r[o].visibility=r[o].visible}a.createOrDestroyCards.apply(a,[d.aManageCardsDialogModelState,r,false]);a.getUIModel().setProperty("/aOrderedCards",r);a.updateDashboardLayoutCards(r);var l=a.getOwnerComponent().oOvpConfig,g=l&&l.bInsightRTEnabled;if(g){a.updateCardVisibiltyForCM(r)}a.updateLayoutWithOrderedCards();i.savePersonalization(s,a.getView());for(var o=0;o<r.length;o++){var v=r[o];var u=a.aErrorCards.indexOf(v.id);if(u>-1&&v.visibility==false){a.aErrorCards.splice(u,1)}}if(document.querySelector(".sapFAvatar")){document.querySelector(".sapFAvatar").focus()}}var f=a.byId("manageCardsSelectionPanel");var p=a.byId("manageCardsDialog");if(f&&p){f.destroy();p.destroy()}},onManageCardResetButtonPressed:function(){var e=a.getLayout().getMetadata().getName();var t=a.getUIModel();var i=t.getProperty("/aOrderedCards");a.createOrDestroyCards.apply(a,[i,a.aManifestOrderedCards,e==="sap.ovp.ui.DashboardLayout"?true:false]);var s=a.getAllowedNumberOfCards();if(s&&s.numberOfCards){var n=s.numberOfCards;for(var o=0;o<a.aManifestOrderedCards.length;o++){var l=a.aManifestOrderedCards[o];if(o>=n){l.visibility=false}}}t.setProperty("/aOrderedCards",a.aManifestOrderedCards);a.resetDashboardLayout();a.updateDashboardLayoutCards(a.aManifestOrderedCards);a.updateLayoutWithOrderedCards();d.manageCardsDialog.getModel().setProperty("/cards",a.aManifestOrderedCards);var g=[];for(var v=0;v<i.length;v++){g.push(a.getView().byId(i[v].id))}var u=d.enhanceOrderedCardsForP13NDialog(i);var f=a.byId("manageCardsSelectionPanel");f.setP13nData(u);if(s){d.setMsgStripAndOkButton(f,a)}r.reset({selectors:g}).finally(function(){if(document.querySelector(".sapFAvatar")){document.querySelector(".sapFAvatar").focus()}})},onCardVisibilityChange:function(){var e=a.byId("manageCardsSelectionPanel");var r=a.getAllowedNumberOfCards();if(r){d.setMsgStripAndOkButton(e,a)}}};this.oManageCardsFragment=t.load({id:a.getView().getId(),name:"sap.ovp.app.ManageCard",controller:n}).then(function(r){d.manageCardsDialog=r;var t=a.getUIModel().getProperty("/aOrderedCards");var i=Object.assign([],t);d.aManageCardsDialogModelState=d.getManageCardsDialogModelState(t);var s=new e({cards:i});d.manageCardsDialog.setModel(s);a.getView().addDependent(d.manageCardsDialog);d.openManageCardsDialog(t)})},openManageCardsDialog:function(a){var e=s.getApp();var r=this.enhanceOrderedCardsForP13NDialog(a);var t=e.byId("manageCardsDialog");var i=e.byId("manageCardsSelectionPanel");i.setP13nData(r);var d=this.getAllowedNumberOfCardsAndSetMessageStripText(e);var n=a.filter(function(a){return a.visibility===true});var o=e.byId("manageCardsPanelWarningMessage");if(d&&a.length>=d&&n.length>=d){o.setVisible(true)}t.open()},enhanceOrderedCardsForP13NDialog:function(a){var e=[];var r=s.getApp();a.forEach(function(a){e.push(a["id"])});var t=r._getCardsModel();var i=[];var d=r.getLayout().getMetadata().getName();if(d==="sap.ovp.ui.DashboardLayout"){var n=r._getCardArrayAsVariantFormatDashboard();n.forEach(function(a){var r=t.find(function(e){return e.id===a.id});var d=s.getUpdatedTitle(a.id);if(e.indexOf(a.id)!=-1){i.push({id:a.id,visibility:a.visibility,visible:a.visibility,name:a.id,label:d||r.settings.title})}});a=i}else if(d==="sap.ovp.ui.EasyScanLayout"){var o=r.getLayout().getContent();var t=r._getCardsModel();o.forEach(function(a){var r=a.getId();var d=r.split("--").pop();var n=t.find(function(a){return a.id===d});var o=s.getUpdatedTitle(d);if(e.indexOf(d)!=-1){i.push({id:d,visibility:a.getVisible(),visible:a.getVisible(),name:d,label:o||n.settings.title})}});a=i}this.aManageCardsDialogModelState=this.getManageCardsDialogModelState(a);r.getUIModel().setProperty("/aOrderedCards",a);this.manageCardsDialog.getModel().setProperty("/cards",a);return a},getManageCardsDialogModelState:function(a){var e=[];for(var r=0;r<a.length;r++){e.push({id:a[r].id,visibility:a[r].visibility})}return e},getAllowedNumberOfCardsAndSetMessageStripText:function(a){var e=a.getAllowedNumberOfCards();var r=e&&e.numberOfCards;var t=e&&e.errorMessage;var i=a.byId("manageCardsPanelWarningMessage");i.setText(t);i.setVisible(false);return r},setMsgStripAndOkButton:function(a,e){var r=a.getSelectedFields().length;var t=this.getAllowedNumberOfCardsAndSetMessageStripText(e);var i=e.byId("manageCardsPanelWarningMessage");var s=e.byId("manageCardsDialog").sId;var d=e.byId(s+"-confirmBtn");d.setEnabled(true);if(t&&r>=t){i.setVisible(true)}if(t&&r>t){d.setEnabled(false)}}})});
//# sourceMappingURL=ManageCardsUtils.js.map