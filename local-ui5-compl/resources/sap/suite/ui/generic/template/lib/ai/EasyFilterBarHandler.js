sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/suite/ui/generic/template/lib/filterHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/ui/model/FilterOperator"],function(e,t,a,r,i){"use strict";var n=new r("lib.ai.EasyFilterBarHandler").getLogger();function o(e,t,r){var o={};var s;var l,u;var c;function f(){return new Promise(function(t){e.oIappStateHandler.onFEStartupInitialized().then(function(){p().then(function(e){t(e)})})})}function p(){var n=[];var l;var u={};var c=e.oSmartFilterbar;var f=c.getModel();var p=f.getMetaModel();var m=t.getOwnerComponent().getEntitySet();var g={};var v=r.oCommonUtils.getMetaModelEntityType(m);v.property.map(function(e){var t="ValueHelp";if(a.isPropertyFilterable(e)){var r;e.extensions&&e.extensions.forEach(function(e){if(e.name==="value-list"&&e.value==="fixed-values"){t="MenuWithCheckBox";r=true}});if(e.type==="Edm.DateTime"&&e["sap:display-format"]==="Date"||e.type==="Edm.String"&&e["com.sap.vocabularies.Common.v1.IsCalendarDate"]&&e["com.sap.vocabularies.Common.v1.IsCalendarDate"].Bool==="true"){t="Calendar"}else if(e.type==="Edm.DateTimeOffset"){t="Time"}g[e.name]={name:e.name,dataType:e.type,defaultValue:[],filterable:true,sortable:false,codeList:r,type:t,unit:e["sap:unit"]||"",required:e["sap:required-in-filter"]==="true"?true:false}}});s={version:1,entitySet:m,fields:[]};u=c.getFilterData()||{};c.getAllFilterItems().forEach(function(e){var t=g[e.getName()];if(t){var a=u[e.getName()];if(a){var r=[];if(a.ranges&&a.ranges.length>0){r=a.ranges.map(function(e){if(e.exclude===false){if(e.operation==="BT"){return{operator:i.BT,selectedValues:[{value1:e.value1,value2:e.value2}]}}else{return{operator:e.operation,selectedValues:[e.value1]}}}else{return{operator:i.NE,selectedValues:[e.value1]}}})}else if(a.items&&a.items.length>0){a.items.forEach(function(e){r.push({operator:i.EQ,selectedValues:[e.key]})})}else if(a){r=[{operator:i.EQ,selectedValues:[a]}]}t.defaultValue=r}t.label=e.getLabel();if(t.codeList){var c=p.getODataProperty(v,t.name,true);var m=p.createBindingContext(c);var h=p.getODataValueLists(m);n.push(h);h.then(function(e){if(o[t.name]){t.codeList=o[t.name]}else{t.codeList=function(){return d(t,e,f)}}s.fields.push(t)})}else{s.fields.push(t)}}else if(e.getName()==="EditState"){l=e}});if(r.oComponentUtils.isDraftEnabled()){var h=t.byId("editStateFilter");if(h){var y=h.getItems().map(function(e){return{value:e.getKey(),description:e.getText()}});var S={name:l.getName(),label:l.getLabel(),dataType:"Edm.String",filterable:true,required:false,sortable:false,type:"MenuWithSingleSelect",codeList:y};s.fields.push(S)}}return Promise.allSettled(n).then(function(){return s})}function d(e,t,a){if(o[e.name]){return o[e.name]}return new Promise(function(r,i){var n=t[""];if(n){var l=n.Parameters&&n.Parameters.map(function(e){return e.ValueListProperty.String}).join(",");var u=function(t){var a=[];t.results&&t.results.forEach(function(e){a.push({value:e[c],description:f?e[f]:undefined})});o[e.name]=a;s.fields.forEach(function(t){if(t.name===e.name){t.codeList=a}});r(a)};a.read("/"+n.CollectionPath.String,{$select:l,success:u,error:i});var c;var f;n.Parameters&&n.Parameters.forEach(function(t){if(t.LocalDataProperty&&t.LocalDataProperty.PropertyPath===e.name){c=t.ValueListProperty.String}else{f=t.ValueListProperty.String}})}})}function m(e){var t=[];var a=0;e.forEach(function(e){if(e.key==="EditState"){a=e.keySpecificSelectedValues[0].selectedValues[0]}else{var r={PropertyName:e.key,Ranges:[]};e.keySpecificSelectedValues.forEach(function(e){e.selectedValues.forEach(function(t){var a={Sign:"I",High:""};if(e.operator==="Contains"){a.Option="CP";a.Low=t}else if(e.operator==="BT"||e.operator==="NB"){a.Low=t[0];a.High=t[1]}else{a.Option=e.operator;a.Low=t}r.Ranges.push(a)})});t.push(r)}});return{aSelectOptions:t,oEditStateFilter:a}}function g(){return t.byId("template::easyFilterContainer")}function v(){var e=g();var a=f();var i=t.getOwnerComponent().getEntitySet();a.then(a=>{e.setContextPath(i);e.setAppId(t.getOwnerComponent().getAppComponent().getManifestEntry("sap.app").id);e.setFilterBarMetadata(a.fields);e.easyfilter=r.oServices.oFioriAIHandler.fioriaiLib.EasyFilter})}function h(t){var a=e.oSmartFilterbar;a.search()}function y(e){u()}function S(e){l=new Promise(function(e){u=e});r.oComponentUtils.getBusyHelper().setBusy(l)}function E(t){var a=e.oSmartFilterbar;var i=t.getParameter("tokens");var n=a.getId();var o=r.oCommonUtils.getControlStateWrapperById(n,"SmartFilterBar");var s=o.getState();var l=m(i);var u=Object.keys(s.customFilters.appExtension);if(u.length>0){u.forEach(function(e){s.customFilters.appExtension[e]=""})}s.selectOptions=l.aSelectOptions;if(r.oComponentUtils.isDraftEnabled()){s.customFilters.editState=l.oEditStateFilter}o.setState(s);a.getSmartVariant()&&a.getSmartVariant().currentVariantSetModified(true);a.search()}function F(t){var a=e.oSmartFilterbar;c=t.getParameter("resolve");a.associateValueLists();try{a.openValueHelpRequestForFilterItem(t.getParameter("key"))}catch(e){n.error("Value help cannot be triggered for the field "+t.getParameter("key"))}}function P(){}function V(e){var t=e.getParameters("mParameters");var a=[];var r;if(t.sId==="change"&&c){r=t.getParameter("filterChangeReason");e.getSource().getFilters().forEach(function(e){e.aFilters&&e.aFilters.forEach(function(e){e=e.aFilters?e.aFilters:[e];e.forEach(function(e){if(e.sPath===r){var t={operator:"",selectedValues:[]};var i=a.find(function(t){return t.operator===e.sOperator});if(i){a.forEach(function(t){if(t.operator===e.sOperator){t.selectedValues.push(e.oValue1)}})}else{t.operator=e.sOperator;t.selectedValues.push(e.oValue1);a.push(t)}}})})});c(a)}}function b(t){var a=r.oComponentUtils.getTemplatePrivateModel();if(!t.getParameter("context")&&a.getProperty("/listReport/filterMode")!=="classic"){var i=e.oSmartFilterbar;a.setProperty("/listReport/filterMode","classic");i.setVisible(true)}}return{getEasyFilterBar:g,initialiseEasyFilterBar:v,getSFBVariantData:m,getEasyFilterSearchMetadata:f,onClearFilters:h,onAfterQueryProcessing:y,onBeforeQueryProcessing:S,onQueryChanged:P,onTokensChanged:E,onShowValueHelp:F,onFilterChange:V,handleVariantLoad:b}}return e.extend("sap.suite.ui.generic.template.lib.ai.EasyFilterBarHandler",{constructor:function(e,a,r){t(this,o(e,a,r))}})});
//# sourceMappingURL=EasyFilterBarHandler.js.map