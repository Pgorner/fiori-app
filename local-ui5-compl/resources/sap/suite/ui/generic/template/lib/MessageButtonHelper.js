sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/lib/ai/ErrorExplanationHelper"],function(e,t,r,n,a,o,i,s,l){"use strict";t=o.observableConstructor(t,true);var u=new t({path:"persistent",operator:r.EQ,value1:false});var c=new t({path:"technical",operator:r.EQ,value1:false});var p=new t({path:"validation",operator:r.EQ,value1:true});var f=new t({filters:[p,new t({path:"validation",operator:r.EQ,value1:false})],and:true});function g(e,r,o){var i=r.controller;var g=i.getOwnerComponent();var v=g.getModel("ui");var m=new n({isPopoverOpen:false,messageToGroupName:Object.create(null),isAIErrorExplanationEnabled:false});var d=i.byId("showMessages");var P=e.oComponentUtils.isDraftEnabled();var h=false;var b;var E;var M;var T;var y=[];function O(t,r,n){var a=!!(n&&r&&e.oCommonUtils.getPositionableControlId(r));var o=a&&m.getProperty("/messageToUpdateFunction");var i=o&&o[t];(i||Function.prototype)();return a}function C(e,t,r,n){var a=n&&e&&t&&T?T.getSubtitle(e,r):r;return a}var S=o&&!P?v.getProperty.bind(v,"/createMode"):function(){return false};var w=f;var x,U;e.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.fragments.MessagePopover",{afterClose:function(){m.setProperty("/isPopoverOpen",false);U.sort([])},beforeOpen:function(){x.navigateBack();m.setProperty("/isPopoverOpen",true)},isPositionable:O,generateErrorExplanation:function(t){l.generateErrorExplanation(t,i,e)},getSubtitle:C,titlePressed:function(t){a.navigateFromMessageTitleEvent(e,t,g,P,b)}}).then(function(t){x=t;x.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"msg");x.setModel(m,"helper");U=x.getBinding("items");U.filter(w);m.setProperty("/isAIErrorExplanationEnabled",l.isErrorExplanationEnabled(e));var r=e.oComponentUtils.getTemplatePrivateModel();r.setProperty("/generic/messageButtonInfo",{count:0,tooltip:e.oCommonUtils.getText("MESSAGE_BUTTON_TOOLTIP_P",[0])});U.attachChange(function(t){var n=U.getLength();var a=0;var o={count:n};if(n>0){if(m.getProperty("/isPopoverOpen")){var i=t.getParameters();if(i.reason!=="sort"){Y(true)}}var s=U.getAllCurrentContexts();var l,u,c;s.forEach(function(e){var t=e.getObject();switch(t.type){case"Error":a++;break;case"Warning":l=true;break;case"Success":u=true;break;default:c=true}});if(a>0){o.severity="Negative";o.icon="sap-icon://message-error"}else if(l){o.severity="Critical";o.icon="sap-icon://message-warning"}else if(c){o.severity="Neutral";o.icon="sap-icon://message-information"}else if(u){o.severity="Success";o.icon="sap-icon://message-success"}}o.label=""+(a||"");o.tooltip=e.oCommonUtils.getText(n===1?"MESSAGE_BUTTON_TOOLTIP_S":"MESSAGE_BUTTON_TOOLTIP_P",[n]);r.setProperty("/generic/messageButtonInfo",o);y.forEach(function(e){e()})})});var A=new t({filters:[p,new t({path:"controlIds",test:function(t){return!!e.oCommonUtils.getPositionableControlId(t)},caseSensitive:true})],and:true});var B=[];var F=0;var I;var _;function N(e){if(Array.isArray(e)){var t=false;for(var r=0;r<e.length;r++){t=N(e[r])||t}return t}if(e instanceof Promise){e.then(I);return false}_.push(e);return true}function j(e){w=e;if(U){U.filter(w)}}function H(){if(h){E=new t({filters:_,and:false});var r=[E,u];if(e.oServices.oApplication.needsToSuppressTechnicalStateMessages()){r.push(c)}M=new t({filters:r,and:true});j(new t({filters:[M,A],and:false}))}}function L(e,t){if(e===F&&N(t)){H()}}function D(e){var t=e();return N(t)}function k(){B.forEach(D)}function G(e){b=e;F++;I=L.bind(null,F);var r=S();_=o?[new t(r?{path:"aTargets",test:function(e){return e.some(function(e){return e.startsWith(b)})}}:{path:"aFullTargets",test:function(e){return e.some(function(e){return e.startsWith(b)})}})]:[];k();H()}function Q(e){B.push(e);if(_&&D(e)){H()}}var W;function J(){W=W||function(){if(U.getLength()>0){x.openBy(d)}};setTimeout(function(){var e=Y();e.then(W)},0)}function q(e){h=e;if(e){if(_){H()}}else{_=null;j(f)}}function z(e){return e?A:w}function K(e){return e?M:E}function R(e){var t=S(),r=!t&&s.analyseContextPath(b,e),n=t?b:r.canonicalPath,a=b;return{target:n,fullTarget:a}}function V(){var e=m.getProperty("/isPopoverOpen")?Promise.resolve():Y();e.then(function(){x.toggle(d)})}var X=Object.create(null);function Y(t){var n=e.oServices.oApplication.getBusyHelper();var a=Object.create(null);var o=false;var i=U.getAllCurrentContexts().map(function(e){var t=e.getObject();o=o||!X[t.id];a[t.id]=t;return t});X=o?a:X;var s=o&&r.getPrepareMessageDisplayPromise?r.getPrepareMessageDisplayPromise(i,U,m,b):Promise.resolve(T);if(!t){e.oServices.oApplication.setNextFocus(Function.prototype);n.setBusy(s)}return s.then(function(e){T=e})}function Z(e){y.push(e)}return{adaptToContext:G,toggleMessagePopover:V,showMessagePopover:J,registerMessageFilterProvider:Q,setEnabled:q,getMessageFilters:z,getContextFilter:K,getTargetInfo:R,registerExternalListener:Z}}return e.extend("sap.suite.ui.generic.template.lib.MessageButtonHelper",{constructor:function(e,t,r){i(this,o.testableStatic(g,"MessageButtonHelper")(e,t,r))}})});
//# sourceMappingURL=MessageButtonHelper.js.map