sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/fe/navigation/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject","sap/ui/core/format/NumberFormat"],function(e,t,r,n,a,i,o,s,l,u,p,c,f){"use strict";var g=new o("lib.multipleViews.MultipleViewsHandler").getLogger();function m(e,o,m){var d=Object.create(null);var v=o.oComponentUtils.getTemplatePrivateModel();var S=m.pathInTemplatePrivateModel+"/items";var y=m.pathInTemplatePrivateModel+"/selectedKey";v.setProperty(m.pathInTemplatePrivateModel,Object.create(null));v.setProperty(S,Object.create(null));var h=new(m.mode==="single"?n:r)(e,o,m);v.setProperty(m.pathInTemplatePrivateModel+"/mode",h.getMode());var C;var b=new Promise(function(e){C=e});var P=o.oServices.oApplication.getBusyHelper().getBusyDelay();var O=e.getOwnerComponent().getModel();var F;var T;var E=[];var M;function w(){if(T){var e=m.getSearchValue&&m.getSearchValue();var t=e?{search:e}:{};var r=(h.getBatchGroupIdForCount||Function.prototype)();for(var n in d){var a=d[n];var i=a.getPath();a.numberOfUpdates++;a.updateStartFunction(a.numberOfUpdates);O.read(i+"/$count",{urlParameters:t,filters:a.getFiltersForCount&&a.getFiltersForCount(),groupId:r,success:a.updateSuccessFunction.bind(null,a.numberOfUpdates),error:a.errorFunction.bind(null,a.numberOfUpdates)})}}}function B(e,t){var r="";var n=t["parameters"];if(!t||!t.entitySetName||!t.navPropertyName||n.length<1){r="/"+e.name;return r}var i=m.smartFilterBar&&m.smartFilterBar.getAnalyticalParameters();if(i&&i.length>0){var o=m.smartFilterBar&&m.smartFilterBar.getUiState({allFilters:false});var s=o?JSON.stringify(o.getSelectionVariant()):"{}";var l=new a(s);var c=[];n.forEach(function(e){i.forEach(function(t){if(t&&t.name===e){var r=t.name;var n=l.getParameter(r);if(t.type==="Edm.DateTime"||t.type==="Edm.DateTimeOffset"){n=new Date(n);n=p.localToUtc(n)}else if(t.type==="Edm.String"&&t["sap:parameter"]==="optional"){if(n===undefined){n=""}}n=u(t.control.getModel().formatValue(n,t.type));c.push(r+"="+n)}})});r="/"+t.entitySetName+"("+c.join(",")+")/"+t.navPropertyName}else{r="/"+e.name;g.error("SelectionParameters","There are no parameters to resolve");return r}return r}function I(t){var r;var n=t.getEntitySet();var a=e.getOwnerComponent();if(m.smartFilterBar&&m.smartFilterBar.getConsiderAnalyticalParameters&&m.smartFilterBar.getConsiderAnalyticalParameters()){var o=O.getMetaModel();var s=o.getODataEntitySet(n);var l=a.getAppComponent();var u=i.getParametersByEntitySet(l.getModel(),n);r=m.resolveParameterizedEntitySet?m.resolveParameterizedEntitySet(s,u):B(s,u);return r}var p=t.getBindingPath();r=p?p:"/"+n;var c=a.getComponentContainer();var f=c.getElementBinding();return f?f.getPath()+"/"+r:r}function U(e,r){var n=O.getMetaModel();var a=n.getODataEntityType(n.getODataEntitySet(e.getEntitySet()).entityType);var i=[],o;var s=r.variantAnnotationPath;if(s){var l=a[s];if(!l){return[]}if(!l.SelectOptions&&l.SelectionVariant){l=l.SelectionVariant;if(l.Path){s=l.Path.split("@")[1];l=s&&a[s]}}if(l.AnnotationPath){o=l.AnnotationPath.split("@")[1];l=a[o]}for(var u in l.SelectOptions){if(l.SelectOptions[u].PropertyName){var p=l.SelectOptions[u].PropertyName.PropertyPath;for(var c in l.SelectOptions[u].Ranges){var f=l.SelectOptions[u].Ranges[c].Sign&&l.SelectOptions[u].Ranges[c].Sign.EnumMember;var g=l.SelectOptions[u].Ranges[c].Option&&l.SelectOptions[u].Ranges[c].Option.EnumMember;g=f?V(f.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","")):g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var m=l.SelectOptions[u].Ranges[c].Low;var d=l.SelectOptions[u].Ranges[c].High;var v=R(m);if(d){var S=R(d);i.push(new t(p,g,v,S))}else{i.push(new t(p,g,v))}}}}}return i}function V(e,t){var r;var n=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(e==="I"){r=t}else if(e==="E"){if(n.has(t)){r=n.get(t)}else{r=t}}return r}function R(e){var t;if(e){if(e.String){t=e.String}else if(e.Bool){t=e.Bool.toLowerCase()==="true"}else{var r=Object.keys(e)[0];t=e[r]}}return t}function H(e){for(var t in d){var r=d[t];if(r.presentationControlHandler.getEntitySet()===e){return t}}return""}function A(e){return!!H(e)}function N(e){return e&&D().presentationControlHandler.getEntitySet()!==e&&H(e)||M}function K(e,t){if(T){var r=h.getCommonFiltersForCounts?h.getCommonFiltersForCounts(e.filters,t):e.filters;for(var n in d){var a=d[n];a.getFiltersForCount=x.bind(null,r,a,true)}}var i=D();e.filters=x(e.filters,i,false)}function x(e,t,r){if(h.getFiltersAdaptedFromItem){e=h.getFiltersAdaptedFromItem(e,t,r)}return e.concat(t.selectionVariantFilters)}function D(){return d[M]}function L(e,t){return h.formatMessageStrip(e,t)}function j(){return M}function G(){return h.getMode()}function z(e){if(!e){e=F}M=e;v.setProperty(y,M)}function W(){return h.getContentForIappState(M)}function _(e){var t;if(!e){return""}if(e.state==="error"){return o.oCommonUtils.getText("SEG_BUTTON_ERROR",e.text)}if(e.state===""||e.state==="busy"){var r=f.getIntegerInstance({groupingEnabled:true});t=r.format(e.count)}return o.oCommonUtils.getText("SEG_BUTTON_TEXT",[e.text,e.state==="busyLong"?"...":t])}function k(e){M=h.getSelectedKeyAndRestoreFromIappState(e);if(d[M]){v.setProperty(y,M)}}var q={getState:j,setState:z,attachStateChanged:ne};function Q(){return h.getSFBVariantContentStateWrapper(q)}function J(){return h.getGeneralContentStateWrapper(q)}function X(){return d[M].templateSortOrder}function $(e){var t=D();if(e!==2){t.presentationControlHandler.rebind()}if(e>1){if(m.refreshModelOnTableRefresh){var r=o.oCommonUtils.refreshModel(t.presentationControlHandler.getEntitySet());if(r){re(t.presentationControlHandler)}}t.presentationControlHandler.refresh()}}function Y(e,t,r){var n=Array.isArray(t);var a=o.oComponentUtils.isComponentActive();if(n&&t.length===0||r&&c(r)){return}h.refreshOperation(e,t,r,M,n,a,$)}function Z(e,t){if(h.setControlVariant){h.setControlVariant(e,t)}}function ee(e,t,r,n){return o.oCommonUtils.getCustomDataText(e).then(function(e){r.text=e;n.text=e;return{modelEntry:r,pathToTheItem:t}})}function te(e){v.setProperty(e.pathToTheItem,e.modelEntry)}function re(e){if(h.refreshSiblingControls){h.refreshSiblingControls(e)}}function ne(e){E.push(e)}function ae(){return Object.keys(d)}(function(){s.testable(function(){return h},"getImplementingHelper");s.testable(function(){return T},"getShowCounts");s.testable(function(){return d[M]},"getCurrentViewMeta");var e=function(e,t,r,n){if(e.numberOfUpdates!==r){return}var a=S+"/"+e.switchingKey;var i=l({},v.getProperty(a));if(!i.state&&t=="busy"){setTimeout(function(){if(v.getProperty(a).state==="busy"){i=l({},v.getProperty(a));i.state="busyLong";v.setProperty(a,i)}},P)}i.state=t;if(!t){i.count=n}v.setProperty(a,i)};m.getSwitchingControlAsync().then(function(t){var r=t?t.getItems():[];for(var n=0;n<r.length;n++){var a=r[n];var i=a.getKey();if(n===0){F=i}var s={presentationControlHandler:m.getPresentationControlHandler(i),switchingKey:i};var l=o.oCommonUtils.getElementCustomData(a);var u=S+"/"+s.switchingKey;var p=Object.create(null);p.text=l.text;p.count=0;p.state="";p.facetId=m.sectionKey;ee(a,u,p,s).then(te);s.templateSortOrder=l.TemplateSortOrder;s.getPath=I.bind(null,s.presentationControlHandler);s.selectionVariantFilters=U(s.presentationControlHandler,l);s.numberOfUpdates=0;s.updateStartFunction=e.bind(null,s,"busy");s.updateSuccessFunction=e.bind(null,s,"");s.errorFunction=e.bind(null,s,"error");d[i]=s}if(h.init){h.init(d,Y,D)}if(m.manifestSettings.showCounts===undefined){T=h.getDefaultShowCounts()}else{T=m.manifestSettings.showCounts}z(M);var c=v.bindProperty(y);c.attachChange(function(e){var t=e.getSource().getValue();E.forEach(function(e){e(t,M)});M=t;if(h.onSelectedKeyChanged){h.onSelectedKeyChanged(t)}var r=m.isDataToBeShown();var n=h.getRefreshMode(M);if(m.adaptRefreshRequestMode){n=m.adaptRefreshRequestMode(n);if(r&&n>0){$(n)}else{D().presentationControlHandler.setEnabledToolbarButtons()}}m.appStateChange()});C()})})();return{updateCounts:w,refreshOperation:Y,onRebindContentControl:K,formatMessageStrip:L,getSelectedKey:j,setSelectedKey:z,getContentForIappState:W,restoreFromIappState:k,getSFBVariantContentStateWrapper:Q,getGeneralContentStateWrapper:J,formatItemTextForMultipleView:_,determineSortOrder:X,setControlVariant:Z,hasEntitySet:A,getPreferredKey:N,refreshSiblingControls:re,resolveParameterizedEntitySet:B,getMode:G,registerKeyChange:ne,getKeys:ae,getInitializationPromise:function(){return b}}}return e.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(e,t,r){l(this,m(e,t,r))}})});
//# sourceMappingURL=MultipleViewsHandler.js.map