sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger"],function(e,t,n,i){"use strict";var o=new i("detailTemplates.DiscardEditHandler").getLogger();function r(e,t,i,r){var a=t.oComponentUtils.isDraftEnabled();var s=t.oComponentUtils.getCRUDActionHandler();var c=t.oServices.oApplication.getBusyHelper();var l=e.getView();var u=l.getModel("ui");var f=t.oComponentUtils.getTemplatePrivateModel();var p=f.setProperty.bind(f,"/objectPage/cancelEnabled");var g;var v;var d=false;var m=false;var C;var y;if(a&&t.oComponentUtils.getViewLevel()!==1){y=Function.prototype}function D(){y();C=null;y=null}function P(){m=false;if(d){g.close()}else{D()}}function h(e,i){if(!v){v=t.oCommonUtils.getDialogFragmentAsync("sap.suite.ui.generic.template.fragments.DiscardEditPopover",{onDiscardConfirm:function(){if(!d||m){return}C();p(true)},beforeClose:function(){d=false;if(!m){D()}},afterClose:function(){p(true);setTimeout(function(){var t=n.getControlWithFocus();if(t&&t.isFocusable()){o.debug("Discard draft is not confirmed. Focus will stay on "+t.getId())}else if(e.isFocusable()){o.debug("Setting back focus on the Cancel button");n.focusUI5Control(e)}else{o.debug("Focus not set here. Should be handled elsewhere.")}},0)}},"discard",function(e,t){t.setProperty("/placement",sap.m.PlacementType.Top)})}v.then(function(n){d=true;g=n;var o=g.getModel("discard");var r=t.oCommonUtils;if(a&&i){o.setProperty("/text",r.getText("CANCEL_AND_DISCARD"))}else if(!a&&i){o.setProperty("/text",r.getText("CANCEL_AND_DISCARD_ND"))}else{o.setProperty("/text",r.getText("DISCARD_EDIT"))}p(false);g.openBy(e)})}function A(){if(a){var n=l.getBindingContext();return t.oServices.oApplication.getNavigateAfterDraftCancelPromise(n).then(function(n){return function(){t.oServices.oViewDependencyHelper.setRootPageToDirty();t.oServices.oViewDependencyHelper.unbindChildren(e.getOwnerComponent());t.oServices.oApplication.invalidatePaginatorInfo();n()}})}return Promise.resolve(function(){if(u.getProperty("/createMode")){var n=e.getOwnerComponent().getModel("_templPrivGlobal");var i=n.getProperty("/generic/FCL");return i&&i.highestViewLevel===1?t.oServices.oNavigationController.navigateToRoot():t.oServices.oNavigationController.navigateBack()}})}function b(){return new Promise(function(e){if(a){var n=l.getBindingContext();var i=n.getPath();s.hasValidationMessageOnDetailsViews().then(function(n){var o=t.oServices.oApplication.getIsDraftModified(i)||n;e(o)})}else{e(t.oComponentUtils.isComponentDirty())}})}function S(){if(a){var e=l.getBindingContext();var t=e.getObject();var n=t.hasOwnProperty("HasActiveEntity")&&!e.getProperty("IsActiveEntity")&&!e.getProperty("HasActiveEntity");return n}return u.getProperty("/createMode")}function E(e,n){if(y){return Promise.reject()}if(!(t.oComponentUtils.isComponentActive()&&u.getProperty("/editable"))){return Promise.reject()}var i=new Promise(function(i,o){y=o;var r=A();var s=function(){if(e&&c.isBusy()){D();return}var o=function(){m=true;var e=r.then(function(e){var o=function(){y=i;e();P();if(n){t.oServices.oApplication.setNextFocus(n)}};var r;if(a){r=t.oServices.oCRUDManager.discardDraft(l.getBindingContext()).then(o);r.catch(P)}else{o()}t.oComponentUtils.cancelEdit(r);return r});c.setBusy(e)};b().then(function(t){if(e&&t){C=o;h(e,S())}else{o()}})};t.oServices.oApplication.performAfterSideEffectExecution(s)});i.catch(Function.prototype);return i}return{discardEdit:E}}return e.extend("sap.suite.ui.generic.template.detailTemplates.DiscardEditHandler",{constructor:function(e,n,i,o){t(this,r(e,n,i,o))}})});
//# sourceMappingURL=DiscardEditHandler.js.map