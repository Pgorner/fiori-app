/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/gantt/library","sap/ui/core/Element","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/base/util/ObjectPath","../misc/Utility","../misc/Format","../misc/RelativeTimeFormatter","../config/TimeHorizon","../misc/AxisTime","sap/ui/core/date/CalendarUtils","sap/base/i18n/Localization","sap/base/i18n/Formatting","sap/gantt/utils/GanttChartConfigurationUtils","sap/gantt/polyfills/lib"],function(e,t,i,a,o,n,r,s,l,p,m,g,u,T,h,f){"use strict";var c=i.extend("sap.gantt.axistime.AxisTimeStrategyBase",{metadata:{library:"sap.gantt",abstract:true,properties:{timeLineOptions:{type:"object"},timeLineOption:{type:"object"},coarsestTimeLineOption:{type:"object"},finestTimeLineOption:{type:"object"},zoomLevels:{type:"int",defaultValue:10},zoomLevel:{type:"int",defaultValue:0},calendarType:{type:"string",defaultValue:sap.ui.core.CalendarType.Gregorian},locale:{type:"object"},firstDayOfWeek:{type:"int"},mouseWheelZoomType:{type:"sap.gantt.MouseWheelZoomType",defaultValue:t.MouseWheelZoomType.FineGranular},calendarWeekNumbering:{type:"sap.ui.core.date.CalendarWeekNumbering",defaultValue:null},_discontinuousProvider:{type:"object",multiple:false,visibility:"hidden"}},aggregations:{totalHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},visibleHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},skipTimePattern:{type:"sap.gantt.skipTime.SkipPattern",multiple:false},_axisTime:{type:"sap.gantt.misc.AxisTime",multiple:false,visibility:"hidden"}}}});c.prototype.applySettings=function(e){e=e||{};if(!e.visibleHorizon){e.visibleHorizon=t.config.DEFAULT_VISIBLE_HORIZON.clone()}if(!e.totalHorizon){e.totalHorizon=t.config.DEFAULT_TOTAL_HORIZON.clone()}this.checkFirstDayOfWeek(e);l._oDefaultDateTimeFormat=n.getDateTimeWithTimezoneInstance({showTimezone:false});i.prototype.applySettings.call(this,e);this.calZoomBase();return this};c.prototype.setSkipTimePattern=function(e,t){var i=this.getParent();if(i){var a=i.getLocale();if(a){e.setLocale(a)}}var o=e?e.getDiscontinuityProvider():null;this.setAggregation("skipTimePattern",e,true);delete this._nGanttVisibleWidth;this.setProperty("_discontinuousProvider",o,t)};c.prototype.clone=function(){var e=i.prototype.clone.apply(this,arguments);if(e.hasListeners("_redrawRequest")){e.mEventRegistry._redrawRequest.forEach(function(t){e.detachEvent("_redrawRequest",t.fFunction,t.oListener)})}return e};c.prototype.exit=function(){T.detachChange(this._onLocalizationChanged.bind(this));h.detachChange(this._onLocalizationChanged.bind(this))};c.prototype.setParent=function(e){i.prototype.setParent.apply(this,arguments);var t=this.getAggregation("skipTimePattern");if(t){var a=e.getLocale();if(a){t.setLocale(a)}}};c.prototype.isTimePeriodZoomEnabled=function(){return true};c.prototype._setVisibleHorizon=function(e){var t=this._completeTimeHorizon(e);var i=this.getAggregation("visibleHorizon");if(i){i.setStartTime(t.getStartTime(),true);i.setEndTime(t.getEndTime(),true)}else{this.setAggregation("visibleHorizon",t,true)}return this};c.prototype.setVisibleHorizonWithReason=function(e,t,i){this._setVisibleHorizon(e);return this};c.prototype._completeTimeHorizon=function(e){var t=this.getVisibleHorizon(),i=this.getTotalHorizon();if(t===null||i===null){return e}var a=new m({startTime:t.getStartTime(),endTime:t.getEndTime()});if(e){var o=e.getStartTime(),n=e.getEndTime(),r,s=l.abapTimestampToDate(i.getStartTime()),p=l.abapTimestampToDate(i.getEndTime());if(!o&&!n){return a}var g;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined&&this.getAxisTime()){var u=this.getAxisTime().getZoomRate();var T=this._oZoom.base.scale/u;g=this._nGanttVisibleWidth*T}else{g=l.abapTimestampToDate(a.getEndTime()).getTime()-l.abapTimestampToDate(a.getStartTime()).getTime()}if(!o){r=l.abapTimestampToDate(n);r.setTime(r.getTime()-g);if(r<s){r=s;n=l.dateToAbapTimestamp(new Date(s+g))}o=l.dateToAbapTimestamp(r)}else if(!n){r=l.abapTimestampToDate(o);r.setTime(r.getTime()+g);if(r>p){r=p;o=l.dateToAbapTimestamp(new Date(p-g))}n=l.dateToAbapTimestamp(r)}else{r=l.abapTimestampToDate(o);if(r<s){o=this.getTotalHorizon().getStartTime()}r=l.abapTimestampToDate(n);if(r>p){n=this.getTotalHorizon().getEndTime()}}a.setStartTime(o);a.setEndTime(n)}return a};c.prototype.createAxisTime=function(t){var i=this.getTimeLineOption(),a=this.getVisibleHorizon(),o=this.getTotalHorizon();if(!s.judgeTimeHorizonValidity(a,o)){if(this.getVisibleHorizon()){this.getVisibleHorizon().setStartTime(o.getStartTime(),true);this.getVisibleHorizon().setEndTime(o.getEndTime(),true)}else{this.setAggregation("visibleHorizon",o.clone(),true)}e.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.AxisTimeStrategyBase.createAxisTime()")}var n=l.getTimeStampFormatter().parse(o.getStartTime());var p=l.getTimeStampFormatter().parse(o.getEndTime());var m=p.valueOf()-n.valueOf();var u=r.get(i.innerInterval.unit).offset(n,i.innerInterval.span).valueOf()-n.valueOf();var T=[n,p];var h=this._getTimeLineRange(i);var f=[0,Math.ceil(m*h/u)];var c=this.getProperty("_discontinuousProvider");if(c){var d=c.distance(n,p);f=[0,Math.ceil(d*h/u)]}var v=new g(T,f,1,null,null,t,this);this.setAggregation("_axisTime",v,true)};c.prototype.syncContext=function(e){var t={zoomLevel:undefined,axisTimeChanged:false};return t};c.prototype.updateStopInfo=function(e){return null};c.prototype._setTotalHorizon=function(e,t){if(typeof t==="undefined"){t=true}if(e){var i=this.getAggregation("totalHorizon");if(i){i.setStartTime(e.getStartTime(),true);i.setEndTime(e.getEndTime(),true)}else{this.setAggregation("totalHorizon",e,t)}}return this};c.prototype.getUpperRowFormatter=function(){var e=this.getTimeLineOption();var t=e.largeInterval;var i;if(t.relativeTime){var o=l.abapTimestampToDate(this.getTotalHorizon().getStartTime());i=new p(o,t.unit,t.relativeTimePrefix)}else{var r=this.getCalendarType(),s=this.getCalendarWeekNumbering(),m=this.getLocale()?this.getLocale():new a(f.getLanguage().toLowerCase());i=n.getDateTimeWithTimezoneInstance({format:t.format,pattern:t.pattern,style:t.style,calendarType:e.calendarType||r,calendarWeekNumbering:s,showTimezone:false},t.locale?new a(t.locale):m)}return i};c.prototype.getLowerRowFormatter=function(){var e=this.getTimeLineOption();var t=e.smallInterval;var i;if(t.relativeTime){var o=l.abapTimestampToDate(this.getTotalHorizon().getStartTime());i=new p(o,t.unit,t.relativeTimePrefix)}else{var r=this.getCalendarType(),s=this.getCalendarWeekNumbering(),m=this.getLocale()?this.getLocale():new a(f.getLanguage().toLowerCase());i=n.getDateTimeWithTimezoneInstance({format:t.format,pattern:t.pattern,style:t.style,calendarType:r,calendarWeekNumbering:s,showTimezone:false},t.locale?new a(t.locale):m)}return i};c.prototype.getCalendarWeekNumbering=function(){var e=this.getProperty("calendarWeekNumbering");return e||f.getCalendarWeekNumbering()};c.prototype._getCalendarWeekConfig=function(){return u.getWeekConfigurationValues(this.getCalendarWeekNumbering())};c.prototype.isLowerRowTickHourSensitive=function(){var e=this.getTimeLineOption();var t=e.innerInterval.unit;var i=e.innerInterval.span;var a=l.getTimeStampFormatter().parse("20000101000000");var o=r.get(t).offset(a,i);return o.getTime()-a.getTime()<=60*60*1e3};c.prototype.getAxisTime=function(){return this.getAggregation("_axisTime")};c.prototype.fireRedrawRequest=function(e,t,i,a,o){this.fireEvent("_redrawRequest",{forceUpdate:e,reasonCode:t,valueBeforeChange:i,originEvent:a,subReasonCode:o})};c.prototype.updateGanttVisibleWidth=function(e){this._nGanttVisibleWidth=e};c.prototype.getGanttVisibleWidth=function(){return this._nGanttVisibleWidth};c.prototype.calZoomScale=function(e,t,i){var a=l.getTimeStampFormatter().parse("20000101000000");var o=r.get(e).offset(a,t);return this.calZoomScaleByDate(a,o,i)};c.prototype.calZoomScaleByDate=function(e,t,i){return(t.valueOf()-e.valueOf())/i};c.prototype.calZoomBase=function(){var e=this.getTimeLineOption()||this.getFinestTimeLineOption();if(e){var t=this.calZoomScale(e.innerInterval.unit,e.innerInterval.span,this._getTimeLineRange(e));this._oZoom={base:{timeLineOption:e,rate:1,scale:t}};return true}return false};c.prototype.checkFirstDayOfWeek=function(e){if(typeof e.firstDayOfWeek==="undefined"){var t=this._getCalendarWeekConfig();if(t){e.firstDayOfWeek=t.firstDayOfWeek}else{e.firstDayOfWeek=o.getInstance(f.getLanguageTag()).getFirstDayOfWeek()}T.attachChange(this._onLocalizationChanged.bind(this));h.attachChange(this._onLocalizationChanged.bind(this))}};c.prototype._getTimeLineRange=function(e){return typeof e.innerInterval.range==="function"?e.innerInterval.range():e.innerInterval.range};c.prototype.updateVisibleHorizonOnMouseWheelZoom=function(e,i,a,o){var n=i<0;var r=Math.round(Math.abs(i)/100);var s=this.getMouseWheelZoomType();if(s===t.MouseWheelZoomType.FineGranular){this.updateVisibleHorizonOnFineGranularMouseWheelZoom(e,n,r,a,o)}else if(s===t.MouseWheelZoomType.Stepwise){this.updateVisibleHorizonOnStepWiseMouseWheelZoom(e,n,r,a,o)}};c.prototype.updateVisibleHorizonOnFineGranularMouseWheelZoom=function(e,t,i,a,o){var n=this.getVisibleHorizon();var s=l.abapTimestampToDate(n.getStartTime());var p=this.getTimeLineOption();var m=r.get(p.innerInterval.unit).offset(s,i*p.innerInterval.span).getTime()-s.getTime();var g=t?-1:1;var u=this.calVisibleHorizonByDelta(g*m,e);var T=o?"syncVisibleHorizon":"mouseWheelZoom";this.setVisibleHorizonWithReason(u,T,a)};c.prototype.updateVisibleHorizonOnStepWiseMouseWheelZoom=function(e,t,i,a,o){var n=t?-1:1;var r=this.getZoomLevel()-n*i;if(r>-1&&r<this.getZoomLevels()){if(this._aZoomRate[r]&&!s.floatEqual(this._aZoomRate[r],this._oZoom.rate)){this.setZoomLevel(r)}}};c.prototype.calVisibleHorizonByRate=function(e,t){var i=0;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined){var a=l.abapTimestampToDate(this.getVisibleHorizon().getStartTime());var o=l.abapTimestampToDate(this.getVisibleHorizon().getEndTime());var n=o.getTime()-a.getTime();var r=this._oZoom.base.scale/e;var s=this._nGanttVisibleWidth*r;i=s-n}return this.calVisibleHorizonByDelta(i,t)};c.prototype.calVisibleHorizonByDelta=function(e,t){var i=this.getVisibleHorizon();e=Math.round(e)||0;if(e!==0){var a=l.abapTimestampToDate(i.getStartTime()).getTime();var o=l.abapTimestampToDate(i.getEndTime()).getTime();var n=o-a;var r=0;var s;var p=l.abapTimestampToDate(this.getTotalHorizon().getStartTime()).getTime();var g=l.abapTimestampToDate(this.getTotalHorizon().getEndTime()).getTime();if(e>0&&a<=p){s=0;r=p}else if(e>0&&o>=g){s=1;r=g}else{if(!t){r=a+n/2}else{r=t.getTime()}s=(r-a)/n}var u=n+e;var T=Math.floor(r-s*u);if(T<=p){T=p}var h=T+u;if(h>=g){T=T-Math.abs(g-h);h=g;if(T<=p){T=p}}return new m({startTime:new Date(T),endTime:new Date(h)})}return i};c.prototype.calMiddleDate=function(e,t){return new Date(e.getTime()+(t.getTime()-e.getTime())/2)};c.prototype._onLocalizationChanged=function(){var e=this._getCalendarWeekConfig();if(e){this.setFirstDayOfWeek(e.firstDayOfWeek)}else{this.setFirstDayOfWeek(o.getInstance(f.getLanguageTag()).getFirstDayOfWeek())}var t=this.getParent();if(t&&t.getEnablePseudoShapes&&t.getEnablePseudoShapes()){if(!t.pseudoShapeSpecificData){t.pseudoShapeSpecificData={}}t.pseudoShapeSpecificData.needUpdateForTasksInAggr=true}l._oDefaultDateTimeFormat=n.getDateTimeWithTimezoneInstance({showTimezone:false})};c.prototype._updateZoomControlType=function(e){return null};return c},true);
//# sourceMappingURL=AxisTimeStrategyBase.js.map