/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/gantt/library","sap/base/util/ObjectPath","sap/gantt/axistime/AxisTimeStrategyBase","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/gantt/config/TimeHorizon","sap/gantt/axistime/ProportionTimeLineOptions"],function(t,e,o,i,a,s,n,r){"use strict";var l=i.extend("sap.gantt.axistime.ProportionZoomStrategy",{metadata:{library:"sap.gantt",properties:{enableMillisecondSupport:{type:"boolean",defaultValue:false,bindable:false}}}});l.prototype.init=function(){this._aZoomRate=new Array(10);this.setProperty("coarsestTimeLineOption",r["1month"],true);this.setProperty("finestTimeLineOption",r["5min"],true);this.setProperty("timeLineOptions",r,true);this.setProperty("timeLineOption",r["4day"],true);this.setProperty("zoomLevel",0,true);this.setProperty("zoomLevels",10,true);this._disableAutoProportion=false};l.prototype.applySettings=function(t){this._applyMissingSettings(t);i.prototype.applySettings.call(this,t);this.initialSettings=t;return this};l.prototype.setVisibleHorizon=function(t){this.setVisibleHorizonWithReason(t,"visibleHorizonUpdated");return this};l.prototype.setEnableMillisecondSupport=function(t){this.setProperty("enableMillisecondSupport",t);s._setEnableMillisecondSupport(t);return this};l.prototype._applyMissingSettings=function(){if(this.getEnableMillisecondSupport()){s._setEnableMillisecondSupport(true)}};l.prototype.setVisibleHorizonWithReason=function(t,e,o,a){if(t&&!t.getStartTime()&&!t.getEndTime()){this._bHorizontalScroll=false}else{this._bHorizontalScroll=!!(t&&(!t.getStartTime()||!t.getEndTime()))}var s=this.getVisibleHorizon();if(s){s=s.clone()}i.prototype._setVisibleHorizon.apply(this,arguments);if(s){this.fireRedrawRequest(false,e,s,o,a)}return this};l.prototype.setTotalHorizon=function(t){i.prototype._setTotalHorizon.apply(this,arguments);if(this.getAxisTime()){this.calZoomBase();this.createAxisTime(this.getAxisTime().getLocale());this.fireRedrawRequest(true,"totalHorizonUpdated")}return this};l.prototype.updateStopInfo=function(t){this.setZoomLevel(t.index);return this};l.prototype.setZoomLevel=function(t){performance.mark("ProportionZoomStrategy.setZoomLevel--start");var e=sap.gantt.simple.VisibleHorizonUpdateSubType;if(t>=0&&t!==this.getZoomLevel()){var o=t>this.getZoomLevel()?e.ZoomIn:e.ZoomOut;this.setProperty("zoomLevel",t,true);if(this._aZoomRate[t]){var i=this.calVisibleHorizonByRate(this._aZoomRate[t]);this.setVisibleHorizonWithReason(i,"zoomLevelChanged",null,o)}}performance.mark("ProportionZoomStrategy.setZoomLevel--end");return this};l.prototype.setZoomLevels=function(t){this.setProperty("zoomLevels",t,true);if(t>1){this._aZoomRate=new Array(t)}else{this._aZoomRate=[1]}this._updateZoomRateOnStops();return this};l.prototype.syncContext=function(t){var e=false,o=false;var i={zoomLevel:undefined,axisTimeChanged:false};var s=this.getParent()?this.getParent()._iLastVisibleWidth:null;var n=s?s:this.getGanttVisibleWidth();if(n&&t!==n){this._updateVisibleHorizon(t)}var r=this._determineZoomBoundaryByStrategy();var l=this._determineZoomRateByChartWidth(t);if(l){this.updateGanttVisibleWidth(t);var m=this._oZoom.minRate||-1;this._oZoom.minRate=Math.max(r.minRate,l.minRate)||r.minRate;var h=this._oZoom.maxRate||-1;this._oZoom.maxRate=r.maxRate;var p=this._oZoom.rate||-1;o=!a.floatEqual(m,this._oZoom.minRate)||!a.floatEqual(h,this._oZoom.maxRate);if(o){this._updateZoomRateOnStops();this._adjustRateByBoundary()}if(l.suitableRate&&!this._bHorizontalScroll){this._oZoom.rate=l.suitableRate;this._adjustRateByBoundary()}if(!this._disableAutoProportion){this._bHorizontalScroll=false}var u=this.getZoomLevel(),g=this._calcZoomLevelFromZoomRate(this._oZoom.rate);var f=u!==g&&!this.getParent()._isDisplayTypeChanged;if(f){this.setProperty("zoomLevel",g,true)}i.zoomLevel=this.getZoomLevel();e=!a.floatEqual(p,this._oZoom.rate);if(e){this.getParent().getAxisTime().setZoomRate(this._oZoom.rate);this._updateTimeLineOption()}i.axisTimeChanged=e}return i};l.prototype.setDisableAutoProportion=function(t){this._disableAutoProportion=t};l.prototype._updateVisibleHorizon=function(t){var e=this.getVisibleHorizon();var o=this.getGanttVisibleWidth();var s=a.calculateHorizonByWidth(e,o,t);i.prototype._setVisibleHorizon.call(this,s)};l.prototype.updateInitialVisibleHorizon=function(t,e){this.getParent().getAxisTime().setZoomRate(this._aZoomRate[e]);this._updateTimeLineOption();i.prototype._setVisibleHorizon.call(this,t)};l.prototype._adjustRateByBoundary=function(){if(this._oZoom.rate){this._oZoom.rate=Math.max(this._oZoom.rate,this._oZoom.minRate);this._oZoom.rate=Math.min(this._oZoom.rate,this._oZoom.maxRate)}};l.prototype._updateZoomRateOnStops=function(){if(this._oZoom&&this._oZoom.maxRate&&this._oZoom.minRate){var t=this._oZoom.maxRate,e=this._oZoom.minRate,o=this.getZoomLevels();this._oLog={};this._oLog.fMax=Math.log(t);this._oLog.fMin=Math.log(e);this._oLog.fStep=(this._oLog.fMax-this._oLog.fMin)/o;if(o>0){for(var i=0;i<o;i++){this._aZoomRate[i]=Math.pow(Math.E,this._oLog.fMin+this._oLog.fStep*i)}}else{this._aZoomRate[0]=1}}};l.prototype._calcZoomLevelFromZoomRate=function(t){if(this._oZoom&&this._oLog&&t){return Math.round((Math.log(t)-this._oLog.fMin)/this._oLog.fStep)}};l.prototype._determineZoomBoundaryByStrategy=function(){if(this._oZoom&&this._oZoom.base){var t=this.getCoarsestTimeLineOption(),e=this.getFinestTimeLineOption();return{minRate:this._oZoom.base.scale/this.calZoomScale(t.innerInterval.unit,t.innerInterval.span,this._getTimeLineRange(t)),maxRate:this._oZoom.base.scale/this.calZoomScale(e.innerInterval.unit,e.innerInterval.span,this._getTimeLineRange(e)*4)}}};l.prototype._determineZoomRateByChartWidth=function(e){var o=this.getTotalHorizon(),n=this.getVisibleHorizon(),r={};if(!this._oZoom){return null}if(!a.judgeTimeHorizonValidity(n,o)){this.getVisibleHorizon().setStartTime(o.getStartTime(),true);this.getVisibleHorizon().setEndTime(o.getEndTime(),true);t.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.ProportionZoomStrategy.syncContext()")}if(o){var l=this.calZoomScaleByDate(s.abapTimestampToDate(o.getStartTime()),s.abapTimestampToDate(o.getEndTime()),e);r.minRate=this._oZoom.base.scale/l}if(n&&n.getStartTime()&&n.getEndTime()){var m=n.getStartTime();var h=n.getEndTime();if(m===h){i.prototype._setVisibleHorizon.call(this,o);var p=this.calVisibleHorizonByRate(this._aZoomRate[this.getZoomLevel()]);i.prototype._setVisibleHorizon.call(this,p);m=p.getStartTime();h=p.getEndTime()}var u=this.calZoomScaleByDate(s.abapTimestampToDate(m),s.abapTimestampToDate(h),e);r.suitableRate=this._oZoom.base.scale/u}return r};l.prototype._updateTimeLineOption=function(){var t=s.getTimeStampFormatter().parse("20000101000000"),e,i,a=this.getTimeLineOptions(),n=this.getProperty("timeLineOption");var r=this.getAxisTime();if(r){var l=r.timeToView(t,undefined,r.continuousScale);for(i in a){var m=a[i].innerInterval;var h=r.timeToView(o.get(m.unit).offset(t,m.span),undefined,r.continuousScale);var p=Math.abs(Math.ceil(h-l));var u=typeof m.selector==="function"?m.selector(p):p>=this._getTimeLineRange(a[i]);if(u){e=i;break}}n=e?a[e]:a[i];this.setProperty("timeLineOption",n,true)}};l.prototype.onSetTimeZoomRate=function(t){var e=this.calVisibleHorizonByRate(t);this.setVisibleHorizon(e)};l.prototype.getCurrentVisibleHorizon=function(){var t=this.getTotalHorizon(),e=this.getZoomLevel();if(!t||e===undefined){return undefined}var o=this._completeTimeHorizon(this.calVisibleHorizonByRate(this._aZoomRate[e]));return o};l.prototype.getRenderedVisibleHorizon=function(){var t=this.getTotalHorizon(),e=this.getZoomLevel(),o=this.getParent();if(!o||!t||e===undefined){return undefined}var i=o.getRenderedTimeRange();var a=new n({startTime:i[0],endTime:i[1]});return a};return l},true);
//# sourceMappingURL=ProportionZoomStrategy.js.map