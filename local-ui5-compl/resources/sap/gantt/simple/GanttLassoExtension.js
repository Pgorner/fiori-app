/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","./GanttExtension","./CoordinateUtils","sap/gantt/misc/Utility"],function(jQuery,t,e,s,a){"use strict";var o=".sapGanttLasso";var n={addEventListeners:function(t){this.removeEventListeners(t);var e=t._getLassoExtension();e.lassoDoms().rowArea.on("mousedown"+o,e.beforeLasso.bind(e))},removeEventListeners:function(t){var e=t._getLassoExtension();e.lassoDoms().rowArea.off(o)},addLassoEventListeners:function(t){this.removeLassoEventListeners(t);var e=t._getLassoExtension();var s=jQuery(e.getDomRefs().gantt);s.on("mousemove"+o,e.onMousemove.bind(e));s.on("mouseup"+o,e.endLasso.bind(e));s.on("mouseleave"+o,e.endLasso.bind(e));s.on("keydown"+o,e.onKeydown.bind(e))},removeLassoEventListeners:function(t){var e=t._getLassoExtension();jQuery(e.getDomRefs().gantt).off(o)}};var i=e.extend("sap.gantt.simple.GanttLassoExtension",{_init:function(t,e){this._initLassoStates();return"LassoExtension"},_attachEvents:function(){var t=this.getGantt();n.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();n.removeEventListeners(t)}});i.prototype._initLassoStates=function(){this.mDom={};this._oLassoStartPoint={};this._bLassoDrawing=false};i.prototype.getSvgElement=function(){return this.getDomRefs().ganttSvg};i.prototype._getShapeConnectRootNode=function(){var t=this.lassoDoms().lasso;return d3.select(t.get(0))};i.prototype.rect=function(t,e,s,a){return"M"+[t,e]+" l"+[s,0]+" l"+[0,a]+" l"+[-s,0]+"z"};i.prototype._getLassoData=function(t){var e=this._oLassoStartPoint.x<t.x?this._oLassoStartPoint.x:t.x;var s=this._oLassoStartPoint.x>t.x?this._oLassoStartPoint.x:t.x;var a=this._oLassoStartPoint.y<t.y?this._oLassoStartPoint.y:t.y;var o=this._oLassoStartPoint.y>t.y?this._oLassoStartPoint.y:t.y;var n={class:"lassoRect",d:this.rect(e,a,s-e,o-a),fill:"#9bdaff",stroke:"#4da5ff","fill-opacity":.5,"stroke-width":2};return n};i.prototype.createLasso=function(t){var e=this._getLassoData(t);if(this.getD3Doms().lassoRect.empty()){var s=this._getShapeConnectRootNode();s.append("path").attr(e)}};i.prototype.isLassoDrawing=function(){return this._bLassoDrawing};i.prototype.beforeLasso=function(t){var e=this.getGantt();if(t.button!==0||e.getSelection().sSelectionMode!==sap.gantt.SelectionMode.MultiWithKeyboardAndLasso&&e.getSelection().sSelectionMode!==sap.gantt.SelectionMode.MultipleWithLasso){return}var a=this.getSvgElement();var o=s.getEventSVGPoint(a,t);this._oLassoStartPoint={x:o.x,y:o.y};if(e.getSelection().sSelectionMode===sap.gantt.SelectionMode.MultiWithKeyboardAndLasso&&!(t.ctrlKey||t.metaKey)){e._bDeselectShapes=true;e.setSelectedShapeUid([])}else{e._bDeselectShapes=false}n.addLassoEventListeners(e)};i.prototype.onMousemove=function(t){if(!this.isLassoDrawing()){this._bLassoDrawing=true;var e=this.getSvgElement();var a=s.getEventSVGPoint(e,t);this.createLasso(a);this.mDom.lassoRect=this.lassoDoms().lassoRect}else{this.onLassoDrawing(t)}};i.prototype.onLassoDrawing=function(t){var e=this.getSvgElement();var a=s.getEventSVGPoint(e,t);var o=this._getLassoData(a);this.mDom.lassoRect.attr(o)};i.prototype.shapeInLasso=function(t,e,s,a,o,n,i,r){if(t>=o&&t<=n&&s>=i&&s<=r||e>=o&&e<=n&&s>=i&&s<=r||t>=o&&t<=n&&a>=i&&a<=r||e>=o&&e<=n&&a>=i&&a<=r||t<=o&&e>=n&&s>=i&&s<=r||t<=o&&e>=n&&a>=i&&a<=r||t>=o&&t<=n&&a>=r&&s<=i||e>=o&&e<=n&&a>=r&&s<=i){return true}return false};i.prototype.getShapeElementByTarget=function(t,e){return jQuery(e.getDraggableDOMElement(t)).control(0,true)};i.prototype.getDraggableDOMElement=function(t){return jQuery(t).closest("[data-sap-gantt-shape-id]").get(0)};i.prototype.endLasso=function(t){var e=this.getGantt();var o=e._getLassoExtension();if(this.isLassoDrawing()){var i=this._getShapeConnectRootNode();i.selectAll("*").remove()}n.removeLassoEventListeners(this.getGantt());var r=this.getSvgElement();var g=s.getEventSVGPoint(r,t);var h=e._getLassoExtension()._oLassoStartPoint;var p=h.x<g.x?h.x:g.x;var l=h.x>g.x?h.x:g.x;var v=h.y<g.y?h.y:g.y;var f=h.y>g.y?h.y:g.y;var c,d,u,S,L,y,m={x:0,y:0};var E=e.getEnableLassoInvert();var x=e.getSelectedShapeUid();var _=E?[]:x;var D=[];var b=jQuery(r);var w=jQuery(b.find(".sapGanttChartShapes")).find(".baseShapeSelection").toArray();var R=jQuery(b.find(".sapGanttChartRls")).find(".baseShapeSelection").toArray();var P=false;w.forEach(function(t,e){if(!t.classList.contains("sapGanttTextNoPointerEvents")){L=o.getShapeElementByTarget(t,o);if(L){P=L.getSelectable();m=a.getShapeBias(L);var s=t.getAttribute("transform");if(s){var n=s.slice(s.indexOf("(")+1,-1).split(" ");m=n&&n.length?{x:parseFloat(n[0]),y:parseFloat(n[1])}:m}y=L.getShapeUid()?L.getShapeUid():L.getParentRowSettings().getShapeUid(L)}c=t.getBBox().x+m.x;d=c+t.getBBox().width;u=t.getBBox().y+m.y;S=u+t.getBBox().height;var i=o.shapeInLasso(c,d,u,S,p,l,v,f);var r=L?x.indexOf(y):0;var g=r===-1?false:true;if(i){if(L&&P&&!g&&_.indexOf(y)===-1){_.push(y)}else if(E&&L&&P&&g){D.push(y)}}else if(E&&L&&P&&g){_.push(y)}if(L){w[e]=y}}});R.forEach(function(t,e){L=o.getShapeElementByTarget(t,o);if(L){P=L.getSelectable();y=L.getShapeUid()?L.getShapeUid():L.getParentRowSettings().getShapeUid(L)}if(E&&L&&P&&x.indexOf(y)!==-1){_.push(y)}if(L){R[e]=y}});if(E){x.forEach(function(t){if(w.indexOf(t)===-1&&R.indexOf(t)===-1){_.push(t)}})}var G=[];_.forEach(function(t){if(G.indexOf(t)===-1&&D.indexOf(t)===-1){G.push(t)}});this._initLassoStates();if(e.getSelectedShapeUid().toString()===G.toString()){e._bSupressShapeChangeEvent=true}else{e._bSupressShapeChangeEvent=false}e.setSelectedShapeUid(G)};i.prototype.onKeydown=function(e){if(this.isLassoDrawing()&&e.keyCode===t.ESCAPE){this.endLasso(e)}};i.prototype.lassoDoms=function(){var t=jQuery(this.getSvgElement());var e=t.find("g.sapGanttChartLasso");var s=t.find("rect.sapGanttBackgroundSVGRow");return{lassoRect:e.find(".lassoRect"),rowArea:s,lasso:e}};i.prototype.getD3Doms=function(){var t=this._getShapeConnectRootNode();return{lassoRect:t.selectAll(".lassoRect")}};return i});
//# sourceMappingURL=GanttLassoExtension.js.map