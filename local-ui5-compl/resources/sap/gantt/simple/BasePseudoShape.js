/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["./MultiActivityGroup","sap/gantt/simple/BaseRectangle","./GanttUtils","sap/ui/core/theming/Parameters","sap/gantt/simple/BaseImage","sap/gantt/def/gradient/LinearGradient","sap/gantt/misc/Format","sap/gantt/def/gradient/Stop","sap/ui/core/Core","sap/gantt/library","sap/gantt/utils/GanttChartConfigurationUtils"],function(e,t,a,r,i,n,o,s,p,g,d){"use strict";var l=e.extend("sap.gantt.simple.BasePseudoShape",{metadata:{properties:{expandTitle:{type:"string",defaultValue:"Show Details"},collapseTitle:{type:"string",defaultValue:"Show Less"},overlapFill:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"@sapChart_OrderedColor_11"},fill:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"@sapChart_OrderedColor_1"},typeOfOverlapIndicator:{type:"string",defaultValue:g.simple.typeOfOverlapIndicator.Gradient}},aggregations:{button:{type:"sap.gantt.simple.BaseShape",sapGanttOrder:2,visibility:"hidden"}}}});l.prototype.getButton=function(){return this.getAggregation("button")};l.prototype.onclick=function(e){if(e&&e.target.getAttribute("class").indexOf("pseudoShapeIcon")==-1){return}var t=this.getGanttChartBase();var a=t.getTable();var r=a.getRowSettingsTemplate();var i=a.getRows();var n=this.getParentRowSettings().getParent().getIndex()-i[0].getIndex();var o=i[n];t.oOverlapShapeIds=t.oOverlapShapeIds?t.oOverlapShapeIds:{};var s=t.oOverlapShapeIds&&t.oOverlapShapeIds[o.getIndex()]?t.oOverlapShapeIds&&t.oOverlapShapeIds[o.getIndex()]:[];var p=this.aShapeIds.length>0&&(s.length==0||this.aShapeIds.indexOf(s[0])==-1);var g=o.getIndex();var d;if(s&&t._aExpandedIndices.length>0&&t._aExpandedIndices.indexOf(g)>-1){t._collapse(d,g,true)}if(p){var l=a.getBindingInfo("rows").model;var h=o.getAggregation("_settings");t.oOverlapShapeIds[o.getIndex()]=[];var m=t._getPossibleShapesInGantt();var f=[];m.forEach(function(e){var t=r.getBindingInfo(e);f.push(t)});this.aShapeContexts.forEach(function(e){var a=m.indexOf(e.aggrType);var r=f[a]&&f[a].template.clone();if(r){r.setBindingContext(e,l);h.addAggregation(e.aggrType,r,true);t.oOverlapShapeIds[g].push(h.getAggregation(e.aggrType)[h.getAggregation(e.aggrType).length-1].getShapeId())}});t._expand(d,g,true)}};l.prototype._timeFormatter=function(e,t){var a=e.getProperty(t.startTime);var r=e.getProperty(t.endTime);var i=e.timeFormatter?e.timeFormatter(a):a,n=e.endTimeFormatter?e.endTimeFormatter(r):r;return{time:i,endTime:n}};l.prototype._createPseudoShape=function(e,a,n,o){var s=sap.gantt.simple.horizontalTextAlignment,p;var g=new l;var d=function(e,t){return new i({height:parseFloat(r.get("sapUiChartAxisTitleFontSize"),100)*16,fontWeight:r.get("sapUiChartTitleFontWeight"),src:e,fill:r.get("sapUiChartReferenceLineLabelColor"),horizontalTextAlignment:t.getHorizontalTextAlignment(),time:t.getTime(),endTime:t.getEndTime()})};g.setAggregation("task",new t({time:e.startTime,endTime:e.endTime,horizontalTextAlignment:s.Start,fontSize:parseFloat(r.get("sapUiChartAxisTitleFontSize"),100)*16,fontWeight:r.get("sapUiChartTitleFontWeight")}));var h=g.getTask();e.overlaps.forEach(function(e){if(g.getTypeOfOverlapIndicator()!="Gradient"){h._iBaseRowHeight=n._oExpandModel.getBaseRowHeight()?n._oExpandModel.getBaseRowHeight():h._iBaseRowHeight;var a=h.getHeight();g.addAggregation("indicators",new t({time:e.startTime,endTime:e.endTime,yBias:a+2}).addStyleClass("sapGanttPseudoShapeOverlapIndicatorStyle"))}});if(o&&n.oOverlapShapeIds&&n.oOverlapShapeIds[a.getIndex()]&&e.aShapeIds&&e.aShapeIds.some(function(e){return n.oOverlapShapeIds[a.getIndex()].includes(e)})){p=d("sap-icon://collapse",h);h.setTitle(g.getCollapseTitle())}else{p=d("sap-icon://expand",h);h.setTitle(g.getExpandTitle())}h.setTitleColor(r.get("sapUiChartReferenceLineLabelColor"));p.aCustomStyleClasses=["pseudoShapeIcon"];g.addAggregation("button",p);return g};l.prototype._fnCreateLinearGradient=function(e,t){var a=[],r=t.shapeFill?t.shapeFill:"@sapChart_OrderedColor_1",i=t.overlapIndicatorFill?t.overlapIndicatorFill:"@sapChart_OrderedColor_11";var n=d.getRTL();if(n){for(var o=e.length-1;o>=0;o--){a.push(new s({offSet:String(100-e[o]+"%"),stopColor:o%2==0?i:r}));a.push(new s({offSet:String(100-e[o-1]+"%"),stopColor:o%2==0?i:r}))}}else{for(var o=0;o<e.length-1;o++){a.push(new s({offSet:String(e[o]+"%"),stopColor:o%2==0?r:i}));a.push(new s({offSet:String(e[o+1]+"%"),stopColor:o%2==0?r:i}))}}return a};l.prototype._createShapesFromContext=function(e,t,a,s,p,g,d){var l=t.getAggregation("_settings");var h=s.getAxisTime(),m={};var f=l.getPseudoShapeTemplate&&l.getPseudoShapeTemplate();var v=s.getTable().getBindingInfo("rows").model;var u=s._getPossibleShapesInGantt();a.forEach(function(e,t){if(e){var a=e.template.getAggregation("shapes");var r=e.template.getBindingInfo("time")||a&&a[0]&&a[0].getBindingInfo("time"),i=e.template.getBindingInfo("endTime")||a&&a[0]&&a[0].getBindingInfo("endTime"),n=e.template.getBindingInfo("shapeId");m[t]={endTime:i.parts[0].path||i.path,startTime:r.parts[0].path||r.path,shapeId:n.parts[0].path||n.path}}});var T=function(e,t){return new i({height:parseFloat(r.get("sapUiChartAxisTitleFontSize"),100)*16,fontWeight:r.get("sapUiChartTitleFontWeight"),src:e,fill:r.get("sapUiChartReferenceLineLabelColor"),horizontalTextAlignment:t.getHorizontalTextAlignment(),time:t.getTime(),endTime:t.getEndTime()})};e.sort(function(e,t){var a=e.timeFormatter;var r=t.timeFormatter;var i=e.getProperty(m[u.indexOf(e.aggrType)].startTime);var n=t.getProperty(m[u.indexOf(t.aggrType)].startTime);var o=a?a(i):i,s=r?r(n):n;return o-s});var S=this._findPseudoShapeContextArray(e,m,t,s,a);var I,c,y;t.aFinalShapeGroupArray=S;S.forEach(function(e){if(e.iShapeCount>1){var r;if(f){r=f.clone();c=r.getTask();e.shapeFill=c.getFill()?c.getFill():r.getFill();c.setTime(e.startTime);c.setEndTime(e.endTime);c.setSelectable(true);if(p&&s.oOverlapShapeIds&&s.oOverlapShapeIds[t.getIndex()]&&e.aShapeIds&&e.aShapeIds.some(function(e){return s.oOverlapShapeIds[t.getIndex()].includes(e)})){y=T("sap-icon://collapse",c);I=r.getCollapseTitle()?r.getCollapseTitle():"Show Less"}else{y=T("sap-icon://expand",c);I=r.getExpandTitle()?r.getExpandTitle():"Show Details"}c.setTitle(I);e.overlaps.forEach(function(t){var a=r.getIndicators()[0].clone();a.addStyleClass("sapGanttPseudoShapeOverlapIndicatorStyle");e.overlapIndicatorFill=a.getFill()?a.getFill():r.getOverlapFill();if(r.getTypeOfOverlapIndicator()!="Gradient"){a.setTime(t.startTime);a.setEndTime(t.endTime);r.addAggregation("indicators",a)}});y.aCustomStyleClasses=["pseudoShapeIcon"];r.addAggregation("button",y)}else{r=this._createPseudoShape(e,t,s,p);c=r.getTask()}r.isPseudoShape=true;r.aShapeContexts=e.aShapeContexts;r.aShapeIds=e.aShapeIds;r.getTask().addStyleClass("sapGanttPseudoShapeColor");if(r.getTypeOfOverlapIndicator()!="Indicator"){r.getTask().setFill("url(#"+e.id+")")}l.addAggregation("pseudoShapes",r,true);r._birdEye(a,s,r,t,g>-1?s._aExpandedIndices.indexOf(t.getIndex())==-1:true,m);if(d){var i=e.startTime,S=e.endTime;var x=i.getTime(),C=S.getTime();var O=C-x,_=[0];for(var F=0;F<e.overlaps.length;F++){var A=e.overlaps[F];var B=(A.startTime.getTime()-x)/O*100;var E=(A.endTime.getTime()-x)/O*100;_.push(B);if(E-B<1){var P=h.timeToView(o.abapTimestampToDate(S)),b=h.timeToView(o.abapTimestampToDate(i));var w=Math.abs(P-b);E=B+1/w*100}_.push(E)}_.push(100);var G=this._fnCreateLinearGradient(_,e);var R=s._oSvgDefs&&s._oSvgDefs.getAggregation("defs")&&s._oSvgDefs.getAggregation("defs").find(function(t){return t.getId()==e.id});if(!R){s._oSvgDefs&&s._oSvgDefs.addAggregation("defs",new n(e.id,{x1:"0%",y1:"0%",x2:"100%",y2:"0%",stops:G}),true)}}}else{if(e.iShapeCount===1){var L=e.aShapeContexts[0].aggrType;var V=a[u.indexOf(L)].template.clone();V.setBindingContext(e.aShapeContexts[0],v);l.addAggregation(L,V,true);var U=l.getAggregation(L).length-1;var F=t.getIndex();var z=s.oOverlapShapeIds&&s.oOverlapShapeIds[F]&&s.oOverlapShapeIds[F].indexOf(l.getAggregation(L)[U].getShapeId());if(z>-1){if(s.oOverlapShapeIds[F].length>1){s.oOverlapShapeIds[F].splice(z,1)}else if(s.oOverlapShapeIds){delete s.oOverlapShapeIds[F]}}}}}.bind(this))};l.prototype._findPseudoShapeContextArray=function(e,t,a,r){var i=[],n,o=0,s=0,p=r.getId();var g=r._getPossibleShapesInGantt();if(e[0]){n=g.indexOf(e[0].aggrType);i.push({id:p+"_row-"+a.getIndex()+"group-"+o,iShapeCount:1,startTime:this._timeFormatter(e[0],t[n],r).time,endTime:this._timeFormatter(e[0],t[n],r).endTime,overlaps:[],aShapeContexts:[e[0]],aShapeIds:[e[0].getProperty(t[n].shapeId)]})}for(var d=1;d<e.length;d++){var l=e[d];n=g.indexOf(l.aggrType);var h=this._timeFormatter(l,t[n],r).time,m=this._timeFormatter(l,t[n],r).endTime,f=i[o],v=f.startTime,u=f.endTime;var T=f.overlaps[s]&&f.overlaps[s].startTime,S=f.overlaps[s]&&f.overlaps[s].endTime;if(h>=v&&m<=u){f.aShapeContexts.push(l);f.iShapeCount++;f.aShapeIds.push(l.getProperty(t[g.indexOf(l.aggrType)].shapeId));if(f.overlaps.length===0){f.overlaps.push({startTime:h,endTime:m})}else{if(h>=T&&m<=S){}else if(h>=T&&h<S&&m>S){f.overlaps[s].endTime=m}else if(h>S&&m>S){f.overlaps.push({startTime:h,endTime:m});s++}}}else if(h>=v&&h<u&&m>u){f.aShapeContexts.push(l);f.iShapeCount++;f.aShapeIds.push(l.getProperty(t[g.indexOf(l.aggrType)].shapeId));if(f.overlaps.length===0){f.overlaps.push({startTime:h,endTime:f.endTime})}else{if(h>=T&&u<=S){}else if(h>=T&&h<S&&u>S){f.overlaps[s].endTime=f.endTime}else if(h>S&&u>S){f.overlaps.push({startTime:h,endTime:f.endTime});s++}}f.endTime=m}else if(h>=u&&m>=u){o++;s=0;i.push({id:p+"_row-"+a.getIndex()+"group-"+o,iShapeCount:1,startTime:h,endTime:m,overlaps:[],aShapeContexts:[l],aShapeIds:[l.getProperty(t[g.indexOf(l.aggrType)].shapeId)]})}}return i};l.prototype._birdEye=function(e,t,a,r,i,n){var o=r.getIndex(),s=r.getAggregation("_settings");var p=t._getPossibleShapesInGantt();var g=function(r,i){var n=false,o,s;for(var g=0;g<a.aShapeContexts.length;g++){var d=a.aShapeContexts[g];var l=p.indexOf(d.aggrType);var h=e[l];var m=h.template.getBindingInfo("countInBirdEye"),f;if(m){f=m.parts[0].path||m.path}else{f=h.template.getCountInBirdEye()}if(typeof f!="boolean"&&d.getProperty(f)||f==true){n=true;var v=i._timeFormatter(d,r[l],t).time;var u=i._timeFormatter(d,r[l],t).endTime;if(!o||v<o){o=v}if(!s||s<u){s=u}}}return{startTime:o,endTime:s,pseudoCountInBirdEye:n}};if(t.oOverlapShapeIds&&t.oOverlapShapeIds[o]&&a.aShapeIds.some(function(e){return t.oOverlapShapeIds[o].includes(e)})&&i){var d=t.getTable().getBindingInfo("rows").model;var l=false,h,m;a.aShapeContexts.forEach(function(r){var i=p.indexOf(r.aggrType);var g=e[i];var f=g.template.getBindingInfo("countInBirdEye"),v;if(f){v=f.parts[0].path||f.path}else{v=g.template.getCountInBirdEye()}if(typeof v!="boolean"){if(r.getProperty(v)){l=true;var u=this._timeFormatter(r,n[i],t).time;var T=this._timeFormatter(r,n[i],t).endTime;if(!h||u<h){h=u}if(!m||m<T){m=T}}}var S;var I=e[i];if(I){S=I.template.clone();S.setBindingContext(r,d);s.addAggregation(r.aggrType,S,true)}s.getAggregation(r.aggrType)[s.getAggregation(r.aggrType).length-1].isPartOfExpandedPseudoShape=true;var c=c>-1?c:o;t.oOverlapShapeIds[c]=a.aShapeIds}.bind(this));if(typeof countInBirdEyeVal!="boolean"){a.groupBirdEyeRangeStartTime=h;a.groupBirdEyeRangeEndTime=m;a.setCountInBirdEye(l)}}else{var f=g(n,this);a.groupBirdEyeRangeStartTime=f.startTime;a.groupBirdEyeRangeEndTime=f.endTime;a.setCountInBirdEye(f.pseudoCountInBirdEye)}};return l},true);
//# sourceMappingURL=BasePseudoShape.js.map