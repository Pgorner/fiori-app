/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/gantt/simple/BaseLine","sap/gantt/simple/RenderUtils","sap/gantt/simple/GanttExtension","sap/gantt/simple/Relationship","sap/gantt/misc/Format","sap/gantt/misc/Utility","sap/gantt/library","sap/m/Toolbar","./GanttUtils","./AdhocLineRenderer","sap/gantt/simple/DeltaLineRenderer","sap/gantt/simple/AggregationUtils","./BaseText","sap/ui/core/Lib","sap/ui/core/RenderManager"],function(e,t,n,a,r,o,i,s,d,l,g,p,c,h,f,u,S){"use strict";var v={apiVersion:2};var E=d.AdhocLineLayer;var m=d.DeltaLineLayer;v.render=function(e,t){performance.mark("InnerGanttChartRenderer.render--start");var n=t.getParent(),a=n.getParent()._bToolbarSettingsItemChanged;if(a){n.getParent()._bToolbarSettingsItemChanged=false;n._getScrollExtension().needRerenderGantt(function(){this.renderImmediately(n)}.bind(this),"initialRender",a)}else{var r=n.getTable().getRows(),o=false;n.schemeRowSpanMap=n.schemeRowSpanMap?n.schemeRowSpanMap:{};n.getShapeSchemes().forEach(function(e){n.schemeRowSpanMap[e.getKey()]=e.getRowSpan()});if(r.length>0){var i=r[0].getIndex(),s,d=[];s=n.getPrimaryShapeScheme();n._aExpandedIndices.forEach(function(e){var t=e-i;if(t>=0&&r.length-1>=t){d.push(t)}});d.forEach(function(e){var t=i+e;var a=r[e].getAggregation("_settings").getRowUid();var d=n._oExpandModel.mExpanded[a];if(d){var l,g=[],p;if(d[d.length-1]){for(var c=1;c<d.length;c++){g.push(d[c].scheme)}}l=n.getShapeSchemes().filter(function(e){return g.indexOf(e.getKey())>-1});if(l[0]!==undefined||n.getEnablePseudoShapes()&&d[d.length-1].expandSchemeShape){n._oExpandModel.isTableRowHeightNeedChange(true,n.getTable(),[t],s,l);p=n._oExpandModel.getMainRowScheme(a);if(n._oExpandModel.rowMaxLevelMap&&n._oExpandModel.rowMaxLevelMap["row"+t]!==undefined&&p!==undefined&&p.value.numberOfRows!==undefined&&p.value.numberOfRows!==n._oExpandModel.rowMaxLevelMap["row"+t]){p.value.numberOfRows=n._oExpandModel.rowMaxLevelMap["row"+t];o=true}}}})}if(!n.pseudoShapeSpecificData){n.pseudoShapeSpecificData={}}if(n.getEnablePseudoShapes()==false&&n.oOverlapShapeIds){var l=Object.keys(n.oOverlapShapeIds);delete n.oOverlapShapeIds;var g=Object.keys(n._oExpandModel.mExpanded);l.forEach(function(e){g.forEach(function(t){if(t.endsWith("["+e+"]")){delete n._oExpandModel.mExpanded[t]}})});n._aExpandedIndices=n._aExpandedIndices.filter(function(e){return l.indexOf(e.toString())==-1})}n.oExpandedShapesMap={};if(o===true||n.pseudoShapeSpecificData&&n.pseudoShapeSpecificData.needUpdateForTasksInAggr){o=false;if(n.pseudoShapeSpecificData&&n.pseudoShapeSpecificData.needUpdateForTasksInAggr){n.pseudoShapeSpecificData.isPseudoShapesEnabled=true;n._addBackTasksToRows();n.pseudoShapeSpecificData.needUpdateForTasksInAggr=false}n.getTable().invalidate()}else{this.renderGanttChart(e,n);var p=n._getScrollExtension();if(!p.mOffsetWidth){p.updateSvgOffsetWidth()}n._getScrollExtension().scrollGanttChartToVisibleHorizon();n.getSyncedControl().scrollContentIfNecessary()}}performance.mark("InnerGanttChartRenderer.render--end")};v.renderGanttChart=function(e,t){e.openStart("div",t.getId()+"-cnt");e.class("sapGanttChartCnt");e.style("height","100%");e.style("width","100%");e.openEnd();this.rerenderAllShapes(e,t);e.close("div")};v.renderImmediately=function(e){var t=new S;this.renderGanttChart(t,e);var n=window.document.getElementById(e.getId()+"-gantt");if(n){t.flush(n,true,false)}this.renderRelationships(t,e);e._updateShapeSelections(e.getSelectedShapeUid(),[]);e.updateShapeHighlights(e.getHighlightedShapeUid(),[]);r.attachEvents(e);if(e.getParent().isA("sap.gantt.simple.GanttChartContainer")&&e.getParent().getShowSearchSidePanel()){e.getParent().getSearchSidePanel().setContainerHeight()}t.destroy();e.getInnerGantt().fireGanttReady({supressEvent:true})};v.rerenderAllShapes=function(e,t){var n=t.getSyncedControl().getRowStates();var r=u.getResourceBundleFor("sap.gantt");if(n.length===0){return}t.getAggregation("_header").renderElement();if(t._getScrollExtension&&t._getScrollExtension.mOffsetWidth){t._getScrollExtension().scrollGanttChartToVisibleHorizon()}var o=t.getSimpleAdhocLines().filter(function(e){return e.MarkerType!=sap.gantt.simple.MarkerType.None});var i=t.getDeltaLines();if((o.length>0||i.length>0)&&t.getShowGanttHeader()){var s=t.getAggregation("table");g.addToolbarToTable(this,s,false)}var d=n.reduce(function(e,t){return e+t.height},0);e.openStart("svg",t.getId()+"-svg");e.class("sapGanttChartSvg");e.attr("height",d+"px");e.attr("aria-label",r.getText("ARIA_GANTT_CHART"));var l=a.getGanttRenderWidth(t);e.attr("width",l+"px");e.openEnd();performance.mark("InnerGanttChartRenderer.rerenderAllShapes-other--start");if(t.getEnableDeltaLine()){this.renderChartAreaOfDeltaLines(e,t)}this.renderGanttBackgrounds(e,t,n);this.renderGanttRowBorders(e,t,n);this.renderCalendarShapes(e,t);this.renderExpandedRowBackground(e,t);this.renderVerticalLines(e,t,d);this.renderNowLineBody(e,t);performance.mark("InnerGanttChartRenderer.rerenderAllShapes-other--end");performance.mark("InnerGanttChartRenderer.rerenderAllShapes-shape--start");var p=a.createOrderedListOfRenderFunctionsFromTemplate(this.createTemplateForOrderedListOfRenderFunctions(t));p.forEach(function(n){n.apply(v,[e,t])});performance.mark("InnerGanttChartRenderer.rerenderAllShapes-shape--end");performance.mark("InnerGanttChartRenderer.rerenderAllShapes-svgDefs--start");e.openStart("svg",t.getId()+"-svgDefs");e.attr("width",0);e.attr("height",0);e.style("position","absolute");e.attr("aria-label",r.getText("ARIA_GANTT_CALENDARS"));e.class("sapGanttChartSvgDefs");e.openEnd();this.renderHelperDefs(e,t.getId(),t);this.renderCalendarPattern(e,t);e.close("svg");e.close("svg");performance.mark("InnerGanttChartRenderer.rerenderAllShapes-svgDefs--end");if(!t._bPreventInitialRender){t._bPreventInitialRender=true}};v.createTemplateForOrderedListOfRenderFunctions=function(e){var t=[{fnCallback:this.renderAllShapesInRows},{fnCallback:this.renderRlsContainer,bUnshift:e.getShapeOverRelationship()},{fnCallback:this.renderAssistedContainer}];if(e.getEnableAdhocLine()){t.push({fnCallback:this.renderAdhocLines,bUnshift:e.getAdhocLineLayer()===E.Bottom})}if(e.getEnableDeltaLine()){t.push({fnCallback:this.renderDeltaLines,bUnshift:e.getDeltaLineLayer()===m.Bottom})}return t};v.renderHelperDefs=function(e,t,n){e.openStart("defs").openEnd();var a=t+"-helperDef-linePattern";e.openStart("pattern",a);e.attr("width",2);e.attr("height",2);e.attr("x",0);e.attr("y",0);e.attr("patternUnits","userSpaceOnUse");e.openEnd();e.openStart("line");e.attr("x1",1);e.attr("x2",1);e.attr("y1",0);e.attr("y2",2);e.attr("stroke-width",1);e.attr("stroke","white");e.attr("shape-rendering","crispEdges");e.openEnd();e.close("line");e.close("pattern");e.close("defs");var r=n?n.getSvgDefs():null;var o=n?n.getAggregation("_pseudoSvgDefs"):null;if(o){e.unsafeHtml(o._getDefString())}if(r){e.unsafeHtml(r._getDefString(n._bClonedGantt))}};v.renderGanttRowBorders=function(e,t,n){e.openStart("g",t.getId()+"-ganttRowBorder");e.openEnd();this.renderRowBorders(e,t,n);e.close("g")};v.renderGanttBackgrounds=function(e,t,n){e.openStart("g",t.getId()+"-bg");e.openEnd();this.renderRowBackgrounds(e,t,n);e.close("g")};v.renderRowBackgrounds=function(e,t,n){var a=0;var r=t.getTable().getRows();var o=r.length-1;e.openStart("g",t.getId()+"-rowBackgrounds");e.class("rowBackgrounds");e.openEnd();n.forEach(function(n,i){e.openStart("rect",t.getId()+"-bgRow-"+i);e.attr("y",a);e.attr("width","100%");e.attr("height",n.height);e.attr("data-sap-ui-index",i);var s=r[i];if(s){e.attr("data-sap-ui-related",s.getId())}e.class("sapGanttBackgroundSVGRow");if(n.selected&&t.getEnableChartSelectionState()){e.class("sapGanttBackgroundSVGRowSelected")}if(n.hovered&&t.getEnableChartHoverState()){e.class("sapGanttBackgroundSVGRowHovered")}e.openEnd().close("rect");if(i<o){a+=n.height}});e.close("g")};v.renderRowBorders=function(e,t,n){e.openStart("g",t.getId()+"-rowBorders");e.class("rowBorders");e.openEnd();var a=0;n.forEach(function(n,r){var o=a+n.height-.5;e.openStart("line",t.getId()+"-bgRowBorder-"+r);e.attr("x1",0);e.attr("x2","100%");e.attr("y1",o);e.attr("y2",o);e.style("pointer-events","none");e.class("sapGanttBackgroundSVGRowBorder");e.openEnd().close("line");a+=n.height});e.close("g")};v.renderAdhocLines=function(e,t){var n=t.getSimpleAdhocLines();var a=t.getRenderedTimeRange(),r=a[0],o=a[1];n=n.filter(function(e){var t=i.abapTimestampToDate(e.getTimeStamp());return t>=r&&t<=o&&e.getProperty("visible")});if(n.length===0){return}e.openStart("g");e.class("sapGanttChartAdhocLine");e.openEnd();n.forEach(function(n){p.renderLine(e,n,t)});e.close("g")};v.renderDeltaLines=function(e,t){var n=t.getDeltaLines();n=n.filter(function(e){return e.getVisible()});if(n.length===0){return}e.openStart("g");e.class("sapGanttChartDeltaLine");e.openEnd();n.forEach(function(n){c.renderDeltaLines(e,n,t)});e.close("g")};v.renderChartAreaOfDeltaLines=function(e,t){var n=t.getDeltaLines();n=n.filter(function(e){return e.getVisible()});if(n.length===0){return}e.openStart("g");e.class("sapGanttChartAreaDeltaLine");e.openEnd();n.forEach(function(n){c.renderChartAreaOfDeltaLines(e,n,t)});e.close("g")};v.renderVerticalLines=function(e,t,n){if(t.getEnableVerticalLine()){var r=a.getGanttRenderWidth(t),o=t.getAxisTime();var i=o.getZoomStrategy();var s=o.getTickTimeIntervalLabel(i.getTimeLineOption(),null,[0,r]);var d=s[1];var l="";for(var g=0;g<d.length;g++){l+=" M"+" "+(d[g].value-1/2)+" 0"+" v "+n}if(l){e.openStart("path");e.class("sapGanttChartVerticalLine");e.attr("d",l);e.openEnd().close("path")}}};v.renderAssistedContainer=function(e,t){e.openStart("g");e.class("sapGanttChartSelection");e.openEnd().close("g");e.openStart("g");e.class("sapGanttChartHighlight");e.openEnd().close("g");e.openStart("g");e.class("sapGanttChartShapeConnect");e.openEnd().close("g");e.openStart("g");e.class("sapGanttChartLasso");e.openEnd().close("g")};v.renderNowLineBody=function(e,t){var a=t.getAxisTime().getNowLabel(t.getNowLineInUTC())[0].value;if(t.getEnableNowLine()===false||isNaN(a)){return}e.openStart("g");e.class("sapGanttNowLineBodySvgLine");e.openEnd();var r=new n({x1:a,y1:0,x2:a,y2:"100%",strokeWidth:1}).setProperty("childElement",true);r.renderElement(e,r);e.close("g")};v.renderRlsContainer=function(e,t){e.openStart("g");e.class("sapGanttChartRls");e.openEnd().close("g")};v.renderAllShapesInRows=function(e,t){if(!jQuery(document.getElementById(t.getId()+"-gantt"))){return}e.openStart("g",t.getId()+"-shapes");e.class("sapGanttChartShapes");e.openEnd();this._eachVisibleRowSettings(t,function(n){n.renderElement(e,t)});e.close("g")};v._eachVisibleRowSettings=function(e,t){var n=e.getTable().getRows();var a=e.getTable().getBindingInfo("rows"),r=a&&a.model;for(var o=0;o<n.length;o++){var i=n[o];var s=i.getBindingContext(r);if(s&&i.getIndex()!==-1){var d=i.getAggregation("_settings");if(t){t(d)}}}};v.renderRelationships=function(e,t){t.relSet={};t.relSetFake={};t._edgePoint=g.getEdgePoint(t);var n=window.document.getElementById(t.getId()+"-svg");var a=jQuery(n).children("g.sapGanttChartRls").get(0);if(n==null||a==null){return}var r=Object.create(null);this._eachVisibleRowSettings(t,this._renderVisibleRowRelationships.bind(this,e,t,r));this._renderNonVisibleRowRelationships(e,t,r);for(var o in t.relSet){if(t.relSet[o].mAnchors.predecessor||t.relSet[o].mAnchors.successor){t.relSet[o].renderElement(e,t.relSet[o],t.getId())}}for(var i in t.relSetFake){if(t.relSetFake[i].mAnchors.predecessor||t.relSetFake[i].mAnchors.successor){t.relSetFake[i].renderElement(e,t.relSetFake[i],t.getId());t.relSetFake[i].destroy()}}e.flush(a,true,false)};v._renderVisibleRowRelationships=function(e,t,n,a){a.getRelationships().forEach(function(e){var r=e.getShapeId();var o=a.getShapeUid(e);if(!n[r]){n[r]=true;e.setProperty("shapeUid",o,true);if(g.relationexist(t,e)){g.setLmarker(t,e,true)}}})};v._renderNonVisibleRowRelationships=function(e,t,n){var a=s.safeCall(t,["getTable","getRowSettingsTemplate","getBindingInfo"],null,["relationships"]);if(!a){return}var r=a.template.getBindingInfo("shapeId");if(!r){return}var o=r.parts[0].path,i=t.getTable().getModel(a.model);var d=function(e,r){if(!n[e]){n[e]=true;var o=a.factory();o.setModel(i,a.model);o.bindObject({path:r,model:a.model});if(g.relationexist(t,o)){g.setLmarker(t,o,false)}else{o.destroy()}}};if(i.isA("sap.ui.model.json.JSONModel")){var l=i.mContexts;Object.keys(l).forEach(function(e){if(e.indexOf(a.path)>0){d(l[e].getProperty(o),e[0]==="/"?e:"/"+e)}})}else if(i.isA("sap.ui.model.odata.v2.ODataModel")){var l=i.getProperty("/");Object.keys(l).forEach(function(e){if(e.startsWith(a.path)){d(l[e][o],e[0]==="/"?e:"/"+e)}})}};v.renderSvgDefs=function(e,t){var n=t.getSvgDefs();if(n){e.openStart("svg",t.getId()+"-svg-psdef");e.attr("aria-hidden","true");e.style("float","left");e.style("width","0px");e.style("height","0px");e.openEnd();e.unsafeHtml(n.getDefString());e.close("svg")}};v.renderCalendarPattern=function(e,t){if(t.getEnableNonWorkingTime()===false){return}var n=t.getCalendarDef(),r=t.getId(),o=t.iGanttRenderedWidth;var i=t.getSyncedControl().getRowStates();if(n){var s=h.getAllNonLazyAggregations(n);var d=Object.keys(s).filter(function(e){return e.indexOf("defs")===0}).map(function(e){return n.getAggregation(e)||[]});var l=function(e){return new f(e)};d.forEach(function(t,s){if(t.length>0){var d=n.getDefNode(t);if(d&&d.defNodes&&o>0){var g=r+"-calendardefs-"+s;e.openStart("defs",g);e.openEnd();for(var p=0;p<d.defNodes.length;p++){var c=d.defNodes[p];e.openStart("pattern",c.id);e.class("calendarPattern");e.attr("patternUnits","userSpaceOnUse");e.attr("x",0);e.attr("y",0);e.attr("width",o);e.attr("height",i[0].height);e.openEnd();for(var h=0;h<c.timeIntervals.length;h++){var f=c.timeIntervals[h];f.height=i[0].height;e.openStart("rect");e.attr("x",f.x);e.attr("y",f.y);e.attr("width",f.width);e.attr("height",i[0].height);e.attr("fill",f.fill);e.openEnd().close("rect");if(c.title!==null){a.renderCalenderTitle(e,c,f,l)}}e.close("pattern")}e.close("defs")}}})}};v.renderCalendarShapes=function(e,t){e.openStart("g");e.class("sapGanttChartCalendar");e.openEnd();var n=t.getSyncedControl().getRowStates();this._eachVisibleRowSettings(t,function(r){var o=a.calcRowDomPosition(r,n);var i=h.getAllNonLazyAggregations(r);var s=Object.keys(i).filter(function(e){return e.indexOf("calendars")===0}).map(function(e){return r.getAggregation(e)||[]});s.forEach(function(n){n.forEach(function(n){if(t.isShapeVisible(n)){n.setProperty("rowYCenter",o.rowYCenter,true);n._iBaseRowHeight=o.rowHeight;if(n.getVisible()){n.renderElement(e,n)}}})})});e.close("g")};v.renderExpandedRowBackground=function(e,t){var n=t.getExpandedBackgroundData();if(jQuery.isEmptyObject(n)){return}var a=t._oExpandModel.refreshRowYAxis(t.getTable());var r=Array.prototype.concat.apply([],n);var o=t.iGanttRenderedWidth;e.openStart("g");e.class("sapGanttChartRowBackground");e.openEnd();for(var i=0;i<r.length;i++){var s=r[i];var d;var l;if(t.getEnableExpandedRowBackground()===true){d="sapGanttExpandChartCntBG"}else{d="sapGanttExpandedRowBackground"}l=s.rowHeight;e.openStart("g");e.class("expandedRow");e.openEnd();var g;if(t.getShowParentRowOnExpand()&&!t.getUseParentShapeOnExpand()){g=s.y}else{g=s.y-a}e.openStart("rect");e.attr("x",s.x);e.attr("y",g);e.attr("height",l);e.attr("width","100%");e.class(d);e.openEnd();e.close("rect");e.openStart("path");if(t.getEnableExpandedRowBorders()===true){e.class("sapGanttExpandChartLine")}e.attr("d","M0 "+g+" H"+(o-1));e.openEnd().close("path");e.close("g")}e.close("g")};return v},true);
//# sourceMappingURL=InnerGanttChartRenderer.js.map