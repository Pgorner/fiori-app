/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/ui/core/IconPool","./GanttUtils","./RenderUtils","./BasePath","sap/ui/core/theming/Parameters","sap/gantt/library","./CoordinateUtils","./BaseShape","sap/gantt/utils/GanttChartConfigurationUtils","sap/ui/core/Element"],function(e,t,s,r,a,i,o,n,h,p,l,c){"use strict";var d=n.simple.connectorType;var g=6,u=20,S=15,f={FinishToFinish:0,FinishToStart:1,StartToFinish:2,StartToStart:3};var y=i.extend("sap.gantt.simple.Relationship",{metadata:{library:"sap.gantt",properties:{type:{type:"sap.gantt.simple.RelationshipType",group:"Appearance"},predecessor:{type:"string",group:"Data"},successor:{type:"string",group:"Data"},selectedStroke:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"#FF0000"},selectedStrokeWidth:{type:"sap.gantt.SVGLength",defaultValue:2},lShapeForTypeFS:{type:"boolean",defaultValue:true},lShapeForTypeSF:{type:"boolean",defaultValue:true},shapeTypeStart:{type:"sap.gantt.simple.connectorType",defaultValue:d.None},shapeTypeEnd:{type:"sap.gantt.simple.connectorType",defaultValue:d.Arrow},startShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},endShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},selectedStartShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},selectedEndShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},enableCurvedEdge:{type:"boolean",defaultValue:false},relationshipOverDivider:{type:"boolean",defaultValue:false},_lMarker:{type:"string",visibility:"hidden"}}},renderer:{apiVersion:2}});y.prototype.applySettings=function(e){e=e||{};i.prototype.applySettings.apply(this,arguments)};y.prototype._getLMarker=function(){return this.getProperty("_lMarker")};y.prototype.onclick=function(e){if(this.getGanttChartBase().getIsConnectorDetailsVisible()){var t=function(){var e=h.getLatestCursorPosition();var t=e.pageX,s=e.pageY;var r=document.elementsFromPoint(t,s),a=[],i=[];for(var o=0;o<r.length;o++){var n=r[o].parentNode;if(r[o].tagName==="path"&&c.getElementById(n.id).isA("sap.gantt.simple.Relationship")&&i.indexOf(n.id)===-1){i.push(n.id);var p=c.getElementById(n.id);a.push(p)}}if(a.length>0){this.getGanttChartBase().fireShapeConnectorList({pageX:t,pageY:s,connectorList:a})}};window.setTimeout(t.bind(this),300)}else{p.prototype.onclick.call(this,e)}};y.prototype.renderElement=function(e,t,s){this.oGantt=c.getElementById(s);var a=t.getProcessedType();if(!t.mRelatedShapes&&!t.mAnchors&&!r.relationexist(this.oGantt,t)||this.oGantt.getEnablePseudoShapes()&&this.mRelatedShapes.predecessor===this.mRelatedShapes.successor){return}this.mRelatedShapes=t.mRelatedShapes;if(this.mRelatedShapes.predecessor){var i=this.mRelatedShapes.predecessor.getParentRowSettings().getParent().getDomRef();var o=i.clientHeight;this.predYTop=i.offsetTop;this.predYBottom=this.predYTop+o}if(this.mRelatedShapes.successor){var h=this.mRelatedShapes.successor.getParentRowSettings().getParent().getDomRef();var p=h.clientHeight;this.sucYTop=h.offsetTop;this.sucYBottom=this.sucYTop+p}if(this.mRelatedShapes.predecessor&&this.mRelatedShapes.successor&&this.predYTop==this.sucYTop&&this.predYBottom==this.sucYBottom){var l=this.mRelatedShapes.successor.getParentRowSettings().getParent().getAggregation("_settings").getRowUid();var d=this.oGantt._oExpandModel.isRowExpanded(l);var g=this.oGantt.getShowParentRowOnExpand()&&!this.oGantt.getUseParentShapeOnExpand();var u=this.mRelatedShapes.predecessor._level;var S=this.mRelatedShapes.successor._level;if(d&&u&&S){var f=this.oGantt._oExpandModel.getBaseRowHeight();var y=this.oGantt.getExpandedRowHeight()?this.oGantt.getExpandedRowHeight():f;var v=g?this.predYTop+f+(u-1)*y:this.predYTop+(u-1)*y;var E=g?this.predYTop+f+u*y:this.predYTop+u*y;var P=g?this.sucYTop+f+(S-1)*y:this.sucYTop+(S-1)*y;var m=g?this.sucYTop+f+S*y:this.sucYTop+S*y;this.predYTop=v;this.predYBottom=E;this.sucYTop=P;this.sucYBottom=m}}switch(this.oGantt.getRelationshipShapeSize()){case n.simple.relationshipShapeSize.Small:this.SHAPE_SIZE=6;break;case n.simple.relationshipShapeSize.Large:this.SHAPE_SIZE=10;break;default:this.SHAPE_SIZE=8;break}this.calcLinePathD(t.mAnchors,a);this.renderRelationship(e,t.mAnchors,a,s)};y.prototype.getRlsAnchors=function(e,t){var s,r,a;var i=this.getShapeAnchors(t);if(t.predecessor&&t.successor){if(e===f.FinishToFinish){s=i.predecessor.tail;r=i.successor.tail}else if(e===f.FinishToStart){s=i.predecessor.tail;r=i.successor.head}else if(e===f.StartToFinish){s=i.predecessor.head;r=i.successor.tail}else if(e===f.StartToStart){s=i.predecessor.head;r=i.successor.head}}else if(t.predecessor&&!t.successor){if(e===f.FinishToFinish||e===f.FinishToStart){s=i.predecessor.tail;r={x:s.x+u,y:s.y};a={x:r.x,y:r.y+S/2}}else if(e===f.StartToFinish||e===f.StartToStart){s=i.predecessor.head;r={x:s.x-u,y:s.y};a={x:r.x-S,y:r.y+S/2}}}else if(!t.predecessor&&t.successor){if(e===f.FinishToFinish||e===f.StartToFinish){r=i.successor.tail;s={x:r.x+u,y:r.y};a={x:s.x,y:s.y+S/2}}else if(e===f.FinishToStart||e===f.StartToStart){r=i.successor.head;s={x:r.x-u,y:r.y};a={x:s.x-S,y:s.y+S/2}}}return{predecessor:s,successor:r,prompter:a}};y.prototype.calcLinePathD=function(e,t){var s=e.predecessor.x,r=e.predecessor.y;var a=e.successor.x,i=e.successor.y;var o,n=[s,r,a,i];var h=this.oGantt._edgePoint;if(r===i){if(t==f.FinishToStart&&a>s||t==f.StartToFinish&&s>a||e.prompter){o=this.calcIRlsPathD}else{o=this.calcSRlsPathD;n.push(t,h)}}else if(r!==i){if(t===f.FinishToFinish){o=this.calcURlsPathD;n.push(false,h)}else if(t===f.FinishToStart){if(s<=a){if(l.getRTL()?this.getLShapeForTypeSF():this.getLShapeForTypeFS()){if(h==2&&this.getShapeTypeStart()=="None"||h==3&&Math.abs(s-a)>=h*g){o=this.calcLRlsPathD}else{o=this.calcSRlsPathD;n.push(t,h)}}else if(Math.abs(s-a)>=2*h*g){o=this.calcZRlsPathD;n.push(h)}else{o=this.calcSRlsPathD;n.push(t,h)}}else if(s>a){o=this.calcSRlsPathD;n.push(t,h)}}else if(t===f.StartToFinish){if(s<a){o=this.calcSRlsPathD;n.push(t,h)}else if(s>=a){if(l.getRTL()?this.getLShapeForTypeFS():this.getLShapeForTypeSF()){if(h==2&&this.getShapeTypeStart()=="None"||h==3&&Math.abs(s-a)>=h*g){o=this.calcLRlsPathD}else{o=this.calcSRlsPathD;n.push(t,h)}}else if(Math.abs(s-a)>=2*h*g){o=this.calcZRlsPathD;n.push(h)}else{o=this.calcSRlsPathD;n.push(t,h)}}}else if(t===f.StartToStart){o=this.calcURlsPathD;n.push(true,h)}}if(o===this.calcLRlsPathD){var p=e.successor.dyTop?e.successor.dyTop:e.successor.dy;var c=e.successor.dyBottom?e.successor.dyBottom:e.successor.dy;n[2]=s<a?a+e.successor.dx:a-e.successor.dx;n[3]=r<i?i-p:i+c}this.setProperty("d",o.apply(this,n),true)};y.prototype.calcIRlsPathD=function(e,t,s,r){return this.getLinePathD([[e,t],[s,r]])};y.prototype.calcLRlsPathD=function(e,t,s,r){return this.getLinePathD([[e,t],[s,t],[s,r]])};y.prototype.calcURlsPathD=function(e,t,s,r,a,i){var o=e<s?s+i*g:e+i*g;var n=e<s?e-i*g:s-i*g;var h=!a?o:n;if(this.getRelationshipOverDivider()){var p=e<s?e+i*g:s+i*g;var l=e<s?s-i*g:e-i*g;var c=!a?p:l;var d=t>r?this.predYTop:this.predYBottom;var u=t<r?this.sucYTop:this.sucYBottom;if(!a&&e<s||a&&e>s){return this.getLinePathD([[e,t],[c,t],[c,d],[h,d],[h,r],[s,r]])}else{return this.getLinePathD([[e,t],[h,t],[h,u],[c,u],[c,r],[s,r]])}}else{return this.getLinePathD([[e,t],[h,t],[h,r],[s,r]])}};y.prototype.calcSRlsPathD=function(e,t,s,r,a,i){var o=a==0||a==1?e+i*g:e-i*g;var n=t>r?this.predYTop:this.predYBottom;var h=a==0||a==2?s+i*g:s-i*g;return this.getLinePathD([[e,t],[o,t],[o,n],[h,n],[h,r],[s,r]])};y.prototype.calcZRlsPathD=function(e,t,s,r,a){var i=e<s?e+a*g:e-a*g;if(this.getRelationshipOverDivider()){var o=t<r?this.sucYTop:this.sucYBottom;var n=e<s?s-a*g:s+a*g;return this.getLinePathD([[e,t],[i,t],[i,o],[n,o],[n,r],[s,r]])}else{return this.getLinePathD([[e,t],[i,t],[i,r],[s,r]])}};y.prototype.getConnectorEndPath=function(e,t,s){var r=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(r);var i=[];var o;var n=this.getEnableCurvedEdge()?a[a.length-4]:a[a.length/2-2];var h=this.getEnableCurvedEdge()?a[a.length-3]:a[a.length/2-1];var p=this.getEnableCurvedEdge()?a[a.length-2]:a[a.length/2+0];var l=this.getEnableCurvedEdge()?a[a.length-1]:a[a.length/2+1];if(n==p){if(h>l){i=this.getCoordinateUpDown(p,l,"up");o=a[0]<p?"rightUp":"leftUp"}else{i=this.getCoordinateUpDown(p,l,"down");o=a[0]<p?"rightDown":"leftDown"}}else if(n!=p){i=n<p?this.getCoordinate(p,l,"rightEnd"):this.getCoordinate(p,l,"leftEnd")}return this.renderSvg(i,"end",t,s,o)};y.prototype.getConnectorStartPath=function(e,t,s){var r=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(r);var i=a[0],o=a[1];var n=s==0||s==1?this.getCoordinate(i,o,"rightStart"):this.getCoordinate(i,o,"leftStart");return this.renderSvg(n,"start",t,s)};y.prototype.renderSvg=function(e,t,s,r,a){var i=[];var o=this._checkConnectorOverlap(s,r,t,a);if(o==d.Arrow){if(t=="start"){i.push(e[0],e[1],e[4],e[7])}else{i.push(e[0],e[3],e[5])}return d3.svg.line().interpolate("linear-closed")(i)}else if(o==d.Square){i.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==d.Diamond){i.push(e[0],e[2],e[4],e[6]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==d.Circle){i.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("basis-closed")(i)}else if(o===d.HorizontalRectangle){i.push(e[0],e[15],e[9],e[10],e[16]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==d.VerticalRectangle){i.push(e[0],e[11],e[12],e[13],e[14]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==d.None){i.push(e[0]);return d3.svg.line().interpolate("linear")(i)}};y.prototype._checkConnectorOverlap=function(e,t,s,a){var i=c.getElementById(e);var o=r._getVisibleRelationships(i);var n=this.getRelatedInRowShapes(e);var h=l.getRTL();var p,g,u,S=[];var y=function(e){g=[1,2];if(n.predecessor&&n.successor){o.forEach(function(t){if(t.mProperties.successor&&t.mProperties.predecessor){if(n.successor.mProperties.shapeId===t.getSuccessor()&&g.indexOf(f[t.getType()])!==-1&&t._getLMarker()===e){S.push(t.getShapeTypeEnd())}}})}S=r.getFilteredShapeType(S);var t=S.length>1?d.HorizontalRectangle:this.getShapeTypeEnd();if(t==d.VerticalRectangle||t==d.HorizontalRectangle){t=t==d.VerticalRectangle?d.HorizontalRectangle:d.VerticalRectangle}return t}.bind(this);var v=function(e,t){return e===d.Arrow?t:e};if(s=="start"){if(h){g=t==0||t==1?[2,3]:[0,1];u=t==0||t==1?[1,3]:[0,2]}else{g=t==0||t==1?[0,1]:[2,3];u=t==0||t==1?[0,2]:[1,3]}if(n.predecessor&&n.successor){o.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(n.predecessor.mProperties.shapeId==e.getPredecessor()&&g.indexOf(f[e.getType()])!==-1){S.push(v(e.getShapeTypeStart(),"ArrowStart"))}if(n.predecessor.mProperties.shapeId==e.getSuccessor()&&u.indexOf(f[e.getType()])!==-1&&e._getLMarker()==""){S.push(v(e.getShapeTypeEnd(),"ArrowEnd"))}}})}S=r.getFilteredShapeType(S);p=S.length>1?d.HorizontalRectangle:this.getShapeTypeStart()}else if(a=="rightUp"||a=="rightDown"||a=="leftUp"||a=="leftDown"){p=y(a)}else{if(h){g=t==1||t==3?[0,2]:[1,3];u=t==1||t==3?[0,1]:[2,3]}else{g=t==1||t==3?[1,3]:[0,2];u=t==1||t==3?[2,3]:[0,1]}if(n.predecessor&&n.successor){o.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(n.successor.mProperties.shapeId==e.getSuccessor()&&g.indexOf(f[e.getType()])!==-1&&e._getLMarker()==""){S.push(v(e.getShapeTypeEnd(),"ArrowEnd"))}if(n.successor.mProperties.shapeId==e.getPredecessor()&&u.indexOf(f[e.getType()])!==-1){S.push(v(e.getShapeTypeStart(),"ArrowStart"))}}})}S=r.getFilteredShapeType(S);p=S.length>1?d.HorizontalRectangle:this.getShapeTypeEnd()}return p};y.prototype.getCoordinate=function(e,t,s){var r=s=="rightStart"||s=="leftEnd"?e+this.SHAPE_SIZE/2:e-this.SHAPE_SIZE/2;var a=s=="rightStart"||s=="leftEnd"?e+this.SHAPE_SIZE:e-this.SHAPE_SIZE;var i=s=="rightStart"||s=="leftEnd"?e+2*g:e-2*g;var o=s=="rightStart"||s=="leftEnd"?e+g:e-g;var n=[[e,t],[e,t-this.SHAPE_SIZE/2],[r,t-this.SHAPE_SIZE/2],[a,t-this.SHAPE_SIZE/2],[a,t],[a,t+this.SHAPE_SIZE/2],[r,t+this.SHAPE_SIZE/2],[e,t+this.SHAPE_SIZE/2],[r,t],[i,t-g/2],[i,t+g/2],[e,t-g],[o,t-g],[o,t+g],[e,t+g],[e,t-g/2],[e,t+g/2]];return n};y.prototype.getCoordinateUpDown=function(e,t,s){var r=s=="up"?t+this.SHAPE_SIZE/2:t-this.SHAPE_SIZE/2;var a=s=="up"?t+this.SHAPE_SIZE:t-this.SHAPE_SIZE;var i=s=="up"?t+2*g:t-2*g;var o=s=="up"?t+g:t-g;var n=[[e,t],[e+this.SHAPE_SIZE/2,t],[e+this.SHAPE_SIZE/2,r],[e+this.SHAPE_SIZE/2,a],[e,a],[e-this.SHAPE_SIZE/2,a],[e-this.SHAPE_SIZE/2,r],[e-this.SHAPE_SIZE/2,t],[e,r],[e+g/2,i],[e-g/2,i],[e+g,t],[e+g,o],[e-g,o],[e-g,t],[e+g/2,t],[e-g/2,t]];return n};y.prototype.getShapeAnchors=function(e){var t={predecessor:null,successor:null};Object.keys(e).forEach(function(s){var r=e[s];if(r==null){return}if(r.getShapeAnchors){t[s]=r.getShapeAnchors()}else{var a,i,o;if(r.getDomRef("nonLabelGroup")){a=r.getDomRef("nonLabelGroup").getBBox();i=3/4;o=3/4}else{a=r.getDomRef().getBBox();i=r.getLeftAnchorPosition()/100;o=r.getRightAnchorPosition()/100}var n,h=0;n=window.getComputedStyle(r.getDomRef()).transform.match(/matrix.*\((.+)\)/);if(n){h=n[1].split(", ")[5]}t[s]={head:{x:a.x,y:a.y+a.height*i+parseFloat(h),dx:0,dyTop:a.height*i,dyBottom:a.height*(1-i)},tail:{x:a.x+a.width,y:a.y+a.height*o+parseFloat(h),dx:0,dyTop:a.height*o,dyBottom:a.height*(1-o)}}}});return t};y.prototype.renderRelationship=function(t,i,o,n){this.writeElementData(t,"g",true);a.renderAttributes(t,this,["style"]);t.openEnd();a.renderTooltip(t,this);t.openStart("path");if(!this.getEnableCurvedEdge()||i.prompter){t.attr("d",this.getD())}else{t.style("fill","none");t.attr("d",r.getPathCorners(this.getD(),5))}t.openEnd().close("path");t.openStart("path");if(!this.getEnableCurvedEdge()||i.prompter){t.attr("d",this.getD());t.style("fill","none")}else{t.style("fill","none");t.attr("d",r.getPathCorners(this.getD(),5))}t.style("stroke-width",8);t.style("stroke","none");t.style("pointer-events","stroke");t.openEnd().close("path");t.openStart("path");t.style("fill",this.getStartShapeColor());t.style("stroke-dasharray","none");t.attr("d",this.getConnectorStartPath(this.getD(),n,o));t.openEnd().close("path");t.openStart("path");t.style("fill",this.getEndShapeColor());t.style("stroke-dasharray","none");t.attr("d",this.getConnectorEndPath(this.getD(),n,o));t.openEnd().close("path");if(i.prompter){t.openStart("text");t.attr("x",i.prompter.x);t.attr("y",i.prompter.y);t.attr("font-size",S);t.attr("font-family","SAP-icons");t.attr("text-anchor",l.getRTL()&&!e.browser.edge?"end":"start");t.attr("stroke-width",0);t.openEnd();t.text(s.getIconInfo("chain-link").content);t.close("text")}t.close("g")};y.prototype.getStyle=function(){return this.getInlineStyle({fill:this.getStroke()||o.get("sapUiBaseText"),stroke:this.getStroke()||o.get("sapUiBaseText"),"stroke-width":this.getStrokeWidth()||1,"stroke-dasharray":this.getStrokeDasharray(),opacity:this.getStrokeOpacity()})};y.prototype.getLinePathD=function(e){if(this.getEnableCurvedEdge()){return d3.svg.line().interpolate("linear")(e)}else{e=e.concat(e.slice(1,-1).reverse());return d3.svg.line().interpolate("linear-closed")(e)}};y.prototype.getSelectedStyle=function(){return this.getInlineStyle({fill:this.getSelectedStroke(),stroke:this.getSelectedStroke(),"stroke-width":this.getSelectedStrokeWidth(),"stroke-dasharray":this.getStrokeDasharray(),"pointer-events":"none"})};y.prototype.getBaseRowHeight=function(e){return c.getElementById(e).getTable()._getDefaultRowHeight()};y.prototype.getProcessedType=function(){var e=this.getProperty("type");var t=l.getRTL();return t?3-f[e]:f[e]};y.prototype.getRelatedInRowShapes=function(e){var t=r.shapeElementById(this.getPredecessor(),e+"-svg");var s=r.shapeElementById(this.getSuccessor(),e+"-svg");return{predecessor:t?t:r.isRelationshipConnectedToPseudoShapes(this.getPredecessor(),e),successor:s?s:r.isRelationshipConnectedToPseudoShapes(this.getSuccessor(),e)}};return y},true);
//# sourceMappingURL=Relationship.js.map