/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_debounce","sap/ui/dt/Plugin","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/rta/util/hasStableId"],function(e,t,i,n,a,s,r){"use strict";const o={CTX_RENAME:10,CTX_ADD_ELEMENTS_AS_SIBLING:20,CTX_ADD_ELEMENTS_AS_CHILD:25,CTX_ADD_ELEMENTS_CHILD_AND_SIBLING:30,CTX_CREATE_SIBLING_CONTAINER:40,CTX_CREATE_CHILD_CONTAINER:50,CTX_REMOVE:60,CTX_LOCAL_RESET:65,CTX_CUT:70,CTX_PASTE:80,CTX_GROUP_FIELDS:90,CTX_UNGROUP_FIELDS:100,CTX_ADDXML_AT_EXTENSIONPOINT:105,CTX_SETTINGS:110,CTX_CREATE_SIBLING_IFRAME:130,CTX_ANNOTATION:140,CTX_VARIANT_SET_TITLE:200,CTX_COMP_VARIANT_RENAME:200,CTX_VARIANT_SAVE:210,CTX_COMP_VARIANT_SAVE:210,CTX_VARIANT_SAVEAS:220,CTX_COMP_VARIANT_SAVE_AS:220,CTX_VARIANT_MANAGE:230,CTX_COMP_VARIANT_MANAGE:230,CTX_VARIANT_SWITCH_SUBMENU:240,CTX_COMP_VARIANT_SWITCH:240,CTX_COMP_VARIANT_CONTENT:250};function l(e,t,i){var n=i;if(typeof this.getActionName()==="string"){if(this.isResponsibleElementActionAvailable(i)){n=this.getResponsibleElementOverlay(i)}}var a=n.getElement()&&n.getDesignTimeMetadata()&&!n.getDesignTimeMetadata().markedAsNotAdaptable()&&this._isEditable(n,{sourceElementOverlay:i,...e});if(a&&typeof a.then==="function"){a.then(function(e){this._handleModifyPluginList(i,e)}.bind(this));t.push(a)}else{this._handleModifyPluginList(i,a)}return t}var u=t.extend("sap.ui.rta.plugin.Plugin",{metadata:{abstract:true,library:"sap.ui.rta",properties:{commandFactory:{type:"object",multiple:false},commandStack:{type:"object",multiple:false}},events:{elementModified:{command:{type:"sap.ui.rta.command.BaseCommand"}}}}});u.prototype._isEditable=function(){};u.prototype.executeWhenVisible=function(e,t){var i=function(n){if(n.getSource().getGeometry()&&n.getSource().getGeometry().visible){e.detachEvent("geometryChanged",i,this);t()}};var n=e.getGeometry();if(e.getElementVisibility()&&(!n||!n.visible)){e.attachEvent("geometryChanged",i,this)}else{t()}};function g(t,i,n,a){var s=i.getId();t[s]||={};t[s][n]||=e(a,16);t[s][n]()}var c=async function(e){if(this.getCommandStack()){await this.getCommandStack().getLastCommandExecuted()}if(!this._mDebounceFunctions){this._mDebounceFunctions={insertOrRemove:{},addOrSet:{}}}var t=e.getParameters();var i;var n=e.getSource();if(t.type==="propertyChanged"&&t.name==="visible"){i=this._getRelevantOverlays(n);if(t.value===true){this.executeWhenVisible(n,function(){this.evaluateEditable(i,{onRegistration:false})}.bind(this))}else{this.evaluateEditable(i,{onRegistration:false})}}else if(t.type==="afterRendering"){if(this.getDesignTime().getStatus()==="synced"){this.evaluateEditable([n],{onRegistration:false})}else{this.getDesignTime().attachEventOnce("synced",function(){this.evaluateEditable([n],{onRegistration:false})},this)}}else if(t.type==="insertAggregation"||t.type==="removeAggregation"){g(this._mDebounceFunctions.insertOrRemove,n,t.name,function(){i=this._getRelevantOverlays(n,t.name);this.evaluateEditable(i,{onRegistration:false})}.bind(this))}else if(t.type==="addOrSetAggregation"){g(this._mDebounceFunctions.addOrSet,n,t.name,function(){var e=this.getDesignTime();if(!e){return}if(e.getStatus()==="synced"){i=this._getRelevantOverlays(n,t.name);this.evaluateEditable(i,{onRegistration:false})}else{e.attachEventOnce("synced",function(){i=this._getRelevantOverlays(n,t.name);this.evaluateEditable(i,{onRegistration:false})},this)}}.bind(this))}};u.prototype._getRelevantOverlays=function(e,t){var i=e.getRelevantOverlays();if(i.length===0){var n=[];if(!e.getIsPartOfTemplate()){n=a.findAllOverlaysInContainer(e);if(t){var s=e.getAggregationOverlay(t);var r=s?s.getChildren():[];r=r.filter(function(e){return n.indexOf(e)===-1});n=n.concat(r)}}e.setRelevantOverlays(n);return n}return i};u.prototype.evaluateEditable=async function(e,t){if(!t.onRegistration&&this.getDesignTime()&&this.getDesignTime().getBusyPlugins().length){return}this.setProcessingStatus(true);var i=e.reduce(l.bind(this,t),[]);if(i.length){try{await Promise.all(i);this.setProcessingStatus(false)}catch(e){this.setProcessingStatus(false)}}else{this.setProcessingStatus(false)}};u.prototype._handleModifyPluginList=function(e,t){if(t!==undefined&&t!==null){if(typeof t==="boolean"){this._modifyPluginList(e,t)}else{this._modifyPluginList(e,t.asChild,false);this._modifyPluginList(e,t.asSibling,true)}}};u.prototype._modifyPluginList=function(e,t,i){if(t){this.addToPluginsList(e,i)}else{this.removeFromPluginsList(e,i)}};u.prototype._retrievePluginName=function(e){var t=this.getMetadata().getName();if(e!==undefined){t+=e?".asSibling":".asChild"}return t};u.prototype._isEditableByPlugin=function(e,t){var i=this._retrievePluginName(t);return e.getEditableByPlugins()[i]};u.prototype.registerElementOverlay=function(e){this.executeWhenVisible(e,function(){this.evaluateEditable([e],{onRegistration:true});e.attachElementModified(c,this)}.bind(this))};u.prototype.deregisterElementOverlay=function(e){this.removeFromPluginsList(e);this.removeFromPluginsList(e,true);this.removeFromPluginsList(e,false);e.detachElementModified(c,this)};u.prototype.hasStableId=function(e){return r(e)};u.prototype.getVariantManagementReference=function(e){var t;if(e.getVariantManagement){t=e.getVariantManagement()}return t};u.prototype.checkAggregationsOnSelf=function(e,t,i,a){var s=e.getDesignTimeMetadata();var r=e.getElement();var o=s.getActionDataFromAggregations(t,r,undefined,a);var l=o.filter(function(e){if(e&&i){return e.aggregation===i}return true})[0];var u=l?l.changeType:null;var g=l&&l.changeOnRelevantContainer;if(g){r=e.getRelevantContainer();var c=n.getOverlay(r);if(!this.hasStableId(c)){return Promise.resolve(false)}}if(u){return this.hasChangeHandler(u,r)}return Promise.resolve(false)};u.prototype.removeFromPluginsList=function(e,t){const i=this._retrievePluginName(t);const n=e.getEditableByPlugins();e.setEditableByPlugins({...n,[i]:false});if(!Object.values(e.getEditableByPlugins()).some(Boolean)){e.setEditable(false)}};u.prototype.addToPluginsList=function(e,t){const i=this._retrievePluginName(t);const n=e.getEditableByPlugins();if(!n[i]){e.setEditableByPlugins({...n,[i]:true});e.setEditable(true)}};u.prototype.hasChangeHandler=function(e,t,n){return i.getChangeHandler({changeType:e,element:t,modifier:s,layer:this.getCommandFactory().getFlexSettings().layer,controlType:n}).then(function(){return true}).catch(function(){return false})};u.prototype.isAvailable=function(e){return e.every(function(e){return this._isEditableByPlugin(e)},this)};u.prototype._checkRelevantContainerStableID=function(e,t){if(e.changeOnRelevantContainer){var i=t.getRelevantContainer();var a=n.getOverlay(i);if(!this.hasStableId(a)){return false}}return true};u.prototype._checkChangeHandlerAndStableId=function(e){var t=this.getAction(e);if(t&&t.changeType){var i=t.changeOnRelevantContainer?e.getRelevantContainer():e.getElement();return this.hasChangeHandler(t.changeType,i).then(function(i){return i&&this._checkRelevantContainerStableID(t,e)&&this.hasStableId(e)}.bind(this))}return Promise.resolve(false)};u.prototype.getRank=function(e){return o[e]};u.prototype._getMenuItems=function(e,i){i.rank||=this.getRank(i.pluginId);return t.prototype._getMenuItems.apply(this,[e,i])};return u});
//# sourceMappingURL=Plugin.js.map