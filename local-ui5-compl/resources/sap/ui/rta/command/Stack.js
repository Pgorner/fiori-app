/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Utils","sap/ui/rta/command/Settings","sap/ui/rta/command/CompositeCommand","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/rta/util/showMessageBox","sap/ui/core/Lib"],function(e,t,n,o,i,r,a,s){"use strict";function u(e,t,n){var o=e[n];if(o){t.push(o)}return t}function d(e,t,n,a){var s=a.getSelector&&a.getSelector();var u=new o({selector:s,changeType:a.getChangeType(),element:r.bySelector(s,e)});u._oPreparedChange=a;var d=a.getSupportInformation().compositeCommand;if(d){if(!t[d]){t[d]=new i;n.pushExecutedCommand(t[d])}t[d].addCommand(u)}else{n.pushExecutedCommand(u)}}function m(e,t){const n=this.getAllExecutedCommands();e.forEach(e=>{n.some(n=>{if(n.getPreparedChange?.().getId()===e.getId()){n.setRelevantForSave(t);return true}return false})})}var c=e.extend("sap.ui.rta.command.Stack",{metadata:{library:"sap.ui.rta",properties:{saved:{type:"boolean",defaultValue:false},lastCommandExecuted:{type:"object",defaultValue:Promise.resolve()}},aggregations:{commands:{type:"sap.ui.rta.command.BaseCommand",multiple:true}},events:{modified:{},commandExecuted:{parameters:{command:{type:"object"},undo:{type:"boolean"}}}}}});c.initializeWithChanges=function(e,o){var i=new c;i._aPersistedChanges=o;if(o&&o.length>0){var r=n.getAppComponentForControl(e);var a={selector:r,invalidateCache:false};return t._getUIChanges(a).then(function(e){var t={};var n={};e.forEach(function(e){n[e.getId()]=e});o.reduce(u.bind(null,n),[]).forEach(d.bind(null,r,t,i));return i})}return Promise.resolve(i)};c.prototype.addCommandExecutionHandler=function(e){this._aCommandExecutionHandler.push(e)};c.prototype.removeCommandExecutionHandler=function(e){var t=this._aCommandExecutionHandler.indexOf(e);if(t>-1){this._aCommandExecutionHandler.splice(t,1)}};c.prototype.init=function(){this._aCommandExecutionHandler=[];this._toBeExecuted=-1};c.prototype._waitForCommandExecutionHandler=function(e){return Promise.all(this._aCommandExecutionHandler.map(function(t){return t(e)}))};c.prototype._getCommandToBeExecuted=function(){return this.getCommands()[this._toBeExecuted]};c.prototype.pushExecutedCommand=function(e){this.push(e,true);this.fireModified()};c.prototype.push=function(e,t){if(this._bUndoneCommands){this._bUndoneCommands=false;while(this._toBeExecuted>-1){this.pop()}}this.insertCommand(e,0);if(!t){this._toBeExecuted++}};c.prototype.top=function(){return this.getCommands()[0]};c.prototype.pop=function(){if(this._toBeExecuted>-1){this._toBeExecuted--}return this.removeCommand(0)};c.prototype.removeCommand=function(e,t){var n=this.removeAggregation("commands",e,t);return n};c.prototype.removeAllCommands=function(e){var t=this.removeAllAggregation("commands",e);this._toBeExecuted=-1;this.fireModified();return t};c.prototype.isEmpty=function(){return this.getCommands().length===0};c.prototype.execute=function(){this.setLastCommandExecuted(this.getLastCommandExecuted().catch(function(){}).then(function(){var e=this._getCommandToBeExecuted();if(e){var t={command:e,undo:false};return e.execute().then(this._waitForCommandExecutionHandler.bind(this,t)).then(function(){this._toBeExecuted--;const n=e.getDiscardedChanges?.();if(n){m.call(this,n,false)}this.fireCommandExecuted(t);this.fireModified()}.bind(this)).catch(function(t){t||=new Error("Executing of the change failed.");t.index=this._toBeExecuted;t.command=this.removeCommand(this._toBeExecuted);this._toBeExecuted--;var n=s.getResourceBundleFor("sap.ui.rta");const o=e.isA("sap.ui.rta.command.AddXMLAtExtensionPoint")?t.message:n.getText("MSG_GENERIC_ERROR_MESSAGE",[t.message]);a(o,{title:n.getText("HEADER_ERROR")},"error");return Promise.reject(t)}.bind(this))}return undefined}.bind(this)));return this.getLastCommandExecuted()};c.prototype._unExecute=function(){if(this.canUndo()){this._bUndoneCommands=true;this._toBeExecuted++;var e=this._getCommandToBeExecuted();const n=e.getDiscardedChanges?.();if(e){var t={command:e,undo:true};return e.undo().then(this._waitForCommandExecutionHandler.bind(this,t)).then(function(){if(n){m.call(this,n,true)}this.fireCommandExecuted(t);this.fireModified()}.bind(this))}return Promise.resolve()}return Promise.resolve()};c.prototype.canUndo=function(){return this._toBeExecuted+1<this.getCommands().length};c.prototype.canSave=function(){return this.canUndo()&&this.getAllExecutedCommands().some(function(e){return e.getRelevantForSave()})};c.prototype.undo=function(){return this._unExecute()};c.prototype.canRedo=function(){return!!this._getCommandToBeExecuted()};c.prototype.redo=function(){return this.execute()};c.prototype.pushAndExecute=function(e){this.push(e);return this.execute()};c.prototype.getAllExecutedCommands=function(){var e=[];var t=this.getCommands();for(var n=t.length-1;n>this._toBeExecuted;n--){var o=this.getSubCommands(t[n]);e=e.concat(o)}return e};c.prototype.getSubCommands=function(e){var t=[];if(e.getCommands){e.getCommands().forEach(function(e){var n=this.getSubCommands(e);t=t.concat(n)},this)}else{t.push(e)}return t};c.prototype.compositeLastTwoCommands=function(){var e=this.pop();var t=this.pop();var n=new i;n.addCommand(t);n.addCommand(e);this.push(n)};return c});
//# sourceMappingURL=Stack.js.map