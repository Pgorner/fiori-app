/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/rta/util/showMessageBox","sap/ui/core/BusyIndicator","sap/ui/core/EventBus","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/ui/fl/write/api/FeaturesAPI","sap/base/util/merge"],function(e,r,n,a,t,i,s,o,u){"use strict";var p;var c;var l;var v;var f;var h=function(){return e.getAppDescriptor(l)};var d=function(){return i.getInstance()};var g=function(){window.onbeforeunload=f};var A=function(e){var n=e?"MSG_DO_NOT_CLOSE_BROWSER_CURRENTLY_ADAPTING":"MSG_DO_NOT_CLOSE_BROWSER";f=window.onbeforeunload;window.onbeforeunload=r.handleBeforeUnloadEvent;return r.showMessage(n)};var w=function(e,r){return c.triggerCatalogPublishing(e,r,true)};var S=function(e){return c.triggerCatalogPublishing(e,null,false)};var I=function(e,n){if(p){r.closeOverviewDialog();return this.onGetOverview(true,n)}else if(!p&&e){a.hide();return this.onGetOverview(true,n)}return Promise.resolve()};var b=function(e,n,a){return e?r.navigateToFLPHomepage():I.call(this,!n,a)};var P=function(e,a){if(e&&e.response&&e.response.IAMId){if(!Array.isArray(e.response.CatalogIds)||e.response.CatalogIds.length===0){const e=r.getText("MSG_BASE_APP_CATALOGS_NOT_FOUND",a);const t=r.getText("HEADER_SAVE_APP_VARIANT_FAILED");n(e,{title:t},"error");return Promise.reject()}return c.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,a,true)}return Promise.resolve()};var _=function(e,r){if(e&&e.response&&e.response.IAMId&&e.response.inProgress){return c.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,r,false)}return Promise.resolve()};t.getInstance().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(p){p.destroy();p=null}});return{onGetOverview(e,n){var a=h();return new Promise(function(t){var i=function(){r.closeOverviewDialog()};var s="sap/ui/rta/appVariant/AppVariantOverviewDialog";var o={idRunningApp:a["sap.app"].id,isOverviewForKeyUser:e,layer:n};sap.ui.require([s],function(e){p||=new e(o);p.attachCancel(i);p.oPopup.attachOpened(function(){t(p)});p.open()})})},isOverviewExtended(){var e=new URLSearchParams(window.location.search);var r=e.get("sap-ui-xx-app-variant-overview-extended");if(!r){return false}return r.toLowerCase()==="true"},isManifestSupported(){var e=h();return r.getManifirstSupport(e["sap.app"].id)},isSaveAsAvailable(e,n,a){l=e;v=a;var t=h();if(t["sap.app"]&&t["sap.app"].id){return o.isSaveAsAvailable(n).then(function(e){if(e){if(t["sap.app"].crossNavigation&&t["sap.app"].crossNavigation.inbounds){return r.getInboundInfo(t["sap.app"].crossNavigation.inbounds)}return r.getInboundInfo()}return undefined}).then(function(e){return!!e})}return Promise.resolve(false)},getAppVariantDescriptor(e){l=e;var r=h();if(r["sap.app"]&&r["sap.app"].id){return s.load({id:r["sap.app"].id})}return Promise.resolve(false)},_determineSelector(e,r){return e?l:{appId:r["sap.app"].id,appVersion:r["sap.app"].applicationVersion.version}},onSaveAs(n,t,i,s){var o;var p;var l=h();var f=true;if(s&&s["sap.app"].id===l["sap.app"].id){t=true;l=u({},s);s=null}else if(s){f=false;l=u({},s);s=null}var S=this._determineSelector(f,l);return new Promise(function(s){var f=function(){return c.processSaveAsDialog(l,n)};var h=function(e){a.show();return c.createAllInlineChanges(e,S)};var I=function(e){var n=e.slice();return r.addChangesToPersistence(n,S)};var _=function(){var e=r.getNewAppVariantId();return c.createAppVariant(e,S).catch(function(n){var a=n.messageKey;a||="MSG_SAVE_APP_VARIANT_FAILED";return r.catchErrorDialog(n,a,e)})};var m=function(e){p=null;p=u({},e.response);return c.clearRTACommandStack(t)};var D=function(){var r=e.getUshellContainer();if(r&&t){r.setDirtyFlag(false)}};var O=function(e){D();o=r.isS4HanaCloud(e);var a=r.buildSuccessInfo(p.id,n,o);return c.showSuccessMessage(a)};var V=function(){var e=r.buildFinalSuccessInfoS4HANACloud();return c.showSuccessMessage(e)};var E=function(){a.show();if(o){var e;return A().then(function(){return w(p.id,p.reference)}).then(function(r){e={...r};a.hide();return b.call(this,n,null,i)}.bind(this)).then(function(){return P(e,p.id)}).then(function(){g();return V()}).then(function(){return n?s():b.call(this,n,o,i)}.bind(this))}a.hide();return b.call(this,n,o,i)};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(e){c||=new e({commandSerializer:v,layer:i});return f().then(h).then(I).then(_).then(m).then(d).then(O).then(E.bind(this)).then(s).catch(function(e){if(!e){return false}if(o){g()}return b.call(this,null,o,i).then(s)}.bind(this))}.bind(this))}.bind(this))},onDeleteFromOverviewDialog(e,n,t){var i;return new Promise(function(s){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(o){c||=new o({rootControl:l,commandSerializer:v,layer:t});var u=function(){return c.deleteAppVariant(e).catch(function(n){if(n==="cancel"){return Promise.reject("cancel")}var a=n.messageKey;a||="MSG_DELETE_APP_VARIANT_FAILED";return r.catchErrorDialog(n,a,e)})};var p=function(){r.closeOverviewDialog();var n=r.buildDeleteSuccessMessage(e,i);return c.showSuccessMessage(n)};var f=function(s){i=r.isS4HanaCloud(s);if(i){var o;return A(n).then(function(){return S(e)}).then(function(e){o={...e};return I.call(this,!n,t)}.bind(this)).then(function(){return _(o,e)})}a.show();return Promise.resolve()};var h=function(){if(i){g()}a.hide();return n?s():I.call(this,!i,i,t).then(s)};if(n){r.closeOverviewDialog();r.navigateToFLPHomepage()}return d().then(f.bind(this)).then(u).then(p).then(h.bind(this)).catch(function(e){if(e==="cancel"){return false}if(i){g()}return I.call(this,null,i,t).then(s)}.bind(this))}.bind(this))}.bind(this))}}});
//# sourceMappingURL=Feature.js.map