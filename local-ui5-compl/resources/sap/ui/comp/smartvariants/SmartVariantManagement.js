/*!
 * SAPUI5
 * (c) Copyright 2009-2024 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/thirdparty/jquery","sap/ui/comp/library","sap/ui/comp/variants/VariantItem","sap/ui/comp/odata/ODataModelUtil","sap/ui/comp/odata/MetadataAnalyser","./SmartVariantManagementAdapter","./SmartVariantManagementBase","sap/base/Log","sap/base/util/merge","sap/ui/base/SyncPromise"],function(t,jQuery,e,a,i,r,n,o,s,l,h){"use strict";var d=o.extend("sap.ui.comp.smartvariants.SmartVariantManagement",{metadata:{library:"sap.ui.comp",designtime:"sap/ui/comp/designtime/smartvariants/SmartVariantManagement.designtime",interfaces:["sap.ui.core.IShrinkable"],properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null}},aggregations:{personalizableControls:{type:"sap.ui.comp.smartvariants.PersonalizableInfo",multiple:true,singularName:"personalizableControl"}},events:{initialise:{},save:{parameters:{tile:{type:"boolean"},name:{type:"string"}}},afterSave:{}}},renderer:{apiVersion:2}});d.prototype.init=function(){o.prototype.init.apply(this);this._bIsInitialized=false;this._bIsVariantAdaptationEnabled=false;this._oStandardVariant=null;this._oControlPromise=null;this._oPersoControl=null;this._sAppStandardVariantKey=null;this._oSelectionVariantHandler={};this._oAppStdContent=null;this._aPersonalizableControls=[];this._oAdapter=null;this._bApplyingUIState=false;this._loadFlex()};d.prototype.setEntitySet=function(t){this.setProperty("entitySet",t,true);this._checkEntitySet(t);return this};d.prototype._checkEntitySet=function(t){if(!this._oMetadataPromise){this.attachModelContextChange(this._initializeMetadata,this);this._createMetadataPromise();this._initializeMetadata()}return this};d.prototype._createMetadataPromise=function(){this._oMetadataPromise=new Promise(t=>{this._fResolveMetadataPromise=t})};d.prototype._resolveMetadataPromise=function(){if(this._fResolveMetadataPromise){this._fResolveMetadataPromise()}};d.prototype._initializeMetadata=function(){if(!this.bIsInitialised){i.handleModelInit(this,this._onMetadataInitialised)}};d.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){var t=new r(this.getModel());if(t){this._oAdapter=new n({selectionPresentationVariants:t.getSelectionPresentationVariantAnnotationList(this.getEntitySet())});this.detachModelContextChange(this._initializeMetadata,this);this.bIsInitialised=true;this._resolveMetadataPromise()}}};d.prototype.applySettings=function(t){if(!t||!t.hasOwnProperty("useFavorites")){this.setUseFavorites(true)}if(t&&Object.hasOwn(t,"entitySet")&&t.entitySet){this._checkEntitySet(t.entitySet)}o.prototype.applySettings.apply(this,arguments)};d.prototype._createControlWrapper=function(e){var a=null;var i=t.getElementById(e.getControl());if(i){a={control:i,type:e.getType(),dataSource:e.getDataSource(),keyName:e.getKeyName(),loaded:jQuery.Deferred()}}return a};d.prototype._getControlWrapper=function(t){var e=this._getAllPersonalizableControls();if(e&&e.length){for(var a=0;a<e.length;a++){if(e[a].control===t){return e[a]}}}return null};d.prototype.addPersonalizableControl=function(e){var a,i=e.getControl();var r=t.getElementById(i);if(!r){s.error("couldn't obtain the control with the id="+i);return this}this.addAggregation("personalizableControls",e,true);a=this._createControlWrapper(e);if(a){this._aPersonalizableControls.push(a)}if(this.isPageVariant()){return this}this.setPersControler(r);return this};d.prototype._loadFlex=function(){return this.oModel.loadFlex().catch(t=>{s.error(t)})};d.prototype.setPersControler=function(t){if(this.oModel.isFlexLoaded()&&this.oModel._isFlexSupported(t)){this._oPersoControl=t;this._handleGetChanges(t);return}if(!this._oPersoControl){this.oModel.isFlexSupported(t).then(e=>{if(e){this._oPersoControl=t;this._handleGetChanges(t)}})}};d.prototype.setPersistencyKey=function(t){this.setProperty("persistencyKey",t);this.setPersControler(this);return this};d.prototype.isPageVariant=function(){if(this.getPersistencyKey()){return true}return false};d.prototype._getAdapter=function(){return this._oAdapter};d.prototype._handleGetChanges=function(t){if(!t||!this.oModel.isFlexLoaded()){return}this._oControlPromise=new Promise((t,e)=>{Promise.all([this._getStandardVariantItemName(),this._oMetadataPromise]).then(a=>{if(this._bIsBeingDestroyed){return}const i=a[0];var r={control:this._oPersoControl,standardVariant:{id:this.STANDARDVARIANTKEY,name:i,executeOnSelection:this.bExecuteOnSelectForStandardViaXML}};if(this._getAdapter()){r.variants=this._getAdapter().getODataVariants()}else if(this._getFilterBarAdapter()){r.variants=this._getFilterBarAdapter().variants}this.oModel.loadVariants(r,t,e)})})};d.prototype._getFilterBarAdapter=function(){return this._oSelectionVariantHandler["#"]};d.prototype._getVariantById=function(t){if(this._mVariants&&this._mVariants[t]){return this._mVariants[t]}return null};d.prototype.getVariantContent=function(t,e){var a,i=this._getVariantContent(e);if(i&&this.isPageVariant()&&t){a=this._getControlPersKey(t);if(a){i=this._retrieveContent(i,a)}}return i};d.prototype._getContent=function(t){return t.getContent()};d.prototype._getVariantContent=function(t){var e=this._getVariantById(t);if(e){var a=this._getContent(e);if(a){if(t===this.STANDARDVARIANTKEY&&Object.keys(a).length<1){a=this.getStandardVariant()}return l({},a)}}return null};d.prototype._getAllPersonalizableControls=function(){return this._aPersonalizableControls};d.prototype.removeAllPersonalizableControls=function(){this.removeAllAggregation("personalizableControls");this._aPersonalizableControls=[]};d.prototype.removePersonalizableControl=function(t){var e=this.removeAggregation("personalizableControls",t);if(e){this._aPersonalizableControls.some((t,a)=>{if(t.control.getId()===e.getControl()){this._aPersonalizableControls.splice(a,1);return true}return false})}return e};d.prototype.removePersonalizableControlById=function(t){var e=this.getAggregation("personalizableControls");if(e){e.some((e,a)=>{if(e.getControl()===t.getId()){this.removePersonalizableControl(e);return true}return false})}};d.prototype._variantItemChange=function(t){var e,a,i;if(t&&t.oSource&&t.oSource.isA("sap.ui.comp.variants.VariantItem")){i=t.oSource;if(i.getKey()!==this.STANDARDVARIANTKEY){a=t.getParameter("propertyName");if(a==="text"){this.removeVariantItem(i);e=this._getIdxSorted(i.getText());this.insertVariantItem(i,e)}}}};d.prototype._createVariantItem=function(t){try{const e={key:t.getVariantId(),title:t.getName(),sharing:t.isUserDependent()?"private":"public",remove:t.isDeleteEnabled(),favorite:t.getFavorite(),executeOnSelect:t.getExecuteOnSelection(),rename:t.isRenameEnabled(),visible:true,changeable:t.isEditEnabled(),author:t.getAuthor(),contexts:t.getContexts()};this._mVariants[t.getVariantId()]=t;this._insertVariantItem(t,e)}catch(t){s.error(t.message)}};d.prototype._createVariantEntries=function(t){if(t){if(t.defaultVariantId){this._setDefaultVariantKey(t.defaultVariantId,false)}if(t.standardVariant){this._createVariantItem(t.standardVariant);var e=this._getVariantContent(t.standardVariant.getVariantId());if(Object.keys(e).length>0){this._sAppStandardVariantKey=t.standardVariant.getVariantId();if(this._sAppStandardVariantKey!==this.STANDARDVARIANTKEY){this.setStandardVariantKey(this._sAppStandardVariantKey)}}}if(t.variants){t.variants.forEach(t=>{this._createVariantItem(t)})}this.resolveTitleBindings()}};d.prototype._addFavorites=function(t){t.forEach(t=>{if(t.key!==this.STANDARDVARIANTKEY){var e=this._getVariantById(t.key);if(e){this._flUpdateVariant(e,{favorite:t.visible});this._updateView(t.key,"favorite",t.visible)}}})};d.prototype._flUpdateVariant=function(t,e){return this.oModel.flUpdateVariant(t,e,this._oPersoControl)};d.prototype._flRemoveVariant=function(t){var e={control:this._oPersoControl,id:t.getVariantId(),layer:t.getLayer()};var a=this.oModel._flWriteRemoveVariant(e);if(a){delete this._mVariants[a.getVariantId()]}};d.prototype.flWriteOverrideStandardVariant=function(t){this.oModel.flWriteOverrideStandardVariant(t,this._oPersoControl)};d.prototype.getCurrentVariantId=function(){if(this._bDuringVariantCreation){return"SV1656651501366"}var t=this.getCurrentVariantKey();if(t===this.STANDARDVARIANTKEY){t=""}return t};d.prototype.clearVariantSelection=function(){this.setSelectionKey(this.getStandardVariantKey())};d.prototype.setCurrentVariantId=function(t,e){var a;if(this._oPersoControl){a=this._determineVariantId(t);this.setCurrentVariantKey(a);if(this._oStandardVariant){this.setModified(false);if(!e){this._triggerSelectVariant(a,"SET_VM_ID")}}}};d.prototype._determineVariantId=function(t){var e=t;if(!e||!this.getItemByKey(e)){e=this.getStandardVariantKey()}return e};d.prototype.initialise=function(t,e){var a,i;try{if(e&&t){a=this._getControlWrapper(e);if(!a){s.error("initialise on an unknown control.");return}if(a.bInitialized){s.error("initialise on "+e.getId()+" already executed");return}a.fInitCallback=t}else if(!this.isPageVariant()){a=this._getControlWrapper(this._oPersoControl)}const r=this.oModel.getPersistencyPromise();if(!r){this._errorHandling("'initialise' no '_oPersistencyPromise'  available",t,e);return}return r.then(()=>{if(!this._oControlPromise||!this._oPersoControl||!a){this._errorHandling("'initialise' no personalizable component available",t,e);return}Promise.all([this._oMetadataPromise,this._oControlPromise,...this.oModel.retrieveDataFromFlex()]).then(t=>{const[,e,i,r,n]=t;this._dataReceived(e,i,r,n,a)},a=>{i="'loadVariants' failed:";if(a&&a.message){i+=" "+a.messages}this._errorHandling(i,t,e)},a=>{if(a&&a.message){i=a.message}else{i="accessing either flexibility functionality or odata metadata."}this._errorHandling("'initialise' failed: "+i,t,e)})}).catch(a=>{if(a&&a.message){i=a.message}else{i="accessing the flexibility functionality."}this._errorHandling("'initialise' failed: "+i,t,e)})}catch(a){this._errorHandling("exception occurs during 'initialise' processing",t,e)}};d.prototype._errorHandling=function(t,e,a){var i={variantKeys:[]};this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),t);if(e&&a){e.call(a)}else{this.fireEvent("initialise",i)}if(a.variantsInitialized){a.variantsInitialized()}this.setInErrorState(true)};d.prototype.isVariantAdaptationEnabled=function(){return this._bIsVariantAdaptationEnabled};d.prototype._dataReceived=function(t,e,a,i,r){var n,o,s={variantKeys:[]};if(this._bIsBeingDestroyed){return}if(!this._bIsInitialized){this._bIsVariantAdaptationEnabled=i;this.setVariantCreationByUserAllowed(a);this.setShowShare(e);this._bIsInitialized=true;this._createVariantEntries(t);o=this._getDefaultVariantKey();if(!o||!this._getVariantById(o)&&o.substring(0,1)!=="#"){o=this.getStandardVariantKey()}n=this._getVariantById(o);if(n){this.setDefaultVariantKey(o);this.setSelectionKey(o)}if(this._sAppStandardVariantKey){this._oAppStdContent=this._getVariantContent(this._sAppStandardVariantKey)}}this._initialize(s,r)};d.prototype._initialize=function(t,e){var a,i=null,r=this.isPageVariant();var n,o=false;if(this._oAppStdContent){if(e.type==="table"||e.type==="chart"){if(r){this._applyControlVariant(e.control,this._oAppStdContent,"STANDARD",true)}else{this._applyVariant(e.control,this._oAppStdContent,"STANDARD",true)}}}if(e.fInitCallback){e.fInitCallback.call(e.control);delete e.fInitCallback;e.bInitialized=true}else{t.variantKeys=Object.keys(this._mVariants);this.fireEvent("initialise",t)}a=this.getCurrentVariantKey();if(a&&a!==this.getStandardVariantKey()){i=this._getVariantContent(a);n=this._getVariantById(a);if(n){o=n.getExecuteOnSelection()}}else if(this._oAppStdContent){i=this._oAppStdContent;if(e.type==="table"||e.type==="chart"){i=null}}var l;if(this._sAppStandardVariantKey){l=this._updateStandardVariant(e,this._oAppStdContent)}else{l=this._setStandardVariant(e)}h.resolve(l).then(t=>{e.loaded.resolve();if(i){if(this._getAdapter()&&a.substring(0,1)==="#"&&Object.entries(i).length===0){this._applyUiState(a,"INIT",o)}else if(r){this._applyControlVariant(e.control,i,"INIT",true,o)}else{this._applyVariant(e.control,i,"INIT",true,o)}}if(this.bConsiderXml!==undefined){this._executeOnSelectForStandardVariantByXML(this.bConsiderXml)}if(e.control.variantsInitialized){e.control.variantsInitialized()}if(this.getCurrentVariantKey()===this.getStandardVariantKey()){if(this._getApplyAutomaticallyOnStandardVariant()&&e.control.search){e.control.search()}if(this.getExecuteOnSelectForStandardVariant()&&this._oAppStdContent){var n=this.getItemByKey(this.getCurrentVariantKey());if(n){n.setExecuteOnSelect(true)}}}if(!this.getEnabled()){this.setEnabled(true)}}).catch(t=>{s.error("'_initialize' throws an exception:"+t.message)}).unwrap()};d.prototype._updateVariant=function(t){return h.resolve(this._fetchContentAsync()).then(e=>{if(t.key!==this.getStandardVariantKey()){var a=this._getVariantById(t.key);if(a){if(e){var i=this.getItemByKey(t.key);var r={content:e};if(a.getPackage()){r.transportId=a.getPackage()}if(a.getRequest()){r.packageName=a.getRequest()}if(i){r.executeOnSelection=i.getExecuteOnSelect()}this._flUpdateVariant(a,r);if(t.def===true){this._setDefaultVariantKey(t.key)}}this._afterSave(t,false)}}}).catch(t=>{s.error("'_updateVariant' throws an exception:"+t.message)}).unwrap()};d.prototype._createChangeHeader=function(){if(this.isPageVariant()){return{type:"page",dataService:"n/a"}}var t=this._getAllPersonalizableControls();if(t&&t.length>0){return{type:t[0].type,dataService:t[0].dataSource}}};d.prototype._newVariant=function(t){this._bDuringVariantCreation=true;return h.resolve(this._fetchContentAsync()).then(e=>{var a=this._createChangeHeader();var i={type:a.type,ODataService:a.dataSource,texts:{variantName:t.name},content:e,isVariant:true,isUserDependent:!t.public,executeOnSelection:t.execute};var r=this.oModel._flWriteAddVariant({control:this._oPersoControl,changeSpecificData:i});if(r){var n=r.getVariantId();this._mVariants[n]=r;const e=this._flUpdateVariant(r,{favorite:true});if(e){this._mVariants[e.getVariantId()]=e}this._createVariantItem(r);this.setSelectionKey(n);this._bDuringVariantCreation=false;if(t.def===true){this._setDefaultVariantKey(n);this.setDefaultVariantKey(n)}this._afterSave(t,true)}}).catch(t=>{this._bDuringVariantCreation=false;s.error("'_newVariant' throws an exception:"+t.message)}).unwrap()};d.prototype._fetchContent=function(){var t,e,a,i={};var r=this._getAllPersonalizableControls();for(var n=0;n<r.length;n++){t=r[n];if(t&&t.control&&t.control.fetchVariant){a=t.control.fetchVariant();if(a){a=l({},a);if(this.isPageVariant()){e=this._getControlPersKey(t);if(e){i=this._assignContent(i,a,e)}else{s.error("no persistancy key retrieved")}}else{i=a;break}}}}return i};d.prototype._fetchContentAsync=function(){var t,e,a,i={},r=[],n=[];var o=this._getAllPersonalizableControls();for(var h=0;h<o.length;h++){t=o[h];if(t&&t.control&&t.control.fetchVariant){a=t.control.fetchVariant();if(a){if(a&&a instanceof Promise){this.setEnabled(false);r.push(a);n.push(t);continue}a=l({},a);if(this.isPageVariant()){e=this._getControlPersKey(t);if(e){i=this._assignContent(i,a,e)}else{s.error("no persistancy key retrieved")}}else{i=a;break}}}}if(r.length>0){var d=null;var p=new Promise((t,e)=>{d=t});Promise.all(r).then(t=>{for(var r=0;r<t.length;r++){a=l({},t[r]);if(this.isPageVariant()){e=this._getControlPersKey(n[r]);if(e){i=this._assignContent(i,a,e)}else{s.error("no persistancy key retrieved")}}else{i=a;break}}d(i)});return p}else{return i}};d.prototype._getControlInfoPersKey=function(t){var e=null;if(t.keyName==="id"){e=t.control.getId()}else{e=t.control.getProperty(t.keyName)}return e};d.prototype._getControlPersKey=function(t){var e=t;if(!t.keyName){e=this._getControlWrapper(t)}return this._getControlInfoPersKey(e)};d.prototype._appendLifecycleInformation=function(t,e){var a;if(t){a=t.getRequest();if(a===null||a===undefined){a=""}}return a};d.prototype._renameVariant=function(t){if(t.key!==this.getStandardVariantKey()){if(t){var e=this._getVariantById(t.key);if(e){var a={name:t.name};var i=this._appendLifecycleInformation(e,t.key);if(i!=undefined){a.transportId=i}this._flUpdateVariant(e,a);this._reorderList(t.key,t.name)}}}};d.prototype._deleteVariants=function(t){var e;var a=this._getDefaultVariantKey();var i=this.getCurrentVariantKey();if(t&&t.length){for(var r=0;r<t.length;r++){var n=t[r];var o=this._getVariantById(n);if(o){e=this._appendLifecycleInformation(o,n);o.setRequest(e);this._flRemoveVariant(o);var s=this.getItemByKey(n);if(s){this._removeViewItem(s.getKey());this.removeVariantItem(s)}if(a&&a===n){this._setDefaultVariantKey("")}if(n===i){this.setModified(false);this.setCurrentVariantKey(this.STANDARDVARIANTKEY);this._selectVariant(this.STANDARDVARIANTKEY)}}}}};d.prototype._executeOnSelectForStandardVariantByXML=function(t){o.prototype._executeOnSelectForStandardVariantByXML.apply(this,arguments);this._reapplyExecuteOnSelectForStandardVariant(t)};d.prototype._reapplyExecuteOnSelectForStandardVariant=function(t){if(Object.keys(this._mVariants).length>0){this.bConsiderXml=undefined;this.flWriteOverrideStandardVariant(t);var e=this.getStandardVariantKey();var a=this._getVariantById(e);if(a){var i=this.getItemByKey(e);if(i){i.setExecuteOnSelect(a.getExecuteOnSelection());this._reapplyExecuteOnSelectForStandardVariantItem(a.getExecuteOnSelection())}}}else{this.bConsiderXml=t}};d.prototype.setExecuteOnStandard=function(t){this._reapplyExecuteOnSelectForStandardVariant(t)};d.prototype.getExecuteOnStandard=function(){var t=this.getStandardVariantKey();var e=this.getItemByKey(t);if(e){return e.getExecuteOnSelect()}return undefined};d.prototype._getApplyAutomaticallyOnStandardVariant=function(){var t=this.getExecuteOnSelectForStandardVariant();if(this._fRegisteredApplyAutomaticallyOnStandardVariant&&this.getDisplayTextForExecuteOnSelectionForStandardVariant()){try{t=this._fRegisteredApplyAutomaticallyOnStandardVariant()}catch(t){s.error("callback for determination of apply automatically on standard variant failed")}}return t};d.prototype._getDefaultVariantKey=function(){return this.oModel._getDefaultVariantId()};d.prototype._setDefaultVariantKey=function(t,e=true){return this.oModel._setDefaultVariantId(t,e?this._oPersoControl:undefined)};d.prototype._setExecuteOnSelections=function(t){if(t&&t.length){for(var e=0;e<t.length;e++){var a=this._getVariantById(t[e].key);if(a){var i=t[e].key;this._flUpdateVariant(a,{executeOnSelection:t[e].exe});this._updateView(i,"executeOnSelect",t[e].exe)}}}};d.prototype._save=function(t,e){if(this.oModel.isFlexLoaded()){try{this.oModel.save(this._oPersoControl).then(()=>{if(!e){if(t){this._updateUser()}this.fireEvent("afterSave")}}).catch(t=>{var e="'_save' failed:";if(t&&t.message){e+=" "+t.message}this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),e)})}catch(t){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),"'_save' throws an exception")}}};d.prototype._updateUser=function(){var t=this.getInitialSelectionKey();var e,a=this._getVariantById(t);if(a){e=a.getAuthor();if(e){this._assignUser(t,e)}}};d.prototype.fireSave=function(t){var e={};if(t){if(t.hasOwnProperty("tile")){e.tile=t.tile}e.name=t.name;if(t.overwrite){if(t.key!==this.getStandardVariantKey()){this.fireEvent("save",e);if(t.key===this.STANDARDVARIANTKEY){this._newVariant(t)}else{this._updateVariant(t)}}}else{this.fireEvent("save",e);this._newVariant(t)}}};d.prototype._afterSave=function(t,e){this.setEnabled(true);this.setModified(false);this._save(e)};d.prototype.fireManage=function(t){var e,a=false;if(t){if(t.renamed){for(e=0;e<t.renamed.length;e++){this._renameVariant(t.renamed[e])}}if(t.deleted){this._deleteVariants(t.deleted)}if(t.exe){this._setExecuteOnSelections(t.exe)}if(t.def){var i=this._getDefaultVariantKey();if(i!==t.def){if(!(i===""&&t.def===this.STANDARDVARIANTKEY)){this._setDefaultVariantKey(t.def);this.setDefaultVariantKey(t.def);a=true}}}if(t.fav&&t.fav.length>0){this._addFavorites(t.fav)}this._checkUpdate();if(t.deleted&&t.deleted.length>0||t.renamed&&t.renamed.length>0||t.exe&&t.exe.length>0||a){this._save()}else if(t.fav&&t.fav.length>0){this._save(false,true)}this.fireEvent("manage",t)}};d.prototype.fireSelect=function(t,e){if(this._oPersoControl&&t&&t.key){this._triggerSelectVariant(t.key,e);this.fireEvent("select",t)}};d.prototype._selectVariant=function(t,e){this.setModified(false);this.fireSelect({key:t},e)};d.prototype._checkForSelectionHandler=function(t){var e=null,a=Object.keys(this._oSelectionVariantHandler);if(a.length>-1){a.some(a=>{if(t.indexOf(a)===0){e=this._oSelectionVariantHandler[a];return true}return false})}return e};d.prototype._triggerSelectVariant=function(t,e){var a,i,r=false;var n=this._checkForSelectionHandler(t);var o=this._getVariantById(t);if(o){a=o.getExecuteOnSelection();if(t===this.getStandardVariantKey()){a=this._getApplyAutomaticallyOnStandardVariant()}r=Object.entries(this._getContent(o)).length===0?false:true}if(r){i=this._getGeneralSelectVariantContent(t,e)}else if(this._getAdapter()&&t.substring(0,1)==="#"){this._applyUiState(t,"SPV_VARIANT",a);return}else if(n){i=this._getSpecialSelectVariantContent(t,e,n)}else{i=this._getGeneralSelectVariantContent(t,e)}if(i){if(this.isPageVariant()){this._applyVariants(i,e,a)}else{this._applyVariant(this._oPersoControl,i,e,false,a)}}};d.prototype._getSpecialSelectVariantContent=function(t,e,a){return a.callback.call(a.handler,t,e)};d.prototype._getGeneralSelectVariantContent=function(t,e){var a=this._getVariantContent(t);if(a){a=l({},a)}return a};d.prototype.currentVariantSetModified=function(t){if(!this._bApplyingUIState){o.prototype.currentVariantSetModified.apply(this,arguments)}};d.prototype._applyControlUiState=function(t,e,a){if(t&&e){t.loaded.then(()=>{if(t.control.setUiStateAsVariant){t.control.setUiStateAsVariant(e,a)}})}};d.prototype._applyUiState=function(t,e,a){var i,r=this._getAdapter(),n=null,o=this._getAllPersonalizableControls();var s=null;if(r){n=r.getUiState(t);this._bApplyingUIState=true;for(i=0;i<o.length;i++){if(o[i]&&o[i].control&&o[i].loaded){this._applyControlUiState(o[i],n,e);if(o[i].control.search){s=o[i].control}}}this._bApplyingUIState=false;if(a&&s){s.search()}}};d.prototype._applyControlWrapperVariants=function(t,e,a,i){if(t){return t.loaded.then(()=>{this._applyControlVariant(t.control,e,a,false,i)})}return Promise.resolve()};d.prototype._applyVariants=function(t,e,a){var i,r=this._getAllPersonalizableControls();const n=[];for(i=0;i<r.length;i++){if(r[i]&&r[i].control&&r[i].loaded){n.push(this._applyControlWrapperVariants(r[i],t,e,a))}}return n};d.prototype._setStandardVariant=function(t){var a=t.control;if(a){if(a.fireBeforeVariantSave){a.fireBeforeVariantSave(e.STANDARD_VARIANT_NAME)}return this._assignStandardVariantAsync(t)}};d.prototype._retrieveContent=function(t,e){var a=t;if(this.isPageVariant()&&t){a=t[e];if(!a&&e===this.getPersistencyKey()&&this._aPersonalizableControls&&this._aPersonalizableControls.length===1){a=t}}return a};d.prototype._assignContent=function(t,e,a){if(this.isPageVariant()){t[a]=e}else{t=e}return t};d.prototype._updateStandardVariant=function(t,e){if(t.control){var a=e;if(this.isPageVariant()){var i=this._getControlPersKey(t);if(i){a=this._retrieveContent(e,i)}}return this._assignStandardVariantForControl(t,a)}return e};d.prototype._assignStandardVariantAsync=function(t){var e=null;if(t.control){if(t.control.fetchVariant){e=t.control.fetchVariant()}if(e instanceof Promise){this.setEnabled(false)}return h.resolve(e).then(e=>this._assignStandardVariantForControl(t,e)).catch(t=>{s.error("'_assignStandardVariant' throws an exception: "+t.message)}).unwrap()}return null};d.prototype._assignStandardVariantForControl=function(t,e){var a=e;if(t){if(this.isPageVariant()){var i=this._getControlPersKey(t.control);if(i){if(!this._oStandardVariant){this._oStandardVariant={}}this._oStandardVariant=this._assignContent(this._oStandardVariant,a,i)}}else{this._oStandardVariant=a}}return this._oStandardVariant};d.prototype.getStandardVariant=function(t){var e,a,i=null;if(this._oStandardVariant){if(!t){i=this._oStandardVariant}else{if(this.isPageVariant()){a=this._getControlWrapper(t);if(a){e=this._getControlPersKey(t);if(e){i=this._retrieveContent(this._oStandardVariant,e)}}}else{if(t===this._oPersoControl){i=this._oStandardVariant}}}}return i};d.prototype._applyVariant=function(t,e,a,i,r){if(t&&t.applyVariant){if(r!=undefined){e.executeOnSelection=r}t.applyVariant(e,a,i)}};d.prototype._applyVariantByPersistencyKey=function(e,a,i){var r=null;this.getAggregation("personalizableControls",[]).some(a=>{var i=t.getElementById(a.getControl());if(i){var n=a.getKeyName();if(i.getProperty(n)===e){r=i}return r!=null}});if(r){var n=this._retrieveContent(a,e);this._applyVariant(r,n,i)}};d.prototype._applyControlVariant=function(t,e,a,i,r){var n,o;o=this._getControlPersKey(t);if(o){n=this._retrieveContent(e,o);if(n){this._applyVariant(t,n,a,i,r)}}};d.prototype.registerSelectionVariantHandler=function(t,e){this._oSelectionVariantHandler[e]=t};d.prototype.unregisterSelectionVariantHandler=function(t){var e=null;if(!this._oSelectionVariantHandler){return}if(typeof t==="string"){e=t}else{Object.keys(this._oSelectionVariantHandler).some(a=>{if(this._oSelectionVariantHandler[a].handler===t){e=a;return true}return false})}if(e){delete this._oSelectionVariantHandler[e]}};d.prototype._setErrorValueState=function(t,e){this.setInErrorState(true);if(e){s.error(e)}};d.prototype.exit=function(){o.prototype.exit.apply(this,arguments);this._aPersonalizableControls=null;this._oMetadataPromise=null;this._fResolveMetadataPromise=null;this._oControlPromise=null;this._oPersoControl=null;this._oAppStdContent=null;this._sAppStandardVariantKey=null;this._oSelectionVariantHandler=null;if(this._oAdapter){this._oAdapter.destroy();this._oAdapter=null}};return d});
//# sourceMappingURL=SmartVariantManagement.js.map