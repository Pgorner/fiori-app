/*!
 * SAPUI5
 * (c) Copyright 2009-2024 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/mdc/LinkDelegate","sap/ui/mdc/enums/LinkType","sap/base/Log","./Util","sap/base/strings/whitespaceReplacer","sap/ui/core/Component","sap/base/util/isPlainObject","./ContactDetailsController","./Factory","sap/m/VBox","sap/ui/mdc/library","sap/base/util/merge","sap/ui/mdc/link/LinkItem","sap/m/Title","sap/m/Link","sap/m/library","sap/ui/core/CustomData","sap/m/Text","sap/ui/comp/personalization/Util","sap/ui/core/library","sap/ui/mdc/link/Panel","./SemanticObjectController","./LinkData","sap/base/util/isEmptyObject"],(t,e,n,i,a,o,r,s,c,l,g,u,m,d,f,p,b,v,S,h,k,y,C,L)=>{"use strict";const _=Object.assign({},t);_.fetchLinkType=async t=>{const n=_._getSmartLink(t);const i=await _._isSmartLinkEnabled(n);const a={initialType:{type:i?e.Popover:e.Text,directLink:undefined},runtimeType:_._getRuntimeLinkType(t)};return Promise.resolve(a)};_.fetchAdditionalContent=async t=>{const e=_._getSmartLink(t);const i=sap.ui.getCore().byId(e.sId);if(!i){n.error("sap.ui.comp.navpopover.SmartLinkDelegate: No control provided, popover cannot be attached.")}const a=await _._retrieveAdditionalContent(t);return a};const O=t=>t.getHref?.()??t.href;const A=t=>t.getText?.()??t.text;const j=t=>{if(t.getInternalHref!==undefined){return t.getInternalHref()}return t.data?.("internalHref")??t.internalHref};_.beforeNavigationCallback=function(t,e){const n=_._getSmartLink(t);const i=e.getSource();const a=n?.getSemanticObjectController();const o=n?.getBeforeNavigationCallback()||a?.getBeforeNavigationCallback();if(!o){return Promise.resolve(true)}let r=n?.getSemanticObject();const s=n.getAdditionalSemanticObjects();if(s?.length>0){const t=s.find(t=>O(i).includes(t));if(t&&t.trim().length>0){r=t}}const c=n?._getSemanticAttributes();const l=j(i);const g={text:A(i),href:O(i),originalId:n?.getParent()?.isA("sap.m.ObjectIdentifier")?n.getParent().getId():n?.getId(),semanticObject:r,semanticAttributes:c?c[r]:c};return o(u({},g)).then(t=>{if(t){n?.fireInnerNavigate({...g,internalHref:l});a?.fireNavigate({...g,internalHref:l})}return t})};_.getPanelId=function(t){const e=_._getSmartLink(t);if(!e){n.error("SmartLinkDelegate: Stable ID could not be determined because the control is undefined");return undefined}const a=_._getComponent(e);if(!a){n.error("SmartLinkDelegate: Stable ID could not be determined because the app component is not defined for control '"+e.getId()+"'");return undefined}const o=e.getSemanticObject();if(!o){n.error("SmartLinkDelegate: Stable ID could not be determined because no default semantic object is defined");return undefined}const r=[o].concat(e.getAdditionalSemanticObjects());i.sortArrayAlphabetical(r);const s=r.join("--");return a.createId("sapuicompnavpopoverNavigationPopover---"+s)};_.fetchPopoverTitle=function(t,e){const n=_._getSmartLink(t);const i=n.getMainNavigationId();const a=_._getLabelledByControl(e);return Promise.resolve({sTitle:i,oLabelledByControl:a})};_._getLabelledByControl=function(t){return t._getAdditionalContentArea().getItems()[0].getItems()[0].getItems()[0].getContent()};_.getSemanticObjectValue=function(t){const e=t.getSemanticObject();const n=t._getSemanticAttributes();if(n&&e&&n[e]){return n[e][e]}return undefined};_.onLinkPressed=async function(t,e){const n=e.getSource();const i=_._getSmartLink(t);const a=i.getSemanticObjectController();const o=e.getParameters().ctrlKey||e.getParameters().metaKey;const r=!!(i.getBeforeNavigationCallback()||a?.getBeforeNavigationCallback());const s=n?.getTarget()==="_blank"||o;if(s){return}e.preventDefault();const c=n?.getCustomData()&&n.getCustomData()[0]?.getValue();const l=c?n.getCustomData()[0].getValue():n.getHref();if(r){const n=await t._beforeNavigationCallback(e);if(n){k.navigate(l)}}else{k.navigate(l)}};_.fetchNavigationTargets=async(t,e)=>{const a=_._getSmartLink(t);const o=a.getSemanticObject();const r=o;const s=a.getAdditionalSemanticObjects();const c=sap.ui.getCore().byId(a.sId);if(!c){n.error("sap.ui.comp.navpopover.SmartLinkDelegate: No control provided, popover cannot be attached.")}const l=e?.getPath()??null;if(!l){n.warning("sap.ui.comp.navpopover.SmartLinkDelegate: Binding Context is null. Please be aware that without binding context no semantic attributes can be calculated. Without semantic attributes no URL parameters can be created.")}const g=a.getModel();const u=_._getComponent(c);await sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true});let m=c&&c._getTextOfDom&&c._getTextOfDom()||_.getSemanticObjectValue(a);const d=a._getSemanticAttributes();a._setSemanticAttributes(d);m=c&&c._getTextOfDom&&c._getTextOfDom()||_.getSemanticObjectValue(a);const f=a._getAppStateKey();return i.retrieveNavigationTargets(r,s,f,u,d,m,a.getFieldName(),g,l)};_._getNavgationInfo=function(t,e){const n=_._getSmartLink(t);const i=n?._getSemanticAttributes();const a=n?.getSemanticObject();const o={originalId:n?.getId(),semanticObject:a,semanticAttributes:i?i[a]:i,text:A(e),href:O(e),internalHref:j(e)};return o};_._retrieveAdditionalContent=async t=>{const e=_._getSmartLink(t);const n=e.getModel()||t.getModel();const a=new s;a.setModel(n);const o=e.getBindingContext()||t._getControlBindingContext();const r=o?.getPath()??null;const c=i.getContactAnnotationPath(e,e.getSemanticObjectController());const l=_.getSemanticObjectValue(e);const g=_._getMainNavigationContent(e);if(c==undefined){return[g]}await sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true});const u=await a.getBindingPath4ContactAnnotation(r,c,l);const m=a.getContactDetailsContainers(u);a.destroy();return[g,m]};_._getMainNavigationContent=t=>{const e=t._getInternalModel();const n=new f({href:"{$sapuicompSmartLink>/mainNavigationLink/href}",text:"{$sapuicompSmartLink>/mainNavigationLink/title}",target:"{$sapuicompSmartLink>/mainNavigationLink/target}",visible:{path:"$sapuicompSmartLink>/mainNavigationLink/title",formatter:t=>!!t},enabled:{path:"$sapuicompSmartLink>/mainNavigationLink/href",formatter:t=>!!t},press:e=>{_.onLinkPressed(t.getFieldInfo(),e)}});const i=new b({key:"internalHref",value:"{$sapuicompSmartLink>/mainNavigationLink/internalHref}"});n.addCustomData(i);const a=new d({level:h.TitleLevel.Auto,content:n});a.addStyleClass("sapFontHeader5Size");const o=new v({text:"{$sapuicompSmartLink>/mainNavigationLink/subtitle}",visible:{path:"$sapuicompSmartLink>/mainNavigationLink/subtitle",formatter:t=>!!t}});const r=new l({items:[a,o],visible:{path:"$sapuicompSmartLink>/mainNavigationLink/title",formatter:t=>!!t}});r.addStyleClass("mdcbaseinfoPanelTitleH1");r.addStyleClass("mdcbaseinfoPanelHeader");const s=new l({fitContainer:true,justifyContent:p.FlexJustifyContent.Start,items:[r]});s.setModel(e,"$sapuicompSmartLink");return s};_._transformNavigationTargets=t=>{const{availableActions:e,mainNavigation:n}=t;const i=[];if(e){e.forEach(t=>{if(t.getText()){t.setText(a(t.getText()))}if(t.getHref()){t.setInternalHref(t.getHref());i.push(_._convertToExternal(t.getHref()).then(e=>{t.setHref(e)}))}})}if(n){if(n.getDescription()){n.setDescription(a(n.getDescription()))}if(n.getText()){n.setText(a(n.getText()))}if(n.getHref()){n.setInternalHref(n.getHref());i.push(_._convertToExternal(n.getHref()).then(t=>{n.setHref(t)}))}}return Promise.all(i).then(()=>{t.availableActions=e;t.mainNavigation=n;if(t.mainNavigationId){t.mainNavigationId=a(t.mainNavigationId)}return t})};_._updateVisibilityOfAvailableActions=(t,e)=>{if(!_._getEnableAvailableActionsPersonalization(t,e)){return t.map(t=>{t.setInitiallyVisible(true);return t})}const n=i.getStorableAvailableActions(t);const a=n.some(t=>!!t.getInitiallyVisible());n.forEach(e=>{const n=e.getInitiallyVisible();if(t.length>10){e.setInitiallyVisible(false)}if(a){e.setInitiallyVisible(false)}if(n){e.setInitiallyVisible(true)}});if(t.every(t=>!t.getInitiallyVisible())){if(t[0]){t[0].setInitiallyVisible(true)}if(t[1]){t[1].setInitiallyVisible(true)}if(t[2]){t[2].setInitiallyVisible(true)}}return t};_._getEnableAvailableActionsPersonalization=(t,e)=>{const n=i.getStorableAvailableActions(t);if(n.length===0){return false}const a=_._getSmartLink(e);let o=a.getEnableAvailableActionsPersonalization();const r=a.getFieldName();const s=a.getSemanticObjectController()?.getEnableAvailableActionsPersonalization();if(s&&s[r]!==undefined){o=s[r]}return o};_._getComponent=t=>{if(!t){return null}let e=t.getParent();while(e){if(e instanceof o){if(e&&e.getAppComponent){e=e.getAppComponent()}return e}e=e.getParent()}return o.get(o.getOwnerIdFor(t))};_._calculateSemanticAttributes=(t,e,i)=>{const a=_._getSmartLink(e);const o=i?.getObject(i.getPath())??null;const s=a.getSemanticObject();const c=a.getAdditionalSemanticObjects();const l=a.getFieldName();const g=["",s].concat(c);const u={};g.forEach(i=>{u[i]={};const c=_._getMappingRules(i,t,o,e);for(const e in o){const g={transformations:[]};let m=null;if(o[e]===undefined||o[e]===null){if(g){g.transformations.push({value:o[e],description:"â„¹ Undefined and null values have been removed in SmartLinkDelegate."})}continue}if(r(o[e])){if(g){g.transformations.push({value:o[e],description:"â„¹ Plain objects has been removed in SmartLinkDelegate."})}continue}const d=c[e];if(g&&e!==d){m=t?{value:undefined,description:"â„¹ The attribute "+e+" has been renamed to "+d+" in SmartLinkDelegate.",reason:`ðŸ”´ A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object ${i}\n\t\t\t\t\t\t\t with source attribute ${e} and target attribute ${d}.\n\t\t\t\t\t\t\t You can modify the annotation if the mapping result is not what you expected.`}:{value:undefined,description:"â„¹ The attribute "+e+" has been renamed to "+d+" in SmartLinkDelegate.",reason:"ðŸ”´ The property mapFieldToSemanticObject is set to true. Attribute "+e+" is mapped to "+d+". (semantic object is "+s+", field name is "+a.getFieldName()+"). If this is not what you expected, you can set the property to false or define a com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation."}}let f=o[e];if(u[i][d]){if(o[l]){if(d===c[a.getFieldName()]){f=o[l]}else{n.error("The attribute "+e+" can not be renamed to the attribute "+d+" due to a clash situation. This can lead to wrong navigation later on.")}}}u[i][d]=f;if(g){g.transformations.push({value:o[e],description:"â„¹ The attribute "+e+" with the value "+o[e]+" is taken from the binding context in SmartLinkDelegate."});if(m){g.transformations.push(m)}}}});return u};_._getMappingRules=(t,e,n,i)=>{const a=_._getSmartLink(i);const o=!!a.getSemanticObjectController()?.getMapFieldToSemanticObject();const r=o?a.getSemanticObjectController().getMapFieldToSemanticObject():a.getMapFieldToSemanticObject();let s;const c={};if(e){for(s in e[t]){if(typeof e[t][s]==="string"){c[s]=e[t][s]}}}else if(r){if(a.getSemanticObjectController()){const t=a.getSemanticObjectController().getFieldSemanticObjectMap();for(s in t){c[s]=t[s]}}if(a.getFieldName()&&a.getSemanticObject()){c[a.getFieldName()]=a.getSemanticObject()}}for(s in n){if(!c.hasOwnProperty(s)){c[s]=s}}return c};_._fireBeforePopoverOpens=(t,e,n,i)=>{const a=_._getSmartLink(i);return new Promise(i=>{const o={semanticAttributes:t,appStateKey:undefined};if(!a.hasListeners("beforePopoverOpens")){i(o);return}const r=t=>{const e=Object.keys(t).filter(e=>!L(t[e]));return!!e.length};const s={originalId:n,semanticObject:e,semanticAttributes:!L(t[e])?t[e]:null,semanticAttributesOfSemanticObjects:r(t)?t:null,setSemanticAttributes:(t,n)=>{n=n||e;o.semanticAttributes=o.semanticAttributes||{};o.semanticAttributes[n]=t},setAppStateKey:t=>{o.appStateKey=t},open:()=>i(o)};const c=a._onBeforePopoverOpens.bind(a);c(s)})};_._fireNavigationTargetsObtained=(t,e,i,a,o,r,s)=>new Promise(c=>{const g=_._getSmartLink(s);const u={mainNavigationId:t,extraContent:o.length?new l({items:o}):undefined};const m={mainNavigation:r.mainNavigation,actions:r.availableActions,ownNavigation:r.ownNavigation,popoverForms:o,semanticObject:e,semanticAttributes:i?i[e]:i,originalId:a};const d=g.hasListeners("navigationTargetsObtained");const f=g._onNavigationTargetsObtained.bind(g);const p=g.getNavigationTargetsObtainedCallback();if(p){if(d){f({...m,show:function(){n.warning(`sap.ui.comp.navpopover.SmartLinkDelegate: "navigationTargetsObtained" event handling will be ignored as "navigationTargetsObtainedCallback" property is set.`)}})}const t={...m,...u};p(t).then(e=>{c(_._applyResults(t,e))});return}const b={...u,...r};if(!d){c(b);return}f({...m,show:function(t,e,n,i){if(arguments.length>0&&!(typeof t==="string"||e instanceof C||Array.isArray(n))&&i===undefined){i=n;n=e;e=t;t=undefined}c(_._applyResults(b,{mainNavigationId:t,mainNavigation:e,actions:n,extraContent:i}))}})});_._applyResults=(t,e)=>{e??=t;const{mainNavigationId:i,mainNavigation:a,actions:o,extraContent:r}=e;if(i!==undefined&&i!==null){t.mainNavigationId=i}if(a!==undefined){t.mainNavigation=a}if(o){o.forEach(function(t){if(t.getKey()===undefined){n.error("'key' attribute of 'availableAction' '"+t.getText()+"' is undefined. Links without 'key' can not be persisted.");n.warning("The 'visible' attribute of 'availableAction' '"+t.getText()+"' is set to 'true'");t.setVisible(true)}});t.availableActions=o}if(r){t.extraContent=r}return t};_._convertToExternal=async t=>{const e=await c.getServiceAsync("Navigation");if(!e){return t}const n=await e.getHref({target:{shellHash:t}},_._getComponent());return n};_._updateInnerControl=t=>{if(t.getAggregation("innerControl")){return}const e=t._getInnerControl();if(!e){return}const n=e.clone("display");t.setContentDisplay(n)};_._getRuntimeLinkType=async t=>{const n=_._getSmartLink(t);const i=await _._isSmartLinkEnabled(n);return{type:i?e.Popover:e.Text,directLink:undefined}};_._isSmartLinkEnabled=async t=>{const e=t.getSemanticObjectController();const n=i.getForceLinkRendering(t,e);const a=t.getProperty("ignoreLinkRendering");const o=i.getContactAnnotationPath(t,t.getSemanticObjectController());const r=e?.getIgnoredFields();const s=r!==undefined&&S.createArrayFromString(r).includes(t.getFieldName());if(s){return false}if(a){_._updateInnerControl(t);return false}if(n){return true}const c=[t.getSemanticObject(),...t.getAdditionalSemanticObjects()];const l=await y.getDistinctSemanticObjects();const g=y.hasDistinctSemanticObject(c,l);if(!g&&!o){return false}return true};_._getParent=t=>t.getParent()?t.getParent():sap.ui.getCore().byId(t.getAssociation("sourceControl"));_._getSmartLink=t=>{const e=t.getParent();return e};return _});
//# sourceMappingURL=SmartLinkDelegate.js.map