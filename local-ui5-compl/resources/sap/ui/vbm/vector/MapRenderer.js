sap.ui.define(["../lib/sapvbi","../VBIRenderer","./VectorUtils","./thirdparty/MaplibreStyles","./PayloadGenerator","./RectangularSelection","./LassoSelection","sap/ui/core/Lib","./thirdparty/maplibregl","./VBITransformer"],function(e,t,o,r,n,i,s,a){"use strict";VBI.MapRenderer={};var l="";let c=false;let d;let p;let u=false;let m=false;let v=[];var b=[];let g=[];let f=[];let y=false;let h=false;VBI.MapRenderer.name=undefined;VBI.MapRenderer.setAdapter=e=>{this._adapter=e;this._payloadGenerator=new n(this._adapter)};VBI.MapRenderer._processGeoSpot=(e,t)=>{};VBI.MapRenderer._processGeoRoutes=(e,t)=>{};VBI.MapRenderer.renderMap=()=>{let e=VBI.VBITransformer.getTransformedJSON();l=t.getId();var u=document.createElement("style");u.textContent=r.loadStyles();document.head.appendChild(u);const m=o.createMap(e,l);const v=m.getCanvasContainer();const A=new i(m);const _=new s(m);v.addEventListener("mousedown",e=>A.mouseDown(e,this.Rpressed),true);v.addEventListener("mousedown",e=>_.mouseDown(e,this.Apressed),true);m.touchZoomRotate.enable();this.map=m;class E{onAdd(e){this.map=e;this._container=document.createElement("div");this._container.id="__xmlview1--vbi-vbi-nav";this._container.className="vbi-nav my-custom-control";this._container.setAttribute("role","Navigation");this._container.setAttribute("tabindex","-1");this._container.style.opacity="0.5";a.load({name:"sap.ui.vbm.i18n"});var t=a.getResourceBundleFor("sap.ui.vbm.i18n");var o=t.getText("NAVCTL_TITLE_MOVE_LEFT");var r=t.getText("NAVCTL_TITLE_MOVE_RIGHT");var n=t.getText("NAVCTL_TITLE_MOVE_UP");var i=t.getText("NAVCTL_TITLE_MOVE_DOWN");var s=t.getText("NAVCTL_TITLE_MOVE");var l=t.getText("NAVCTL_TITLE_ZOOM");var u=document.createElement("div");u.id="__xmlview1--vbi-vbi-cursor-left";u.className="vbi-cursor-left";u.setAttribute("role",sap.ui.core.AccessibleRole.Button);u.setAttribute("aria-label",o);u.setAttribute("tabindex","2");u.setAttribute("title",o);var m=document.createElement("div");m.id="__xmlview1--vbi-vbi-cursor-right";m.className="vbi-cursor-right";m.setAttribute("role","Button");m.setAttribute("aria-label",r);m.setAttribute("tabindex","4");m.setAttribute("title",r);var v=document.createElement("div");v.id="__xmlview1--vbi-vbi-cursor-top";v.className="vbi-cursor-top";v.setAttribute("role","Button");v.setAttribute("aria-label",n);v.setAttribute("tabindex","1");v.setAttribute("title",n);var b=document.createElement("div");b.id="__xmlview1--vbi-vbi-cursor-down";b.className="vbi-cursor-down";b.setAttribute("role","Button");b.setAttribute("aria-label",i);b.setAttribute("tabindex","5");b.setAttribute("title",i);var g=document.createElement("div");g.id="__xmlview1--vbi-vbi-cursor-reset";g.className="vbi-cursor-reset";g.setAttribute("role","Button");g.setAttribute("aria-label",s);g.setAttribute("tabindex","3");g.setAttribute("title",s);this._container.addEventListener("mouseover",function(){this.style.opacity="1";this.style.boxShadow="0 0 25px rgba(255, 0, 0, 0.8)"});this._container.addEventListener("mouseout",function(){this.style.opacity="0.5";this.style.boxShadow="none"});var f=document.createElement("div");f.id="__xmlview1--vbi-vbi-scrollarea";f.className="vbi-scrollarea";f.setAttribute("role","Slider");f.setAttribute("tabindex","0");var y=document.createElement("div");y.id="__xmlview1--vbi-vbi-scrolllineupperending";y.className="vbi-scrolllineupperending";y.setAttribute("role","Img");y.setAttribute("tabindex","-1");y.style.cursor="pointer";y.style.position="absolute";y.top="20px";var h=document.createElement("div");h.id="__xmlview1--vbi-vbi-scrollline";h.className="vbi-scrollline";h.setAttribute("role","Img");h.setAttribute("tabindex","-1");var A=document.createElement("div");A.id="__xmlview1--vbi-vbi-scrolllinelowerending";A.className="vbi-scrolllinelowerending";A.setAttribute("role","Img");A.setAttribute("tabindex","-1");A.style.cursor="pointer";A.style.position="absolute";A.style.top="90px";var _=document.createElement("div");_.id="__xmlview1--vbi-vbi-scrollpoint";_.className="vbi-scrollpoint";_.setAttribute("role","Button");_.setAttribute("aria-label",l);_.setAttribute("tabindex","0");_.setAttribute("title",l);_.style.top="4.43911px";p=4.43911;f.appendChild(y);f.appendChild(h);f.appendChild(A);f.appendChild(_);this._container.appendChild(f);var E=document.createElement("div");E.id="__xmlview1--vbi-vbi-cursor";E.className="vbi-cursor";E.setAttribute("role","Presentation");E.setAttribute("tabindex","-1");this._container.appendChild(E);var L=document.createElement("div");L.id="__xmlview1--vbi-vbi-cursor-grip";L.className="vbi-cursor-grip";L.setAttribute("role","Img");L.setAttribute("tabindex","-1");var C=document.createElement("div");C.id="__xmlview1--vbi-vbi-cursor-middle";C.className="vbi-cursor-middle";C.setAttribute("role","Img");C.setAttribute("tabindex","0");C.appendChild(u);C.appendChild(m);C.appendChild(v);C.appendChild(b);C.appendChild(g);v.addEventListener("click",function(){e.panBy([0,-100])});b.addEventListener("click",function(){e.panBy([0,100])});u.addEventListener("click",function(){e.panBy([-100,0])});m.addEventListener("click",function(){e.panBy([100,0])});g.addEventListener("click",function(){e.setCenter([0,0]);e.setZoom(0)});function x(t){if(!c)return;const o=t.clientY;const r=o-d;let n=parseInt(_.style.top||"0px")+r;const i=0;const s=h.offsetHeight-_.offsetHeight;n=Math.max(i,Math.min(n,s));_.style.top=`${n}px`;const a=e.getMaxZoom()-e.getMinZoom();const l=(n-i)/(s-i);const p=e.getMinZoom()+l*a;e.setZoom(p);d=o}function w(){const t=e.getZoom();const o=0;const r=h.offsetHeight-_.offsetHeight;const n=r-o;const i=e.getMinZoom();const s=e.getMaxZoom();const a=(t-i)/(s-i)*n;_.style.top=`${o+a}px`}e.on("zoom",w);e.on("move",w);w();_.addEventListener("mousedown",e=>{c=true;d=e.clientY;document.addEventListener("mousemove",x);document.addEventListener("mouseup",T)});function T(){c=false;document.removeEventListener("mousemove",x);document.removeEventListener("mouseup",T)}document.addEventListener("mouseup",T);L.appendChild(C);this._container.appendChild(L);if(e&&e.getContainer()){e.getContainer().appendChild(this._container)}return this._container}onRemove(){this._container.parentNode.removeChild(this._container);this.map=undefined}}m.on("load",()=>{VBI.VBITransformer._createLegend(l);
// Custom attribution/copyright control
m.addControl(new maplibregl.AttributionControl({customAttribution:"<span>"+e[0].copyright+"</span>",compact:false}));m.addControl(new maplibregl.ScaleControl({maxWidth:80,unit:e[0].scaleType}));m.addSource("geojson-source",{type:"geojson",data:e[1]});m.addControl(new E,"top-left");const t=new maplibregl.Popup({closeButton:false,closeOnClick:false});b=[];const r=[];e[1].features.forEach(e=>{let i=e.geometry.coordinates;if(e.geometry.type==="Point"){const s=o.createSpotElement(e);const a=o.createIconElement(e.properties.Icon);s.appendChild(a);let c=new maplibregl.Marker({element:s,draggable:true,offset:[0,-25]}).setLngLat(e.geometry.coordinates).on("dragend",p).addTo(m);let d=c.getLngLat();c.customProperties={Key:e.properties.Key};f.push(c);function p(){const e=c.getLngLat();if(e!==0){c.setLngLat(d)}}function u(){return new Promise(e=>{m.once("click",function(t){e(t.lngLat)})})}s.addEventListener("mouseenter",()=>{if(y){h=true;if(!w.Apressed&&!w.Rpressed){s.style.cursor="copy"}}else{if(!w.Apressed&&!w.Rpressed){s.style.cursor="pointer"}if(w.Apressed||w.Rpressed){s.style.cursor="crosshair"}else{t.setLngLat(e.geometry.coordinates).setHTML(e.properties.ToolTip).addTo(m)}}});async function v(t,r){let i=null;if(r==="DETAIL_REQUEST"){i=await u()}else{i={lng:e.geometry.coordinates[0],lat:e.geometry.coordinates[1]}}const s=o.GetEventVPCoordsObj(t,l);e.properties.x=s.x;e.properties.y=s.y;n.objectClick("Spot",r,e,i)}s.addEventListener("click",e=>{v(e,"DETAIL_REQUEST")});s.addEventListener("contextmenu",e=>{v(e,"CONTEXT_MENU_REQUEST")});s.addEventListener("mouseleave",()=>{if(!w.Apressed&&!w.Rpressed){m.getCanvas().style.cursor=""}t.remove();h=false});let A=g.some(e=>e[0]===i[0]&&e[1]===i[1]);if(!A){g.push(i)}}else if(e.geometry.type=="LineString"){const _=e.geometry.coordinates;const E=_[0];const L=_[_.length-1];const C=o.calculateBearing(E,L);const x=o.normalizeAngle(90+C);const T=C>90?o.normalizeAngle(270+C):o.normalizeAngle(90-C);if(_.length>1){const B={type:"Feature",geometry:{type:"Point",coordinates:_[0]},properties:{Color:e.properties.Color,BorderColor:e.properties.BorderColor,arrowRotation:x,size:.07*parseFloat(e.properties.LineWidth),borderSize:.07*(parseFloat(e.properties.LineWidth)+1)}};const R={type:"Feature",geometry:{type:"Point",coordinates:_[_.length-1]},properties:{Color:e.properties.Color,BorderColor:e.properties.BorderColor,arrowRotation:T,size:.07*parseFloat(e.properties.LineWidth),borderSize:.07*(parseFloat(e.properties.LineWidth)+1)}};if(e.properties.StartStyle==="1"){r.push(B)}if(e.properties.EndStyle==="1"){r.push(R)}}}if(e.geometry.type=="LineString"){i.forEach(e=>{let t=b.some(t=>t[0]===e[0]&&t[1]===e[1]);if(!t){b.push(e)}})}else{let I=b.some(e=>e[0]===i[0]&&e[1]===i[1]);if(!I){b.push(i)}}});var i=b.reduce((e,t)=>e.extend(t),new maplibregl.LngLatBounds(b[0],b[0]));m.fitBounds(i,{padding:150});m.addLayer({id:"geojson-source-point",type:"circle",source:"geojson-source",paint:{"circle-opacity":0},filter:["==","$type","Point"]});m.addLayer({id:"geojson-source-route-border",type:"line",source:"geojson-source",layout:{"line-join":"round","line-cap":"butt"},paint:{"line-color":["get","BorderColor"],"line-width":["get","BorderWidth"]},filter:["==","$type","LineString"]});m.addLayer({id:"geojson-source-route",type:"line",source:"geojson-source",layout:{"line-join":"round","line-cap":"butt"},paint:{"line-color":["get","Color"],"line-width":["get","LineWidth"]},filter:["==","$type","LineString"]});const s={type:"FeatureCollection",features:r};m.addSource("line-end-points",{type:"geojson",data:s});o.getArrowHead(e=>{m.addImage("arrow-icon",e,{sdf:true});m.addLayer({id:"route-end-arrows-border",type:"symbol",source:"line-end-points",layout:{"icon-image":"arrow-icon","icon-size":["get","borderSize"],"icon-allow-overlap":true,"icon-rotation-alignment":"map","icon-rotate":["get","arrowRotation"]},paint:{"icon-color":["get","BorderColor"]}});m.addLayer({id:"route-end-arrows",type:"symbol",source:"line-end-points",layout:{"icon-image":"arrow-icon","icon-size":["get","size"],"icon-allow-overlap":true,"icon-rotation-alignment":"map","icon-rotate":["get","arrowRotation"]},paint:{"icon-color":["get","Color"]}})})});m.on("mouseenter","geojson-source-route",function(){if(!w.Apressed&&!w.Rpressed){m.getCanvas().style.cursor="pointer"}});m.on("mouseleave","geojson-source-route",function(){if(!w.Apressed&&!w.Rpressed){m.getCanvas().style.cursor=""}});m.on("click","geojson-source-route",function(e){L(e,"DETAIL_REQUEST")});function L(e,t){const r=e.lngLat;const i=o.GetEventVPCoordsObj(e.originalEvent,l);var s=e.features[0];s.properties.x=i.x;s.properties.y=i.y;n.objectClick("Link",t,s,r)}function C(e){if(h){console.log("Dropped on valid target")}else{console.log("Invalid drop")}m.getCanvas().style.cursor="";m.off("mousemove",x);m.off("touchmove",x);y=false;h=false}m.on("mousedown","geojson-source-route",e=>{if(e.originalEvent.button===0){e.preventDefault();y=true;m.on("mousemove",x);m.once("mouseup",C)}});function x(e){const t=m.queryRenderedFeatures(e.point,{layers:["geojson-source-route"]});if(!w.Apressed&&!w.Rpressed){if(t.length||h){m.getCanvas().style.cursor="copy"}else{m.getCanvas().style.cursor="not-allowed"}}}m.on("contextmenu",e=>{const t=m.queryRenderedFeatures(e.point,{layers:["geojson-source-route"]});if(t.length>0){e.features=t;L(e,"CONTEXT_MENU_REQUEST")}else{const t=e.lngLat.lng+";"+e.lngLat.lat+";0.0";const r=m.getZoom();const i=m.getCenter();const s=i.lng+";"+i.lat;const a=o.GetEventVPCoordsObj(e.originalEvent,l);const c=a.x;const d=a.y;n.onMapContextMenu(t,r,s,c,d)}});var w=this;m.on("idle",()=>{const e=m.getContainer();e.addEventListener("keydown",function(e){switch(e.keyCode){case 72:m.setCenter([0,0]);m.setZoom(2);m.getCanvas().style.cursor="";break;case 82:if(!w.Rpressed){w.Rpressed=true;w.Apressed=false;m.boxZoom.disable();m.getCanvas().style.cursor="crosshair"}else{w.Rpressed=false;m.boxZoom.enable();m.getCanvas().style.cursor=""}break;case 65:if(!w.Apressed){w.Apressed=true;w.Rpressed=false;m.boxZoom.disable();m.getCanvas().style.cursor="crosshair"}else{w.Apressed=false;m.boxZoom.enable();m.getCanvas().style.cursor=""}break;default:break}n.KeyboardHandler(e,VBI.MapRenderer.name)})})};VBI.MapRenderer.actionName=e=>{const t=Array.isArray(e?.SAPVB?.Actions?.Set?.Action)?e.SAPVB.Actions.Set.Action:[e?.SAPVB?.Actions?.Set?.Action].filter(Boolean);const o=t.find(e=>e.refEvent==="KeyPress");VBI.MapRenderer.name=o?.name??undefined};VBI.MapRenderer.createPopup=(e,t)=>{let o;switch(t[0]){case"Spots":const e=f.find(e=>e.customProperties.Key===t[1]);o=e?.getLngLat();break;default:}if(this.popup){this.popup.remove()}this.popup=new maplibregl.Popup({closeButton:false,offset:[19,15]}).setLngLat(o).setDOMContent(e).addTo(this.map)};VBI.MapRenderer.closePopup=()=>{this.popup?.remove()};VBI.MapRenderer.setRefMapLayerStack=(e,t)=>{this.map.setStyle(e);if(Object.keys(t).length!=0){this.map.transformRequest=(e,o)=>({url:e,headers:t})}};VBI.MapRenderer.createMenu=(e,t)=>{var o={};o.cnt=0;const r=t.Params?.Param?t.Params.Param:t.Param;for(var n=0;n<r.length;++n){if(r[n].name==="x"){o.m_x=parseInt(r[n]["#"],10)}if(r[n].name==="y"){o.m_y=parseInt(r[n]["#"],10)}if(r[n].name==="scene"){o.m_scene=r[n]["#"]}}e.findMenuByID(t.refID).open(true,0,"begin top","begin top",this.map._container,""+o.m_x+" "+o.m_y+"","fit")}});
//# sourceMappingURL=MapRenderer.js.map