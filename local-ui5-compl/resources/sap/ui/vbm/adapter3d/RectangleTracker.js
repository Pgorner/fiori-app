sap.ui.define(["sap/ui/base/Object","./thirdparty/three"],function(e,t){"use strict";var n=t.Vector2;var i=new t.Frustum;var r=new t.Vector3;var s=new t.Vector3;var a=new t.Vector3;var o=new t.Vector3;var h=new t.Vector3;var p=new t.Vector3;var c=new t.Vector3;var l=new t.Vector3;var u=new t.Vector3;var _=new t.Vector3;var d=new t.Vector3;var f=new t.Vector3;var v=new t.Vector3;var m=new t.Raycaster;var y=new n;var g={onBeforeRendering:function(e){this._unsubscribe()},onAfterRendering:function(e){this._subscribe()}};var w=e.extend("sap.ui.vbm.adapter3d.RectangleTracker",{constructor:function(n){e.call(this);this._adapter=n;this._context=n._context;this._viewport=n._viewport;this._root=this._viewport._root;this._scene=this._viewport._scene;this._camera=this._viewport._camera;this._cameraControls=this._viewport._cameraController;this._selected=new Set;this._renderer=this._renderer;this.init();var i=new t.CameraHelper(this._camera);i.geometry.setDrawRange(0,0);this._addToScene(i,this._scene,true,1);this._snapBox=new t.BoxHelper(undefined,65535);this._addToScene(this._snapBox,this._scene,false,1)}});w.prototype.init=function(){this._mouseDown=false;var e=document.createElement("div");e.classList.add("selectBox");this._element=e;this._element.style.pointerEvents="none";this._renderer=this._viewport._renderer;this._startPoint=new n;this.pointTopLeft=new n;this.pointBottomRight=new n;this.deep=50;this.instances=[]};w.prototype._getXY=function(e){var t=this._viewport.getDomRef().getBoundingClientRect();return{x:(e.pageX||e.originalEvent.pageX)-window.pageXOffset-t.left,y:(e.pageY||e.originalEvent.pageY)-window.pageYOffset-t.top}};w.prototype._updatePointer=function(e,t){var n=this._viewport.getDomRef().getBoundingClientRect();t.x=(e.cursor?e.cursor.x:e.pageX-window.pageXOffset-n.left)/n.width*2-1;t.y=-(e.cursor?e.cursor.y:e.pageY-window.pageYOffset-n.top)/n.height*2+1;return t};w.prototype._addListener=function(e,t,n){var i=n.bind(this);this[t+"Proxy"]=i;e.addEventListener(t,i)};w.prototype._removeListener=function(e,t){e.removeEventListener(t,this[t+"Proxy"]);delete this[t+"Proxy"]};w.prototype._subscribe=function(){var e=this._viewport.getDomRef();if(e){this._dom=e;this._addListener(e,"pointerup",this._onPointerCancel);this._addListener(e,"pointerdown",this._onPointerDown);this._addListener(e,"pointermove",this._onPointerMove);this._addListener(e,"pointerleave",this._onPointerCancel)}};w.prototype._unsubscribe=function(){var e=this._viewport.getDomRef();if(e){this._dom=null;this._removeListener(e,"pointerup");this._removeListener(e,"pointerdown");this._removeListener(e,"pointermove");this._removeListener(e,"pointerleave")}this._removeListener(this._cameraControls,"change")};w.prototype._addToScene=function(e,t,n,i,r){if(n!==undefined){e.visible=n}if(i!==undefined){e.layers.set(i)}if(r!==undefined){e.renderOrder=r}t.add(e);e.matrixAutoUpdate=false};w.prototype._onPointerDown=function(e){this._updateController(true);this.onSelectStart(e);var t=this;e.cursor=e.cursor||this._getXY(e);this._mouseDown=true;var n=this._viewport.getDomRef().getBoundingClientRect();f.x=e.cursor.x/n.width*2-1;f.y=-(e.cursor.y/n.height)*2+1;var i=new Map;var r;var s;if(!e.ctrlKey){this._selected.forEach(function(e){if(e.type!="InstancedMesh"||e.type!="PlaneGeometry"){var n={};if(e._sapInstance!=undefined){var a=e._sapInstance;e._sapInstance["VB:s"]="false";t._adapter._sceneBuilder.updateHotInstance(a);r=e._sapInstance.voGroup.datasource;s=t._adapter._parser.getAttributeAlias(r,e._sapInstance.voGroup.keyAttributeName);n[s]=e._sapInstance.id;n["VB:s"]="false"}else if(e.userData.name=="ColladaBounds"){if(e.userData._sapInstance["VB:s"]=="true"){var o=e.userData._sapInstance;var h=t._adapter._changeSelection(o,"toggle",false);t._adapter._sceneBuilder.updateSelection(h.selected,h.deselected);r=e.userData._sapInstance.voGroup.datasource;s=t._adapter._parser.getAttributeAlias(r,e.userData._sapInstance.voGroup.keyAttributeName);n[s]=e.userData.id;n["VB:s"]="false"}}var p=i.get(r);if(p!=undefined){var c=p.find(function(e){return e.name===r});if(c){var l=c.E.find(function(t){if(e._sapInstance!=undefined)return t[s]===e._sapInstance.id;else return t[s]===e.userData.id});if(!l&&JSON.stringify(n)!=="{}"){c.E.push(n)}}}else{i.set(r,[{name:r,E:[n]}])}}});if(i!=undefined){var a=t._constructPayload(i);if(a.Data.Merge.N.length>0){this._adapter.fireSubmit({data:JSON.stringify(a)})}}}this._selected.clear()};w.prototype._onPointerMove=function(e){e.preventDefault();if(!this._mouseDown){this._updatePointer(e,y);this._handleHover(y)}if(this._mouseDown){this._updateController(false);this.onSelectMove(e);var t=this;e.cursor=e.cursor||this._getXY(e);var n=this._viewport.getDomRef().getBoundingClientRect();v.x=e.cursor.x/n.width*2-1;v.y=-(e.cursor.y/n.height)*2+1;v.z=.5;var r=this.selecting(i);var s=new Map;var a;var o;var h={};if(r.length>0){for(var p=0;p<r.length;p++){this._selected.add(r[p])}}this._selected.forEach(function(e){h={};if(e.type!="InstancedMesh"||e.type!="PlaneGeometry"){if(e._sapInstance!=undefined){var n=e._sapInstance;e._sapInstance["VB:s"]="true";t._adapter._sceneBuilder.updateHotInstance(n);a=e._sapInstance.voGroup.datasource;o=t._adapter._parser.getAttributeAlias(a,e._sapInstance.voGroup.keyAttributeName);h[o]=e._sapInstance.id;h["VB:s"]="true"}else if(e.userData.name=="ColladaBounds"){var i=e.userData.id;var r=e.userData.count;var p=0;t._selected.forEach(function(e){if(e.userData.id==i)p++});if(p==r){var c=e.userData._sapInstance;var l=t._adapter._changeSelection(c,"select",false);t._adapter._sceneBuilder.updateSelection(l.selected,l.deselected);a=e.userData._sapInstance.voGroup.datasource;o=t._adapter._parser.getAttributeAlias(a,e.userData._sapInstance.voGroup.keyAttributeName);h[o]=e.userData.id;h["VB:s"]="true"}}var u=s.get(a);if(u!=undefined){var _=u.find(function(e){return e.name===a});if(_){var d=_.E.find(function(t){if(e._sapInstance!=undefined)return t[o]===e._sapInstance.id;else return t[o]===e.userData.id});if(!d&&JSON.stringify(h)!=="{}"){_.E.push(h)}}}else{s.set(a,[{name:a,E:[h]}])}}})}if(s!=undefined){var c=t._constructPayload(s);if(c.Data.Merge.N.length>0){this._adapter.fireSubmit({data:JSON.stringify(c)})}}};w.prototype._constructPayload=function(e){var t={version:"2.0","xmlns:VB":"VB",Data:{Merge:{N:[]}}};t.Data.Merge.N=[];e.forEach(function(e){e.forEach(function(e){t.Data.Merge.N.push(e)})});return t};w.prototype._onPointerCancel=function(e){e.preventDefault();this._mouseDown=false;this._dom.style.cursor=this._hovered?"pointer":"auto";this._updateController(true);this.onSelectOver()};w.prototype.onSelectStart=function(e){this._element.style.display="none";this._renderer.domElement.parentElement.appendChild(this._element);this._element.style.left=e.clientX+"px";this._element.style.top=e.clientY+"px";this._element.style.width="0px";this._element.style.height="0px";this._startPoint.x=e.clientX;this._startPoint.y=e.clientY};w.prototype.onSelectMove=function(e){this._element.style.display="block";this.pointBottomRight.x=Math.max(this._startPoint.x,e.clientX);this.pointBottomRight.y=Math.max(this._startPoint.y,e.clientY);this.pointTopLeft.x=Math.min(this._startPoint.x,e.clientX);this.pointTopLeft.y=Math.min(this._startPoint.y,e.clientY);this._element.style.left=this.pointTopLeft.x+"px";this._element.style.top=this.pointTopLeft.y+"px";this._element.style.width=this.pointBottomRight.x-this.pointTopLeft.x+"px";this._element.style.height=this.pointBottomRight.y-this.pointTopLeft.y+"px"};w.prototype.onSelectOver=function(e){var n=new t.Vector3((this.pointBottomRight.x+this.pointTopLeft.x)/2,(this.pointBottomRight.y+this.pointTopLeft.y)/2,0);this._centerOfBox=n;var i=new t.Vector3(this.pointBottomRight.x-this.pointTopLeft.x)*(this.pointBottomRight.y-this.pointTopLeft.y);this._size=i;var r=Math.max(i.x,i.y,i.z)*2;this._distance=r;if(this._element&&this._element.parentElement)this._element.parentElement.removeChild(this._element)};w.prototype._updateController=function(e){if(e){this._cameraControls.enableRotate=true;this._mouseDown=false}else{this._cameraControls.enableRotate=false;this._mouseDown=true}};w.prototype.selecting=function(e){this.startPoint=f||this.startPoint;this.endPoint=v||this.endPoint;this.collection=[];this.updateFrustum(this.startPoint,this.endPoint);this.searchChildInFrustum(e,this._scene);this._scene.remove(this._planeMesh);return this.collection};w.prototype.updateFrustum=function(e,t){e=e||this.startPoint;t=t||this.endPoint;if(e.x===t.x){t.x+=Number.EPSILON}if(e.y===t.y){t.y+=Number.EPSILON}if(this._camera.isPerspectiveCamera){s=e;s.x=Math.min(e.x,t.x);s.y=Math.max(e.y,t.y);t.x=Math.max(e.x,t.x);t.y=Math.min(e.y,t.y);a.setFromMatrixPosition(this._camera.matrixWorld);o.copy(s);h.set(t.x,s.y,0);p.copy(t);c.set(s.x,t.y,0);o.unproject(this._camera);h.unproject(this._camera);p.unproject(this._camera);c.unproject(this._camera);l.copy(o).sub(a);u.copy(h).sub(a);_.copy(p).sub(a);l.normalize();u.normalize();_.normalize();l.multiplyScalar(this.deep);u.multiplyScalar(this.deep);_.multiplyScalar(this.deep);d.multiplyScalar(this.deep);l.sub(a);u.sub(a);_.sub(a);var n=i.planes;n[0].setFromCoplanarPoints(a,o,h);n[1].setFromCoplanarPoints(a,h,p);n[2].setFromCoplanarPoints(p,c,a);n[3].setFromCoplanarPoints(c,o,a);n[4].setFromCoplanarPoints(h,p,c);n[5].setFromCoplanarPoints(_,u,l);n[5].normal.multiplyScalar(-1)}};w.prototype.searchChildInFrustum=function(e,n){var i=0;if(n._sapInstance!=undefined&&!n.geomtry){var s=new t.BoxHelper(n,0);var a=s.geometry.attributes.position.array;for(var o=0,h=a.length;o<h;o+=3){r.set(a[o],a[o+1],a[o+2]);if(e.containsPoint(r)){i++}}if(i===a.length/3){this.collection.push(n)}}else if(n.userData.name=="ColladaBounds"){var s=new t.BoxHelper(n,0);var a=s.geometry.attributes.position.array;for(var o=0,h=a.length;o<h;o+=3){r.set(a[o],a[o+1],a[o+2]);if(e.containsPoint(r)){i++}}if(i===a.length/3){this.collection.push(n)}}if(n.children.length>0){for(var p=0;p<n.children.length;p++){this.searchChildInFrustum(e,n.children[p])}}};w.prototype._handleHover=function(e){var t=[];var n=this._adapter._colladaBoundingBoxMesh;var i=this;m.layers.set(0);m.setFromCamera(e,this._camera);m.intersectObjects(this._adapter._colladaBoundingBoxMesh,false,t);if(t.length>0){for(var r=0;r<t.length;r++){this._hoverOff();var s=t[r].object;if(s.isMesh&&s.userData.name=="ColladaBounds"){var a=s.userData.id;var o=s.userData.count;if(o>1){n.forEach(function(e){if(e.userData.id==a)i._hoverOn(e)})}else this._hoverOn(s)}}}else{this._hoverOff()}};w.prototype._hoverOn=function(e){var n=new t.BoxHelper(undefined,65535);n.setFromObject(e);this._adapter._snapBox.push(n);this._addToScene(n,this._scene,true,1)};w.prototype._hoverOff=function(){var e=this;var t=this._adapter._snapBox;if(t!=undefined)t.forEach(function(t){e._scene.remove(t)});this._adapter._snapBox=[]};w.prototype._createEvent=function(){this._viewport.addEventDelegate(g,this);this._subscribe()};w.prototype._destroy=function(){if(this._viewport){this._viewport.removeEventDelegate(g);this._unsubscribe();this._adapter=null;this._context=null;this._viewport=null;this._root=null;this._scene=null;this._camera=null;this._cameraControls=null;this._raycaster=null;this._selected=null;this._renderer=null;this._element=null;this._snapBox=null;e.prototype.destroy.call(this)}};return w});
//# sourceMappingURL=RectangleTracker.js.map