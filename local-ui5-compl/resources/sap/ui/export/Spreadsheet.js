/*!
 * SAPUI5
 * (c) Copyright 2009-2024 SAP SE. All rights reserved.
 */
sap.ui.define(["./library","./ExportBase","./ExportDialog","./ExportUtils","./SpreadsheetExport","sap/base/Log","sap/base/i18n/Formatting","sap/ui/Device"],function(e,t,o,s,n,r,i,a){"use strict";const c="sap.ui.export.Spreadsheet";const u=e.Status;const l=t.extend(c,{constructor:function(e){t.call(this,e);this._mSettings.customizing={};this._mSettings.showProgress=true;this._mSettings.worker=true;["showProgress","worker"].forEach(function(t){if(typeof e[t]!=="undefined"){this._mSettings[t]=e[t]}}.bind(this));this.codeListsPromise=this.codeListsPromise instanceof Promise?this.codeListsPromise:Promise.resolve([null,null])}});function p(e,t,o){if(!(o[e]instanceof Object)){o[e]={}}if(!isNaN(t.digits)){o[e].scale=t.digits}if(!isNaN(t.UnitSpecificScale)){o[e].scale=t.UnitSpecificScale}if(isNaN(o[e].scale)){delete o[e]}}l.prototype.setDefaultExportSettings=async function(e){const t=await s.getResourceBundle();e.customizing.timezone=s.getTimezoneTranslations();let o=e.workbook.context;if(!(o instanceof Object)){o=e.workbook.context={}}if(!o.title){o.title=t.getText("XLSX_DEFAULT_TITLE")}if(!o.sheetName){o.sheetName=t.getText("XLSX_DEFAULT_SHEETNAME")}const n=e.customizing.currency={};const r=e.customizing.unit={};const a=i.getCustomCurrencies();if(a){for(const e in a){p(e,a[e],n)}}let c;const[u,l]=await this.codeListsPromise;for(c in u){p(c,u[c],n)}for(c in l){p(c,l[c],r)}};l.requestCodeLists=function(e){if(!e.isA(["sap.ui.model.odata.ODataMetaModel","sap.ui.model.odata.v4.ODataMetaModel"])){return Promise.resolve([null,null])}return Promise.all([e.requestCurrencyCodes(),e.requestUnitsOfMeasure()]).catch(function(e){r.warning(c+": Code lists cannot be processed due to the following error - "+e);return Promise.resolve([null,null])})};l.prototype.attachBeforeSave=function(e,t,o){return this.attachEvent("beforeSave",e,t,o)};l.prototype.detachBeforeSave=function(e,t){return this.detachEvent("beforeSave",e,t)};l.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null}return this};l.prototype.getMimeType=function(){return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};l.prototype.onprogress=function(e,t){if(isNaN(e)||isNaN(t)){return}const o=Math.round(e/t*100);r.debug("Spreadsheet export: "+o+"% loaded.")};l.prototype.createDataSourceFromBinding=function(e){let t=[];if(e.isA("sap.ui.model.ClientListBinding")){const o=[];e.getAllCurrentContexts().forEach(function(e){o.push(e.getObject())});t={data:o,type:"array"}}if(e.isA("sap.ui.model.ClientTreeBinding")){r.error("Unable to create dataSource configuration due to not supported Binding: "+e.getMetadata().getName())}if(typeof e.getDownloadUrl==="function"){const o=e.getModel();const n=o.isA("sap.ui.model.odata.v4.ODataModel");let r=e.getDownloadUrl("json");let i=o.sServiceUrl;r=s.interceptUrl(r);i=s.interceptUrl(i);const a=r.split(/[?&]/g).some(e=>e?.includes("$apply")&&e?.includes("com.sap.vocabularies.Hierarchy.v1.TopLevels"));t={type:"odata",dataUrl:r,serviceUrl:i,headers:n?o.getHttpHeaders(true):o.getHeaders(),count:a?undefined:s.getCountFromBinding(e),useBatch:n||o.bUseBatch};if(o.getMetaModel()&&typeof o.getMetaModel().requestCurrencyCodes==="function"&&typeof o.getMetaModel().requestUnitsOfMeasure==="function"){this.codeListsPromise=l.requestCodeLists(o.getMetaModel(),this._mSettings)}}return t};l.prototype.processDataSource=function(e){const t=typeof e;let o=null;if(!e){return null}if(t=="string"){return{count:this._mSettings.count,dataUrl:e,type:"odata",useBatch:false}}if(t!="object"){r.error("Spreadsheet#processDataSource: Unable to apply data source of type "+t);return null}if(e instanceof Array){o={data:e,type:"array"}}if(e.dataUrl){o=e}if(e.isA&&e.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){o=this.createDataSourceFromBinding(e)}return o};l.prototype.createBuildPromise=function(t){const r=this;return new Promise(function(i,c){let l;const p=1048576;const f=t.dataSource.count;const d=t.dataSource.downloadLimit;const g=a.system.desktop?2e6:1e5;const h=t.dataSource.type=="array"?t.dataSource.data.length:d||f;const m=t.workbook.columns.length;function y(e){if(e.progress){if(l){l.updateStatus(e.fetched,e.total)}r.onprogress(e.fetched,e.total)}if(e.finished&&r.process!==null){r.process=null;if(!e.spreadsheet){c();return}const o=r.fireEvent("beforeSave",{data:e.spreadsheet,exportDialog:l},true,false);if(o){if(l){window.setTimeout(l.finish,1e3)}s.saveAsFile(new Blob([e.spreadsheet],{type:r.getMimeType()}),t.fileName)}s.announceExportStatus(u.FINISHED,{assertive:true});i()}if(typeof e.error!="undefined"){const t=e.error.message||e.error;r.process=null;if(l){l.finish()}c(t);o.showErrorMessage(t)}}function S(e,t){return e<t}function w(){if(!t.showProgress){if(r.process){c("Cannot start export: the process is already running");return}r.process=n.execute(t,y);return}o.getProgressDialog().then(function(e){l=e;if(r.process){c("Cannot start export: the process is already running");return}l.oncancel=function(){return r.process&&r.process.cancel()};l.open();l.updateStatus(0,Math.min(d||p,f||p));r.process=n.execute(t,y)})}if(m<=0){c("No columns to export.")}else if(h*m>g||!h||h>=p||S(h,f)){const t={rows:h,columns:m,cellLimit:g,rowLimit:p,fileType:e.FileType.XLSX,count:f};o.showWarningDialog(t).then(w).catch(c)}else{w()}})};return l});
//# sourceMappingURL=Spreadsheet.js.map