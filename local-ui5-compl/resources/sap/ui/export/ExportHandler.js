/*!
 * SAPUI5
 * (c) Copyright 2009-2024 SAP SE. All rights reserved.
 */
sap.ui.define(["./library","./ExportUtils","./ExportDialog","./util/PDFCapabilities","sap/base/Log","sap/m/MessageToast","sap/ui/base/EventProvider","sap/ui/model/odata/v4/ODataModel","sap/ui/util/openWindow"],function(e,t,i,o,r,a,s,n,l){"use strict";const h=e.Destination;const c=e.FileType;const p=s.extend("sap.ui.export.ExportHandler",{constructor:function(e){const t=this;s.call(this);this._mCapabilities=e instanceof Object?e:{XLSX:{}};if(this._mCapabilities.PDF){const e=this._mCapabilities.PDF;if(!e?.isA?.("sap.ui.export.util.PDFCapabilities")){this._mCapabilities.PDF=new o(e)}if(!this._mCapabilities.PDF.isValid()){delete this._mCapabilities.PDF}}this._initialized=new Promise(e=>{this.isGoogleSheetSupported().then(e=>{if(e){t._mCapabilities[c.GSHEET]={};t._mDialogSettings={destination:h.REMOTE,fileType:c.GSHEET}}}).finally(e)})}});p.prototype.attachBeforeExport=function(e,t,i){return this.attachEvent("beforeExport",e,t,i)};p.prototype.detachBeforeExport=function(e,t){return this.detachEvent("beforeExport",e,t)};p.prototype.initialized=function(){return this._initialized};p.prototype.destroy=function(){s.prototype.destroy.apply(this,arguments);this._oExportDialog?.destroy();this._oFilePicker?.destroy();this._oFileShareBinding?.destroy();this._oModel?.destroy();this._mCapabilities=null;this._mDialogSettings=null;this._oDataSource=null;this._oExportDialog=null;this._oFilePicker=null;this._oFileShareBinding=null;this._oModel=null;this.bIsDestroyed=true};p.prototype.getFileShareContexts=async function(){const e=await this.getFileShareModel();if(!e){return Promise.resolve([])}if(!this._oFileShareBinding){this._oFileShareBinding=e.bindList("/FileShares")}try{return await this._oFileShareBinding.requestContexts(0)}catch(e){r.error(e?.message??e);return[]}};p.prototype.getRemoteFileLocation=async function(e){const[i,o,r]=await Promise.all([t.getResourceBundle(),this.getFileShareModel(),t.loadClass("sap/suite/ui/commons/CloudFilePicker")]);const a=this._oFilePicker=new r({sharedModel:o,suggestedFileName:e,enableDuplicateCheck:true,fileNameMandatory:true,confirmButtonText:i.getText("EXPORT_BUTTON"),title:i.getText("DESTINATION_DIALOG_TITLE")});return new Promise((e,t)=>{a.attachSelect(function(o){const r=o.getParameter("selectedFiles");const a=o.getParameter("selectedFolder");const s=o.getParameter("replaceExistingFile");const n={FileShare:a.getFileShareId(),FileShareItemKind:"document",FileShareItemName:o.getParameter("selectedFileName"),ParentFileShareItem:a.getFileShareItemId()};if(s&&Array.isArray(r)&&r.length>0){const e=r.shift();n.FileShareItem=e.getFileShareItemId()}if(!n.FileShare){t(i.getText("DESTINATION_SELECTION_INCOMPLETE"))}e(n)});a.open()})};p.prototype.getExportInstance=async function(e,o,r){const s=this;const[n,l]=await Promise.all([t.getResourceBundle(),t.getExportInstance(e,this._mCapabilities,r)]);let h=[];const p={name:n.getText("FILTER_HEADER"),items:[]};if(o?.includeFilterSettings){let i=e.workbook.context;if(!i){i=e.workbook.context={metainfo:[]}}h=t.getFilters(e.dataSource);i.metaSheetName=p.name;i.metainfo.push(p)}l.attachBeforeExport(function(e){const t=s.fireEvent("beforeExport",{exportSettings:e.getParameter("exportSettings"),userExportSettings:o||{},filterSettings:h},true,false);if(!t){e.preventDefault();return}h.filter(e=>e?.isA?.("sap.ui.export.util.Filter")).sort((e,t)=>{const i=e.getLabel().toLowerCase();const o=t.getLabel().toLowerCase();if(i>o){return 1}if(i<o){return-1}return 0}).forEach(e=>{p.items.push({key:e.getLabel(),value:e.getValue()})})});if(r&&typeof l.attachBeforeSave==="function"){l.attachBeforeSave(function(t){const o=t.getParameter("data");const s=t.getParameter("exportDialog");r.FileShareItemContentType=l.getMimeType();r.FileShareItemConvertToMimeType=l.getMimeType();if(e.fileType===c.GSHEET){r.FileShareItemConvertToMimeType="application/vnd.google-apps.spreadsheet"}const h=new Uint8Array(o);const p=new Array(h.length);for(let e=0;e<h.length;e++){p[e]=String.fromCharCode(h[e])}r.FileShareItemContent=btoa(p.join(""));s.updateStatus(n.getText("DESTINATION_DIALOG_STATUS"));t.preventDefault();this.uploadFile(r).then(()=>{a.show(n.getText("DESTINATION_TRANSFER_SUCCESS"))}).catch(()=>{i.showErrorMessage(n.getText("DESTINATION_TRANSFER_ERROR"))}).finally(()=>{s.finish()})},this)}return l};p.prototype.uploadFile=async function(e){let t;const i=await this.getFileShareModel();const o="FileShareItemContent";const r="FileShareItemContentType";if(e.FileShareItem){const a=i.getKeepAliveContext(`/FileShareItems(FileShare='${e.FileShare}',FileShareItem='${e.FileShareItem}')`);a.setProperty("FileShareItemContentLink","",null);a.setProperty(r,e[r]);await a.setProperty(o,e[o]);t=a.getProperty("FileShareItemContentLink")}else{const o=e.ParentFileShareItem?`/FileShareItems(FileShare='${e.FileShare}',FileShareItem='${e.ParentFileShareItem}')/_Children`:`/FileShares(FileShare='${e.FileShare}')/_Root/_Children`;const r=i.bindList(o);t=await this._createFile(r,e)}if(t){l(t)}};p.prototype._createFile=function(e,t){return new Promise((i,o)=>{function r(t){const{success:a,context:s}=t.getParameters();if(a){e.detachCreateCompleted(r);i(s.getProperty("FileShareItemContentLink"))}else{s.destroy();o()}}e.attachCreateCompleted(r);e.create(t,true)})};p.prototype.export=async function(e){if(this.bIsDestroyed){Promise.reject("ExportHandler must not be used after calling #destroy")}const t=await this.getExportInstance(e);try{await t.build()}finally{t.destroy()}};p.prototype.exportAs=async function(e,o){if(this.bIsDestroyed){throw new Error("ExportHandler must not be used after calling #destroy")}await this.initialized();const r=Object.assign({},e,this._mDialogSettings);const a=await this.getFileShareContexts();const s=await t.getExportSettingsViaDialog(r,this._mCapabilities,a.length>0,e=>{this._oExportDialog=e});this._mDialogSettings=s;Object.assign(r,s);t.validateFileSettings(r);const n={splitCells:s.splitCells,includeFilterSettings:s.includeFilterSettings};if(r.fileType===c.PDF||s.splitCells){r.workbook.columns=t.splitColumns(r.workbook.columns,o)}if(r.includeFilterSettings){const e=await t.parseTechnicalConfiguration();let i=r.workbook.context;if(!i){i=r.workbook.context={}}i.metainfo=Array.isArray(i.metainfo)?i.metainfo.push(e):[e]}let l;if(r.destination===h.REMOTE){l=await this.getRemoteFileLocation(r.fileName)}if(l&&!l.FileShareItem){l.FileShareItemName=t.validateFileName(l.FileShareItemName,r.fileType)}if(r.fileType===c.GSHEET){await this.validateFileShare(l)}const p=await this.getExportInstance(r,n,l);try{await p.build()}catch(e){i.showErrorMessage(e)}finally{p.destroy()}};p.prototype.validateFileShare=function(e){return Promise.all([t.getResourceBundle(),this.getFileShareContexts()]).then(t=>{const[i,o]=t;const r=o.find(t=>t.getProperty("FileShare")===e.FileShare);return this.isGoogleWorkspace(r)?e:Promise.reject(i.getText("DESTINATION_ERROR_NOT_GOOGLE"))})};p.prototype.getFileShareModel=async function(){if(this._oModel){return this._oModel}const e=await t.fetchDataSource();if(e){this._oModel=new n({serviceUrl:e.uri,autoExpandSelect:true})}return this._oModel};p.prototype.isGoogleSheetSupported=async function(){const e=await this.getFileShareContexts();return e.some(this.isGoogleWorkspace)};p.prototype.isGoogleWorkspace=function(e){const t=e.getProperty("FileShareVendorType");const i=e.getProperty("FileShareDescription");return t==="GOOGLE"||typeof i==="string"&&i.indexOf("Google")>-1};return p},true);
//# sourceMappingURL=ExportHandler.js.map