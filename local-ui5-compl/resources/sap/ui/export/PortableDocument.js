/*!
 * SAPUI5
 * (c) Copyright 2009-2024 SAP SE. All rights reserved.
 */
sap.ui.define(["./ExportDialog","./ExportBase","./ExportUtils","./library","./util/PDFCapabilities","sap/base/i18n/Localization","sap/base/Log","sap/m/BusyDialog","sap/ui/base/Object","sap/ui/model/odata/v4/ODataModel","sap/ui/util/openWindow"],function(e,t,i,o,r,a,s,n,l,c,p){"use strict";const u=o.FileType;const m=o.EdmType;const d=o.Status;const f=t.extend("sap.ui.export.PortableDocument",{constructor:function(e,i,o){t.call(this,e,i);if(!l.isA(this._mCapabilities,"sap.ui.export.util.PDFCapabilities")){this._mCapabilities=new r(this._mCapabilities)}if(o?.FileShare&&o?.ParentFileShareItem){this._mCloudFileInfo=o}["paperSize","orientation","font","fontSize","doEnableAccessibility","fitToPage","signature","signatureReason","pdfArchive","showPageNumber"].forEach(t=>{if(typeof e[t]!=="undefined"){this._mSettings[t]=e[t]}})}});f.prototype.processDataSource=function(e){let t=null;const i=typeof e;if(!e){return null}if(i!="object"){s.error("Spreadsheet#processDataSource: Unable to apply data source of type "+i);return null}if(e.dataUrl&&e.serviceUrl){t=e}if(e.isA&&e.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){t=this.createDataSourceFromBinding(e)}return t};f.prototype.createDataSourceFromBinding=function(e){let t=null;if(e.isA(["sap.ui.model.ClientListBinding","sap.ui.model.ClientTreeBinding"])){s.error("Unable to create dataSource configuration due to not supported Binding: "+e.getMetadata().getName())}if(typeof e.getDownloadUrl==="function"){const o=e.getModel(),r=i.interceptUrl(e.getDownloadUrl("pdf")),a=i.interceptUrl(o.sServiceUrl),s=o.isA("sap.ui.model.odata.v4.ODataModel");const n=new URL(r,document.baseURI);n.hash="";this._oModel=o;n.search=n.search.split("&").filter(e=>e.indexOf("$format")==-1).join("&");t={type:"odata",version:s?4:2,dataUrl:n.toString(),serviceUrl:this._resolveServiceUrl(a),headers:s?o.getHttpHeaders(true):o.getHeaders(),count:i.getCountFromBinding(e)}}return t};f.prototype._resolveServiceUrl=function(e){if(!e.endsWith("/")){e+="/"}const t=/^[\./]/.test(e);let i=this._mCapabilities.DocumentDescriptionReference;if(typeof i!=="string"||!i){return e.split("/").slice(0,-5).join("/")+"/default/iwbep/common/0001/"}i=i.endsWith("/")?i:i.split("/").slice(0,-1).join("/")+"/";let o=new URL(e,document.baseURI);o=new URL(i,o.href);return t?o.pathname:o.href};f.prototype._createDocumentDescription=function(e){const t=e.workbook;const i=e.dataSource.version;const o={Title:t.context.title,Format:{PaperSize:e.paperSize,Orientation:e.orientation},PDFStandard:{DoEnableAccessibility:e.doEnableAccessibility},TableColumns:[]};if(this._mCapabilities.ArchiveFormat){o.PDFStandard.UsePDFAConformance=e.pdfArchive}if(this._mCapabilities.CoverPage){const e=t.context.metainfo;o.CoverPage=[];if(e instanceof Array){e.forEach(e=>{if(i===2){e.items.forEach(t=>{const i={Title:e.name,Name:t.key,Value:t.value};o.CoverPage.push(i)})}else{const t={Title:e.name,Content:[]};e.items.forEach(e=>{t.Content.push({Name:e.key,Value:e.value})});o.CoverPage.push(t)}})}}if(this._mCapabilities.FitToPage){o.Format.FitToPage={IsEnabled:e.fitToPage,MinimumFontSize:4}}if(this._mCapabilities.FontSize){o.Format.FontSize=Number(e.fontSize)}if(this._mCapabilities.HeaderFooter&&e.showPageNumber){o.Footer={Center:{Type:"PAGENUM"}}}if(this._mCapabilities.Signature){o.Signature={DoSign:e.signature,Reason:e.signatureReason}}if(this._mCapabilities.TextDirectionLayout){o.Format.TextDirectionLayout=a.getRTL()?"RTL":"LTR"}if(this._mCapabilities.Treeview&&t.hierarchyLevel&&t.drillState){if(i===2){o.Hierarchy={DistanceFromRootElement:t.hierarchyLevel,DrillStateElement:t.drillState}}else{o.Format.TableFormat="TREE"}}if(this._mCapabilities.UploadToFileShare&&this._mCloudFileInfo){o.FileName=this._mCloudFileInfo.FileShareItemName;o.FileShare={Repository:this._mCloudFileInfo.FileShare,Folder:this._mCloudFileInfo.ParentFileShareItem}}t.columns.filter((e,t,i)=>{const o=Array.isArray(e.property)?e.property[0]:e.property;if(!o){return false}return i.findIndex(e=>{const t=Array.isArray(e.property)?e.property[0]:e.property;return o===t})===t}).forEach(e=>{const t={Name:Array.isArray(e.property)?e.property[0]:e.property,Header:e.label};if(this._mCapabilities.IANATimezoneFormat&&e.type===m.DateTime){t.Format={DisplayFormat:i==2?"IANATSSHOR":"IANA-Timestamp-Short"};if(e.timezoneProperty){t.Format.IANATimezoneProperty=e.timezoneProperty}else if(e.timezone){t.Format.IANATimezone=e.timezone}}o.TableColumns.push(t)});return o};f.prototype._getEntitySetName=function(e){let t;const i=e?.version||2;if(this._mCapabilities&&typeof this._mCapabilities.DocumentDescriptionCollection==="string"){t=this._mCapabilities.DocumentDescriptionCollection}return t||(i==4?"MyDocumentDescriptions":"SAP__MyDocumentDescriptions")};f.prototype._getModel=function(e){const t=e.version||2;return t===4?new c({serviceUrl:e.serviceUrl}):this._oModel};f.prototype._showWarning=function(t){let i=Promise.resolve();const o={rows:t.dataSource.count,rowLimit:this._mCapabilities.ResultSizeMaximum,fileType:u.PDF};if(isNaN(o.rows)||o.rows>o.rowLimit){i=e.showWarningDialog(o)}return i};f.showErrorMessage=async t=>{const o=await i.getResourceBundle();if(!t){return}if(typeof t.text==="function"){t.text().then(t=>{e.showErrorMessage(t)}).catch(()=>{e.showErrorMessage(o.getText("PDF_GENERIC_ERROR"))})}else if(t.message){e.showErrorMessage(t.message)}};f.prototype._applyResultSize=function(e){const t=parseInt(this._mCapabilities.ResultSizeMaximum);if(!isNaN(t)&&t>0){const i=new URL(e);i.search+="&$top="+t;e=i.toString()}return e};f.prototype.setDefaultExportSettings=function(e){let t=e?.workbook?.context;if(!(t instanceof Object)){t=e.workbook.context={}}if(typeof t.title==="string"&&t.title){return Promise.resolve()}return i.getResourceBundle().then(e=>{t.title=e.getText("XLSX_DEFAULT_TITLE")})};f.prototype.postDocumentDescription=function(e,t){const i=this._getModel(t);const o="/"+this._getEntitySetName(t);if(!i||!i.isA(["sap.ui.model.odata.v4.ODataModel","sap.ui.model.odata.v2.ODataModel"])){return Promise.reject("Unsupported Model")}return new Promise((t,r)=>{if(i.isA("sap.ui.model.odata.v4.ODataModel")){const a=i.bindList(o);a.attachCreateCompleted(e=>{if(e.getParameter("success")){t(e.getParameter("context").getObject()["Id"])}else{r()}});a.create(e)}else{const a=i.bUseBatch;i.setUseBatch(false);i.create(o,e,{success:e=>{i.setUseBatch(a);t(e["Id"])},error:e=>{i.setUseBatch(a);r(e)}})}})};f.prototype.createBuildPromise=async function(e){const t=await i.getResourceBundle();const o=this._createDocumentDescription(e);let r=new n("PDFExportBusyDialog",{title:t.getText("PROGRESS_TITLE"),text:t.getText("PDF_GENERATION_IN_PROGRESS"),showCancelButton:true,close:e=>{if(e.getParameter("cancelPressed")){this.cancel()}r.destroy();r=null}});r.open();try{await this._showWarning(e);this._request=new AbortController;const t=await this.postDocumentDescription(o,e.dataSource);const r=await this.sendRequest(e.dataSource.dataUrl,t);i.saveAsFile(r,e.fileName);i.announceExportStatus(d.FINISHED,{assertive:true})}catch(e){f.showErrorMessage(e)}r?.destroy()};f.prototype.sendRequest=async function(e,t){if(this._request?.signal.aborted){throw null}e=this._applyResultSize(e);try{const i=await fetch(e,{signal:this._request?.signal,headers:{Accept:this.getMimeType(),"SAP-Document-Description-Id":t}});if(i.redirected&&i.url!==e){p(i.url,"_blank");return undefined}if(i.ok){return i.blob()}else{throw i.text()}}catch(e){if(e.name==="AbortError"){throw null}else{throw e}}};f.prototype.getMimeType=function(){return"application/pdf"};f.prototype.cancel=function(){this._request?.abort()};f.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);this._request=null;this._oModel=null};return f});
//# sourceMappingURL=PortableDocument.js.map