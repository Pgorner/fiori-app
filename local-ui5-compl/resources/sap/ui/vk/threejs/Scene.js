/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../Scene","./NodeHierarchy","../RenderMode","../thirdparty/three","../thirdparty/BufferGeometryUtils","./ThreeExtensions","./ThreeUtils","sap/base/util/uid"],function(e,t,r,i,a,n,o,s,u){"use strict";var l=t.extend("sap.ui.vk.threejs.Scene",{metadata:{library:"sap.ui.vk"},PoiCoordinateSpaces:{WorldSpace:0,ReferenceNodeSpace:1},constructor:function(e){t.call(this);this._id=u();this._scene=e;this._sceneBuilder=null;this._defaultNodeHierarchy=null;this._currentViewStateManager=null;this._animationSequenceMap=new Map;this._initialView=null;this._materialMap=new Map;this._annotationMap=new Map}});l.prototype.init=function(){this._outlineColor=new a.Vector4(0,0,0,1);this._outlineMaterial=new a.ShaderMaterial({uniforms:{color:{value:this._outlineColor}},vertexShader:["attribute vec3 normal1;","attribute vec3 normal2;","#include <clipping_planes_pars_vertex>","uniform vec4 color;","varying vec4 vColor;","void main() {","\t#include <begin_vertex>","\t#include <project_vertex>","\t#include <clipping_planes_vertex>","\tvec3 eyeDirection = mvPosition.xyz;","\tvec3 n1 = normalMatrix * normal1;","\tvec3 n2 = normalMatrix * normal2;","\tvColor = color;","\tvColor.a *= step(dot(eyeDirection, n1) * dot(eyeDirection, n2), 0.0);","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","varying vec4 vColor;","void main() {","\t#include <clipping_planes_fragment>","\tif (vColor.a < 0.01) discard;","\tgl_FragColor = vColor;","}"].join("\n"),depthWrite:false,depthFunc:a.LessEqualDepth,polygonOffset:true,polygonOffsetFactor:-4,blending:a.NormalBlending,clipping:true});this._solidWhiteMaterial=new a.MeshBasicMaterial({color:16777215})};l.prototype.clearThreeScene=function(){if(!this._scene){return}var e=[];var t=[];s.getAllTHREENodes([this._scene],e,t);var r=this._scene.userData;if(r.geometryClusters){e=e.concat(r.geometryClusters);delete r.geometryClusters}if(r.currentClusters){r.currentClusters.clear()}r.instanceDataTexture?.dispose();r.instanceDataTexture=null;r.currentInstanceIndex=0;var i=new Map;var n=new Map;e.forEach(function(e){if(e instanceof a.Mesh){if(!i.has(e.geometry.uuid)){s.disposeGeometry(e);i.set(e.geometry.uuid,true)}if(e.material){if(!n.has(e.material.uuid)){s.disposeMaterial(e.material);n.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!n.has(e.userData.originalMaterial.uuid)){s.disposeMaterial(e.userData.originalMaterial);n.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});t.forEach(function(e){e.parent.remove(e)});i.clear();n.clear()};l.prototype.destroy=function(){this.clearThreeScene();if(this._defaultNodeHierarchy){this._defaultNodeHierarchy.destroy();this._defaultNodeHierarchy=null}s.disposeMaterial(this._solidWhiteMaterial);s.disposeMaterial(this._outlineMaterial);this._sceneBuilder=null;this._scene=null;this._currentViewStateManager=null;this._animationSequenceMap.clear();this._materialMap.clear();t.prototype.destroy.call(this)};l.prototype.setDoubleSided=function(e){this.setProperty("doubleSided",e,true);this._scene.traverse(function(t){if(t.material!==undefined){var r=t.userData;var i=a.FrontSide;var n;if(r.originalMaterial){n=r.originalMaterial.userData;if(n.originalMaterialSide===undefined){n.originalMaterialSide=r.originalMaterial.side}i=n.originalMaterialSide}else{n=t.material.userData;if(n.originalMaterialSide===undefined){n.originalMaterialSide=t.material.side}i=n.originalMaterialSide}t.material.side=e?a.DoubleSide:i}});return this};l.prototype.setViewStateManager=function(e){this._currentViewStateManager=e;return this};l.prototype.getViewStateManager=function(){return this._currentViewStateManager};l.prototype.getId=function(){return this._id};l.prototype.getDefaultNodeHierarchy=function(){if(!this._defaultNodeHierarchy){this._defaultNodeHierarchy=new r(this)}return this._defaultNodeHierarchy};l.prototype._computeBoundingBox=function(e,t,r,i){var n=new a.Box3;if(this._scene){var o=this._scene.userData;var s=o.geometryClusters;if(e&&s&&s.length>100&&!i){var u;for(var l=0,d=s.length;l<d;++l){u=s[l].geometry.boundingBox;if(u){n.union(u)}}}else{this._scene._expandBoundingBox(n,e,t,r)}}return n};l.prototype.getSceneRef=function(){return this._scene};l.prototype.setSceneBuilder=function(e){this._sceneBuilder=e};l.prototype.getSceneBuilder=function(){return this._sceneBuilder};l.prototype.nodeRefToPersistentId=function(e){return Array.isArray(e)?e.map(function(e){return e._vkPersistentId()}):e._vkPersistentId()};l.prototype.persistentIdToNodeRef=function(e){var t=this._sceneBuilder;if(Array.isArray(e)){return e.map(function(e){return t?t.getNode(e):null})}else{return t?t.getNode(e):null}};l.prototype.setNodePersistentId=function(e,t,r){return this._sceneBuilder?this._sceneBuilder.setNodePersistentId(e,t,r):false};l.prototype._addAnnotation=function(e,t){this._annotationMap.set(e,t)};l.prototype._hasAnnotation=function(e){return this._annotationMap.has(e)};l.prototype._getAnnotations=function(){return this._annotationMap};l.prototype._removeAnnotationsForNode=function(e){this._annotationMap.forEach(function(t){if(t.node===e){this._annotationMap.delete(t.annotation.id)}},this)};l.prototype.setAnnotationPersistentId=function(e,t,r){var i=this._annotationMap.get(e.id);if(i){this._annotationMap.delete(e.id);i.annotation.id=t;this._annotationMap.set(t,i);return true}return false};l.prototype.getPointCloudGroups=function(){this._pointCloudGroups??=new Map;return this._pointCloudGroups};l.prototype.enumerateMaterials=function(){if(!this._defaultNodeHierarchy){return[]}var e=this._defaultNodeHierarchy.createNodeProxy(this._scene);if(e){return e.enumerateMaterials(true)}else{return[]}};var d=0;function c(e,t){var r=e.x-t.x;if(r<-d){return true}if(r>d){return false}var i=e.y-t.y;if(i<-d){return true}if(i>d){return false}return e.z-t.z<-d}function f(e,t,r){if(t<r){var i=p(e,t,r);f(e,t,i-1);f(e,i+1,r)}return e}function p(e,t,r){var i=e[r],a=t;for(var n=t;n<r;n++){if(c(e[n],i)){h(e,n,a);a++}}h(e,r,a);return a}function h(e,t,r){if(t!=r){var i=e[t];e[t]=e[r];e[r]=i}}function v(e,t){var r=new a.BufferGeometry;Object.setPrototypeOf(r,v.prototype);r.type="OutlineGeometry";var i=e&&e.isBufferGeometry&&e.getAttribute("position");if(!i||!e.index){return}e.computeBoundingBox();var n=new a.Vector3;e.boundingBox.getSize(n);d=Math.max(n.x,n.y,n.z)*1e-4;var o=i.count;var s=e.index.array;var u=s.length;if(o===0||u<3){return}var l,p,h,y;var M=new Array(o);for(l=0;l<o;l++){M[l]=(new a.Vector3).fromArray(i.array,l*i.itemSize);M[l].index=l}f(M,0,M.length-1);var _=[],m=[];_.push(M[0]);m[M[0].index]=_.length-1;for(l=1;l<o;l++){if(c(_[_.length-1],M[l])){_.push(M[l])}m[M[l].index]=_.length-1}var g=[];for(h=0;h<u;h+=3){var x=m[s[h]];var b=m[s[h+1]];var S=m[s[h+2]];if(x!==b&&b!==S&&S!==x){g.push(x,b,S)}}s=g;M=_;u=s.length;var B={},w;var N=new a.Vector3,D=new a.Vector3,A=new a.Vector3;var C=new Array(u/3);for(h=0,y=0;h<u;h+=3,y++){D.copy(M[s[h+1]]).sub(M[s[h]]);A.copy(M[s[h+2]]).sub(M[s[h]]);C[y]=(new a.Vector3).crossVectors(D,A).normalize();for(l=0,p=2;l<3;p=l++){var I=s[h+p];var k=s[h+l];w=Math.min(I,k)+","+Math.max(I,k);if(B[w]===undefined){B[w]={index1:I,index2:k,face1:y,face2:undefined}}else{B[w].face2=y}}}var V=Math.cos(a.MathUtils.DEG2RAD*(t!==undefined?t:1));var O=[];var T=[];var G=[];for(w in B){var R=B[w];if(R.face2===undefined||C[R.face1].dot(C[R.face2])<=V&&N.copy(M[R.index2]).sub(M[R.index1]).cross(C[R.face1]).dot(C[R.face2])>0){var z=M[R.index1];O.push(z.x,z.y,z.z);z=M[R.index2];O.push(z.x,z.y,z.z);var P=C[R.face1];T.push(P.x,P.y,P.z);T.push(P.x,P.y,P.z);if(R.face2!==undefined){var F=C[R.face2];G.push(F.x,F.y,F.z);G.push(F.x,F.y,F.z)}else{G.push(0,0,0);G.push(0,0,0)}}}r.setAttribute("position",new a.Float32BufferAttribute(O,3));r.setAttribute("normal1",new a.Float32BufferAttribute(T,3));r.setAttribute("normal2",new a.Float32BufferAttribute(G,3));return r}v.prototype=Object.create(a.BufferGeometry.prototype);v.prototype.constructor=v;function y(e){return e===null||e.min.x>=e.max.x&&e.min.y>=e.max.y&&e.min.z>=e.max.z}function M(e){var t=e&&e.geometry;var r=t&&t.isBufferGeometry&&t.getAttribute("position");if(!r){return null}var i=e.userData.renderGroup;if(i){var n=t.getAttribute("position").array;var o=t.getIndex().array;var s=i.firstVertex;var u=i.start;var l=i.count;var d=new Uint16Array(l);for(var c=0;c<l;++c){d[c]=o[u+c]-s}t=new a.BufferGeometry;t.setAttribute("position",new a.BufferAttribute(n.subarray(s*3,i.lastVertex*3),3));t.setIndex(new a.BufferAttribute(d,1))}else{t=t.clone()}if(!t.index){var f=[];for(var p=0,h=r.count;p<h;p++){f.push(p)}t.setIndex(f)}return t}function _(e){var t=null;if(e.isMesh&&!y(e.geometry.boundingBox)&&!e.userData.skipIt){var r=M(e);if(r){t=r}}for(var i=0,a=e.children.length;i<a;i++){var o=e.children[i];if(o.isMesh&&!y(o.geometry.boundingBox)&&o.userData.skipIt){var s=M(o);if(s){o.updateMatrix();s.applyMatrix4(o.matrix);t=t?n.mergeGeometries([t,s]):s}}}return t}function m(e,t){var r=e.userData;if(r.defaultMaterial===undefined){r.defaultMaterial=r.originalMaterial||e.material}e.material=t;r.originalMaterial=null;e._vkUpdateMaterialColorAndOpacity()}function g(e){var t=e.userData;if(t.defaultMaterial){e.material=t.defaultMaterial;delete t.defaultMaterial;t.originalMaterial=null;e._vkUpdateMaterialColorAndOpacity()}}l.prototype._createOutlineGeometry=function(t){if(this._scene){this._scene._vkTraverseMeshNodes(function(r){if(r.isOutline){r.visible=true}else{if(!r.hasOutline){try{var n=_(r);if(n!==null){r.hasOutline=true;var o=new v(n);var s=o.getAttribute("position");if(s&&s.count>0){o.boundingBox=new a.Box3;var u=new a.LineSegments(o,this._outlineMaterial);u.isOutline=true;u.renderOrder=r.renderOrder+.5;u.matrixWorldNeedsUpdate=true;r.add(u)}}}catch(t){e.error("Unable to create outline geometry for node "+r.name,t)}}if(r.isMesh&&r.material&&!r.material.isLineBasicMaterial&&!r.material.isLineMaterial){switch(t){case i.LineIllustration:m(r,this._solidWhiteMaterial);break;case i.ShadedIllustration:var l=(r.userData.defaultMaterial||r.userData.originalMaterial||r.material).clone();if(l.emissive){l.color.multiplyScalar(.5);l.emissive.multiplyScalar(.5).addScalar(.5)}else{l.color.multiplyScalar(.5).addScalar(.5)}m(r,l);break;default:g(r);break}}}}.bind(this))}};l.prototype._hideOutlineGeometry=function(){if(this._scene){this._scene._vkTraverseMeshNodes(function(e){if(e.isOutline){e.visible=false}if(e.isMesh){g(e)}})}};l.prototype.getInitialView=function(){return this._initialView};l.prototype.setInitialView=function(e){this._initialView=e};l.prototype.getMaterial=function(e){return this._materialMap.get(e)};l.prototype.setMaterial=function(e,t){this._materialMap.set(e,t)};l.prototype.clearUnusedMaterials=function(){const e=new Set;this._scene?.traverse(t=>{if(t.material){e.add(t.material);if(t.userData.originalMaterial){e.add(t.userData.originalMaterial)}}});const t=[];this._materialMap.forEach(function(r,i){if(e.has(r.getMaterialRef())){t.push([i,r])}else{r.destroy()}});this._materialMap=new Map(t)};l.prototype._getNativeMaterial=function(e){var t=e?this._materialMap.get(e):null;return t?t.getMaterialRef():null};l.prototype._setNodeMaterial=function(e,t){var r=this._getNativeMaterial(t);e.children.forEach(function(e){if(e.material){if(r){if(e.userData.materialId!==t){this._sceneBuilder._setSubmeshMaterial(e,r,t)}}else{var i=e.userData.initialMaterialId;if(i&&e.userData.materialId!==i){var a=this._getNativeMaterial(i);if(a){this._sceneBuilder._setSubmeshMaterial(e,a,i)}}}}}.bind(this))};l.prototype.bindMarkerNodeTransformationToReferenceNode=function(e,t){if(this._sceneBuilder){this._sceneBuilder.bindMarkerNodeTransformationToReferenceNode(e,t,this.PoiCoordinateSpaces.ReferenceNodeSpace)}};l.prototype.unbindMarkerNodeTransformationFromReferenceNode=function(e,t){if(this._sceneBuilder){this._sceneBuilder.unbindMarkerNodeTransformationFromReferenceNode(e,t)}};l.prototype.getReferenceNodeFromMarkerNodeId=function(e){if(this._sceneBuilder){return this._sceneBuilder.getReferenceNodeFromMarkerNodeId(e)}return null};l.prototype.updateMarkerCoordinateSpace=function(e,t,r){if(!e||!t||!r){return}if(this._sceneBuilder){this._sceneBuilder.updateMarkerCoordinateSpace(e,t,r)}};return l});
//# sourceMappingURL=Scene.js.map