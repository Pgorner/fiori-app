/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_merge","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/storageResultDisassemble","sap/ui/fl/initial/_internal/StorageFeaturesMerger","sap/ui/fl/initial/_internal/StorageResultMerger","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/Layer"],function(e,t,n,r,a,o,l){"use strict";function s(e,n){const r=n.map(function(n){const r={...e,url:n.url,path:n.path};const a=t.getByReference(e.reference);if(!n.layers||n.layers[0]!=="ALL"&&n.layers.indexOf(l.CUSTOMER)===-1){delete r.version}else{if(a.initialAllContexts){r.allContexts=true}if(!r.version&&a.version){r.version=a.version}}const s=!!Object.keys(window.sessionStorage).filter(e=>e.startsWith("sap.ui.rta.restart.")).length;if(!s&&!a.saveChangeKeepSession){delete a.version;delete a.maxLayer;delete a.adaptationLayer;t.setByReference(a,e.reference)}if(r.version){delete r.cacheKey}return n.loadConnectorModule.loadFlexData(r).then(function(e){return e||o.getEmptyFlexDataResponse()}).catch(o.logAndResolveDefault.bind(undefined,o.getEmptyFlexDataResponse(),n,"loadFlexData"))});return Promise.all(r)}function i(e){var t=[];e.forEach(function(e){if(Array.isArray(e)){t=t.concat(e)}else{t.push(e)}});return t}function u(e){return e.map(function(e){return n(e)})}function c(e){return Promise.resolve(e).then(i).then(u).then(i).then(a.merge)}function d(e){return o.getStaticFileConnector().then(s.bind(this,e))}function f(e){var t=e.map(function(e){if(!e?.loadConnectorModule?.loadFeatures){return Promise.resolve(o.logAndResolveDefault({features:{},layers:e.layers},e,"loadFeatures"))}return e.loadConnectorModule.loadFeatures({url:e.url}).then(function(t){return{features:t,layers:e.layers}}).catch(o.logAndResolveDefault.bind(null,{features:{},layers:e.layers},e,"loadFeatures"))});return Promise.all(t)}async function h(t,n){const r=await Promise.all(n.map(function(e){if(!e?.loadConnectorModule?.loadVariantsAuthors){return Promise.resolve(o.logAndResolveDefault({},e,"loadVariantsAuthors"))}const n={reference:t,url:e.url};return e.loadConnectorModule.loadVariantsAuthors(n).then(e=>e||{}).catch(o.logAndResolveDefault.bind(undefined,{},e,"loadVariantsAuthors"))}));return e({},...r)}var p={};p.loadFeatures=function(){return o.getLoadConnectors().then(f).then(r.mergeResults)};p.completeFlexData=function(e){if(!e||!e.reference){return Promise.reject("No reference was provided")}return Promise.all([d(e),e.partialFlexData]).then(c)};p.loadFlexData=function(e){if(!e||!e.reference){return Promise.reject("No reference was provided")}return o.getLoadConnectors().then(s.bind(this,e)).then(c)};p.loadVariantsAuthors=function(e){if(!e){return Promise.reject("No reference was provided")}return o.getLoadConnectors().then(h.bind(this,e))};p.loadFlVariant=async function(e){const t=await o.getLoadConnectors();const n=[];for(const r of t){if(r?.loadConnectorModule?.loadFlVariant){const t={...e,url:r.url,layers:r.layers};try{n.push(await r.loadConnectorModule.loadFlVariant(t))}catch(e){n.push({})}}}const r=["variants","variantChanges","variantDependentControlChanges"];return n.reduce((e,t)=>{r.forEach(n=>{if(t[n]){e[n]=[...e[n]||[],...t[n]]}});return e},{})};return p});
//# sourceMappingURL=Storage.js.map