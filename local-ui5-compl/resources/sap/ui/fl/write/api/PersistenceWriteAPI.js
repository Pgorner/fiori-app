/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/flexObjects/AnnotationChange","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/flexState/changes/UIChangeManager","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,n,t,r,a,s,i,o,l,c,f,u,g,p,h,d,y,x){"use strict";var b={};function C(e){return e._getMap&&r.getChangeTypes().includes(e._getMap().changeType)||e.getChangeType&&r.getChangeTypes().includes(e.getChangeType())}function v(e){e.includeCtrlVariants=true;return b._getUIChanges(e).then(function(e){return e.length>0})}b.hasDirtyChanges=function(e){return g.hasDirtyFlexObjects(e)};b.hasHigherLayerChanges=function(e){e.upToLayer||=y.getCurrentLayer();return g.getFlexObjects(e).then(function(n){return n.filter(function(n){return y.isOverLayer(n.getLayer(),e.upToLayer)})}).then(function(n){if(n.length===0){return false}return g.filterHiddenFlexObjects(n,e.reference).length>0})};b.save=function(e){var n=o.getFlexReferenceForControl(e.selector);var t=l.getByReference(n);t.saveChangeKeepSession=true;l.setByReference(t,n);return g.saveFlexObjects(e).then(function(r){if(r?.length>0){return b.getResetAndPublishInfo(e).then(function(e){t=l.getByReference(n);delete t.saveChangeKeepSession;l.setByReference({...t,...e},n);return r})}t=l.getByReference(n);delete t.saveChangeKeepSession;l.setByReference(t,n);return r})};b.getResetAndPublishInfo=function(e){return Promise.all([v(e),h.isPublishAvailable()]).then(function(t){var r=t[0];var a=t[1];var s=e.layer!==d.USER&&e.layer!==d.PUBLIC;var i={isResetEnabled:r,isPublishEnabled:false,allContextsProvided:true};if(s){return p.getFlexInfo(e).then(function(e){i.allContextsProvided=e.allContextsProvided===undefined||e.allContextsProvided;i.isResetEnabled=e.isResetEnabled;i.isPublishEnabled=a&&e.isPublishEnabled;return i}).catch(function(e){n.error(`Sending request to flex/info route failed: ${e.message}`);return i})}return i})};b.getResetAndPublishInfoFromSession=function(e){var n=o.getFlexReferenceForControl(e)||"true";return JSON.parse(window.sessionStorage.getItem(`sap.ui.fl.info.${n}`))};b.reset=function(n){var t=x.getAppComponentForSelector(n.selector);return g.resetFlexObjects({...e(n,"selector"),appComponent:t})};b.add=function(e){const n=x.getAppComponentForSelector(e.selector);const t=o.getFlexReferenceForSelector(e.selector);function r(e){if(C(e)){return e.store()}if(e instanceof s){return g.addDirtyFlexObjects(t,[e])?.[0]}return u.addDirtyChanges(t,[e],n)?.[0]}if(e.change&&e.flexObjects){throw new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property.")}if(e.change){return r(e.change)}const a=e.flexObjects.some(function(e){return C(e)});if(a){return e.flexObjects.map(r)}const i=[];const l=[];e.flexObjects.forEach(e=>{if(e instanceof s){l.push(e)}else{i.push(e)}});const c=g.addDirtyFlexObjects(t,l);const f=u.addDirtyChanges(t,i,n);return e.flexObjects.map(e=>c.find(n=>n===e)||f.find(n=>n===e))};b.remove=function(e){return Promise.resolve().then(function(){if(e.change&&e.flexObjects){return Promise.reject(new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property."))}if(!e.selector){return Promise.reject(new Error(`An invalid selector was passed so change could not be removed with id: ${e.change.getId()}`))}var n=x.getAppComponentForSelector(e.selector);if(!n){return Promise.reject(new Error(`Invalid application component for selector, change could not be removed with id: ${e.change.getId()}`))}function r(e){var r=t.bySelector(e.getSelector(),n);if(r){a.destroyAppliedCustomData(r,e,t)}}const s=o.getFlexReferenceForSelector(e.selector);if(e.change){if(!C(e.change)){r(e.change)}g.deleteFlexObjects({reference:s,flexObjects:[e.change]});return undefined}e.flexObjects.forEach(function(e){if(!C(e)){r(e)}});g.deleteFlexObjects({reference:s,flexObjects:e.flexObjects});return undefined})};b.getChangesWarning=function(e){return this._getUIChanges(e).then(function(e){var n=e.some(function(e){return e.isChangeFromOtherSystem()});var t=c.getInstanceOrUndef();var r=t&&t.isProductiveSystemWithTransports();var a=e.length===0;var s={showWarning:false};if(n){s={showWarning:true,warningType:"mixedChangesWarning"}}if(r&&a){s={showWarning:true,warningType:"noChangesAndPSystemWarning"}}return s})};b._condense=function(e){return Promise.resolve().then(function(){if(!e.selector){throw Error("An invalid selector was passed")}var n=x.getAppComponentForSelector(e.selector);if(!n){throw Error("Invalid application component for selector")}if(!e.changes||e.changes&&!Array.isArray(e.changes)){throw Error("Invalid array of changes")}return f.condense(n,e.changes)})};b._getUIChanges=function(e){if(e.layer){e.currentLayer=e.layer}e.invalidateCache=false;return g.getFlexObjects(e)};b._getAnnotationChanges=function(e){const n=o.getFlexReferenceForControl(e.control);return i.getAnnotationChanges(n)};b.setAdaptationLayer=function(e,n){const t=o.getFlexReferenceForControl(n);const r=l.getByReference(t);r.adaptationLayer=e;l.setByReference(r,t)};return b});
//# sourceMappingURL=PersistenceWriteAPI.js.map