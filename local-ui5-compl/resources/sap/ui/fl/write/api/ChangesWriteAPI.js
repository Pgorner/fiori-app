/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/write/_internal/controlVariants/ControlVariantWriteUtils","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,t,n,a,r,c,o,i,l,p,s,g,f,h,u,C,d,m,y,S,D,v,F,T){"use strict";var A={};function x(e){var n;if(e.changeSpecificData.layer){n=e.changeSpecificData.layer;delete e.changeSpecificData.layer}const a={changeType:e.changeSpecificData.changeType,content:e.changeSpecificData.content};if(e.changeSpecificData.texts){a.texts=e.changeSpecificData.texts}return m.createDescriptorInlineChange(a).then(t=>(new C).createNew(e.changeSpecificData.reference,t,n,e.selector)).catch(e=>{t.error("the change could not be created.",e.message);throw e})}async function w(e){const t=await d.getAnnotationChangeHandler({changeType:e.changeSpecificData.changeType});const a=g.createAnnotationChange(e.changeSpecificData);t.completeChangeContent(a,e.changeSpecificData,{modifier:n,appComponent:e.appComponent});return a}function O(e){const a=g.createUIChange(e.changeSpecificData);return d.getChangeHandler(a.getChangeType(),e.controlType,e.selector,n,a.getLayer()).then(r=>{const c={...e.changeSpecificData};if(c.content){Object.keys(c.content).forEach(e=>{if(!c[e]){c[e]=c.content[e]}else{t.warning(`The property '${e}' is defined both in the change specific data and its content.`)}})}return r.completeChangeContent(a,c,{modifier:n,appComponent:e.appComponent,view:T.getViewForControl(e.selector)})}).then(()=>{a.setState(f.LifecycleState.NEW);return a})}A.create=function(e){if(e.changeSpecificData.changeType==="codeExt"){return g.createControllerExtensionChange(e.changeSpecificData)}const t=T.getAppComponentForSelector(e.selector.view||e.selector);const r=e.selector.appId||u.getFlexReferenceForControl(t);e.appComponent=t;e.changeSpecificData.reference=r;if(o.getChangeTypes().includes(e.changeSpecificData.changeType)){return x(e)}if(e.annotationChange){return w(e)}const c={layer:e.changeSpecificData.layer,control:t,reference:r};if(D.hasAdaptationsModel(c)){e.changeSpecificData.adaptationId=D.getDisplayedAdaptationId(c)}if(e.selector instanceof a){return Promise.resolve(g.createUIChange(e.changeSpecificData))}if(e.selector.name&&e.selector.view){e.changeSpecificData.selector={name:e.selector.name,viewSelector:n.getSelector(e.selector.view.getId(),t)};return O(e)}const i=e.selector.id||e.selector.getId();e.changeSpecificData.selector||={};Object.assign(e.changeSpecificData.selector,n.getSelector(i,t));e.controlType=e.selector.controlType||T.getControlType(e.selector);return O(e)};A.createVariant=function(e){const t=T.getAppComponentForSelector(e.selector);const n=u.getFlexReferenceForControl(t);const a={variantManagementReference:e.variantManagementReference,variantReference:e.variantReference||e.variantManagementReference,variantName:e.title,layer:e.layer||F.CUSTOMER,user:e.author||s.DEFAULT_AUTHOR,reference:n,generator:e.generator||"ChangesWriteAPI.createVariant"};return g.createFlVariant(a)};A.apply=function(t){if(!(t.element instanceof r)){return Promise.reject("Please provide an Element")}t.appComponent=T.getAppComponentForSelector(t.element);t.modifier||=n;return i.applyChangeOnControl(t.change,t.element,e(t,["element","change"])).then(function(e){var a=h.getOpenDependentChangesForControl(n.getControlIdBySelector(t.change.getSelector(),t.appComponent),t.appComponent);if(a.length>0){return A.revert({change:t.change,element:t.element}).then(function(){var e=c.getResourceBundleFor("sap.ui.fl");var n=a.map(function(e){return e.getId()}).join(", ");throw Error(e.getText("MSG_DEPENDENT_CHANGE_ERROR",[t.change.getId(),n]))})}return e})};A.revert=function(e){var t=T.getAppComponentForSelector(e.element||{});var a=[];var r={modifier:n,appComponent:t};if(!Array.isArray(e.change)){return l.revertChangeOnControl(e.change,e.element,r)}var c=e.change.slice(0).reverse();return c.reduce(function(t,n){return t.then(function(){return l.revertChangeOnControl(n,e.element,r).then(function(e){a.unshift(e)})})},Promise.resolve()).then(function(){return a})};A.getChangeHandler=function(e){var t=e.controlType||e.modifier?.getControlType(e.element);return p.getChangeHandler({changeType:e.changeType,control:e.element,controlType:t,modifier:e.modifier,layer:e.layer,appDescriptorChange:e.appDescriptorChange,annotationChange:e.annotationChange})};A.deleteVariantsAndRelatedObjects=function(e){if(!e.variantManagementControl?.isA("sap.ui.fl.variants.VariantManagement")){throw new Error("Please provide a valid Variant Management control")}const t=e.variantManagementControl;const a=T.getAppComponentForControl(t);const r=n.getSelector(t,a).id;const c=u.getFlexReferenceForControl(a);const o=v.getDraftFilenames({control:t,layer:e.layer});const i=h.getDirtyFlexObjects(c).map(e=>e.getId());const l=e.variants.filter(e=>o.includes(e)||i.includes(e));return l.map(e=>y.deleteVariant(c,r,e)).flat()};A.restoreDeletedFlexObjects=function(e){S.restoreDeletedFlexObjects(e)};return A});
//# sourceMappingURL=ChangesWriteAPI.js.map