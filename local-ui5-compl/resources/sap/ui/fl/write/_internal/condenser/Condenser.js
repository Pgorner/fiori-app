/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/isPlainObject","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/AppDescriptorChange","sap/ui/fl/apply/_internal/flexObjects/FlexObject","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexObjects/UIChange","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/classifications/Update","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,t,n,a,s,o,r,i,c,l,f,d,u,p,g,C,h,E,y,_,S){"use strict";const I={};const O="unclassified";const T={lastOneWins:g,reverse:C,update:h};const D=["affectedControl","sourceContainer","targetContainer","updateControl"];function N(e,t){const n=e[p.Move];return t.classification===p.Create&&n&&n[n.length-1].targetContainer===t.targetContainer}function m(e,t){return t.classification===p.Move&&e[p.Destroy]}function A(e,t){return t.classification===p.Create&&e[p.Destroy]}async function x(e,t,n,a){if(!m(e,n)&&!A(e,n)){const t=n.classification;if(!e[t]){n.change=a;a.condenserState="select";e[t]=[n]}else{a.condenserState="delete"}e[t][0].updateChange=a}else{a.condenserState="delete"}if(N(e,n)||A(e,n)){if(e[p.Move]){e[p.Move].forEach(e=>{e.change.condenserState="delete"});delete e[p.Move]}if(e[p.Destroy]){e[p.Destroy].forEach(e=>{e.change.condenserState="delete"});delete e[p.Destroy]}}await E.addChange(t,n)}function w(e,t,n){e[t.classification]||={};const a=e[t.classification];T[t.classification].addToChangesMap(a,t,n)}async function b(e,t,n,a,s){e[a.type]||={};const o=e[a.type];if(a.type===y.NOT_INDEX_RELEVANT){w(o,a,s)}else{n.push(s);o[a.targetAggregation]||={};await x(o[a.targetAggregation],t,a,s)}}function v(e,t,n){e[t]||=[];e[t].push(n);n.condenserState="select"}async function L(e,t){let n;let a=false;let s={};try{if(t instanceof u){const i=o.getControlIdBySelector(t.getSelector(),e);const l=r.getElementById(i);if(l){s={modifier:o,appComponent:e,view:_.getViewForControl(l)};const r=c.getControlIfTemplateAffected(t,l,s);a=r.bTemplateAffected;n=await c.getChangeHandler({flexObject:t,control:r.control,controlType:r.controlType,modifier:s.modifier})}}else{n=await c.getChangeHandler({flexObject:t})}if(typeof n.getCondenserInfo==="function"){const e=await n.getCondenserInfo(t,s);if(e&&a){R(e,t)}return e}}catch(e){return undefined}return undefined}function R(e,t){const n=t.getOriginalSelector();const a=t.getSelector();D.forEach(t=>{if(e[t]&&e[t]===a){e[t]=n}})}function U(e,t,n,s){const o=n.getIdForCondensing(t,s);e[o]||={};if(t&&t.updateControl){const n=t.updateControl;const s=[y.NOT_INDEX_RELEVANT,p.Update,t.uniqueKey];const r=a.get(s,e[n]);if(r){a.set(s,r,e[o]);delete e[n][y.NOT_INDEX_RELEVANT][p.Update][t.uniqueKey]}}return e[o]}async function M(e,t,n,a,s){for(const o of s){await j(e,t,n,a,o)}}async function j(e,t,n,a,s){const o=await L(e,s);X(o,e);const r=U(t,o,s,e);if(o!==undefined){V(o);await b(r,n,a,o,s);if(o.update){q(r,o,s)}}else{v(r,O,s);t[O]=true}}function V(e){if(T[e.classification]){e.type=y.NOT_INDEX_RELEVANT}else{e.type=y.INDEX_RELEVANT}}function X(e,t){D.forEach(n=>{if(e&&e[n]){e[n]=o.getControlIdBySelector(e[n],t)}})}function q(e,t,n){const s=[y.NOT_INDEX_RELEVANT,p.Update,t.uniqueKey];const o=a.get(s,e);if(o){o.change.condenserState="delete";if(n.condenserState==="delete"){return}if(n.isPersisted()){n.condenserState="update"}t.update(n,o.updateContent);n.setState(d.LifecycleState.UPDATED);delete e[y.NOT_INDEX_RELEVANT][p.Update][t.uniqueKey]}}function F(e,a){t(e,(t,s)=>{if(T[t]&&T[t].getChangesFromMap){T[t].getChangesFromMap(e,t).forEach(e=>{a.push(e)})}else if(n(s)){return F(s,a)}else if(Array.isArray(s)){s.forEach(e=>{if(e instanceof f){a.push(e)}else{a.push(e.change)}})}});return a}function P(e){return F(e,[])}function B(e,t){Object.values(e).forEach(e=>{if(n(e)){B(e,t)}else if(Array.isArray(e)){e.forEach(e=>{if(!(e instanceof f)){t.push(e)}})}});return t}function K(e,t){t.sort((t,n)=>e.indexOf(t)-e.indexOf(n))}function H(e,t){t.sort((t,n)=>e.indexOf(t.change)-e.indexOf(n.change))}function W(e,t){const n=e.map(e=>e.getId());t.forEach(t=>{if(n.indexOf(t.getId())===-1){e.push(t)}})}function J(t,n,a){t.forEach(t=>{const s=t.updateChange;if(s&&!e(s.getContent(),t.change.getContent())&&s.getState()!==d.LifecycleState.NEW){const e=t.change;if(s.getId()!==e.getId()){const t=e.getContent();s.setContent(t);s.setRevertData(e.getRevertData());e.condenserState="delete";n=n.map(t=>{if(t.getId()===e.getId()){return s}return t});const o=t=>{if(t.getId()===e.getId()){return s}return t};a.forEach((e,t)=>{a[t]=e.map(o)})}else{s.setState(d.LifecycleState.UPDATED)}s.condenserState="update"}});return n}I.condense=async function(e,t){S.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);const n={};const a={};const o=[];const r=[];const i=[];t.slice(0).reverse().forEach(e=>{if(e.getState()===d.LifecycleState.DELETED){e.condenserState="delete"}if(e.canBeCondensed()){i.push(e)}else{r.push(e)}});S.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);await M(e,n,a,o,i);S.end("Condenser_defineMaps");const c=n[O];if(!c){E.compareAndUpdate(n,a)}let l=P(n);if(c){o.forEach(e=>{if(e.condenserState!=="update"){e.condenserState="select"}});W(l,o)}l=l.concat(r);K(t,l);if(!c){S.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);let e=true;let r=B(n,[]);H(t,r);let i;try{S.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);i=E.sortIndexRelatedChanges(a,r)}catch(t){s.error(`Error during Condensing: ${t.message}`,"No Condensing performed for index-relevant changes.");e=false}S.end("Condenser_sort");if(e){l=l.filter(e=>e.condenserState!=="delete");r=r.filter(e=>e.change.condenserState!=="delete");l=J(r,l,i);K(t,l);i.forEach(e=>{E.swapChanges(e,l)})}else{o.forEach(e=>{e.condenserState="select"});W(l,o);K(t,l)}S.end("Condenser_handleIndexRelatedChanges")}S.end("Condenser_overall");return l};return I});
//# sourceMappingURL=Condenser.js.map