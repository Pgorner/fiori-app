/*
 * ! SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/m/MessageBox","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/m/Dialog","sap/m/Button","sap/base/strings/formatMessage","sap/ui/core/Lib","sap/ui/generic/app/util/ModelUtil","sap/ui/core/CustomData"],function(e,t,a,n,r,i,o,s,l,c,u,p,m){"use strict";var f=e.extend("sap.ui.generic.app.util.ActionUtil",{metadata:{properties:{controller:{type:"object",group:"Misc",defaultValue:null},applicationController:{type:"object",group:"Misc",defaultValue:null},contexts:{type:"object",group:"Misc",defaultValue:null},functionImport:{type:"object",group:"Misc",defaultValue:null},functionImportPath:{type:"string",group:"Misc",defaultValue:null},entityType:{type:"object",group:"Misc",defaultValue:null},actionLabel:{type:"string",group:"Misc",defaultValue:null},actionButtonText:{type:"string",group:"Misc",defaultValue:null},isDraftEnabled:{type:"boolean",group:"Misc",defaultValue:false},isCreateAction:{type:"boolean",group:"Misc",defaultValue:false},contextIndependentParameterData:{type:"object",group:"Misc",defaultValue:null},expand:{type:"string",group:"Misc",defaultValue:undefined},successCallback:{type:"function",group:"Misc",defaultValue:null},operationGrouping:{type:"string",group:"Misc",defaultValue:null},isBoundAction:{type:"boolean",group:"Misc",defaultValue:false}}}});f.prototype.call=function(e){return new Promise(function(t,a){var n=this.getFunctionImport();if(!n){a("Call method invoked without setting the functionImport property of ActionUtil instance.")}var r=!!n["sap:action-for"];this.setIsBoundAction(r);if(r){var i=this.getContexts();if(!i||i.length===0){a("Bound action is executed without a context.")}var o=p.getEntityTypeFromContext(i[0]);this.setEntityType(o)}this._callMethodPromise={resolve:t,reject:a};if(this._isActionCritical()){this._displayCriticalActionDialog()}else{this._prepareParamsAndInvokeAction(e)}}.bind(this))};f.prototype._displayCriticalActionDialog=function(){var e;var a="ACTION_CONFIRM|"+this.getFunctionImport().name;var n=this.getController();var r=n.getOwnerComponent();var i=r.getAppComponent();var o=i.getModel("i18n");var s=o&&o.getResourceBundle();if(s&&s.hasText(a)){e=s.getText(a)}else{e=u.getResourceBundleFor("sap.ui.generic.app").getText("ACTION_CONFIRM");e=c(e,this.getActionLabel())}t.confirm(e,{title:this.getActionLabel(),onClose:function(e){if(e==="OK"){this._prepareParamsAndInvokeAction(true)}else if(e==="CANCEL"){this._callMethodPromise.reject("Action execution cancelled by user.")}}.bind(this),sClass:this._getCompactModeStyleClass()})};f.prototype._prepareParamsAndInvokeAction=function(e){this._prepareParameters().then(function(t){this._initiateCall(t,e)}.bind(this))};f.prototype._prepareParameters=function(){return new Promise(function(e){var t=this.getFunctionImport();var a={inParameters:{},contextSpecificParameterData:[],hasParametersRequiringUserInput:false};var n=this.getContexts();var r=this.getContextIndependentParameterData()||{};var i=this.getApplicationController().getTransactionController();var o=t.name;var s=function(e){this.setContextIndependentParameterData(e)}.bind(this);var l=function(){var i={};var o=this._getKeys();r=this.getContextIndependentParameterData()||{};if(t.parameter){for(var s=0;s<t.parameter.length;s++){var l=t.parameter[s];var c=l.name;this._checkAndUpdateLabelAnnotation(l,this.getEntityType(),this.getContexts()[0]);if(c==="ResultIsActiveEntity"){if(l.nullable!=="false"){continue}}var u=!!o[c];if(l.mode.toUpperCase()==="IN"){i[c]={metadata:l,isKey:u};if(this.getIsBoundAction()&&(n.length===1||u)||l.hasOwnProperty("com.sap.vocabularies.UI.v1.Hidden")||r[c]){for(var p=0;p<n.length;p++){this.initializeContextSpecificParameterData(n[p],p,a,r,c)}}a.inParameters=i;a.hasParametersRequiringUserInput=a.hasParametersRequiringUserInput||this._checkParameterRelevant4UserInput(a,i[c])}}}e(a)}.bind(this);var c=i.getDefaultValues(n,r,undefined,o);if(c instanceof Promise){c.then(s,s).then(l)}else{Promise.resolve().then(function(){l()})}}.bind(this))};f.prototype.initializeContextSpecificParameterData=function(e,t,a,n,r){var i;var o=e.getObject();if(!a.contextSpecificParameterData[t]){a.contextSpecificParameterData[t]={}}if(n&&n[r]){i=n[r]}else if(r==="ResultIsActiveEntity"){i=false}else if(o&&o.hasOwnProperty(r)){i=o[r]}a.contextSpecificParameterData[t][r]=i};f.prototype._getKeys=function(){const e={};const t=this.getEntityType();if(t){t.key.propertyRef.forEach(t=>{e[t.name]=true})}return e};f.prototype._getCompactModeStyleClass=function(){if(this.getController().getView().$().closest(".sapUiSizeCompact").length){return"sapUiSizeCompact"}return""};f.prototype._cleanUpContext=function(e){e.forEach(function(e){var t=e.getModel();var a=e.sPath;t.resetChanges([a],true,true)})};f.prototype._isActionCritical=function(){var e=this.getFunctionImport()["com.sap.vocabularies.Common.v1.IsActionCritical"];if(!e){return false}if(e.Bool===undefined){return true}return this._toBoolean(e.Bool)};f.prototype._toBoolean=function(e){if(typeof e==="string"){var t=e.toLowerCase();return!(t==="false"||t===""||t===" ")}return!!e};f.prototype._initiateCall=function(e,t){var a=t?"strict":"lenient";var n={Prefer:"handling="+a};var r=this.getContextIndependentParameterData()||{};var o=this.getIsDraftEnabled();if(!e.hasParametersRequiringUserInput||this.getIsCreateAction()&&this._checkContextIndependentParameterDataForInParams(e)){this._call(r,o,n,this.expand)}else if(Object.keys(e.inParameters).length>0){var c=this.getApplicationController();var p=o?c.synchronizeDraftAsync():Promise.resolve();p.then(function(){var a={urlParameters:{},headers:n,expand:this.expand};var r=this.getContexts();var o=c._getChangeSetFunc(r,this.getOperationGrouping());var p=r.map(function(e,t){a.changeSetId=o(t);return c.getNewActionContext(this.getFunctionImportPath(),e,a)}.bind(this));var m=p.map(function(e){return e.context});Promise.all(m).then(function(a){a.forEach(function(t,a){var n=e.contextSpecificParameterData[a];for(var r in n){t.getModel().setProperty(r,n[r],t,true)}});if(t){var n=this._buildParametersForm(e,a[0]);var o=false;var c=new s({title:this.getActionLabel(),content:[n.form],beginButton:new l({text:this.getActionButtonText()||this.getActionLabel(),type:"Emphasized",press:function(){var i=n.form?n.form.check():Promise.resolve();i.then(function(){if(n.hasNoClientErrors()){c.close();o=this._triggerActionPromise(p,r,e,a,t)}}.bind(this))}.bind(this)}),endButton:new l({text:u.getResourceBundleFor("sap.ui.generic.app").getText("ACTION_CANCEL"),press:function(){p[0].abort();c.close();this._cleanUpContext(a);this._callMethodPromise.reject();o=true}.bind(this)}),afterClose:function(){c.destroy();if(!o){this._callMethodPromise.reject()}}.bind(this)}).addStyleClass("sapUiNoContentPadding");c.addStyleClass(this._getCompactModeStyleClass());c.setModel(a[0].getModel());if(this.getController().getView().getModel("@i18n")){c.setModel(this.getController().getView().getModel("@i18n"),"@i18n")}var m=c.getAggregation("content")[0].mAggregations["content"];var f=m.getFormContainers()[0].getFormElements();var d=f.some(function(e){var t=e.getFields()[0];return t instanceof i&&t.getVisible()===true});if(f.length===0||!d){this._triggerActionPromise(p,r,e,a,t);c.destroy()}else{c.open()}}else{this._triggerActionPromise(p,r,e,a)}}.bind(this))}.bind(this))}else{this._call(null,o,n,null)}};f.prototype._triggerActionPromise=function(e,t,a,n,r){const i={};this._callMethodPromise.resolve({executionPromise:this.getApplicationController()._newPromiseAll(e.map(function(e){return e.result})).then(function(e){this._bExecutedSuccessfully=this.getApplicationController()._checkAtLeastOneSuccess(t,e);if(r){e.forEach(function(e){e.userEnteredAdditionalParams=i})}if(this._bExecutedSuccessfully){return e}else{this._cleanUpContext(n);return Promise.reject(e)}}.bind(this),function(e){this._bExecutedSuccessfully=false;e.forEach(function(e){e.userEnteredAdditionalParams=i});throw e}.bind(this))});var o=n[0].getObject();var s=Object.values(a.inParameters);s.forEach(function(e){if(this._checkParameterRelevant4UserInput(a,e)){var t=e.metadata;var r=o[t.name]===null?undefined:o[t.name];if(r===undefined){if(t.type==="Edm.Boolean"){r=false}n[0].getModel().setProperty(t.name,r,n[0],true)}i[t.name]=r;for(var s=1;s<n.length;s++){var l=n[s];l.getModel().setProperty(t.name,r,l,true)}}}.bind(this));var l=this.getFunctionImport().name;t.forEach(function(e,t){this.getApplicationController().submitActionContext(e,n[t],l)}.bind(this));return r};f.prototype._call=function(e,t,a,n){var r=this.getContexts();var i=this.getApplicationController();var o={urlParameters:e,operationGrouping:this.getOperationGrouping(),triggerChanges:t,headers:a,expand:n};this._callMethodPromise.resolve({executionPromise:i.invokeActions(this.getFunctionImportPath(),r,o).then(function(e){this._bExecutedSuccessfully=true;return e}.bind(this),function(e){this._bExecutedSuccessfully=false;throw e}.bind(this))})};f.prototype._buildParametersForm=function(e,t){var s=new a({editable:true,validationMode:"Async"});s.setBindingContext(t);var l;var c=[];var u;var p=new n;const f=Object.values(e.inParameters);for(var d=0;d<f.length;d++){var h=f[d].metadata;if(!this._checkParameterRelevant4UserInput(e,f[d])){continue}if(!h["com.sap.vocabularies.UI.v1.TextArrangement"]){h["com.sap.vocabularies.UI.v1.TextArrangement"]={EnumMember:"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"}}l=new i("ActionUtil-"+this.getFunctionImportPath().replace("/","-")+"-"+h.name,{value:"{"+h.name+"}",textLabel:this._getParameterName(h),width:"100%"});l.addCustomData(new m({key:"defaultTextInEditModeSource",value:"ValueListNoValidation"}));l.addCustomData(new m({key:"defaultInputFieldDisplayBehaviour",value:"descriptionOnly"}));c.push(l);u=new o;u.setLabelFor(l);var g=new r;g.addElement(l);p.addGroupElement(g)}s.addGroup(p);var v=function(){var e=true;for(var t=0;t<c.length;t++){if(c[t].getValueState()!="None"){e=false;break}}return e};return{form:s,hasNoClientErrors:v}};f.prototype._checkParameterRelevant4UserInput=function(e,t){const a=t.metadata;var n=a["com.sap.vocabularies.UI.v1.Hidden"];return!(n&&!n.Path&&n.Bool!=="false"||t.isKey&&this.getIsBoundAction())};f.prototype._getParameterName=function(e){return e["com.sap.vocabularies.Common.v1.Label"]?e["com.sap.vocabularies.Common.v1.Label"].String:e.name};f.prototype._checkAndUpdateLabelAnnotation=function(e,t,a){if(t&&e&&!e["com.sap.vocabularies.Common.v1.Label"]){var n=a.getModel().getMetaModel().getODataProperty(t,e.name,false);if(n&&n["com.sap.vocabularies.Common.v1.Label"]){e["com.sap.vocabularies.Common.v1.Label"]=n["com.sap.vocabularies.Common.v1.Label"]}}};f.prototype._checkContextIndependentParameterDataForInParams=function(e){var t=this.getContextIndependentParameterData()||{};var a=Object.values(e.inParameters);for(var n=0;n<a.length;n++){var r=a[n].metadata.name;if(!t[r]){return false}}return true};f.prototype.getExecutedSuccessfully=function(){return this._bExecutedSuccessfully};return f});
//# sourceMappingURL=ActionUtil.js.map