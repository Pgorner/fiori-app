/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/m/Menu","sap/m/MenuItem","sap/ui/base/DesignTime","sap/ui/dt/util/_createPromise","sap/ui/dt/Plugin","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/events/KeyCodes","sap/ui/Device"],function(e,t,n,o,i,s,r,u,a,c){"use strict";const h=s.extend("sap.ui.dt.plugin.ContextMenu",{metadata:{library:"sap.ui.dt",properties:{contextElement:{type:"object"},openOnClick:{type:"boolean",defaultValue:true}},events:{openedContextMenu:{},closedContextMenu:{}}}});const l="sapUiDtContextMenu";h.prototype.init=function(){this.oContextMenuControl=new t;this.oContextMenuControl.attachItemSelected(this._onItemSelected,this);this.oContextMenuControl.attachClosed(this._contextMenuClosed,this);this.oContextMenuControl.addStyleClass(l);this._aMenuItems=[];this._aGroupedItems=[];this._aSubMenus=[]};h.prototype.exit=function(){delete this._aMenuItems;if(this.oContextMenuControl){this.oContextMenuControl.destroy()}};h.prototype.addMenuItem=function(e,t,n){const o={menuItem:e,fromPlugin:!!t,bPersistOneTime:n};this._aMenuItems.push(o)};h.prototype.registerElementOverlay=function(e){e.attachBrowserEvent("click",this._openContextMenu,this);e.attachBrowserEvent("touchstart",this._openContextMenu,this);e.attachBrowserEvent("contextmenu",this._openContextMenu,this);e.attachBrowserEvent("keydown",this._onKeyDown,this);e.attachBrowserEvent("keyup",this._onKeyUp,this)};h.prototype.deregisterElementOverlay=function(e){e.detachBrowserEvent("click",this._openContextMenu,this);e.detachBrowserEvent("touchstart",this._openContextMenu,this);e.detachBrowserEvent("contextmenu",this._openContextMenu,this);e.detachBrowserEvent("keydown",this._onKeyDown,this);e.detachBrowserEvent("keyup",this._onKeyUp,this)};h.prototype.open=function(e,t,o){let s;function r(t,o){o.forEach(function(o,i){const u=typeof o.text==="function"?o.text(e):o.text;const a=typeof o.enabled==="function"?o.enabled(s):o.enabled;t.addItem(new n({key:o.id,icon:o.icon,text:u,enabled:a}));if(o.submenu){r(t.getItems()[i],o.submenu)}})}const a=e.getElement();if(this._fnCancelMenuPromise){if(this.getContextElement()===a){return}this._fnCancelMenuPromise();delete this._fnCancelMenuPromise}this.setContextElement(a);this.getDesignTime().getSelectionManager().attachChange(this._onSelectionChanged,this);s=this.getSelectedOverlays().filter(function(t){return t!==e});s.unshift(e);this._aMenuItems=this._aMenuItems.filter(function(e){if(e.bPersistOneTime){e.bPersistOneTime=false;return true}return!e.fromPlugin});this.oContextMenuControl.destroyItems();let c=Promise.resolve();if(!t){const e=i(function(e,t){u.waitForSynced(this.getDesignTime())().then(e).catch(t)}.bind(this));this._fnCancelMenuPromise=e.cancel;c=e.promise.then(function(){this._aGroupedItems=[];this._aSubMenus=[];const e=[];const t=this.getDesignTime().getPlugins();t.forEach(function(t){let n=t.getMenuItems(s);if(!(n instanceof Promise)){n=Promise.resolve(n)}e.push(n)});const n=i(function(t,n){Promise.all(e).then(t).catch(n)});this._fnCancelMenuPromise=n.cancel;return n.promise}.bind(this)).then(function(e){return e.reduce(function(e,t){return e.concat(t)})}).then(function(e){e.forEach(function(e){if(e.submenu!==undefined){this._addSubMenu(e)}else{this.addMenuItem(e,true)}}.bind(this));this._addItemGroupsToMenu();delete this._fnCancelMenuPromise}.bind(this))}c.then(function(){let t=this._aMenuItems.map(function(e){return e.menuItem});if(t.length>0){t=this._sortMenuItems(t);r(this.oContextMenuControl,t);this.oContextMenuControl.openAsContextMenu(o,e)}this.fireOpenedContextMenu()}.bind(this)).catch(function(e){throw u.createError("ContextMenu#open",`An error occurred during calling getMenuItems: ${e}`)})};h.prototype._sortMenuItems=function(e){return e.sort(function(e,t){if(!e.rank&&!t.rank){return 0}if(!e.rank&&t.rank){return-1}if(e.rank&&!t.rank){return 1}return e.rank-t.rank})};h.prototype._onItemSelected=function(t){this._ensureSelection(this._oCurrentOverlay);function n(t,n){const o=t.responsible||this.getSelectedOverlays()||[];e(o.length>0,"sap.ui.rta - Opening context menu, with empty selection - check event order");const i={};i.eventItem=n;i.contextElement=this.getContextElement();t.handler(o,i)}const o=t.getParameter("item").getKey();this._aMenuItems.some(function(e){const i=e.menuItem;if(o===e.menuItem.id){n.apply(this,[i,t]);return true}else if(i.submenu){i.submenu.some(function(e){if(o===e.id){n.apply(this,[e,t]);return true}}.bind(this))}},this)};h.prototype._onKeyUp=function(e){const t=r.getOverlay(e.currentTarget.id);if(e.keyCode===a.ENTER&&t.getIgnoreEnterKeyUpOnce()){t.setIgnoreEnterKeyUpOnce(false);e.stopPropagation();e.preventDefault();return}if((e.keyCode===a.SPACE||e.keyCode===a.ENTER)&&e.shiftKey===false&&e.altKey===false&&e.ctrlKey===false){if(!this._checkForPluginLock()){this._openContextMenu(e);e.stopPropagation();e.preventDefault()}}if(e.keyCode===a.F10&&e.shiftKey===true&&e.altKey===false&&e.ctrlKey===false){if(!this._checkForPluginLock()){this._openContextMenu(e);e.stopPropagation();e.preventDefault()}}};h.prototype._onKeyDown=function(e){const t=r.getOverlay(e.currentTarget.id);if(e.keyCode===a.SPACE&&e.shiftKey===false&&e.altKey===false&&e.ctrlKey===false){if(t&&t.isSelectable()&&!this._checkForPluginLock()){t.setSelected(true);e.stopPropagation();e.preventDefault()}}};h.prototype._openContextMenu=function(e){if(e.type==="click"&&o.isDesignModeEnabled()){return}const t=r.getOverlay(e.currentTarget.id);if(t&&t.isSelectable()&&t.getSelected()){this._oCurrentOverlay=t;this.open(t,undefined,e)}};h.prototype._contextMenuClosed=function(){this.fireClosedContextMenu()};h.prototype._onSelectionChanged=function(){this.getDesignTime().getSelectionManager().detachChange(this._onSelectionChanged,this)};h.prototype._ensureSelection=function(e){if(e&&!e.isSelected()){e.setSelected(true)}};h.prototype._checkForPluginLock=function(){if(c.os.ios){return false}if(this.getDesignTime().getBusyPlugins().length){return true}return false};h.prototype._addMenuItemToGroup=function(e){const t=this._aGroupedItems.some(function(t){if(t.sGroupName===e.group){t.aGroupedItems.push(e);return true}});if(!t){this._aGroupedItems.push({sGroupName:e.group,aGroupedItems:[e]})}};h.prototype._addSubMenu=function(e){e.submenu.forEach(function(t){t.handler||=e.handler});this._aSubMenus.push({sSubMenuId:e.id,aSubMenuItems:e.submenu});this.addMenuItem(e,true)};h.prototype._addItemGroupsToMenu=function(){this._aGroupedItems.forEach(function(e){if(e.aGroupedItems.length===1){this.addMenuItem(e.aGroupedItems[0],true)}else{this.addMenuItem({id:`${e.sGroupName}-groupItem`,enabled:true,text:e.sGroupName,icon:e.aGroupedItems[0].icon,rank:e.aGroupedItems[0].rank,submenu:e.aGroupedItems},true)}}.bind(this))};return h});
//# sourceMappingURL=ContextMenu.js.map