/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/utils/constants","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/textManipulator","sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/viewValidator","sap/apf/utils/utils","sap/m/Token","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/mvc/ViewType"],function(e,t,i,l,n,a,o,s,d,r,u){"use strict";var c=d.ValueState;var f=e.events.facetFilter;var I,b,g,V,y,F,S;var p=n.TranslationFormatMap.FACETFILTER_LABEL;function v(e){e.byId("idFacetFilterBasicData").setText(b("basicData"));e.byId("idFFLabel").setText(b("ffLabel"));e.byId("idLabel").setPlaceholder(b("newFacetFilter"));e.byId("idFFPropertyLabel").setText(b("ffProperty"));e.byId("idDoNotShowAtRuntimeLabel").setText(b("doNotShowAtRuntime"));e.byId("idSelectionModeLabel").setText(b("ffSelectionMode"));e.byId("idValueHelpLabel").setText(b("valueHelpMode"));e.byId("idVHNone").setText(b("none"));e.byId("idValueHelpRequest").setText(b("valueHelpRequest"));e.byId("idConfigListOfValues").setText(b("configListOfValues"));e.byId("idConfigListOfValuesLabel").setText(b("configListOfValuesLabel"));e.byId("idSingleSelectionMode").setText(b("singleSelection"));e.byId("idMultiSelectionMode").setText(b("multipleSelection"));e.byId("idDefaultValuesTitle").setText(b("vhDefaultValues"));e.byId("idPreselectionModeLabel").setText(b("vhDefaultValueMode"));e.byId("idNoneSelection").setText(b("none"));e.byId("idAutomaticSelection").setText(b("automaticValue"));e.byId("idFixedValue").setText(b("fixedValues"));e.byId("idFunction").setText(b("function"));e.byId("idPreselectionDefaultsLabel").setText(b("vhDefaultValues"));e.byId("idPreselectionFunctionLabel").setText(b("function"));e.byId("idValueHelpTitle").setText(b("valueHelp"));e.byId("idFilterResolutionTitle").setText(b("contextResolution"));e.byId("idUseVHRAsFRRCheckBoxLabel").setText(b("vhCheckBoxLabel"));e.byId("idAriaPropertyForSelection").setText(b("ffSelectionMode"));e.byId("idAriaPropertyForDefaultMode").setText(b("vhDefaultValueMode"));e.byId("idAriaPropertyForVHR").setText(b("valueHelpMode"))}function R(e,t){var i=F.isVisible()?"sap-icon://filter":"sap-icon://hide";var l={id:F.getId(),icon:i};if(t){delete l.icon;l.name=t}e.getView().getViewData().updateSelectedNode(l)}function h(e,t){var i=b("facetFilter")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i)}function P(e){var i;if(I&&I.arguments&&I.arguments.facetFilterId){F=V.getFacetFilter(I.arguments.facetFilterId);T(F)}if(!t.checkIsNotUndefined(F)){i=V.createFacetFilter();F=V.getFacetFilter(i);R(e);T(F)}}function T(e){true}function C(t){var i,l,n,a;var o={oTextReader:b,oConfigurationHandler:g,oConfigurationEditor:V,oParentObject:F,getCalatogServiceUri:t.getView().getViewData().getCalatogServiceUri,oCoreApi:t.getView().getViewData().oCoreApi};i=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterVHR");n=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:u.XML,id:t.createId("idVHRView"),viewData:o,controller:i});l=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterFRR");a=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:u.XML,id:t.createId("idFRRView"),viewData:o,controller:l});n.attachEvent(f.UPDATEPROPERTIES,t.setFFProperty.bind(t));a.attachEvent(f.UPDATEPROPERTIES,t.setFFProperty.bind(t));t.getView().attachEvent(f.USESAMEASVHR,a.getController().handleCopy.bind(a.getController()));t.getView().attachEvent(f.ENABLEDISABLEFRRFIELDS,a.getController().enableOrDisableView.bind(a.getController()));n.attachEvent(f.USESAMEASVHR,a.getController().handleCopy.bind(a.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,n.getController().updateSubViewInstancesOnReset.bind(n.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,a.getController().updateSubViewInstancesOnReset.bind(a.getController()));t.getView().attachEvent(f.DONOTSHOWATRUNTIME,n.getController().clearVHRFields.bind(n.getController()));t.getView().attachEvent(f.CLEARVHRFIELDSIFVALUELIST,n.getController().clearVHRFields.bind(n.getController()));t.getView().attachEvent(f.DONOTSHOWATRUNTIME,a.getController().clearFRRFields.bind(a.getController()));n.addStyleClass("formTopPadding");n.addStyleClass("formBottomPadding");a.addStyleClass("formTopPadding")}function L(e,t){e.byId("idSelectionMode").setVisible(t);e.byId("idSelectionModeLabel").setVisible(t);e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"));e.byId("idValueHelp").setVisible(t);e.byId("idValueHelpLabel").setVisible(t);e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"));e.byId("idFFForm1").setVisible(t);if(t){e.byId("idValueHelpTitle").setText(b("valueHelp"));e.byId("idFRRVBox").insertItem(e.byId("idFRRView"));e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(false)}else{e.byId("idValueHelpTitle").setText("");M(e,t);B(e,t);e.byId("idFRRVBox").removeItem(e.byId("idFRRView"))}}function E(e){if(!F.isVisible()){e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(true)}L(e,F.isVisible())}function m(e){if(!t.checkIsNotNullOrUndefinedOrBlank(V.getFacetFilter(I.arguments.facetFilterId))){return}if(t.checkIsNotNullOrUndefinedOrBlank(F.getLabelKey())&&y.get(F.getLabelKey())){e.byId("idLabel").setValue(y.get(F.getLabelKey()).TextElementDescription)}else{e.byId("idLabel").setValue(F.getId())}}function D(e){if(!t.checkIsNotNullOrUndefinedOrBlank(V.getFacetFilter(I.arguments.facetFilterId))){F.setMultiSelection(true)}if(F.isMultiSelection()){e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"))}else{e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idSingleSelectionMode"))}}function A(e){e.byId("idPreselectionFunction").setValue("");if(t.checkIsNotNullOrUndefinedOrBlank(F.getPreselectionFunction())){e.byId("idPreselectionFunction").setValue(F.getPreselectionFunction())}}function O(e){var i=false,l=false;if(F.getNoneSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idNoneSelection"))}else if(t.checkIsNotNullOrUndefinedOrBlank(F.getPreselectionFunction())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFunction"));A(e);i=true}else if(t.checkIsNotNullOrUndefinedOrBlank(F.getPreselectionDefaults())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFixedValue"));w(e);l=true}else if(F.getAutomaticSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idAutomaticSelection"))}x(e,i);N(e,l)}function x(e,t){e.byId("idPreselectionFunctionLabel").setVisible(t);e.byId("idPreselectionFunction").setVisible(t);if(t){S.addField("idPreselectionFunction")}else{e.byId("idPreselectionFunction").setValue("");S.removeField("idPreselectionFunction")}}function N(e,t){e.byId("idPreselectionDefaultsLabel").setVisible(t);e.byId("idPreselectionDefaults").setVisible(t);if(t){S.addField("idPreselectionDefaults")}else{S.removeField("idPreselectionDefaults")}}function w(e){e.byId("idPreselectionDefaults").setTokens([]);var i=F.getPreselectionDefaults();if(t.checkIsNotNullOrUndefinedOrBlank(i)){i.forEach(function(t){e.byId("idPreselectionDefaults").addToken(new s({text:t}))})}}function k(e){e.byId("idConfigListOfValuesMultiInput").setTokens([]);var i=F.getValueList();if(t.checkIsNotNullOrUndefinedOrBlank(i)){i.forEach(function(t){e.byId("idConfigListOfValuesMultiInput").addToken(new s({text:t}))})}}function B(e,t){e.byId("idConfigListOfValuesLabel").setVisible(t);e.byId("idConfigListOfValuesMultiInput").setVisible(t);if(t){S.addField("idConfigListOfValuesMultiInput")}else{S.removeField("idConfigListOfValuesMultiInput")}}function M(e,t){e.getView().fireEvent(f.ENABLEDISABLEFRRFIELDS);G(e,t);if(t){e.byId("idVHRVBox").insertItem(e.byId("idVHRView"))}else{e.getView().fireEvent(f.CLEARVHRFIELDSIFVALUELIST);e.byId("idVHRVBox").removeItem(e.byId("idVHRView"))}}function H(e){if(F.getUseSameRequestForValueHelpAndFilterResolution()){e.byId("idUseVHRAsFRRCheckBox").setSelected(true);e.getView().fireEvent(f.ENABLEDISABLEFRRFIELDS)}}function U(e){var i=false,l=false;if(t.checkIsNotNullOrUndefinedOrBlank(F.getServiceOfValueHelp())){i=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idValueHelpRequest"))}else if(t.checkIsNotNullOrUndefinedOrBlank(F.getValueList())){k(e);l=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idConfigListOfValues"))}else{e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"))}B(e,l);M(e,i)}function G(e,t){if(t===false){e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}e.byId("idUseVHRAsFRRCheckBox").setVisible(t);e.byId("idUseVHRAsFRRCheckBoxLabel").setVisible(t)}function q(e,t){t.byId("idPreselectionDefaults").setValueState(c.Warning);t.byId("idPreselectionDefaults").setValueStateText(b(e));t.byId("idPreselectionDefaults").focus()}function W(e,t){var i=new s({text:e});t.addToken(i);V.setIsUnsaved()}function K(e,t){if(e.mEventRegistry.tokenChange===undefined){e.attachTokenChange(t)}}return r.extend("sap.apf.modeler.ui.controller.facetFilter",{onInit:function(){var e=this;var t=e.getView().getViewData();b=t.getText;I=t.oParams;g=t.oConfigurationHandler;y=g.getTextPool();V=t.oConfigurationEditor;if(!V){g.loadConfiguration(I.arguments.configId,function(e){V=e})}S=new a(e.getView());v(e);P(e);C(e);e.setDetailData();S.addFields(["idFFProperty","idLabel"])},onAfterRendering:function(){var e=this;if(e.byId("idLabel").getValue().length===0){e.byId("idLabel").focus()}K(e.byId("idConfigListOfValuesMultiInput"),e.handleTokenChangeForConfigListOfValues.bind(e));K(e.byId("idPreselectionDefaults"),e.handleTokenChangeForPreselectionDefaults.bind(e))},setDetailData:function(){var e=this;E(e);e.setFFProperty();m(e);D(e);O(e);U(e);H(e)},updateSubViewInstancesOnReset:function(t){var i=this;V=t;F=V.getFacetFilter(F.getId());i.getView().fireEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:V,oParentObject:F})},validateSelectedValues:function(e,t,i){var n={},a=[],s=[],d=[],r=[],u;n=o.validateSelectedValues(t,i);a=n.invalid;s=n.valid;d=l.addPrefixText(a,b);r=d.concat(i).length!==0?d.concat(i):i;u=d.concat(s).length!==0?d.concat(s):t;return{aValues:r,aSelectedValues:u}},setFFProperty:function(){var e=this;var l=[],n,a;V.getFilterablePropertiesAndParametersAsPromise().done(function(o){l=o;a=F.getProperty();if(t.checkIsNotNullOrUndefinedOrBlank(a)){n=e.validateSelectedValues(e,[a],l);l=n.aValues;a=n.aSelectedValues[0]}var s=i.convert(l);e.byId("idFFProperty").setModel(s);e.byId("idFFProperty").setSelectedKey(a)})},handleChangeForVisibilityAtRuntime:function(){var e=this,t=true;if(e.byId("idDoNotShowAtRuntimeCheckBox").getSelected()){t=false;F.setInvisible();F.setUseSameRequestForValueHelpAndFilterResolution(false);e.getView().fireEvent(f.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(f.DONOTSHOWATRUNTIME);F.setValueList([]);k(e)}else{F.setVisible()}F.setMultiSelection(true);V.setIsUnsaved();R(e);L(e,t)},handleChangeForProperty:function(){var i=this;var n=i.byId("idFFProperty").getSelectedKey().trim();n=l.removePrefixText(n,b(e.texts.NOTAVAILABLE));if(t.checkIsNotNullOrUndefinedOrBlank(n)){F.setProperty(n)}V.setIsUnsaved()},handleChangeForLabel:function(){var e=this;var i=e.byId("idLabel").getValue().trim();if(t.checkIsNotNullOrUndefinedOrBlank(i)){y.setTextAsPromise(i,p).done(function(t){F.setLabelKey(t);R(e,i);h(e,i);V.setIsUnsaved()})}else{V.setIsUnsaved()}},handleSuggestions:function(e){var t=new n.SuggestionTextHandler(y);t.manageSuggestionTexts(e,p)},handleChangeForSelectionMode:function(){var e=this,t,i;var l=e.byId("idSelectionModeRadioGroup").getSelectedButton();if(l===e.byId("idSingleSelectionMode")){F.setMultiSelection(false);if(e.byId("idPreselectionDefaultsLabel").getVisible()){t=F.getPreselectionDefaults();if(t&&t.length>1){F.setPreselectionDefaults([t[0]]);i=new s({text:t[0]});e.byId("idPreselectionDefaults").setTokens([i]);q("singleToMultipleSelectionWarningMessage",e)}}}else{e.byId("idPreselectionDefaults").setValueState(c.None);F.setMultiSelection(true)}V.setIsUnsaved()},handleChangeForPreselectionMode:function(){var e=this,t=false,i=false,l=false,n=false;switch(e.byId("idPreselectionModeRadioGroup").getSelectedButton()){case e.byId("idAutomaticSelection"):t=true;break;case e.byId("idFunction"):i=true;F.removePreselectionDefaults();break;case e.byId("idFixedValue"):l=true;F.removePreselectionFunction();break;default:n=true}F.setAutomaticSelection(t);F.setNoneSelection(n);w(e);A(e);N(e,l);x(e,i);V.setIsUnsaved()},handleChangeForPreselectionDefaults:function(e){var t=this;t.byId("idPreselectionDefaults").setValue("");t.byId("idPreselectionDefaults").setValueState(c.None);if(!F.isMultiSelection()){if(t.byId("idPreselectionDefaults").getTokens().length<1){t.byId("idPreselectionDefaults").setValueState(c.None);W(e.getParameter("value"),t.byId("idPreselectionDefaults"))}else{q("singleSelectionWarningMessage",t)}}else{W(e.getParameter("value"),t.byId("idPreselectionDefaults"))}},handleTokenChangeForPreselectionDefaults:function(e){var t=this;var i,l=[];var n=t.byId("idPreselectionDefaults").getTokens();t.byId("idPreselectionDefaults").setValueState(c.None);if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<n.length;i++){l[i]=n[i].getText()}if(F.isMultiSelection()){F.setPreselectionDefaults(l)}else{F.setPreselectionDefaults([l[0]])}if(e.getParameters().type==="removed"){V.setIsUnsaved()}}},handleChangeForPreselectionFunction:function(){var e=this;var i=e.byId("idPreselectionFunction").getValue().trim();F.removePreselectionFunction();if(t.checkIsNotNullOrUndefinedOrBlank(i)){F.setPreselectionFunction(i)}V.setIsUnsaved()},handleChangeForUseVHRAsFRRCheckBox:function(){var e=this;if(e.byId("idUseVHRAsFRRCheckBox").getSelected()){F.setUseSameRequestForValueHelpAndFilterResolution(true)}else{F.setUseSameRequestForValueHelpAndFilterResolution(false)}e.getView().fireEvent(f.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(f.USESAMEASVHR);V.setIsUnsaved()},handleChangeForValueHelpOption:function(){var e=this,t=false,i=false;switch(e.byId("idValueHelpRadioGroup").getSelectedButton()){case e.byId("idValueHelpRequest"):t=true;F.setValueList([]);break;case e.byId("idConfigListOfValues"):i=true;F.setAlias(undefined);break;default:F.setAlias(undefined);F.setValueList([])}if(F.getUseSameRequestForValueHelpAndFilterResolution()===true){F.setUseSameRequestForValueHelpAndFilterResolution(false);e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}k(e);B(e,i);M(e,t);V.setIsUnsaved()},handleChangeForConfigListOfValues:function(e){var t=this;t.byId("idConfigListOfValuesMultiInput").setValue("");W(e.getParameter("value"),t.byId("idConfigListOfValuesMultiInput"))},handleTokenChangeForConfigListOfValues:function(e){var t=this;var i,l=[];var n=t.byId("idConfigListOfValuesMultiInput").getTokens();if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<n.length;i++){l[i]=n[i].getText()}F.setValueList(l);if(e.getParameters().type==="removed"){V.setIsUnsaved()}}},getValidationState:function(){var e=this;return S.getValidationState()&&e.byId("idVHRView").getController().getValidationState()&&e.byId("idFRRView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idVHRView").destroy();e.byId("idFRRView").destroy()}})});
//# sourceMappingURL=facetFilter.controller.js.map