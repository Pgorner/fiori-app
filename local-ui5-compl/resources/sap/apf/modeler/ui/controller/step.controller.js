sap.ui.define(["sap/apf/modeler/ui/utils/constants","sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/modeler/ui/utils/textPoolHelper","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/mvc/ViewType"],function(e,t,i,a,n,r,o,d,s,l){"use strict";var g=d.ValueState;var p,u,c,I,f,S,T,v,b,y,h,m;var V=o.TranslationFormatMap.STEP_TITLE;var N=o.TranslationFormatMap.STEP_LONG_TITLE;function E(e){e.byId("idStepBasicData").setText(u("stepBasicData"));e.byId("idStepTitleLabel").setText(u("stepTitle"));e.byId("idStepTitle").setPlaceholder(u("newStep"));e.byId("idStepLongTitleLabel").setText(u("stepLongTitle"));e.byId("idStepLongTitle").setPlaceholder(u("stepLongTitle"));e.byId("idCategoryTitleLabel").setText(u("categoryAssignments"));e.byId("idGlobalLabel").setText(u("globalNavigationTarget"));e.byId("idStepSpecificLabel").setText(u("stepSpecificNavTargets"));e.byId("idDataRequest").setText(u("dataRequest"));e.byId("idFilterMapping").setText(u("filterMap"));e.byId("idFilterMapKeepSourceLabel").setText(u("filterMapKeepSource"));e.byId("idNavigationTarget").setText(u("navigationTargetAssignments"));e.byId("idDataReduction").setText(u("dataReduction"));e.byId("idDataReductionLabel").setText(u("dataReductionType"));e.byId("idNoDataReduction").setText(u("noDataReduction"));e.byId("idTopN").setText(u("topN"));e.byId("idNumberOfRecordsLabel").setText(u("recordNumber"));e.byId("idAriaPropertyForDataReduction").setText(u("dataReductionType"))}function C(e,t){var i=u(h?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i);R(e,t)}function R(e,t){var i=u(h?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(i)}function w(e,t){var i={id:T.getId(),icon:T.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(t){i.name=t}e.getView().getViewData().updateSelectedNode(i)}function F(e){var t,a;if(p&&p.arguments&&p.arguments.stepId){T=I.getStep(p.arguments.stepId);h=T&&T.getType()==="hierarchicalStep"?true:false}if(!i.checkIsNotUndefined(T)){a=p.arguments.categoryId;h=p.bIsHierarchicalStep;if(h){t=I.createHierarchicalStep(a)}else{t=I.createStep(a)}T=I.getStep(t);w(e)}}function x(t){var i=this;var a=t.getParameter("bShowFilterMappingLayout");i.byId("idStepFilterMappingVBox").setVisible(a);i.byId("idFilterMapKeepSourceLabel").setVisible(a);i.byId("idFilterKeepSourceCheckBox").setVisible(a);if(!a){i.byId("idFilterMapping").setText("");i.getView().fireEvent(e.events.step.RESETFILTERMAPPINGFIELDS)}else{i.byId("idFilterMapping").setText(u("filterMap"))}}function O(e){e.byId("idDataReductionForm").setVisible(!h)}function D(e,t,i,a,n){sap.ui.view({viewName:a,type:l.XML,id:e.createId(n),viewData:i,controller:t})}function P(t){var i,a,n,r,o,d,s;i={oTextReader:u,oConfigurationEditor:I,oTextPool:f,oParentObject:T,oStepPropertyMetadataHandler:m,oCoreApi:t.getView().getViewData().oCoreApi};a=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");D(t,a,i,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");o=t.byId("idStepCornerTextView");t.byId("idStepCornerTextVBox").insertItem(o);i.oConfigurationHandler=c;i.getCalatogServiceUri=t.getView().getViewData().getCalatogServiceUri;if(h){n=new sap.ui.controller("sap.apf.modeler.ui.controller.hierarchicalStepRequest")}else{n=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest")}D(t,n,i,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");d=t.byId("idStepRequestView");t.byId("idStepRequestVBox").insertItem(d);r=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");D(t,r,i,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");s=t.byId("idStepFilterMappingView");t.byId("idStepFilterMappingVBox").insertItem(s);d.attachEvent(e.events.step.SETDATAREDUCTIONSECTION,t.setDataReductionSection.bind(t));d.attachEvent(e.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,x.bind(t));t.getView().attachEvent(e.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,x.bind(t));d.attachEvent(e.events.step.UPDATEFILTERMAPPINGFIELDS,s.getController().updateFilterMappingFields.bind(s.getController()));t.getView().attachEvent(e.events.step.RESETFILTERMAPPINGFIELDS,s.getController().resetFilterMappingFields.bind(s.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,o.getController().updateSubViewInstancesOnReset.bind(o.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,d.getController().updateSubViewInstancesOnReset.bind(d.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,s.getController().updateSubViewInstancesOnReset.bind(s.getController()));d.addStyleClass("formTopPadding");d.addStyleClass("formBottomPadding");s.addStyleClass("formTopPadding");s.addStyleClass("formBottomPadding")}function L(e){if(!i.checkIsNotNullOrUndefinedOrBlank(I.getStep(p.arguments.stepId))){return}e.byId("idStepTitle").setValue(T.getId());if(i.checkIsNotNullOrUndefinedOrBlank(T.getTitleId())&&f.get(T.getTitleId())){e.byId("idStepTitle").setValue(f.get(T.getTitleId()).TextElementDescription)}}function M(e){if(!i.checkIsNotNullOrUndefinedOrBlank(I.getStep(p.arguments.stepId))){return}e.byId("idStepLongTitle").setValue("");if(i.checkIsNotNullOrUndefinedOrBlank(T.getLongTitleId())&&f.get(T.getLongTitleId())){e.byId("idStepLongTitle").setValue(f.get(T.getLongTitleId()).TextElementDescription)}}function B(e){var t=[];var n=I.getCategories();n.forEach(function(e){var i={};i.CategoryId=e.getId();i.CategoryTitle=f.get(e.labelKey)?f.get(e.labelKey).TextElementDescription:e.labelKey;t.push(i)});var r=a.prepareModel(t,t.length);e.byId("idCategorySelect").setModel(r);var o=I.getCategoriesForStep(T.getId());if(i.checkIsNotNullOrUndefinedOrBlank(o)){e.byId("idCategorySelect").setSelectedKeys(o)}}function U(e){e.byId("idNumberOfRecordsValue").setValue("");e.byId("idNumberOfRecordsValue").setValueState("None");if(T.getTopN()){e.byId("idNumberOfRecordsValue").setValue(T.getTopN().top)}k(e)}function A(e){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idNoDataReduction"));G(e);if(T.getTopN()){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idTopN"))}}function k(e){var t=e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idTopN")?true:false;e.byId("idNumberOfRecordsLabel").setVisible(t);e.byId("idNumberOfRecordsValue").setVisible(t);if(t){v.addField("idNumberOfRecordsValue")}else{v.removeField("idNumberOfRecordsValue")}}function K(t){if(T.getTopN()){b.instantiateStepSortData();if(T.getTopN().orderby.length===0){t.getView().fireEvent(e.events.step.SETTOPNPROPERTIES);var i=y.createMessageObject({code:"11523"});y.putMessage(i)}}else{b.destroySortData()}}function G(e){var t=T.getSelectProperties().length!==0?true:false;e.byId("idDataReductionRadioGroup").setEnabled(t)}function q(t){var i=T.getFilterProperties().length!==0?true:false;t.getView().fireEvent(e.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{bShowFilterMappingLayout:i})}function H(e){if(i.checkIsNotNullOrUndefinedOrBlank(T.getFilterMappingKeepSource())){e.byId("idFilterKeepSourceCheckBox").setSelected(T.getFilterMappingKeepSource())}}function j(e,t,i,n){var r=[];if(t.length!==0){i.setBusy(true)}t.forEach(function(e){var o={};o.navTargetKey=e.getId();S(e.getId()).then(function(e){o.navTargetName=e;r.push(o);if(r.length===t.length){var d=a.prepareModel(r,r.length);i.setModel(d);i.setSelectedKeys(n);i.setBusy(false)}})})}function W(e){var t=I.getNavigationTargets();var i=T.getNavigationTargets();var a=t.filter(function(e){return e.isStepSpecific()});j(e,a,e.byId("idStepSpecificCombo"),i)}function Y(e){var t=I.getNavigationTargets();var i=t.filter(function(e){return e.isGlobal()});var a=i.map(function(e){return e.getId()});j(e,i,e.byId("idGlobalCombo"),a)}return s.extend("sap.apf.modeler.ui.controller.step",{onInit:function(){var e=this,i;var a=e.getView().getViewData();y=a.oCoreApi;u=y.getText;p=a.oParams;c=a.oConfigurationHandler;f=c.getTextPool();I=a.oConfigurationEditor;S=a.getNavigationTargetName;v=new n(e.getView());E(e);F(e);m=new(a.StepPropertyMetadataHandler||r)(y,T);b=new t(e.getView(),T,m,u);P(e);e.setDetailData();i=e.byId("idStepTitle").getValue().trim();if(i===""){i="< "+u("newStep")+" >"}R(e,i);v.addFields(["idStepTitle","idCategorySelect"])},setDetailData:function(){var e=this;L(e);M(e);B(e);e.setDataReductionSection();O(e);q(e);H(e);W(e);Y(e)},onAfterRendering:function(){var e=this;if(e.byId("idStepTitle").getValue().length===0){e.byId("idStepTitle").focus()}},updateSubViewInstancesOnReset:function(t){var i=this;I=t;T=I.getStep(T.getId());i.getView().fireEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:I,oParentObject:T})},setDataReductionSection:function(){var e=this;A(e);U(e);K(e)},handleChangeForStepTitle:function(){var e=this;var t=I.getCategoriesForStep(T.getId());var a=e.byId("idStepTitle").getValue().trim();if(i.checkIsNotNullOrUndefinedOrBlank(a)){f.setTextAsPromise(a,V).done(function(i){T.setTitleId(i);if(t.length>1){e.getView().getViewData().updateTree()}else{w(e,a)}C(e,a);I.setIsUnsaved()})}else{I.setIsUnsaved()}},handleSuggestionsForStepTitle:function(e){var t=new o.SuggestionTextHandler(f);t.manageSuggestionTexts(e,V)},handleChangeForStepLongTitle:function(){var e=this;var t=e.byId("idStepLongTitle").getValue().trim();if(i.checkIsNotNullOrUndefined(t)){f.setTextAsPromise(t,N).done(function(e){T.setLongTitleId(e);I.setIsUnsaved()})}else{I.setIsUnsaved()}},handleSuggestionsForStepLongTitle:function(e){var t=new o.SuggestionTextHandler(f);t.manageSuggestionTexts(e,N)},handleChangeForCategory:function(){var e=this;var t=T.getId();var i=p.arguments.categoryId;var a=I.getCategoriesForStep(T.getId());var n=e.byId("idCategorySelect").getSelectedKeys();var r=n.indexOf(i);var o=[];var d=[];var s,l;for(s=0;s<a.length;s++){var g=false;for(l=0;l<n.length;l++){if(a[s]===n[l]){g=true;break}}if(!g){d.push(a[s])}}if(n.length!==0){n.forEach(function(e){I.addCategoryStepAssignment(e,t);var a={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:p.arguments.configId,categoryId:e}}};if(e!==i){o.push(a)}});a.forEach(function(e){if(n.indexOf(e)===-1){I.removeCategoryStepAssignment(e,T.getId())}});if(d.length!==0){d.forEach(function(e){var a={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:p.arguments.configId,categoryId:e}},removeStep:true};if(r===-1&&e===i){var d={arguments:{appId:p.arguments.appId,configId:p.arguments.configId,categoryId:n[0],stepId:t}};a.categoryChangeContext=d;a.changeCategory=true}o.push(a)})}}if(o.length!==0){e.getView().getViewData().updateTree(o)}I.setIsUnsaved()},handleChangeForDataReductionType:function(){var e=this;if(e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idNoDataReduction")){T.resetTopN();e.setDataReductionSection()}else{b.instantiateStepSortData()}k(e);I.setIsUnsaved()},handleValidationForNumberOfRecords:function(e){var t=e.getSource();var i=t.getValue().trim();var a=i.indexOf("E")!==-1||i.indexOf("e")!==-1||i.indexOf(".")!==-1||i<=0||i>1e4?g.Error:g.None;t.setValueState(a);I.setIsUnsaved()},handleChangeForNoOfRecords:function(t){var a=this;var n=t.getSource().getValue().trim();if(t.getSource().getValueState()===g.Error){return}if(i.checkIsNotNullOrUndefinedOrBlank(n)){if(T.getTopN()===undefined){a.getView().fireEvent(e.events.step.SETTOPNPROPERTIES)}T.setTopNValue(n)}I.setIsUnsaved()},handleFilterMapKeepSource:function(){var e=this;var t=e.byId("idFilterKeepSourceCheckBox").getSelected();T.setFilterMappingKeepSource(t);I.setIsUnsaved()},handleChangeForStepSpecificNavTargets:function(){var e=this;var t=e.byId("idStepSpecificCombo").getSelectedKeys();var i=T.getNavigationTargets();i.forEach(function(e){if(t.indexOf(e)===-1){T.removeNavigationTarget(e)}});t.forEach(function(e){if(i.indexOf(e)===-1){T.addNavigationTarget(e)}});I.setIsUnsaved()},getValidationState:function(){var e=this;return v.getValidationState()&&e.byId("idStepRequestView").getController().getValidationState()&&e.byId("idStepFilterMappingView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idStepCornerTextView").destroy();e.byId("idStepRequestView").destroy();e.byId("idStepFilterMappingView").destroy()}})});
//# sourceMappingURL=step.controller.js.map