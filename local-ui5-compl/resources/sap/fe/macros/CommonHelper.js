/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/macros/filterBar/DefaultSemanticDateOperators","sap/fe/macros/filterBar/ExtendedSemanticDateOperators","sap/fe/macros/filterBar/SemanticDateOperators","sap/m/library","sap/ui/Device","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/enums/FieldEditMode","sap/ui/mdc/odata/v4/TypeMap","sap/ui/model/Context","sap/ui/model/odata/v4/AnnotationHelper"],function(t,e,n,i,r,o,a,s,c,l,u,f,g,d,p,h){"use strict";var m=r.isPropertyFilterable;var b=i.convertTypes;var $=e.ref;var P=e.pathInModel;var O=e.notEqual;var y=e.ifElse;var M=e.fn;var E=e.equal;var v=e.constant;var C=e.compileExpression;function D(t,e){return t.filter(function(t){return e.includes(t)})}function T(t){const e=d.getDataTypeClassName(t);const n=d.getBaseType(e,{},{});return f.getOperatorsForType(n)}const x=l.ValueColor;const N={getPathToKey:function(t){return t.getObject()},getParameterEditMode:function(t,e){const n=e.context.getModel(),i=e.context.getPath(),r=n.getObject(`${i}@`),o=r["@com.sap.vocabularies.Common.v1.FieldControl"],a=r["@Org.OData.Core.V1.Immutable"],s=r["@Org.OData.Core.V1.Computed"];let c=g.Editable;if(a||s){c=g.ReadOnly}else if(o){if(o.$EnumMember){if(o.$EnumMember==="com.sap.vocabularies.Common.v1.FieldControlType/ReadOnly"){c=g.ReadOnly}if(o.$EnumMember==="com.sap.vocabularies.Common.v1.FieldControlType/Inapplicable"||o.$EnumMember==="com.sap.vocabularies.Common.v1.FieldControlType/Hidden"){c=g.Disabled}}if(o.$Path){c="{= %{"+o.$Path+"} < 3 ? (%{"+o.$Path+"} === 0 ? '"+g.Disabled+"' : '"+g.ReadOnly+"') : '"+g.Editable+"'}"}}return c},getMetaPath:function(t,e){return e&&e.context&&e.context.getPath()||undefined},getMetaModelId:function(t,e){b(e.context.getModel());return e.context.getModel().getId()},isDesktop:function(){return u.system.desktop===true},getTargetCollectionPath:function(t,e){let n=t.getPath();if(t.getObject("$kind")==="EntitySet"||t.getObject("$ContainsTarget")===true){return n}const i=t.getModel();const r=i.isA("sap.ui.model.odata.v4.ODataMetaModel")?i:i.getMetaModel();n=r.getMetaPath(n);const o=n.split("/").filter(function(t){return!!t&&t!="$Type"});const a=`/${o[0]}`;if(o.length===1){return a}const s=e===undefined?o.slice(1).join("/$NavigationPropertyBinding/"):e;return`${a}/$NavigationPropertyBinding/${s}`},isPropertyFilterable:function(t,e){const n=t.getModel(),i=t.getPath(),r=N.getLocationForPropertyPath(n,i),o=i.replace(`${r}/`,"");if(e&&(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation")){return false}return m(n,r,o)},getLocationForPropertyPath:function(t,e){let n;let i=e.slice(0,e.lastIndexOf("/"));if(t.getObject(`${i}/$kind`)==="EntityContainer"){n=i.length+1;i=e.slice(n,e.indexOf("/",n))}return i},gotoActionParameter:function(t){const e=t.getPath(),i=t.getObject(`${e}/$Name`);return n.getParameterPath(e,i)},getEntitySetName:function(t,e){const n=t.getObject("/");for(const t in n){if(typeof n[t]==="object"&&n[t].$Type===e){return t}}return undefined},getActionPath:function(t,e,n,i){let r=t.getPath().split("/@")[0];n=!n?t.getObject(t.getPath()):n;if(n&&n.includes("(")){n=n.split("(")[0]}else if(t.getObject(r)){const e=t.getObject(r).$Type;const n=this.getEntitySetName(t.getModel(),e);if(n){r=`/${n}`}}else{return r}if(i){return t.getObject(`${r}/${n}@Org.OData.Core.V1.OperationAvailable`)}if(e){return`${r}/${n}`}else{return{sContextPath:r,sProperty:t.getObject(`${r}/${n}@Org.OData.Core.V1.OperationAvailable/$Path`),sBindingParameter:t.getObject(`${r}/${n}/@$ui5.overload/0/$Parameter/0/$Name`)}}},getNavigationContext:function(t){return h.getNavigationPath(t.getPath())},getNavigationPath:function(t,e){const n=t.startsWith("/");const i=t.split("/").filter(function(t){return!!t});if(n){i.shift()}if(!e){i.pop()}return i.join("/")},getActionContext:function(t){return N.getActionPath(t,true)},getPathToBoundActionOverload:function(t){const e=N.getActionPath(t,true);return`${e}/@$ui5.overload/0`},addSingleQuotes:function(t,e){if(e&&t){t=this.escapeSingleQuotes(t)}return`'${t}'`},escapeSingleQuotes:function(t){return t.replace(/[']/g,"\\'")},generateFunction:function(t){let e="";for(let t=0;t<(arguments.length<=1?0:arguments.length-1);t++){e+=t+1<1||arguments.length<=t+1?undefined:arguments[t+1];if(t<(arguments.length<=1?0:arguments.length-1)-1){e+=", "}}let n=`${t}()`;if(e){n=`${t}(${e})`}return n},getHeaderDataPointLinkVisibility:function(t,e){return C(y(v(e),E(P(`isHeaderDPLinkVisible/${t}`,"internal"),true),O(P(`isHeaderDPLinkVisible/${t}`,"internal"),true)))},objectToString:function(t){let e=Object.keys(t).length,n="";for(const i in t){let r=t[i];if(r&&typeof r==="object"){r=this.objectToString(r)}n+=`${i}: ${r}`;if(e>1){--e;n+=", "}}return`{ ${n}}`},removeEscapeCharacters:function(t){return t?t.replace(/\\?\\([{}])/g,"$1"):undefined},stringifyObject:function(e){if(!e||e==="{}"){return undefined}else{const n=JSON.parse(e);if(typeof n==="object"&&!Array.isArray(n)){const t={ui5object:true};Object.assign(t,n);return JSON.stringify(t)}else{const e=Array.isArray(n)?"Array":typeof n;t.error(`Unexpected object type in stringifyObject (${e}) - only works with object`);throw new Error("stringifyObject only works with objects!")}}},stringifyCustomData:function(t){const e={ui5object:true};e["customData"]=t instanceof p?t.getObject():t;return JSON.stringify(e)},parseCustomData:function(t){t=typeof t==="string"?JSON.parse(t):t;if(t&&t.hasOwnProperty("customData")){return t["customData"]}return t},getContextPath:function(t,e){const n=e&&e.context&&e.context.getPath();return n[n.length-1]==="/"?n.slice(0,-1):n},getSortConditions:function(t,e,n){if(e&&N._isPresentationVariantAnnotation(n)&&e.SortOrder){const n={sorters:[]};const i=t.getPath(0).split("@")[0];e.SortOrder.forEach(function(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};let r;const o={};if(e.DynamicProperty){r=t.getModel(0).getObject(i+e.DynamicProperty.$AnnotationPath)?.Name}else if(e.Property){r=e.Property.$PropertyPath}if(r){o.name=r;o.descending=!!e.Descending;n.sorters.push(o)}else{throw new Error("Please define the right path to the sort property")}});return JSON.stringify(n)}return undefined},_isPresentationVariantAnnotation:function(t){return t.includes(`@${"com.sap.vocabularies.UI.v1.PresentationVariant"}`)||t.includes(`@${"com.sap.vocabularies.UI.v1.SelectionPresentationVariant"}`)},createPresentationPathContext:function(t){const e=t.getPath().split("@")||[];const n=t.getModel();if(e.length&&e[e.length-1].includes("com.sap.vocabularies.UI.v1.SelectionPresentationVariant")){const e=t.getPath().split("/PresentationVariant")[0];return n.createBindingContext(`${e}@sapui.name`)}return n.createBindingContext(`${t.getPath()}@sapui.name`)},getPressHandlerForDataFieldForIBN:function(t,e,n){let i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(!t)return undefined;const r={navigationContexts:e?e:"${$source>/}.getBindingContext()"};if(t.RequiresContext&&!t.Inline&&n){const e=!i?"aApplicable":"aApplicableForContextMenu";const n=!i?"aNotApplicable":"aNotApplicableForContextMenu";r.applicableContexts=`\${internal>ibn/${t.SemanticObject}-${t.Action}/${e}/}`;r.notApplicableContexts=`\${internal>ibn/${t.SemanticObject}-${t.Action}/${n}/}`;r.label=this.addSingleQuotes(t.Label,true)}if(t.Mapping){r.semanticObjectMapping=this.addSingleQuotes(JSON.stringify(t.Mapping))}return this.generateFunction(n?"._intentBasedNavigation.navigateWithConfirmationDialog":"._intentBasedNavigation.navigate",this.addSingleQuotes(t.SemanticObject),this.addSingleQuotes(t.Action),this.objectToString(r),"${$source>/}")},getEntitySet:function(t){const e=t.getPath();return o.getEntitySetPath(e)},getCriticalityCalculationBinding:function(e,n,i,r,o,a,s,c){let l=x.Neutral;n=`%${n}`;i=i||-Infinity;r=r||i;o=o||r;c=c||Infinity;s=s||c;a=a||s;i=i&&(+i?+i:`%${i}`);r=r&&(+r?+r:`%${r}`);o=o&&(+o?+o:`%${o}`);a=a&&(+a?+a:`%${a}`);s=s&&(+s?+s:`%${s}`);c=c&&(+c?+c:`%${c}`);if(e.includes("Minimize")){l="{= "+n+" <= "+a+" ? '"+x.Good+"' : "+n+" <= "+s+" ? '"+x.Neutral+"' : "+"("+c+" && "+n+" <= "+c+") ? '"+x.Critical+"' : '"+x.Error+"' }"}else if(e.includes("Maximize")){l="{= "+n+" >= "+o+" ? '"+x.Good+"' : "+n+" >= "+r+" ? '"+x.Neutral+"' : "+"("+i+" && "+n+" >= "+i+") ? '"+x.Critical+"' : '"+x.Error+"' }"}else if(e.includes("Target")){l="{= ("+n+" <= "+a+" && "+n+" >= "+o+") ? '"+x.Good+"' : "+"(("+n+" >= "+r+" && "+n+" < "+o+") || ("+n+" > "+a+" && "+n+" <= "+s+")) ? '"+x.Neutral+"' : "+"(("+i+" && ("+n+" >= "+i+") && ("+n+" < "+r+")) || (("+n+" > "+s+") && "+c+" && ("+n+" <= "+c+"))) ? '"+x.Critical+"' : '"+x.Error+"' }"}else{t.warning("Case not supported, returning the default Value Neutral")}return l},getMeasureAttributeIndex:function(t,e){let n,i;if(e?.Measures?.length&&e?.Measures?.length>0){n=e.Measures;i=n[t].$PropertyPath}else if(e?.DynamicMeasures?.length&&e?.DynamicMeasures?.length>0){n=e.DynamicMeasures;i=n[t].$AnnotationPath}let r;const o=e.MeasureAttributes;let a=-1;const s=function(t,e,n){if(e){if(e.Measure&&e.Measure.$PropertyPath===t){a=n;return true}else if(e.DynamicMeasure&&e.DynamicMeasure.$AnnotationPath===t){a=n;return true}}return false};if(o){r=o.some(s.bind(null,i))}return r&&a>-1?a:-1},getMeasureAttribute:async function(e){const n=e.getModel(),i=e.getPath();return n.requestObject(i).then(function(e){const n=e.MeasureAttributes,r=N.getMeasureAttributeIndex(0,e);const o=r>-1&&n?.[r]&&n[r].DataPoint?`${i}/MeasureAttributes/${r}/`:undefined;if(o===undefined){t.warning("DataPoint missing for the measure")}return o?`${o}DataPoint/$AnnotationPath/`:o})},getMeasureAttributeForMeasure:function(e){const n=e.getModel(),i=e.getPath(),r=i.substring(0,i.lastIndexOf("Measure")),o=i.replace(/.*\//,"");const a=n.getObject(r);const s=a.MeasureAttributes,c=N.getMeasureAttributeIndex(o,a);const l=c>-1&&s[c]&&s[c].DataPoint?`${r}MeasureAttributes/${c}/`:undefined;if(l===undefined){t.warning("DataPoint missing for the measure")}return l?`${l}DataPoint/$AnnotationPath/`:l},isDraftParentEntityForContainment:function(t,e){if(t){if(e&&e.parentEntitySet&&e.parentEntitySet.sPath){const t=e.parentEntitySet.sPath;const n=e.parentEntitySet.oModel.getObject(`${t}@com.sap.vocabularies.Common.v1.DraftRoot`);const i=e.parentEntitySet.oModel.getObject(`${t}@com.sap.vocabularies.Common.v1.DraftNode`);if(n||i){return true}else{return false}}}return false},getDataFromTemplate:function(t){const e=t.getPath().split("/");const n=e[e.length-1];const i=`/${e.slice(1,-2).join("/")}/@`;const r=t.getObject(i);const o=r.Template;const a=o.split("}");const s=[];for(let t=0;t<a.length-1;t++){const e=a[t].split("{")[1].trim();s.push(e)}Object.keys(r.Data).forEach(function(t){if(t.startsWith("$")){delete r.Data[t]}});const c=Object.keys(r.Data).indexOf(n);return`/${e.slice(1,-2).join("/")}/Data/${s[c]}`},notLastIndex:function(t,e){const n=t.Template;const i=n.split("}");const r=[];let o=false;for(let t=0;t<i.length-1;t++){const e=i[t].split("{")[1].trim();r.push(e)}r.forEach(function(n){const i=r.length-1;if(t.Data[n]===e&&r.indexOf(n)<i){o=true}});return o},getDelimiter:function(t){return t.split("}")[1].split("{")[0].trim()},oMetaModel:undefined,setMetaModel:function(t){this.oMetaModel=t},getMetaModel:function(){return this.oMetaModel},getParameters:function(t,e){if(t){const t=e.context.getModel();const i=e.context.getPath();const r=n.getParameterInfo(t,i);if(r.parameterProperties){return Object.keys(r.parameterProperties)}}return[]},buildActionWrapper:function(t,e){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const i=[$("$event"),t.handlerModule,t.handlerMethod];if(e&&e.id){const t=!n?"${internal>selectedContexts}":"${internal>contextmenu/selectedContexts}";const e={contexts:$(t)};i.push(e)}return C(M("FPM.actionWrapper",i))},getHiddenPathExpression:function(t){if(t["@com.sap.vocabularies.UI.v1.Hidden"]!==null){const e=t["@com.sap.vocabularies.UI.v1.Hidden"];return typeof e==="object"?"{= !${"+e.$Path+"} }":!e}return true},getOperatorsForProperty:function(t,e,i,r,o,l){const u=n.getFilterRestrictionsByPath(e,i);const f=["EQ"];const g=["EQ","GE","LE","LT","GT","BT","NOTLE","NOTLT","NOTGE","NOTGT"];const d=["EQ","BT"];const p=["EQ","GE","LE","LT","GT","BT","NE","NOTBT","NOTLE","NOTLT","NOTGE","NOTGT"];const h=["Contains","NotContains","StartsWith","NotStartsWith","EndsWith","NotEndsWith"];const m=c.getBasicSemanticDateOperations();const b=o==="true"||o===true;let $=[];const P=l&&typeof l==="string"?JSON.parse(l).customData:l;if(i.getObject(`${e}/@com.sap.vocabularies.Common.v1.ResultContext`)===true){return f}if(P&&P.operatorConfiguration&&P.operatorConfiguration.length>0){$=c.getFilterOperations(P.operatorConfiguration,r)}else{$=a.getSemanticDateOperations(r)}const O=T(r);let y=O;if(b){const t=s.getSemanticDateOperations();y=[...m,...O,...t]}let M=[];if(u&&u.FilterAllowedExpressions&&u.FilterAllowedExpressions[t]){const e=n.getSpecificAllowedExpression(u.FilterAllowedExpressions[t]);switch(e){case"SingleValue":const t=a.getSingleValueDateOperations();const e=r==="Edm.Date"&&b?t:f;M=D(y,e);break;case"MultiValue":const n=[...f,"Empty","NotEmpty"];M=D(y,n);break;case"SingleRange":let i;if(b){if(r==="Edm.Date"){i=$}else if(r==="Edm.DateTimeOffset"){i=$}else{i=g}}else if(r==="Edm.DateTimeOffset"){i=d}else{i=g}const o=D(y,i);M=o;break;case"MultiRange":M=D(y,p);break;case"SearchExpression":M=D(y,h);break;case"MultiRangeOrSearchExpression":M=D(y,h.concat(p));break;default:break}}return M},getOperatorsForDateProperty:function(t){const e=T(t);const n=["EQ","GE","LE","LT","GT","BT","NE","NOTBT","NOTLE","NOTLT","NOTGE","NOTGT"];return D(e,n)}};N.getSortConditions.requiresIContext=true;return N},false);
//# sourceMappingURL=CommonHelper.js.map