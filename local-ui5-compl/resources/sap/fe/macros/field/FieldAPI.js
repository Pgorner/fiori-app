/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/macros/internal/field/FieldStructure","sap/fe/macros/internal/field/FieldStructureHelper","sap/m/MessageToast","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/mdc/enums/FieldEditMode","../MacroAPI","./FieldRuntimeHelper"],function(e,t,i,r,n,a,o,s,l,u,c,p){"use strict";var d,f,g,b,m,h,y,v,A,P,C,B,x,E,w,F,O,M,I,z,T,V,j,S,D,k,L,R,W,H,_,G,q,U,N,$,J,K,Q,X,Y,Z,ee,te,ie,re,ne,ae,oe,se,le,ue,ce,pe;var de=a.setUpField;var fe=r.Activity;var ge=t.xmlEventHandler;var be=t.property;var me=t.event;var he=t.defineUI5Class;var ye=t.association;var ve=t.aggregation;function Ae(e,t,i,r){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(r):void 0})}function Pe(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Ce(e,t)}function Ce(e,t){return Ce=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ce(e,t)}function Be(e,t,i,r,n){var a={};return Object.keys(r).forEach(function(e){a[e]=r[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce(function(i,r){return r(e,t,i)||i},a),n&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(n):void 0,a.initializer=void 0),void 0===a.initializer?(Object.defineProperty(e,t,a),null):a}function xe(e,t){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let Ee=(d=he("sap.fe.macros.field.FieldAPI",{returnTypes:["sap.fe.core.controls.FormElementWrapper"]}),f=be({type:"boolean"}),g=be({type:"boolean"}),b=be({type:"string"}),m=be({type:"string",expectedAnnotations:[],expectedTypes:["EntitySet","EntityType","Singleton","NavigationProperty","Property"]}),h=be({type:"boolean"}),y=be({type:"string",expectedTypes:["EntitySet","EntityType","Singleton","NavigationProperty"]}),v=me(),A=me(),P=me(),C=be({type:"boolean"}),B=ye({type:"string"}),x=ye({type:"string"}),E=be({type:"boolean"}),w=ve({type:"sap.fe.macros.field.FieldFormatOptions"}),F=ye({type:"string"}),O=be({type:"sap.ui.mdc.enums.FieldEditMode"}),M=be({type:"string"}),I=be({type:"string",bindable:true,isBindingInfo:true,required:false}),z=be({type:"string",bindable:true,isBindingInfo:true,required:false}),T=be({type:"sap.ui.core.TextAlign"}),V=be({type:"boolean"}),j=be({type:"string"}),S=be({type:"string"}),D=be({type:"object",isBindingInfo:true}),k=ge(),L=ge(),R=ge(),d(W=(H=function(t){function r(e,i){var r;r=t.call(this,e,i)||this;Ae(r,"editable",_,r);Ae(r,"readOnly",G,r);Ae(r,"id",q,r);Ae(r,"metaPath",U,r);Ae(r,"wrap",N,r);Ae(r,"contextPath",$,r);Ae(r,"change",J,r);Ae(r,"focusin",K,r);Ae(r,"liveChange",Q,r);Ae(r,"required",X,r);Ae(r,"idPrefix",Y,r);Ae(r,"vhIdPrefix",Z,r);Ae(r,"navigateAfterAction",ee,r);Ae(r,"formatOptions",te,r);Ae(r,"_flexId",ie,r);Ae(r,"editMode",re,r);Ae(r,"semanticObject",ne,r);Ae(r,"value",ae,r);Ae(r,"description",oe,r);Ae(r,"textAlign",se,r);Ae(r,"showErrorObjectStatus",le,r);Ae(r,"collaborationEnabled",ue,r);Ae(r,"mainPropertyRelativePath",ce,r);Ae(r,"customValueBinding",pe,r);r.focusHandlersAttached=false;return r}Pe(r,t);var a=r.prototype;a.getCollaborationBinding=function e(t){let r=t.getBindingContext().getBinding();if(!r.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=i.getTargetView(t);r=e.getBindingContext().getBinding()}return r};a.extractChangeEventDetails=function e(t){const i=t.getSource();const r=this.getController();const n=i&&i.getBindingContext();const a=n?n.isTransient():false;const o=t.getParameter("promise")||Promise.resolve();const s=t.getParameter("valid");const l=p.getFieldStateOnChange(t).state["validity"];const u=this?.customValueBinding;return{source:i,controller:r,isTransient:a,valueResolved:o,valid:s,fieldValidity:l,customValueBinding:u}};a.handleChange=function t(i){const{source:r,controller:n,isTransient:a,valueResolved:o,valid:s,fieldValidity:l,customValueBinding:u}=this.extractChangeEventDetails(i);if(u){let e;const t=r?.getModel(u.model);if(r.isA("sap.m.CheckBox")){e=i.getParameter("selected")}else{e=i.getParameter("value")}t?.setProperty(u.path,e);t?.updateBindings(true)}const c=n?p.getExtensionController(n):undefined;o.then(()=>{i.oSource=r;i.mParameters={valid:s??true};this?.fireEvent("change",{value:this.getValue(),isValid:s??true});if(!a){c?._sideEffects.handleFieldChange(i,!!l,o,true)}if(n){p.fetchRecommendations(r,n)}return}).catch(()=>{i.oSource=r;i.mParameters={valid:false};e.debug("Prerequisites on Field for the SideEffects and Recommendations have been rejected");this.fireEvent("change",{value:this.getValue(),isValid:s??false})});const d=o.then(async()=>new Promise(e=>{setTimeout(e,0)})).catch(()=>{});c?.editFlow.syncTask(d);if(a){return}c?._sideEffects.prepareDeferredSideEffectsForField(i,!!l,o);const f=n?.collaborativeDraft.isConnected();if(f&&l){const e=this.getCollaborationBinding(r);const t=[...(r.getBindingInfo("value")||r.getBindingInfo("selected"))?.parts||[],...r.getBindingInfo("additionalValue")?.parts||[]].filter(e=>e?.path!==undefined&&e.path.indexOf("@@")<0).map(function(e){return`${r.getBindingContext()?.getPath()}/${e.path}`});n?.collaborativeDraft.retainAsyncMessages(t);const i=()=>{if(e.hasPendingChanges()){e.attachEventOnce("patchCompleted",function(){n?.collaborativeDraft.send({action:fe.Change,content:t});n?.collaborativeDraft.releaseAsyncMessages(t)})}else{n?.collaborativeDraft.releaseAsyncMessages(t)}};if(r.isA("sap.ui.mdc.Field")||r.isA("sap.ui.mdc.MultiValueField")){o.then(()=>{i();return}).catch(()=>{i()})}else{i()}}};a.handleLiveChange=function e(t){this.fireEvent("liveChange")};a.onValidateFieldGroup=function e(t){const r=t.getSource(),n=i.getTargetView(r),a=n.getController();const o=p.getExtensionController(a);o._sideEffects.handleFieldGroupChange(t)};a.onBeforeRendering=function e(){const t=function(e){return e.isA(["sap.m.Button","sap.fe.macros.controls.FieldWrapper","sap.ui.mdc.Field","sap.fe.macros.controls.FileWrapper"])};const i=this.content;if(i&&t(i)&&i.addAriaLabelledBy){const e=this.getAriaLabelledBy();for(const t of e){const e=i.getAriaLabelledBy()||[];if(e.indexOf(t)===-1){i.addAriaLabelledBy(t)}}}};a.onAfterRendering=function e(){if(this.collaborationEnabled&&!this.focusHandlersAttached){this.content?.addEventDelegate({onfocusin:e=>{this.fireEvent("focusin",{relatedTarget:e.relatedTarget})}},this);this.focusHandlersAttached=true}};r.getControlInFieldWrapper=function e(t){if(t.isA("sap.fe.macros.controls.FieldWrapper")&&!t.isA("sap.fe.macros.controls.FileWrapper")){const e=t;const i=e.getEditMode()==="Display"?[e.getContentDisplay()]:e.getContentEdit();if(i.length>=1){return i[0]}}else{return t}};a.getValue=function e(){let t=r.getControlInFieldWrapper(this.content);if(this.collaborationEnabled&&t?.isA("sap.m.HBox")){t=t.getItems()[0]}if(t?.isA("sap.m.CheckBox")){return t.getSelected()}else if(t?.isA("sap.m.InputBase")){return t.getValue()}else if(t?.isA("sap.m.Link")){return t.getText()}else if(t?.isA("sap.m.Label")){return t.getText()}else if(t?.isA("sap.m.Text")){return t.getText(false)}else if(t?.isA("sap.m.ObjectStatus")){return t.getText()}else if(t?.isA("sap.m.ObjectIdentifier")){return t.getTitle()}else if(t?.isA("sap.ui.mdc.Field")){return t.getValue()}else if(t?.isA("sap.fe.macros.internal.DataPoint")||t?.isA("sap.fe.macros.contact.Email")||t?.isA("sap.fe.macros.contact.Contact")){return t.getValue()}else{throw new Error("getting value not yet implemented for this field type")}};a.getMainPropertyRelativePath=function e(){return this.mainPropertyRelativePath};a.setValue=function e(t){if(!this.content){return this}let i=r.getControlInFieldWrapper(this.content);if(this.collaborationEnabled&&i?.isA("sap.m.HBox")){i=i.getItems()[0]}if(i?.isA("sap.m.CheckBox")){i.setSelected(t)}else if(i?.isA("sap.m.InputBase")){i.setValue(t)}else if(i?.isA("sap.m.Text")){i.setText(t)}else if(i?.isA("sap.ui.mdc.Field")){i.setValue(t)}else{throw"setting value not yet implemented for this field type"}return this};a.getEnabled=function e(){let t=r.getControlInFieldWrapper(this.content);if(t!==null&&t!==undefined&&!t?.isA("sap.m.Text")){if(this.collaborationEnabled&&t.isA("sap.m.HBox")){t=t.getItems()[0]}if(t.isA("sap.m.VBox")){t=t.getItems()[0]}if(t.isA("sap.m.CheckBox")){return t.getProperty("enabled")}else if(t.isA("sap.m.InputBase")){return t.getProperty("enabled")}else if(t.isA("sap.m.Link")){return t.getProperty("enabled")}else if(t.isA("sap.m.Button")){return t.getProperty("enabled")}else if(t.isA("sap.m.ObjectStatus")){return t.getProperty("active")}else if(t.isA("sap.m.ObjectIdentifier")){return t.getProperty("titleActive")}else if(t.isA("sap.fe.core.controls.FormElementWrapper")){return true}else if(t.isA("sap.fe.macros.internal.DataPoint")){return t.getEnabled()}else if(t.isA("sap.fe.macros.contact.Email")){return t.getProperty("linkEnabled")}else if(t.isA("sap.fe.macros.contact.Contact")){return t.getEnabled()}else if(t.isA("sap.m.ExpandableText")){return true}else if(t.isA("sap.ui.mdc.Field")){const e=t.getEditMode();return e!==u.Disabled}else if(t.isA("sap.fe.macros.controls.FileWrapper")){return t.link?t.link.getProperty("enabled"):true}else if(t.isA("sap.fe.macros.controls.ConditionalWrapper")||t.isA("sap.fe.macros.controls.TextLink")){return true}else{return false}}else{return false}};a.setEnabled=function e(t){let i=r.getControlInFieldWrapper(this.content);if(this.collaborationEnabled&&i?.isA("sap.m.HBox")){i=i.getItems()[0]}if(i?.isA("sap.m.CheckBox")){return i.setProperty("enabled",t)}else if(i?.isA("sap.m.InputBase")){return i.setProperty("enabled",t)}else if(i?.isA("sap.m.Link")){return i.setProperty("enabled",t)}else if(i?.isA("sap.m.Button")){return i.setProperty("enabled",t)}else if(i?.isA("sap.m.ObjectStatus")){return i.setProperty("active",t)}else if(i?.isA("sap.m.ObjectIdentifier")){return i.setProperty("titleActive",t)}else if(i?.isA("sap.ui.mdc.Field")){let e;if(t){e=u.Editable}else{e=u.Disabled}i.setEditMode(e)}else if(i?.isA("sap.fe.macros.contact.Email")){i.setLinkEnabled(t);return i}else if(i?.isA("sap.fe.macros.internal.DataPoint")){i.setEnabled(t)}else{throw"setEnabled isn't implemented for this field type"}return this};a.addMessage=function e(t){const i=this.getMessageManager();const n=r.getControlInFieldWrapper(this.content);let a;if(n?.isA("sap.m.CheckBox")){a=n.getBinding("selected")?.getResolvedPath()}else if(n?.isA("sap.m.InputBase")){a=n.getBinding("value")?.getResolvedPath()}else if(n?.isA("sap.ui.mdc.Field")){a=n.getBinding("value").getResolvedPath()}const o=new l({target:a,type:t.type,message:t.message,processor:n?.getModel(),description:t.description,persistent:t.persistent});i.addMessages(o);return o.getId()};a.removeMessage=function e(t){const i=this.getMessageManager();const r=i.getMessageModel().getData();const n=r.find(e=>e?.getId?.()===t);if(n){i.removeMessages(n)}};a.getMessageManager=function e(){return s};a.onMetadataAvailable=function e(){if(!this.content){this.content=this.createContent()}};a.createContent=function e(){const t=this.getMetaPathObject(this.metaPath,this.contextPath);const i=this._getOwner();const r=i?.getMetaModel();const a=r?.getMetaContext(this.contextPath??this.getOwnerContextPath());let s;if(t){s=r?.createBindingContext(t.getPath())}try{const e=this.getPropertyBag();e.onLiveChange=this.hasListeners("liveChange")?"Something":undefined;const t=de(e,{},i?.preprocessorContext,s,a);t.eventHandlers.change=this.handleChange.bind(this);t.eventHandlers.liveChange=this.handleLiveChange.bind(this);t.eventHandlers.validateFieldGroup=this.onValidateFieldGroup.bind(this);this.content=n.getFieldStructureTemplate(t)}catch(e){if(e instanceof Error){o.show(e.message+" in createContent of FieldAPI")}else{o.show("An unknown error occurred")}}return this.content};a.getPropertyBag=function e(){const t={};const i=this.getMetadata().getAllProperties();const r=this.getMetadata().getAllAggregations();for(const e in i){const i=this.getProperty(e);t[e]=i}for(const e in r){const i=this.getAggregation(e);if(Array.isArray(i)){const r=[];for(const e of i){if(e.isA("sap.fe.macros.controls.BuildingBlockObjectProperty")){r.push(e.getPropertyBag())}}t[e]=r}else if(i){if(i.isA("sap.fe.macros.controls.BuildingBlockObjectProperty")){t[e]=i.getPropertyBag()}else{t[e]=i.getId()}}}return t};return r}(c),_=Be(H.prototype,"editable",[f],{configurable:true,enumerable:true,writable:true,initializer:null}),G=Be(H.prototype,"readOnly",[g],{configurable:true,enumerable:true,writable:true,initializer:null}),q=Be(H.prototype,"id",[b],{configurable:true,enumerable:true,writable:true,initializer:null}),U=Be(H.prototype,"metaPath",[m],{configurable:true,enumerable:true,writable:true,initializer:null}),N=Be(H.prototype,"wrap",[h],{configurable:true,enumerable:true,writable:true,initializer:null}),$=Be(H.prototype,"contextPath",[y],{configurable:true,enumerable:true,writable:true,initializer:null}),J=Be(H.prototype,"change",[v],{configurable:true,enumerable:true,writable:true,initializer:null}),K=Be(H.prototype,"focusin",[A],{configurable:true,enumerable:true,writable:true,initializer:null}),Q=Be(H.prototype,"liveChange",[P],{configurable:true,enumerable:true,writable:true,initializer:null}),X=Be(H.prototype,"required",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),Y=Be(H.prototype,"idPrefix",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),Z=Be(H.prototype,"vhIdPrefix",[x],{configurable:true,enumerable:true,writable:true,initializer:null}),ee=Be(H.prototype,"navigateAfterAction",[E],{configurable:true,enumerable:true,writable:true,initializer:function(){return true}}),te=Be(H.prototype,"formatOptions",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),ie=Be(H.prototype,"_flexId",[F],{configurable:true,enumerable:true,writable:true,initializer:null}),re=Be(H.prototype,"editMode",[O],{configurable:true,enumerable:true,writable:true,initializer:null}),ne=Be(H.prototype,"semanticObject",[M],{configurable:true,enumerable:true,writable:true,initializer:null}),ae=Be(H.prototype,"value",[I],{configurable:true,enumerable:true,writable:true,initializer:null}),oe=Be(H.prototype,"description",[z],{configurable:true,enumerable:true,writable:true,initializer:null}),se=Be(H.prototype,"textAlign",[T],{configurable:true,enumerable:true,writable:true,initializer:null}),le=Be(H.prototype,"showErrorObjectStatus",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),ue=Be(H.prototype,"collaborationEnabled",[j],{configurable:true,enumerable:true,writable:true,initializer:null}),ce=Be(H.prototype,"mainPropertyRelativePath",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),pe=Be(H.prototype,"customValueBinding",[D],{configurable:true,enumerable:true,writable:true,initializer:null}),Be(H.prototype,"handleChange",[k],Object.getOwnPropertyDescriptor(H.prototype,"handleChange"),H.prototype),Be(H.prototype,"handleLiveChange",[L],Object.getOwnPropertyDescriptor(H.prototype,"handleLiveChange"),H.prototype),Be(H.prototype,"onValidateFieldGroup",[R],Object.getOwnPropertyDescriptor(H.prototype,"onValidateFieldGroup"),H.prototype),H))||W);return Ee},false);
//# sourceMappingURL=FieldAPI.js.map