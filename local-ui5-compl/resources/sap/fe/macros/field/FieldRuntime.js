/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/ObjectPath","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/macros/CommonHelper","sap/fe/macros/field/FieldAPI","sap/fe/macros/internal/helpers/Upload","sap/m/HBox","sap/m/Label","sap/m/MessageBox","sap/m/ResponsivePopover","sap/m/table/Util","sap/ui/core/Element","sap/ui/core/IconPool","sap/ui/core/Lib","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/util/openWindow","./FieldRuntimeHelper"],function(e,t,n,o,a,i,s,r,l,c,d,g,u,f,p,h,m,P,C,v,F,y,B){"use strict";var b=d.showTypeMismatchDialog;var D=d.showFileSizeExceedDialog;var T=d.setHeaderFields;var x=d.displayMessageForFailedUpload;var E=r.getResourceModel;var S=o.getActivityKeyFromPath;var M=o.Activity;function w(e){let t=e.getBindingContext().getBinding();if(!t.isA("sap.ui.model.odata.v4.ODataListBinding")){const o=n.getTargetView(e);t=o.getBindingContext().getBinding()}return t}const A={uploadPromises:{},creatingInactiveRow:false,onDataFieldWithNavigationPath:async function(t,o,i){if(o._routing){const e=t.getBindingContext();const r=n.getTargetView(t),l=e.getModel().getMetaModel();const c=r.getViewData();const d=s.getDraftRootPath(e)??e.getPath();let g=await o._routing.getHashForNavigation(e,i);const u=()=>{o.getAppComponent().getRouterProxy().navToHash(g,true,false,false,!s.isStickySessionSupported(e.getModel().getMetaModel()))};if(!g?.startsWith("/")){g=`/${g}`}const f=g.startsWith(d);if(c.converterType==="ObjectPage"&&!s.isStickySessionSupported(l)&&!f){a.processDataLossOrDraftDiscardConfirmation(u,Function.prototype,e,r.getController(),true,a.NavigationType.ForwardNavigation)}else{u()}}else{e.error("FieldRuntime: No routing listener controller extension found. Internal navigation aborted.","sap.fe.macros.field.FieldRuntime","onDataFieldWithNavigationPath")}},isDraftIndicatorVisible:function(e,t,n,o,a){if(o!==undefined&&n!==undefined&&(!o||n)&&!a){return e===t}else{return false}},onValidateFieldGroup:function(e){const t=e.getSource();const o=n.getTargetView(t),a=o.getController();const i=B.getExtensionController(a);i._sideEffects.handleFieldGroupChange(e)},handleChangeMultiValueField:function(t,n){const o=n.getSource(),a=o&&o.getBindingContext().isTransient(),i=n.getParameter("promise")||Promise.resolve(),s=n.getSource(),r=n.getParameter("valid"),l=B.getFieldStateOnChange(n).state["validity"],d=n.getSource(),g=d.getParent()?.getParent(),u=g?.customValueBinding;if(u){let e;const t=d?.getModel(u.model);if(s.isA("sap.m.CheckBox")){e=n.getParameter("selected")}else{e=n.getParameter("value")}t?.setProperty(u.path,e);t?.updateBindings(true)}const f=B.getExtensionController(t);i.then(function(){n.oSource=s;n.mParameters={valid:r};c.handleChange(n,t);if(!a){f._sideEffects.handleFieldChange(n,!!l,i,true)}B.fetchRecommendations(d,t);return}).catch(function(){n.oSource=s;n.mParameters={valid:false};e.debug("Prerequisites on Field for the SideEffects and Recommendations have been rejected");c.handleChange(n,t)});const p=i.then(async()=>new Promise(e=>{setTimeout(e,0)}));f.editFlow.syncTask(p);if(a){return}f._sideEffects.prepareDeferredSideEffectsForField(n,!!l,i);const h=t.collaborativeDraft.isConnected();if(h&&l){const e=w(d);const n=[...(d.getBindingInfo("value")||d.getBindingInfo("selected"))?.parts||[],...d.getBindingInfo("additionalValue")?.parts||[]].filter(e=>e?.path!==undefined&&e.path.indexOf("@@")<0).map(function(e){return`${d.getBindingContext()?.getPath()}/${e.path}`});t.collaborativeDraft.retainAsyncMessages(n);const a=()=>{if(e.hasPendingChanges()){e.attachEventOnce("patchCompleted",function(){t.collaborativeDraft.send({action:M.Change,content:n});t.collaborativeDraft.releaseAsyncMessages(n)})}else{t.collaborativeDraft.releaseAsyncMessages(n)}};if(o.isA("sap.ui.mdc.Field")||o.isA("sap.ui.mdc.MultiValueField")){i.then(()=>{a();return}).catch(()=>{a()})}else{a()}}},_sendCollaborationMessageForFileUploader(e,t){const o=n.getTargetView(e);const a=o.getController().collaborativeDraft;if(a.isConnected()){const n=e.getParent()?.getProperty("propertyPath");const o=`${e.getBindingContext()?.getPath()}/${n}`;a.send({action:t,content:o})}},handleOpenUploader:function(e){const t=e.getSource();A._sendCollaborationMessageForFileUploader(t,M.Lock)},handleCloseUploader:function(e){const t=e.getSource();A._sendCollaborationMessageForFileUploader(t,M.Unlock)},_fnFixHashQueryString:function(e){if(e?.includes("?")){e=e.split("?")[0]}return e},openExternalLink:function(e){const t=e.getSource();if(t.data("url")&&t.getProperty("text")!==""){y(t.data("url"),"_self")}},uploadStream:function(e,t){const n=t.getSource(),o=B.getExtensionController(e),a=n.getParent(),i=a.getUploadUrl();if(i!==""){a.setUIBusy(true);n.setUploadUrl(i);T(n);const e=new Promise((e,t)=>{this.uploadPromises=this.uploadPromises||{};this.uploadPromises[n.getId()]={resolve:e,reject:t};n.upload()});o.editFlow.syncTask(e)}else{f.error(E(e).getText("M_FIELD_FILEUPLOADER_ABORTED_TEXT"))}},handleUploadComplete:function(e,t,o,a){const i=Number(e.getParameter("status")),s=e.getSource(),r=s.getParent();r.setUIBusy(false);const l=s.getBindingContext();if(i===0||i>=400){const t=e.getParameter("responseRaw")||e.getParameter("response");x(s,t);this.uploadPromises[s.getId()].reject()}else{const n=e.getParameter("headers")?.etag;if(n){l?.setProperty("@odata.etag",n,null)}if(t?.path){l?.setProperty(t.path,s.getValue())}r.avatar?.refreshAvatarCacheBusting();this._callSideEffectsForStream(e,r,a);this.uploadPromises[s.getId()].resolve()}delete this.uploadPromises[s.getId()];const c=a.collaborativeDraft.isConnected();if(!c||!l){return}const d=[`${l.getPath()}/${o}`];if(t?.path){d.push(`${l.getPath()}/${t.path}`)}let g=l.getBinding();if(!g.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=n.getTargetView(s);g=e.getBindingContext().getBinding()}if(g.hasPendingChanges()){g.attachEventOnce("patchCompleted",()=>{a.collaborativeDraft.send({action:M.Change,content:d});a.collaborativeDraft.send({action:M.Unlock,content:d})})}else{a.collaborativeDraft.send({action:M.Change,content:d});a.collaborativeDraft.send({action:M.Unlock,content:d})}},removeStream:function(e,t,o,a){const i=e.getSource();const s=i.getParent();const r=s.getBindingContext();r.setProperty(o,null);r.setProperty(o,undefined,null);this._callSideEffectsForStream(e,s,a);const l=a.collaborativeDraft.isConnected();if(l){let e=r.getBinding();if(!e.isA("sap.ui.model.odata.v4.ODataListBinding")){const t=n.getTargetView(i);e=t.getBindingContext().getBinding()}const s=[`${r.getPath()}/${o}`];if(t?.path){s.push(`${r.getPath()}/${t.path}`)}a.collaborativeDraft.send({action:M.Lock,content:s});e.attachEventOnce("patchCompleted",function(){a.collaborativeDraft.send({action:M.Change,content:s});a.collaborativeDraft.send({action:M.Unlock,content:s})})}},_callSideEffectsForStream:function(e,t,n){const o=B.getExtensionController(n);if(t&&t.getBindingContext().isTransient()){return}if(t){e.oSource=t}o._sideEffects.handleFieldChange(e,B.getFieldStateOnChange(e).state["validity"])},getIconForMimeType:function(e){return P.getIconForMimeType(e)},retrieveTextFromValueList:async function(t,n,o){let a;let i;let s;if(t){i=l.getMetaModel();s=i.getObject(`${n}@sapui.name`);return i.requestValueListInfo(n,true).then(function(e){const n=e[e[""]?"":Object.keys(e)[0]];const i=n.$model;const r=i.getMetaModel();const l=n.Parameters.find(function(e){return e.LocalDataProperty&&e.LocalDataProperty.$PropertyPath===s});if(l&&!l.ValueListProperty){throw new Error(`Inconsistent value help annotation for ${s}`)}const c=r.getObject(`/${n.CollectionPath}/${l.ValueListProperty}@com.sap.vocabularies.Common.v1.Text`);if(c&&c.$Path){a=c.$Path;const e=new v({path:l.ValueListProperty,operator:"EQ",value1:t});const o=i.bindList(`/${n.CollectionPath}`,undefined,undefined,e,{$select:a});return o.requestContexts(0,2)}else{o="Value";return t}}).then(function(e){const n=a?e[0]?.getObject()[a]:"";switch(o){case"Description":return n;case"DescriptionValue":return C.getResourceBundleFor("sap.fe.core").getText("C_FORMAT_FOR_TEXT_ARRANGEMENT",[n,t]);case"ValueDescription":return C.getResourceBundleFor("sap.fe.core").getText("C_FORMAT_FOR_TEXT_ARRANGEMENT",[t,n]);default:return t}}).catch(function(t){const o=t;const a=o.status&&o.status===404?`Metadata not found (${o.status}) for value help of property ${n}`:o.message;e.error(a)})}return t},handleTypeMissmatch:function(e){const t=e.getSource();const n=e.getParameter("mimeType");const o=t.getMimeType();if(n){b(t,n,o)}},handleFileSizeExceed:function(e){const t=e.getSource();D(t,t.getMaximumFileSize().toFixed(3))},showCollaborationEditUser:function(e,t){const n=r.getResourceModel(t);let o=m.getElementById(`manageCollaborationDraft--editUser`);if(!o){o=new p("manageCollaborationDraft--editUser",{showHeader:false,placement:"Bottom"});o.addStyleClass("sapUiContentPadding");t.addDependent(o)}const a=e.getBinding("initials")?.getBindings().find(e=>e?.getPath()?.startsWith("/collaboration/activities")).getPath();const i=e.getBindingContext("internal")?.getObject(a);let s;if(i&&i.length>0){s=i.find(t=>t.key===S(e.getBindingContext().getPath()))}o.destroyContent();o.addContent(new u({text:n.getText("C_COLLABORATIONAVATAR_USER_EDIT_FIELD",[`${s?.name}`])}));o.openBy(e)},displayAggregateDetails:async function(e,t){const n=e.getSource();const o=i.getMdcTable(n);const a=n.getBindingContext();const s=a.getBinding();const r=a.getObject();const l=[];const c=a.getFilter();if(c){l.push(c)}const d=l.concat(s.getFilters("Application"),s.getFilters("Control"));const u=s.getAggregation();const f=u.aggregate[t].unit;const p={};p[f]={};const m={};m[t]={grandTotal:false,subtotals:false,unit:f};const P=n.getDependents()[0].clone();const C=new g({renderType:"Bare",justifyContent:"End",items:[P]});const v={group:p,aggregate:m};if(u.search){v.search=u.search}const y={path:s.getResolvedPath(),filters:d,parameters:{$$aggregation:v},sorter:new F(f,false)};const B=r["@$ui5.node.level"]===0;const b=await h.createOrUpdateMultiUnitPopover(`${o.getId()}-multiUnitPopover`,{control:o,grandTotal:B,itemsBindingInfo:y,listItemContentTemplate:C});o.addDependent(b);const D=()=>{o.removeDependent(b);b.detachEvent("afterClose",D);b.destroy()};b.attachEvent("afterClose",D);b.openBy(n)}};t.set("sap.fe.macros.field.FieldRuntime",A);return A},false);
//# sourceMappingURL=FieldRuntime.js.map