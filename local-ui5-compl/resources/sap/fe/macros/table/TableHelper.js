/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/helpers/BindingHelper","sap/fe/core/helpers/SizeHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/PropertyHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/CommonHelper","sap/fe/macros/formatters/TableFormatter","sap/fe/macros/internal/helpers/ActionHelper","sap/fe/macros/table/TableSizeHelper","sap/ui/mdc/enums/FieldEditMode"],function(e,t,n,a,i,o,r,l,s,c,u,d,f,p){"use strict";var g=s.getEditMode;var b=l.isImageURL;var v=l.hasText;var h=r.isPathAnnotationExpression;var m=r.isAnnotationOfType;var y=o.generate;var I=a.UI;var A=t.resolveBindingString;var F=t.ref;var $=t.pathInModel;var C=t.or;var T=t.ifElse;var O=t.formatResult;var S=t.fn;var x=t.equal;var U=t.constant;var D=t.compileExpression;var E=t.and;const N={_isStaticAction:function(e,t){let n;if(e){if(Array.isArray(e)){const a=this._getActionOverloadEntityType(t.toString());if(a){n=e.find(function(e){return e.$IsBound&&e.$Parameter[0].$Type===a})}else{n=e[0]}}else{n=e}}return!!n&&typeof n!=="string"&&n.$IsBound&&!!n.$Parameter[0].$isCollection},_getActionOverloadEntityType:function(e){if(e&&e.includes("(")){const t=e.split("(");return t[t.length-1].replaceAll(")","")}return undefined},_isActionOverloadOnDifferentType:function(e,t){const n=this._getActionOverloadEntityType(e);return!!n&&t!==n},getNavigationAvailableMap:function(e){const t={};e?.forEach(e=>{if("SemanticObject"in e){const n=`${e.SemanticObject}-${e.Action}`;if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"&&!e.Inline&&e.RequiresContext){if(e.NavigationAvailable!==undefined){t[n]=h(e.NavigationAvailable)?e.NavigationAvailable.path:e.NavigationAvailable}}}});return Object.keys(t).length>0?t:undefined},getUiLineItemObject:function(e,t){const n=t.resolvePath(e.getPath()).target;if(!n)return undefined;const a=t.resolvePath(e.getPath()).target.Visualizations;const i=a?a?.find(e=>e.value.indexOf("@"+"com.sap.vocabularies.UI.v1.LineItem")===0)?.$target:n;return i?.term==="com.sap.vocabularies.UI.v1.LineItem"?i:undefined},createBindingToLoadProperties:function(e){const t=e?.map(e=>$(e))??[];return D(O(t,"sap.fe.core.formatters.StandardFormatter#loadProperties"))},getColumnWidth:function(e,t,n,a,i,o,r){if(t.width){return t.width}if(e.enableAutoColumnWidth===true){let l;l=this.getColumnWidthForImage(i)||this.getColumnWidthForDataField(e,t,n,a,i,r)||undefined;if(l){return o?`${l}rem`:l}l=D(O([$("/editMode","ui"),$("tablePropertiesAvailable","internal"),t.name,o,this._shouldIncludeHeaderInColumnwidhCalculation(e,t),t.sortable??false,A(t.required??false,"boolean")],u.getColumnWidth));return l}return undefined},getColumnWidthForImage:function(e){let t=null;const n=e.targetObject?.Value?.$target?.annotations;const a=e.targetObject?.Value?.$target?.type;if(e.targetObject?.Value&&g(e.targetObject.Value?.$target,e,false,false,e.targetObject)===p.Display&&e.targetObject.Value?.$target){const i=v(e.targetObject.Value.$target);if(a==="Edm.Stream"&&!i&&n?.Core?.MediaType?.includes?.("image/")){t=6.2}}else if(n&&(b(e.targetObject?.Value?.$target)||n?.Core?.MediaType?.includes?.("image/"))){t=6.2}return t},_shouldIncludeHeaderInColumnwidhCalculation(e,t){return t.widthIncludingColumnHeader!==undefined?t.widthIncludingColumnHeader:e.widthIncludingColumnHeader},getColumnWidthForDataField:function(e,t,n,a,o,r){const l=o.targetObject?.annotations;const s=o.targetObject?.$Type;let c=null;if(s==="com.sap.vocabularies.UI.v1.DataFieldForAction"||s==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||s==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&!n.Target?.$AnnotationPath.includes(`@${"com.sap.vocabularies.UI.v1.FieldGroup"}`)){let s;s=i.getButtonWidth(a)||i.getButtonWidth(n?.Label?.toString())||i.getButtonWidth(l?.Label);const u=f.getWidthForDataFieldForAnnotation(o.targetObject,this._shouldIncludeHeaderInColumnwidhCalculation(e,t)).propertyWidth;if(u>s){c=u}else if(a||l&&(m(l,"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation")||m(l,"com.sap.vocabularies.UI.v1.DataFieldForAction"))){s+=1.8;c=s}c=c??this.getColumnWidthForChart(e,t,n,s,r)}return c},getColumnWidthForChart(e,t,n,a,o){let r,l=null;if(n.Target?.$AnnotationPath?.includes(`@${"com.sap.vocabularies.UI.v1.Chart"}`)){switch(this.getChartSize(e,t)){case"XS":r=4.4;break;case"S":r=4.6;break;case"M":r=5.5;break;case"L":r=6.9;break;default:r=5.3}a+=1.8;if(!this.getShowOnlyChart(e,t)&&(o?.title.length||o?.description.length)){const e=o.title.length>o.description.length?o.title:o.description;const t=i.getButtonWidth(e)+7;const n=t>a?t:a;l=n}else if(a>r){l=a}else{l=r}}return l},getMarginClass:function(e,t){let n="";if(t){if(e=="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){n="sapUiNoMarginBottom sapUiNoMarginTop"}}else if(e==="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){n="sapUiNoMarginTop"}else{n="sapUiTinyMarginBottom"}return n},getVBoxVisibility:function(e,t,n){let a=true;const i=[];if(n[`@${"com.sap.vocabularies.UI.v1.Hidden"}`]){return t}for(const n of e){const e=n[`@${"com.sap.vocabularies.UI.v1.Hidden"}`];if(e===undefined||e===false){i.push(false);continue}if(e===true){i.push(true);continue}if(e.$Path){i.push($(e.$Path));a=false;continue}if(typeof e==="object"){return t}}const o=U(i.length>0&&a!==true);const r=U(i.length>0&&!i.includes(false)&&a);return D(T(o,O(i,u.getVBoxVisibility),T(r,U(false),U(true))))},getElementStableId:function(e,t,n){if(!e){return undefined}const a=n.targetObject;let i;switch(a?.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":i=a.Target.value;break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":i=a;break;default:i=a.Value?.path??"";break}return y([e,t,i])},getColumnStableId:function(e,t){return N.getElementStableId(e,"C",t)},getFieldGroupLabelStableId:function(e,t){return N.getElementStableId(e,"FGLabel",t)},pressEventDataFieldForActionButton:function(e,t,n,a,i){let o=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;let r=arguments.length>6?arguments[6]:undefined;let l=arguments.length>7?arguments[7]:undefined;let s=arguments.length>8?arguments[8]:undefined;if(!t)return undefined;const c=t.Action,u=e.contextObjectPath.targetEntityType.fullyQualifiedName,d=typeof i!=="string"&&(this._isStaticAction(i,c)||this._isActionOverloadOnDifferentType(c.toString(),u)),f=!s?"aApplicable":"aApplicableForContextMenu",p=!s?"aNotApplicable":"aNotApplicableForContextMenu",g=!s?"":"contextmenu/",b=$(`${g}selectedContexts`,"internal"),v={contexts:!d?b:null,bStaticAction:d?d:undefined,entitySetName:n,applicableContexts:!d?$(`dynamicActions/${t.Action}/${f}/`,"internal"):null,notApplicableContexts:!d?$(`dynamicActions/${t.Action}/${p}/`,"internal"):null,isNavigable:o,enableAutoScroll:r,defaultValuesExtensionFunction:l,invocationGrouping:t?.InvocationGrouping==="UI.OperationGroupingType/ChangeSet"?"ChangeSet":"Isolated",controlId:e.id,operationAvailableMap:a,label:t.Label};return D(S("API.onActionPress",[F("$event"),F("$controller"),t.Action,v]))},isDataFieldForActionEnabled:function(e,t,n,a,i,o,r,l){if(!o)return false;const s=this._isStaticAction(a,t);if(this._isActionOverloadOnDifferentType(t.toString(),o.fullyQualifiedName)){const n=e&&JSON.parse(e.operationAvailableMap);if(n?.hasOwnProperty(t)){return!r?`{= \${internal>dynamicActions/${t}/bEnabled} }`:`{= \${internal>dynamicActions/${t}/bEnabledForContextMenu} }`}return true}if(!n||s){return true}const c=l?d.getNumberOfContextsExpression("single",r):d.getNumberOfContextsExpression(i??"multiselect",r);let u="";const f=!r?`\${internal>dynamicActions/${t}/bEnabled}`:`\${internal>dynamicActions/${t}/bEnabledForContextMenu}`;u=`${c} && ${f}`;return`{= ${u}}`},isDataFieldForIBNEnabled:function(t,n,a,i,o){let r=null;if(h(i)){r=i.path}const l=t?.tableDefinition?.enableAnalytics;if(!a){const a=t.collection.getPath();const o=t.collection.getModel();if(i===false&&!l){e.warning("NavigationAvailable as false is incorrect usage");return false}else if(r&&!l&&h(n?.NavigationAvailable)&&o.getObject(a+"/$Partner")===n.NavigationAvailable.path.split("/")[0]){return`{= \${${r.substring(r.indexOf("/")+1,r.length)}}}`}return true}let s="",c,u;if(i===true||l){s=!(o??false)?"%{internal>numberOfSelectedContexts} >= 1":"%{internal>contextmenu/numberOfSelectedContexts} >= 1"}else if(i===false){e.warning("NavigationAvailable as false is incorrect usage");return false}else{c=!(o??false)?"%{internal>numberOfSelectedContexts} >= 1":"%{internal>contextmenu/numberOfSelectedContexts} >= 1";u=!(o??false)?`\${internal>ibn/${n.SemanticObject}-${n.Action}/bEnabled}`:`\${internal>ibn/${n.SemanticObject}-${n.Action}/bEnabledForContextMenu}`;s=c+" && "+u}return`{= ${s}}`},getIBNData:function(e){if(e){const t={semanticObject:c.addSingleQuotes(e.semanticObject),action:c.addSingleQuotes(e.action)};return c.objectToString(t)}},buildExpressionForMultiValueFieldReadOnly:function(e){return D(T(C(e.readOnly===true,E(I.IsInactive,e.creationMode.name==="InlineCreationRows")),U(true),x(e.fieldMode,"nowrapper")))},setHeaderLabelVisibility:function(e,t){if(!t){if(e.$Type?.includes("DataFieldForAction")&&e.Inline){return false}if(e.$Type?.includes("DataFieldForIntentBasedNavigation")&&e.Inline){return false}return true}return t.some(function(e){if((e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation")&&e[`@${"com.sap.vocabularies.UI.v1.Hidden"}`]!==true){return true}})},getTextOnActionField:function(e,t){if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){return e.Label}if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&t.context.getObject("Target/$AnnotationPath").indexOf("@"+"com.sap.vocabularies.UI.v1.FieldGroup")>-1){const e="Target/$AnnotationPath/Data/";const n=[];for(const a in t.context.getObject(e)){if(t.context.getObject(`${e+a}/$Type`)==="com.sap.vocabularies.UI.v1.DataFieldForAction"||t.context.getObject(`${e+a}/$Type`)==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push(t.context.getObject(`${e+a}/Label`))}}if(n.length>1){return n.reduce(function(e,t){return e.length>t.length?e:t})}else{return n.length===0?undefined:n.toString()}}return undefined},_getResponsiveTableColumnSettings:function(e,t){if(e.tableType==="ResponsiveTable"){return t.settings}return undefined},getChartSize:function(e,t){const n=this._getResponsiveTableColumnSettings(e,t);if(n&&n.microChartSize){return n.microChartSize}return"XS"},getShowOnlyChart:function(e,t){const n=this._getResponsiveTableColumnSettings(e,t);if(n&&n.showMicroChartLabel){return!n.showMicroChartLabel}return true},getDelegate:function(e,t,n,a){let i;if(t){if(e.control.type==="TreeTable"){throw new Error("TreeTable not supported in Analytical ListPage")}i={name:"sap/fe/macros/table/delegates/ALPTableDelegate",payload:{collectionName:n}};if(e.enableAnalytics&&a){i.payload.filterOnActiveEntities=true}}else if(e.control.type==="TreeTable"){if(!e.control.hierarchyQualifier){throw new Error("A hierarchy qualifier is mandatory with a TreeTable")}i={name:"sap/fe/macros/table/delegates/TreeTableDelegate",payload:{hierarchyQualifier:e.control.hierarchyQualifier,initialExpansionLevel:e.annotation.initialExpansionLevel,filterOnActiveEntities:a,createInPlace:e.control.createInPlace===true}}}else{i={name:"sap/fe/macros/table/delegates/TableDelegate"};if(e.enableAnalytics&&a){i.payload={filterOnActiveEntities:a}}}return JSON.stringify(i)},enableFastCreationRow:async function(t,a,i,o,r){let l,s;if(t){try{await r;if(n.getIsEditable(t)&&!i.isDeleted()){l=o.bindList(a,i,[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});l.refreshInternal=function(){};s=l.create();t.setBindingContext(s);try{await s.created()}catch(t){e.trace("transient fast creation context deleted")}}}catch(t){e.error("Error while computing the final UI state",t)}}},isActionShownInContextMenu:function(e,t){const n=e.annotationPath?t.convertedTypes.resolvePath(e.annotationPath).target:undefined;switch(n?.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAction":{const e=n.ActionTarget;return e?.isBound===true&&!e.parameters[0].isCollection&&e.sourceEntityType===t.targetEntityType}case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":return n.RequiresContext?.valueOf()===true;default:if(e.type==="Default"){return e.requiresSelection===true}}return false}};N.getNavigationAvailableMap.requiresIContext=true;N.getTextOnActionField.requiresIContext=true;return N},false);
//# sourceMappingURL=TableHelper.js.map