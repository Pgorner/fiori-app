/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ResourceModelHelper","sap/m/MessageToast","../TableRuntime"],function(e,t,n,o,i,r,s,a){"use strict";var l={};var c=function(e){e["On"]="On";e["Between"]="Between";e["OnOrBetween"]="OnOrBetween";return e}(c||{});let u=function(){function u(){}l=u;var g=u.prototype;g.setupMixin=function e(t){};g._onCut=function t(n){let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;let i;if(!o){i=n.getSource().getParent()}else{const e=n.getSource().getParent();i=e.getParent()?.getParent()}const l=i.getBindingContext("internal");const c=this.getSelectedContexts();if(c.length>1){e.error("Multi cutting is not supported");return}l.setProperty("pastableContexts",c);s.show(r.getResourceModel(i).getText("M_CUT_READY"));if(!o||l.getProperty("numberOfSelectedContexts")>0){a.clearSelection(i);i.fireSelectionChange()}const u=!o?"cutableContexts":"contextmenu/cutableContexts";l.setProperty(u,[])};g._onDragEnterDocument=function e(t){const n=t.getParameter("dragSource");if(this.getContent().getRowBinding()!==n.getBinding()){t.preventDefault();return}const o=t.getParameter("bindingContext");if(n.isAncestorOf(o)){t.preventDefault();return}let r=false;let s=false;const a=this.getTableDefinition();const l=a.control.isMoveToPositionAllowed;const u=l?i.getCustomFunction(l.moduleName,l.methodName,t.getSource().getParent()):undefined;if(o===this.getContent().getBindingContext()){s=!this.safeIsMoveAllowed(u,n,null);r=true}else{s=!this.safeIsMoveAllowed(u,n,o);r=a.annotation.allowDropBetweenNodes!==true;if(Math.abs(o.getIndex()-n.getIndex())===1&&!(o.getIndex()===0&&t.getParameter("dropPosition")==="Before")&&!(o.getIndex()===this.getContent().getRowBinding().getLength()-1&&t.getParameter("dropPosition")==="After")){r=true}if(!r&&!a.annotation.changeSiblingForRootsSupported&&o.getProperty("@$ui5.node.level")===1){r=true}if(u&&!r){r=!this.isDropBetweenAllowedForDrag(u,n,o)}}let g=c.OnOrBetween;if(r&&s){t.preventDefault();return}if(r){g=c.On}else if(s){g=c.Between}t.getSource().setDropPosition(g)};g._onDragStartDocument=function e(t){const n=t.getParameter("bindingContext");const o=this.getTableDefinition().annotation.updatablePropertyPath;let r=!!o&&!n.getProperty(o);if(!r&&!n.getBinding().isRelative()){r=n.getProperty("HasDraftEntity")===true}const s=this.getTableDefinition().control.isNodeMovable;try{if(s&&!r){r=i.getCustomFunction(s.moduleName,s.methodName,t.getSource())(n)===false}}catch(e){r=false}if(r){t.preventDefault()}};g._onDropDocument=async function e(t){n.lock(this.getContent());try{const e=t.getParameter("bindingContext");let n;if(e===this.getContent().getBindingContext()){n={position:c.On,parentContext:null}}else if(t.getParameter("dropPosition")===c.On){n={position:c.On,parentContext:e}}else{let o;let i;if(t.getParameter("dropPosition")==="After"){o=e;i=this.getContextAfter(e)}else{o=this.getContextBefore(e);i=e}n={position:c.Between,contextAfter:i,contextBefore:o}}await Promise.all([this.dropContext(t.getParameter("dragSource"),n),this.requestSideEffectsForChangeNextSiblingAction()])}catch(e){s.show(this.getTranslatedText("M_TABLEDROP_FAILED",[e.message??""]))}finally{n.unlock(this.getContent())}};g._onCollapseExpandNode=async function e(t,n){const o=this.getSelectedContexts();if(n){const e=o.map(async e=>{if(e.isExpanded()!==undefined){if(e.isExpanded()===true){await e.collapse()}return e.expand(Number.MAX_SAFE_INTEGER)}});await Promise.all(e)}else{await Promise.all(o.map(async e=>{if(e.isExpanded()===true){return e.collapse(true)}}))}};g._onMoveUpDown=async function e(t,n){let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const i=this.getSelectedContexts();if(i.length!==1){return}const r=i[0];const s=await r.requestParent();let a=false;let l=null;if(n){const e=await r.requestSibling(-1);if(e){l=r.move({nextSibling:e,parent:s});a=true}}else{const e=await r.requestSibling(1);if(e){l=e.move({nextSibling:r,parent:s});a=true}}await Promise.all([l,this.requestSideEffectsForChangeNextSiblingAction()]);const c=r.getIndex();if(a&&c!==undefined&&c>=0){const e=this.getContent();if(!o){e.scrollToIndex(c)}else{e.focusRow(c)}}};g.requestSideEffectsForChangeNextSiblingAction=async function e(){const n=this.getContent().data("metaPath");const i=this.getContent().getBindingContext();const r=i.getModel(),s=r.getMetaModel();const a=s.getContext(n);const l=o.convertMetaModelContext(a);const c=l.targetType??l.entityType;const u=c.annotations.Hierarchy?.[`RecursiveHierarchyActions#${this.getTableDefinition().control.hierarchyQualifier??""}`]?.ChangeNextSiblingAction;if(u){const e=t.getAppComponent(this.getContent());const n=e.getSideEffectsService();const o=n.getODataActionSideEffects(u,i);if(o){await n.requestSideEffectsForODataAction(o,i)}}};g.safeIsMoveAllowed=function t(n,o,i){if(!n){return true}let r=true;try{r=n(o,i)===true}catch(t){e.error("Cannot execute function related to isMoveToPositionAllowed",t);r=true}return r};g.isDropBetweenAllowedForDrag=function e(t,n,o){let i=true;const r=this.getContextBefore(o);const s=r===null?null:r.getParent();const a=this.getDropBetweenParameters(r,s,o,o.getParent());const l=this.getContextAfter(o);const c=l===null?null:l.getParent();const u=this.getDropBetweenParameters(o,o.getParent(),l,c);if(a!==undefined&&u!==undefined){if(a.parent===u.parent){i=this.safeIsMoveAllowed(t,n,a.parent)}else{i=this.safeIsMoveAllowed(t,n,a.parent)||this.safeIsMoveAllowed(t,n,u.parent)}}return i};g.getContextBefore=function e(t){const n=t.getIndex();if(n===undefined){throw new Error("Unexpected error")}const o=t.getBinding();return n===0?null:o.getAllCurrentContexts().find(e=>e.getIndex()===n-1)??null};g.getContextAfter=function e(t){const n=t.getIndex();if(n===undefined){throw new Error("Unexpected error")}const o=t.getBinding();return o.getAllCurrentContexts().find(e=>e.getIndex()===n+1)??null};g.getDropBetweenParameters=function e(t,n,o,i){if(t===null){return{parent:null,nextSibling:o}}else if(o===null){return n!==undefined?{parent:n,nextSibling:null}:undefined}else if(i===t){return{parent:t,nextSibling:o}}else if(n===undefined||i===undefined){return undefined}else if(n===i){return{parent:n,nextSibling:o}}else{return{parent:n,nextSibling:null}}};g.dropContext=async function e(t,n){const o=this.getTableDefinition().control.isMoveToPositionAllowed;const r=o?i.getCustomFunction(o.moduleName,o.methodName,this.getContent()):undefined;const a=this.getContent().getBindingContext("internal");const l=a.getProperty("isSorted")===true;const u=async(e,n)=>{if(this.safeIsMoveAllowed(r,t,e)){return t.move({parent:e,nextSibling:l?undefined:n})}else{s.show(this.getTranslatedText("M_TABLE_DROP_NOT_ALLOWED"))}};if(n.position===c.On){return u(n.parentContext)}else{const[e,t]=await Promise.all([n.contextBefore?.requestParent()??null,n.contextAfter?.requestParent()??null]);const o=this.getDropBetweenParameters(n.contextBefore,e,n.contextAfter,t);return u(o.parent,o.nextSibling)}};return u}();l=u;return l},false);
//# sourceMappingURL=TableHierarchy.js.map