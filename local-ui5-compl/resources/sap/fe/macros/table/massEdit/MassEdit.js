/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/controls/Any","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/annotations/DataField","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/FieldControlHelper","sap/fe/core/templating/PropertyHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/field/FieldTemplating","sap/m/MessageBox","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/mdc/enums/FieldEditMode","sap/ui/model/BindingMode","./MassEditDialog","./library"],function(e,t,n,i,o,s,a,r,l,c,d,g,u,p,f,h,y,E,m,T,M,x){"use strict";var _={};var C=x.SpecificSelectKeys;var P=f.setEditStyleProperties;var I=f.getTextBinding;var A=p.isVisible;var b=p.isMultiValueField;var F=p.getRequiredExpression;var S=p.getEditMode;var D=u.hasValueHelp;var v=u.getAssociatedUnitPropertyPath;var O=u.getAssociatedUnitProperty;var B=u.getAssociatedTextPropertyPath;var R=g.isReadOnlyExpression;var w=d.getDisplayMode;var L=c.getRelativePaths;var N=c.getContextRelativeTargetObjectPath;var V=c.enhanceDataModelPath;var k=l.isProperty;var U=a.isDataFieldTypes;var j=s.getInvolvedDataModelObjects;var G=s.convertMetaModelContext;var H=n.pathInModel;var q=n.getExpressionFromAnnotation;var K=n.constant;var $=n.compileExpression;let X=function(){function n(e){this.fieldProperties=[];const t=e.table.getParent().getTableDefinition().annotation.collection,n=e.table.getModel().getMetaModel();this.table=e.table;this.onContextMenu=e.onContextMenu;this.onDialogClose=e.onClose;this.view=i.getTargetView(this.table);this.contexts=this.fetchContextsForEdit();this.isAdaptation=i.getAppComponent(this.table).isAdaptationMode();this.headerInfo=j(n.getContext(t)).targetEntityType.annotations.UI?.HeaderInfo}_=n;var s=n.prototype;s.open=async function t(){try{const e=y.getOwnerComponentFor(this.view);const t=this.table.getBindingContext("internal"),n=!this.onContextMenu?"numberOfSelectedContexts":"contextmenu/numberOfSelectedContexts",i=t.getProperty(n)||0;this.fieldProperties=await this.getFieldsPropertiesFromInfo(this.getFieldsInfo());if(!this.isAdaptation){if(!this.fieldProperties.some(e=>e.visible)){this.noFieldInformation();return}if(this.contexts.length!==i){this.contexts=await this.confirmSelection(this.contexts,i);if(!this.contexts.length){this.onDialogClose?.();return}}}await e.runAsOwner(async()=>{this.massEditDialog=new M({table:this.table,contexts:this.contexts,fieldProperties:this.fieldProperties});const e=await this.massEditDialog.create();e.attachBeforeClose(()=>{this.onDialogClose?.()});e.open()})}catch(t){e.error("Mass Edit: Something went wrong in mass edit dialog creation.",t)}};s.noFieldInformation=function e(){const t=this.table.getParent().getTableDefinition().control.massEdit.visibleFields;const n=E.getResourceBundleFor("sap.fe.macros");let i="",o;if(t.length>0){i=n.getText("C_MASS_EDIT_NO_EDITABLE_FIELDS_WITH_MANIFEST",[this.getResourceText(this.headerInfo?.TypeName)??n.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME")]);o=`<ul>\n\t\t\t${this.fieldProperties.reduce((e,n)=>{if(t.includes(n.propertyInfo.relativePath)){e.push(`<li>${n.label}</li>`)}return e},[]).join("")} </ul>`}else{i=n.getText("C_MASS_EDIT_NO_EDITABLE_FIELDS_DEFAULT")}h.information(i,{details:o,onClose:()=>{this.onDialogClose?.()}})};s.confirmSelection=async function t(n,i){const o=E.getResourceBundleFor("sap.fe.macros");const s=E.getResourceBundleFor("sap.fe.core");const a=n.length;return new Promise(t=>{try{const e=this.table.getParent();const l=o.getText("C_MASS_EDIT_CONFIRM_BUTTON_TEXT"),c=s.getText("C_COMMON_OBJECT_PAGE_CANCEL"),d=this.table.getModel().getMetaModel(),g=this.getResourceText(this.headerInfo?.TypeName)??o.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME"),u=this.getResourceText(this.headerInfo?.TypeNamePlural)??o.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME_PLURAL"),p=r.isDraftSupported(d,this.table.data("targetCollectionPath"))&&e.readOnly?this.getMessageDetailForNonEditable(g,u):"";h.warning(o.getText("C_MASS_EDIT_CONFIRM_MESSAGE",[i-a,i,a,u]),{details:p,actions:[l,c],emphasizedAction:l,onClose:function(e){t(e===l?n:[])}})}catch(t){e.error(t)}})};s.getResourceText=function e(t){if(!t){return undefined}return i.getTranslatedTextFromExpBindingString($(q(t)),this.view)?.toLocaleLowerCase()};s.getMessageDetailForNonEditable=function e(t,n){const i=E.getResourceBundleFor("sap.fe.macros");return`<p><strong>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_HEADER")}</strong></p>\n\n\t\t\t<p>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON",[n])}</p>\n\n\t\t\t<ul>\n\t\t\t\t<li>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON_DRAFT",[t])}</li>\n\t\t\t\t<li>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON_NON_EDITABLE",[t])}</li>\n\t\t\t</ul>`};s.getEntityFieldsInfo=function e(){const t=this.table.getParent();const n=t.getTableDefinition().columns;const i=new Set(n.reduce((e,t)=>{if(t.type==="Annotation"){e.push(t.name)}return e},[]));return this.transformPathsToInfo(i)};s.getFieldsInfo=function e(){const t=this.table.getParent().getTableDefinition().control.massEdit;const n=t.visibleFields.length>0?new Set(t.visibleFields):new Set(this.table.getColumns().map(e=>e.getPropertyKey()));if(t.ignoredFields.length>0){for(const e of t.ignoredFields){n.delete(e)}}return this.transformPathsToInfo(n)};s.transformPathsToInfo=function e(t){return Array.from(t).reduce((e,t)=>{const n=this.getFieldInfo(t);if(n){e.push(n)}return e},[])};s.getFieldInfo=function e(t){const n=this.table.getParent().getTableDefinition().columns;const i=this.table.getModel().getMetaModel();const o=i.getMetaPath(this.table.data("metaPath"));const s=j(i.getContext(o));const a=n.find(e=>e.name===t&&e.type==="Annotation");if(a){const e=a.annotationPath;if(e&&t){const n=V(s,t);const o=G(i.getContext(e));const r=this.getCompliantProperty(n,o);if(r&&s.targetEntityType.entityProperties.includes(r))return{key:a.key,propertyDataModel:n,targetProperty:r,label:a.label??a.key,convertedAnnotation:o}}}return undefined};s.getCompliantProperty=function e(t,n){const i=t.targetObject;let o;if(k(i)){o=i;if(i.annotations.UI?.IsImageURL){return}}else if(U(n)&&!n.hasOwnProperty("Action")){o=n.Value.$target}else{return}const s=O(o);if(b(t)||D(o)&&o.annotations?.Common?.ValueListRelevantQualifiers||s&&D(s)&&s.annotations?.Common?.ValueListRelevantQualifiers){return}return o};s.isHiddenForContexts=function e(t){if(t==="true"){return false}else if(t==="false"){return true}const n=new o({anyBoolean:t});n.setModel(this.contexts[0].getModel());const i=!this.contexts.find(e=>{n.setBindingContext(e);return n.getBinding("anyBoolean").getExternalValue()});n.destroy();return i};s.fetchContextsForEdit=function e(){const t=this.table.getBindingContext("internal"),n=!this.onContextMenu?"updatableContexts":"contextmenu/updatableContexts";return t?.getProperty(n)??[]};s.getFieldProperties=function e(){return t(this.fieldProperties)};s.getFieldsPropertiesFromInfo=async function e(t){const n=[];const i=[];for(const e of t){const{targetProperty:t,propertyDataModel:o,convertedAnnotation:s}=e;const a=N(o);if(a){const r=v(t);const l=this.getInputType(s,o);if(l&&o.targetObject){const c=L(o);i.push({isVisible:$(A(s)),editMode:S(t,o,false,false,s,K(true))});const d={visible:true,label:e.label||t.annotations.Common?.Label||a,isFieldRequired:F(t,s,true,false,{},o),descriptionPath:B(o.targetObject),textBinding:I(o,{displayMode:w(t,o)}),readOnlyExpression:R(t,c),inputType:l,propertyInfo:{nullable:t.nullable!==false,key:e.key,relativePath:a,unitPropertyPath:r},selectItems:[]};n.push(d)}}}if(!this.isAdaptation){const e=[].concat(...n.map((e,t)=>[i[t].isVisible,i[t].editMode,e.textBinding,$(e.readOnlyExpression),e.isFieldRequired,$(H(e.propertyInfo.relativePath)),$(H(e.propertyInfo.unitPropertyPath))]));await this.getMissingData(e)}await Promise.all(n.map(async(e,t)=>{e.visible=this.isFieldVisible(i[t]);const n=!this.isAdaptation?await this.getRuntimeSelection(e):[];e.selectItems=[...this.getDefaultSelectOptions(e),...n]}));return n};s.generateFieldsProperties=async function e(){return this.getFieldsPropertiesFromInfo(this.getFieldsInfo())};s.generateEntityFieldsProperties=async function e(){return this.getFieldsPropertiesFromInfo(this.getEntityFieldsInfo())};s.getMissingData=async function e(t){let n=[];for(const e of this.contexts){const i=t.map(t=>{const n=new o({any:t});n.setModel(e.getModel());n.setBindingContext(e);return n});n=[...n,...i]}await Promise.all(n.map(async e=>{const t=e.getBinding("any");if(t){t.setBindingMode(T.OneTime);if(t.isA("sap.ui.model.CompositeBinding")){await Promise.all(t.getBindings().map(e=>e.requestValue?.()))}else{await(t.requestValue?.())}}}));for(const e of n){e.destroy()}};s.getRuntimeSelection=async function e(t){const n=new Set;const i=[];if(t.inputType==="CheckBox"){return[]}const s=new o({anyText:t.textBinding});s.setModel(this.contexts[0].getModel());for(const e of this.contexts){s.setBindingContext(e);const o=s.getBinding("anyText");if(o?.isA("sap.ui.model.CompositeBinding")){o.setBindingMode(T.OneTime);await Promise.all(o.getBindings().map(e=>e.requestValue?.()))}const a=s.getBinding("anyText")?.getExternalValue();if(a&&!n.has(a)){n.add(a);i.push({text:a,key:a,unitValue:t.propertyInfo.unitPropertyPath?e.getObject(t.propertyInfo.unitPropertyPath):"",propertyValue:e.getObject(t.propertyInfo.relativePath)})}}s.destroy();return i};s.getDefaultSelectOptions=function e(t){const n=E.getResourceBundleFor("sap.fe.macros");const i={text:n.getText("C_MASS_EDIT_COMBOBOX_KEEP_VALUES"),key:C.KeepKey};const o=[];o.push(i);if(t.inputType==="CheckBox"){o.push({text:n.getText("yes"),key:"true"},{text:n.getText("no"),key:"false"})}else{o.push({text:n.getText("C_MASS_EDIT_COMBOBOX_REPLACE_VALUES"),key:C.ReplaceKey});if(t.isFieldRequired!=="true"){o.push({text:n.getText("C_MASS_EDIT_COMBOBOX_CLEAR_VALUES"),key:C.ClearFieldValueKey})}}return o};s.getFieldEditable=function e(t){if(t===m.Editable){return true}else if(Object.keys(m).includes(t)){return false}else if(t){const e=new o({any:t});const n=this.contexts[0].getModel();e.setModel(n);const i=this.contexts.some(t=>{e.setBindingContext(t);return e.getBinding("any").getExternalValue()===m.Editable});e.destroy();return i}else{return true}};s.getInputType=function e(t,n){const i={};P(i,t,n,true);return i?.editStyle};s.isFieldVisible=function e(t){if(this.isAdaptation){const e=Object.keys(m).includes(t.editMode);const n=!e||e&&t.editMode===m.Editable;return n&&t.isVisible!=="false"}return this.getFieldEditable(t.editMode)&&!this.isHiddenForContexts(t.isVisible)};return n}();_=X;return _},false);
//# sourceMappingURL=MassEdit.js.map