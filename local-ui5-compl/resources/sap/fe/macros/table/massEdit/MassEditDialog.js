/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/ManifestSettings","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/Label","sap/m/MessageBox","sap/m/MessageStrip","sap/m/MessageToast","sap/ui/core/Lib","sap/ui/layout/form/Form","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/ui/layout/form/ResponsiveGridLayout","sap/ui/model/json/JSONModel","./MassEditField","./MassEditSideEffects","sap/fe/base/jsx-runtime/jsx","sap/fe/base/jsx-runtime/Fragment","sap/fe/base/jsx-runtime/jsxs"],function(e,t,s,n,i,o,a,r,l,d,h,c,g,u,f,p,m,C,E,M,x,S,b){"use strict";var _={};var T=n.OperationGroupingMode;let w=function(){function n(e){this.updatedProperties=new Set;this.dialog=undefined;this.table=e.table;this.contexts=e.contexts;this.isAdaptation=t.getAppComponent(this.table).isAdaptationMode();this.fieldProperties=e.fieldProperties;this.view=t.getTargetView(this.table);this.transientListBinding=this.generateListBinding();this.bindingContext=this.transientListBinding.create({},true);this.resourceBundle=g.getResourceBundleFor("sap.fe.macros");this.contextsOnError=[];this.fieldControls=[]}_=n;var w=n.prototype;w.generateListBinding=function e(){const t=this.table.getRowBinding();const s=this.table.getModel().bindList(t.getPath(),t.getContext(),[],[],{$$updateGroupId:"submitLater"});s.refreshInternal=()=>{};return s};w.create=async function e(){if(!this.dialog){const e=this.table.getHeader();const t=g.getResourceBundleFor("sap.fe.core");const s=this.view.getViewData().converterType==="ListReport"?this.resourceBundle.getText("C_MASS_EDIT_SAVE_BUTTON_TEXT"):t.getText("C_COMMON_DIALOG_OK");const n=await this.createContent();const o=x(r,{"dt:designtime":"sap/fe/macros/table/massEdit/designtime/MassEdit.designtime",id:i.generate([this.table.getId(),"MED_","Dialog"]),contentWidth:"27rem",class:"sapUiContentPadding",horizontalScrolling:"false",title:e?this.resourceBundle.getText("C_MASS_EDIT_DIALOG_TITLE_TYPENAME_PLURAL",[e,this.contexts.length.toString()]):this.resourceBundle.getText("C_MASS_EDIT_DIALOG_TITLE_WITHOUT_TYPENAME_PLURAL",[this.contexts.length.toString()]),content:n,escapeHandler:this.onClose.bind(this),beforeOpen:this.beforeOpen.bind(this),beginButton:x(a,{text:s,type:"Emphasized",press:this.onApply.bind(this)}),endButton:x(a,{text:t.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:this.onClose.bind(this)})});this.dialog=o;o.setModel(new C({isEditable:true}),"ui");o.bindElement({path:"/",model:"ui"});return o}return this.dialog};w.beforeOpen=function e(t){const s=t.getSource();s.setModel(this.table.getModel());s.setBindingContext(this.bindingContext);this.table.addDependent(s)};w.onClose=function e(){this.transientListBinding.destroy();if(this.dialog){this.dialog.close();this.dialog.destroy()}};w.manageMessage=async function e(){const n=g.getResourceBundleFor("sap.fe.core");const i=this.view.getController();const a=o.DraftStatus;const r=this.view.getBindingContext("internal");r?.setProperty("getBoundMessagesForMassEdit",true);await i.messageHandler.showMessages({onBeforeShowMessage:(e,n)=>{n.fnGetMessageSubtitle=s.setMessageSubtitle.bind({},this.table,this.contexts);if(!this.contextsOnError.length){if(this.updatedProperties.size>0){i.editFlow.setDraftStatus(a.Saved);if(this.view.getViewData().converterType==="ListReport"){c.show(this.resourceBundle.getText("C_MASS_EDIT_SUCCESS_TOAST"))}else{c.show(this.resourceBundle.getText("C_OBJECT_PAGE_MASS_EDIT_SUCCESS_TOAST"))}}else{c.show(this.resourceBundle.getText("C_MASS_EDIT_NO_CHANGE"))}}else if(this.contextsOnError.length<this.contexts.length){i.editFlow.setDraftStatus(a.Saved)}else if(this.contextsOnError.length===this.contexts.length){i.editFlow.setDraftStatus(a.Clear)}if(t.getIsEditable(i)&&!e.some(e=>!e.getTargets())){n.showMessageBox=false;n.showMessageDialog=false}return n}});if(!!this.contextsOnError.length&&this.contextsOnError.length<this.contexts.length){const e=n.getText("C_COMMON_DIALOG_OK");d.success(this.resourceBundle.getText("C_MASS_EDIT_CHANGES_WITH_ERROR",[this.contexts.length-this.contextsOnError.length,this.contexts.length]),{actions:[e],emphasizedAction:e})}r?.setProperty("getBoundMessagesForMassEdit",false)};w.saveChanges=async function t(s){const n=new M(this);const i=[];const o=this.table.getParent().getTableDefinition().control.massEdit;this.contexts.forEach((t,a)=>{for(const{control:r,values:l}of s.fieldControlReference){let s=false;if(!r.isReadOnlyOnContext(t)){const d=o.operationGroupingMode===T.ChangeSet?"$auto":`$auto.${a}`;for(const o in l){if(t.getProperty(o)!==l[o]){s=true;i.push(t.setProperty(o,l[o],d).then(()=>this.updatedProperties.add(o)).catch(s=>{this.contextsOnError.push(t);e.error("Mass Edit: Something went wrong in updating entries.",s)}));i.push(n.executeImmediateSideEffects(t,o,d))}}if(s){i.push(n.refreshDescription(r,t,d))}}}});await Promise.allSettled(i);if(this.updatedProperties.size){n.executeDeferredSideEffects(new Set(["genericField",...Array.from(this.updatedProperties)]))}};w.getFieldValuesInfos=function e(){const t={values:{},fieldControlReference:[]};for(const e of this.fieldControls){const s=e.getFieldValues();t.values={...t.values,...s};t.fieldControlReference.push({control:e,values:s})}return t};w.applyChanges=async function t(){this.view.getBindingContext("internal")?.setProperty("skipPatchHandlers",true);const s=this.getFieldValuesInfos();let n=false;try{n=await this.view.getController().editFlow.customMassEditSave({aContexts:this.contexts,oUpdateData:s.values})}catch(t){e.error("Mass Edit: Something went wrong in updating entries.",t)}if(!n){await this.saveChanges(s)}this.view.getBindingContext("internal")?.setProperty("skipPatchHandlers",false);return n};w.onApply=async function e(){if(this.fieldControls.some(e=>!e.isFieldValid())){return}if(!this.isAdaptation){s.removeBoundTransitionMessages();s.removeUnboundTransitionMessages();const e=await this.applyChanges();if(!e){this.manageMessage()}}this.onClose()};w.createContent=async function e(){const t=await this.createCustomContainer();return b(S,{children:[this.getAdaptationMessage(),x(u,{children:{layout:x(m,{labelSpanM:"12",labelSpanL:"12",labelSpanXL:"12"}),formContainers:b(S,{children:[t,x(f,{children:{formElements:this.createFormElements()}})]})}})]})};w.getAdaptationMessage=function e(){if(this.isAdaptation){return x(h,{text:this.resourceBundle.getText("C_MASS_EDIT_ADAPTATION_MODE")})}return undefined};w.createCustomContainer=async function e(){const t=this.table.getParent().getTableDefinition().control.massEdit;return t.customFragment?await this.view.getController().getExtensionAPI().loadFragment({id:"customMassEdit",name:t.customFragment,contextPath:this.transientListBinding.getModel().getMetaModel().getMetaPath(this.transientListBinding.getResolvedPath())}):undefined};w.createFormElements=function e(){return this.fieldProperties.map(this.createFormElement.bind(this))};w.createFormElement=function e(t){return x(p,{visible:t.visible,children:{label:x(l,{text:t.label,id:i.generate(["MED_",t.propertyInfo.key,"Label"])}),fields:this.createFields(t)}})};w.createFields=function e(t){const s=this.table.getModel().getMetaModel();const n=s.createBindingContext(s.getMetaPath(this.bindingContext.getPath()));const i=new E(t,n);this.fieldControls.push(i);return i.getControls()};return n}();_=w;return _},false);
//# sourceMappingURL=MassEditDialog.js.map