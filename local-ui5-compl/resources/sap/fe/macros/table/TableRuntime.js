/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/FPMHelper","sap/fe/core/library","sap/fe/macros/table/Utils","sap/ui/core/Element","sap/ui/core/Messaging","../field/FieldRuntimeHelper"],function(e,t,n,o,a,i,r,l,s,c,d,g){"use strict";const u=l.CreationMode;const f={displayTableSettings:function(e){const t=e.getSource().getParent(),o=c.getElementById(`${t.getId()}-settings`);n.fireButtonPress(o)},executeConditionalActionShortcut:function(e,t){const o=t.getParent();if(e!==u.CreationRow){const t=o.getActions().reduce(function(e,t){return e.concat(t.getAction())},[]).find(function(t){return t.getId().endsWith(e)});n.fireButtonPress(t)}else{const e=o.getAggregation("creationRow");if(e&&e.getApplyEnabled()&&e.getVisible()){e.fireApply()}}},setContexts:async function(t){const n=t.getSource();const a=n;o.lock(a);try{await f.setContextsAsync(a)}catch(t){e.error(t)}finally{o.unlock(a)}},setContextsAsync:async function(e){const n=e.getModel()?.getMetaModel();const o=e.getParent();if(!o||!n){return}const r=o.tableDefinition;const l=a.convertTypes(n).resolvePath(r.annotation.collection).target;const s=r.annotation.updatablePropertyPath;const c=e.data("actionsMultiselectDisabled")?.split(",")??[];const d=JSON.parse(r.operationAvailableMap||"{}");const g=e.data("navigationAvailableMap");const u=e.getSelectedContexts();const b=[];const p=e.data("displayModePropertyBinding")==="true"&&!!l?.annotations.Common?.DraftRoot;const C=[];const m={};const y={};const h=e.getBindingContext("internal");if(!h){return}i.updateDeleteInfoForSelectedContexts(h,u);const P=u.filter(function(e){return!e.isInactive()});const x=Object.assign(h.getObject()||{},{selectedContexts:P,selectedContextsIncludingInactive:u,numberOfSelectedContexts:P.length,dynamicActions:m,ibn:y,deleteEnabled:true,deletableContexts:b,unSavedContexts:[],lockedContexts:[],draftsWithNonDeletableActive:[],draftsWithDeletableActive:[],controlId:"",updatableContexts:C,pasteAuthorized:true,cutableContext:[],semanticKeyHasDraftIndicator:h.getProperty("semanticKeyHasDraftIndicator")?h.getProperty("semanticKeyHasDraftIndicator"):undefined});for(const e of P){const t=e.getObject();for(const e in t){if(e.indexOf("#")===0){let t=e;t=t.substring(1,t.length);x.dynamicActions[t]={enabled:true};h.setProperty("",x)}}if(this.isUpdatableContext(s,e,p)){C.push(e)}}if(!e.data("enableAnalytics")){f.setIntentBasedNavigationEnablement(h,g,P)}if(P.length>1){this.disableAction(c,m)}if(x){x["updatableContexts"]=C;x["controlId"]=e.getId();h.setProperty("",x)}if(P.length<=1&&r.control.createEnablement){const t=P.length?P[0]:null;this._updateCreateEnablement(h,r.control.createEnablement,e,t,r.control.nodeType)}this.updateCutPasteEnablement(x,e);this.updateMoveUpDownEnablement(x,e);return t.setActionEnablement(h,d,P,"table")},isUpdatableContext:function(e,t,n){const o=t.getObject();const a=e.length===0||!!t.getProperty(e);const i=!n||o.IsActiveEntity;if(a&&i){return true}return false},checkIfNodeIsMovable:function(t,n){const o=n.getParent().getTableDefinition().control.isNodeMovable;const a=o?r.getCustomFunction(o.moduleName,o.methodName,n):undefined;try{return a===undefined||a(t)}catch(t){e.warning(`Error in custom function for isNodeMovable: ${t}`);return true}},updateCutPasteEnablement:function(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const o=!t.getRowBinding().isRelative();const a=!n?e["updatableContexts"]:e.contextmenu["updatableContexts"];const i=a?.filter(e=>f.checkIfNodeIsMovable(e,t)&&(!o||e.getProperty("HasDraftEntity")!==true));if(!n){e["cutableContexts"]=i?.map(e=>e.getPath())}else{e.contextmenu["cutableContexts"]=i?.map(e=>e.getPath())}const l=t.getParent().getTableDefinition().control.isMoveToPositionAllowed;if(l&&e.numberOfSelectedContexts<=1){const n=e.pastableContexts?e.pastableContexts[0]:undefined;if(n&&!r.getCustomFunction(l.moduleName,l.methodName,t)(n,e.selectedContexts[0])){e.pasteAuthorized=false}}},updateMoveUpDownEnablement:function(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const o=!n?e:e.contextmenu;const a=o.selectedContexts;const i=t.getParent().getTableDefinition();const r=i.annotation.changeSiblingForRootsSupported;if(a.length!==1||i.control.type!=="TreeTable"||t.getBindingContext("internal")?.getProperty("isSorted")===true||a[0].getProperty("@$ui5.node.level")===1&&!r){o.singleContextMovableUp=false;o.singleContextMovableDown=false}else{const e=a[0];const n=t.getRowBinding().isRelative()||e.getProperty("HasDraftEntity")!==true;const i=e.isTransient()!==undefined;const r=f.checkIfNodeIsMovable(e,t);o.singleContextMovableUp=n&&r&&!i&&e.getSibling(-1)!==null;o.singleContextMovableDown=n&&r&&!i&&e.getSibling(1)!==null}},_updateCreateEnablement:function(e,t,n,o,a){let i=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;let l;if(a!==undefined){l=a.values.map(e=>e.value)}else{l=[undefined]}const s=r.getCustomFunction(t.moduleName,t.methodName,n);if(!s){return}const c=l.map(e=>{let t=false;try{t=!!(s(e,o)??true)}catch(e){t=true}return t});const d={};d["Create"]=c.some(e=>e);c.forEach((e,t)=>{d[`Create_${t}`]=e});const g=i?"contextmenu/":"";e.setProperty(g+"createEnablement",d)},clearSelection:function(e){e.clearSelection();const t=e.getBindingContext("internal");if(t){t.setProperty("deleteEnabled",false);t.setProperty("numberOfSelectedContexts",0);t.setProperty("selectedContexts",[]);t.setProperty("deletableContexts",[])}const n=e.getParent();if(n.tableDefinition.control.createEnablement){this._updateCreateEnablement(t,n.tableDefinition.control.createEnablement,e,null,n.tableDefinition.control.nodeType)}},disableAction:function(e,t){e.forEach(function(e){t[e]={bEnabled:false}})},onFieldChangeInCreationRow:function(e,t){const n=g.getFieldStateOnChange(e),o=n.field,a=o.getId();const i=o.getBindingContext("internal"),r=i.getProperty("creationRowFieldValidity"),l=Object.assign({},r);l[a]=n.state;i.setProperty("creationRowFieldValidity",l);if(t){const e=i.getProperty("creationRowCustomValidity"),t=Object.assign({},e);t[o.getBinding("value").getPath()]={fieldId:o.getId()};i.setProperty("creationRowCustomValidity",t);const n=`${o.getBindingContext()?.getPath()}/${o.getBindingPath("value")}`;d.getMessageModel().getData().forEach(function(e){if(e.getTargets()[0]===n){d.removeMessages(e)}})}},onTreeTableContextChanged:function(e,t){const n=e.getSource();const o=n;const a=o.getRowBinding();if(!a.getContext()){return}const i=a.getAggregation()??{};const r=s.getAllFilterInfo(o);i.expandTo=r.search?Number.MAX_SAFE_INTEGER:t;a.setAggregation(i)},onCreateMenuItemPress:async function(t,o,a){const i=r.getMdcTable(t.getSource());const l=i?.getParent();if(!l||!i){return}const s=l.tableDefinition.control.nodeType;if(!s){return}const c=n.getTargetView(l);const d={};d[s.propertyName]=s.values[o].value;const g={selectedContexts:a,creationMode:l.tableDefinition.annotation.create.mode,data:d,tableId:i?.getId()};if(g.creationMode===u.CreationDialog){g.creationDialogFields=s.values[o].creationDialogFields;if(!g.creationDialogFields||g.creationDialogFields.length===0){g.creationDialogFields=l.tableDefinition.control.creationDialogFields}if(!i.getRowBinding()){await i.rebind()}}c.getController().editFlow.createDocument(l.getRowBinding(),g).catch(t=>{e.error(`Failed to create new document: ${t}`)})},onCreateButtonPress:async function(t,o){const a=r.getMdcTable(t.getSource());const i=a?.getParent();if(!i||!a){return}const l={creationMode:i.tableDefinition.annotation.create.mode};switch(l.creationMode){case u.External:l.outbound=i.tableDefinition.annotation.create.outbound;break;case u.CreationRow:l.creationRow=t.getSource();l.createAtEnd=i.tableDefinition.control.createAtEnd??false;break;case u.NewPage:case u.Inline:case u.CreationDialog:l.createAtEnd=i.tableDefinition.control.createAtEnd??false;l.tableId=a?.getId();l.selectedContexts=o;break;case u.InlineCreationRows:break;default:return}if(l.creationMode===u.CreationDialog){l.creationDialogFields=i.tableDefinition.control.creationDialogFields;if(!a.getRowBinding()){await a.rebind()}}const s=n.getTargetView(i);if(l.creationMode===u.InlineCreationRows){s.getController().editFlow.createEmptyRowsAndFocus(a).catch(t=>{e.error(`Failed to create new empty row: ${t}`)})}else{s.getController().editFlow.createDocument(i.getRowBinding(),l).catch(t=>{e.error(`Failed to create new document: ${t}`)})}},setIntentBasedNavigationEnablement:function(e,t,n){let o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;for(const a in t){if(!o){e.setProperty(`ibn/${a}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]})}else{e.setProperty(`ibn/${a}`,{bEnabled:e.getProperty(`${e.getPath()}/ibn/${a}/bEnabled`),aApplicable:e.getProperty(`${e.getPath()}/ibn/${a}/aApplicable`),aNotApplicable:e.getProperty(`${e.getPath()}/ibn/${a}/aNotApplicable`),bEnabledForContextMenu:false,aApplicableForContextMenu:[],aNotApplicableForContextMenu:[]})}const i=[],r=[];const l=t[a];for(const t of n){if(t.getObject(l)){const n=!o?"bEnabled":"bEnabledForContextMenu";e.getModel().setProperty(`${e.getPath()}/ibn/${a}/${n}`,true);i.push(t)}else{r.push(t)}}const s=!o?"aApplicable":"aApplicableForContextMenu";const c=!o?"aNotApplicable":"aNotApplicableForContextMenu";e.getModel().setProperty(`${e.getPath()}/ibn/${a}/${s}`,i);e.getModel().setProperty(`${e.getPath()}/ibn/${a}/${c}`,r)}},onContextMenuItemSelected:function(e){const t=r.getMdcTable(e.getSource());const n=t?.getParent();n?.setContextMenuActive(true);setTimeout(()=>{n?.setContextMenuActive(false)},0)},dataStateIndicatorFilter:function(e,t){const n=t.getParent();return n.dataStateIndicatorFilter(e,t)}};return f},false);
//# sourceMappingURL=TableRuntime.js.map