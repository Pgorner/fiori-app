/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/deepExtend","sap/fe/base/BindingToolkit","sap/fe/base/jsx-runtime/jsx","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/controllerextensions/cards/CollaborationManager","sap/fe/core/formatters/ValueFormatter","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/ExcelFormatHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/SizeHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/type/EDM","sap/fe/macros/CollectionBindingInfo","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filterBar/FilterBarDelegate","sap/fe/macros/table/MdcTableTemplate","sap/fe/macros/table/TableHelper","sap/fe/macros/table/TableRuntime","sap/fe/macros/table/TableSizeHelper","sap/fe/macros/table/Utils","sap/m/IllustratedMessage","sap/m/IllustratedMessageType","sap/ui/core/Fragment","sap/ui/core/util/XMLPreprocessor","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/json/JSONModel"],function(e,t,n,i,a,o,r,s,l,c,p,u,d,g,f,m,h,y,b,C,P,T,v,_,D,I,E,S,F,A,M,x,O,B,w,L){"use strict";var R=v.getSlotColumn;var H=v.getCustomColumnTemplate;var N=v.getComputedColumn;var U=v.getColumnTemplate;var V=y.isTypeFilterable;var W=h.isPathFilterable;var $=f.getResourceModel;var k=f.getLocalizedText;var j=s.getInvolvedDataModelObjects;var G=i.isConstant;const X="/semanticKeyHasDraftIndicator";const K="searchFired";const z="columnAdded";const q="previousSorters";return Object.assign({},x,{apiVersion:2,_computeVisualSettingsForFieldGroup:function(e,t,i){if(t.name.indexOf("DataFieldForAnnotation::FieldGroup::")===0){const a=e.getColumns().find(e=>e.getPropertyKey()===t.name);const o=a?a.data("showDataFieldsLabel")==="true":false;const r=e.getModel().getMetaModel();const s=j(r.getContext(t.metadataPath));const l=s.convertedTypes;const c=s.targetObject;const p=c.Target.$target;const u=[];p.Data.forEach(function(e){let t;switch(e.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":t=I.getWidthForDataFieldForAnnotation(e,false,i,l,o);break;case"com.sap.vocabularies.UI.v1.DataField":t=I.getWidthForDataField(e,o,i,l,false);break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":t={labelWidth:0,propertyWidth:m.getButtonWidth(e.Label?.toString())};break;default:}if(t){u.push(t.labelWidth+t.propertyWidth)}});const d=u.reduce(function(e,t){return Math.max(e,t)},0);t.visualSettings=n(t.visualSettings,{widthCalculation:{verticalArrangement:true,minWidth:Math.ceil(d)}})}},_computeVisualSettingsForPropertyWithValueHelp:function(e,t){const i=e.getParent();if(!t.propertyInfos){const a=e.getModel().getMetaModel();if(t.metadataPath&&a){const e=a.getObject(`${t.metadataPath}@`);if(e&&e["@com.sap.vocabularies.Common.v1.ValueList"]){t.visualSettings=n(t.visualSettings||{},{widthCalculation:{gap:i.getProperty("readOnly")?0:4}})}}}},_computeVisualSettingsForPropertyWithUnit:function(e,t,i,a,o){const r=e?e.getParent():null;const s=a||o;if(s){t.visualSettings=n(t.visualSettings,{widthCalculation:{gap:Math.ceil(m.getButtonWidth(s))}})}if(i){t.visualSettings=n(t.visualSettings,{widthCalculation:{gap:r&&r.getReadOnly()?0:6}})}},_computeLabel:function(e,t){if(e.label){const n=t[e.label];const i=n?.some(t=>t.text===e.path&&t.mode==="Description");if(n?.length>1&&e.path?.includes("/")&&e.additionalLabels&&!i){e.label=e.label+" ("+e.additionalLabels.join(" / ")+")"}delete e.additionalLabels}},_updatePropertyInfo:function(e,t){const i={};const a=e.getP13nMode();t.forEach(e=>{if(!e.propertyInfos&&e.label){if(a?.includes("Sort")&&e.sortable||a?.includes("Filter")&&e.filterable||a?.includes("Group")&&e.groupable){i[e.label]=i[e.label]!==undefined?i[e.label].concat([e]):[e]}}});t.forEach(a=>{this._computeVisualSettingsForFieldGroup(e,a,t);this._computeVisualSettingsForPropertyWithValueHelp(e,a);a.typeConfig=n(a.typeConfig,{});this._computeLabel(a,i)});t.push({name:"$editState",path:"$editState",groupLabel:"",group:"",typeConfig:O.getTypeConfig("sap.ui.model.odata.type.String",{},{}),visible:false,groupable:false,sortable:false,filterable:false});return t},getColumnsFor:function(e){return e.getParent().getTableDefinition().columns},fetchExportCapabilities:async function(t){const n={XLSX:{}};let i;return P.fetchModel(t).then(function(e){i=e;return i.getMetaModel().getObject("/$EntityContainer@Org.OData.Capabilities.V1.SupportedFormats")}).then(function(e){const t=(e||[]).map(e=>e.toLowerCase());if(t.includes("application/pdf")){return i.getMetaModel().getObject("/$EntityContainer@com.sap.vocabularies.PDF.v1.Features")}return undefined}).then(function(e){if(e){n["PDF"]=Object.assign({},e)}return}).catch(function(t){e.error(`An error occurs while computing export capabilities: ${t}`)}).then(function(){return n})},_isFilterableNavigationProperty:function(e,t){const n=W(t);return!e.relativePath.includes("/")||(e.isPartOfLineItem===true||e.isPartOfCustomColumn===true)&&!(G(n)&&n.value===false)},_fetchPropertyInfo:function(e,t,n,i){const a=t.annotationPath,o=e.getObject(a),r=e.createBindingContext(a),s=t.typeConfig?.className&&V(t.typeConfig.className)?O.getTypeConfig(t.typeConfig.className,t.typeConfig.formatOptions,t.typeConfig.constraints):{},l=C.isPropertyFilterable(r,o),c=t.typeConfig&&t.typeConfig.className&&t.typeConfig.className?.indexOf("Edm.")!==0,p=P.getCustomData(n,"enableAnalytics")==="true",u=k(t.label??"",i??n);const d=k(t.tooltip??"",i??n);const g={name:t.name,metadataPath:a,groupLabel:t.groupLabel,group:t.group,label:u,tooltip:d,typeConfig:s,formatOptions:t.typeConfig?.baseType==="Edm.DateTimeOffset"?{style:"medium/short"}:t.typeConfig?.formatOptions,visible:t.availability!=="Hidden"&&!c,exportSettings:this._setPropertyInfoExportSettings(t.exportSettings,t),unit:t.unit};if(g.exportSettings?.template){g.clipboardSettings={template:g.exportSettings.template}}if(t.visualSettings&&Object.keys(t.visualSettings).length>0){g.visualSettings=t.visualSettings}if(t.exportDataPointTargetValue){g.exportDataPointTargetValue=t.exportDataPointTargetValue}if(t.propertyInfos?.length){g.propertyInfos=t.propertyInfos}else{const a=j(e.getContext(t.annotationPath),e.getContext(P.getCustomData(n,"metaPath")));g.path=t.relativePath;g.sortable=t.sortable;if(p){this._updateAnalyticalPropertyInfoAttributes(g,t)}g.filterable=t.filterable!==false&&!!l&&this._isFilterableNavigationProperty(t,a);g.isKey=t.isKey;g.groupable=t.isGroupable;if(t.textArrangement){const e=this.getColumnsFor(n).find(function(e){return e.name===t.textArrangement?.textProperty});if(e){g.mode=t.textArrangement.mode;g.valueProperty=t.relativePath;g.descriptionProperty=e.relativePath}}g.text=t.textArrangement?.textProperty;g.caseSensitive=t.caseSensitive;if(t.additionalLabels){g.additionalLabels=t.additionalLabels.map(e=>k(e,i||n))}}this._computeVisualSettingsForPropertyWithUnit(n,g,t.unit,t.unitText,t.timezoneText);return g},_setPropertyInfoExportSettings:function(e,t){const n=this._getExportFormat(t.typeConfig?.className);if(n&&e){e.format=n}return e},_updateAnalyticalPropertyInfoAttributes(e,t){if(t.aggregatable){e.aggregatable=t.aggregatable}if(t.extension){e.extension=t.extension}},_fetchComputedPropertyInfo:function(e,t){let n="";n=k(e.label,t);const i={name:e.name,label:n.toString(),type:"Edm.String",visible:e.availability!=="Hidden",filterable:false,sortable:false,groupable:false,exportSettings:null,clipboardSettings:null};if(e.propertyInfos!==undefined&&e.propertyInfos.length>0){i.propertyInfos=e.propertyInfos}return i},_fetchCustomPropertyInfo:function(e,t,n){let i;if(e.header){if(e.header.startsWith("{metaModel>")){i=d.fetchTextFromMetaModel(e.header,undefined,t.getModel().getMetaModel())}else{i=k(e.header,n)}}const a={name:e.name,groupLabel:undefined,group:undefined,label:i??"",type:"Edm.String",visible:e.availability!=="Hidden",exportSettings:e.exportSettings,visualSettings:e.visualSettings};if(e.propertyInfos&&e.propertyInfos.length){a.propertyInfos=e.propertyInfos}else{a.path=e.name;a.sortable=false;a.filterable=false}return a},_bColumnHasPropertyWithDraftIndicator:function(e){return!!(e.formatOptions&&e.formatOptions.hasDraftIndicator||e.formatOptions&&e.formatOptions.fieldGroupDraftIndicatorPropertyPath)},_updateDraftIndicatorModel:function(e,t){const n=e.getColumns();const i=e.getBindingContext("internal");const a=i&&i.getPath();if(n&&i){for(const e in n){if(this._bColumnHasPropertyWithDraftIndicator(t)&&t.name===n[e].getPropertyKey()){if(i.getProperty(a+X)===undefined){i.setProperty(a+X,t.name);break}}}}},_fetchPropertiesForEntity:async function(t,n,i,a){const o=d.getEntitySetPath(n);let s=[];const l=r.getFilterRestrictionsByPath(o,i);const c=l.NonFilterableProperties;return Promise.resolve(this.getColumnsFor(t)).then(e=>{if(e){let n;e.forEach(e=>{this._updateDraftIndicatorModel(t,e);switch(e.type){case"Annotation":n=this._fetchPropertyInfo(i,e,t,a);if(n&&!c.includes(n.name)){n.maxConditions=P.isMultiValue(n)?-1:1}break;case"Computed":n=this._fetchComputedPropertyInfo(e,t);break;case"Slot":case"Default":n=this._fetchCustomPropertyInfo(e,t,a);break;default:throw new Error(`unhandled switch case ${e.type}`)}s.push(n)})}return}).then(()=>{s=this._updatePropertyInfo(t,s);return}).catch(function(t){e.error(`An error occurs while updating fetched properties: ${t}`)}).then(function(){return s})},_getCachedOrFetchPropertiesForEntity:async function(e,t,n,i){const a=P.getCachedProperties(e);if(a){return Promise.resolve(a)}return this._fetchPropertiesForEntity(e,t,n,i).then(function(t){P.setCachedProperties(e,t);return t})},setNoDataInformation:function(e,t){const n=e.getNoData();if(typeof n!="string"&&n?.isA("sap.m.IllustratedMessage")){const e=n;e.setTitle(t.title);e.setDescription(t.description);e.setIllustrationType(t.illustrationType);e.setIllustrationSize(t.illustrationSize)}else{const n=new S({...t});e.setNoData(n)}},setTableNoDataIllustratedMessage:function(e,t){const n=E.getAllFilterInfo(e);const i=$(e);const a=t.path?.startsWith("/")?t.path.substring(1):t.path;let o;const s=function(){if(e.data("hiddenFilters")||e.getQuickFilter()){return{title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("M_TABLE_AND_CHART_NO_DATA_TEXT_MULTI_VIEW",undefined,a),illustrationType:F.NoSearchResults}}return{title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("T_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER",undefined,a),illustrationType:F.NoSearchResults}};const l=e.getFilter();const c=n.search||n.filters?.length;if(l&&!/BasicSearch$/.test(l)){if(c){o=s()}else{o={title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("T_TABLE_AND_CHART_NO_DATA_TEXT",undefined,a),illustrationType:F.NoSearchResults}}}else if(c){o=s()}else{o={title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NODATA"),description:i.getText("M_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT",undefined,a),illustrationType:F.NoData}}if(r.getTargetView(e).getViewData().liveMode){o={title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("T_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"),illustrationType:F.NoSearchResults}}o.illustrationSize=e.getParent().modeForNoDataMessage;if(o.illustrationSize==="text"){const t=e.getNoData();if(typeof t==="string"&&t===o.description){return}e.setNoData(o.description)}else{this.setNoDataInformation(e,o)}},handleTableDataReceived:function(e,t){const n=e&&e.getRowBinding(),i=t&&t.getProperty("dataReceivedAttached");if(t&&!i){n.attachDataReceived(()=>{if(!t.getProperty("dataReceivedTimeoutSet")){t.setProperty("dataReceivedTimeoutSet",true);setTimeout(()=>{t.setProperty("dataReceivedTimeoutSet",false);t.setProperty("selectedContexts",[]);const n=e.getSelectedContexts();t.setProperty("selectedContexts",n);t.setProperty("numberOfSelectedContexts",n.length);const i=P.getCustomData(e,"operationAvailableMap")??{};o.setActionEnablement(t,i,n,"table");p.updateDeleteInfoForSelectedContexts(t,n);const a=e?e.getParent():null;if(a){a.setUpEmptyRows(e)}this._updateAvailableCards(e)},0)}});t.setProperty("dataReceivedAttached",true)}},setOptimisticBatchPromiseForModel:function(e,t){const n=e.getAppComponent().getModel();if(n){t.setOptimisticBatchEnablerPromise(new g);this.setOptimisticBatchForModel(e,n,t)}},enableOptimisticBatchMode:function(e,t){const n=t&&E.isFilterEligibleForOptimisticBatch(t,e._getFilterBarControl());t.getParent().getOptimisticBatchEnablerPromise()?.resolve(!n)},setOptimisticBatchForModel:function(e,t,n){const i=e.getAppComponent().getShellServices().isFlpOptimisticBatchPluginLoaded();if(t.getOptimisticBatchEnabler()===null&&!n.isOptimisticBatchDisabled()&&i){const e=n.getOptimisticBatchEnablerPromise();t.setOptimisticBatchEnabler(function(){return e?.promise})}},rebind:async function(t,n){const i=t.getParent();const a=i?.getProperty("bindingSuspended");i?.setProperty("outDatedBinding",a);if(!a){D.clearSelection(t);x.rebind.apply(this,[t,n]);E.onTableBound(t);return E.whenBound(t).then(e=>{this.handleTableDataReceived(e,e.getBindingContext("internal"));return}).catch(function(t){e.error("Error while waiting for the table to be bound",t)})}return Promise.resolve()},fetchProperties:async function(e){return P.fetchModel(e).then(async t=>{const n=r.getAppComponent(e);return this._getCachedOrFetchPropertiesForEntity(e,P.getCustomData(e,"entityType")??"",t.getMetaModel(),n)}).then(t=>{e.getBindingContext("internal")?.setProperty("tablePropertiesAvailable",true);return t})},preInit:async function(e){return x.preInit.apply(this,[e]).then(()=>{const t=e.getCreationRow();if(t){t.setBindingContext(null)}return})},updateBindingInfo:function(t,n){const i=t.getBindingContext("internal");i?.setProperty("isInsightsEnabled",true);x.updateBindingInfo.apply(this,[t,n]);try{this._handleSortersOnCurrenciesOrUoM(t,n);this._internalUpdateBindingInfo(t,n);this.setTableNoDataIllustratedMessage(t,n);this._handleRecommendationOutputFields(t,n);this._handleFiltersForExternalID(t,n);t.getParent()?.fireEvent("beforeRebindTable",{collectionBindingInfo:new b(n)});const e=t.getBindingContext();if(t.getCreationRow()?.getBindingContext()===null&&n.path&&e){_.enableFastCreationRow(t.getCreationRow(),n.path,e,t.getModel(),Promise.resolve())}}catch(t){e.error("Error while updating the binding info",t)}},_handleSortersOnCurrenciesOrUoM:function(e,t){const n=t.sorter;const i=[];if(n?.length){const a=P.getCachedProperties(e);for(const e of n){const t=a?.find(t=>t.path===e.getPath());if(t?.unit){const n=a?.find(e=>e.name===t?.unit);if(n?.sortable!==false&&n?.path){i.push(new w(n.path,e.isDescending()))}}i.push(e)}t.sorter=i}},_handleFiltersForExternalID:function(e,t){const n=e.getModel()?.getMetaModel();const i=t.path+"/";const a=t.filters?.getFilters();if(a!==undefined){E.updateFiltersForExternalID(n,a,i)}},_handleRecommendationOutputFields:function(e,t){const n=e.getParent();const i=n?.getController();if(i?.recommendations.isRecommendationEnabled()){const e=i.getAppComponent();const a=n.getTableDefinition();const o=e.getSideEffectsService().getRecommendationOutputFields(a.annotation.entityTypeName);if(o&&o.length>0&&t.parameters){t.parameters.$select=t.parameters?.$select?.concat(",",o.join())}}},_updateAvailableCards:async function(e){const t=e.getParent();const n=t?.getController()?.getAppComponent();const i=[];await t.collectAvailableCards(i);const a=new l;const o=a.updateCards(i);const r=n.getId();n.getCollaborationManagerService().addCardsToCollaborationManager(o,r);n.getCollaborationManagerService().shareAvailableCards()},getInResultPropertyKeys:function(e){const t=e.getParent();if(t?.tableDefinition.requestAtLeast){return t.tableDefinition.requestAtLeast}return[""]},updateBinding:function(n,i,a){const o=n.getParent();const s=o?.getProperty("bindingSuspended");if(!s){let s=false;const l=r.getTargetView(n);const c=n.getBindingContext("internal");const p="pendingManualBindingUpdate";const u=c?.getProperty(p);const d=JSON.stringify(i.sorter??[]);if(a){const e=l?.getViewData();const n=a.getFilters("Application");const o=c?.getProperty(q)??"[]";const r=t(i.filters,n[0])&&d===o&&i.path===a.getPath()&&a.getQueryOptionsFromParameters().$search===i?.parameters?.$search;const p=!!e.views;s=r&&(c?.getProperty(K)||c?.getProperty(z)||p)&&!u}x.updateBinding.apply(this,[n,i,a]);o.setTableBindingInfo(i);o.setDownloadUrl();n.fireEvent("bindingUpdated");if(s&&n.getFilter()&&a){a.requestRefresh(a.getGroupId()).finally(()=>{c?.setProperty(p,false)}).catch(function(t){e.error("Error while refreshing the table",t)});c?.setProperty(p,true)}c?.setProperty(K,false);c?.setProperty(z,false);c?.setProperty(q,d);if(o.getTableDefinition().control.type==="TreeTable"){c?.setProperty("pastableContexts",[])}}o?.setProperty("outDatedBinding",s)},_computeRowBindingInfoFromTemplate:function(e){const t=e.getParent();const n=t.getTableTemplateBindingInfo();if(n.parameters?.$$getKeepAliveContext===true){const t=P.getCustomData(e,"targetCollectionPath")??"";const i=e.getModel("internal");const a=i?.getObject("/keptAliveLists")??{};if(!a[t]){a[t]=e.getId();i?.setProperty("/keptAliveLists",a)}else if(a[t]!==e.getId()){delete n.parameters.$$getKeepAliveContext}}return n},_internalUpdateBindingInfo:function(e,t){const n=e.getBindingContext("internal");Object.assign(t,this._computeRowBindingInfoFromTemplate(e));if(e.getRowBinding()){t.suspended=false}if(n){n.setProperty("dataReceivedAttached",false)}let i;const a=E.getAllFilterInfo(e);if(a.filters.length>0){i=new B({filters:a.filters,and:true})}if(a.bindingPath){t.path=a.bindingPath}const o=e.getDataStateIndicator();if(o&&o.isFiltering()){if(t.filters.length>0){i=new B({filters:t.filters.concat(a.filters),and:true});this.updateBindingInfoWithSearchQuery(t,a,i)}}else{this.updateBindingInfoWithSearchQuery(t,a,i)}this.addFilterOnActiveEntities(e,t)},_templateCustomColumnFragment:async function(e,t,n,i,o){const r=o.getModel&&o.getModel();const s=t.getController();const l=s?.getOwnerComponent();const c=new L(e),p=new L({id:i}),u={bindingContexts:{this:p.createBindingContext("/"),column:c.createBindingContext("/"),collection:o},models:{metaModel:r,this:p,column:c,collection:r},appComponent:l?.getAppComponent()};const d=(new DOMParser).parseFromString(a.renderAsXML(()=>H(i,e,o)),"text/xml");return P.templateControlFragment(d.firstElementChild,u,{view:t},n).then(function(e){c.destroy();return e})},updateBindingInfoWithSearchQuery:function(e,t,n){e.filters=n;e.parameters??={};if(t.search){e.parameters.$search=r.normalizeSearchTerm(t.search)}else{e.parameters.$search=undefined}},addFilterOnActiveEntities:function(e,t){const n=e.getPayload();if(n?.filterOnActiveEntities===true){const e=new B({path:"IsActiveEntity",operator:"EQ",value1:true});if(t.filters){t.filters=new B({filters:[e,t.filters],and:true})}else{t.filters=e}}},_templateSlotColumnFragment:async function(t,n,i,o){const r=(new DOMParser).parseFromString(a.renderAsXML(()=>R(o,t,false)),"text/xml");if(!r){return Promise.resolve(null)}const s=r.getElementsByTagName("slot")[0];if(t.template){if(s){const e=(new DOMParser).parseFromString(t.template,"text/xml");if(e.firstElementChild&&e.firstElementChild.nodeName!=="html"){s.replaceWith(e.firstElementChild)}else{s.remove()}}}else{e.error(`Please provide content inside this Building Block Column: ${t.header}`);return Promise.resolve(null)}const l=await M.process(r.firstElementChild,{models:{}},n.getController().getOwnerComponent().getPreprocessorContext());if(i?.targets!=="jsControlTree"){return l.firstElementChild}return A.load({type:"XML",definition:l,controller:n.getController()})},_getExportFormat:function(e){switch(e){case"Edm.Date":return u.getExcelDatefromJSDate();case"Edm.DateTimeOffset":return u.getExcelDateTimefromJSDateTime();case"Edm.TimeOfDay":return u.getExcelTimefromJSTime();default:return undefined}},_getVHRelevantFields:function(e,t,n){let i=[],a=e.getObject(t);if(a.$kind&&a.$kind==="Property"){a=e.getObject(`${t}@com.sap.vocabularies.UI.v1.DataFieldDefault`);t=`${t}@com.sap.vocabularies.UI.v1.DataFieldDefault`}switch(a.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":if(e.getObject(`${t}/Target/$AnnotationPath`).includes("com.sap.vocabularies.UI.v1.FieldGroup")){e.getObject(`${t}/Target/$AnnotationPath/Data`).forEach((n,a)=>{i=i.concat(this._getVHRelevantFields(e,`${t}/Target/$AnnotationPath/Data/${a}`))})}break;case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithIntentBasedNavigation":case"com.sap.vocabularies.UI.v1.DataFieldWithAction":i.push(e.getObject(`${t}/Value/$Path`));break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":break;default:if(n&&t.indexOf(n)===0){i.push(t.substring(n.length+1));break}i.push(C.getNavigationPath(t,true));break}return i},_setDraftIndicatorOnVisibleColumn:function(e,t,n){const i=e.getBindingContext("internal");if(!i){return}const a=i.getPath();const o=t.filter(e=>this._bColumnHasPropertyWithDraftIndicator(e));const r=e.getColumns();let s,l,c,p;for(const e in r){l=r[e].getPropertyKey();for(const e in o){p=o[e].name;if(l===p){c=true;break}if(n&&n.name===p){s=n.name}}if(c){i.setProperty(a+X,l);break}}if(!c&&s){i.setProperty(a+X,s)}},removeItem:async function(e,t,n){let i=true;if(!t){return Promise.resolve(i)}const a=n.modifier;const o=await a.getProperty(t,"dataProperty");if(o&&o.includes&&o.includes("InlineXML")){a.insertAggregation(e,"dependents",t);i=false}if(e.isA&&a.targets==="jsControlTree"){this._setDraftIndicatorStatus(a,e,this.getColumnsFor(e))}return Promise.resolve(i)},_getMetaModel:function(e){return e.appComponent&&e.appComponent.getModel().getMetaModel()},_setDraftIndicatorStatus:function(e,t,n,i){if(e.targets==="jsControlTree"){this._setDraftIndicatorOnVisibleColumn(t,n,i)}},_getGroupId:function(e){return e||undefined},_fnTemplateValueHelp:function(e,t,n){if(t&&!n){return e("sap.fe.macros.table.ValueHelp")}return Promise.resolve()},_insertAggregation:async function(e,t,n){if(e){return t.insertAggregation(n,"dependents",e,0)}return},addItem:async function(t,n,i){const o=this._getMetaModel(i),s=i.modifier,l=s.getId(t),c=t.isA?this.getColumnsFor(t):null;if(!c){return Promise.resolve(null)}const p=c.find(function(e){return e.name===n});if(!p){e.error(`${n} not found while adding column`);return Promise.resolve(null)}if(p.availability==="Hidden"){e.warning(`Column for ${n} not added because it's hidden`);return Promise.resolve(null)}const u=t.getBindingContext("internal");u?.setProperty(z,true);this._setDraftIndicatorStatus(s,t,c,p);const d=await P.getCustomDataWithModifier(t,"metaPath",s);const g=o.createBindingContext(d);const f=i.view||r.getTargetView(t)||(i.appComponent?r.getCurrentPageView(i.appComponent):undefined);if(p.type==="Default"){return this._templateCustomColumnFragment(p,f,s,l,g)}if(p.type==="Slot"){return this._templateSlotColumnFragment(p,f,s,l)}if(p.type==="Computed"){const e=t.getParent().getTableDefinition().enableAnalytics;return N(l,p,g,e)}if(!o){return Promise.resolve(null)}const m=await P.getCustomDataWithModifier(t,"entityType",s);const h=await P.getCustomDataWithModifier(t,"requestGroupId",s);const y=this._getGroupId(h);const b=await this._getCachedOrFetchPropertiesForEntity(t,m,o,i.appComponent);const C=b.find(function(e){return e.name===n});const T=o.createBindingContext(C.metadataPath);const v=this._getVHRelevantFields(o,C.metadataPath,d);const _={sBindingPath:d,sValueHelpType:"TableValueHelp",oControl:t,metaPath:T.getPath(),oMetaModel:o,oModifier:s,oPropertyInfo:C};const D=async n=>{const i=new L({id:l,requestGroupId:y}),a={bindingContexts:{this:i.createBindingContext("/"),dataField:T,contextPath:g},models:{this:i,dataField:o,metaModel:o,contextPath:o}};try{const e=await P.templateControlFragment(n,a,{},s);return await this._insertAggregation(e,s,t)}catch(t){e.error(`ValueHelp not loaded : ${t.message}`);return}finally{i.destroy()}};const I=async(e,r)=>{let c;let u;let f;let m;return Promise.all([P.getCustomDataWithModifier(t,"displayModePropertyBinding",s),P.getCustomDataWithModifier(t,"tableType",s),P.getCustomDataWithModifier(t,"onChange",s),P.getCustomDataWithModifier(t,"creationMode",s)]).then(async e=>{c=e[0];u=e[1];f=e[2];m=e[3];if(c!==undefined&&typeof c!=="boolean"){c=c==="true"}const h=t.getParent();const y=new L({enableAutoColumnWidth:h.enableAutoColumnWidth,readOnly:c,tableType:u,onChange:f,id:l,navigationPropertyPath:n,columnInfo:p,collection:o.createBindingContext(d),creationMode:{name:m},widthIncludingColumnHeader:h.widthIncludingColumnHeader}),b={bindingContexts:{entitySet:g,collection:g,dataField:T,this:y.createBindingContext("/"),column:y.createBindingContext("/columnInfo")},models:{this:y,entitySet:o,collection:o,dataField:o,metaModel:o,column:y},appComponent:i.appComponent};const C=(new DOMParser).parseFromString(a.renderAsXML(()=>U(l,h.getTableDefinition(),p,o.createBindingContext(d),c,h.enableAutoColumnWidth,h.widthIncludingColumnHeader,h.getTableDefinition().enableAnalytics,u,{name:m},"",f,h.getTableDefinition().control.isCompactType,"")??""),"text/xml");return P.templateControlFragment(C.firstElementChild,b,{view:r},s).finally(function(){y.destroy()})})};await Promise.all(v.map(async e=>{const t=Object.assign({},_,{sPropertyName:e});const n=await Promise.all([P.isValueHelpRequired(t),P.doesValueHelpExist(t)]);const i=n[0],a=n[1];return this._fnTemplateValueHelp(D,i,a)}));return I(C,f)},getFilterDelegate:function(){return Object.assign({apiVersion:2},T,{addItem:async function(e,t){if(t.indexOf("Property::")===0){t=t.replace("Property::","")}return T.addItem(e,t)}})},getTypeMap:function(){return O},formatGroupHeader(e,t,n){const i=P.getCachedProperties(e),a=i?.find(e=>e.name===n),o=a?.typeConfig?.baseType==="DateTime"||a?.typeConfig?.baseType==="Date"||a?.typeConfig?.baseType==="Boolean";let s;if(!t){s=$(r.getTargetView(e)).getText("M_TABLE_GROUP_HEADER_TITLE_VALUE");return $(e).getText("M_TABLE_GROUP_HEADER_TITLE",[a?.label,s])}if(a?.mode){switch(a.mode){case"Description":s=a.descriptionProperty?t.getProperty(a.descriptionProperty,o):null;break;case"DescriptionValue":s=c.formatWithBrackets(a.descriptionProperty?t.getProperty(a.descriptionProperty,o):null,a.valueProperty?t.getProperty(a.valueProperty,o):null);break;case"ValueDescription":s=c.formatWithBrackets(a.valueProperty?t.getProperty(a.valueProperty,o):null,a.descriptionProperty?t.getProperty(a.descriptionProperty,o):null);break;default:break}}else{s=a?.path?t.getProperty(a.path,o):null}if(s===null||s===""){s=$(r.getTargetView(e)).getText("M_TABLE_GROUP_HEADER_TITLE_VALUE")}return $(e).getText("M_TABLE_GROUP_HEADER_TITLE",[a?.label,s])}})},false);
//# sourceMappingURL=TableDelegate.js.map