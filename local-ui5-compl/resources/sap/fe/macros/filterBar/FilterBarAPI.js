/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/ClassSupport","sap/fe/core/helpers/PromiseKeeper","sap/fe/macros/MacroAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/filterBar/SemanticDateOperators","sap/fe/macros/mdc/adapter/StateHelper","sap/fe/navigation/library","sap/ui/core/Element","sap/ui/mdc/enums/FieldEditMode","sap/ui/mdc/p13n/StateUtil"],function(t,e,r,n,i,a,o,l,s,c,u,f){"use strict";var h,p,g,d,y,S,b,m,F,v,w,C,V,E,P,_,x,I,O,z,A,B,M,T,j,k,H,D,N,$,K,R,U;var L=s.NavType;var W=r.xmlEventHandler;var q=r.property;var J=r.implementInterface;var G=r.event;var Q=r.defineUI5Class;var X=r.aggregation;function Y(t,e,r,n){r&&Object.defineProperty(t,e,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}function Z(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,tt(t,e)}function tt(t,e){return tt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},tt(t,e)}function et(t,e,r,n,i){var a={};return Object.keys(n).forEach(function(t){a[t]=n[t]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=r.slice().reverse().reduce(function(r,n){return n(t,e,r)||r},a),i&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(i):void 0,a.initializer=void 0),void 0===a.initializer?(Object.defineProperty(t,e,a),null):a}function rt(t,e){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let nt=function(){function t(t){this.countFilterActions=0;this.countVariantFilters=0;this.filterBarAPI=t}var e=t.prototype;e.onFiltersChanged=function t(e){if(e==="Variant"){this.countVariantFilters++}else{this.countFilterActions++}};e.onSearch=function t(e,r){const n=this.getFilterNamesFromConditions(r);this.filterBarAPI.getController().telemetry.storeAction({type:"FE.FilterBarSearch",parameters:{countFilterActions:this.countFilterActions,countFilters:Object.keys(r).length,countVariantFilters:this.countVariantFilters,variantLayer:this.filterBarAPI.getVariant()?.layer??"None",autoLoad:e.reason==="Variant",searchUsed:r.$search?!!Object.keys(r.$search).length:false,filterNames:n}});this.countFilterActions=0;this.countVariantFilters=0};e.getFilterNamesFromConditions=function t(e){let r="";Object.keys(e).forEach(t=>{if(t!="$search"){r+=t+";"}});return r};return t}();let it=(h=Q("sap.fe.macros.filterBar.FilterBarAPI",{returnTypes:["sap.ui.core.Control"]}),p=J("sap.fe.core.controllerextensions.viewState.IViewStateContributor"),g=q({type:"string"}),d=q({type:"string",expectedAnnotations:["com.sap.vocabularies.UI.v1.SelectionFields"],expectedTypes:["EntitySet","EntityType"]}),y=q({type:"string",expectedTypes:["EntitySet","EntityType","NavigationProperty"]}),S=q({type:"boolean",defaultValue:false}),b=q({type:"boolean",defaultValue:true}),m=q({type:"boolean",defaultValue:true}),F=q({type:"boolean",defaultValue:false}),v=X({type:"sap.fe.macros.filterBar.FilterField",multiple:true}),w=G(),C=G(),V=G(),E=G(),P=G(),_=W(),x=W(),h(I=(O=function(r){function i(t,e){var i;i=r.call(this,t,e)||this;Y(i,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",z,i);i.initialControlState={};i._initialStatePromise=new n;Y(i,"id",A,i);Y(i,"metaPath",B,i);Y(i,"contextPath",M,i);Y(i,"liveMode",T,i);Y(i,"visible",j,i);Y(i,"showMessages",k,i);Y(i,"showClearButton",H,i);Y(i,"filterFields",D,i);Y(i,"search",N,i);Y(i,"internalSearch",$,i);Y(i,"filterChanged",K,i);Y(i,"afterClear",R,i);Y(i,"internalFilterChanged",U,i);i.telemetry=new nt(i);i.attachStateChangeHandler();return i}Z(i,r);var s=i.prototype;s.applyLegacyState=async function t(e,r,n,i){const a=this.content;const o=e(a);const l={};if(o){l.innerState={...o,fullState:{...l.innerState?.fullState,...o.fullState},initialState:{...l.innerState?.initialState,...o.initialState}}}if(l&&Object.keys(l).length>0){await this.applyState(l,r,n,i)}};s.applyState=async function e(r,n,i,a){try{if(r&&n){const t=n.navigationType;if(t===L.hybrid&&r.innerState?.fullState!==undefined){const t=await this.convertSelectionVariantToStateFilters(n.selectionVariant,true);const e={...r.innerState?.fullState,filter:{...r.innerState?.fullState.filter,...t}};await this._clearFilterValuesWithOptions(this.content,{clearEditFilter:true});return await f.applyExternalState(this.content,e)}if(i){const t=await f.diffState(this.content,r.innerState?.initialState,r.innerState?.fullState);return await f.applyExternalState(this.content,t)}else if(a){await this._clearFilterValuesWithOptions(this.content,{clearEditFilter:true})}return await f.applyExternalState(this.content,r?.innerState?.fullState??r)}}catch(e){t.error(e)}finally{this._initialStatePromise.resolve()}};s.waitForInitialState=async function t(){return this._initialStatePromise.promise};s.getControlState=function t(e){const r=this.initialControlState;if(e){return{fullState:e,initialState:r}}return e};s.retrieveState=async function t(){const e={};e.innerState=this.getControlState(await f.retrieveExternalState(this.content));const r=this.content.getPropertyInfoSet();const n=e.innerState?.filter||{};r.filter(function(t){return Object.keys(n).length>0&&t.path&&n[t.path]&&(t.removeFromAppState||n[t.path].length===0)}).forEach(function(t){if(t.path){delete n[t.path]}});return e};s.setInitialState=async function e(){try{const t=await f.retrieveExternalState(this.content);this.initialControlState=t}catch(e){t.error(e)}};s.attachStateChangeHandler=function t(){f.detachStateChange(this.stateChangeHandler);f.attachStateChange(this.stateChangeHandler)};s.stateChangeHandler=function t(e){const r=e.getParameter("control");if(r.isA("sap.ui.mdc.FilterBar")){const t=r.getParent();if(t?.handleStateChange){t.handleStateChange()}}};s.handleSearch=function t(r){const n=r.getSource();const i=r.getParameters();if(n){const t=n.getFilterConditions()??{};const r=this._prepareEventParameters(n);this.telemetry?.onSearch(i,t);this.fireEvent("internalSearch",e({conditions:t},i));this.fireEvent("search",e({reason:i.reason},r))}};s.handleFilterChanged=function t(r){const n=r.getSource();const i=r.getParameters();if(n){const t=n.getFilterConditions();const r=this._prepareEventParameters(n);this.telemetry?.onFiltersChanged(this._getFilterBarReason(n));this.fireEvent("internalFilterChanged",e({conditions:t},i));this.fireEvent("filterChanged",r)}};s._getFilterBarReason=function t(e){return e?._sReason??""};s._prepareEventParameters=function t(e){const{parameters:r,filters:n,search:i}=a.getFilters(e)||{};return{parameters:r,filters:n,search:i}};s.setFilterValues=async function t(e,r,n){if(arguments.length===2){n=r;return a.setFilterValues(this.content,e,n)}return a.setFilterValues(this.content,e,r,n)};s.getActiveFiltersText=function t(){return this.content?.getAssignedFiltersText()?.filtersText||""};s.getFilters=function t(){return a.getFilters(this.content)||{}};s.triggerSearch=async function e(){const r=this.content;try{if(r){await r.waitForInitialization();return await r.triggerSearch()}}catch(e){const r=e instanceof Error?e.message:String(e);t.error(`FE : Buildingblock : FilterBar : ${r}`);throw Error(r)}};s.isSemanticDateFilterApplied=function t(){return o.hasSemanticDateOperations(this.content.getConditions(),false)};s.getSelectionVariant=async function t(){return l.getSelectionVariant(this.getContent())};s.getMandatoryFilterPropertyNames=function t(){return this.content.getPropertyInfoSet().filter(function(t){return t.required}).map(function(t){return t.conditionPath})};s.getParameters=function t(){const e=this.content;const r=e.data("parameters");if(r){return Array.isArray(r)?r:JSON.parse(r)}return[]};s.getVariant=function e(){let r;try{const t=this.getModel("$FlexVariants");const e=this.content.getVariantBackreference();if(t&&e){r=t.getVariant(t.getCurrentVariantReference(e))}}catch(e){t.debug("Couldn't fetch variant ",e)}return r};s.setFilterFieldVisible=async function t(e,r){await f.applyExternalState(this.content,{items:[{name:e,visible:r}]})};s.getFilterFieldVisible=async function t(e){const r=await f.retrieveExternalState(this.content);return!!r.items.find(t=>t.name===e)};s.getVariantManagement=function t(){const e=this.content.getVariantBackreference();if(e){return c.getElementById(e)}else{throw new Error(`Variant back reference not defined on the filter bar ${this.id}`)}};s.setVariantBackReference=function t(e){if(!this.liveMode){this.content.setVariantBackreference(e)}};s.getCurrentVariantKey=function t(){return this.getVariantManagement().getCurrentVariantKey()};s.setCurrentVariantKey=function t(e){const r=this.getVariantManagement();r.setCurrentVariantKey(e)};s.setFilterFieldEnabled=function t(e,r){this.getModel("internal").setData({[this.content.data("localId")]:{filterFields:{[e]:{editMode:r?u.Editable:u.Disabled}}}},true)};s.getFilterFieldEnabled=function t(e){return this.getModel("internal").getProperty(`/${this.content.data("localId")}/filterFields/${e}/editMode`)===u.Disabled?false:true};s.convertSelectionVariantToStateFilters=async function t(e,r){return l.convertSelectionVariantToStateFilters(this.content,e,r,this.content?.getModel())};s._clearFilterValuesWithOptions=async function t(e,r){await l._clearFilterValuesWithOptions(e,r)};s.setSelectionVariant=async function t(e){let r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return l.setSelectionVariantToMdcControl(this.getContent(),e,r)};s.handleStateChange=function t(){this.getPageController()?.getExtensionAPI().updateAppState()};s.showFilterField=async function t(e){const r=await f.retrieveExternalState(this.content);const n=!!r.items.find(t=>t.name===e);if(!n){r.items.push({name:e})}await f.applyExternalState(this.content,r)};s.openValueHelpForFilterField=function t(e,r,n){const i=this.content.getFilterItems().find(t=>t.getPropertyKey()===e);if(i){const t=c.getElementById(i.getValueHelp());if(t){let e=[];const r=t=>{e=t.getParameter("conditions")};t.attachClosed(()=>{t.detachSelect(r,this);n?.(e)});t.attachSelect(r,this)}i._oFocusInfo={targetInfo:{silent:true}};i.onfocusin?.();setTimeout(()=>{i.getAggregation("_content")[0].fireValueHelpRequest({fromKeyboard:true,_userInputValue:r})},200)}};s.getCollapsedFiltersText=function t(){return this.content?.getAssignedFiltersText()?.filtersText};return i}(i),z=et(O.prototype,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",[p],{configurable:true,enumerable:true,writable:true,initializer:function(){return true}}),A=et(O.prototype,"id",[g],{configurable:true,enumerable:true,writable:true,initializer:null}),B=et(O.prototype,"metaPath",[d],{configurable:true,enumerable:true,writable:true,initializer:null}),M=et(O.prototype,"contextPath",[y],{configurable:true,enumerable:true,writable:true,initializer:null}),T=et(O.prototype,"liveMode",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),j=et(O.prototype,"visible",[b],{configurable:true,enumerable:true,writable:true,initializer:null}),k=et(O.prototype,"showMessages",[m],{configurable:true,enumerable:true,writable:true,initializer:null}),H=et(O.prototype,"showClearButton",[F],{configurable:true,enumerable:true,writable:true,initializer:null}),D=et(O.prototype,"filterFields",[v],{configurable:true,enumerable:true,writable:true,initializer:null}),N=et(O.prototype,"search",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),$=et(O.prototype,"internalSearch",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),K=et(O.prototype,"filterChanged",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),R=et(O.prototype,"afterClear",[E],{configurable:true,enumerable:true,writable:true,initializer:null}),U=et(O.prototype,"internalFilterChanged",[P],{configurable:true,enumerable:true,writable:true,initializer:null}),et(O.prototype,"handleSearch",[_],Object.getOwnPropertyDescriptor(O.prototype,"handleSearch"),O.prototype),et(O.prototype,"handleFilterChanged",[x],Object.getOwnPropertyDescriptor(O.prototype,"handleFilterChanged"),O.prototype),O))||I);return it},false);
//# sourceMappingURL=FilterBarAPI.js.map