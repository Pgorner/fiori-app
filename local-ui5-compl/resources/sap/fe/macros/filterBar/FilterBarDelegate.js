/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/jsx-runtime/jsx","sap/fe/core/CommonUtils","sap/fe/core/TemplateModel","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/templating/PropertyFormatters","sap/fe/core/type/EDM","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/field/FieldHelper","sap/fe/macros/filter/FilterUtils","sap/fe/macros/internal/valuehelp/ValueHelpTemplating","sap/fe/macros/mdc/adapter/StateHelper","sap/ui/mdc/FilterBarDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/model/json/JSONModel"],function(e,t,n,o,i,r,a,s,l,c,f,d,u,p,g,m,h,y,P,v,C,F){"use strict";var x=y.getValueHelpTemplate;var M=u.getModelType;var b=d.hasValueHelp;var I=f.generate;var w=c.getResourceModel;var A=c.getLocalizedText;var D=s.isPropertyFilterable;var S=a.sortPropertyInfosByGroupLabel;var T=a.processSelectionFields;var E=r.getInvolvedDataModelObjects;const $=Object.assign({},v);$.apiVersion=2;const B="$editState",L="$search",V="FilterFieldValueHelp",_="sap_fe_FilterBarDelegate_propertyInfoMap",O=/[+*]/g;async function H(e,t,n){const o=new F({id:e,isDraftCollaborative:l.isCollaborationDraftSupported(t)}),i={bindingContexts:{this:o.createBindingContext("/")},models:{this:o}};return g.templateControlFragment("sap.fe.macros.filterBar.DraftEditState",i,undefined,n).finally(function(){o.destroy()})}$._templateCustomFilter=async function(e,t,n,r,a){const s=await g.getCustomDataWithModifier(e,"entityType",a);if(n.annotationPath!==undefined){const e=r.getContext(n.annotationPath),t=E(e),o=t.targetObject?.annotations.Common?.DocumentationRef?.toString();n.documentRefText=o}const l=new F({id:t}),c=new i(n,r),f={bindingContexts:{contextPath:r.createBindingContext(s),this:l.createBindingContext("/"),item:c.createBindingContext("/")},models:{contextPath:r,this:l,item:c}},d=o.getTargetView(e),u=d?d.getController():undefined,p={controller:u?u:undefined,view:d};return g.templateControlFragment("sap.fe.macros.filter.CustomFilter",f,p,a).finally(function(){l.destroy();c.destroy()})};function N(e){return e.replace(O,"")}$._findSelectionField=function(e,t){return e.find(function(e){return(e.conditionPath===t||e.conditionPath.replaceAll(/\*/g,"")===t)&&e.availability!=="Hidden"})};function U(e,t,n){return n?I([e,t,n]):I([e,t])}async function j(o,i){const r={idPrefix:i.sVhIdPrefix,conditionModel:"$filters",navigationPrefix:i.sNavigationPrefix?`/${i.sNavigationPrefix}`:"",filterFieldValueHelp:true,useSemanticDateRange:i.bUseSemanticDateRange,metaPath:o.bindingContexts.metaPath,contextPath:o.bindingContexts.contextPath,opensOnFocus:true,useMultiValueField:false,requiresValidation:false,collaborationEnabled:false,requestGroupId:undefined};const a=new F(r);const s=t({},o,{bindingContexts:{this:a.createBindingContext("/")},models:{this:r}});const l=m.valueHelpPropertyForFilterField(o.bindingContexts.metaPath);if(o.isXML){let t=n.renderAsXML(()=>x(o.bindingContexts.metaPath.getModel().createBindingContext(l),r));if(t){if(o.isXML){t=`<root>${t}</root>`}const n=(new DOMParser).parseFromString(t,"text/xml");return Promise.resolve(g.templateControlFragment(n.firstElementChild,s,{isXML:o.isXML})).then(async function(e){if(e){const t="dependents";if(Array.isArray(e)){e.forEach(function(e){if(i.oModifier){i.oModifier.insertAggregation(i.oControl,t,e,0)}else{i.oControl.insertAggregation(t,e,0,false)}})}else if(i.oModifier){return i.oModifier.insertAggregation(i.oControl,t,e,0,i.view)}else{i.oControl.insertAggregation(t,e,0,false);return}}return}).catch(function(t){e.error("Error while evaluating DelegateUtil.isValueHelpRequired",t)}).finally(function(){a.destroy()})}}else{const e=x(o.bindingContexts.metaPath.getModel().createBindingContext(l),r);if(e){const t="dependents";if(Array.isArray(e)){e.forEach(function(e){if(i.oModifier){i.oModifier.insertAggregation(i.oControl,t,e,0)}else{i.oControl.insertAggregation(t,e,0,false)}})}else if(i.oModifier){i.oModifier.insertAggregation(i.oControl,t,e,0)}else{i.oControl.insertAggregation(t,e,0,false)}}}}async function R(t,n,o){try{const e=await Promise.resolve(n.getAggregation(t,"dependents"));let i;if(e&&e.length>1){for(i=0;i<=e.length;i++){const t=e[i];if(t&&t.isA("sap.ui.mdc.FilterField")){const e=t.getPropertyKey(),n=t.getId();if(o===e&&n.indexOf("CustomFilterField")){return t}}}}}catch(t){e.error("Filter Cannot be added",t)}}async function k(e,n,o,r){const a=new F({idPrefix:n.sIdPrefix,vhIdPrefix:n.sVhIdPrefix,propertyPath:n.sPropertyName,navigationPrefix:n.sNavigationPrefix?`/${n.sNavigationPrefix}`:"",useSemanticDateRange:n.bUseSemanticDateRange,settings:n.oSettings,visualFilter:n.visualFilter,editMode:`{internal>/${o}/filterFields/${n.sPropertyName}/editMode}`});try{const o=n.oMetaModel;const s=new i(n.visualFilter,o);const l=t({},e,{bindingContexts:{this:a.createBindingContext("/"),visualFilter:s.createBindingContext("/")},models:{this:a,visualFilter:s,metaModel:o,converterContext:r}});return await g.templateControlFragment("sap.fe.macros.internal.filterField.FilterFieldTemplate",l,{isXML:!!e.isXML})}finally{a.destroy()}}async function X(t,n,o,i){try{const e=i;i=i.replace("*","");if(n&&!n.modifier){throw"FilterBar Delegate method called without modifier."}const r=await n.modifier.getProperty(t,"delegate");const a=await n.modifier.getProperty(t,"propertyInfo");if(a){const s=a.some(function(t){return t.key===e||t.name===e});if(!s){const e=r.payload.entityTypePath;const s=h.createConverterContext(t,e,o,n.appComponent);const l=s.getEntityType();const c=h.getFilterField(i,s,l);const f=h.buildProperyInfo(c,s);await W(a,n,f,t)}}}catch(n){e.warning(`${t.getId()} : ${n}`)}}async function W(e,t,n,o){let i=await g.getCustomDataWithModifier(o,"feFilterInfo",t.modifier);if(i&&i.length>0){const e=JSON.parse(i);e.push(n);i=JSON.stringify(e);i=i.replace(/\{/g,"\\{");i=i.replace(/\}/g,"\\}");const r=await g.retrieveCustomDataNode(o,"feFilterInfo",t.modifier);r[0].setAttribute("value",i);t.modifier.insertAggregation(o,"customData",r[0],0)}e.push(n);const r=h.formatPropertyInfo(e);t.modifier.setProperty(o,"propertyInfo",r)}$.addItem=async function(e,t,n){if(!n){return $._addP13nItem(t,e)}const o=n.modifier;const i=n&&n.appComponent&&n.appComponent.getModel();const r=i&&i.getMetaModel();if(!r){return Promise.resolve(null)}const a=o&&o.targets==="xmlTree";if(a){await X(e,n,r,t)}return $._addFlexItem(t,e,r,o,n.appComponent,n.view)};$.removeItem=async function(e,t,n){let o=true;const i=n.modifier;const r=i&&i.targets==="xmlTree";if(r){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}const r=await n.modifier.getProperty(t,"propertyKey");await X(e,n,i,r)}if(typeof t!=="string"&&t.isA&&t.isA("sap.ui.mdc.FilterField")){if(t.data("isSlot")==="true"&&n){i.insertAggregation(e,"dependents",t);o=false}}return Promise.resolve(o)};$.addCondition=async function(e,t,n){const o=n.modifier;const i=o&&o.targets==="xmlTree";if(i){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}await X(e,n,i,t)}return Promise.resolve()};$.removeCondition=async function(e,t,n){if(!e.data("sap_fe_FilterBarDelegate_propertyInfoMap")){const o=n.modifier;const i=o&&o.targets==="xmlTree";if(i){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}await X(e,n,i,t)}}return Promise.resolve()};$.clearFilters=async function(e){const t=e.getParent();return P.clearFilterValues(t)};$._addP13nItem=async function(t,n){return g.fetchModel(n).then(async function(e){return $._addFlexItem(t,n,e.getMetaModel(),undefined)}).catch(function(t){e.error("Model could not be resolved",t);return null})};$.fetchPropertiesForEntity=function(e,t,n){const i=t.getObject(e);const r=n.isA("sap.ui.mdc.filterbar.vh.FilterBar")?true:undefined;if(!n||!i){return[]}const a=h.createConverterContext(n,e);const s=l.getEntitySetPath(e);const c=h.getConvertedFilterFields(n,e,r);let f=[];c.forEach(function(e){const n=e.annotationPath;if(n){const o=a.getConvertedTypes().resolvePath(n).target;const i=p.getLocationForPropertyPath(t,n);const r=n.replace(`${i}/`,"");const s=a.getEntityType();const l=s.annotations?.UI?.SelectionFields;const c=s.annotations?.UI?.FilterFacets;if(o&&$._isFilterAdaptable(e,o,l,c)&&D(t,i,N(r),true)){f.push(e)}}else{f.push(e)}});const d=[];const u=T(f,a);const m=[];u.forEach(function(e){if(e.key){m.push(e.key)}});f=f.filter(function(e){return m.includes(e.key)});const y=o.getFilterRestrictionsByPath(s,t),P=y.FilterAllowedExpressions;u.forEach(function(e,n){const i=f[n];if(!i||!i.conditionPath){return}const r=N(i.conditionPath);e=Object.assign(e,{group:i.group,groupLabel:i.groupLabel,path:i.conditionPath,tooltip:null,removeFromAppState:false,hasValueHelp:false});if(i.annotationPath){const n=i.annotationPath;const o=t.getObject(n),r=t.getObject(`${n}@`),a=t.createBindingContext(n);const s=r["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||r["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||r["@com.sap.vocabularies.Analytics.v1.Measure"];const l=p.getLocationForPropertyPath(t,i.annotationPath);const c=n.replace(`${l}/`,"");let f;let d;if(a&&D(t,l,N(c),true)){f=r["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(f){d=f[`$${M(o.$Type)}`]}e=Object.assign(e,{tooltip:r["@com.sap.vocabularies.Common.v1.QuickInfo"]||undefined,removeFromAppState:s,hasValueHelp:b(a.getObject(),{context:a}),defaultFilterConditions:d?[{fieldPath:i.conditionPath,operator:"EQ",values:[d]}]:undefined})}}if(e){if(P[r]&&P[r].length>0){e.filterExpression=o.getSpecificAllowedExpression(P[r])}else{e.filterExpression="auto"}e=Object.assign(e,{visible:i.availability==="Default"})}u[n]=e});u.forEach(function(e){e.key=e.name;if(e.path==="$editState"){e.label=w(n).getText("FILTERBAR_EDITING_STATUS")}e.typeConfig=C.getTypeConfig(e.dataType,e.formatOptions,e.constraints);e.label=A(e.label,n)||"";if(e.isParameter){d.push(e.name)}});f=u;g.setCustomData(n,"parameters",d);return f};function q(e,t){if(e.isA("sap.fe.macros.table.TableAPI")){const n=e.getMetaPath().split("#")[0].split("/");switch(n[n.length-1]){case`@${"com.sap.vocabularies.UI.v1.SelectionPresentationVariant"}`:case`@${"com.sap.vocabularies.UI.v1.PresentationVariant"}`:return t.getObject(e.getMetaPath()).Visualizations?.find(e=>e.$AnnotationPath.includes(`@${"com.sap.vocabularies.UI.v1.LineItem"}`)).$AnnotationPath;case`@${"com.sap.vocabularies.UI.v1.LineItem"}`:const n=e.getMetaPath().split("/");return n[n.length-1]}}return undefined}$._isFilterAdaptable=function(e,t,n,o){let i;const r=n?$._isFilterInSelectionFields(n,e):false;if(o){i=o.some(function(t){const n=t.Target?.$target;return n?.Data.some(function(t){if(t.Value.path===e.key){return true}return false})})}else{i=false}return r||i||!t.annotations?.UI?.AdaptationHidden};$._isFilterInSelectionFields=function(e,t){const n=t.key?.indexOf("::")>0?t.key?.replace("::","/"):t.key;return e.some(function(e){if(e.value===n){return true}return false})};$._addFlexItem=async function(e,t,n,i,r,a){const s=i?i.getId(t):t.getId(),c=i?"":"Adaptation",f=h.getConvertedFilterFields(t,undefined,undefined,n,r,i,i?undefined:q(t.getParent(),n)),d=$._findSelectionField(f,e),u=N(e),m=!!i&&i.targets==="xmlTree";if(e===B){return H(U(s,`${c}FilterField`),n,i)}else if(e===L){return Promise.resolve(null)}else if(d?.template){return $._templateCustomFilter(t,U(s,`${c}`),d,n,i)}if(d?.type==="Slot"&&i){return R(t,i,u)}const y=p.getNavigationPath(u);let P;let v;let C;let F;let x;return Promise.resolve().then(async function(){if(d?.isParameter){const e=d.annotationPath;return e.substring(0,e.lastIndexOf("/")+1)}return g.getCustomDataWithModifier(t,"entityType",i)}).then(async function(e){P=e;return g.getCustomDataWithModifier(t,"useSemanticDateRange",i)}).then(async function(e){v=e;const o=n.createBindingContext(P+u);const r=i?i.getId(t):t.getId();C={bindingContexts:{contextPath:n.createBindingContext(P),property:o},models:{contextPath:n,property:n},isXML:m};F=`/${l.getEntitySetPath(P).split("/").filter(l.filterOutNavPropBinding).join("/")}`;x={metaPath:o.getPath(),sPropertyName:u,sBindingPath:F,sValueHelpType:c+V,oControl:t,oMetaModel:n,oModifier:i,sIdPrefix:U(r,`${c}FilterField`,y),sVhIdPrefix:U(r,c+V),sNavigationPrefix:y,bUseSemanticDateRange:v,oSettings:d?.settings??{},visualFilter:d?.visualFilter,view:a};return g.doesValueHelpExist(x)}).then(async function(e){if(!e){return j({bindingContexts:{contextPath:n.createBindingContext(P),metaPath:C.bindingContexts.property},models:{contextPath:n,metaPath:n},isXML:m},x)}return}).then(async function(){return g.getCustomDataWithModifier(t,"localId",i)}).then(async function(e){let n;if(x.visualFilter){n=o.getTargetView(t).getController()._getPageModel()}return k(C,x,e,n)})};function G(e){if(e instanceof window.Element){return null}return g.getCustomData(e,_)}function J(e,t){if(e instanceof window.Element){return}g.setCustomData(e,_,t)}function z(e,t,n){let o=G(n);let i;if(!o){o=$.fetchPropertiesForEntity(e,t,n);o.forEach(function(e){i=null;if(e.groupLabel){i=A(e.groupLabel,n);e.groupLabel=i===null?e.groupLabel:i}});S(o);J(n,o)}return o}$.fetchProperties=async function(e){const t=await $.fetchFilterProperties(e);g.setCustomData(e,"feFilterInfo",t);if(t.length>0){return h.formatPropertyInfo(t)}else{return[]}};$.fetchFilterProperties=async function(e){const t=g.getCustomData(e,"entityType");return g.fetchModel(e).then(function(n){if(!n){return[]}return z(t,n.getMetaModel(),e)})};$.getTypeMap=function(){return C};return $},false);
//# sourceMappingURL=FilterBarDelegate.js.map