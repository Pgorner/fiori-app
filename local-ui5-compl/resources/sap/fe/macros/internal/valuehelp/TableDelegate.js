/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/EDM","sap/fe/macros/DelegateUtil","sap/fe/macros/internal/valuehelp/TableDelegateHelper","sap/ui/core/Element","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,a,r,n,o,i,s,l,p,c,g,f,d,u,h,y,m,b,P,M){"use strict";var C=f.isSortableProperty;var $=f.isFilterableProperty;var v=f.getPath;var I=c.isTypeFilterable;var T=p.getLabel;var D=p.getAssociatedUnitPropertyPath;var O=p.getAssociatedTimezonePropertyPath;var x=p.getAssociatedTextPropertyPath;var E=p.getAssociatedCurrencyPropertyPath;var F=l.getDisplayMode;var B=s.getTargetObjectPath;var S=s.enhanceDataModelPath;var j=o.isMultiValueFilterExpression;var w=o.getSortRestrictionsInfo;var A=o.getFilterRestrictionsInfo;var _=n.fetchTypeConfig;var R=r.getInvolvedDataModelObjects;const U=Object.assign({},u);U.fetchProperties=async function(e){const t=await this._getModel(e);const a=await this._createPropertyInfos(e,t);U.createInternalBindingContext(e);g.setCachedProperties(e,a);e.getBindingContext("internal").setProperty("tablePropertiesAvailable",true);return a};U.createInternalBindingContext=function(e){let t=e;while(t&&!t.isA("sap.ui.mdc.valuehelp.Dialog")){t=t.getParent()}const a=e.getModel("internal");if(t&&a){const r=t.getBindingContext("internal");let n;if(r){n=r.getPath()+`::VHDialog::${t.getId()}::table`}else{n=`/buildingblocks/${e.getId()}`;a.setProperty("/buildingblocks",{...a.getProperty("/buildingblocks")})}const o=a.bindContext(n).getBoundContext();e.setBindingContext(o,"internal")}};function N(e){const t=V(e);const a={};if(t?.targetObject){const r=t.targetObject;const n=B(t,true);const o=e.targetObject;const i=B(e,true);const s=o.annotations?.Common?.Text,l=s?.annotations?.UI?.TextArrangement?.toString(),p=s&&l&&F(o);if(p==="Description"){a[n]=r}else if(p&&p!=="Value"||!s){a[i]=o;a[n]=r}}return a}U._createPropertyInfos=async function(e,t){const a=e.getDelegate().payload;const r=[];const n=`/${a.collectionName}`;const o=t.getMetaModel();return o.requestObject(`${n}@`).then(function(t){const a=w(t);const o=t["@Org.OData.Capabilities.V1.FilterRestrictions"];const i=A(o);const s=g.getCustomData(e,"columns");const l={};const p=R(e.getModel().getMetaModel().getContext(n));s.customData.forEach(function(t){const n={name:t.path,label:t.label,sortable:C(a,t),filterable:$(i,t),maxConditions:H(i,t),typeConfig:I(t.$Type)?e.getTypeMap().getTypeConfig(t.$Type):undefined};const o=S(p,t.path);const s=o.targetObject;if(s){const a=B(o,true);let r;if(I(s.type)){const a=_(s);r=h.getTypeConfig(a.type??"",a.formatOptions,a.constraints)??e.getTypeMap().getTypeConfig(t.$Type)}const i=N(o);const p=Object.keys(i);if(p.length){n.propertyInfos=p;n.sortable=false;n.filterable=false;p.forEach(e=>{l[e]=i[e]});if(!p.find(e=>i[e]===s)){l[a]=s}}else{n.path=t.path}n.typeConfig=n.typeConfig?r:undefined}else{n.path=t.path}r.push(n)});const c=k(l,r,a,i);return r.concat(c)})};U.updateBindingInfo=function(e,t){u.updateBindingInfo.apply(this,[e,t]);const r=e.getDelegate().payload;if(r){t.path=t?.path||r.collectionPath||`/${r.collectionName}`}t.parameters=t.parameters||{};const n=d.getElementById(e.getFilter()),o=e.isFilteringEnabled();let s;let l,p;const c=[];const f=g.getCachedProperties(e);if(o){s=e.getConditions();l=m.getFilterInfo(e,s,f,[]);if(l.filters){c.push(l.filters)}}const h=!!r?.hierarchyQualifier;if(h){t.parameters.$$aggregation={hierarchyQualifier:r.hierarchyQualifier,expandTo:r.initialExpansionLevel}}if(n){s=n.getConditions();if(s){const a=y.getParameterNames(n);U._updatePropertyInfo(f,e,s,r);p=m.getFilterInfo(n,s,f,a);if(p.filters){c.push(p.filters)}const o=y.getParametersInfo(n,s);if(o){t.path=o}}if(!h){t.parameters.$search=a.normalizeSearchTerm(n.getSearch())||undefined}else if(n.getSearch()){if(!t.parameters.$$aggregation){t.parameters.$$aggregation={}}t.parameters.$$aggregation.search=a.normalizeSearchTerm(n.getSearch());t.parameters.$$aggregation.expandTo=Number.MAX_SAFE_INTEGER}}t.parameters.$$sharedRequest=false;this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=f?.reduce(function(e,t){if(t.path&&!t.path.includes("/")){e=e?`${e},${t.path}`:t.path}return e},"");t.parameters.$count=true;if(t.path&&i.isDraftSupported(e.getModel()?.getMetaModel(),t.path)){c.push(new b("IsActiveEntity",P.EQ,true))}t.filters=new b(c,true)};U.getTypeMap=function(){return h};U._getModel=async function(e){const t=e.getDelegate().payload;let a=e.getModel(t.model);if(!a){await new Promise(t=>{e.attachEventOnce("modelContextChange",t)});a=e.getModel(t.model)}return a};U._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.parameters.$$aggregation?.search==undefined&&e.sorter&&e.sorter.length==0){const a=t?t.defaultSortPropertyName:undefined;if(a){e.sorter.push(new M(a,false))}}};U._updatePropertyInfo=function(e,t,a,r){const n=Object.keys(a),o=t.getModel().getMetaModel();n.forEach(function(a){if(e.findIndex(function(e){return e.path===a})===-1){const n={name:a,path:a,typeConfig:t.getTypeMap().getTypeConfig(o.getObject(`/${r.collectionName}/${a}`).$Type)};e.push(n)}})};U.updateBinding=function(a,r,n){let o=false;const i=a.getBindingContext("internal");const s="pendingManualBindingUpdate";const l="lastSearch";const p="lastFilter";const c=i?.getProperty(s);const g=i?.getProperty(l);const f=i?.getProperty(p);let d=a.getRowBinding();u.updateBinding.apply(U,[a,r,n]);if(!d){d=a.getRowBinding()}if(d){o=i?t(r.filters,f)&&r.parameters?.$search===g&&!c:true}i?.setProperty(l,r.parameters?.$search);i?.setProperty(p,r.filters);if(o&&a.getFilter()){i?.setProperty(s,true);d.requestRefresh(d.getGroupId()).finally(function(){i?.setProperty(s,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}a.fireEvent("bindingUpdated")};function k(e,t,a,r){const n={},o=[];Object.keys(e).forEach(i=>{const s=e[i],l=t.find(e=>e.path===i);if(!l){const e=`Property::${i}`;n[i]=e;const t={name:e,label:T(s),path:i,sortable:C(a,s),filterable:$(r,s)};t.maxConditions=H(r,t);if(I(s.type)){const e=_(s);t.typeConfig=h.getTypeConfig(e.type??"",e.formatOptions,e.constraints)}o.push(t)}});t.forEach(e=>{if(e.propertyInfos){e.propertyInfos=e.propertyInfos?.map(e=>n[e]??e)}});return o}function H(e,t){const a=v(t);return a&&e.propertyInfo?.hasOwnProperty(a)&&j(e.propertyInfo[a])?-1:1}function V(e){const t=e.targetObject;const a=t&&(x(t)||E(t)||D(t)||O(t));if(!a){return undefined}const r=S(e,a);const n=r.targetObject;if(!n){return undefined}return r}return U},false);
//# sourceMappingURL=TableDelegate.js.map