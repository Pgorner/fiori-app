/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/BindingToolkit","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/ODataOperation","sap/fe/core/controllerextensions/editFlow/editFlowConstants","sap/fe/core/controllerextensions/editFlow/operations/facade","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/library","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/FieldControlHelper","sap/fe/core/templating/PropertyHelper","sap/fe/macros/field/FieldHelper","sap/fe/macros/internal/valuehelp/ValueHelpTemplating","sap/m/Button","sap/m/Dialog","sap/m/Label","sap/m/MessageBox","sap/ui/core/Messaging","sap/ui/core/message/MessageType","sap/ui/layout/form/SimpleForm","sap/ui/mdc/Field","sap/ui/mdc/MultiValueField","sap/ui/mdc/ValueHelp","sap/ui/mdc/enums/FieldEditMode","sap/ui/mdc/field/MultiValueFieldItem","sap/ui/mdc/valuehelp/Dialog","sap/ui/mdc/valuehelp/Popover","sap/ui/mdc/valuehelp/content/MTable","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/AnnotationHelper","sap/fe/base/jsx-runtime/jsx","sap/fe/base/jsx-runtime/Fragment","sap/fe/base/jsx-runtime/jsxs"],function(e,t,a,s,i,n,r,o,l,c,d,u,h,m,g,p,f,M,P,x,v,C,y,E,O,A,b,F,T,H,w,I,D,V,_,N,S,L,B,R){"use strict";var U={};var j=x.useCaseSensitiveFilterRequests;var $=x.requiresValidation;var k=M.isMultiLineText;var q=M.hasValueHelp;var G=f.isReadOnlyExpression;var W=f.isDisabledExpression;var K=f.isActionParameterRequiredExpression;var z=p.getTargetNavigationPath;var Q=m.isPathAnnotationExpression;var J=h.generate;var Y=u.getResourceModel;var X=c.getInvolvedDataModelObjects;var Z=c.convertTypes;var ee=t.not;var te=t.ifElse;var ae=t.getExpressionFromAnnotation;var se=t.equal;var ie=t.constant;var ne=t.compileExpression;let re=function(){function t(e,t,a,s,i,n,r,o,l,c){this.buttonLock=false;this.actionParameterInfos=[];this.result=[];this.parameterModel=new N({$displayMode:{}});this.action=e;this.actionContext=t;this.parameters=a;this.parameterValues=s;this.entitySetName=i;this.view=n;this.messageHandler=r;this.strictHandlingUtilities=o;this.callbacks=l;this.ignoreETag=c;this.actionName=this.action.isBound?this.action.fullyQualifiedName.replace(/\(.*\)$/g,""):this.action.name;this.metaModel=t.getModel();this.dialogPromise=new Promise((e,t)=>{this._fnResolve=e;this._fnReject=t});this.resourceModel=this.view?Y(this.view):Y(this.parameters.appComponent)}U=t;var c=t.prototype;c.getParameterEditMode=function e(t){const a=t.annotations,s=a.Common?.FieldControl,i=a.Core?.Immutable?.valueOf(),n=a.Core?.Computed?.valueOf();if(i||n){return ie(w.ReadOnly)}else if(s){return te(G(t),w.ReadOnly,te(W(t),w.Disabled,w.Editable))}return ie(w.Editable)};c.createFormElement=async function e(t){const a=this.metaModel.getMetaPath(this.actionContext.getPath());const i=this.metaModel.createBindingContext(s.getParameterPath(a,t.name));const n=await(t.isCollection?this.createMultiField(t,i):this.createField(t,i));return R(B,{children:[L(y,{id:J(["APD_",t.name,"Label"]),text:t.annotations.Common?.Label?this.resourceModel.getText(t.annotations.Common.Label.toString()):t.name}),n]})};c.createMultiField=async function e(t,a){const s=await P.getAPDialogDisplayFormat(a.getObject(),{context:a});return L(T,{id:J(["APD_",t.name]),placeholder:t.annotations.UI?.Placeholder,items:{path:`mvfview>/${t.name}`},delegate:{name:"sap/fe/core/controls/MultiValueParameterDelegate"},display:s,editMode:this.getParameterEditMode(t),width:"100%",multipleLines:t.annotations.UI?.MultiLineText?.valueOf()===true,required:ne(K(t,this.action,Z(this.metaModel))),valueHelp:q(t)?J([this.actionName,t.name]):undefined,change:async e=>this.handleFieldChange(e,t),visible:ne(ee(se(ae(t.annotations?.UI?.Hidden),true))),ariaLabelledBy:[J(["APD_",t.name,"Label"])],dependents:this.createParameterDialogValueHelp(t,a),children:L(I,{description:"{mvfview>Desc}"},"{path: 'mvfview>Key', type:'sap.ui.model.type.String'}")})};c.createField=async function e(t,a){const s=await P.getAPDialogDisplayFormat(a.getObject(),{context:a});return L(F,{delegate:{name:"sap/fe/macros/field/FieldBaseDelegate",payload:{retrieveTextFromValueList:true}},id:J(["APD_",t.name]),value:S.format(a.getObject(),{context:a}),placeholder:t.annotations.UI?.Placeholder,display:s,editMode:this.getParameterEditMode(t),width:"100%",multipleLines:k(t),required:ne(K(t,this.action,Z(this.metaModel))),change:async e=>this.handleFieldChange(e,t),valueHelp:q(t)?J([this.actionName,t.name]):undefined,dependents:this.createParameterDialogValueHelp(t,a),visible:ne(te(t.name==="ResultIsActiveEntity",false,ee(se(ae(t.annotations?.UI?.Hidden),true)))),ariaLabelledBy:[J(["APD_",t.name,"Label"])]})};c.createParameterDialogValueHelp=function e(t,a){if(!q(t)){return undefined}return L(H,{id:J([this.actionName,t.name]),delegate:{name:"sap/fe/macros/valuehelp/ValueHelpDelegate",payload:{propertyPath:this.action.isBound?`${z(X(a))}/${this.actionName}/${t.name}`:`/${this.action.name.substring(this.action.name.lastIndexOf(".")+1)}/${t.name}`,qualifiers:{},valueHelpQualifier:""}},validateInput:$(t),typeahead:L(V,{children:L(_,{id:J([this.actionName,t.name,"Popover","qualifier"]),caseSensitive:this.action.isBound?j(X(a),Z(this.metaModel).entityContainer.annotations.Capabilities?.FilterFunctions??[]):false,useAsValueHelp:!!t.annotations.Common?.ValueListWithFixedValues})}),dialog:this.createFieldVHDialog(t)})};c.createFieldVHDialog=function e(t){if(t.annotations.Common?.ValueListWithFixedValues?.valueOf()!==true){return L(D,{})}else{return undefined}};c.handleFieldChange=async function e(t,s){const i=t.getParameter("promise");const n=t.getSource();const r=this.actionParameterInfos.find(e=>e.field===n);if(!r){return}r.validationPromise=i;this.removeMessagesForParameter(s);try{r.value=await i;this.parameters.defaultParametersValues[r.parameter.name]=r.value;r.hasError=false}catch(e){delete r.value;r.hasError=true;a._addMessageForActionParameter([{actionParameterInfo:r,message:e.message}])}};c.removeMessagesForParameter=function e(t){const a=O.getMessageModel().getData();const s=J(["APD_",t.name]);const i=a.filter(e=>e.getControlIds().some(e=>s.split("-").includes(e)));O.removeMessages(i)};c.getFormElements=async function e(t){const a=await this.createFormElement(t);return{formElements:a,parameter:t}};c.createDialog=async function e(){const t=this.action.isBound?this.action.parameters.slice(1):this.action.parameters;const a=await Promise.all(t.map(this.getFormElements.bind(this)));const s=a.map(e=>e.formElements);this.registerActionParameterInfo(a);const i=L(v,{id:J(["fe","APD_",this.actionName,"Action","Cancel"]),text:this.resourceModel.getText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL"),press:this.close.bind(this)});const n=L(C,{title:this.getTitleText(this.parameters.label),id:J(["fe","APD_",this.actionName]),escapeHandler:this.close.bind(this),afterClose:this.afterClose.bind(this),beforeOpen:this.beforeOpen.bind(this),afterOpen:()=>{this.afterOpen()},initialFocus:i,children:{beginButton:L(v,{id:J(["fe","APD_",this.actionName,"Action","Ok"]),text:this.parameters.isCreateAction?this.resourceModel.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON_CONTINUE"):this.getBeginButtonLabel(this.parameters.label),press:()=>{this.onApply.bind(this)()},type:"Emphasized"}),endButton:i,content:L(b,{binding:"$Parameter",children:{content:s}})}});this.dialog=n;return n};c.getBeginButtonLabel=function e(t){const a="ACTION_PARAMETER_DIALOG_ACTION_NAME";const s="C_COMMON_DIALOG_OK";return this.getOverriddenText(a,s,t)};c.getTitleText=function e(t){const a="ACTION_PARAMETER_DIALOG_ACTION_TITLE";const s="C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE";return this.getOverriddenText(a,s,t)};c.getOverriddenText=function e(t,a,s){let i=this.actionName;i=i.split(".").pop()??i;const n=i&&this.entitySetName?`${this.entitySetName}|${i}`:"";if(s){if(this.resourceModel.checkIfResourceKeyExists(`${t}|${n}`)){return this.resourceModel.getText(t,undefined,n)}else if(this.resourceModel.checkIfResourceKeyExists(`${t}|${this.entitySetName}`)){return this.resourceModel.getText(t,undefined,`${this.entitySetName}`)}else if(this.resourceModel.checkIfResourceKeyExists(`${t}`)){return this.resourceModel.getText(t)}else{return s}}else{return this.resourceModel.getText(a)}};c.onApply=async function e(){if(this.buttonLock||!this.dialog){return}const t=this.dialog;const s={...this.parameters};const n=t.getObjectBinding()?.getParameterContext();const o=Object.assign({},...this.actionParameterInfos.map(e=>{const a=e.parameter;const s=a.isCollection?Object.values(t.getModel("mvfview").getProperty(`/${a.name}`)??{}).map(e=>e?.Key):n?.getProperty(a.name);return{[a.name]:s}}));const l=Object.values(o).some(e=>!!e);s.label=this.parameters.label;this.buttonLock=true;i.lock(t);if(!await a.validateProperties(this.actionParameterInfos,this.resourceModel)){i.unlock(this.dialog);this.buttonLock=false;return}s.defaultParametersValues=o;this.parameters.appComponent.getModel("ui").setProperty(r.DocumentModified,l);this.messageHandler.removeTransitionMessages();const{errorOnFirstIteration:c,failedContexts:d}=await this.executeActionOnApply(s);if(c){const e=await this.manageMessageOnApply(d);this.buttonLock=false;if(e){if(t.isOpen()){this.updateDialogBindingContextForError(this.parameters.aContexts)}else{this._fnReject(c)}}}this.afterOnApply()};c.updateDialogBindingContextForError=function e(t){if(t.length<2){return}let a,s;const i=t.find(e=>{const t=e.getMessages();return t.some(t=>{a=!a&&t.getType()===A.Warning?e:undefined;s=!s&&t.getType()===A.Information?e:undefined;return t.getType()===A.Error})});const n=i??a??s;if(n){this.dialog?.setBindingContext(n)}};c.executeActionOnApply=async function e(t){let a;let s=[];const i=this.dialog;try{this.result=await this.executeAction(t,this.parameters.aContexts,false);if(this.result.find(e=>e.status==="rejected")){throw new Error("At least one action failed")}this.close()}catch(e){if(this.strictHandlingUtilities.is412Executed&&this.strictHandlingUtilities.strictHandlingTransitionFails.length){this.strictHandlingUtilities.delaySuccessMessages=this.strictHandlingUtilities.delaySuccessMessages.concat(O.getMessageModel().getData())}a=e}if(this.strictHandlingUtilities.is412Executed&&this.strictHandlingUtilities.strictHandlingTransitionFails.length){try{s=this.strictHandlingUtilities.strictHandlingTransitionFails.map(e=>e.oAction.getContext());t.aContexts=s;this.result=await this.executeAction(t,this.parameters.aContexts,true);if(this.result.find(e=>e.status==="rejected")){throw new Error("At least one action failed on the second iteration")}}catch{const e=i.isOpen();if(this.strictHandlingUtilities.is412Executed&&this.strictHandlingUtilities.strictHandlingTransitionFails.length){O.addMessages(this.strictHandlingUtilities.delaySuccessMessages)}await this.messageHandler.showMessageDialog({isActionParameterDialogOpen:e,forceShowUIElement:e,onBeforeShowMessage:(e,a)=>this.callbacks.beforeShowingMessage(t,this.parameters.aContexts,i,e,a,!!this.parameters.bGrouped&&(!!this.strictHandlingUtilities.strictHandlingPromises.length||l.hasTransitionErrorsOrWarnings())),aSelectedContexts:undefined,sActionName:this.parameters.label})}}return{errorOnFirstIteration:a,failedContexts:s}};c.manageMessageOnApply=async function e(t){const a=this.dialog;let s=true;const i=!!(this.parameters.bGrouped&&(this.strictHandlingUtilities.strictHandlingPromises.length||l.hasTransitionErrorsOrWarnings()));await this.messageHandler.showMessages({context:t[0],isActionParameterDialogOpen:a.isOpen(),forceShowUIElement:a.isOpen(),messagePageNavigationCallback:()=>{this.close()},onBeforeShowMessage:(e,t)=>{const n=this.callbacks.beforeShowingMessage(this.parameters,this.parameters.aContexts,a,e,t,i);s=n.showMessageDialog;return n},aSelectedContexts:undefined,sActionName:this.parameters.label,control:a.getParent()});return s};c.afterOnApply=function e(){this.messageHandler.clearStrictWarningMessages();this.strictHandlingUtilities={is412Executed:false,strictHandlingTransitionFails:[],strictHandlingPromises:[],strictHandlingWarningMessages:[],delaySuccessMessages:[],processedMessageIds:new Set};if(this.dialog&&i.isLocked(this.dialog)){i.unlock(this.dialog)}};c.executeAction=async function e(t,a,s){const i=this.dialog;const r=await new n(this.action,t,this.messageHandler,this.strictHandlingUtilities,{ignoreETag:this.ignoreETag}).execute();const o=O.getMessageModel().getData();const c=this.strictHandlingUtilities.is412Executed&&this.strictHandlingUtilities.strictHandlingTransitionFails.length;const d=!!this.parameters.bGrouped&&(this.strictHandlingUtilities.strictHandlingPromises.length>0||l.hasTransitionErrorsOrWarnings());let u=o.length>0;if(c){if(!s){this.strictHandlingUtilities.delaySuccessMessages=this.strictHandlingUtilities.delaySuccessMessages.concat(o);u=false}else{O.addMessages(this.strictHandlingUtilities.delaySuccessMessages)}}if(u){i.attachEventOnce("afterClose",()=>{const e=i.isOpen();this.messageHandler.showMessageDialog({isActionParameterDialogOpen:c?undefined:e,forceShowUIElement:c?undefined:e,onBeforeShowMessage:(e,s)=>this.callbacks.beforeShowingMessage(t,a,i,e,s,d,true),control:i.getParent(),aSelectedContexts:t.aContexts,sActionName:t.label})})}return r};c.close=function e(){if(this.dialog){this.dialog.close()}};c.openDialog=async function e(t){if(!this.dialog){throw new Error("Error on opening the dialog")}await s.setUserDefaults(this.parameters.appComponent,this.actionParameterInfos.map(e=>e.parameter),this.parameterModel,true);this.setModels(this.dialog);t.addDependent(this.dialog);await this.setOperationDefaultValues(this.dialog);this.dialog.open();return this.dialogPromise};c.setModels=function e(t){t.setModel(this.parameterModel,"paramsModel");t.bindElement({path:"/",model:"paramsModel"});t.setModel(this.parameters.model);t.bindElement({path:`${this.parameters.aContexts.length?"":"/"}${this.actionName}(...)`});if(this.parameters.aContexts.length){t.setBindingContext(this.parameters.aContexts[0])}t.setModel(new N({}),"mvfview")};c.beforeOpen=function e(t){this.messageHandler.removeTransitionMessages()};c.getParameterDefaultValue=async function t(a,i,n){const r=n.getObjectBinding();const o=this.parameterModel.getData();const l=a.name;const c=a.annotations.UI?.ParameterDefaultValue;if(c){if(this.parameters.aContexts.length>0&&Q(c)){try{const e=i&&c.path.startsWith(`${i}/`)?c.path.replace(`${i}/`,""):c.path;let t=await s.requestSingletonProperty(c.path,r.getModel());if(t===null){t=await r.getParameterContext().requestProperty(c.path)}if(this.parameters.aContexts.length>1){if(this.parameters.aContexts.some(a=>a.getProperty(e)!==t)){return{paramName:l,value:undefined,noPossibleValue:true}}}return{paramName:l,value:t}}catch(t){e.error("Error while reading default action parameter",l,this.action.name);return{paramName:l,value:undefined,latePropertyError:true}}}else{return{paramName:l,value:c.valueOf()}}}return{paramName:l,value:o[l]}};c.getManifestFunctionValues=async function e(){const t=this.dialog?.getBindingContext();if(!this.view||!this.parameters.defaultValuesExtensionFunction||!t){return{}}return d.loadModuleAndCallMethod(this.parameters.defaultValuesExtensionFunction.substring(0,this.parameters.defaultValuesExtensionFunction.lastIndexOf(".")||-1).replace(/\./gi,"/"),this.parameters.defaultValuesExtensionFunction.substring(this.parameters.defaultValuesExtensionFunction.lastIndexOf(".")+1,this.parameters.defaultValuesExtensionFunction.length),this.view,t,this.parameters.aContexts)};c.getPreDefinedValues=async function t(a,s){const i=this.action.annotations.Common?.DefaultValuesFunction?.valueOf();let n=Promise.resolve({});let r=[];if(this.action.isBound){if(typeof i==="string"){r=this.parameters.aContexts.map(async e=>o.callBoundFunction(i,e,e.getModel()))}if(this.parameters.aContexts.length>0){n=this.parameters.aContexts[0].requestObject()}}try{const e=await n;const t=await Promise.all([Promise.all(this.actionParameterInfos.map(async e=>this.getParameterDefaultValue(e.parameter,a,s))),Promise.all(r),this.getManifestFunctionValues()]);return{contextValues:e,defaultValues:t[0],functionValues:t[1],manifestFunctionValues:t[2]}}catch(t){e.error("Error while retrieving the parameter",t);this.messageHandler.removeTransitionMessages();return{contextValues:{},defaultValues:[],functionValues:[],manifestFunctionValues:{}}}};c.afterOpen=function e(){const t=this.actionParameterInfos.find(e=>e.field.getVisible());if(t){const e=t?.field;const a=e?.getFocusInfo();a.targetInfo={silent:true};e?.focus(a)}};c.registerActionParameterInfo=function e(t){t.forEach(e=>{const t=e?.parameter;const a=e?.formElements?.[1];this.actionParameterInfos.push({parameter:t,field:a,isMultiValue:t.isCollection,hasError:false})})};c.setOperationDefaultValues=async function e(t){const a=this.action.isBound?this.action.parameters[0].name:"";const{contextValues:s,defaultValues:i,functionValues:n,manifestFunctionValues:r}=await this.getPreDefinedValues(a,t);const o=t.getObjectBinding();if(a){o.setParameter(a,s)}for(const e in this.actionParameterInfos){if(this.actionParameterInfos[e].parameter.name!=="ResultIsActiveEntity"){const t=this.actionParameterInfos[e].parameter.name;const a=this.parameterValues?.find(e=>e.name===t)?.value;if(a){o.setParameter(t,a)}else if(r.hasOwnProperty(t)){o.setParameter(t,r[t])}else if(i[e]&&i[e].value!==undefined){o.setParameter(t,i[e].value)}else if(this.action.annotations.Common?.DefaultValuesFunction&&!i[e].noPossibleValue){const e=new Set(this.parameters.aContexts.map((e,a)=>n[a].getObject(t)));if(e.size===1){o.setParameter(t,Array.from(e)[0])}}}}if(i.some(e=>e.latePropertyError)){const e=this.resourceModel.getText("C_COMMON_SAPFE_REFRESH");E.warning(Y(this.parameters.appComponent).getText("C_APP_COMPONENT_SAPFE_ETAG_LATE_PROPERTY"),{actions:[e,E.Action.OK],emphasizedAction:e,onClose:t=>{if(t===e){const e=this.view?.getController().getExtensionAPI();e.refresh()}},contentWidth:"25em"})}};c.afterClose=function e(t){const a=t.getParameter("origin");for(const e in this.actionParameterInfos){this.removeMessagesForParameter(this.actionParameterInfos[e].parameter)}if(a===null||a===this.dialog?.getEndButton()){this._fnReject(g.Constants.CancelActionDialog)}else{this._fnResolve(this.result)}this.dialog?.destroy();this.buttonLock=false};return t}();U=re;return U},false);
//# sourceMappingURL=ParameterDialog.js.map