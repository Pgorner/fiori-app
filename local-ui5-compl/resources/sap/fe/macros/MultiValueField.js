/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/base/ClassSupport","sap/fe/core/helpers/BindingHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyFormatters","sap/fe/core/templating/UIFormatters","sap/fe/macros/field/FieldHelper","sap/fe/macros/field/FieldTemplating","sap/fe/macros/internal/valuehelp/ValueHelpTemplating","sap/ui/core/CustomData","sap/ui/mdc/MultiValueField","sap/ui/mdc/field/MultiValueFieldItem","sap/fe/core/buildingBlocks/BuildingBlock","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controls/FormElementWrapper","sap/fe/core/formatters/CollaborationFormatter","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/PropertyHelper","sap/fe/macros/multivaluefield/FormatOptions","sap/m/Avatar","sap/m/HBox","sap/ui/base/Event","sap/ui/core/Element","./ValueHelp","./field/FieldRuntime","sap/fe/base/jsx-runtime/jsx"],function(t,e,i,a,o,n,r,l,s,d,c,u,h,p,f,g,b,m,y,P,v,M,x,C,E,I,O,F){"use strict";var D,_,w,B,z,S,V,j,H,$,L,T,G,A,k,R,U,N,Q,q,W,J,K,X,Y;var Z={};var tt=P.hasValueHelp;var et=g.CollaborationFieldGroupPrefix;var it=d.getVisibleExpression;var at=d.getValueBinding;var ot=l.getDisplayMode;var nt=l.getCollaborationExpression;var rt=n.isPathInsertable;var lt=n.isPathDeletable;var st=n.getTargetObjectPath;var dt=n.getRelativePaths;var ct=n.getContextRelativeTargetObjectPath;var ut=n.enhanceDataModelPath;var ht=o.isPropertyPathExpression;var pt=o.isProperty;var ft=o.isPathAnnotationExpression;var gt=o.isMultipleNavigationProperty;var bt=i.UI;var mt=e.property;var yt=e.implementInterface;var Pt=e.defineUI5Class;var vt=e.association;var Mt=e.aggregation;var xt=t.or;var Ct=t.not;var Et=t.isConstant;var It=t.ifElse;var Ot=t.getExpressionFromAnnotation;var Ft=t.constant;var Dt=t.compileExpression;var _t=t.and;function wt(t,e,i,a){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(a):void 0})}function Bt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,zt(t,e)}function zt(t,e){return zt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},zt(t,e)}function St(t,e,i,a,o){var n={};return Object.keys(a).forEach(function(t){n[t]=a[t]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=i.slice().reverse().reduce(function(i,a){return a(t,e,i)||i},n),o&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(o):void 0,n.initializer=void 0),void 0===n.initializer?(Object.defineProperty(t,e,n),null):n}function Vt(t,e){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let jt=(D=Pt("sap.fe.macros.MultiValueField"),_=yt("sap.ui.core.IFormContent"),w=mt({type:"string"}),B=vt({type:"string"}),z=vt({type:"string"}),S=mt({type:"string",required:true}),V=mt({type:"boolean",required:false}),j=mt({type:"string"}),H=mt({type:"any",isBindingInfo:true}),$=Mt({type:"sap.fe.macros.multivaluefield.FormatOptions",multiple:false,defaultClass:v}),L=mt({type:"boolean"}),T=mt({type:"boolean"}),D(G=(A=function(t){function e(e,i){var a;if(typeof e!=="string"){e._isInEditMode=Dt(bt.IsEditable)}a=t.call(this,e,i)||this;wt(a,"__implements__sap_ui_core_IFormContent",k,a);wt(a,"id",R,a);wt(a,"idPrefix",U,a);wt(a,"vhIdPrefix",N,a);wt(a,"metaPath",Q,a);wt(a,"readOnly",q,a);wt(a,"contextPath",W,a);wt(a,"items",J,a);wt(a,"formatOptions",K,a);wt(a,"_isInEditMode",X,a);wt(a,"useParentBindingCache",Y,a);return a}Z=e;Bt(e,t);var i=e.prototype;i._overrideValue=function t(e,i,a,o,n){if(this.items){const t=this.items.model??this.items.modelName;e={path:`${t}>${this.items.path}`};i={path:`${t}>${this.items.path}`};const r=a.targetObject;const l=`{${t}>${r.name}}`;if(ft(r.annotations.Common?.Text)){o=`{${t}>${r.annotations.Common?.Text?.path}}`}else{o=l}n=l}return{description:o,collectionBindingDisplay:e,collectionBindingEdit:i,key:n}};i._getMultiInputSettings=function t(i,a){const{collectionPath:o,itemDataModelObjectPath:n}=e._getPathStructure(i);const r={path:o,templateShareable:false};const l=this.useParentBindingCache?{path:o,templateShareable:false}:{path:o,parameters:{$$ownRequest:true},templateShareable:false};const s=i.targetObject;const d=ht(s)?s.$target:s;const c=d?.annotations.Common?.Text;const u=dt(i);const h=c?Dt(Ot(c,u)):at(n,a??{},true);const p=at(n,a??{},true);let f=false;if(dt(n).length>0){f=true}return{displayOnly:f,...this._overrideValue(r,l,n,h,p)}};e._getPathStructure=function t(e){let i="";const a=e.contextLocation?.targetEntitySet?e.contextLocation.targetEntitySet:e.startingEntitySet;const o=[];const n=e.contextLocation?.navigationProperties||[];for(const t of e.navigationProperties){if(e.contextLocation===undefined||!e.contextLocation.navigationProperties.some(e=>e.fullyQualifiedName===t.fullyQualifiedName)){o.push(t.name);n.push(t);if(a.navigationPropertyBinding.hasOwnProperty(t.name)){if(gt(t)){break}}}}i=`${o.join("/")}`;const r=Object.assign({},e);if(r.contextLocation){r.contextLocation.navigationProperties=n}return{collectionPath:i,itemDataModelObjectPath:r}};i.computeFieldGroupIds=function t(e){if(!e){return""}const i=e.getSideEffectsService();const a=i.computeFieldGroupIds(this.dataModelPath.targetEntityType.fullyQualifiedName,this.dataModelPath.targetObject.fullyQualifiedName);if(this.collaborationEnabled){const t=`${et}${this.dataSourcePath}`;a.push(t)}this.fieldGroupIds=a.length?a.join(","):undefined;const o=a.join(",");return o===""?undefined:o};i.initialize=function t(e){const i=this._getOwner();this.contextPath=this.contextPath??i?.preprocessorContext?.fullContextPath;const a=i?.getMetaModel();const o=a?.createBindingContext(e.getPath());const n=e?.getTarget();if(pt(n)&&n.annotations.UI?.DataFieldDefault!==undefined){this.enhancedMetaPath=a?.createBindingContext(`@${"com.sap.vocabularies.UI.v1.DataFieldDefault"}`,o)}else{this.enhancedMetaPath=o}const r=this.getDataModelObjectForMetaPath(this.enhancedMetaPath.getPath(),this.contextPath);this.convertedDataField=r.targetObject;this.dataModelPath=ut(r,this.convertedDataField.Value.path);this.dataSourcePath=st(this.dataModelPath);this.property=this.dataModelPath.targetObject;let l=rt(this.dataModelPath);const s=lt(this.dataModelPath,{ignoreTargetCollection:true,authorizeUnresolvable:true});const d=lt(this.dataModelPath);let c=It(s._type==="Unresolvable",xt(Ct(Et(d)),d),d);if(this.items){l=c=Ft(!this.readOnly)}else{this.visible=it(this.dataModelPath,this.formatOptions)}this.collaborationExpression=Ft(false);this.computeCollaborationProperties();if(this.formatOptions?.displayOnly===true||this.readOnly===true){this.editMode="Display"}else{this.editMode=Dt(It(_t(l,c,bt.IsEditable),It(this.collaborationExpression,Ft("ReadOnly"),Ft("Editable")),Ft("Display")))}this.displayMode=ot(this.dataModelPath);const u=ut(this.getDataModelObjectForMetaPath(this.enhancedMetaPath.getPath(),this.contextPath),this.convertedDataField.Value.path);this.item=this._getMultiInputSettings(u,this.formatOptions);if(this.item.displayOnly){this.editMode="Display"}this.collection=this.editMode==="Display"?this.item.collectionBindingDisplay:this.item.collectionBindingEdit;const h=this.getAppComponent();this.fieldGroupIds=this.computeFieldGroupIds(h)};i.onMetadataAvailable=function t(){if(!this.content){this.content=this.createContent()}};i.isCollaborationDraftSupported=function t(){const e=this._getOwner();const i=e?.getMetaModel();return y.isCollaborationDraftSupported(i)};i.computeCollaborationProperties=function t(){if(this.isCollaborationDraftSupported()&&this.editMode!=="Display"){this.collaborationEnabled=true;this.collaborationExpression=l.getCollaborationExpression(this.dataModelPath,m.hasCollaborationActivity);this.collaborationInitialsExpression=Dt(nt(this.dataModelPath,m.getCollaborationActivityInitials));this.collaborationColorExpression=Dt(nt(this.dataModelPath,m.getCollaborationActivityColor))}};i.getPossibleValueHelp=function t(){const e=this.dataModelPath.targetObject;if(this.id&&pt(e)&&tt(e)){return F(I,{idPrefix:this.vhIdPrefix,metaPath:ct(this.dataModelPath),contextPath:this.contextPath,useMultiValueField:true})}};i.createContent=function t(){const e=this.getMetaPathObject(this.metaPath,this.contextPath);if(e){this.initialize(e);if(this.id){this.vhIdPrefix=a.generate([this.getId(),this.vhIdPrefix??"FieldValueHelp"])}else if(!this.vhIdPrefix){this.vhIdPrefix=this.createId("FieldValueHelp")}const t=this._getOwner()?.getRootController();const i=t.getView();const o=this._getOwner()?.getMetaModel();const n=o?.createBindingContext(e.getPath());const l=o?.createBindingContext(e.getContextPath());if(!n||!l){return}const d=s.valueHelpProperty(n);const f=o?.createBindingContext(d,n);const g=this.collection;const m=s.computeLabelText(this.convertedDataField.Value,{context:n});const y=this.getPossibleValueHelp();let P;if(y&&y.getContent()){P=y.getContent().getId()}else{P=c.generateID(undefined,this.vhIdPrefix,r.getRelativePropertyPath(f,{context:l}),ct(this.dataModelPath)??"")}const v=F(h,{id:this.createId("_mvf"),delegate:{name:"sap/fe/macros/multivaluefield/MultiValueFieldDelegate"},items:g,display:this.displayMode,width:"100%",editMode:this.editMode,valueHelp:P,ariaLabelledBy:this.ariaLabelledBy?this.ariaLabelledBy:[],showEmptyIndicator:this.formatOptions?.showEmptyIndicator,label:m,change:O.handleChangeMultiValueField.bind(O,t),fieldGroupIds:this.fieldGroupIds,validateFieldGroup:O.onValidateFieldGroup,children:{items:F(p,{description:this.item.description},this.item.key),dependents:y}});let I=null;if(this.collaborationEnabled){const e=F(M,{visible:this.collaborationExpression,initials:this.collaborationInitialsExpression,displaySize:"Custom",customDisplaySize:"1.5rem",customFontSize:"0.8rem",backgroundColor:this.collaborationColorExpression,press:()=>{O.showCollaborationEditUser(e,i)}});I=F(b,{children:F(x,{width:"100%",alignItems:"End",children:{items:[v,e]}})});v?.addEventDelegate({onfocusin:e=>{const i=e.srcControl.getParent();t.collaborativeDraft?.handleContentFocusIn({getSource:()=>i});if(a?.getDomRef()){a.attachEventOnce("closed",()=>{i?.focus()})}},onfocusout:e=>{let i=e.srcControl.getParent();if(i?.isA("sap.m.Tokenizer")){i=i.getParent()?.getParent()}const a=new C("",i,{fieldGroupIds:i.getFieldGroupIds()});t.collaborativeDraft.handleContentFocusOut(a)}},this);const a=E.getElementById(v.getValueHelp());a?.attachOpened(e=>{const i=e.getSource().getControl();t.collaborativeDraft.handleContentFocusIn({getSource:()=>i})})}v.addCustomData(new u({key:"forwardedItemsBinding",value:this.items}));return this.collaborationEnabled?I:v}};i.setReadOnly=function e(i){t.prototype.setProperty.call(this,"readOnly",i);this.updateEditMode()};i.set_isInEditMode=function e(i){t.prototype.setProperty.call(this,"_isInEditMode",i);this.updateEditMode()};i.getMultiValueField=function t(){if(this.isCollaborationDraftSupported()){return this.content.content.getItems()[0]}else{return this.content}};i.updateEditMode=function t(){if(!this.content){return}const e=this.getMultiValueField();if(this.readOnly===true){this.editMode="Display";e.setEditMode("Display")}else if(this.readOnly===false&&this.items){if(this._isInEditMode){this.editMode="Editable";e.setEditMode("Editable")}else{this.editMode="Display";e.setEditMode("Display")}}};i.onBeforeRendering=function t(){if(this.content){const t=this.getMultiValueField();const e=this.getAriaLabelledBy();for(const i of e){const e=t.getAriaLabelledBy();if(!e.includes(i)){t.addAriaLabelledBy(i)}}}};return e}(f),k=St(A.prototype,"__implements__sap_ui_core_IFormContent",[_],{configurable:true,enumerable:true,writable:true,initializer:function(){return true}}),R=St(A.prototype,"id",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),U=St(A.prototype,"idPrefix",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),N=St(A.prototype,"vhIdPrefix",[z],{configurable:true,enumerable:true,writable:true,initializer:null}),Q=St(A.prototype,"metaPath",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),q=St(A.prototype,"readOnly",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),W=St(A.prototype,"contextPath",[j],{configurable:true,enumerable:true,writable:true,initializer:null}),J=St(A.prototype,"items",[H],{configurable:true,enumerable:true,writable:true,initializer:null}),K=St(A.prototype,"formatOptions",[$],{configurable:true,enumerable:true,writable:true,initializer:null}),X=St(A.prototype,"_isInEditMode",[L],{configurable:true,enumerable:true,writable:true,initializer:function(){return false}}),Y=St(A.prototype,"useParentBindingCache",[T],{configurable:true,enumerable:true,writable:true,initializer:function(){return false}}),A))||G);Z=jt;return Z},false);
//# sourceMappingURL=MultiValueField.js.map