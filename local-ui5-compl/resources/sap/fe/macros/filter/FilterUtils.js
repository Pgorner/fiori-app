/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filterBar/SemanticDateOperators","sap/ui/core/Element","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/v4/ODataUtils"],function(e,t,n,i,a,r,o,s,l,c,f,d,u,p,g,y,h,m,C,F,b,P){"use strict";var T=l.ODATA_TYPE_MAPPING;var v=o.getAllCustomAggregates;var S=function(e){e["hiddenFilter"]="hiddenFilter";e["required"]="required";e["path"]="path";e["tooltip"]="tooltip";e["visible"]="visible";e["maxConditions"]="maxConditions";e["formatOptions"]="formatOptions";e["constraints"]="constraints";e["group"]="group";e["groupLabel"]="groupLabel";e["caseSensitive"]="caseSensitive";return e}(S||{});const M={getFilter:function(e){const t=M.getFilterInfo(e).filters;return t?.length?new F(t,false):undefined},getFilterField:function(e,t,n){return r.getFilterField(e,t,n)},buildProperyInfo:function(e,t){let n;const i={};const a=t.getConverterContextFor(e.annotationPath);const o=a.getDataModelObjectPath().targetObject;const s=r.fetchTypeConfig(o);n=r.fetchPropertyInfo(t,e,s);i[e.key]=s;n=r.assignDataTypeToPropertyInfo(n,t,[],i);return n},createConverterContext:function(e,r,o,s){const l=f.getCustomData(e,"entityType"),c=r||l;const d=e.isA?n.getTargetView(e):null;const u=o||e.getModel().getMetaModel();const p=s||d&&n.getAppComponent(d);const g=a.getInvolvedDataModelObjects(u.createBindingContext(c));let y;if(e.isA&&!e.isA("sap.ui.mdc.filterbar.vh.FilterBar")){y=d&&d.getViewData()||{}}return i.createConverterContextForMacro(g.startingEntitySet.name,u,p?.getDiagnostics(),t,g.contextLocation,y)},getConvertedFilterFields:function(e,t,n,i,a,r,o){const s=this._getFilterMetaModel(e,i);const l=f.getCustomData(e,"entityType");const c=f.getCustomData(e,"annotationPath"),d=t||l;const u=this._getFieldsForTable(e,t);const p=this.createConverterContext(e,t,i,a);return this._getSelectionFields(e,t,l,d,u,s,p,n,r,o,c)},getBindingPathForParameters:function(e,n,i,a){const r=[];i=M.setTypeConfigToProperties(i);for(const o of a){if(n[o]&&n[o].length>0){const a=t({},n[o][0]);const s=C.getPropertyByKey(i,o);const l=s.typeConfig||h.getTypeConfig(s.dataType,s.formatOptions,s.constraints);const c=g.toType(a,l,e.getTypeMap());const f=T[l.className];r.push(`${o}=${encodeURIComponent(P.formatLiteral(c.values[0],f))}`)}}const o=e.data("entityType");const s=o.substring(0,o.length-1);const l=s.slice(0,s.lastIndexOf("/"));const c=s.substring(s.lastIndexOf("/")+1);return`${l}(${r.toString()})/${c}`},getEditStateIsHideDraft:function(e){let t=false;if(e&&e.$editState){const n=e.$editState.find(function(e){return e.operator==="DRAFT_EDIT_STATE"});if(n&&(n.values.includes("ALL_HIDING_DRAFTS")||n.values.includes("SAVED_ONLY"))){t=true}}return t},getFilterInfo:function(e,t,n){let i=t&&t.ignoredProperties||[];const a=t&&t.targetControl,r=a?a.data("entityType"):undefined;const o={};let s=e,l,c=[],f,d=t&&t.propertiesMetadata;if(typeof e==="string"){s=u.getElementById(e)}if(s){l=this._getSearchField(s,i);const e=this._getFilterConditions(t,n,s);let a;if(s.isA("sap.ui.mdc.FilterBar")){a=this.getFilterPropertyInfo(s)}else{a=s.getPropertyInfoSet?s.getPropertyInfoSet():null}a=this._getFilterPropertiesMetadata(a,s);if(t&&t.targetControl&&t.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(e).forEach(function(t){if(t==="$editState"){delete e["$editState"]}})}let u=s.data("parameters")||[];u=typeof u==="string"?JSON.parse(u):u;if(u&&u.length>0){f=M.getBindingPathForParameters(s,e,a,u);if(Object.keys(e).length){Object.keys(e).forEach(t=>{u.forEach(n=>{if(t===n){const i=e[t][0].values;o[n]=i[0]}})})}}if(e){if(r&&s.data("entityType")&&s.data("entityType")!==r){const e=s.getModel().getMetaModel();const t=s.getControlDelegate?.().fetchPropertiesForEntity(r,e,s);d=t;const n=this._getIgnoredProperties(a,t);if(n.length>0){i=i.concat(n)}}else if(!d&&a){d=a}const t=C.getFilterInfo(s,e,M.setTypeConfigToProperties(d),i.concat(u)).filters;c=t?[t]:[]}}return{parameters:o,filters:c,search:l||undefined,bindingPath:f}},setTypeConfigToProperties:function(e){if(e&&e.length){e.forEach(function(e){if(e.typeConfig&&e.typeConfig.typeInstance&&e.typeConfig.typeInstance.getConstraints instanceof Function){return}if(e.path==="$editState"){e.typeConfig=h.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(e.path==="$search"){e.typeConfig=h.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(e.dataType||e.typeConfig&&e.typeConfig.className){e.typeConfig=h.getTypeConfig(e.dataType||e.typeConfig?.className,e.formatOptions,e.constraints)}})}return e},getNotApplicableFilters:function(e,t){const n=t.data("entityType"),i=e.data("entityType"),a=e.getModel().getMetaModel(),r=a.getObject(i),o=[],s=e.getConditions(),l=n===i,d=t.isA("sap.ui.mdc.Chart"),u=!d&&t.getParent().getTableDefinition().enableAnalytics,p=!d&&t.getParent().getTableDefinition().control.type==="TreeTable",g=d?c.parseCustomData(f.getCustomData(t,"applySupported")).enableSearch:!(u||p)||t.getParent().getTableDefinition().enableBasicSearch;if(s&&(!l||u||d||p)){const i=l?[]:e.getControlDelegate().fetchPropertiesForEntity(n,a,e),c=i.reduce(function(e,t){e[t.name]=t;return e},{}),f={};const g=t.getModel().getMetaModel().getObject(t.data("targetCollectionPath")+"/");if(t.isA("sap.ui.mdc.Chart")){const e=t.getModel().getMetaModel().getObject(`${t.data("targetCollectionPath")}@`),n=v(e);Object.keys(n).forEach(function(e){if(!f[e]){const t=n[e];f[e]=t}})}for(const e in s){const t=s[e];let n=true;if(g[e]&&r[e]){n=g[e]["$Type"]===r[e]["$Type"]}if(Array.isArray(t)&&t.length>0&&((!c[e]||c[e].isCustomFilter&&c[e].annotationPath==undefined||c[e]&&!n)&&(!l||e==="$editState"&&(d||p||u))||f[e])){o.push(e.replace(/[+|*]/g,""))}}}if(!g&&e.getSearch()){o.push("$search")}return o},async _getValueListInfo(e,t){const n=e.getModel()?.getMetaModel();if(!n){return undefined}const i=e.data("entityType")??"";const a=await n.requestValueListInfo(i+t,true).catch(()=>null);return a?.[""]},getFilterPropertyInfo(e){let t=e.data("feFilterInfo");if(typeof t==="string"){t=JSON.parse(t)}return t||[]},_getConditionValidated:async function(t,n,i){if(!t){return y.NotValidated}try{const e=t.Parameters.filter(e=>["com.sap.vocabularies.Common.v1.ValueListParameterInOut".valueOf(),"com.sap.vocabularies.Common.v1.ValueListParameterOut".valueOf()].includes(e.$Type)).filter(e=>e.LocalDataProperty?.$PropertyPath===n).map(e=>e.ValueListProperty);const a=e[0]??n;const r=new F({path:a,operator:b.EQ,value1:i});const o=t.$model.bindList(`/${t.CollectionPath}`,undefined,undefined,r,{$select:a});const s=(await o.requestContexts()).length>0;if(s){return y.Validated}else{return y.NotValidated}}catch(t){e.error("FilterUtils: Error while retrieving ConditionValidated",t);return y.NotValidated}},async _clearFilterValue(e,t){const n=await m.retrieveExternalState(e);if(n.filter[t]){n.filter[t].forEach(e=>{e.filtered=false});await m.applyExternalState(e,{filter:{[t]:n.filter[t]}})}},setFilterValues:async function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),a=2;a<n;a++){i[a-2]=arguments[a]}await this._setFilterValues(e,false,t,...i)},addFilterValues:async function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),a=2;a<n;a++){i[a-2]=arguments[a]}await this._setFilterValues(e,true,t,...i)},_setFilterValues:async function(t,n,i){for(var a=arguments.length,r=new Array(a>3?a-3:0),o=3;o<a;o++){r[o-3]=arguments[o]}let s=r?.[0];let l=r?.[1];if(!t){return}if(r.length===2&&(l===undefined||l===null||l==="")&&s&&Object.keys(b).includes(s)){e.warning(`An empty filter value cannot be applied with the ${s} operator`);return}if(l===undefined&&!d.getSemanticDateOperations().includes(s||"")){l=s??[];s=undefined}if(!s){s=b.EQ}const c=["string","number","boolean"];if(l!==undefined&&(!Array.isArray(l)&&!c.includes(typeof l)||Array.isArray(l)&&l.length>0&&!c.includes(typeof l[0]))){throw new Error("FilterUtils.js#_setFilterValues: Filter value not supported; only primitive values or an array thereof can be used.")}let f;if(l!==undefined){f=Array.isArray(l)?l:[l]}const u=await this._getValueListInfo(t,i);const g={};if(i){if(f&&f.length){if(s===b.BT){g[i]=[p.createCondition(s,f,null,null,y.NotValidated)]}else{g[i]=await Promise.all(f.map(async e=>{const t=s===b.EQ?await this._getConditionValidated(u,i,e):y.NotValidated;return p.createCondition(s,[e],null,null,t)}))}}else if(d.getSemanticDateOperations().includes(s||"")){g[i]=[p.createCondition(s,[],null,null,y.NotValidated)]}}if(!n){await this._clearFilterValue(t,i)}if(g[i]){await m.applyExternalState(t,{filter:g})}},conditionToModelPath:function(e){return e.replace(/\//g,"\\")},_getFilterMetaModel:function(e,t){return t||e.getModel().getMetaModel()},_getEntitySetPath:function(e){return e&&s.getEntitySetPath(e)},_getFieldsForTable:function(e,t){const i=[];if(t){const t=n.getTargetView(e);const a=t&&t.getController()&&t.getController()._getControls&&t.getController()._getControls("table");if(a){a.forEach(function(e){i.push(e.getParent().getTableDefinition())})}return i}return[]},_getSelectionFields:function(e,t,n,i,o,s,l,c,f,d,u){const p=r.getSelectionFields(l,o,u,c,d);let g=p.selectionFields;const y=e.data?this.getFilterPropertyInfo(e):JSON.parse(p.sPropertyInfo.replace(/\\\{/g,"{").replace(/\\\}/g,"}"));if((f?f.getControlType(e)==="sap.ui.mdc.FilterBar":e.isA("sap.ui.mdc.FilterBar"))&&t!==n){const e=a.getInvolvedDataModelObjects(s.createBindingContext(i));const t=l.getConverterContextFor(n);const o=t.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];const c={};g.forEach(function(e){c[e.conditionPath]=true});o.forEach(function(t){const n=t.value;if(!c[n]){const t=r.getFilterField(n,l,e.startingEntitySet.entityType);if(t){g.push(t)}}})}if(g){const e=[];g.forEach(function(t){e.push(t.key)});g=this._getSelectionFieldsFromPropertyInfos(e,g,y)}return g},_getSelectionFieldsFromPropertyInfos:function(e,t,n){n.forEach(function(n){if(n.name==="$search"||n.name==="$editState"||n.key===undefined){return}const i=t[e.indexOf(n.key)];if(e.includes(n.key)&&i.annotationPath){n.group=i.group;n.groupLabel=i.groupLabel;n.settings=i.settings;n.visualFilter=i.visualFilter;n.label=n.label?n.label:i.label;n.annotationPath=n.annotationPath??i.annotationPath;t[e.indexOf(n.key)]=n}if(!e.includes(n.key)&&!n.annotationPath){t.push(n)}});return t},_getSearchField:function(e,t){return e.getSearch&&!t.includes("search")?e.getSearch():null},_getFilterConditions:function(e,t,n){const i=t||n.getConditions();if(e&&e.targetControl&&e.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(i).forEach(function(e){if(e==="$editState"){delete i["$editState"]}})}return i},_getFilterPropertiesMetadata:function(e,t){if(!(e&&e.length)){if(t.getPropertyInfo){e=t.getPropertyInfo()}else{e=null}}return e},_getIgnoredProperties:function(e,t){const n=[];e.forEach(function(e){const i=e.name;const a=t.find(e=>e.name===i);if(a&&(!e.isCustomFilter&&e.dataType!==a.dataType||e.isCustomFilter&&a.annotationPath===undefined)){n.push(i)}});return n},getFilters:function(e){if(!e){return}const{parameters:t,filters:n,search:i}=this.getFilterInfo(e);return{parameters:t,filters:n,search:i}},formatPropertyInfo:function(e){if(typeof e==="string"){let t=e.replace(/\\\{/g,"{");t=t.replace(/\\\}/g,"}");let n=JSON.parse(t);n=this._formatPropertyInfo(n);let i=JSON.stringify(n);i=i.replace(/\{/g,"\\{");i=i.replace(/\}/g,"\\}");return i}else{return this._formatPropertyInfo(e)}},_formatPropertyInfo:function(e){return e.map(e=>{const t={key:e.key||e.name,dataType:"",label:""};for(const n in S){if(e.hasOwnProperty(n)){switch(n){case"hiddenFilter":t.hiddenFilter=e.hiddenFilter;break;case"required":t.required=e.required;break;case"path":t.path=e.path;break;case"tooltip":t.tooltip=e.tooltip;break;case"visible":t.visible=e.visible;break;case"maxConditions":t.maxConditions=e.maxConditions;break;case"formatOptions":t.formatOptions=e.formatOptions;break;case"constraints":t.constraints=e.constraints;break;case"group":t.group=e.group;break;case"groupLabel":t.groupLabel=e.groupLabel;break;case"caseSensitive":t.caseSensitive=e.caseSensitive}}}if(e.dataType){t.dataType=e.dataType}else{throw new Error(`Missing mandatory property dataType for filter-bar filter field: ${e}`)}if(e.label){t.label=e.label}return t})}};return M},false);
//# sourceMappingURL=FilterUtils.js.map