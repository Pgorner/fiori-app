/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/controls/easyFilter/EasyFilterBarContainer","sap/fe/core/buildingBlocks/BuildingBlock","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/PropertyHelper","sap/fe/macros/filter/FilterUtils","sap/fe/macros/filterBar/DraftEditState","sap/ui/core/Element","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/odata/type/Date","sap/ui/model/odata/type/DateTimeOffset","sap/ui/model/odata/type/TimeOfDay","sap/fe/base/jsx-runtime/jsx"],function(e,t,r,a,i,n,o,s,l,c,u,p,d,f,h,y,m){"use strict";var g,b,w,P,F,C,B,S,V,E,v,_,T,M,O;var k={};var D=s.hasValueHelpWithFixedValues;var L=o.isPathAnnotationExpression;var x=t.property;var I=t.implementInterface;var A=t.defineUI5Class;var z=t.association;var j=t.aggregation;function Q(e,t,r,a){r&&Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(a):void 0})}function H(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,$(e,t)}function $(e,t){return $=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},$(e,t)}function q(e,t,r,a,i){var n={};return Object.keys(a).forEach(function(e){n[e]=a[e]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=r.slice().reverse().reduce(function(r,a){return a(e,t,r)||r},n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer?(Object.defineProperty(e,t,n),null):n}function N(e,t){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let W=(g=A("sap.fe.macros.EasyFilterBar"),b=I("sap.fe.core.controllerextensions.viewState.IViewStateContributor"),w=z({type:"sap.fe.macros.filterBar.FilterBarAPI"}),P=z({type:"sap.fe.macros.contentSwitcher.ContentSwitcher"}),F=x({type:"string"}),C=x({type:"string"}),B=j({type:"sap.fe.controls.easyFilter.EasyFilterBarContainer"}),g(S=(V=function(t){function a(r,a){var i;i=t.call(this,r,a)||this;Q(i,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",E,i);Q(i,"filterBar",v,i);Q(i,"contentSwitcher",_,i);Q(i,"contentSwitcherKey",T,i);Q(i,"contextPath",M,i);Q(i,"content",O,i);i.getAppComponent()?.getEnvironmentCapabilities().prepareFeature("MagicFiltering").then(()=>{i.easyFilterPath="ux/eng/fioriai/reuse/easyfilter/EasyFilter";i.content?.setEasyFilterLib(i.easyFilterPath);return}).catch(t=>{e.debug("Error while loading EasyFilter",t);return undefined});return i}k=a;H(a,t);var o=a.prototype;o.applyLegacyState=async function e(t,r,a,i){if(r?.selectionVariant){const e=r.selectionVariant.getSelectOptionsPropertyNames();this.filterBarMetadata.forEach(t=>{if(e.includes(t.name)){t.defaultValue=r.selectionVariant.getSelectOption(t.name)?.map(e=>{if(e.Sign==="I"){if(e.Option==="BT"){return{operator:p.BT,selectedValues:[{value1:e.Low,value2:e.High}]}}else{return{operator:e.Option,selectedValues:[e.Low]}}}else{return{operator:p.NE,selectedValues:[e.Low]}}})}});this.content?.resetState()}return Promise.resolve(undefined)};o.applyState=function e(t,r){return undefined};o.retrieveState=function e(){return{}};o.getApplicationId=function e(){return this.getAppComponent()?.getManifestEntry("sap.app").id??"<unknownID>"};o.onMetadataAvailable=function e(){this._fetchedCodeList??={};this.filterBarMetadata=this.prepareFilterBarMetadata();this.recommendedQueries=this.getAppComponent()?.getManifestEntry("sap.fe")?.macros?.easyFilter?.recommendedQueries??[];this.content=this.createContent();this.content.filterBarMetadata=this.filterBarMetadata};o.prepareFilterBarMetadata=function e(){const t=this._getOwner();const r=t.preprocessorContext?.getDefinitionForPage();let a;if(r){a=r.getFilterBarDefinition({});const e=t.preprocessorContext?.models.metaModel;const i=(e,t)=>{if(t){return"MenuWithCheckBox"}switch(e){case"Edm.Date":return"Calendar";case"Edm.TimeOfDay":return"Time";default:return"ValueHelp"}};const o=t.getAppComponent().getComponentData()?.startupParameters??{};const s=a.getFilterFields();const l=s.map(e=>{const t=e.getTarget();let r;const a=D(t);if(a){r=this._fetchedCodeList[e.name];if(!r){r=async()=>this.getCodeListForProperty(e.name,e.annotationPath)}}const n=t.annotations.Measures?.ISOCurrency??t.annotations.Measures?.Unit;const l=L(n)?n.$target:undefined;const c=l?s.find(e=>e.getTarget()===l)?.name:undefined;let u;if(o.hasOwnProperty(e.name)){u=[{operator:p.EQ,selectedValues:o[e.name]}]}else if(e.isParameter&&o.hasOwnProperty(e.name.substring(2))){u=[{operator:p.EQ,selectedValues:o[e.name.substring(2)]}]}return{name:e.name,label:e.label,dataType:t.type,required:e.required??false,defaultValue:u,filterable:true,sortable:!e.isParameter,codeList:r,type:i(t.type,r),unit:c}});if(n.isMetaPathDraftSupported(r.getMetaPath())){const t=new d({isDraftCollaborative:n.isCollaborationDraftSupported(e)}).createBindingContext("/");const r=c.getEditStatesContext(t).getObject("/").map(e=>({value:e.id,description:e.display}));l.push({name:"$editState",label:this.getTranslatedText("FILTERBAR_EDITING_STATUS"),dataType:"Edm.String",required:false,filterable:true,sortable:false,codeList:r,type:"MenuWithCheckBox"})}return l}return[]};o.getCodeListForProperty=async function e(t,r){const a=this.getModel();const i=await a.getMetaModel().requestValueListInfo(r);const n=i[""];const o=n.Parameters.map(e=>e.ValueListProperty).join(",");const s=n.$model.bindList("/"+n.CollectionPath,undefined,undefined,undefined,{$select:o});const l=await s.requestContexts();let c;let u;for(const e of n.Parameters){if(e.LocalDataProperty?.$PropertyPath===t){c=e.ValueListProperty}else{u=e.ValueListProperty}}const p=[];for(const e of l){const t=e.getObject();p.push({value:t[c],description:u?t[u]:undefined})}this._fetchedCodeList[t]=p;const d=this.filterBarMetadata.find(e=>e.name===t);if(d){d.codeList=p}return p};o.onTokensChanged=async function e(t){const r=u.getElementById(this.filterBar);const a=r.getParent();const i=t.getParameter("tokens");const n=i.some(e=>e.key==="$editState");await a._clearFilterValuesWithOptions(r,{clearEditFilter:n});this.formateDataTypes(i);for(const e of i){if(e.key==="$editState"){for(const t of e.keySpecificSelectedValues){await l.addFilterValues(a.content,e.key,"DRAFT_EDIT_STATE",t.selectedValues)}}else{for(const t of e.keySpecificSelectedValues){const{operator:r,selectedValues:i}=t;await l.addFilterValues(a.content,e.key,r,i)}}}await a.triggerSearch()};o.formateDataTypes=function e(t){const r=new f,a=new h(undefined,{V4:true}),i=new y;t.forEach(e=>{const t=this.filterBarMetadata.find(t=>t.name===e.key)?.dataType;e.keySpecificSelectedValues.forEach(e=>{let n;switch(t){case"Edm.Date":n=r;break;case"Edm.TimeOfDay":n=i;break;case"Edm.DateTimeOffset":n=a;break;default:return}e.selectedValues.forEach((t,r)=>{e.selectedValues[r]=n.parseValue(t,"object")})})})};o.showValueHelpForKey=async function e(t,r,a){const i=u.getElementById(this.filterBar);const n=i.getParent();await n.showFilterField(t);n.openValueHelpForFilterField(t,undefined,a)};o.onBeforeQueryProcessing=function e(){const t=this.getModel("ui");i.lock(t)};o.onAfterQueryProcessing=function e(){const t=this.getModel("ui");i.unlock(t)};o.onClearFilters=async function e(){const t=u.getElementById(this.filterBar);const r=t.getParent();await r._clearFilterValuesWithOptions(t);await r.triggerSearch()};o.onQueryChanged=function e(){const t=u.getElementById(this.filterBar);t.fireFiltersChanged({conditionsBased:true})};o.createContent=function e(){return m(r,{contextPath:this.getOwnerContextPath(),appId:this.getApplicationId(),filterBarMetadata:this.filterBarMetadata,easyFilterLib:this.easyFilterPath,showValueHelp:e=>{this.showValueHelpForKey(e.getParameter("key"),e.getParameter("values"),t=>{const r=t.map(e=>{if(e.operator===p.BT||e.operator===p.NB){return{operator:e.operator,selectedValues:e.values}}else{return{operator:e.operator,selectedValues:e.values}}});e.getParameter("resolve")(r)})},recommendedValues:this.recommendedQueries,queryChanged:this.onQueryChanged.bind(this),tokensChanged:this.onTokensChanged.bind(this),beforeQueryProcessing:this.onBeforeQueryProcessing.bind(this),afterQueryProcessing:this.onAfterQueryProcessing.bind(this),clearFilters:this.onClearFilters.bind(this)})};return a}(a),E=q(V.prototype,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",[b],{configurable:true,enumerable:true,writable:true,initializer:null}),v=q(V.prototype,"filterBar",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),_=q(V.prototype,"contentSwitcher",[P],{configurable:true,enumerable:true,writable:true,initializer:null}),T=q(V.prototype,"contentSwitcherKey",[F],{configurable:true,enumerable:true,writable:true,initializer:null}),M=q(V.prototype,"contextPath",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),O=q(V.prototype,"content",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),V))||S);k=W;return k},false);
//# sourceMappingURL=EasyFilterBar.js.map