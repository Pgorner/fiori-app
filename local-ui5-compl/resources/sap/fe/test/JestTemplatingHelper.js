/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["@sap/cds-compiler","fs","htmljs-parser","path","sap/base/Log","sap/base/util/LoaderExtensions","sap/base/util/merge","sap/base/util/uid","sap/fe/base/jsx-runtime/jsx","sap/fe/core/AppComponent","sap/fe/core/PageController","sap/fe/core/TemplateModel","sap/fe/core/buildingBlocks/templating/BuildingBlockTemplateProcessor","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/MetaModelConverter","sap/fe/core/services/SideEffectsServiceFactory","sap/fe/test/UI5MockHelper","sap/m/Page","sap/ui/base/BindingParser","sap/ui/base/ManagedObject","sap/ui/base/ManagedObjectMetadata","sap/ui/core/Component","sap/ui/core/InvisibleText","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/util/serializer/Serializer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/preprocessors/XmlPreprocessor","sap/ui/fl/initial/_internal/Storage","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/ODataMetaModel","sap/ui/model/odata/v4/lib/_MetadataRequestor","xpath","./JestFlexibilityHelper","sap/fe/base/jsx-runtime/jsx"],function(e,t,n,o,s,r,a,i,c,l,u,d,p,f,m,g,y,h,C,$,v,x,S,b,w,M,O,j,A,P,B,F,T,k,E,I,D){"use strict";var L={};var _=I.createFlexibilityChangesObject;var R=y.createMockResourceModel;var N=m.getInvolvedDataModelObjects;var X=m.convertTypes;var z=p.parseXMLString;var V=n.createParser;function H(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,W(e,t)}function W(e,t){return W=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},W(e,t)}s.setLevel(1,"sap.ui.core.util.XMLPreprocessor");jest.setTimeout(4e4);const J={macro:"sap.fe.macros",macros:"sap.fe.macros",feBB:"sap.fe.core.buildingBlocks.templating",macroField:"sap.fe.macros.field",macrodata:"http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",log:"http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",customData:"http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",control:"sap.fe.core.controls",controls:"sap.fe.macros.controls",core:"sap.ui.core",dt:"sap.ui.dt",m:"sap.m",f:"sap.ui.layout.form",fl:"sap.ui.fl",internalMacro:"sap.fe.macros.internal",mdc:"sap.ui.mdc",actiontoolbar:"sap.ui.mdc.actiontoolbar",mdcField:"sap.ui.mdc.field",mdcTable:"sap.ui.mdc.table",u:"sap.ui.unified",uxap:"sap.uxap",macroMicroChart:"sap.fe.macros.microchart",microChart:"sap.suite.ui.microchart",macroTable:"sap.fe.macros.table",mdcvc:"sap.ui.mdc.valuehelp.content",mdcv:"sap.ui.mdc.valuehelp",valueHelp:"sap.fe.macros.valueHelp",contentSwitcher:"sap.fe.macros.contentSwitcher",filterBar:"sap.fe.macros.filterBar",fbControls:"sap.fe.macros.controls.filterbar",draftIndicator:"sap.fe.macros.draftIndicator"};const q=Object.keys(J).reduce((e,t)=>{e[J[t]]=t;return e},{});const G=E.useNamespaces(J);const U={computeFieldGroupIds:()=>[]};function K(e,t){const n="/root";return`${e.nodeName==="root"&&!t.startsWith(n)?n:""}${t}`}async function Q(e,t,n,o){let s;if(e){s=await ue(e);if(!n.hasOwnProperty("converterContext")){n=Object.assign(n,{converterContext:new d({},s)})}Object.keys(n).forEach(function(e){if(n[e]&&n[e].isTemplateModel){n[e]=new d(n[e].data,s)}})}const r={models:Object.assign({metaModel:s},n),bindingContexts:{},appComponent:{getSideEffectsService:jest.fn(),getDiagnostics:()=>undefined,getShellServices:jest.fn()}};r.appComponent.getSideEffectsService.mockReturnValue(o??U);Object.keys(t).forEach(function(e){expect(typeof s?.getObject(t[e])).toBeDefined();const o=n[e]||s;r.bindingContexts[e]=o.createBindingContext(t[e]);r.models[e]=o});return r}function Y(e){const t=e.replace(/\./g,"/")+".view.xml";const n=r.loadResource(t);return n.documentElement}const Z=function(e,t){return G(e,t)};expect.extend({toHaveControl(e,t){const n=Z(K(e,t),e);return{message:()=>{const n=ne(e);return`did not find controls matching ${t} in generated xml:\n ${n}`},pass:n&&n.length>=1}},toNotHaveControl(e,t){const n=Z(K(e,t),e);return{message:()=>{const n=ne(e);return`There is a control matching ${t} in generated xml:\n ${n}`},pass:n&&n.length===0}},toHaveTemplatingErrors(e){const t=typeof e==="string"?e:ne(e);const n=t.match(/BBF\.base64Decode\('([^']*)'\)/gm)||[];const o=n.map(e=>{if(e&&e.length>0){return atob(e.match(/('[^']*)/)?.[0]?.slice(1)||"")}return""});if(o.length<=0){return{message:()=>`XML Templating without errors`,pass:false}}else{return{message:()=>o.join("\n"),pass:true}}}});L.runXPathQuery=Z;const ee=function(e){if(Array.isArray(e)){e=e.join("")}return oe(e)};L.formatBuildingBlockXML=ee;const te=function(e,t,n){const o=`string(${K(n,e)}/@${t})`;return Z(o,n)};L.getControlAttribute=te;const ne=function(e,t){const n=new window.XMLSerializer;let o;if(t){const s=Z(t,e);o=s.map(e=>n.serializeToString(e)).join("\n")}else{o=n.serializeToString(e)}return oe(o)};L.serializeXML=ne;const oe=function(e){const t="<__XML__>",n="</__XML__>",o=/uid--id-\d{13}-\d{1,3}/,s=/id-\d{13}-\d{1,3}/,r=[];let a="",i=-1,c=[];function l(){if(a&&a!==t){r.push(a)}a=i>0?"  ".repeat(i):""}function u(){if(c.length>0){c=c.sort((e,t)=>{if(e.name.startsWith("xmlns")&&!t.name.startsWith("xmlns")){return-1}else if(!e.name.startsWith("xmlns")&&t.name.startsWith("xmlns")){return 1}else if(e.name.startsWith("xmlns")&&t.name.startsWith("xmlns")){return e.name.localeCompare(t.name)}else if(e.name.includes(":")&&!t.name.includes(":")){return-1}else if(!e.name.includes(":")&&t.name.includes(":")){return 1}else{return e.name.localeCompare(t.name)}});i++;for(const e of c){l();a+=e.name;if(e.value)a+=e.value}i--;c=[];l()}}function d(e){a+=p.read(e)}const p=V({onOpenTagStart(e){l();d(e)},onOpenTagName:d,onAttrName(e){c.unshift({name:p.read(e)})},onAttrValue(e){c[0].value=p.read(e).replace(o,"uid--id");c[0].value=p.read(e).replace(s,"id")},onOpenTagEnd(e){u();d(e);if(!e.selfClosed)i++},onCloseTagStart(e){i--;l();d(e)},onCloseTagName:d,onCloseTagEnd:d});p.parse(t+e+n);return r.join("\n").trim()};L.formatXML=oe;const se=function(e){let n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const s=t.readFileSync(e,"utf-8");const r=re(s,"sap.fe.test.JestService",n);const a=o.resolve(e,"..","gen");const i=Object.entries(n);i.sort((e,t)=>t[0].localeCompare(e[0]));const c=i.reduce((e,t)=>{let[n,o]=t;return`${e}#${n}=${o.toString()}#`},o.basename(e).replace(".cds",""))+".xml";const l=o.resolve(a,c);t.mkdirSync(a,{recursive:true});t.writeFileSync(l,r);return l};L.compileCDS=se;function re(n){let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"sap.fe.test.JestService";let s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const r={"source.cds":n};if(n.includes("'@sap/cds/common'")){r["common.cds"]=t.readFileSync(require.resolve("@sap/cds/common.cds"),"utf-8")}const a=e.compileSources(r,{});const i={odataForeignKeys:true,odataFormat:"structured",odataContainment:true,...s,service:o};const c=e.to.edmx(a,i);if(!c){throw new Error(`Compilation failed. Hint: Make sure that the CDS model defines service ${o}.`)}return c}L.cds2edmx=re;const ae=async function(e){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"sap.ui.model.odata.v4.ODataModel";const n={getModel:()=>({isA:()=>t==="sap.ui.model.odata.v4.ODataModel",getMetaModel:()=>e,getServiceUrl:()=>undefined}),getService:()=>({getCapabilities:()=>undefined})};const o=await(new g).createInstance({scopeObject:n,scopeType:"",settings:{}});return o.getInterface()};L.getFakeSideEffectsService=ae;const ie=function(){const e=[];return{addIssue(t,n,o){e.push({issueCategory:t,issueSeverity:n,details:o})},getIssues(){return e},checkIfIssueExists(t,n,o){return e.find(e=>e.issueCategory===t&&e.issueSeverity===n&&e.details===o)}}};L.getFakeDiagnostics=ie;const ce=function(e,t){const n=X(e);const o=t.contextPath?N(e.createBindingContext(t.contextPath)):N(e.createBindingContext(`/${t.entitySet}`));return new f(n,t,ie(),a,o)};L.getConverterContextForTest=ce;const le={};const ue=async function(e){const t=k.create({},"4.0",undefined,{},{},function(){return null});if(!le[e]){const n=new T(t,e,undefined,{_requestAnnotationChanges:()=>[]});await n.fetchEntityContainer();le[e]=n}return le[e]};L.getMetaModel=ue;const de=function(e,t,n){const o={startingEntitySet:e,navigationProperties:[],targetObject:n,targetEntitySet:e,targetEntityType:e.entityType,convertedTypes:t};o.contextLocation=o;return o};L.getDataModelObjectPathForProperty=de;const pe=function(e){const t=C.complexParser(e);for(var n=arguments.length,o=new Array(n>1?n-1:0),s=1;s<n;s++){o[s-1]=arguments[s]}return t.formatter.apply(undefined,o)};L.evaluateBinding=pe;function fe(e,t,n){const o=C.complexParser(e);const s=new S;s.bindProperty("text",o);const r=new F(t);s.setModel(r);s.setBindingContext(r.createBindingContext("/"));if(n){for(const[e,t]of Object.entries(n)){const n=new F(t);s.setModel(n,e);s.setBindingContext(n.createBindingContext("/"),e)}}return s.getText()}L.evaluateBindingWithModel=fe;const me="testViewId";const ge=async function(e,t,n){[...n.querySelectorAll("[id]")].forEach(e=>{e.id=`${me}--${e.id}`});const o=_(me,e);const s="someComponent";const r={"sap.app":{id:s,type:"application",crossNavigation:{outbounds:[]}}};const a={getDiagnostics:jest.fn().mockReturnValue(ie()),getModel:jest.fn().mockReturnValue({getMetaModel:jest.fn().mockReturnValue(t)}),getComponentData:jest.fn().mockReturnValue({}),getManifestObject:jest.fn().mockReturnValue({getEntry:function(e){return r[e]}}),getLocalId:jest.fn(e=>e)};jest.spyOn(B,"loadFlexData").mockReturnValue(Promise.resolve(o));jest.spyOn(A,"loadFlexData").mockReturnValue(Promise.resolve(o));jest.spyOn(x,"getComponentById").mockReturnValue(a);jest.spyOn(O,"getAppComponentForControl").mockReturnValue(a);await j.initialize({componentId:s});n=await P.process(n,{name:"Test Fragment",componentId:s,id:me});const i=ye(n);expect(i.length).toBe(e?.changes?.length??0+e?.variantDependentControlChanges?.length??0);return n};const ye=e=>[...e.querySelectorAll("*")].flatMap(e=>[...e.attributes].map(e=>e.name)).filter(e=>e.includes("sap.ui.fl.appliedChanges"));L.getChangesFromXML=ye;const he=async function(e,t,n,o,s,r){if(!o["sap.fe.i18n"]){o["sap.fe.i18n"]=R()}const a=`<root>${e}</root>`;const i=new window.DOMParser;const c=i.parseFromString(a,"text/xml");const l=await Q(t,n,o,r);if(l.models["this"]){l.bindingContexts["this"]=l.models["this"].createBindingContext("/")}let u=await w.process(c.firstElementChild,{name:"Test Fragment"},l);if(t&&s){const e=await ue(t);u=await ge(s,e,u)}return u};L.getTemplatingResult=he;const Ce=async function(e,t,n,o,s,r){return c.defineXMLNamespaceMap(q,async()=>{const a=await he(e,t,n,o,s,r);const i=ne(a,undefined);expect(i).not.toHaveTemplatingErrors();return i})};L.getTemplatedXML=Ce;async function $e(e,t,n,o,s){const r=await ue(t);const a=Y(e);const i=await Q(t,n,o);let c=await w.process(a,{name:e},i);if(s){c=await ge(s??[],r,c)}return{asElement:c,asString:oe(c?.outerHTML||"")}}L.processView=$e;async function ve(e,t){const n=`<root><core:Fragment fragmentName="${e}" type="XML" xmlns:core="sap.ui.core" /></root>`;const o=new window.DOMParser;const s=o.parseFromString(n,"text/xml");const r={models:{},bindingContexts:{},appComponent:{getSideEffectsService:jest.fn(),getDiagnostics:()=>undefined}};for(const e in t){const n=new F;n.setData(t[e]);r.models[e]=n;r.bindingContexts[e]=r.models[e].createBindingContext("/")}r.appComponent.getSideEffectsService.mockReturnValue(U);const a=await w.process(s.firstElementChild,{name:e},r);const i=a.getElementsByTagName("core:Fragment");if(i?.length>0){for(const e of i){e.innerHTML=""}}const c=a.children.length>1?a.outerHTML:a.innerHTML;return oe(c)}L.processFragment=ve;function xe(e){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;let n=0;const o=/uid--id-\d{13}-\d{1,3}/;const s=/id-\d{13}-\d{1,3}/;function r(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;let t="";for(let o=0;o<n+e;o++){t+="\t"}return t}const a={start:function(e,t){let n="";if(t){if(e.getParent()){const o=e.getParent().getAggregation(t)?.indexOf?.(e);if(o>0){n+=`,\n${r()}`}}}n+=`${e.getMetadata().getName()}(`;return n},end:function(){return"})"},middle:function(e){let n=e.getId();n=typeof n==="string"?n?.replace?.(s,"id"):n;let a=`{id: ${v.isGeneratedId(n)?"__dynamicId":n}`;for(const t in e.mProperties){if(e.mProperties.hasOwnProperty(t)){let n=e.mProperties[t];n=typeof n==="string"?n?.replace?.(o,"uid--id"):n;n=typeof n==="string"?n?.replace?.(s,"id"):n;try{n=typeof n==="object"?JSON.stringify(n):n}catch(e){}a+=`,\n${r()} ${t}: ${n}`}else if(e.mBindingInfos.hasOwnProperty(t)){const n={...e.mBindingInfos[t]};if(n.type?.oOutputFormat){delete n.type.oOutputFormat}if(n.binding){delete n.binding}a+=`,\n${r()} ${t}: ${JSON.stringify(n)}`}}for(const t in e.mAssociations){if(e.mAssociations.hasOwnProperty(t)){let n=e.mAssociations[t];if(!Array.isArray(n)){n=[n]}n=n.map(e=>typeof e==="string"?e?.replace?.(s,"id"):e);a+=`,\n${r()} ${t}: ${(n?.join?.(",")??n)||undefined}`}}if(t&&e.aCustomStyleClasses?.length>0){a+=`,\n${r()} customStyleClasses : ${e.aCustomStyleClasses.join(", ")}`}for(const t in e.mEventRegistry){if(e.mEventRegistry.hasOwnProperty(t)){a+=`,\n${r()} ${t}: true`}}a+=``;return a},startAggregation:function(e,t){let o=`,\n${r()}${t}`;n++;if(e.mBindingInfos[t]){o+=`={ path:'${e.mBindingInfos[t].path}', template:\n${r()}`}else{o+=`=[\n${r()}`}return o},endAggregation:function(e,t){n--;if(e.mBindingInfos[t]){return`\n${r()}}`}else{return`\n${r()}]`}}};if(Array.isArray(e)){return e.map(e=>new M(e,a).serialize())}else{return new M(e,a).serialize()}}L.serializeControl=xe;function Se(e){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;let n=0;const o=/uid--id-\d{13}-\d{1,3}/;const s=/id-\d{13}-\d{1,3}/;const r={};function a(e){const t=e.split(".");const n=t.slice(0,-1);const o=t[t.length-1];let s=n[n.length-1];if(q[n.join(".")]){s=q[n.join(".")]}if(s===undefined){s="test"}return s}function i(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;let t="";for(let o=0;o<n+e;o++){t+="\t"}return t}const c={start:function(e,t){let n="";if(t){if(e.getParent()){const o=e.getParent().getAggregation(t)?.indexOf?.(e);if(o>0){n+=`\n${i()}`}}}const o=e.getMetadata().getName();const s=o.split(".");const c=s[s.length-1];const l=a(o);n+=`<${l}:${c}\n`;if(!r[l]){r[l]=true;n+=`${i()}xmlns:${l}="${J[l]}"`}return n},end:function(e){const t=e.getMetadata().getName();const n=t.split(".");const o=n[n.length-1];const s=a(t);let r=false;for(const t in e.mAggregations){if(!Array.isArray(e.mAggregations[t])&&e.mAggregations[t]!==null&&e.mAggregations[t]!==undefined||Array.isArray(e.mAggregations[t])&&e.mAggregations[t].length>0){r=true}}if(r){return`</${s}:${o}>`}else{return`/>`}},middle:function(e){let n=e.getId();n=typeof n==="string"?n?.replace?.(s,"id"):n;let r="";if(!v.isGeneratedId(n)){r=`id="${n}"`}let a=Object.keys(e.mProperties).concat(Object.keys(e.mBindingInfos)).concat(Object.keys(e.mAssociations)).concat(Object.keys(e.mEventRegistry));a=a.sort((e,t)=>e.localeCompare(t));const c=new Set(a);a=Array.from(c);for(const t of a){if(e.mBindingInfos.hasOwnProperty(t)){const n={...e.mBindingInfos[t]};if(n.bindingString){r+=`\n${i()}${t}="${n.bindingString.replace(">","&gt;")}"`}else{if(n.type?.oOutputFormat){delete n.type.oOutputFormat}if(n.binding){delete n.binding}if(n.template){delete n.template}r+=`\n${i()}${t}='${JSON.stringify(n)}'`}}else if(e.mProperties.hasOwnProperty(t)&&e.mProperties[t]!==undefined){let n=e.mProperties[t];n=typeof n==="string"?n?.replace?.(o,"uid--id"):n;n=typeof n==="string"?n?.replace?.(s,"id"):n;try{n=typeof n==="object"?JSON.stringify(n):n}catch(e){}r+=`\n${i()} ${t}="${n}"`}else if(e.mAssociations.hasOwnProperty(t)){let n=e.mAssociations[t];if(!Array.isArray(n)){n=[n]}n=n.map(e=>typeof e==="string"?e?.replace?.(s,"id"):e);r+=`\n${i()} ${t}="${(n?.join?.(",")??n)||undefined}"`}else if(e.mEventRegistry.hasOwnProperty(t)){if(e.mEventRegistry[t][0]?.fFunction?.name){r+=`\n${i()} ${t}="${e.mEventRegistry[t][0]?.fFunction?.name}"`}else{r+=`\n${i()} ${t}="someEventHandler"`}}}if(t&&e.aCustomStyleClasses?.length>0){r+=`\n${i()} customStyleClasses : ${e.aCustomStyleClasses.join(", ")}`}r+=`\n`;let l=false;for(const t in e.mAggregations){if(!Array.isArray(e.mAggregations[t])&&e.mAggregations[t]!==null&&e.mAggregations[t]!==undefined||Array.isArray(e.mAggregations[t])&&e.mAggregations[t].length>0){l=true}}if(l){r+=">"}return r},startAggregation:function(e,t){const o=a(e.getMetadata().getName());let s=`\n${i()}<${o}:${t}>`;n++;s+=`\n${i()}`;return s},endAggregation:function(e,t){n--;const o=a(e.getMetadata().getName());if(e.mBindingInfos[t]){return`\n${i()}</${o}:${t}>\n`}else{return`\n${i()}</${o}:${t}>\n`}}};let l;if(Array.isArray(e)){l=e.map(e=>new M(e,c).serialize())}else{l=new M(e,c).serialize()}return oe(`<root>${l}</root>`)}L.serializeControlAsXML=Se;function be(){let e;const t=new Promise(t=>{e=t});return{promise:t,resolve:e}}L.createAwaiter=be;function we(e,t){return $.runWithPreprocessors(()=>e.getContent(),{settings:function(e){e.models=t;return e}})}L.renderBuildingBlockWithModels=we;function Me(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++){t[n]=arguments[n]}const o=b.loadTemplatePromise;const s=jest.spyOn(b,"loadTemplatePromise");s.mockImplementation((e,n)=>{for(const n of t){if(n.name===e){return z(n.content)[0]}}return o(e,n)});return s}L.registerMockFragments=Me;async function Oe(e,n,s){let r=e?.cdsFile;if(!r){r=se(o.join(__dirname,"./data/Products.cds"))}const a=i();const c=e?.componentId??`sap.fe.test.${a}`;const d=t.readFileSync(r).toString();sap.jest.registerFakeFragment(`/sap/fe/core/mock/${a}/$metadata?sap-language=EN`,d);let p=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;n.render=function e(){return D(h,{})};return t}(u);sap.ui.define(`sap/fe/test/${a}/Component`,["sap/fe/core/AppComponent"],function(t){"use strict";return l.extend(`sap.fe.test.${a}.Component`,{metadata:{manifest:{"sap.app":{id:`test${a}`,dataSources:{mainService:{uri:`/sap/fe/core/mock/${a}/`,type:"OData",settings:{odataVersion:"4.0"}}}},"sap.ui5":{models:{"":{dataSource:"mainService",settings:{}}},routing:{targets:{Default:{type:"Component",name:n??"sap.fe.core.fpm",id:"Default",viewLevel:s,options:{settings:{...e?.manifestSettings??{},contextPath:e?.mainContextPath??"/Products",viewType:"JSX",viewContent:e?.pageContent??p,content:e?.content}}}},routes:[{pattern:":?query:",name:"Default",target:"Default"}]}}}}})});const f=await x.create({name:`sap.fe.test.${a}`,id:c});await f.initialized;const m=await(f.getRouter().getTarget("Default").load?.());return{appComponent:f,templateComponent:m.object}}L.initializeAppComponent=Oe;function je(e,t){for(let n=0;n<e.length;n++){const o=e.item(n);if(t(o)){return o}}return undefined}L.findElement=je;async function Ae(e,t){return new Promise(n=>{e.attachEventOnce(t,e=>{n(e)})})}L.waitForEvent=Ae;function Pe(e){C._keepBindingStrings=e}L.keepBindingStringForTest=Pe;return L},false);
//# sourceMappingURL=JestTemplatingHelper.js.map