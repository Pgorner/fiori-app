/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/library","sap/fe/navigation/SelectionVariant","sap/fe/navigation/library","sap/ui/Device","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil"],function(t,e,a,n,i,r,o,s,l){"use strict";var c=e.getInvolvedDataModelObjects;const d=r.NavType,g=n.VariantManagement,u=n.TemplateContentView,f=n.InitialLoadMode,h="DisplayCurrency";const p={_bSearchTriggered:false,applyInitialStateOnly:function(){return true},onBeforeStateApplied:function(t,e){const a=this.getView(),n=a.getController(),i=n._getFilterBarControl(),r=n._getControls("table");if(i){i.setSuspendSelection(true);t.push(i.waitForInitialization());if(e===d.hybrid){this._clearFilterConditions(i)}}r.forEach(function(e){t.push(e.initialized())});delete this._bSearchTriggered},adaptBindingRefreshControls:function(t){const e=this.base.getView(),n=e.getController(),i=n._getControls(),r=a.getControlsForRefresh(e,i);Array.prototype.push.apply(t,r)},adaptStateControls:function(t){const e=this.base.getView(),a=e.getController();const n=this._getFilterBarVM(e);if(n){t.push(n)}if(a._isMultiMode()){t.push(a._getMultiModeControl())}if(a._hasMultiVisualizations()){t.push(a._getSegmentedButton(u.Chart));t.push(a._getSegmentedButton(u.Table))}t.push(e.byId("fe::ListReport"))},retrieveAdditionalStates:function(t){const e=this.getView(),a=e.getController(),n=e.getBindingContext("internal").getProperty("hasPendingFilters");t.dataLoaded=!n||!!this._bSearchTriggered;if(a._hasMultiVisualizations()){const a=e.getBindingContext("internal").getProperty("alpContentView");t.alpContentView=a}delete this._bSearchTriggered},applyAdditionalStates:function(t){const e=this.getView(),a=e.getController(),n=a._getFilterBarControl();if(t){if(t.dataLoaded===false&&n){n._bSearchTriggered=false}else if(t.dataLoaded===true){if(n){const t=n.getParent();t.triggerSearch()}this._bSearchTriggered=true}if(a._hasMultiVisualizations()){const a=e.getBindingContext("internal");if(!o.system.desktop&&t.alpContentView==u.Hybrid){t.alpContentView=u.Chart}a.getModel().setProperty(`${a.getPath()}/alpContentView`,t.alpContentView)}}},isSearchTriggeredByInitialLoad(t){const e=this.base.getView(),a=e.getController(),i=e.getViewData();let r=false,o;if(i.variantManagement===n.VariantManagement.Control){o=a._getFilterBarVariantControl()}else{o=e.byId("fe::PageVariantManagement")}const s=o?.getCurrentVariantKey();if(t===d.xAppState){return true}else if(o&&i.initialLoad!==f.Enabled){if(a._shouldAutoTriggerSearch(this._getFilterBarVM(e))){r=true}}else if(o&&i.initialLoad===f.Enabled&&a._getApplyAutomaticallyOnVariant(o,s)){r=true}return r},_enableFilterBar:function(t,e){const a=t.getParent();const n=()=>{this._bSearchTriggered=!e};if(t.getSuspendSelection()){a.attachEventOnce("search",n);t.setSuspendSelection(false)}else{n()}},_applyNavigationParametersToFilterbar:function(e,a){const n=this.base.getView();const i=n.getController();const r=i.getAppComponent();const s=r.getComponentData();const l=s&&s.startupParameters||{};const c=this.handleVariantIdPassedViaURLParams(l);let g;a.push(c.then(t=>{if(t&&t.length>0){if(t[0]===true||t[1]===true){g=true}}return this._applySelectionVariant(n,e,g)}).then(()=>{let t=false;const a=this._getFilterBarVM(n);const r=i._getFilterBarControl();if(r){if(e.navigationType!==d.initial&&e.requiresStandardVariant||!a&&n.getViewData().initialLoad===f.Enabled||i._shouldAutoTriggerSearch(a)){const t=r.getParent();t.triggerSearch()}else{t=this._preventInitialSearch(a)}if(!o.system.desktop){const t=n.getBindingContext("internal");const a=this.isSearchTriggeredByInitialLoad(e.navigationType);t.setProperty("searchTriggeredByInitialLoad",a)}this._enableFilterBar(r,t)}return}).catch(function(){t.error("Variant ID cannot be applied")}))},handleVariantIdPassedViaURLParams:async function(t){const e=t["sap-ui-fe-variant-id"],a=t["sap-ui-fe-filterbar-variant-id"],n=t["sap-ui-fe-table-variant-id"],i=t["sap-ui-fe-chart-variant-id"];let r;if(e||a||n||i){r={sPageVariantId:e&&e[0],sFilterBarVariantId:a&&a[0],sTableVariantId:n&&n[0],sChartVariantId:i&&i[0]}}return this._handleControlVariantId(r)},_handleControlVariantId:async function(t){let e;const a=this.base.getView(),n=[];const i=a.getViewData().variantManagement;if(t&&t.sPageVariantId&&i==="Page"){e=a.byId("fe::PageVariantManagement");this._handlePageVariantId(t,e,n)}else if(t&&i==="Control"){if(t.sFilterBarVariantId){e=a.getController()._getFilterBarVariantControl();this._handleFilterBarVariantControlId(t,e,n)}if(t.sTableVariantId){const e=a.getController();this._handleTableControlVariantId(t,e,n)}if(t.sChartVariantId){const e=a.getController();this._handleChartControlVariantId(t,e,n)}}return Promise.all(n)},_handlePageVariantId:function(t,e,a){e.getVariants()?.forEach(n=>{this._findAndPushVariantToPromise(n,t.sPageVariantId,e,a,true)})},_handleFilterBarVariantControlId:function(t,e,a){if(e){e.getVariants().forEach(n=>{this._findAndPushVariantToPromise(n,t.sFilterBarVariantId,e,a,true)})}},_handleTableControlVariantId:function(t,e,a){const n=e._getControls("table");n.forEach(e=>{const n=e.getVariant();if(e&&n){n.getVariants().forEach(e=>{this._findAndPushVariantToPromise(e,t.sTableVariantId,n,a)})}})},_handleChartControlVariantId:function(t,e,a){const n=e._getControls("Chart");n.forEach(e=>{const n=e.getVariant();const i=n.getVariants();if(i){i.forEach(e=>{this._findAndPushVariantToPromise(e,t.sChartVariantId,n,a)})}})},_findAndPushVariantToPromise:function(t,e,a,n,i){if(t.key===e){n.push(this._applyControlVariant(a,e,i))}},_applyControlVariant:async function(t,e,a){const n=this._checkIfVariantIdIsAvailable(t,e)?e:t.getStandardVariantKey();const i=s.activateVariant({element:t,variantReference:n});return i.then(function(){return a})},_getFilterBarVM:t=>{let e;const a=t.getViewData();switch(a.variantManagement){case g.Page:e=t.byId("fe::PageVariantManagement");break;case g.Control:e=t.getController()._getFilterBarVariantControl();break;case g.None:default:break}return e},_preventInitialSearch:function(t){if(!t){return true}const e=t.getVariants();const a=e.find(function(e){return e.getKey()===t.getCurrentVariantKey()});return!a.executeOnSelect},_checkIfDisplayCurrencyIsRequired:function(t,e){const a=t.getMetaContext(e),n=c(a),i=n.startingEntitySet._type==="EntitySet"?n.startingEntitySet:undefined,r=i?.annotations.Capabilities?.FilterRestrictions?.RequiredProperties??[],o=r.some(t=>t.value===h);return o},_addDefaultDisplayCurrencyToSV:function(t,e,a){if(!a||a?.isEmpty()){return}const n=t.getViewData(),i=t.getModel()?.getMetaModel(),r=n.contextPath||`/${n.entitySet}`,o=this._checkIfDisplayCurrencyIsRequired(i,r);if(!o){return}const s=e.getSelectOption(h),l=a.getSelectOption(h),c=!!l&&l.length>0,d=!s||!s.length;if(d&&c){const t=l[0],a=t["Sign"],n=t["Option"],i=t["Low"],r=t["High"];e.addSelectOption(h,a,n,i,r)}},_getAdjustedSV:async(t,e,a)=>{let n=new i(e.toJSONObject());const r=await t.getSelectionVariant();const o=r?.getSelectOptionsPropertyNames()||[];if(o.length>0){n=o.reduce((t,e)=>{const n=t.getSelectOption(e);if(a&&!n?.length||!a){const a=r.getSelectOption(e);t.massAddSelectOption(e,a||[])}return t},n)}return n},_applySelectionVariant:async function(t,e,a){const n=t.getController()._getFilterBarControl();const{selectionVariant:i,selectionVariantDefaults:r,requiresStandardVariant:o=false,bNavSelVarHasDefaultsOnly:s=false}=e;if(!n||!i){return Promise.resolve()}const l=this._getFilterBarVM(t);const c=await this._activeVariantAndGetAppStateOverride(l,o,a);if(c){this._addDefaultDisplayCurrencyToSV(t,i,r);const e=r?r.getSelectOptionsPropertyNames().length>0:false;const o=l&&l.getDefaultVariantKey()===l.getStandardVariantKey();const c=e&&(o||!l)&&s;const d=n.getParent();let g=i;if(a||c){g=await this._getAdjustedSV(d,i,c)}return d.setSelectionVariant(g,true)}},_activeVariantAndGetAppStateOverride:async function(t,e,a){if(t&&!a){let a=e?t.getStandardVariantKey():t.getDefaultVariantKey();if(a===null){a=t.getId()}await s.activateVariant({element:t,variantReference:a});return e||t.getDefaultVariantKey()===t.getStandardVariantKey()}return true},_fnClearStateBeforexAppNav:async function(e){return l.retrieveExternalState(e).then(t=>{const e=t.filter;for(const t in e){if(t!=="$editState"&&t!=="$search"&&e[t]){e[t].forEach(t=>{t["filtered"]=false})}}return e}).catch(function(e){t.error("Error while retrieving the external state",e)})},_clearFilterConditions:async function(t){const e=[];return t.waitForInitialization().then(async()=>{const a=await this._fnClearStateBeforexAppNav(t);return l.applyExternalState(t,{filter:a,items:e})})}};return p},false);
//# sourceMappingURL=ViewState.js.map