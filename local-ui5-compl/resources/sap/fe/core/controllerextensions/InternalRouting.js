/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/routing/ContextPathHelper","sap/fe/core/controllerextensions/routing/NavigationReason","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../converters/MetaModelConverter","./messageHandler/messageHandling"],function(t,e,o,n,i,r,a,s,c,g,l,u,p,h,d){"use strict";var f,C,P,_,v,y,m,x,b,R,B,w,E,O,S,A,T,D,M,F,V,I,N,L;var H=h.getInvolvedDataModelObjects;var j=r.resolvePath;var $=r.isPathOnDraftRoot;var k=r.getDraftOrActiveContext;var K=e.publicExtension;var q=e.methodOverride;var z=e.finalExtension;var U=e.extensible;var W=e.defineUI5Class;function G(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,Q(t,e)}function Q(t,e){return Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Q(t,e)}function J(t,e,o,n,i){var r={};return Object.keys(n).forEach(function(t){r[t]=n[t]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=o.slice().reverse().reduce(function(o,n){return n(t,e,o)||o},r),i&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(i):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(t,e,r),null):r}let X=(f=W("sap.fe.core.controllerextensions.InternalRouting"),C=q(),P=q(),_=K(),v=U(p.After),y=K(),m=U(p.After),x=K(),b=U(p.After),R=K(),B=U(p.After),w=K(),E=K(),O=K(),S=z(),A=K(),T=z(),D=K(),M=K(),F=z(),V=K(),I=U(p.Before),f(N=(L=function(e){function r(){return e.apply(this,arguments)||this}G(r,e);var u=r.prototype;u.onExit=function t(){if(this._oRoutingService){this._oRoutingService.detachRouteMatched(this._fnRouteMatchedBound)}};u.onInit=function t(){this._oView=this.base.getView();this._oAppComponent=o.getAppComponent(this._oView);this._oPageComponent=g.getOwnerComponentFor(this._oView);this._oRouter=this._oAppComponent.getRouter();this._oRouterProxy=this._oAppComponent.getRouterProxy();if(!this._oAppComponent||!this._oPageComponent){throw new Error("Failed to initialize controler extension 'sap.fe.core.controllerextesions.InternalRouting")}if(this._oAppComponent===this._oPageComponent){this._oPageComponent=null}this._oAppComponent.getService("routingService").then(t=>{this._oRoutingService=t;this._fnRouteMatchedBound=this._onRouteMatched.bind(this);this._oRoutingService.attachRouteMatched({},this._fnRouteMatchedBound);this._oTargetInformation=t.getTargetInformationFor(this._oPageComponent||this._oView)??{};return}).catch(function(){throw new Error("This controller extension cannot work without a 'routingService' on the main AppComponent")})};u.onRouteMatched=function t(){};u.onRouteMatchedFinished=function t(){};u.onBeforeBinding=function t(e,o){};u.beforeSetBindingContext=function t(e,o){this.onBeforeBinding(e,o);const n=this.base.getView().getController().routing;if(n&&n.onBeforeBinding){n.onBeforeBinding(e)}};u.onAfterBinding=function t(e,o){this._oAppComponent.getRootViewController().onContextBoundToView(e)};u.afterSetBindingContext=function t(e,o){this.onAfterBinding(e,{...o,deferredCreation:true});const n=this.base.getView().getController().routing;if(n&&n.onAfterBinding){n.onAfterBinding(e)}};u.navigateToTarget=async function t(e,o,n,i){const r=this._oPageComponent&&this._oPageComponent.getNavigationConfiguration&&this._oPageComponent.getNavigationConfiguration(o);if(r){const t=r.detail;const o=t.route;const a=t.parameters;return this._oRoutingService.navigateTo(e,o,a,n,i)}else{return this._oRoutingService.navigateTo(e,null,null,n,i)}};u.getHashForNavigation=async function t(e,o){const n=this?._oPageComponent?.getNavigationConfiguration(o);if(n){const t=n.detail;const o=t.route;const i=t.parameters;return this._oRoutingService.getHashFromRoute(e,o,i)}else{return this._oRoutingService.getHashFromRoute(e,null)}};u.navigateToRoute=async function t(e,o){return this._oRoutingService.navigateToRoute(e,o)};u.navigateToContext=async function e(o){let n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(o.isA("sap.ui.model.odata.v4.ODataListBinding")){if(n.createOnNavigateParameters?.mode==="Async"){this._oRouterProxy.activateRouteMatchSynchronization();n.createOnNavigateParameters.createContextPromise.then(async t=>this.navigateToContext(t,{checkNoHashChange:n.checkNoHashChange,editable:n.editable,persistOPScroll:n.persistOPScroll,updateFCLLevel:n.updateFCLLevel,forceFocus:n.forceFocus})).catch(function(e){t.error("Error with the async context",e)})}else if(n.createOnNavigateParameters?.mode!=="Deferred"){throw"navigation to a list binding is not yet supported"}}else if(n.callExtension){const t=this._oView.getModel("internal");t.setProperty("/paginatorCurrentContext",null);const e=await this.base.getView().getController().routing.onBeforeNavigation({bindingContext:o});if(e){t.setProperty("/paginatorCurrentContext",o);return Promise.resolve(true)}}n.FCLLevel=this._getFCLLevel();if(n.reason===a.RowPress&&o.isA("sap.ui.model.odata.v4.Context")){const t=o.getModel();const e=t.getMetaModel();if($(o.getPath(),e)){const t=await this.getContextForNavigationWithCollaboration(o,n)??await this.getContextForNavigationFromTreeOrAnalyticalTable(o);if(t){o=t}}}return this._oRoutingService.navigateToContext(o,n,this._oView.getViewData(),this._oTargetInformation)};u.getContextForNavigationWithCollaboration=async function t(e,o){const n=e.getModel();const i=n.getMetaModel();if(c.isCollaborationDraftSupported(i)&&e.getProperty("IsActiveEntity")===false){const t=await k(e);if(t!==null&&e.getPath()!==t.getPath()){const r=H(i.getMetaContext(e.getPath()));o.redirectedToNonDraft=r.targetEntityType.annotations.UI?.HeaderInfo?.TypeName??r.targetEntityType.name;if(this._oAppComponent.getRootViewController().isFclEnabled()){const o=n.getKeepAliveContext(t.getPath());e.replaceWith(o)}else{s.setEditStateDirty()}return t}}return null};u.getContextForNavigationFromTreeOrAnalyticalTable=async function t(e){const o=e.getBinding();if(!o.isA("sap.ui.model.odata.v4.ODataListBinding")){return null}const n=o.getAggregation();if(!n?.hierarchyQualifier&&!n?.group&&!n?.aggregate){return null}if(e.getProperty("IsActiveEntity")===true&&e.getProperty("HasDraftEntity")===true){const t=await k(e);if(t!==null&&e.getPath()!==t.getPath()){return t}}return null};u.navigateBackFromContext=async function t(e){let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};o.updateFCLLevel=-1;return this.navigateToContext(e,o)};u.navigateForwardToContext=async function t(e){let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(this._oView.getBindingContext("internal")?.getProperty("messageFooterContainsErrors")===true){return Promise.resolve(true)}o.updateFCLLevel=1;return this.navigateToContext(e,o)};u.navigateBackFromTransientState=function t(){const e=this._oRouterProxy.getHash();if(e.includes("(...)")){this._oRouterProxy.navBack()}};u.navigateToMessagePage=async function t(e,o){o=o||{};if(this._oRouterProxy.getHash().includes("i-action=create")||this._oRouterProxy.getHash().includes("i-action=autoCreate")){return this._oRouterProxy.navToHash(this._oRoutingService.getDefaultCreateHash())}else{return this._oAppComponent.getRootViewController().displayErrorPage(e,o,this._getFCLLevel())}};u.isCurrentStateImpactedBy=function t(e){return this._oRoutingService.isCurrentStateImpactedBy(e)};u._isViewPartOfRoute=function t(e){const o=e?.targets;if(!o||!o.includes(this._oTargetInformation.targetName)){if((this._oTargetInformation.viewLevel??0)>=(e?.routeLevel??0)){setTimeout(()=>{if(e?.routeLevel===0&&this.base.collaborativeDraft.isConnected()){this.base.collaborativeDraft.disconnect()}this._setBindingContext(null)},0)}return false}return true};u._buildBindingPath=function t(e,o,n){let i=o.replace(":?query:","");let r=false;for(const t in e){const a=e[t];if(typeof a!=="string"){continue}if(a==="..."&&o.includes(`{${t}}`)){r=true;n.bTargetEditable=true}i=i.replace(`{${t}}`,a)}if(e["?query"]?.["i-action"]?.includes("create")){n.bActionCreate=true}if(i&&i[0]!=="/"){i=`/${i}`}return{path:i,deferred:r}};u._onRouteMatched=function e(o){if(!this._isViewPartOfRoute(o.getParameter("routeInformation"))){return}let n;if(this._oPageComponent&&this._oPageComponent.getBindingContextPattern){n=this._oPageComponent.getBindingContextPattern()}n=n||this._oTargetInformation.contextPattern;if(n===null||n===undefined){n=o.getParameter("routePattern")}const i=o.getParameters().arguments;const r=o.getParameter("navigationInfo");const{path:s,deferred:c}=this._buildBindingPath(i,n,r);this.onRouteMatched();let g;const l=this._oView.getModel();if(c){g=this._bindDeferred(s,r)}else if(r.reason!==a.EditFlowAction&&(this._oRouterProxy.getHash().includes("i-action=edit")||(this._oPageComponent?.isOpenInEditMode?.()??false))){g=this._bindPageForEdit(s,l,r)}else{g=this._bindPage(s,l,r)}g.finally(()=>{this.onRouteMatchedFinished()}).catch(e=>{t.error("Error during page binding "+e.toString())});this._oAppComponent.getRootViewController().updateUIStateForView(this._oView,this._getFCLLevel())};u._bindDeferred=async function t(e,o){this.beforeSetBindingContext(null,{editable:o.bTargetEditable});if(!o.createOnNavigateParameters||o.createOnNavigateParameters.mode==="Deferred"){if(this._oPageComponent&&this._oPageComponent.createDeferredContext){this._oPageComponent.createDeferredContext(e,o.createOnNavigateParameters?.listBinding,o.createOnNavigateParameters?.parentContext,o.createOnNavigateParameters?.data,!!o.bActionCreate)}}const n=this._getBindingContext();if(n?.hasPendingChanges()){n.getBinding().resetChanges()}this._setBindingContext(null);this.afterSetBindingContext(null);return Promise.resolve()};u._bindPageForEdit=async function t(e,n,i){if(e===""){return Promise.resolve(this._bindPageToContext(null,n,i))}try{const t=await j(e,n,this._oRoutingService,this._oRouter);const r=n.getMetaModel();const a=o.isStickyEditMode(this.base.getView());const s=c.isStickySessionSupported(r);if(t.includes("IsActiveEntity=true")||s&&!a){const e=i.useContext?.getPath()===t?i.useContext:this._createContext(t,n);return await this.base.editFlow.editDocument(e)}else{return this._bindPageToPath(t,n,i)}}catch(t){const e=l.getResourceBundleFor("sap.fe.core");this.navigateToMessagePage(e.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:e.getText("C_COMMON_SAPFE_ERROR"),description:t.message})}};u._bindPage=async function t(e,o,n){if(e===""){return Promise.resolve(this._bindPageToContext(null,o,n))}return j(e,o,this._oRoutingService,this._oRouter).then(t=>this._bindPageToPath(t,o,n)).catch(t=>{const e=l.getResourceBundleFor("sap.fe.core");this.navigateToMessagePage(e.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:e.getText("C_COMMON_SAPFE_ERROR"),description:t.message})})};u._bindPageToPath=function e(o,n,i){const r=this._getBindingContext(),g=r&&r.getPath(),l=i.useContext;const u=this._oAppComponent.getRootViewController();if(l&&l.getPath()===o){if(l!==r){let e=false;if(u.isFclEnabled()&&i.reason===a.RowPress){const t=l.getModel().getMetaModel();if(!l.getBinding().hasPendingChanges()&&c.isDraftSupported(t,l.getPath())){e=true}else if(this.base.collaborativeDraft.isConnected()||c.isDraftSupported(t,l.getPath())&&c.isCollaborationDraftSupported(t)){l.getBinding().resetChanges();e=true}}this._bindPageToContext(l,n,i);if(e){this._oAppComponent.getSideEffectsService().requestSideEffects([{$NavigationPropertyPath:""}],l,l.getBinding().getGroupId()).catch(e=>{t.error(`Cannot refresh context: ${e}`)})}}else if(i.reason===a.EditFlowAction){this.beforeSetBindingContext(l,{editable:i.bTargetEditable,listBinding:l.getBinding(),bPersistOPScroll:i.bPersistOPScroll,reason:i.reason,showPlaceholder:i.bShowPlaceholder});this.afterSetBindingContext(l,{redirectedToNonDraft:i?.redirectedToNonDraft})}}else if(g!==o||i.reason===a.EditFlowAction){this._bindPageToContext(this._createContext(o,n),n,i)}else if(i.reason!==a.AppStateChanged&&i.reason!==a.RestoreHistory&&s.isEditStateDirty()&&!u.isFclEnabled()&&r){this._refreshBindingContext(r)}};u._bindPageToContext=function e(o,n,i){if(!o){this.beforeSetBindingContext(null);this.afterSetBindingContext(null);return}const r=o.getBinding();const a=this._oAppComponent.getRootViewController();if(a.isFclEnabled()){if(!r||!r.isA("sap.ui.model.odata.v4.ODataListBinding")){o=this._createContext(o.getPath(),n)}try{this._setKeepAlive(o,true,()=>{if(o&&!this._oAppComponent.isExiting&&a.isContextUsedInPages(o)){this.navigateBackFromContext(o)}},true)}catch(e){t.error(`View for ${o.getPath()} won't be synchronized. Parent listBinding must have binding parameter $$ownRequest=true`)}}else if(!r||r.isA("sap.ui.model.odata.v4.ODataListBinding")){o=this._createContext(o.getPath(),n)}this.beforeSetBindingContext(o,{editable:i.bTargetEditable,listBinding:r,bPersistOPScroll:i.bPersistOPScroll,reason:i.reason,showPlaceholder:i.bShowPlaceholder});this._setBindingContext(o);this.afterSetBindingContext(o,{redirectedToNonDraft:i?.redirectedToNonDraft})};u._createContext=function t(e,o){const i=this._oPageComponent,r=i&&i.getEntitySet&&i.getEntitySet(),a=i&&i.getContextPath&&i.getContextPath()||r&&`/${r}`,s=o.getMetaModel(),g={$$groupId:"$auto.Heroes",$$updateGroupId:"$auto",$$patchWithoutSideEffects:true};const l=s.getObject(`${a}@com.sap.vocabularies.Common.v1.DraftRoot`);const u=s.getObject(`${a}@com.sap.vocabularies.Common.v1.DraftNode`);const p=a?s.getContext(a)&&H(s.getContext(a)):null;const h=c.getAlternateAndSecondaryKeys(p?.targetEntityType,p?.targetEntitySet);const d=l?p?.targetEntityType.annotations.Common?.SemanticKey?.map(t=>t.value)??[]:[];const f=this._oAppComponent.getRootViewController();if(f.isFclEnabled()){const t=this._getKeepAliveContext(o,e,false,g);if(!t){throw new Error(`Cannot create keepAlive context ${e}`)}else if(l||u){const e=["HasActiveEntity","HasDraftEntity","IsActiveEntity"].concat(d);if(t.getProperty("IsActiveEntity")===undefined){t.requestProperty(e);if(l){t.requestObject("DraftAdministrativeData")}}else{t.requestSideEffects(l?e.concat(["DraftAdministrativeData"]):e)}}return t}else{const t=[];if(a){const e=c.getMessagesPath(s,a);if(e){t.push(e)}}if(l||u){t.push("HasActiveEntity","HasDraftEntity","IsActiveEntity");t.push(...d)}t.push(...h);if(t.length){g.$select=t.join(",")}if(this._oView.getBindingContext()){const t=this._oView.getBindingContext()?.getBinding();if(t){o.resetChanges(t.getUpdateGroupId());t.destroy()}}const i=o.bindContext(e,undefined,g);i.attachEventOnce("dataRequested",()=>{n.lock(this._oView)});i.attachEventOnce("dataReceived",this.onDataReceived.bind(this));return i.getBoundContext()}};u.onDataReceived=async function e(o){const i=o?.getParameter("error");if(n.isLocked(this._oView)){n.unlock(this._oView)}if(i){const e=this.base.messageHandler;const o=e.registerToHoldMessages();let n={};const r=i.status??i.cause?.status;try{const t=l.getResourceBundleFor("sap.fe.core");if(r===503){n={isInitialLoad503Error:true,shellBack:true}}else if(r===400){n={title:t.getText("C_COMMON_SAPFE_ERROR"),description:t.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR_DESCRIPTION"),isDataReceivedError:true,shellBack:true}}else{n={title:t.getText("C_COMMON_SAPFE_ERROR"),description:i?.message,isDataReceivedError:true,shellBack:true}}}catch(e){t.error("Error while getting the core resource bundle",e)}finally{n.unHoldKey=o;await e.showMessages(n)}}};u._refreshBindingContext=function t(e){const o=this._oPageComponent;const n=this._oAppComponent.getSideEffectsService();const i=e.getPath();const r=o&&o.getEntitySet&&o.getEntitySet();const a=o&&o.getContextPath&&o.getContextPath()||r&&`/${r}`;const s=this._oView.getModel().getMetaModel();let g;const l=[];const u=[];const p={targetProperties:[],targetEntities:[]};function h(t){let e;const o=(t.getContext()?.getPath()??"").replace(i,"");const n=(o?`${o.slice(1)}/`:o)+t.getPath();if(t.isA("sap.ui.model.odata.v4.ODataContextBinding")){e=t.getDependentBindings();if(e){for(const t of e){h(t)}}else if(!l.includes(n)){l.push(n)}}else if(t.isA("sap.ui.model.odata.v4.ODataListBinding")){if(!l.includes(n)){l.push(n)}}else if(t.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(!u.includes(n)){u.push(n)}}}if(a){g=c.getMessagesPath(s,a)}h(e.getBinding());let d;for(d=0;d<l.length;d++){p.targetEntities.push({$NavigationPropertyPath:l[d]})}p.targetProperties=u;if(g){p.targetProperties.push(g)}p.targetProperties=p.targetProperties.reduce((t,e)=>{if(e){const o=e.indexOf("/");t.push(o>0?e.slice(0,o):e)}return t},[]);n.requestSideEffects([...p.targetEntities,...p.targetProperties],e)};u._getBindingContext=function t(){if(this._oPageComponent){return this._oPageComponent.getBindingContext()}else{return this._oView.getBindingContext()}};u._setBindingContext=function t(e){let o,n;if(this._oPageComponent){o=this._oPageComponent.getBindingContext();n=this._oPageComponent}else{o=this._oView.getBindingContext();n=this._oView}n.setBindingContext(e);if(o?.isKeepAlive()&&o!==e){this._setKeepAlive(o,false)}};u._getFCLLevel=function t(){return this._oTargetInformation.FCLLevel};u._setKeepAlive=function t(e,o,n,i){if(e.getPath().endsWith(")")){const t=e.getModel().getMetaModel();const r=t.getMetaPath(e.getPath());const a=c.getMessagesPath(t,r);e.setKeepAlive(o,n,!!a&&i)}};u._getKeepAliveContext=function t(e,o,n,i){const r=o.split("/");const a=[];while(r.length&&!r[r.length-1].endsWith(")")){a.push(r.pop())}if(r.length===0){return undefined}const s=r.join("/");const c=e.getKeepAliveContext(s,n,i);if(a.length===0){return c}else{a.reverse();const t=a.join("/");return e.bindContext(t,c).getBoundContext()}};u.switchFullScreen=function e(){const o=this.base.getView();const n=o.getModel("fclhelper"),i=n.getProperty("/actionButtonsInfo/isFullScreen"),r=n.getProperty(i?"/actionButtonsInfo/exitFullScreen":"/actionButtonsInfo/fullScreen"),a=this._oAppComponent.getRootViewController();const s=a.getRightmostContext?a.getRightmostContext():o.getBindingContext();this.base._routing.navigateToContext(s,{layout:r}).catch(function(){t.warning("cannot switch between column and fullscreen")})};u.closeColumn=function t(){const e=this._oView.getViewData();const o=this._oView.getBindingContext();const n=o.getModel().getMetaModel();const r={noPreservationCache:true,sLayout:this._oView.getModel("fclhelper").getProperty("/actionButtonsInfo/closeColumn")};if(e?.viewLevel===1&&c.isDraftSupported(n,o.getPath())){i.processDataLossOrDraftDiscardConfirmation(()=>{this.navigateBackFromContext(o,r)},Function.prototype,o,this._oView.getController(),false,i.NavigationType.BackNavigation)}else{this.navigateBackFromContext(o,r)}d.removeTransistionMessageForContext(o)};return r}(u),J(L.prototype,"onExit",[C],Object.getOwnPropertyDescriptor(L.prototype,"onExit"),L.prototype),J(L.prototype,"onInit",[P],Object.getOwnPropertyDescriptor(L.prototype,"onInit"),L.prototype),J(L.prototype,"onRouteMatched",[_,v],Object.getOwnPropertyDescriptor(L.prototype,"onRouteMatched"),L.prototype),J(L.prototype,"onRouteMatchedFinished",[y,m],Object.getOwnPropertyDescriptor(L.prototype,"onRouteMatchedFinished"),L.prototype),J(L.prototype,"onBeforeBinding",[x,b],Object.getOwnPropertyDescriptor(L.prototype,"onBeforeBinding"),L.prototype),J(L.prototype,"onAfterBinding",[R,B],Object.getOwnPropertyDescriptor(L.prototype,"onAfterBinding"),L.prototype),J(L.prototype,"navigateToTarget",[w],Object.getOwnPropertyDescriptor(L.prototype,"navigateToTarget"),L.prototype),J(L.prototype,"navigateToRoute",[E],Object.getOwnPropertyDescriptor(L.prototype,"navigateToRoute"),L.prototype),J(L.prototype,"navigateBackFromTransientState",[O,S],Object.getOwnPropertyDescriptor(L.prototype,"navigateBackFromTransientState"),L.prototype),J(L.prototype,"isCurrentStateImpactedBy",[A,T],Object.getOwnPropertyDescriptor(L.prototype,"isCurrentStateImpactedBy"),L.prototype),J(L.prototype,"onDataReceived",[D],Object.getOwnPropertyDescriptor(L.prototype,"onDataReceived"),L.prototype),J(L.prototype,"switchFullScreen",[M,F],Object.getOwnPropertyDescriptor(L.prototype,"switchFullScreen"),L.prototype),J(L.prototype,"closeColumn",[V,I],Object.getOwnPropertyDescriptor(L.prototype,"closeColumn"),L.prototype),L))||N);return X},false);
//# sourceMappingURL=InternalRouting.js.map