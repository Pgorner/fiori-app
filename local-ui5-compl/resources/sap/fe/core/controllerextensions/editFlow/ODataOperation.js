/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/library","sap/ui/core/Messaging","sap/ui/core/message/MessageType","sap/ui/model/odata/v4/SubmitMode","../../ActionRuntime","../../operationsHelper","../messageHandler/messageHandling"],function(t,e,i,s,a,r,n,o){"use strict";var c={};const l=e.Constants;let d=function(){function e(t,e,i,s){let a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:{};this.enableStrictHandling=true;this.firstIterationOperations=[];this.operationParameters=[];this.neverSubmitted=true;this.apiGroupIdsToSubmit=new Set;this.operation=t;this.parameters=e;this.messageHandler=i;this.strictHandlingUtilities=s;this.operationProperties=a;this.enableStrictHandling=this.parameters.disableStrictHandling!==true&&!this.operation.isFunction;this.defineOperationParameters()}c=e;var d=e.prototype;d.defineOperationParameters=function t(){if(this.operation._type==="ActionImport"){this.operationParameters=this.operation.action.parameters}else{this.operationParameters=this.operation.isBound?this.operation.parameters.slice(1):this.operation.parameters}};d.execute=async function e(){let i;try{if(this.parameters.aContexts.length){i=await(this.parameters.bGrouped===true?this.executeChangeset():this.executeSequentially())}else{i=await Promise.allSettled([this.executeImport()])}}catch(e){t.error("Error while executing operation "+this.parameters.actionName,e);throw e}finally{this.parameters.fnOnResponse?.()}return i};d.executeImport=async function t(){const e=this.parameters.model.bindContext(`/${this.parameters.actionName}(...)`);this.setParametersValue(e);const i=this.parameters.groupId??"actionImport";const s=[this.invoke(e,i,null)];if(this.parameters.additionalSideEffect){const t=this.parameters.model.bindContext("/unBoundAction").getBoundContext();const e={context:t,pathExpressions:this.parameters.additionalSideEffect.pathExpressions,triggerActions:this.parameters.additionalSideEffect.triggerActions};this.requestSideEffects(e,i,s);t.destroy()}this.defaultSubmit(i);const a=await Promise.all(s);return a[0]};d.executeChangeset=async function t(){const e=this.parameters.aContexts.map(async t=>this.executeBoundOperation(t,this.parameters.groupId));await Promise.allSettled(this.firstIterationOperations);await this.manageStrictHandlingFails();return Promise.allSettled(e)};d.executeSequentially=async function t(){const e=[];await this.parameters.aContexts.reduce(async(t,i,s)=>{await t;e.push(this.executeBoundOperation(i,this.parameters.groupId??`apiMode${s+1}`));await Promise.allSettled(this.firstIterationOperations)},Promise.resolve());await this.manageStrictHandlingFails(true);return Promise.allSettled(e)};d.executeBoundOperation=async function t(e,i){const s=this.parameters.model.bindContext(`${this.parameters.actionName}(...)`,e,this.parameters.mBindingParameters);const a=[];this.setParametersValue(s);const r=i??s.getUpdateGroupId();const n=this.parameters.control?.getRowBinding?.()?.getHeaderContext();const o={context:n?.getPath()===e.getPath()?n:e,pathExpressions:this.parameters.additionalSideEffect?.pathExpressions,triggerActions:this.parameters.additionalSideEffect?.triggerActions};this.parameters.requestSideEffects=this.requestSideEffects.bind(this,o,r,a);const c=this.invoke(s,r,this.parameters.aContexts.findIndex(t=>t===e)+1);a.push(c);this.requestSideEffects(o,r,a);this.defaultSubmit(r);Promise.allSettled(a);return c};d.invoke=async function t(e,i,s){let a;let r;let o;const c=new Promise(function(t,e){r=t;o=e});this.firstIterationOperations.push(c);if(i&&this.isAPIMode(i)){this.apiGroupIdsToSubmit.add(i)}try{const t=this.parameters.aContexts.length?this.parameters.aContexts.length:null;const o=e.invoke(i,this.operationProperties.ignoreETag,this.enableStrictHandling?n.fnOnStrictHandlingFailed.bind(this,i,this.parameters,s,e.getContext(),t,this.messageHandler,this.strictHandlingUtilities,r):undefined,this.operationProperties.replaceWithRVC);await Promise.race([o,c]);a=await o;r();if(!this.parameters.bGrouped){this.update412TransitionMessages(e,i,true)}}catch(t){if(!this.parameters.bGrouped){this.update412TransitionMessages(e,i)}o(t);throw l.ActionExecutionFailed}return{returnedContext:a,boundContext:e.getBoundContext()}};d.submit=function t(){if(!this.neverSubmitted||this.apiGroupIdsToSubmit.size===0){return}for(const t of Array.from(this.apiGroupIdsToSubmit.values())){this.submitOnModel(t)}this.parameters.fnOnSubmitted?.()};d.submitOnModel=function t(e){this.parameters.model.submitBatch(e);this.apiGroupIdsToSubmit.delete(e)};d.isAPIMode=function t(e){if(!e){return false}if(e.startsWith("$auto")||e.startsWith("$direct")||e.startsWith("$single")){return false}const i=this.parameters.appComponent.getManifestEntry("sap.ui5")?.models[""]?.settings?.groupProperties?.[e]?.submit;if(i===undefined||[a.Auto,a.Direct].includes(i)){return true}return true};d.defaultSubmit=function t(e){const i=this.neverSubmitted;const s=this.isAPIMode(e);if(!s){this.neverSubmitted=false}else if(this.operationProperties.deferredSubmit!==true&&e){this.neverSubmitted=false;this.submitOnModel(e)}if(i&&!this.neverSubmitted){this.parameters.fnOnSubmitted?.()}};d.manageStrictHandlingFails=async function e(){let s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.strictHandlingUtilities&&this.strictHandlingUtilities.strictHandlingPromises.length){try{if((!o.hasTransitionErrorsOrWarnings()||s)&&this.strictHandlingUtilities.strictHandlingWarningMessages.length){await n.renderMessageView(this.parameters,this.messageHandler,this.strictHandlingUtilities.strictHandlingWarningMessages,this.strictHandlingUtilities,this.parameters.aContexts.length>1)}else{for(const t of this.strictHandlingUtilities.strictHandlingPromises){t.resolve(false)}const t=i.getMessageModel();const e=t.getData();t.setData(e.concat(this.strictHandlingUtilities.strictHandlingWarningMessages))}}catch{t.error("Re-triggering of strict handling operations failed")}}};d.update412TransitionMessages=function t(e,a){let r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(this.enableStrictHandling&&this.strictHandlingUtilities){const t=i.getMessageModel().getData();const{processedMessageIds:n,delaySuccessMessages:o,strictHandlingTransitionFails:c}=this.strictHandlingUtilities;const l=t.reduce((t,e)=>{if(!n.has(e.getId())){t.push(e)}return t},[]);const d=l.filter(t=>t.getPersistent()===true&&t.getType()!==s.Success&&!n.has(t.getId())).map(t=>t.getId());if(d.length){this.strictHandlingUtilities.processedMessageIds=new Set([...Array.from(n),...d]);o.push(...Object.values(l).filter(t=>t.getType()===s.Success));if(!r&&this.parameters.internalModelContext){c.push({oAction:e,groupId:a})}}}};d.setParametersValue=function t(e){if(this.operationParameters.length){const t=this.parameters.defaultParametersValues??{};for(const i of this.operationParameters){const s=i.name;if(!t[s]){switch(i.type){case"Edm.String":t[s]="";break;case"Edm.Boolean":t[s]=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":t[s]=0;break;default:break}}e.setParameter(s,t[s])}}};d.requestSideEffects=async function e(i,s,a){const n=this.parameters.appComponent.getSideEffectsService();let o=a??[];if(i){o=o.concat((i.triggerActions??[]).map(async t=>n.executeAction(t,i.context,s)),i.pathExpressions?n.requestSideEffects(i.pathExpressions,i.context,s):[]);if(i.pathExpressions){try{await Promise.all(o);if(this.parameters.operationAvailableMap&&this.parameters.internalModelContext){r.setActionEnablement(this.parameters.internalModelContext,JSON.parse(this.parameters.operationAvailableMap),this.parameters.selectedItems,"table")}return}catch(e){t.error("Error while requesting side effects",e)}}}};return e}();c=d;return c},false);
//# sourceMappingURL=ODataOperation.js.map