{"version":3,"file":"sticky.js","names":["ProgrammingModel","FELibrary","async","editDocumentInStickySession","context","appComponent","messageHandler","model","getModel","metaModel","getMetaModel","metaPath","getMetaPath","getPath","editActionAnnotation","getObject","Error","resourceModel","getResourceModel","actionName","getText","editAction","bindContext","$$inheritExpandSelect","groupId","ignoreETag","undefined","editPromise","execute","operationsHelper","fnOnStrictHandlingFailed","bind","sticky","label","getBinding","isA","submitBatch","newContext","sideEffects","getSideEffectsService","getODataActionSideEffects","triggerActions","length","requestSideEffectsForODataAction","activateDocument","saveActionAnnotation","saveAction","savePromise","err","messagesPath","requestSideEffects","error","Log","discardDocument","discardActionAnnotation","discardAction","then","processDataLossConfirmation","fnProcess","view","programmingModel","uiEditable","CommonUtils","getIsEditable","resourceBundle","Library","getResourceBundleFor","warningMsg","confirmButtonTxt","cancelButtonTxt","Sticky","MessageBox","warning","actions","emphasizedAction","onClose","actionText","info"],"sources":["./sticky.ts"],"sourcesContent":["import { CommonAnnotationTerms } from \"@sap-ux/vocabularies-types/vocabularies/Common\";\nimport Log from \"sap/base/Log\";\nimport type AppComponent from \"sap/fe/core/AppComponent\";\nimport type { FEView } from \"sap/fe/core/BaseController\";\nimport CommonUtils from \"sap/fe/core/CommonUtils\";\nimport { getResourceModel } from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport FELibrary from \"sap/fe/core/library\";\nimport MessageBox from \"sap/m/MessageBox\";\nimport Library from \"sap/ui/core/Lib\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport operationsHelper from \"../../operationsHelper\";\nimport type MessageHandler from \"../MessageHandler\";\n\nconst ProgrammingModel = FELibrary.ProgrammingModel;\n/**\n * Opens a sticky session to edit a document.\n * @param context Context of the document to be edited\n * @param appComponent The AppComponent\n * @param messageHandler The message handler controller extension\n * @returns A Promise resolved when the sticky session is in edit mode\n */\nasync function editDocumentInStickySession(context: Context, appComponent: AppComponent, messageHandler: MessageHandler): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\teditActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/EditAction`);\n\n\tif (!editActionAnnotation) {\n\t\tthrow new Error(`Edit Action for Sticky Session not found for ${metaPath}`);\n\t}\n\tconst resourceModel = getResourceModel(appComponent);\n\tconst actionName = resourceModel.getText(\"C_COMMON_OBJECT_PAGE_EDIT\");\n\tconst editAction = model.bindContext(`${editActionAnnotation}(...)`, context, { $$inheritExpandSelect: true });\n\tconst groupId = \"direct\";\n\t// If the context has not been loaded yet, we can ignore the ETag (as no previous ETag is available)\n\tconst ignoreETag = context.getObject() === undefined ? true : undefined;\n\n\tconst editPromise = editAction.execute(\n\t\tgroupId,\n\t\tignoreETag,\n\t\toperationsHelper.fnOnStrictHandlingFailed.bind(\n\t\t\tsticky,\n\t\t\tgroupId,\n\t\t\t{ appComponent, label: actionName, model },\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tmessageHandler,\n\t\t\tundefined,\n\t\t\tundefined\n\t\t),\n\t\tcontext.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\")\n\t);\n\tmodel.submitBatch(groupId);\n\n\tconst newContext: Context = await editPromise;\n\tconst sideEffects = appComponent.getSideEffectsService().getODataActionSideEffects(editActionAnnotation, newContext);\n\tif (sideEffects?.triggerActions && sideEffects.triggerActions.length) {\n\t\tawait appComponent.getSideEffectsService().requestSideEffectsForODataAction(sideEffects, newContext);\n\t}\n\treturn newContext;\n}\n/**\n * Activates a document and closes the sticky session.\n * @param context Context of the document to be activated\n * @param appComponent Context of the document to be activated\n * @param messageHandler The message handler controller extension\n * @returns A promise resolve when the sticky session is activated\n */\nasync function activateDocument(context: Context, appComponent: AppComponent, messageHandler: MessageHandler): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\tsaveActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/SaveAction`);\n\n\tif (!saveActionAnnotation) {\n\t\tthrow new Error(`Save Action for Sticky Session not found for ${metaPath}`);\n\t}\n\n\tconst resourceModel = getResourceModel(appComponent);\n\tconst actionName = resourceModel.getText(\"C_OP_OBJECT_PAGE_SAVE\");\n\tconst saveAction = model.bindContext(`${saveActionAnnotation}(...)`, context, { $$inheritExpandSelect: true });\n\tconst groupId = \"direct\";\n\n\tconst savePromise = saveAction.execute(\n\t\tgroupId,\n\t\ttrue,\n\t\toperationsHelper.fnOnStrictHandlingFailed.bind(\n\t\t\tsticky,\n\t\t\tgroupId,\n\t\t\t{ appComponent, label: actionName, model },\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tmessageHandler,\n\t\t\tundefined,\n\t\t\tundefined\n\t\t),\n\t\tcontext.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\")\n\t);\n\n\tmodel.submitBatch(groupId);\n\n\ttry {\n\t\treturn await savePromise;\n\t} catch (err) {\n\t\tconst messagesPath = metaModel.getObject(`${metaPath}/@${CommonAnnotationTerms.Messages}/$Path`) as string | undefined;\n\n\t\tif (messagesPath) {\n\t\t\ttry {\n\t\t\t\tawait appComponent.getSideEffectsService().requestSideEffects([messagesPath], context);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tLog.error(\"Error while requesting side effects\", error as string);\n\t\t\t}\n\t\t}\n\t\tthrow err;\n\t}\n}\n/**\n * Discards a document and closes sticky session.\n * @param context Context of the document to be discarded\n * @returns A promise resolved when the document is dicarded\n */\nasync function discardDocument(context: Context): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\tdiscardActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/DiscardAction`);\n\n\tif (!discardActionAnnotation) {\n\t\tthrow new Error(`Discard Action for Sticky Session not found for ${metaPath}`);\n\t}\n\n\tconst discardAction = model.bindContext(`/${discardActionAnnotation}(...)`);\n\treturn discardAction.execute(\"$single\").then(function () {\n\t\treturn context;\n\t});\n}\n\n/**\n * Process the Data loss confirmation.\n * @param fnProcess Function to execute after confirmation\n * @param view Current view\n * @param programmingModel Programming Model of the current page\n * @returns `void` i think\n */\nfunction processDataLossConfirmation(fnProcess: Function, view: FEView, programmingModel: string): void {\n\tconst uiEditable = CommonUtils.getIsEditable(view),\n\t\tresourceBundle = Library.getResourceBundleFor(\"sap.fe.templates\")!,\n\t\twarningMsg = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_MSG\"),\n\t\tconfirmButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CONFIRM_BUTTON\"),\n\t\tcancelButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CANCEL_BUTTON\");\n\n\tif (programmingModel === ProgrammingModel.Sticky && uiEditable) {\n\t\treturn MessageBox.warning(warningMsg, {\n\t\t\tactions: [confirmButtonTxt, cancelButtonTxt],\n\t\t\temphasizedAction: confirmButtonTxt,\n\t\t\tonClose: function (actionText: string) {\n\t\t\t\tif (actionText === confirmButtonTxt) {\n\t\t\t\t\tLog.info(\"Navigation confirmed.\");\n\t\t\t\t\tfnProcess();\n\t\t\t\t} else {\n\t\t\t\t\tLog.info(\"Navigation rejected.\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\treturn fnProcess();\n}\n\n/**\n * Static functions for the sticky session programming model\n * @namespace\n * @experimental This module is only for experimental use! <br/><b>This is only a POC and maybe deleted</b>\n * @since 1.54.0\n */\nconst sticky = {\n\teditDocumentInStickySession: editDocumentInStickySession,\n\tactivateDocument: activateDocument,\n\tdiscardDocument: discardDocument,\n\tprocessDataLossConfirmation: processDataLossConfirmation\n};\n\nexport default sticky;\n"],"mappings":"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","ignoreList":[]}