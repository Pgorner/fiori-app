/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/UIProvider","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/library","sap/m/MessageBox","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType","../ODataOperation"],function(e,t,n,a,s,o,i,r,c,l,g,u,d,f,m){"use strict";function p(e){return new Promise((t,n)=>{sap.ui.require([e],n=>{if(!(n&&n.__esModule)){n=n===null||!(typeof n==="object"&&e.endsWith("/library"))?{default:n}:n;Object.defineProperty(n,"__esModule",{value:true})}t(n)},e=>{n(e)})})}var E=r.getResourceModel;var M=s.convertTypes;var C=n.getCoreUIFactory;const h=c.Constants,y=c.InvocationGrouping;const A=l.Action;async function S(t,n,a,s,o){if(!n||n.length===0){throw new Error("Bound actions always requires at least one context")}o.aContexts=Array.isArray(n)?n:[n];const i=a.getMetaModel(),r=`${i.getMetaPath(o.aContexts[0].getPath())}/${t}`,c=i.createBindingContext(`${r}/@$ui5.overload/0`);o.isCriticalAction=await e.getIsActionCritical(i,r,o.aContexts);const l=M(a.getMetaModel());const g=l.resolvePath(c.getPath()).target;if(!g){throw new Error("Unknown bound action")}return w(g,a,c,s,o)}async function T(t,n,a,s){const o=n.getMetaModel();const i=`/${t}`;const r=M(o);const c=r.resolvePath(i).target,l=c?.action;if(!l){throw new Error("Unknown action import")}const g=r.actions.filter(e=>e.name===l.name).findIndex(e=>!e.isBound),u=c.actionName,d=o.createBindingContext(`/${u}/${g}`);s.isCriticalAction=await e.getIsActionCritical(o,`${i}/@$ui5.overload`);return w(c.action,n,d,a,s)}async function x(e,t,n){if(!t){return Promise.reject("Bound functions always requires a context")}const a=n.getMetaModel(),s=`${a.getMetaPath(t.getPath())}/${e}`,o=a.createBindingContext(s);return I(e,n,o,t)}async function P(e,t){const n=t.getMetaModel(),a=t.bindContext(`/${e}`).getPath(),s=n.createBindingContext(`/${n.createBindingContext(a).getObject("$Function")}/0`);return I(e,t,s)}async function I(e,t,n,a){if(!n?.getObject()){return Promise.reject(new Error(`Function ${e} not found`))}const s=t.bindContext(`${a?.getPath()??""}/${e}(...)`);const o=a?"functionGroup":"functionImport";const i=s.execute(o);t.submitBatch(o);await i;return s.getBoundContext()}async function b(e,t){if(t===undefined||t===null){return t}const n=(await p("sap/ui/mdc/enums/BaseType")).default;const a=(await p("sap/ui/mdc/odata/v4/TypeMap")).default;const s=e.type?a.getBaseType(e.type):n.String;const o=a.getDataTypeInstance(s);return o.parseValue(t,"string")}async function w(e,t,n,s,o){let r={is412Executed:false,strictHandlingTransitionFails:[],strictHandlingPromises:[],strictHandlingWarningMessages:[],delaySuccessMessages:[],processedMessageIds:new Set};const c=e.isBound?e.fullyQualifiedName.replace(/\(.*\)$/g,""):e.name;o.bGrouped=o.invocationGrouping===y.ChangeSet;return new Promise(async function(l,g){const d=o.label;let f=o.skipParameterDialog;const p=o.aContexts;const E=o.bIsCreateAction;const h=o.isCriticalAction;let A;let S;let T;let x;let P;const I=n.getObject();const w=e.isBound?e.parameters.slice(1):e.parameters;const _=w.length>0&&!(w.length===1&&w[0].name==="ResultIsActiveEntity");const B=o.parameterValues;const H=s.getComponentData();const N=H&&H.startupParameters||{};f=w.length&&w.filter(e=>e.name!=="ResultIsActiveEntity").every(e=>e.annotations.UI?.Hidden?.valueOf()===true)?true:f;if(_&&f){P=$(!!E,w,B,N)}const R={defaultParametersValues:{},appComponent:s,fnOnSubmitted:o.onSubmitted,fnOnResponse:o.onResponse,actionName:c,aContexts:[],model:t,aActionParameters:w,defaultValuesExtensionFunction:o.defaultValuesExtensionFunction,label:o.label,selectedItems:o.selectedItems};if(e.isBound){A=t.getMetaModel();const n=M(A);const a=n.entitySets.filter(t=>t.entityType===e.returnEntityType);const s=a.length>0?a[0]:undefined;x=!e.returnCollection&&e.returnEntityType&&e.sourceEntityType===e.returnEntityType;if(x&&i.isDraftRoot(s)){o.mBindingParameters??={};o.mBindingParameters.$select=o.mBindingParameters.$select?`${o.mBindingParameters.$select},HasActiveEntity`:"HasActiveEntity"}if(o.additionalSideEffect?.pathExpressions){S=i.getMessagesPath(A,p[0].getPath());if(S){T=o.additionalSideEffect.pathExpressions.findIndex(e=>typeof e==="string"&&(e===S||e==="*"));if(T>-1||x){o.mBindingParameters??={};if(e.returnEntityType?.entityProperties.find(e=>e.name===S)&&!(o.mBindingParameters.$select??"").split(",").includes(S)){o.mBindingParameters.$select=o.mBindingParameters.$select?`${o.mBindingParameters.$select},${S}`:S;if(T===-1){o.additionalSideEffect.pathExpressions.push("*")}if(o.additionalSideEffect.triggerActions?.length===0&&T>-1){o.additionalSideEffect.pathExpressions.splice(T,1)}}}}}R.aContexts=p??[];R.mBindingParameters=o.mBindingParameters;R.additionalSideEffect=o.additionalSideEffect;R.bGrouped=o.invocationGrouping===y.ChangeSet;R.internalModelContext=o.internalModelContext;R.operationAvailableMap=o.operationAvailableMap;R.isCreateAction=E;R.bObjectPage=o.bObjectPage;R.disableStrictHandling=o.disableStrictHandling;R.groupId=o.groupId;if(o.controlId){R.control=o.parentControl.byId(o.controlId);o.control=R.control}else{R.control=o.parentControl;o.control=o.parentControl}}R.additionalSideEffect=o.additionalSideEffect;if(E){R.bIsCreateAction=E}R.isStatic=e.isBound&&!!e.parameters[0]?.isCollection;let F=[];let G=false;try{if(_){if(!(f&&P)){G=true;const t=C().newParameterDialog(e,n,R,B,o.entitySetName,o.view,o.messageHandler,r,{beforeShowingMessage:D},o.ignoreETag);await t.createDialog();F=await t.openDialog(o.parentControl)}}else if(h){G=true;F=await O(e,c,R,o.parentControl,o.entitySetName,o.messageHandler,r,o.ignoreETag)}}catch(e){g(e)}if(G){v(o,R,I);l(F);return}if(B){for(const e in R.aActionParameters){R.defaultParametersValues[R.aActionParameters[e].name]=B?.find(t=>t.name===R.aActionParameters[e].name)?.value}}else{let e,t;for(const n in R.aActionParameters){e=R.aActionParameters[n];t=N[e.name]?.[0]||e.annotations?.UI?.ParameterDefaultValue?.valueOf();R.defaultParametersValues[e.name]=t===undefined?t:await b(e,t)}}let L=[];try{L=await new m(e,R,o.messageHandler,r,{ignoreETag:o.ignoreETag}).execute();const t=u.getMessageModel().getData();if(r&&r.is412Executed&&r.strictHandlingTransitionFails.length){r.delaySuccessMessages=r.delaySuccessMessages.concat(t)}v(o,R,I);l(L)}catch(e){g(e)}finally{if(r&&r.is412Executed&&r.strictHandlingTransitionFails.length&&o.aContexts.length>1){try{const t=r.strictHandlingTransitionFails;const n=[];t.forEach(function(e){n.push(e.oAction.getContext())});R.aContexts=n;const a=await new m(e,R,o.messageHandler,r,{ignoreETag:o.ignoreETag}).execute();r.strictHandlingTransitionFails=[];u.addMessages(r.delaySuccessMessages);v(o,R,I);l(a)}catch(e){g(e)}}let t=false;if(o.bGrouped&&r&&r.strictHandlingPromises.length||o.bGrouped&&a.hasTransitionErrorsOrWarnings()){t=true}o?.messageHandler?.showMessageDialog({control:R?.control,onBeforeShowMessage:function(e,n){return D(R,p,undefined,e,n,t,L.length>0&&L.every(e=>e.status==="fulfilled"))},aSelectedContexts:o.aContexts,sActionName:d,entitySet:o.entitySetName,boundActionName:c}).then(()=>{o.messageHandler.clearStrictWarningMessages();return});if(r){r={is412Executed:false,strictHandlingTransitionFails:[],strictHandlingPromises:[],strictHandlingWarningMessages:[],delaySuccessMessages:[],processedMessageIds:new Set}}}})}function _(e,t){const n="C_OPERATIONS_ACTION_CONFIRM_TITLE";const a=E(e);const s=a.checkIfResourceKeyExists(`${n}|${t}`);if(s){return a.getText(n,undefined,t)}}async function O(e,t,n,a,s,o,i,r){return new Promise((c,g)=>{let u=t;u=u.includes(".")?u.split(".")[u.split(".").length-1]:u;const d=u&&s?`${s}|${u}`:"";const f=E(a);const p=f.getText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",undefined,d);l.confirm(p,{title:_(a,d),onClose:async function(t){if(t===A.OK){try{const t=await new m(e,n,o,i,{ignoreETag:r}).execute();c(t)}catch(e){try{await o.showMessageDialog();g(e)}catch(t){g(e)}}}else{g(h.CancelActionDialog)}}})})}function v(t,n,a){if(n.internalModelContext&&n.operationAvailableMap&&n.aContexts&&n.aContexts.length&&a.$IsBound){let t=[];const a=n.isStatic;if(!a){t=n.internalModelContext.getProperty("selectedContexts")||[];e.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),t,"table")}else if(n.control){const a=n.control;if(a.isA("sap.ui.mdc.Table")){t=a.getSelectedContexts();e.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),t,"table")}}o.updateDeleteInfoForSelectedContexts(n.internalModelContext,t)}}function B(e,n,s,o,i,r,c){if(r&&n){a.removeContextMessagesfromModel(e,s)}let l;if(!(i&&t.getIsEditable(i))){if(r&&n){if(o?.length===0){l=false;c=false}e=a.removeMessagesForActionParameterDialog(e)}}else{if(o?.length===0){l=false}e=a.removeMessagesForActionParameterDialog(e)}return{messagesToShow:e,containsBoundTransistion:l,showMessageInDialog:c}}function D(e,n,s,o,i,r,c){let l=i.showMessageBox,m=i.showMessageDialog;const p=e.control;const E=g.getResourceBundleFor("sap.fe.core");const M=o.filter(function(e){return e.getTargets()?.[0]===""});const C=o.filter(function(t){return t.getTargets&&t.getTargets()?.[0].includes(e.actionName)&&e?.aActionParameters?.some(function(e){return t.getTargets()?.[0].includes(e.name)})});C?.forEach(function(e){e.isAPDTarget=true});const h=C.length?true:false;if(r&&!h&&!c){const n=u.getMessageModel();const s=n.getData();const i=a.getMessages(true);let r;const c=(p&&t.getIsEditable(p))??false;const g=o.findIndex(function(e){return e.getType()==="Error"||e.getType()==="Warning"});const M=s.findIndex(function(e){return e.getType()==="Error"||e.getType()==="Warning"});if(g!==1&&M!==-1&&e.aContexts&&e.aContexts.length>1){if(s.length===1&&i.length===1){r=H(c,E);o.unshift(r);l=true;m=false}else{const e=E.getText("C_COMMON_DIALOG_CANCEL_ERROR_MESSAGES_TEXT");const t=E.getText("C_COMMON_DIALOG_CANCEL_ERROR_MESSAGES_DETAIL_TEXT");r=new d({message:e,type:f.Error,target:"",persistent:true,description:t,code:"FE_CUSTOM_MESSAGE_CHANGESET_ALL_FAILED"});o.unshift(r);if(o.length===1){l=true;m=false}else{m=true;l=false}}}}if(s&&s.isOpen()&&n.length!==0&&!e.isStatic){if(!e.bGrouped){if(n.length>1||!h){s.close();s.destroy()}}else if(!h){s.close();s.destroy()}}const y=[];const A=s&&s.isOpen();const{messagesToShow:S,containsBoundTransistion:T,showMessageInDialog:x}=B(o,h,n,M,p,A);o=S;m=x??m;if(!A&&h&&!e.bGrouped){m=true;o=o.concat(C)}let P;if(p&&p.isA("sap.ui.mdc.Table")){P=a.setMessageSubtitle.bind({},p,n)}return{showMessageBox:l,showMessageDialog:m,filteredMessages:y.length?y:o,fnGetMessageSubtitle:P,showChangeSetErrorDialog:e.bGrouped,containsBoundTransistion:T}}function $(e,t,n,a){const s=t.every(e=>e?.annotations?.UI?.Hidden?.valueOf()===true);if(n?.length&&!s){for(const e of t){if(e.name!=="ResultIsActiveEntity"&&!n?.find(t=>t.name===e.name)){return false}}}if(e&&a?.length&&!s){for(const e of t){if(a&&!a[e.name]){return false}}}if(t.length&&s){return t.every(function(e){const t=e.annotations?.Common?.FieldControl;const s=t?.toString()==="Common.FieldControlType/Mandatory";return!s||a&&a[e.name]||n?.find(t=>t.name===e.name)||e?.annotations?.UI?.ParameterDefaultValue?.valueOf()})}return true}function H(e,t){const n=e?t.getText("C_COMMON_DIALOG_CANCEL_SINGLE_ERROR_MESSAGE_TEXT_EDIT"):t.getText("C_COMMON_DIALOG_CANCEL_SINGLE_ERROR_MESSAGE_TEXT");return new d({message:n,type:f.Error,target:"",persistent:true,code:"FE_CUSTOM_MESSAGE_CHANGESET_ALL_FAILED",technicalDetails:{fe:{changeSetPreTextForSingleError:n}}})}const N={callBoundAction:S,callActionImport:T,callBoundFunction:x,callFunctionImport:P,valuesProvidedForAllMandatoryParameters:$,actionParameterShowMessageCallback:D,afterActionResolution:v,checkParameterTypeAndReturnConvertedValue:b,getConfirmTitle:_};return N},false);
//# sourceMappingURL=facade.js.map