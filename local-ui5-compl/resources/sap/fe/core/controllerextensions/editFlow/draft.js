/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/editFlow/draftDataLossPopup","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/TypeGuards","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/Text","sap/ui/core/Lib","../../helpers/ModelHelper","../../operationsHelper"],function(e,t,n,o,i,r,a,s,c,u,d,f,g,l){"use strict";var h=a.isPathAnnotationExpression;var p=r.getResourceModel;var E=i.getInvolvedDataModelObjects;const A={EDIT:"EditAction",ACTIVATION:"ActivationAction",DISCARD:"DiscardAction",PREPARE:"PreparationAction"};function P(e,t){const n=e.getModel(),o=n.getMetaModel(),i=o.getMetaPath(e.getPath());return o.getObject(`${i}@com.sap.vocabularies.Common.v1.DraftRoot/${t}`)}function m(e,t,n){const o=P(e,t);return e.getModel().bindContext(`${o}(...)`,e,n)}function C(e,t){const n=e.getModel(),o=n.getMetaModel(),i=o.getMetaPath(e.getPath());return o.getObject(`${i}@com.sap.vocabularies.Common.v1.DraftRoot/${t}/$ReturnType`)}function w(e){return!!P(e,A.PREPARE)}async function D(e,n,o,i,r,a){if(e.getObject()===undefined||e.getProperty("IsActiveEntity")){const s={$$inheritExpandSelect:true};const c=$.createOperation(e,A.EDIT,s);c.setParameter("PreserveChanges",n);const u=e.getObject()===undefined?true:undefined;const d=p(o);const f=d.getText("C_COMMON_OBJECT_PAGE_EDIT");const g=c.execute(i,u,l.fnOnStrictHandlingFailed.bind($,i,{appComponent:t.getAppComponent(o),label:f,model:e.getModel()},null,null,null,r,undefined,undefined),e.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"));if(a){c.getModel().submitBatch(i)}return g}else{throw new Error("You cannot edit this draft document")}}async function x(t,n,o){if(g.getMessagesPath(t.getModel().getMetaModel(),t.getPath())&&$.hasPrepareAction(t)){try{if(!o&&!t.isKeepAlive()){await t.getBinding().requestObject("")}const e=$.executeDraftPreparationAction(t,t.getUpdateGroupId(),true,o);if(!C(t,A.PREPARE)){T(t,n.getSideEffectsService())}return await e}catch(t){e.error("Error while requesting messages",t)}}return undefined}async function y(t,n,o,i){const r=w(t);const a=r;if(!t.getProperty("IsActiveEntity")){const s=m(t,A.ACTIVATION,{$$inheritExpandSelect:true});const c=p(n);const u=c.getText("C_OP_OBJECT_PAGE_SAVE");try{return await s.execute(i,a,i?l.fnOnStrictHandlingFailed.bind($,i,{appComponent:n,label:u,model:t.getModel()},null,null,null,o,undefined,undefined):undefined,t.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"))}catch(o){if(r){const o=P(t,A.PREPARE),i=n.getSideEffectsService(),r=i.getODataActionSideEffects(o,t),a=r&&r.pathExpressions;if(a&&a.length>0){try{await i.requestSideEffects(a,t)}catch(t){e.error("Error while requesting side effects",t)}}else{try{await T(t,i)}catch(t){e.error("Error while requesting messages",t)}}}throw o}}else{throw new Error("The activation action cannot be executed on an active document")}}function M(e){return C(e,A.PREPARE)?v(e):undefined}function v(e){const t=e.getModel().getMetaModel().getMetaContext(e.getPath());const n=E(t);const o=n.targetEntityType.annotations.Common?.Messages;return h(o)?o.path:undefined}async function b(t,n,o,i){if(!t.getProperty("IsActiveEntity")){const r=o?M(t):undefined;const a=m(t,A.PREPARE,r?{$select:r}:undefined);a.setParameter("SideEffectsQualifier","");const s=n||a.getGroupId();return a.execute(s,i).then(function(){return a}).catch(function(t){e.error("Error while executing the operation",t)})}else{throw new Error("The preparation action cannot be executed on an active document")}}async function T(e,t){const n=g.getMessagesPath(e.getModel().getMetaModel(),e.getPath());if(n){return t.requestSideEffects([n],e)}return}async function O(e,t,n,o){if(!e.getProperty("IsActiveEntity")){const i=$.createOperation(e,A.DISCARD);const r=p(n);const a="direct";const s=r?.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON")||"";const c=!o?i.execute(a):i.execute(a,undefined,l.fnOnStrictHandlingFailed.bind($,a,{AppComponent:n,label:s,model:e.getModel()},null,null,null,t,undefined,undefined),false);e.getModel().submitBatch(a);await c}else{throw new Error("The discard action cannot be executed on an active document")}}async function S(t,n,o,i){if(!n.getPath().startsWith(t.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(n.getProperty("IsActiveEntity")===false&&n.getProperty("HasActiveEntity")===false){return undefined}const r=t.getModel();try{const e=n.getPath().replace(t.getPath(),"");const a=e?e.substring(1).split("/"):[];a.unshift(t.getPath().substring(1));const s=[];const c=[];let u="";const d=[...a];if(o?.rootSiblingPathPromise){d.shift();u="/"+t?.getPath()?.substring(1)}const f=d.map(async e=>{u+=`/${e}`;s.unshift(u);if(u.endsWith(")")){const e=r.bindContext(`${u}/SiblingEntity`,undefined,i?{$$groupId:i}:undefined).getBoundContext();return e.requestCanonicalPath()}else{return Promise.resolve(undefined)}});const g=await Promise.all(f);if(o?.rootSiblingPathPromise){const e=(await o.rootSiblingPathPromise)?.getPath();g.unshift(e);s.push(t.getPath())}let l="";g.forEach((e,t)=>{if(t!==0){if(a[t].endsWith(")")){const n=a[t].replace(/\(.*$/,"");const o=e.replace(/.*\(/,"(");l+=`/${n}${o}`}else{l+=`/${a[t]}`}}else{l=e}c.unshift(l)});return{targetContext:r.bindContext(l,undefined,{$select:v(n),$$groupId:"$auto.Heroes"}).getBoundContext(),pathMapping:s.map((e,t)=>({oldPath:e,newPath:c[t]}))}}catch(e){return undefined}}async function _(e,n,i,r,a){const s=i||{},c=typeof s.bPreserveChanges==="undefined"||typeof s.bPreserveChanges==="boolean"&&s.bPreserveChanges;async function d(t){const n=e.getModel();const s=n.bindContext(`${e.getPath()}/DraftAdministrativeData`).getBoundContext();const c=p(i.oView);const d=await s.requestObject();if(d){o.removeUnboundTransitionMessages();let t=d.InProcessByUserDescription||d.InProcessByUser;const n=i.oView.getViewData().entitySet;if(t){const e=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_LOCKED_BY_USER",t,n);u.error(e);throw new Error(e)}else{t=d.CreatedByUserDescription||d.CreatedByUser;const o=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_UNSAVED_CHANGES",t,n);await $.showEditConfirmationMessageBox(o,e);return $.executeDraftEditAction(e,false,i.oView,r,a,true)}}else if(t?.message){u.error(t.message)}throw new Error(`Draft creation aborted for document: ${e.getPath()}`)}if(!e){throw new Error("Binding context to active document is required")}let f;try{f=await $.executeDraftEditAction(e,c,i.oView,r,a)}catch(n){if(n.status===409||n.status===423){o.removeBoundTransitionMessages();o.removeUnboundTransitionMessages();const i=await $.computeSiblingInformation(e,e);if(i?.targetContext){await t.waitForContextRequested(i.targetContext);return i.targetContext}else{f=await d(n)}}else if(!(n&&n.canceled)){throw new Error(n)}}if(f){const e=$.getActionName(f,A.EDIT);const t=n.getSideEffectsService().getODataActionSideEffects(e,f);if(t?.triggerActions?.length){await n.getSideEffectsService().requestSideEffectsForODataAction(t,f);return f}else{return f}}else{return undefined}}async function B(e,t,n,o){const i=n||{};if(!e){throw new Error("Binding context to draft document is required")}const r=i.fnBeforeActivateDocument?await i.fnBeforeActivateDocument(e):true;if(!r){throw new Error(`Activation of the document was aborted by extension for document: ${e.getPath()}`)}let a;if(!w(e)){a=await y(e,t,o)}else{const n="$auto";const i=e.getModel().hasPendingChanges("$auto")?true:false;let r=$.executeDraftPreparationAction(e,n,undefined,i);e.getModel().submitBatch(n);const s=$.executeDraftActivationAction(e,t,o,n);try{const e=await Promise.all([r,s]);a=e[1]}catch(t){const i=M(e);if(i){r=$.executeDraftPreparationAction(e,n,true);e.getModel().submitBatch(n);await r;const t=await e.requestObject();if(t[i].length>0){o?.removeTransitionMessages(false,false,e.getPath())}}throw t}}return i.fnAfterActivateDocument?i.fnAfterActivateDocument(e,a):a}async function R(e,t){const n=f.getResourceBundleFor("sap.fe.core");return new Promise(function(o,i){const r=new c({title:n.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING"),state:"Warning",content:new d({text:e}),beginButton:new s({text:n.getText("C_COMMON_OBJECT_PAGE_EDIT"),type:"Emphasized",press:function(){r.close();o(true)}}),endButton:new s({text:n.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:function(){r.close();i(`Draft creation aborted for document: ${t.getPath()}`)}}),afterClose:function(){r.destroy()}});r.addStyleClass("sapUiContentPadding");r.open()})}async function I(e,t,n,o){const i=P(e,A.DISCARD),r=e.getObject().IsActiveEntity;if(r||!r&&!i){if(e.hasPendingChanges()&&!e.isInactive()){return e.getBinding().resetChanges().then(async function(){return e.delete()}).catch(function(e){throw e})}else{return!e.getProperty("IsActiveEntity")&&g.isDraftRoot(E(e.getModel().getMetaModel().getMetaContext(e.getPath()))?.targetEntitySet)&&e.getProperty("HasActiveEntity")?e.getModel().delete(e):e.delete()}}else{await O(e,t,n,o)}}const $={createDraftFromActiveDocument:_,activateDocument:B,deleteDraft:I,executeDraftEditAction:D,executeDraftValidation:x,executeDraftPreparationAction:b,executeDraftActivationAction:y,hasPrepareAction:w,computeSiblingInformation:S,processDataLossOrDraftDiscardConfirmation:n.processDataLossOrDraftDiscardConfirmation,silentlyKeepDraftOnForwardNavigation:n.silentlyKeepDraftOnForwardNavigation,createOperation:m,executeDraftDiscardAction:O,NavigationType:n.NavigationType,getActionName:P,showEditConfirmationMessageBox:R};return $},false);
//# sourceMappingURL=draft.js.map