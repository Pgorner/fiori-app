{"version":3,"names":["ProgrammingModel","FELibrary","editDocumentInStickySession","context","appComponent","messageHandler","model","getModel","metaModel","getMetaModel","metaPath","getMetaPath","getPath","editActionAnnotation","getObject","Error","resourceModel","getResourceModel","actionName","getText","editAction","bindContext","$$inheritExpandSelect","groupId","ignoreETag","undefined","editPromise","execute","operationsHelper","fnOnStrictHandlingFailed","bind","sticky","label","getBinding","isA","submitBatch","newContext","sideEffects","getSideEffectsService","getODataActionSideEffects","triggerActions","length","requestSideEffectsForODataAction","activateDocument","saveActionAnnotation","saveAction","savePromise","err","messagesPath","requestSideEffects","error","Log","discardDocument","discardActionAnnotation","discardAction","then","processDataLossConfirmation","fnProcess","view","programmingModel","uiEditable","CommonUtils","getIsEditable","resourceBundle","Library","getResourceBundleFor","warningMsg","confirmButtonTxt","cancelButtonTxt","Sticky","MessageBox","warning","actions","emphasizedAction","onClose","actionText","info"],"sourceRoot":".","sources":["sticky.ts"],"sourcesContent":["import { CommonAnnotationTerms } from \"@sap-ux/vocabularies-types/vocabularies/Common\";\nimport Log from \"sap/base/Log\";\nimport type AppComponent from \"sap/fe/core/AppComponent\";\nimport type { FEView } from \"sap/fe/core/BaseController\";\nimport CommonUtils from \"sap/fe/core/CommonUtils\";\nimport { getResourceModel } from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport FELibrary from \"sap/fe/core/library\";\nimport MessageBox from \"sap/m/MessageBox\";\nimport Library from \"sap/ui/core/Lib\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport operationsHelper from \"../../operationsHelper\";\nimport type MessageHandler from \"../MessageHandler\";\n\nconst ProgrammingModel = FELibrary.ProgrammingModel;\n/**\n * Opens a sticky session to edit a document.\n * @param context Context of the document to be edited\n * @param appComponent The AppComponent\n * @param messageHandler The message handler controller extension\n * @returns A Promise resolved when the sticky session is in edit mode\n */\nasync function editDocumentInStickySession(context: Context, appComponent: AppComponent, messageHandler: MessageHandler): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\teditActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/EditAction`);\n\n\tif (!editActionAnnotation) {\n\t\tthrow new Error(`Edit Action for Sticky Session not found for ${metaPath}`);\n\t}\n\tconst resourceModel = getResourceModel(appComponent);\n\tconst actionName = resourceModel.getText(\"C_COMMON_OBJECT_PAGE_EDIT\");\n\tconst editAction = model.bindContext(`${editActionAnnotation}(...)`, context, { $$inheritExpandSelect: true });\n\tconst groupId = \"direct\";\n\t// If the context has not been loaded yet, we can ignore the ETag (as no previous ETag is available)\n\tconst ignoreETag = context.getObject() === undefined ? true : undefined;\n\n\tconst editPromise = editAction.execute(\n\t\tgroupId,\n\t\tignoreETag,\n\t\toperationsHelper.fnOnStrictHandlingFailed.bind(\n\t\t\tsticky,\n\t\t\tgroupId,\n\t\t\t{ appComponent, label: actionName, model },\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tmessageHandler,\n\t\t\tundefined,\n\t\t\tundefined\n\t\t),\n\t\tcontext.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\")\n\t);\n\tmodel.submitBatch(groupId);\n\n\tconst newContext: Context = await editPromise;\n\tconst sideEffects = appComponent.getSideEffectsService().getODataActionSideEffects(editActionAnnotation, newContext);\n\tif (sideEffects?.triggerActions && sideEffects.triggerActions.length) {\n\t\tawait appComponent.getSideEffectsService().requestSideEffectsForODataAction(sideEffects, newContext);\n\t}\n\treturn newContext;\n}\n/**\n * Activates a document and closes the sticky session.\n * @param context Context of the document to be activated\n * @param appComponent Context of the document to be activated\n * @param messageHandler The message handler controller extension\n * @returns A promise resolve when the sticky session is activated\n */\nasync function activateDocument(context: Context, appComponent: AppComponent, messageHandler: MessageHandler): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\tsaveActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/SaveAction`);\n\n\tif (!saveActionAnnotation) {\n\t\tthrow new Error(`Save Action for Sticky Session not found for ${metaPath}`);\n\t}\n\n\tconst resourceModel = getResourceModel(appComponent);\n\tconst actionName = resourceModel.getText(\"C_OP_OBJECT_PAGE_SAVE\");\n\tconst saveAction = model.bindContext(`${saveActionAnnotation}(...)`, context, { $$inheritExpandSelect: true });\n\tconst groupId = \"direct\";\n\n\tconst savePromise = saveAction.execute(\n\t\tgroupId,\n\t\ttrue,\n\t\toperationsHelper.fnOnStrictHandlingFailed.bind(\n\t\t\tsticky,\n\t\t\tgroupId,\n\t\t\t{ appComponent, label: actionName, model },\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tnull,\n\t\t\tmessageHandler,\n\t\t\tundefined,\n\t\t\tundefined\n\t\t),\n\t\tcontext.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\")\n\t);\n\n\tmodel.submitBatch(groupId);\n\n\ttry {\n\t\treturn await savePromise;\n\t} catch (err) {\n\t\tconst messagesPath = metaModel.getObject(`${metaPath}/@${CommonAnnotationTerms.Messages}/$Path`) as string | undefined;\n\n\t\tif (messagesPath) {\n\t\t\ttry {\n\t\t\t\tawait appComponent.getSideEffectsService().requestSideEffects([messagesPath], context);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tLog.error(\"Error while requesting side effects\", error as string);\n\t\t\t}\n\t\t}\n\t\tthrow err;\n\t}\n}\n/**\n * Discards a document and closes sticky session.\n * @param context Context of the document to be discarded\n * @returns A promise resolved when the document is dicarded\n */\nasync function discardDocument(context: Context): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\tdiscardActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/DiscardAction`);\n\n\tif (!discardActionAnnotation) {\n\t\tthrow new Error(`Discard Action for Sticky Session not found for ${metaPath}`);\n\t}\n\n\tconst discardAction = model.bindContext(`/${discardActionAnnotation}(...)`);\n\treturn discardAction.execute(\"$single\").then(function () {\n\t\treturn context;\n\t});\n}\n\n/**\n * Process the Data loss confirmation.\n * @param fnProcess Function to execute after confirmation\n * @param view Current view\n * @param programmingModel Programming Model of the current page\n * @returns `void` i think\n */\nfunction processDataLossConfirmation(fnProcess: Function, view: FEView, programmingModel: string): void {\n\tconst uiEditable = CommonUtils.getIsEditable(view),\n\t\tresourceBundle = Library.getResourceBundleFor(\"sap.fe.templates\")!,\n\t\twarningMsg = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_MSG\"),\n\t\tconfirmButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CONFIRM_BUTTON\"),\n\t\tcancelButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CANCEL_BUTTON\");\n\n\tif (programmingModel === ProgrammingModel.Sticky && uiEditable) {\n\t\treturn MessageBox.warning(warningMsg, {\n\t\t\tactions: [confirmButtonTxt, cancelButtonTxt],\n\t\t\temphasizedAction: confirmButtonTxt,\n\t\t\tonClose: function (actionText: string) {\n\t\t\t\tif (actionText === confirmButtonTxt) {\n\t\t\t\t\tLog.info(\"Navigation confirmed.\");\n\t\t\t\t\tfnProcess();\n\t\t\t\t} else {\n\t\t\t\t\tLog.info(\"Navigation rejected.\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\treturn fnProcess();\n}\n\n/**\n * Static functions for the sticky session programming model\n * @namespace\n * @experimental This module is only for experimental use! <br/><b>This is only a POC and maybe deleted</b>\n * @since 1.54.0\n */\nconst sticky = {\n\teditDocumentInStickySession: editDocumentInStickySession,\n\tactivateDocument: activateDocument,\n\tdiscardDocument: discardDocument,\n\tprocessDataLossConfirmation: processDataLossConfirmation\n};\n\nexport default sticky;\n"],"mappings":"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","ignoreList":[],"file":"sticky-dbg.js"}