/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/ClassSupport","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution"],function(t,e,i,r,n,a){"use strict";var o,s,p,l,c,d,u,y,f,g,S,h,v,b,w,A,C,I,O,m,_,P,V,R,j,B,D,K,T,E,M,F,H,N,k,x,L,U,z,$,q,G,Q,W,J,X,Y,Z,tt,et;function it(t){return new Promise((e,i)=>{sap.ui.require([t],i=>{if(!(i&&i.__esModule)){i=i===null||!(typeof i==="object"&&t.endsWith("/library"))?{default:i}:i;Object.defineProperty(i,"__esModule",{value:true})}e(i)},t=>{i(t)})})}var rt=i.publicExtension;var nt=i.privateExtension;var at=i.finalExtension;var ot=i.extensible;var st=i.defineUI5Class;function pt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,lt(t,e)}function lt(t,e){return lt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},lt(t,e)}function ct(t,e,i,r,n){var a={};return Object.keys(r).forEach(function(t){a[t]=r[t]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce(function(i,r){return r(t,e,i)||i},a),n&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(n):void 0,a.initializer=void 0),void 0===a.initializer?(Object.defineProperty(t,e,a),null):a}const dt=r.NavType;const ut="#additionalStates";const yt=async function(){return(await it("sap/ui/mdc/p13n/StateUtil")).default};const ft={"sap.ui.fl.variants.VariantManagement":{retrieve:function(t){return{variantId:t.getCurrentVariantKey()}},apply:async function(e,i){try{if(i&&i.variantId!==undefined&&i.variantId!==e.getCurrentVariantKey()){const r=this._checkIfVariantIdIsAvailable(e,i.variantId);let n;if(r){n=i.variantId}else{n=e.getStandardVariantKey();this.controlsVariantIdUnavailable.push(...e.getFor())}try{const t=(await it("sap/ui/fl/apply/api/ControlVariantApplyAPI")).default;await t.activateVariant({element:e,variantReference:n});await this._setInitialStatesForDeltaCompute(e)}catch(i){t.error(i);this.invalidateInitialStateForApply.push(...e.getFor());await this._setInitialStatesForDeltaCompute(e)}}else{this._setInitialStatesForDeltaCompute(e)}}catch(e){t.error(e)}}},"sap.fe.templates.ListReport.controls.MultipleModeControl":{retrieve:function(t){return{selectedKey:t.content.getSelectedKey()}},apply:function(t,e){if(e?.selectedKey){const i=t.content;if(i.getItems().find(t=>t.getKey()===e.selectedKey)){i.setSelectedKey(e.selectedKey)}}}},"sap.ui.mdc.Table":{refreshBinding:function(e){const i=e.getRowBinding();if(i){const t=i.getRootBinding();const e=i.getAggregation();if(t===i&&e?.hierarchyQualifier===undefined){i.refresh()}else{const t=i.getHeaderContext();const e=i.getGroupId();if(t){t.requestSideEffects([{$NavigationPropertyPath:""}],e)}}}else{t.info(`Table: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.m.SegmentedButton":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e?.selectedKey&&e.selectedKey!==t.getSelectedKey()){t.setSelectedKey(e.selectedKey);if(t.getParent()?.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("selectionChange")}}}},"sap.m.Select":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e?.selectedKey&&e.selectedKey!==t.getSelectedKey()){t.setSelectedKey(e.selectedKey);if(t.getParent()?.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("change")}}}},"sap.f.DynamicPage":{retrieve:function(t){return{headerExpanded:t.getHeaderExpanded()}},apply:function(t,e){if(e){t.setHeaderExpanded(e.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.retrieveViewState()}return{}},apply:async function(t,e,i,r){const n=t.getController();if(n&&n.viewState&&i){return n.viewState.applyViewState(e,i,r)}},refreshBinding:async function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:async function(t){const e=t.getComponentInstance();if(e){return this.retrieveControlState(e.getRootControl())}return{}},apply:async function(t,e,i){const r=t.getComponentInstance();if(r){return this.applyControlState(r.getRootControl(),e,i)}}}};let gt=(o=st("sap.fe.core.controllerextensions.ViewState"),s=rt(),p=at(),l=rt(),c=ot(a.After),d=nt(),u=at(),y=nt(),f=at(),g=rt(),S=ot(a.After),h=rt(),v=ot(a.After),b=rt(),w=ot(a.After),A=nt(),C=at(),I=rt(),O=ot(a.After),m=nt(),_=at(),P=rt(),V=ot(a.After),R=rt(),j=at(),B=rt(),D=at(),K=rt(),T=ot(a.After),E=nt(),M=at(),F=rt(),H=ot(a.Instead),N=rt(),k=at(),x=nt(),L=rt(),U=ot(a.After),z=rt(),$=ot(a.After),q=rt(),G=ot(a.After),Q=nt(),W=rt(),J=ot(a.After),X=nt(),Y=at(),Z=rt(),o(tt=(et=function(i){function r(){var e;e=i.call(this)||this;e.initialControlStatesMapper={};e.controlsVariantIdUnavailable=[];e.invalidateInitialStateForApply=[];e.viewStateControls=[];e.stateContributors=[];e._setInitialStatesForDeltaCompute=async i=>{try{const t=e.viewStateControls;const r=[];const n=[];let a=[];const o=i?.getFor()??[];e.updateInitialState(o);await Promise.all(t.filter(function(t){return t&&(!i||o.includes(t.getId()))&&(t.isA("sap.ui.mdc.Table")||t.isA("sap.ui.mdc.FilterBar")||t.isA("sap.ui.mdc.Chart"))}).map(async t=>{if(i){e._addEventListenersToVariantManagement(i,o)}const a=(await yt()).retrieveExternalState(t);r.push(a);n.push(e.getStateKey(t))}));a=await Promise.all(r);a.forEach((t,i)=>{e.initialControlStatesMapper[n[i]]=t})}catch(e){t.error(e)}};e._iRetrievingStateCounter=0;e._pInitialStateApplied=new Promise(t=>{e._pInitialStateAppliedResolve=t});return e}pt(r,i);var n=r.prototype;n.refreshViewBindings=async function t(){const e=await this.collectResults(this.base.viewState.adaptBindingRefreshControls);let i=Promise.resolve();e.filter(t=>t&&t.isA&&t.isA("sap.ui.base.ManagedObject")).forEach(t=>{i=i.then(this.refreshControlBinding.bind(this,t))});return i};n.adaptBindingRefreshControls=function t(e){};n.refreshControlBinding=async function e(i){const r=this.getControlRefreshBindingHandler(i);let n=Promise.resolve();if(typeof r.refreshBinding!=="function"){t.info(`refreshBinding handler for control: ${i.getMetadata().getName()} is not provided`)}else{n=n.then(r.refreshBinding.bind(this,i))}return n};n.getControlRefreshBindingHandler=function t(e){const i={};if(e){for(const t in ft){if(e.isA(t)){i["refreshBinding"]=ft[t].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(e,i);return i};n.adaptBindingRefreshHandler=function t(e,i){};n.onSuspend=function t(){};n.onRestore=function t(){};n.destroy=function t(){delete this._pInitialStateAppliedResolve;i.prototype.destroy.call(this)};n.collectResults=async function t(e){const i=[];for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++){n[a-1]=arguments[a]}n.push(i);e.apply(this,n);return Promise.all(i)};n.adaptControlStateHandler=function t(e,i){};n.getControlStateHandler=function t(e){const i=[],r=[];if(e){if(e.isA("sap.fe.core.controllerextensions.viewState.IViewStateContributor")&&e.retrieveState&&e.applyState){i.push({retrieve:async t=>e.retrieveState.bind(e)(),apply:async(t,i,r,n)=>{const a=!this.invalidateInitialStateForApply.includes(e.getId())&&!this.controlsVariantIdUnavailable.includes(e.getId())&&r?.navigationType!==dt.hybrid&&n!==true;if(!i){if(e.applyLegacyState){await e.applyLegacyState.bind(e)(this.getControlState.bind(this),r,a,n)}}else{await e.applyState.bind(e)(i,r,a,n)}}})}else{for(const t in ft){if(e.isA(t)){i.push(Object.assign({},ft[t]));break}}}}this.base.viewState.adaptControlStateHandler(e,r);return i.concat(r)};n.adaptStateControls=function t(e){e.push(...this.stateContributors)};n.getStateKey=function t(e){return this.getView().getLocalId(e.getId())||e.getId()};n.retrieveViewState=async function t(){++this._iRetrievingStateCounter;let i;try{await this._pInitialStateApplied;const t=await this.collectResults(this.base.viewState.adaptStateControls);const r=await Promise.all(t.filter(function(t){return t&&t.isA&&t.isA("sap.ui.base.ManagedObject")}).map(async t=>this.retrieveControlState(t).then(e=>({key:this.getStateKey(t),value:e}))));i=r.reduce(function(t,i){const r={};r[i.key]=i.value;return e(t,r)},{});const n=this._currentViewState;if(n&&Object.keys(n).length>0){this._addMissingState(i,n)}const a=await Promise.resolve(this._retrieveAdditionalStates());if(a&&Object.keys(a).length){i[ut]=a}}finally{--this._iRetrievingStateCounter}this._currentViewState=i;return this._iRetrievingStateCounter===0?i:undefined};n._addMissingState=function t(e,i){for(const t in i){if(!(t in e)){e[t]=i[t]}}};n.retrieveAdditionalStates=function t(e){};n._retrieveAdditionalStates=function t(){const e={};this.base.viewState.retrieveAdditionalStates(e);return e};n.retrieveControlState=async function t(i){const r=this.getControlStateHandler(i);return Promise.all(r.map(async t=>{if(typeof t.retrieve!=="function"){throw new Error(`controlStateHandler.retrieve is not a function for control: ${i.getMetadata().getName()}`)}return t.retrieve.call(this,i)})).then(t=>t.reduce(function(t,i){return e(t,i)},{}))};n.applyInitialStateOnly=function t(){return true};n.getControlState=function t(e){const i=this._currentViewState;let r={};if(i){const t=this.getStateKey(e);r=i[t]}return r};n.applyViewState=async function e(i,r,n){if(this.base.viewState.applyInitialStateOnly()&&this._getInitialStateApplied()){return}try{if(this._isStateEmptyForIAppStateNavType(i,r.navigationType)&&!this.__isRootViewController()){return}await this.collectResults(this.base.viewState.onBeforeStateApplied,[],r.navigationType);const t=await this.collectResults(this.base.viewState.adaptStateControls);this.viewStateControls=t;let e=Promise.resolve();let a=false;this._currentViewState=i;this.configOfStateApply=this.configOfStateApply??{};this.configOfStateApply.skipMerge=n;this.configOfStateApply.navTypeParameters=r;this.configOfStateApply.state=i;const o=t.reduce((t,e)=>{if(!e){return t}const i=e.isA("sap.ui.fl.variants.VariantManagement");if(!a){a=i}t=i?[e,...t]:[...t,e];return t},[]);if(!a){this._setInitialStatesForDeltaCompute()}o.filter(function(t){return t.isA("sap.ui.base.ManagedObject")}).forEach(t=>{const a=this.getStateKey(t);e=e.then(this.applyControlState.bind(this,t,i?i[a]:undefined,r,n??false))});await e;if(r.navigationType===dt.iAppState||r.navigationType===dt.hybrid){await this.collectResults(this.base.viewState.applyAdditionalStates,i?i[ut]:undefined)}else{await this.collectResults(this.base.viewState.applyNavigationParameters,r);await this.collectResults(this.base.viewState._applyNavigationParametersToFilterbar,r)}}finally{try{if(!this._isStateEmptyForIAppStateNavType(i,r.navigationType)){await this.collectResults(this.base.viewState.onAfterStateApplied)}this._setInitialStateApplied()}catch(e){t.error(e)}}};n._checkIfVariantIdIsAvailable=function t(e,i){const r=e.getVariants();let n=false;r.forEach(function(t){if(t.getKey()===i){n=true}});return n};n._setInitialStateApplied=function t(){if(this._pInitialStateAppliedResolve){const t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};n._getInitialStateApplied=function t(){return!this._pInitialStateAppliedResolve};n._isStateEmptyForIAppStateNavType=function t(e,i){return(!e||Object.keys(e).length===0)&&i==dt.iAppState};n.__isRootViewController=function t(){const e=this.base.getView().getController();return e.isA("sap.fe.core.rootView.NavContainer")||e.isA("sap.fe.core.rootView.Fcl")};n.onBeforeStateApplied=function t(e,i){};n.onAfterStateApplied=function t(e){};n.applyAdditionalStates=function t(e,i){};n._applyNavigationParametersToFilterbar=function t(e,i){};n.applyNavigationParameters=function t(e,i){};n.applyControlState=async function t(e,i,r,n){const a=this.getControlStateHandler(e);let o=Promise.resolve();a.forEach(t=>{if(typeof t.apply!=="function"){throw new Error(`controlStateHandler.apply is not a function for control: ${e.getMetadata().getName()}`)}o=o.then(t.apply.bind(this,e,i,r,n))});return o};n.updateAppStateDebounced=function t(){if(this.updateAppStateTimer){clearTimeout(this.updateAppStateTimer)}this.updateAppStateTimer=setTimeout(()=>{this.base.getExtensionAPI().updateAppState()},200)};n.registerStateContributor=function t(e){if(this.stateContributors.includes(e)){return}this.stateContributors.push(e);if(this._currentViewState){const t=this.getStateKey(e);const i=this._currentViewState[t];const r=this.configOfStateApply?.navTypeParameters?.navigationType;const n=this.configOfStateApply?.skipMerge;if(i&&i===this.configOfStateApply?.state?.[t]){const t=!this.invalidateInitialStateForApply.includes(e.getId())&&!this.controlsVariantIdUnavailable.includes(e.getId())&&r!==dt.hybrid&&n!==true;e.applyState(i,undefined,t)}else{this.updateAppStateDebounced()}}};n.deregisterStateContributor=function t(e){const i=this.stateContributors.findIndex(t=>t==e);if(i!==-1){this.stateContributors.splice(i,1)}};n.getInterface=function t(){return this};n._getControlState=function t(e,i){const r=this.initialControlStatesMapper;if(Object.keys(r).length>0&&r[e]){if(Object.keys(r[e]).length===0){r[e]={...i}}return{fullState:i,initialState:r[e]}}return i};n._addEventListenersToVariantManagement=function t(e,i){const r={variantManagedControls:i};const n=()=>{this._updateInitialStatesOnVariantChange(i)};e.attachSave(r,n,{});e.attachSelect(r,n,{})};n._updateInitialStatesOnVariantChange=function t(e){const i=this.initialControlStatesMapper;Object.keys(i).forEach(t=>{for(const r of e){if(r.includes(t)){i[t]={}}}});this.updateInitialState(e)};n.updateInitialState=async function t(e){const i=this.stateContributors;await Promise.all(i.map(async t=>{const i=t?.getId();if(e.includes(i)&&t?.isA("sap.fe.core.controllerextensions.viewState.IViewStateContributor")&&t.setInitialState){await t.setInitialState()}}))};n._isInitialStatesApplicable=function t(e,i,r,n){return!!e&&!this.invalidateInitialStateForApply.includes(i.getId())&&!this.controlsVariantIdUnavailable.includes(i.getId())&&(n??true)&&r!==true};return r}(n),ct(et.prototype,"refreshViewBindings",[s,p],Object.getOwnPropertyDescriptor(et.prototype,"refreshViewBindings"),et.prototype),ct(et.prototype,"adaptBindingRefreshControls",[l,c],Object.getOwnPropertyDescriptor(et.prototype,"adaptBindingRefreshControls"),et.prototype),ct(et.prototype,"refreshControlBinding",[d,u],Object.getOwnPropertyDescriptor(et.prototype,"refreshControlBinding"),et.prototype),ct(et.prototype,"getControlRefreshBindingHandler",[y,f],Object.getOwnPropertyDescriptor(et.prototype,"getControlRefreshBindingHandler"),et.prototype),ct(et.prototype,"adaptBindingRefreshHandler",[g,S],Object.getOwnPropertyDescriptor(et.prototype,"adaptBindingRefreshHandler"),et.prototype),ct(et.prototype,"onSuspend",[h,v],Object.getOwnPropertyDescriptor(et.prototype,"onSuspend"),et.prototype),ct(et.prototype,"onRestore",[b,w],Object.getOwnPropertyDescriptor(et.prototype,"onRestore"),et.prototype),ct(et.prototype,"collectResults",[A,C],Object.getOwnPropertyDescriptor(et.prototype,"collectResults"),et.prototype),ct(et.prototype,"adaptControlStateHandler",[I,O],Object.getOwnPropertyDescriptor(et.prototype,"adaptControlStateHandler"),et.prototype),ct(et.prototype,"getControlStateHandler",[m,_],Object.getOwnPropertyDescriptor(et.prototype,"getControlStateHandler"),et.prototype),ct(et.prototype,"adaptStateControls",[P,V],Object.getOwnPropertyDescriptor(et.prototype,"adaptStateControls"),et.prototype),ct(et.prototype,"getStateKey",[R,j],Object.getOwnPropertyDescriptor(et.prototype,"getStateKey"),et.prototype),ct(et.prototype,"retrieveViewState",[B,D],Object.getOwnPropertyDescriptor(et.prototype,"retrieveViewState"),et.prototype),ct(et.prototype,"retrieveAdditionalStates",[K,T],Object.getOwnPropertyDescriptor(et.prototype,"retrieveAdditionalStates"),et.prototype),ct(et.prototype,"retrieveControlState",[E,M],Object.getOwnPropertyDescriptor(et.prototype,"retrieveControlState"),et.prototype),ct(et.prototype,"applyInitialStateOnly",[F,H],Object.getOwnPropertyDescriptor(et.prototype,"applyInitialStateOnly"),et.prototype),ct(et.prototype,"applyViewState",[N,k],Object.getOwnPropertyDescriptor(et.prototype,"applyViewState"),et.prototype),ct(et.prototype,"_checkIfVariantIdIsAvailable",[x],Object.getOwnPropertyDescriptor(et.prototype,"_checkIfVariantIdIsAvailable"),et.prototype),ct(et.prototype,"onBeforeStateApplied",[L,U],Object.getOwnPropertyDescriptor(et.prototype,"onBeforeStateApplied"),et.prototype),ct(et.prototype,"onAfterStateApplied",[z,$],Object.getOwnPropertyDescriptor(et.prototype,"onAfterStateApplied"),et.prototype),ct(et.prototype,"applyAdditionalStates",[q,G],Object.getOwnPropertyDescriptor(et.prototype,"applyAdditionalStates"),et.prototype),ct(et.prototype,"_applyNavigationParametersToFilterbar",[Q],Object.getOwnPropertyDescriptor(et.prototype,"_applyNavigationParametersToFilterbar"),et.prototype),ct(et.prototype,"applyNavigationParameters",[W,J],Object.getOwnPropertyDescriptor(et.prototype,"applyNavigationParameters"),et.prototype),ct(et.prototype,"applyControlState",[X,Y],Object.getOwnPropertyDescriptor(et.prototype,"applyControlState"),et.prototype),ct(et.prototype,"updateAppStateDebounced",[Z],Object.getOwnPropertyDescriptor(et.prototype,"updateAppStateDebounced"),et.prototype),et))||tt);return gt},false);
//# sourceMappingURL=ViewState.js.map