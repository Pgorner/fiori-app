{"version":3,"file":"CollaborativeDraft.js","names":["CollaborationDraft","_dec","defineUI5Class","_class","_BaseControllerExtens","apply","this","arguments","_exports","_inheritsLoose","_proto","prototype","getCollaborativeDraftService","collaborativeDraftService","base","getAppComponent","handleContentFocusIn","focusEvent","fieldpAPI","getSource","isA","getParent","targetOutsideOfControlDomRef","getParameter","getDomRef","contains","lastFocusId","getLastFocusId","getId","getLastFocusFieldGroups","getFieldGroupIds","join","lastFocused","Element","getElementById","sendFocusOutMessage","setLastFocusInformation","sendFocusInMessage","handleContentFocusOut","fieldGroupEvent","control","fieldGroupIds","some","groupId","startsWith","CollaborationFieldGroupPrefix","sourceControl","currentFocusedControl","getActiveElement","undefined","lastFocusFieldGroups","focusedFieldAPI","collaborationPath","getCollaborationPath","send","action","Activity","Lock","content","Unlock","field","bindingContext","getBindingContext","getMainPropertyRelativePath","fieldWrapper","FieldEditMode","Editable","EditableDisplay","EditableReadOnly","includes","getProperty","getPath","keypath","getBindingInfo","template","getBindingPath","path","message","getView","isConnected","connect","async","disconnect","isCollaborationEnabled","retainAsyncMessages","activityPaths","releaseAsyncMessages","updateLocksForContextPath","oldContextPath","newContextPath","BaseControllerExtension"],"sources":["./CollaborativeDraft.ts"],"sourcesContent":["import { defineUI5Class } from \"sap/fe/base/ClassSupport\";\nimport type FieldWrapper from \"sap/fe/macros/controls/FieldWrapper\";\nimport type FieldAPI from \"sap/fe/macros/field/FieldAPI\";\nimport type Tokenizer from \"sap/m/Tokenizer\";\nimport type UI5Event from \"sap/ui/base/Event\";\nimport type ManagedObject from \"sap/ui/base/ManagedObject\";\nimport type Control from \"sap/ui/core/Control\";\nimport type { Control$ValidateFieldGroupEvent } from \"sap/ui/core/Control\";\nimport Element from \"sap/ui/core/Element\";\nimport type MultiValueField from \"sap/ui/mdc/MultiValueField\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport type { FEView } from \"../BaseController\";\nimport type PageController from \"../PageController\";\nimport type { CollaborativeDraftService } from \"../services/collaborativeDraftServiceFactory\";\nimport { FieldEditMode } from \"../templating/UIFormatters\";\nimport BaseControllerExtension from \"./BaseControllerExtension\";\nimport { Activity, CollaborationFieldGroupPrefix } from \"./collaboration/CollaborationCommon\";\n\n@defineUI5Class(\"sap.fe.core.controllerextensions.CollaborationDraft\")\nexport default class CollaborationDraft extends BaseControllerExtension {\n\tprivate base!: PageController;\n\n\tprivate lastFocusId: string | undefined;\n\n\tprivate lastFocusFieldGroups: string | undefined;\n\n\tprivate collaborativeDraftService!: CollaborativeDraftService;\n\n\tprivate getCollaborativeDraftService(): CollaborativeDraftService {\n\t\tthis.collaborativeDraftService = this.collaborativeDraftService ?? this.base.getAppComponent().getCollaborativeDraftService();\n\t\treturn this.collaborativeDraftService;\n\t}\n\n\t/**\n\t * Callback when the focus is set in the FieldAPI or one of its children.\n\t * @param focusEvent\n\t */\n\tpublic handleContentFocusIn(focusEvent: UI5Event<{ relatedTarget: Node }>): void {\n\t\tlet fieldpAPI: FieldAPI | MultiValueField = focusEvent.getSource();\n\t\t// We send the event only if the focus was previously out of the FieldAPI\n\t\tif (fieldpAPI.isA<Tokenizer>(\"sap.m.Tokenizer\")) {\n\t\t\tfieldpAPI = fieldpAPI.getParent()?.getParent() as MultiValueField;\n\t\t}\n\t\tlet targetOutsideOfControlDomRef = false;\n\t\tif (focusEvent.getParameter) {\n\t\t\ttargetOutsideOfControlDomRef = !fieldpAPI.getDomRef()?.contains(focusEvent.getParameter(\"relatedTarget\"));\n\t\t}\n\t\tif (fieldpAPI.isA<MultiValueField>(\"sap.ui.mdc.MultiValueField\") || targetOutsideOfControlDomRef) {\n\t\t\t// We need to handle the case where the newly focused FieldAPI is different from the previous one, but they share the same fieldGroupIDs\n\t\t\t// (e.g. fields in different rows in the same column of a table)\n\t\t\t// In such case, the focusOut handler was not called (because we stay in the same fieldGroupID), so we need to send a focusOut event manually\n\t\t\tconst lastFocusId = this.getLastFocusId();\n\t\t\tif (\n\t\t\t\tlastFocusId &&\n\t\t\t\tlastFocusId !== fieldpAPI.getId() &&\n\t\t\t\tthis.getLastFocusFieldGroups() === fieldpAPI.getFieldGroupIds().join(\",\")\n\t\t\t) {\n\t\t\t\tconst lastFocused = Element.getElementById(lastFocusId) as FieldAPI;\n\t\t\t\tthis?.sendFocusOutMessage(lastFocused);\n\t\t\t}\n\n\t\t\tthis.setLastFocusInformation(fieldpAPI);\n\n\t\t\tthis.sendFocusInMessage(fieldpAPI);\n\t\t}\n\t}\n\n\t/**\n\t * Callback when the focus is removed from the FieldAPI or one of its children.\n\t * @param fieldGroupEvent\n\t */\n\tpublic handleContentFocusOut(fieldGroupEvent: Control$ValidateFieldGroupEvent): void {\n\t\tlet control: ManagedObject | null = fieldGroupEvent.getSource();\n\t\tif (control.isA<Tokenizer>(\"sap.m.Tokenizer\")) {\n\t\t\tcontrol = control.getParent()?.getParent() as MultiValueField;\n\t\t}\n\t\tif (!control.isA<MultiValueField>(\"sap.ui.mdc.MultiValueField\")) {\n\t\t\twhile (control && !control?.isA<FieldAPI>(\"sap.fe.macros.field.FieldAPI\")) {\n\t\t\t\tcontrol = control?.getParent();\n\t\t\t}\n\t\t\tif (!control) return;\n\t\t}\n\n\t\tconst fieldGroupIds = fieldGroupEvent.getParameter(\"fieldGroupIds\") as string[];\n\n\t\t// We send the event only if the validated fieldCroup corresponds to a collaboration group\n\t\tif (\n\t\t\tfieldGroupIds.some((groupId) => {\n\t\t\t\treturn groupId.startsWith(CollaborationFieldGroupPrefix);\n\t\t\t})\n\t\t) {\n\t\t\tconst sourceControl: Control = fieldGroupEvent.getSource();\n\n\t\t\t// Determine if the control that sent the event still has the focus (or one of its children).\n\t\t\t// This could happen e.g. if the user pressed <Enter> to validate the input.\n\t\t\tlet currentFocusedControl: ManagedObject | null | undefined = Element.getActiveElement();\n\t\t\twhile (currentFocusedControl && currentFocusedControl !== sourceControl) {\n\t\t\t\tcurrentFocusedControl = currentFocusedControl.getParent();\n\t\t\t}\n\t\t\tif (currentFocusedControl !== sourceControl) {\n\t\t\t\t// The control that sent the event isn't focused anymore\n\t\t\t\tthis.sendFocusOutMessage(control);\n\t\t\t\tif (this.getLastFocusId() === control.getId()) {\n\t\t\t\t\tthis.setLastFocusInformation(undefined);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Gets the id of the last focused FieldAPI (if any).\n\t * @returns ID\n\t */\n\tprivate getLastFocusId(): string | undefined {\n\t\treturn this.lastFocusId;\n\t}\n\n\t/**\n\t * Gets the fieldgroups of the last focused FieldAPI (if any).\n\t * @returns A string containing the fieldgroups separated by ','\n\t */\n\tprivate getLastFocusFieldGroups(): string | undefined {\n\t\treturn this.lastFocusFieldGroups;\n\t}\n\n\t/**\n\t * Stores information about the last focused FieldAPI (id and fieldgroups).\n\t * @param focusedFieldAPI\n\t */\n\tprivate setLastFocusInformation(focusedFieldAPI: FieldAPI | MultiValueField | undefined): void {\n\t\tthis.lastFocusId = focusedFieldAPI?.getId();\n\t\tthis.lastFocusFieldGroups = focusedFieldAPI?.getFieldGroupIds().join(\",\");\n\t}\n\n\t/**\n\t * If collaboration is enabled, send a Lock collaboration message.\n\t * @param fieldpAPI\n\t */\n\tprivate sendFocusInMessage(fieldpAPI: FieldAPI | MultiValueField): void {\n\t\tconst collaborationPath = this.getCollaborationPath(fieldpAPI);\n\n\t\tif (collaborationPath) {\n\t\t\tthis.send({ action: Activity.Lock, content: collaborationPath });\n\t\t}\n\t}\n\n\t/**\n\t * If collaboration is enabled, send an Unlock collaboration message.\n\t * @param fieldpAPI\n\t */\n\tprivate sendFocusOutMessage(fieldpAPI: FieldAPI | MultiValueField | undefined): void {\n\t\tif (!fieldpAPI) {\n\t\t\treturn;\n\t\t}\n\t\tconst collaborationPath = this.getCollaborationPath(fieldpAPI);\n\t\tif (collaborationPath) {\n\t\t\tthis.send({ action: Activity.Unlock, content: collaborationPath });\n\t\t}\n\t}\n\n\t/**\n\t * Gets the path used to send collaboration messages.\n\t * @param field\n\t * @returns The path (or undefined is no valid path could be found)\n\t */\n\tprivate getCollaborationPath(field: FieldAPI | MultiValueField): string | undefined {\n\t\t// Note: we send messages even if the context is inactive (empty creation rows),\n\t\t// otherwise we can't update the corresponding locks when the context is activated.\n\t\tconst bindingContext = field?.getBindingContext() as Context | undefined;\n\t\tif (!bindingContext) {\n\t\t\treturn;\n\t\t}\n\t\tif (field.isA<FieldAPI>(\"sap.fe.macros.field.FieldAPI\")) {\n\t\t\tif (!field.getMainPropertyRelativePath()) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tconst fieldWrapper = field.content as FieldWrapper | undefined;\n\t\t\tif (\n\t\t\t\t![FieldEditMode.Editable, FieldEditMode.EditableDisplay, FieldEditMode.EditableReadOnly].includes(\n\t\t\t\t\tfieldWrapper?.getProperty(\"editMode\")\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\t// The field is not in edit mode --> no collaboration messages\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\treturn `${bindingContext.getPath()}/${field.getMainPropertyRelativePath()}`;\n\t\t} else if (field.isA<MultiValueField>(\"sap.ui.mdc.MultiValueField\")) {\n\t\t\tconst keypath = field.getBindingInfo(\"items\").template.getBindingPath(\"key\");\n\t\t\treturn `${bindingContext.getPath()}/${field.getBindingInfo(\"items\").path}/${keypath}`;\n\t\t}\n\t}\n\n\tpublic send(message: {\n\t\taction: Activity;\n\t\tcontent: string | string[] | undefined;\n\t\ttriggeredActionName?: string;\n\t\trefreshListBinding?: boolean;\n\t\tactionRequestedProperties?: string[];\n\t}): void {\n\t\tthis.getCollaborativeDraftService().send(this.getView(), message);\n\t}\n\n\tpublic isConnected(): boolean {\n\t\treturn this.getCollaborativeDraftService().isConnected(this.getView());\n\t}\n\n\tpublic async connect(): Promise<void> {\n\t\treturn this.getCollaborativeDraftService().connect(this.getView() as FEView);\n\t}\n\n\tpublic disconnect(): void {\n\t\treturn this.getCollaborativeDraftService().disconnect(this.getView() as FEView);\n\t}\n\n\tpublic isCollaborationEnabled(): boolean {\n\t\treturn this.getCollaborativeDraftService().isCollaborationEnabled(this.getView());\n\t}\n\n\tpublic retainAsyncMessages(activityPaths: string | string[]): void {\n\t\treturn this.getCollaborativeDraftService().retainAsyncMessages(this.getView(), activityPaths);\n\t}\n\n\tpublic releaseAsyncMessages(activityPaths: string | string[]): void {\n\t\treturn this.getCollaborativeDraftService().releaseAsyncMessages(this.getView(), activityPaths);\n\t}\n\n\tpublic updateLocksForContextPath(oldContextPath: string, newContextPath: string): void {\n\t\treturn this.getCollaborativeDraftService().updateLocksForContextPath(this.getView(), oldContextPath, newContextPath);\n\t}\n}\n"],"mappings":"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","ignoreList":[]}