/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BaseControllerExtension","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/Feedback","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/TransactionHelper","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/editFlowConstants","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageToast","sap/m/Text","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/mvc/OverrideExecution","sap/ui/model/Filter","sap/ui/model/Sorter","../ActionRuntime","../controls/Recommendations/ConfirmRecommendationDialog","../converters/ManifestSettings","../helpers/TypeGuards","./routing/NavigationReason"],function(e,t,n,i,o,s,a,r,c,l,g,d,f,u,h,p,y,m,C,w,M,D,b,P,v,E,S,A,x,I,k,T,R,_){"use strict";var O,F,B,H,V,N,j,L,G,$,q,K,U,W,z,J,Q,X,Y,Z,ee,te,ne,ie,oe,se,ae,re,ce,le,ge,de,fe,ue,he,pe,ye,me,Ce,we,Me,De,be,Pe,ve;var Ee=R.isFulfilled;var Se=T.CreationMode;var Ae=k.RecommendationDialogDecision;var xe=k.ConfirmRecommendationDialog;var Ie=h.getResourceModel;var ke=d.getInvolvedDataModelObjects;var Te=d.convertTypes;var Re=a.shareObject;var _e=a.Activity;var Oe=s.triggerConfiguredSurvey;var Fe=s.TriggerType;var Be=s.StandardActions;var He=t.publicExtension;var Ve=t.finalExtension;var Ne=t.extensible;var je=t.defineUI5Class;function Le(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Ge(e,t)}function Ge(e,t){return Ge=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ge(e,t)}function $e(e,t,n,i,o){var s={};return Object.keys(i).forEach(function(e){s[e]=i[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=n.slice().reverse().reduce(function(n,i){return i(e,t,n)||n},s),o&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(o):void 0,s.initializer=void 0),void 0===s.initializer?(Object.defineProperty(e,t,s),null):s}const qe=y.ProgrammingModel,Ke=y.Constants,Ue=y.DraftStatus,We=y.EditMode,ze=y.StartupMode;let Je=(O=je("sap.fe.core.controllerextensions.EditFlow"),F=He(),B=Ve(),H=He(),V=Ve(),N=He(),j=Ve(),L=He(),G=Ne(S.After),$=He(),q=Ne("AfterAsync"),K=He(),U=Ne("AfterAsync"),W=He(),z=Ne(S.After),J=He(),Q=Ne(S.After),X=He(),Y=Ne(S.After),Z=He(),ee=Ne(S.After),te=He(),ne=Ne(S.After),ie=He(),oe=Ne(S.After),se=He(),ae=Ne(S.After),re=He(),ce=Ve(),le=He(),ge=Ve(),de=He(),fe=Ve(),ue=He(),he=Ve(),pe=He(),ye=Ve(),me=He(),Ce=Ne(S.After),we=He(),Me=Ne(S.Instead),De=He(),be=Ve(),O(Pe=(ve=function(t){function i(){var i;for(var o=arguments.length,s=new Array(o),a=0;a<o;a++){s[a]=arguments[a]}i=t.call(this,...s)||this;i.syncTasks=Promise.resolve();i.handleSideEffects=async(t,o)=>{try{const e=i.getView().getBindingContext();const s=await o;await s.created();if(!n.hasTransientContext(t)&&e){i.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(t.getPath(),e)}}catch(t){e.error("Error while creating the document",t)}};i.createCustomValidationMessages=(e,t)=>{const n=t.getCreationRow().data("customValidationFunction");const o=t.getBindingContext("internal")?.getProperty("creationRowCustomValidity");const s=[];let a;let r;const c=P.getMessageModel().getData().filter(e=>e.getCode()===n);P.removeMessages(c);e.forEach(e=>{if(e.messageTarget){a=D.getElementById(o[e.messageTarget].fieldId);r=`${a.getBindingContext()?.getPath()}/${a.getBindingPath("value")}`;if(!P.getMessageModel().getData().filter(e=>e.getTargets().some(e=>e===r)).length){P.addMessages(new v({message:e.messageText,processor:i.getView().getModel(),type:E.Error,code:n,technical:false,persistent:false,target:r}))}const t=P.getMessageModel().getData().filter(e=>e.getTargets().some(e=>e===r));t[0].addControlId(o[e.messageTarget].fieldId)}else{s.push({code:n,text:e.messageText,persistent:true,type:E.Error})}});if(s.length){i.getMessageHandler().showMessageDialog({customMessages:s})}};i.resolveCreationMode=(e,t,n)=>{if(e!==Se.NewPage){return e}else{const e=t.getModel().getMetaModel();const o=i.getProgrammingModel(t);if(!t.isRelative()){const n=ke(e.getMetaContext(t.getPath()));const i=n.targetEntitySet,s=(o===qe.Draft?i?.annotations.Common?.DraftRoot:i?.annotations.Session?.StickySessionSupported)?.NewAction?.toString();if(s&&n.targetEntityType.actions[s].parameters.length>1){return Se.Deferred}}const s=i.getTransactionHelper().getCreationParameters(t,n,i.getAppComponent());if(s.length){return Se.Deferred}return Se.Async}};return i}Le(i,t);var s=i.prototype;s.getInterface=function e(){return t.prototype.getInterface.call(this)};s.getAppComponent=function e(){return this.base.getAppComponent()};s.editDocument=async function t(i){const o=this.getTransactionHelper();const s=this._getRootViewController();const a=i.getModel();const r=this.getView().getViewData();const c=this.getProgrammingModel(i);let l=i;const g=this.base.getView();const d="editGroup";const f=this.getMessageHandler().registerToHoldMessages();try{if(r?.viewLevel>1){if(c===qe.Draft||c===qe.Sticky){l=await n.createRootContext(c,g,this.getAppComponent())}}await this.base.editFlow.onBeforeEdit({context:l});let e=this._isFclEnabled()?s.getRightmostContext():i;if(e===undefined||c===qe.Draft&&this.getProgrammingModel(e)!==qe.Draft){e=i}const t=o.editDocument(l,this.base.getView(),this.getAppComponent(),this.getMessageHandler(),d);const h={rootSiblingPathPromise:t};this._setStickySessionInternalProperties(c,a);let p;const y=e!==l||r?.viewLevel>1;if(y){p=this._computeSiblingInformation(l,e,c,true,h,d)}i.getModel().submitBatch(d);let m=await p;const C=await t;let w=C;if(y&&w){if(m===undefined){m=await this._computeSiblingInformation(l,e,c,true,h,"$auto")}w=this._getNavigationTargetForEdit(i,C,m)}else{this._updatePathsInHistory([])}let M=false;if(C){await this.base.editFlow.onAfterEdit({context:w});await this._handleNewContext(w,{editable:true,recreateContext:false,forceFocus:true});if(c===qe.Sticky){let e;if(this._isFclEnabled()){e=C?.getModel().getKeepAliveContext(C.getPath())}else{e=C}await this.handleStickyOn(e)}else if(u.isCollaborationDraftSupported(a.getMetaModel())){Re(C)}M=true;this.setEditMode(We.Editable,false);this.setDocumentModified(false)}this.getMessageHandler().showMessageDialog({unHoldKey:f,overrideUIDecision:M});return w}catch(t){this.getMessageHandler().showMessageDialog({unHoldKey:f});e.error("Error while editing the document",t);return Promise.reject(t)}};s.requestSideEffectsOnDelete=function e(t,i){if(!t||!i||n.hasTransientContext(t)){return}const o=this.getAppComponent().getSideEffectsService();o.requestSideEffectsForNavigationProperty(t.getPath(),i);const s=u.getMessagesPath(t.getModel().getMetaModel(),i.getPath());if(s&&this.getTransactionHelper().isListBindingHierarchical(t)){o.requestSideEffects([s],i)}};s.deleteMultipleDocuments=async function t(n,i){i.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete;i.requestSideEffects=i.requestSideEffects!==false;const s=this.getGlobalUIModel();const a=this.getView().byId(i.controlId)??D.getElementById(i.controlId);let r=[];if(a?.isA("sap.ui.mdc.Table")){r=n.filter(e=>e.isInactive())}if(!a){throw new Error("parameter controlId missing or incorrect")}else{i.parentControl=a}const c=a.getBinding("items")||a.getRowBinding();i.bFindActiveContexts=true;o.lock(s);try{if(this.getProgrammingModel(i?.selectedContexts?.[0]??n[0])===qe.Sticky){this.setDocumentModified(true)}await this.deleteDocumentTransaction(n,i);let e;if(a.isA("sap.ui.mdc.Table")){a.clearSelection()}const t=this.getView().getBindingContext();if(c.isRoot()){e=this.getTransactionHelper().refreshListBinding(c,this.getAppComponent())}else if(i.requestSideEffects){this.requestSideEffectsOnDelete(c,t)}if(!this.getAppComponent()._isFclEnabled()){f.setEditStateDirty()}const o=this.base.recommendations.isRecommendationEnabled();if(o){this.base.recommendations.ignoreRecommendationForContexts(n)}await this.base.editFlow.onAfterDelete({contexts:n});if(a.isA("sap.ui.mdc.Table")){const e=a.getParent();if(e?.tableDefinition?.control?.creationMode===Se.InlineCreationRows&&r.length>0){e.removeEmptyRowsMessages(r);await e.setUpEmptyRows(a,false)}}this._sendActivity(_e.Delete,n);return await e}catch(t){if(c.isRoot()){await this.getTransactionHelper().refreshListBinding(c,this.getAppComponent())}else if(i.requestSideEffects){const e=this.getView().getBindingContext();this.requestSideEffectsOnDelete(c,e)}e.error("Error while deleting the document(s)",t)}finally{o.unlock(s)}};s.updateDocument=async function t(n,i){const o=this.getView().getBindingContext();const s=this.getProgrammingModel(n)===qe.Draft;this.getMessageHandler().removeTransitionMessages();const a=this.getMessageHandler().registerToHoldMessages();return this.syncTask(async()=>{if(o){this.setDocumentModified(true);if(!this._isFclEnabled()){f.setEditStateDirty()}if(s){this.setDraftStatus(Ue.Saving)}}try{await i;const e=this.getView().getBindingContext();if(!s||!e||e!==o){return}const t=e.getModel().getMetaModel();const n=t.getMetaContext(e.getPath()).getObject("@sapui.name");const a=p.getSemanticKeys(t,n);if(a?.length&&e.getProperty("IsActiveEntity")===false&&e.getProperty("HasActiveEntity")===true){const t=this._getSemanticMapping();const n=t?.semanticPath,i=p.getSemanticPath(e,true);if(n&&n!==i){await this._handleNewContext(e,{editable:true,recreateContext:false})}}this.setDraftStatus(Ue.Saved)}catch(t){e.error("Error while updating the document",t);if(s&&o){this.setDraftStatus(Ue.Clear)}}finally{await this.getMessageHandler().showMessages({unHoldKey:a})}})};s.getParentContextFromSelection=function e(t){if(t&&t.length>1){throw new Error(`Cannot create a new document in a TreeTable with ${t.length} parents`)}return t?.length===1?t[0]:undefined};s.createDocument=async function e(t,n){let i;let o;const s=function(e,t){const n=e.getView().getModel();if(!n){return undefined}return n.bindList(t)};if(typeof t==="object"&&t.isA&&t.isA("sap.fe.core.IRowBindingInterface")){i=t.getRowBinding();t=i}if(n.creationMode!==Se.External){if(typeof t==="string"){const e=s(this,t);if(!e){return}else{i=e}delete n.createAtEnd}else if(typeof t==="object"&&t.isA&&t.isA("sap.ui.model.odata.v4.ODataListBinding")){i=t}else{throw new Error("Binding object or path expected")}if(this.getTransactionHelper().isListBindingHierarchical(i)){o=this.getParentContextFromSelection(n.selectedContexts)}}const a=this.resolveCreationMode(n.creationMode,i,n.data);this.getAppComponent().getRouterProxy().removeIAppStateKey();if((n.singleDraftForCreate!==undefined?n.singleDraftForCreate:this.getAppComponent().getManifest()["sap.fe"]?.app?.singleDraftForCreate)&&i===i.getRootBinding()&&i.getHeaderContext()!==null){const e=i.getModel()?.bindList(i.getPath(),i.getContext(),new x("DraftAdministrativeData/LastChangeDateTime",true),new A({filters:[new A({path:"IsActiveEntity",operator:"EQ",value1:false}),new A({path:"HasActiveEntity",operator:"EQ",value1:false})],and:true}));const s=await(e?.requestContexts(0,1));if(s.length>0){return this._handleNewContext(s[0],{editable:true,recreateContext:false}).then(()=>e?.destroy())}e?.destroy();return this._handleCreationMode(a,t,n,i,o)}return this._handleCreationMode(a,t,n,i,o)};s._handleCreationMode=async function e(t,n,i,o,s){this._updatePathsInHistory([]);switch(t){case Se.External:return this.createExternalDocument(n,i.outbound);case Se.Deferred:return this.createDeferredDocument(o,s,i.data);case Se.CreationRow:return i.creationRow?this.createCreateRowDocument({creationRow:i.creationRow,skipSideEffects:i.skipSideEffects,createAtEnd:i.createAtEnd}):undefined;case Se.Inline:return this.createDialogInlineDocument({creationMode:Se.Inline,tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data},o);case Se.CreationDialog:if(o.isRelative()){return this.createDialogInlineDocument({creationMode:Se.CreationDialog,tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data,creationDialogFields:i.creationDialogFields},o)}else{return this.createDialogAndSaveDocument({tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data,creationDialogFields:i.creationDialogFields},o)}case Se.Sync:case Se.Async:return this.createSyncAsyncDocument({creationMode:t,data:i.data,bFromDeferred:i.bFromDeferred,skipSideEffects:i.skipSideEffects,createAction:i.createAction,parentContext:s},o);default:throw new Error(`Unhandled creationMode ${t}`)}};s.postDocumentCreation=async function e(t,n){const i=this.getProgrammingModel(n);const o=n.getModel();const s=await t;const a=s[0];this._setStickySessionInternalProperties(i,o);await this.base.editFlow.onAfterCreate({context:a});this.setEditMode(We.Editable);if(!n.isRelative()){if(i===qe.Sticky){const e=o.getMetaModel().getMetaContext(n.getPath());const t=ke(e).startingEntitySet;const i=t?.annotations.Session?.StickySessionSupported?.NewAction;this.getInternalModel().setProperty("/lastInvokedAction",i)}else if(this.getTransactionHelper().isListBindingHierarchical(n)||this.getTransactionHelper().isListBindingAnalytical(n)){this.forceDraftSaveOrDiscard(true)}}if(a){this.setDocumentModifiedOnCreate(n);if(!this._isFclEnabled()){f.setEditStateDirty()}this._sendActivity(_e.Create,a);if(u.isCollaborationDraftSupported(o.getMetaModel())&&this.isDraftRoot(a)&&!this.base.collaborativeDraft.isConnected()){this.getInternalModel().setProperty("/executeShareActionForCollaboration",true)}}};s.createCreateRowDocument=async function t(n){let i;const s=this.getAppComponent();const a=n.creationRow;const r=n.creationRow.getParent();let c=Promise.resolve();if(!r){return}const l=r.getModel()?.getMetaModel();const g=r.getRowBinding();if(this.getTransactionHelper().isListBindingHierarchical(g)){throw new Error(`Unhandled creationMode "CreationRow" with a TreeTable`)}const d=a.getBindingContext();const f=this.getCreationRowValidationFunction(r);if(a.data("disableAddRowButtonForEmptyData")==="true"){r.getBindingContext("internal")?.setProperty("creationRowFieldValidity",{})}const u=await this.syncTask(f);if(u.length>0){this.createCustomValidationMessages(u,r);e.error("Custom Validation failed");return}const h=ke(l.getMetaContext(d.getPath())).targetEntityType;const p=d.getObject();await this._checkForValidationErrors();g.attachEventOnce("change",async()=>{await i;r.scrollToIndex(n.createAtEnd?r.getRowBinding().getLength():0)});this.handleCreateEvents(g);try{i=this.getTransactionHelper().createDocument(g,{data:Object.assign({},...Object.keys(p).filter(e=>h.navigationProperties.findIndex(t=>t.name===e)===-1).map(e=>({[e]:p[e]}))),keepTransientContextOnFailed:false,busyMode:"Local",busyId:r?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:s.getStartupMode()===ze.AutoCreate,createAtEnd:n.createAtEnd,creationMode:Se.CreationRow},s,this._getResourceModel(),this.getMessageHandler(),false);if(!n.skipSideEffects){this.handleSideEffects(g,i)}await i;const t=d.getBinding();const o=t.create();a.setBindingContext(o);o.created()?.catch(()=>{e.trace("transient fast creation context deleted")});c=d.delete("$direct");return await this.postDocumentCreation(Promise.all([i,c]),g)}catch(t){if(o.isLocked(this.base.getView().getModel("ui"))){o.unlock(this.base.getView().getModel("ui"))}e.error("CreationRow navigation error: ",t)}};s.createDialogInlineDocument=async function e(t,n){let i;if(t.tableId){i=this.getView().byId(t.tableId)}if(i?.isA("sap.ui.mdc.Table")){i.getRowBinding().attachEventOnce("createCompleted",async()=>{const e=await o;const t=e.getIndex();const s=n.getAggregation();const a=s?.createInPlace??false;if(t!==undefined&&t>=0){i?.focusRow(t,true)}else if(a){w.show(this._getResourceModel().getText("C_NEW_ELEMENT_NOT_DISPLAYED"))}if(this.getTransactionHelper().isListBindingHierarchical(n)&&!a){const t=e.getParent();const n=t?.getIndex();if(n!==undefined&&n>=0){i?.scrollToIndex(n)}}})}this.handleCreateEvents(n);const o=this.getTransactionHelper().createDocument(n,{keepTransientContextOnFailed:false,busyMode:"Local",busyId:i?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:this.getAppComponent().getStartupMode()===ze.AutoCreate,createAtEnd:t.createAtEnd,creationMode:t.creationMode,parentContext:t.parentContext,data:t.data,creationDialogFields:t.creationDialogFields},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false);if(!t.skipSideEffects){this.handleSideEffects(n,o)}return this.postDocumentCreation(Promise.all([o,this.syncTask(o)]),n)};s.createDialogAndSaveDocument=async function t(n,i){let o;if(n.tableId){o=this.getView().byId(n.tableId);if(o?.isA("sap.ui.mdc.Table")!==true){o=undefined}}let s;const a=async t=>{try{await this.base.editFlow.onAfterCreate({context:t})}catch(t){e.error("Error after creation: "+t)}await this.base.editFlow.onBeforeSave({context:t});s=await this.getTransactionHelper().saveDocument(t,this.getAppComponent(),this._getResourceModel(),false,[],this.getMessageHandler(),true,true);try{await this.base.editFlow.onAfterSave({context:s})}catch(t){e.error("Error after save: "+t)}if(this.getTransactionHelper().isListBindingHierarchical(i)){const e=o?.getParent();if(e){const t=n.parentContext?.getIndex();e.refresh();if(t!==undefined&&t>=0){o?.scrollToIndex(t)}}}else{const e=s.getIndex();if(e!==undefined&&e>=0){o?.scrollToIndex(e)}}};const r=this.getTransactionHelper().createDocument(i,{keepTransientContextOnFailed:false,busyMode:"Local",busyId:o?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,afterCreateCallBack:a,skipParameterDialog:this.getAppComponent().getStartupMode()===ze.AutoCreate,createAtEnd:n.createAtEnd,creationMode:Se.CreationDialog,parentContext:n.parentContext,data:n.data,creationDialogFields:n.creationDialogFields},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false);await Promise.all([r,this.syncTask(r)]);if(s&&n.skipSideEffects!==true){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(i.getPath(),s)}};s.createDeferredDocument=async function e(t,n,i){const s=this.getGlobalUIModel();o.lock(s);await this.getInternalRouting().navigateForwardToContext(t,{createOnNavigateParameters:{mode:"Deferred",parentContext:n,listBinding:t,data:i},editable:true,forceFocus:true});o.unlock(s)};s.createSyncAsyncDocument=async function e(t,n){let i;const s=this.getGlobalUIModel();const a=this.getInternalRouting();o.lock(s);const r=this.getTransactionHelper().createDocument(n,{...t,...{parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:this.getAppComponent().getStartupMode()===ze.AutoCreate}},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false).then(e=>{if(this._isFclEnabled()&&e&&e.getBinding()!==n){n.refresh()}return e});if(t.bFromDeferred!==true&&!t.skipSideEffects){this.handleSideEffects(n,r)}if(t.creationMode===Se.Async){i=a.navigateForwardToContext(n,{createOnNavigateParameters:{mode:"Async",createContextPromise:r},editable:true,forceFocus:true})}else{i=r.then(async e=>{if(!e){const e=b.getResourceBundleFor("sap.fe.core");return a.navigateToMessagePage(e.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:e.getText("C_COMMON_SAPFE_ERROR"),description:e.getText("C_EDITFLOW_SAPFE_CREATION_FAILED_DESCRIPTION")})}else{const i={editable:true,forceFocus:true,transient:this.getProgrammingModel(n)==qe.Sticky||t.createAction?true:undefined};return t.bFromDeferred?a.navigateToContext(e,i):a.navigateForwardToContext(e,i)}})}try{await this.postDocumentCreation(Promise.all([r,i]),n)}catch(e){if([Ke.CancelActionDialog,Ke.ActionExecutionFailed,Ke.CreationFailed,Ke.OnBeforeCreateFailed].includes(e)){this.getInternalRouting().navigateBackFromTransientState()}throw e}finally{o.unlock(s)}};s.createExternalDocument=async function e(t,n){if(n){if(typeof t!=="string"&&this.getTransactionHelper().isListBindingHierarchical(t)){throw new Error(`Unhandled creationMode "External" with a TreeTable`)}await this.syncTask();const e=this.getView().getController();const i=u.getAbsoluteMetaPathForListBinding(this.base.getView(),t);e._intentBasedNavigation.onChevronPressNavigateOutBound(e,n,undefined,i)}};s.validateDocument=async function e(t,n){return this.getTransactionHelper().validateDocument(t,n,this.getView())};s.getCreationRowValidationFunction=function e(t){const n=t?.getCreationRow();if(n&&t){return async()=>{const e=n.getBindingContext().getObject();delete e["@$ui5.context.isTransient"];return this.validateDocument(t.getBindingContext(),{data:e,customValidationFunction:t.getCreationRow().data("customValidationFunction")})}}return async()=>Promise.resolve([])};s.createMultipleDocuments=async function t(i,s,a,r,c){let l=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;let g=arguments.length>6?arguments[6]:undefined;const d=this.getTransactionHelper();const f=this.getGlobalUIModel();const u=i;g=g!==false;if(!l){o.lock(f)}try{await this.syncTask();if(c){await c({contextPath:u.getPath()})}const e=u.getModel().getMetaModel();let t;if(u.getContext()){t=e.getMetaPath(`${u.getContext().getPath()}/${u.getPath()}`)}else{t=e.getMetaPath(u.getPath())}this.handleCreateEvents(u);const i=s.map(async n=>{const i={data:{},parentControl:this.getView()};i.keepTransientContextOnFailed=false;i.creationMode=Se.CreationRow;i.createAtEnd=a;i.inactive=l;for(const o in n){const s=e.getObject(`${t}/${o}`);if(s&&s.$kind!=="NavigationProperty"&&!o.includes("/")&&n[o]){i.data[o]=n[o]}}return d.createDocument(u,i,this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),r)});const o=await Promise.all(i);if(!l){this.setDocumentModifiedOnCreate(u)}const f=o.filter(e=>!e.isInactive());await Promise.all(f.map(async e=>e.created()));const h=this.getView().getBindingContext();if(g&&!n.hasTransientContext(u)){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(u.getPath(),h)}if(this.base.collaborativeDraft.isConnected()&&f.length>0){this._sendActivity(_e.Create,f)}return o}catch(t){e.error("Error while creating multiple documents.");throw t}finally{if(!l){o.unlock(f)}}};s.onBeforeCreate=async function e(t){return Promise.resolve()};s.onBeforeEdit=async function e(t){return Promise.resolve()};s.onBeforeSave=async function e(t){return Promise.resolve()};s.onBeforeDiscard=async function e(t){return Promise.resolve()};s.onBeforeDelete=async function e(t){return Promise.resolve()};s.onAfterSave=async function e(t){return Promise.resolve()};s.onAfterCreate=async function e(t){return Promise.resolve()};s.onAfterEdit=async function e(t){return Promise.resolve()};s.onAfterDiscard=async function e(t){return Promise.resolve()};s.onAfterDelete=async function e(t){return Promise.resolve()};s.saveDocument=async function t(n,i){i=i||{};const o=i.bExecuteSideEffectsOnError||undefined;const s=this.getTransactionHelper();const a=i.bindings;const r=this.getMessageHandler().registerToHoldMessages();try{await this.syncTask();this.getMessageHandler().removeTransitionMessages();if(i.mergePatchDraft!==true){await this._submitOpenChanges(n)}await this._checkForValidationErrors();const e=await this.checkRecommendationOption();await this.base.editFlow.onBeforeSave({context:n});const t=this.getProgrammingModel(n);const c=this._getRootViewController();let l;if((t===qe.Sticky||n.getProperty("HasActiveEntity"))&&c.isFclEnabled()){l=await this._computeSiblingInformation(n,c.getRightmostContext(),t,true)}await this.base._sideEffects.handlePageChangeContext(n);if(n.getModel().hasPendingChanges("$auto")&&i.mergePatchDraft){n.getModel().submitBatch("$auto")}const g=await s.saveDocument(n,this.getAppComponent(),this._getResourceModel(),o,a,this.getMessageHandler(),this.getCreationMode());this._removeStickySessionInternalProperties(t);this._sendActivity(_e.Activate,g);this.base.collaborativeDraft.disconnect();this._triggerConfiguredSurvey(Be.save,Fe.standardAction);this.setDocumentModified(false);this.setEditMode(We.Display,false);this.getMessageHandler().showMessageDialog({unHoldKey:r});await this.base.editFlow.onAfterSave({context:g});this.base.recommendations.storeDataForTelemetry(e);if(g!==n){let e=g;l=l??this._createSiblingInfo(n,g);if(t===qe.Draft){const e=p.getSemanticPath(n,true);const t=p.getSemanticPath(g,true);if(e&&t&&e!==t){l.pathMapping.push({oldPath:e,newPath:t})}}this._updatePathsInHistory(l.pathMapping);if(c.isFclEnabled()){if(l.targetContext.getPath()!==g.getPath()){e=l.targetContext}}await this._handleNewContext(e,{editable:false,recreateContext:false,forceFocus:true})}}catch(t){this.getMessageHandler().showMessageDialog({unHoldKey:r});if(!(t&&t.canceled)){e.error("Error while saving the document",t)}throw t}};s.toggleDraftActive=async function e(t){const n=t.getObject();let i;const o=t&&this.getProgrammingModel(t)===qe.Draft;if(!o||!(!n.IsActiveEntity&&n.HasActiveEntity||n.IsActiveEntity&&n.HasDraftEntity)){return}if(!n.IsActiveEntity&&n.HasActiveEntity){i=false}else{i=true}try{const e=this._getRootViewController();const n=e.isFclEnabled()?e.getRightmostContext():t;let o=await this._computeSiblingInformation(t,n,qe.Draft,false);if(!o&&t!==n){o=await this._computeSiblingInformation(t,t,qe.Draft,false)}if(o){this.setEditMode(i?We.Editable:We.Display,false);if(e.isFclEnabled()){const e=this._getSemanticMapping();if(e?.technicalPath===t.getPath()){const t=o.pathMapping[o.pathMapping.length-1].newPath;o.pathMapping.push({oldPath:e.semanticPath,newPath:t})}}this._updatePathsInHistory(o.pathMapping);await this._handleNewContext(o.targetContext,{editable:i,recreateContext:true,forceFocus:true})}else{throw new Error("Error in EditFlow.toggleDraftActive - Cannot find sibling")}}catch(e){throw new Error(`Error in EditFlow.toggleDraftActive:${e}`)}};s.cancelDocument=async function t(n,i){const o=this.getTransactionHelper();let s;let a=false;const r={skipDiscardPopover:i.skipDiscardPopover===true,cancelButton:i.control||i.cancelButton,beforeCancelCallBack:this.base.editFlow.onBeforeDiscard};try{await this.syncTask();const e=this.getProgrammingModel(n);if((e===qe.Sticky||n.getProperty("HasActiveEntity"))&&this._isFclEnabled()){const t=this._getRootViewController();s=await this._computeSiblingInformation(n,t.getRightmostContext(),e,true)}const t=await o.cancelDocument(n,r,this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),this.getCreationMode(),this.isDocumentModified());this._getRootViewController().getInstancedViews().forEach(e=>{const t=e.getBindingContext();if(t&&t.isKeepAlive()){t.setKeepAlive(false)}});this._removeStickySessionInternalProperties(e);this.setEditMode(We.Display,false);this.setDocumentModified(false);this.setDraftStatus(Ue.Clear);await this.base.editFlow.onAfterDiscard({context:typeof t==="boolean"||t===null?undefined:t});f.setEditStateDirty();if(!t){this._sendActivity(_e.Discard,n);this.base.collaborativeDraft.disconnect();if(!i.skipBackNavigation){await this.getInternalRouting().navigateBackFromContext(n);a=true}}else{const o=t;this._sendActivity(_e.Discard,o);this.base.collaborativeDraft.disconnect();let a=o;s=s??this._createSiblingInfo(n,o);this._updatePathsInHistory(s.pathMapping);if(this._isFclEnabled()){if(s.targetContext.getPath()!==o.getPath()){a=s.targetContext}}if(e===qe.Draft){await this._fetchSemanticKeyValues(o);if(!i.skipBindingToView){await this._handleNewContext(a,{editable:false,recreateContext:true,forceFocus:true})}else{return o}}else{await this._handleNewContext(a,{editable:false,recreateContext:true,forceFocus:true})}}if(e===qe.Draft){this.showDocumentDiscardMessage(a)}}catch(t){e.error("Error while discarding the document",t)}};s.showDocumentDiscardMessage=function e(t){const n=this._getResourceModel();const i=n.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");if(t==true){const e=this.getAppComponent();e.getRoutingService().attachAfterRouteMatched({},this.showMessageWhenNoContext,this)}else{w.show(i)}};s.showMessageWhenNoContext=function e(){const t=this._getResourceModel();const n=t.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");const i=this.getAppComponent();w.show(n);i.getRoutingService().detachAfterRouteMatched(this.showMessageWhenNoContext,this)};s.isDraftRoot=function e(t){const n=t.getModel().getMetaModel();const i=n.getMetaContext(t.getPath());return u.isDraftRoot(ke(i).targetEntitySet)};s.deleteDocument=async function t(n,i){const o=this.getAppComponent();const s={...i,bFindActiveContexts:false,beforeDeleteCallBack:this.base.editFlow.onBeforeDelete},a=this.getMessageHandler().registerToHoldMessages();try{if(this._isFclEnabled()&&this.isDraftRoot(n)&&n.getIndex()===undefined&&n.getProperty("IsActiveEntity")===true&&n.getProperty("HasDraftEntity")===true){s.beforeDeleteCallBack=async t=>{await this.base.editFlow.onBeforeDelete(t);try{const e=n.getModel();const t=e.bindContext(`${n.getPath()}/SiblingEntity`).getBoundContext();const i=await t.requestCanonicalPath();const o=e.getKeepAliveContext(i);o.replaceWith(n)}catch(t){e.error("Error while replacing the draft instance in the LR ODLB",t)}}}if(this.getProgrammingModel(n)===qe.Sticky){this.setDocumentModified(true)}await this.deleteDocumentTransaction(n,s);if(!this._isFclEnabled()){f.setEditStateDirty()}else{const e=n.getBinding();if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){if(e.isRoot()){await this.getTransactionHelper().refreshListBinding(e,o)}else if(s.requestSideEffects!==false){this.requestSideEffectsOnDelete(e,e.getContext())}}}this._sendActivity(_e.Delete,n);await(o?.getShellServices().setBackNavigation());const t=this.base.recommendations.isRecommendationEnabled();if(t){this.base.recommendations.ignoreRecommendationForContexts([n])}await this.base.editFlow.onAfterDelete({contexts:[n]});if(!this._isFclEnabled()){if(o?.getStartupMode()===ze.Deeplink){o.getRouterProxy().exitFromApp()}else{this.getInternalRouting().navigateBackFromContext(n)}}}catch(t){e.error("Error while deleting the document",t)}finally{this.getMessageHandler().showMessages({unHoldKey:a})}};s.applyDocument=async function e(t){const n=this.getGlobalUIModel();const i=this.getMessageHandler().registerToHoldMessages();try{await this.syncTask();if(t.getModel().hasPendingChanges("$auto")){o.lock(n);await this._submitOpenChanges(t)}const e=await this.showConfirmRecommendationsDialog(false);if(e===Ae.Continue){return}await this._checkForValidationErrors();await this.getMessageHandler().showMessageDialog({unHoldKey:i});await this.getInternalRouting().navigateBackFromContext(t)}finally{if(o.isLocked(n)){o.unlock(n)}}};s.invokeAction=async function t(n,i,o){const s=this.getTransactionHelper();let a;let r;let c;const l=this.base.getView();if(i?.isA&&i?.isA("sap.ui.model.odata.v4.Context")||Array.isArray(i)||o!==undefined){const e=i;i=o||{};if(e){i.contexts=e}else{i.model=this.base.getView().getModel()}}const g={...i,parentControl:this.base.getView()}||{parentControl:this.base.getView()};g.isNavigable=g.requiresNavigation||g.isNavigable;const d=Te(this.getView().getModel()?.getMetaModel());if(n.includes(""+d.entityContainer.name)){g.isBound=false}else{g.isBound=true}if(!g.entitySetName&&g.contexts&&g.model){g.entitySetName=g.model.getMetaModel().getMetaContext((Array.isArray(g.contexts)?g.contexts[0]:g.contexts).getPath()).getObject("@sapui.name")}let u;if(g.controlId){u=this.getView().byId(g.controlId);if(u){g.internalModelContext=u.getBindingContext("internal")}}else{g.internalModelContext=l.getBindingContext("internal")}g.ignoreETag=g.internalModelContext?.getProperty("/sessionOn");if(n&&n.includes("(")){a=n.split("(");n=a[0];r=a[a.length-1].replaceAll(")","")}if(g.bStaticAction&&u){if(u.isA("sap.ui.mdc.Table")){const e=u.getParent();g.contexts=(this.getView().getModel()?.bindList(e.getRowBinding().getHeaderContext().getPath())).getHeaderContext()}if(r&&u.getBindingContext()&&u.isA&&u.isA("sap.ui.mdc.Table")){g.contexts=this._getActionOverloadContextFromMetadataPath(u.getBindingContext(),u.getRowBinding(),r)}if(g.enableAutoScroll){c=this.createActionPromise(n,u.getId())}}g.bObjectPage=l.getViewData().converterType==="ObjectPage";try{await this.syncTask();const t=await s.callAction(n,g,this.getView(),this.getAppComponent(),this.getMessageHandler());const o=t.filter(Ee);if(t.length!==o.length){throw t}let a;if(g.contexts&&Array.isArray(g.contexts)&&g.isBound===true){a=await this._refreshListIfRequired(this.getActionResponseDataAndKeys(n,o),g.contexts[0])}if(this.base.collaborativeDraft.isConnected()){this._sendActivity(_e.Action,g.contexts,n,a,Object.keys(o[0].value.boundContext.getObject()))}this._triggerConfiguredSurvey(n,Fe.action);if(c){c.fResolver(o)}if(g.contexts){if(!this._isFclEnabled()&&this.base.getView().getViewData().converterType!=="ListReport"){f.setEditStateDirty()}this.getInternalModel().setProperty("/lastInvokedAction",n)}if(g.isNavigable){if(o.length===1){const t=this._getBoundContext(l,g)?o[0].value.boundContext:o[0].value.returnedContext??o[0].value.boundContext;const n=l.getModel().getMetaModel();const i=n.getMetaPath(t.getPath());const s=(e,t)=>e.filter(e=>{if(t){return t.includes(e)}return true});const a=Array.isArray(g.contexts)?s(g.contexts,g.applicableContexts)[0]:g.contexts;const r=a&&n.getMetaPath(a.getPath());if(i!=undefined&&i===r){if(a?.getPath()!==t.getPath()){this.getInternalRouting().navigateForwardToContext(t,{checkNoHashChange:true});if(this.getProgrammingModel(t)===qe.Draft&&(t.getProperty("IsActiveEntity")===false||this._isFclEnabled())){t.getBinding().destroy()}}else{e.info("Navigation to the same context is not allowed")}}}}this.base.editFlow.onAfterActionExecution(n);if(!Array.isArray(i?.contexts)&&o.length===1){return o[0].value.returnedContext??o[0].value.boundContext}return o.map(e=>({...e,...{value:e.value.returnedContext??e.value.boundContext}}))}catch(e){if(c){c.fRejector()}if(e===Ke.CancelActionDialog){throw new Error("Dialog cancelled")}throw e}};s.onAfterActionExecution=async function e(t){};s.customMassEditSave=async function e(t){return Promise.resolve(false)};s.securedExecution=async function e(t,n){const i=n?.busy?.set??true,s=n?.busy?.check??true,a=n?.updatesDocument??false,r=this.getGlobalUIModel(),c=this.getView().getBindingContext(),l=c&&this.getProgrammingModel(c)===qe.Draft,g=this.getMessageHandler().registerToHoldMessages();if(s&&o.isLocked(r)){return Promise.reject("Application already busy therefore execution rejected")}if(i){o.lock(r)}if(a&&l){this.setDraftStatus(Ue.Saving)}this.getMessageHandler().removeTransitionMessages();return this.syncTask(t).then(()=>{if(a){this.setDocumentModified(true);if(!this._isFclEnabled()){f.setEditStateDirty()}if(l){this.setDraftStatus(Ue.Saved)}}return}).catch(e=>{if(a&&l){this.setDraftStatus(Ue.Clear)}throw e}).finally(()=>{if(i){o.unlock(r)}this.getMessageHandler().showMessageDialog({unHoldKey:g})})};s.handlePatchSent=function e(t){const n=this.getView()?.getBindingContext("internal");const i=this.base.collaborativeDraft.isConnected()||n.getProperty("/sessionOn");if(i){t.getSource().getModel().setIgnoreETag(true)}if(!n?.getProperty("skipPatchHandlers")){const e=t.getSource();const n=new Promise((n,o)=>{t.getSource().attachEventOnce("patchCompleted",s=>{if(i){t.getSource().getModel().setIgnoreETag(false)}if(t.getSource().isA("sap.ui.model.odata.v4.ODataListBinding")){I.setActionEnablementAfterPatch(this.getView(),e,this.getView()?.getBindingContext("internal"))}const a=s.getParameter("success");if(a){n()}else{o()}})});this.updateDocument(e,n)}};s.handleCreateSent=function e(t){const n=t.getParameter("context");this.getMessageHandler().removeTransitionMessages(false,false,n.getPath())};s.syncTask=async function t(n){if(n){if(typeof n==="function"){this.syncTasks=this.syncTasks.then(n).catch(function(t){e.debug(t)})}else{this.syncTasks=this.syncTasks.then(async()=>n).catch(function(t){e.debug(t)})}}return this.syncTasks};s.computeModelsForEditMode=async function t(n){const i=this.getProgrammingModel(n);if(i===qe.Draft){if(this.getInternalModel().getProperty("/executeShareActionForCollaboration")){Re(n);this.getInternalModel().setProperty("/executeShareActionForCollaboration",false)}try{this.setDraftStatus(Ue.Clear);const e=this.getGlobalUIModel();e.setProperty("/isEditablePending",true,undefined,true);const t=await n.requestObject("IsActiveEntity");if(t===false){this.setEditMode(We.Editable);const e=await n.requestObject("HasActiveEntity");this.setEditMode(undefined,!e)}else{this.setEditMode(We.Display,false)}e.setProperty("/isEditablePending",false,undefined,true)}catch(t){e.error("Error while determining the editMode for draft",t)}}else if(i===qe.Sticky){const e=this.getInternalModel().getProperty("/lastInvokedAction");if(e&&this.isNewActionForSticky(e,n)){this.setEditMode(We.Editable,true);if(!this.getAppComponent()._isFclEnabled()){f.setEditStateDirty()}this.handleStickyOn(n);this._setStickySessionInternalProperties(this.getProgrammingModel(n),n.getModel());this.getInternalModel().setProperty("/lastInvokedAction",undefined)}}};s.deleteDocumentTransaction=async function e(t,n){if(n.selectedContexts){n.numberOfSelectedContexts=n.selectedContexts.length}const i=this._getResourceModel();const o=this.getTransactionHelper();if(n.controlId){const e=D.getElementById(n.controlId);if(e&&!e.isA("sap.ui.mdc.MultiValueField")){n.internalModelContext=e.getBindingContext("internal")}}await this.syncTask();await o.deleteDocument(t,n,this.getAppComponent(),i,this.getMessageHandler())};s._getResourceModel=function e(){return Ie(this.getView())};s.getTransactionHelper=function e(){return r};s.getMessageHandler=function e(){if(this.base.messageHandler){return this.base.messageHandler}else{throw new Error("Edit Flow works only with a given message handler")}};s.getInternalModel=function e(){return this.getView().getModel("internal")};s.getGlobalUIModel=function e(){return this.getView().getModel("ui")};s.getPageInternalModel=function e(){return this.getView().getModel("pageInternal")};s.setCreationMode=function e(t){const n=this.getView().getBindingContext("pageInternal");this.getPageInternalModel().setProperty(l.CreateMode,t,n,true)};s.getCreationMode=function e(){const t=this.getView().getBindingContext("pageInternal");return!!t.getProperty(l.CreateMode)};s.isDocumentModified=function e(){return!!this.getGlobalUIModel().getProperty(l.DocumentModified)};s.setDocumentModified=function e(t){this.getGlobalUIModel().setProperty(l.DocumentModified,t)};s.setDocumentModifiedOnCreate=function e(t){if(t.isRelative()){this.setDocumentModified(true)}};s.handleCreateEvents=function e(t){this.setDraftStatus(Ue.Clear);const n=this.getProgrammingModel(t);let i;t.attachEvent("createSent",()=>{if(n===qe.Draft){this.setDraftStatus(Ue.Saving)}i=this.getMessageHandler().registerToHoldMessages()});t.attachEvent("createCompleted",e=>{const t=e.getParameter("success");if(n===qe.Draft){this.setDraftStatus(t?Ue.Saved:Ue.Clear)}this.getMessageHandler().showMessageDialog({unHoldKey:i})})};s.setDraftStatus=function e(t){this.getView().getModel("ui").setProperty("/draftStatus",t,undefined,true)};s.getProgrammingModel=function e(t){return this.getTransactionHelper().getProgrammingModel(t)};s.setEditMode=function e(t,n){const i=this.getGlobalUIModel();if(t){i.setProperty("/isEditable",t==="Editable",undefined,true);if(t!=="Editable"){this.forceDraftSaveOrDiscard(false)}}if(n!==undefined){this.setCreationMode(n)}};s.forceDraftSaveOrDiscard=function e(t){this.getGlobalUIModel().setProperty("/forceDraftSaveOrDiscard",t,undefined,true)};s.shallForceDraftSaveOrDiscard=function e(){return this.getGlobalUIModel().getProperty("/forceDraftSaveOrDiscard")===true};s.isNewActionForSticky=function t(n,i){try{const e=i.getModel().getMetaModel();const t=e.getMetaContext(i.getPath());const o=ke(t).startingEntitySet;const s=o.annotations.Session?.StickySessionSupported;if(s?.NewAction===n){return true}if(s?.AdditionalNewActions&&s?.AdditionalNewActions.includes(n)){return true}return false}catch(t){e.info(t);return false}};s.handleStickyOn=async function t(n){const i=this.getAppComponent();try{if(i===undefined){throw new Error("undefined AppComponent for function handleStickyOn")}if(!i.getRouterProxy().hasNavigationGuard()){const e=i.getRouterProxy().getHash();const t=this.getInternalModel();setTimeout(function(){i.getRouterProxy().setNavigationGuard(n.getPath().substring(1))},0);await i.getShellServices().setBackNavigation(this.onBackNavigationInSession.bind(this,n));const o=this.base.getView().getModel("sap.fe.i18n");i.registerStickySessionCallbacks(this.getDirtyStateProvider(i,t,e),this.getSessionTimeoutFunction(n,o),this.getRouteMatchedFunction(n,i))}}catch(t){e.info(t);return false}return true};s.handleStickyOff=function t(){const n=this.getAppComponent();try{if(n===undefined){throw new Error("undefined AppComponent for function handleStickyOff")}if(n.getRouterProxy){n.getRouterProxy().discardNavigationGuard()}if(n.unregisterStickySessionCallbacks){n.unregisterStickySessionCallbacks()}this.setEditMode(We.Display,false);if(n.getShellServices){n.getShellServices().setBackNavigation()}}catch(t){e.info(t);return false}return true};s._setStickySessionInternalProperties=function e(t,n){if(t===qe.Sticky){const e=this.getInternalModel();e.setProperty("/sessionOn",true);e.setProperty("/stickySessionToken",n.getHttpHeaders(true)["SAP-ContextId"])}};s.getDirtyStateProvider=function t(n,i,o){return t=>{try{if(t===undefined){throw new Error("Invalid input parameters for DirtyStateProvider function")}const e=t.innerAppRoute;const s=n.getRouterProxy();let a="";let r;const c=i.getProperty("/sessionOn");if(!c){return undefined}if(!s.isNavigationFinalized()){r=false;a=e}else if(o===e){r=true}else if(s.checkHashWithGuard(e)||s.isGuardCrossAllowedByUser()){a=e;r=false}else{r=true}if(r){setTimeout(function(){n.getShellServices().setDirtyFlag(false)},0)}else{o=a}return r}catch(t){e.info(t);return undefined}}};s.getSessionTimeoutFunction=function t(n,i){return()=>{try{if(n===undefined){throw new Error("Context missing for SessionTimeout function")}this.getMessageHandler().removeTransitionMessages();const e=new C({title:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new M({text:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new m({text:"{sap.fe.i18n>C_COMMON_DIALOG_OK}",type:"Emphasized",press:()=>{this.handleStickyOff();this.getInternalRouting().navigateBackFromContext(n)}}),afterClose:function(){e.destroy()}});e.addStyleClass("sapUiContentPadding");e.setModel(i,"sap.fe.i18n");this.getView().addDependent(e);e.open()}catch(t){e.info(t);return undefined}return true}};s.getRouteMatchedFunction=function e(t,n){return()=>{const e=n.getRouterProxy().getHash();if(!e||!n.getRouterProxy().checkHashWithGuard(e)){this.discardStickySession(t);t.getModel().clearSessionContext()}}};s.discardStickySession=async function e(t){const n=await g.discardDocument(t);if(n?.hasPendingChanges()){n.getBinding().resetChanges()}if(!this.getCreationMode()){n?.refresh()}this.handleStickyOff()};s.getInternalRouting=function e(){if(this.base._routing){return this.base._routing}else{throw new Error("Edit Flow works only with a given routing listener")}};s._getRootViewController=function e(){return this.getAppComponent().getRootViewController()};s._getSemanticMapping=function e(){return this.getAppComponent().getRoutingService().getLastSemanticMapping()};s.createActionPromise=function e(t,n){let i,o;this.actionPromise=new Promise((e,t)=>{i=e;o=t}).then(e=>Object.assign({controlId:n},this.getActionResponseDataAndKeys(t,e)));return{fResolver:i,fRejector:o}};s.getActionResponseDataAndKeys=function e(t,n){if(n.length>=1){const e=this.base.getView();const i=e.getModel().getMetaModel().getData()??{};const o=i[t];const s=o?.[0].$ReturnType?o?.[0].$ReturnType.$Type:null;const a=s&&i[s]?i[s].$Key:[];return{oData:n[0].value.boundContext.getObject(),keys:a}}return undefined};s.getCurrentActionPromise=async function e(){return this.actionPromise};s.deleteCurrentActionPromise=function e(){this.actionPromise=undefined};s.showConfirmRecommendationsDialog=async function e(t){if(!this.confirmRecommendationsDialog){this.confirmRecommendationsDialog=new xe({view:this.getView()})}return this.confirmRecommendationsDialog?.open(t)};s._scrollAndFocusOnInactiveRow=function e(t){const n=t.getRowBinding();const i=n.getCount()||0;if(t.data("tableType")!=="ResponsiveTable"){if(i>0){t.scrollToIndex(i-1)}t.focusRow(i,true)}else{const e=n.getContexts();if(!e?.length){t.focusRow(i,true);return}let o=i,s=0;for(const t of e){if(t.isInactive()&&s<o){o=s}s++}if(o>0){t.scrollToIndex(o)}t.focusRow(o,true)}};s.createEmptyRowsAndFocus=async function e(t){const n=t.getParent();if(n?.tableDefinition?.control?.inlineCreationRowsHiddenInEditMode&&!t.getBindingContext("pageInternal")?.getProperty("createMode")){await n.setUpEmptyRows(t,true)}this._scrollAndFocusOnInactiveRow(t)};s._sendActivity=function e(t,n,i,o,s){const a=Array.isArray(n)?n.map(e=>e.getPath()):n?.getPath();this.base.collaborativeDraft.send({action:t,content:a,triggeredActionName:i,refreshListBinding:o,actionRequestedProperties:s})};s._triggerConfiguredSurvey=function e(t,n){Oe(this.base.getView(),t,n)};s._submitOpenChanges=async function e(t){const n=t.getModel(),i=this.getGlobalUIModel();try{await n.submitBatch("$auto");await n.oRequestor.waitForRunningChangeRequests("$auto");if(n.hasPendingChanges("$auto")){throw new Error("submit of open changes failed")}}finally{if(o.isLocked(i)){o.unlock(i)}}};s._removeStickySessionInternalProperties=function e(t){if(t===qe.Sticky){const e=this.getInternalModel();e.setProperty("/sessionOn",false);e.setProperty("/stickySessionToken",undefined);this.handleStickyOff()}};s.onBackNavigationInSession=function e(t){const n=this.base.getView();const i=this.getAppComponent().getRouterProxy();if(i.checkIfBackIsOutOfGuard()){g.processDataLossConfirmation(async()=>{await this.discardStickySession(t);this._removeStickySessionInternalProperties(qe.Sticky);history.back()},n,qe.Sticky);return}history.back()};s._handleNewContext=async function e(t,n){if(!this._isFclEnabled()){f.setEditStateDirty()}await this.getInternalRouting().navigateToContext(t,{checkNoHashChange:true,editable:n.editable,persistOPScroll:true,recreateContext:n.recreateContext,reason:_.EditFlowAction,showPlaceholder:false,forceFocus:n.forceFocus??false,keepCurrentLayout:true})};s._getBoundContext=function e(t,n){const i=t.getViewData().viewLevel;const o=i>1||i===1&&n.controlId;return!n.isNavigable||!!o};s._checkForValidationErrors=async function t(){return this.syncTask().then(()=>{const t=this.getView().getId();const n=P.getMessageModel().getData();let i;if(!n.length){e.info("No validation errors found");return}for(const e of n){if(e.validation){i=D.getElementById(e.getControlId());while(i){if(i.getId()===t){throw"validation errors exist"}i=i.getParent()}}}return})};s._refreshListIfRequired=async function e(t,n){if(!n||!t||!t.oData||!t.keys){return false}const i=n.getBinding();if(i&&i.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=t.oData;const o=t.keys;const s=n.getObject();let a=true;if(Object.keys(e).length){a=o.every(function(t){return s[t]===e[t]});if(!a){await this.getTransactionHelper().refreshListBinding(i,this.getAppComponent());return true}}}return false};s._fetchSemanticKeyValues=async function e(t){const n=t.getModel().getMetaModel(),i=n.getMetaContext(t.getPath()).getObject("@sapui.name"),o=p.getSemanticKeys(n,i);if(o&&o.length){const e=o.map(e=>e.$PropertyPath);await t.requestProperty(e)}};s._getActionOverloadContextFromMetadataPath=function e(t,n,i){const o=t.getModel();const s=o.getMetaModel();let a=n.getPath().split("/");let r=t;a.pop();if(a.length===0){a=[""]}if(a[0]!==""){a.unshift("")}const c=a.map(e=>{if(e!==""){r=o.bindContext(e,r).getBoundContext()}else{r=t}return r}).reverse();const l=c.find(e=>s.getMetaContext(e.getPath()).getObject("$Type")===i);return l||n.getHeaderContext()};s._createSiblingInfo=function e(t,n){return{targetContext:n,pathMapping:[{oldPath:t.getPath(),newPath:n.getPath()}]}};s._updatePathsInHistory=function e(t){const n=this.getAppComponent();n.getRouterProxy().setPathMapping(t);const i=this._getSemanticMapping();if(t.length&&i?.technicalPath===t[t.length-1].oldPath){i.technicalPath=t[t.length-1].newPath}};s._getNavigationTargetForEdit=function e(t,n,i){let o;i=i??this._createSiblingInfo(t,n);this._updatePathsInHistory(i.pathMapping);if(i.targetContext.getPath()!=n.getPath()){o=t.getPath()===i.targetContext.getPath()?t:i.targetContext}return o};s._computeSiblingInformation=async function t(n,i,o,s,a,r){i=i??n;if(!i.getPath().startsWith(n.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}let l=i;if(o===qe.Draft&&this.getProgrammingModel(i)!==qe.Draft){l=n}if(s&&l.getPath()===n.getPath()){return Promise.resolve(undefined)}const g=n.getModel();if(o===qe.Draft){return c.computeSiblingInformation(n,l,a,r)}else{return{targetContext:g.bindContext(i.getPath()).getBoundContext(),pathMapping:[]}}};s._isFclEnabled=function e(){return this.getAppComponent()._isFclEnabled()};s.checkRecommendationOption=async function e(){const t=await this.showConfirmRecommendationsDialog(true);if(t===Ae.Continue){return Promise.reject(Ae.Continue)}return t};return i}(i),$e(ve.prototype,"editDocument",[F,B],Object.getOwnPropertyDescriptor(ve.prototype,"editDocument"),ve.prototype),$e(ve.prototype,"updateDocument",[H,V],Object.getOwnPropertyDescriptor(ve.prototype,"updateDocument"),ve.prototype),$e(ve.prototype,"createDocument",[N,j],Object.getOwnPropertyDescriptor(ve.prototype,"createDocument"),ve.prototype),$e(ve.prototype,"onBeforeCreate",[L,G],Object.getOwnPropertyDescriptor(ve.prototype,"onBeforeCreate"),ve.prototype),$e(ve.prototype,"onBeforeEdit",[$,q],Object.getOwnPropertyDescriptor(ve.prototype,"onBeforeEdit"),ve.prototype),$e(ve.prototype,"onBeforeSave",[K,U],Object.getOwnPropertyDescriptor(ve.prototype,"onBeforeSave"),ve.prototype),$e(ve.prototype,"onBeforeDiscard",[W,z],Object.getOwnPropertyDescriptor(ve.prototype,"onBeforeDiscard"),ve.prototype),$e(ve.prototype,"onBeforeDelete",[J,Q],Object.getOwnPropertyDescriptor(ve.prototype,"onBeforeDelete"),ve.prototype),$e(ve.prototype,"onAfterSave",[X,Y],Object.getOwnPropertyDescriptor(ve.prototype,"onAfterSave"),ve.prototype),$e(ve.prototype,"onAfterCreate",[Z,ee],Object.getOwnPropertyDescriptor(ve.prototype,"onAfterCreate"),ve.prototype),$e(ve.prototype,"onAfterEdit",[te,ne],Object.getOwnPropertyDescriptor(ve.prototype,"onAfterEdit"),ve.prototype),$e(ve.prototype,"onAfterDiscard",[ie,oe],Object.getOwnPropertyDescriptor(ve.prototype,"onAfterDiscard"),ve.prototype),$e(ve.prototype,"onAfterDelete",[se,ae],Object.getOwnPropertyDescriptor(ve.prototype,"onAfterDelete"),ve.prototype),$e(ve.prototype,"saveDocument",[re,ce],Object.getOwnPropertyDescriptor(ve.prototype,"saveDocument"),ve.prototype),$e(ve.prototype,"cancelDocument",[le,ge],Object.getOwnPropertyDescriptor(ve.prototype,"cancelDocument"),ve.prototype),$e(ve.prototype,"deleteDocument",[de,fe],Object.getOwnPropertyDescriptor(ve.prototype,"deleteDocument"),ve.prototype),$e(ve.prototype,"applyDocument",[ue,he],Object.getOwnPropertyDescriptor(ve.prototype,"applyDocument"),ve.prototype),$e(ve.prototype,"invokeAction",[pe,ye],Object.getOwnPropertyDescriptor(ve.prototype,"invokeAction"),ve.prototype),$e(ve.prototype,"onAfterActionExecution",[me,Ce],Object.getOwnPropertyDescriptor(ve.prototype,"onAfterActionExecution"),ve.prototype),$e(ve.prototype,"customMassEditSave",[we,Me],Object.getOwnPropertyDescriptor(ve.prototype,"customMassEditSave"),ve.prototype),$e(ve.prototype,"securedExecution",[De,be],Object.getOwnPropertyDescriptor(ve.prototype,"securedExecution"),ve.prototype),ve))||Pe);return Je},false);
//# sourceMappingURL=EditFlow.js.map