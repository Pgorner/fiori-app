/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/uid","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/MessageType","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution"],function(e,s,t,o,n,i,r,a,g,c,l){"use strict";var u,h,d,f,p,M,T,y,m,w;var S=o.publicExtension;var v=o.privateExtension;var E=o.finalExtension;var D=o.extensible;var b=o.defineUI5Class;function C(e,s){e.prototype=Object.create(s.prototype),e.prototype.constructor=e,O(e,s)}function O(e,s){return O=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,s){return e.__proto__=s,e},O(e,s)}function P(e,s,t,o,n){var i={};return Object.keys(o).forEach(function(e){i[e]=o[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=t.slice().reverse().reduce(function(t,o){return o(e,s,t)||t},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer?(Object.defineProperty(e,s,i),null):i}let _=(u=b("sap.fe.core.controllerextensions.MessageHandler"),h=v(),d=D(l.Instead),f=S(),p=E(),M=S(),T=S(),y=E(),u(m=(w=function(o){function c(){var e;e=o.call(this)||this;e.strictWarningMessages=[];e.holdKeys=[];e.holdMsgsToShow=false;return e}C(c,o);var l=c.prototype;l.addWarningMessagesToMessageHandler=function e(s){this.strictWarningMessages=this.strictWarningMessages.concat(s)};l.isStrictWarningMessage=function e(t){return this.strictWarningMessages.find(e=>e.getCode()===t.getCode()&&e.getMessage()===t.getMessage()&&e.getType()===t.getType()&&e.getDescriptionUrl()===t.getDescriptionUrl()&&s(e.getTargets(),t.getTargets())&&e.getPersistent()===t.getPersistent())!==undefined};l.clearStrictWarningMessages=function e(){this.strictWarningMessages=[]};l.filterErrorMessages=function e(s){return s.filter(e=>e.getType()===g.Error)};l.getShowBoundMessagesInMessageDialog=function e(){return true};l.registerToHoldMessages=function e(s){const o=s??t();if(!this.holdKeys.includes(o)){this.holdKeys.push(o)}return o};l.resetHoldKeys=function e(){this.holdKeys=[]};l.showMessageDialog=async function e(s){const t=a.getMessageModel().getData();const o=t.filter(e=>this.isStrictWarningMessage(e));a.removeMessages(o);const n=s&&s.customMessages?s.customMessages:undefined,i=this.base.getView().getBindingContext("internal");const r=this.base.getView().getViewData().converterType;if(s&&s.isActionParameterDialogOpen&&i){i.setProperty("isActionParameterDialogOpen",true)}const g=this.getShowBoundMessagesInMessageDialog();const c=s&&s.context?s.context:this.getView().getBindingContext();if(i){i.setProperty("isActionParameterDialogOpen",false)}return new Promise(function(e,t){setTimeout(function(){this.processAndShowMessages(s??{},c,g,n??[],e,t,r)}.bind(this),0)}.bind(this))};l.processAndShowMessages=function e(s,t,o,n,r,a,g){const{concurrentEditFlag:c,control:l,sActionName:u,onBeforeShowMessage:h,unHoldKey:d,forceShowUIElement:f=false,overrideUIDecision:p,showBoundStateMessages:M}=s;this.holdMsgsToShow=true;const T=i.getUIDecisions(n,t,o,c,l,u,h,g,M,s);this.updateUIDecisions(T,p);this.removeHoldKey(d??l?.getId());this.showMessagesWithCondtions(f,r,a)};l.showMessagesWithCondtions=function s(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;let o=arguments.length>1?arguments[1]:undefined;let n=arguments.length>2?arguments[2]:undefined;const r=t||this.checkToShowUIElement();if(r&&this.uiDecisions){i.showMessagesInUI(this.uiDecisions).then(o).catch(n);this.uiDecisions=undefined;this.clearStrictWarningMessages();this.holdMsgsToShow=false}else{e.info("FE : V4 : MessageHandler : Holding messages until a registered process ");o?.()}};l.removeTransitionMessages=function e(s,t,o){if(!s){i.removeBoundTransitionMessages(o)}if(!t){i.removeUnboundTransitionMessages()}};l._checkNavigationToErrorPage=function e(s){const t=i.getMessages();const o=this.getShowBoundMessagesInMessageDialog();const r=o?i.getMessages(true,true):[];const a=s&&s.customMessages?s.customMessages:[];const g=n.isStickyEditMode(this.base.getView());let c;if(s?.isDataReceivedError===true){c={title:s.title,description:s.description,navigateBackToOrigin:true,errorType:"PageNotFound"}}else if(!g&&!r.length&&!a.length&&(t.length===1||s?.isInitialLoad503Error===true)){const e=t[0];const s=e.getTechnicalDetails();if(s?.httpStatus===503){c=this._getHTTP503MessageParameters(e,s)}}return c};l._getHTTP503MessageParameters=function e(s,t){let o;const n=t.retryAfter!==undefined?this._getSecondsBeforeRetryAfter(t.retryAfter):undefined;if(n===undefined||n>120){const e=i.getRetryAfterMessage(s);o={description:e?`${e} ${s.getMessage()}`:s.getMessage(),navigateBackToOrigin:true,errorType:"UnableToLoad"}}return o};l._getSecondsBeforeRetryAfter=function e(s){const t=new Date,o=t.getTime(),n=s.getTime(),i=(n-o)/1e3;return i};l.updateUIDecisions=function e(s){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;const o=this.uiDecisions;let n=[];let i;if(o&&t===false){if(o.messagesToShow.length===1&&s.messagesToShow.length===1&&o.messagesToShow[0].getCode()==="C_COMMON_SUCCESS_MESSAGE"&&s.messagesToShow[0].getCode()==="C_COMMON_SUCCESS_MESSAGE"){n=o.messagesToShow}else{n=Array.from(new Set([...o.messagesToShow,...s.messagesToShow]))}const e=[o.uiElementToUse,s.uiElementToUse];let t=n.length>0?"Dialog":"None";if(n.length===1){if(e.includes("Toast")){t="Toast"}else if(e.includes("Box")){t="Box"}}i={messagesToShow:n,uiElementToUse:t,contextNeedsEtagRefresh:o.contextNeedsEtagRefresh||s.contextNeedsEtagRefresh,containsBoundTransition:o.containsBoundTransition||s.containsBoundTransition}}else{i=s}this.uiDecisions=i};l.removeHoldKey=function e(s){if(s&&this.holdKeys.includes(s)){this.holdKeys.splice(this.holdKeys.indexOf(s),1)}};l.checkToShowUIElement=function e(){return this.holdMsgsToShow&&(this.holdKeys.length>0?false:true)};l.holdMessagesForControl=function e(s){const t=s.getId();this.registerToHoldMessages(t)};l.releaseHoldByControl=function e(s){const t=s?.getId();this.removeHoldKey(t);this.showMessagesWithCondtions()};l.showMessages=async function e(s){const t=this._checkNavigationToErrorPage(s);if(t){if(s?.messagePageNavigationCallback){s.messagePageNavigationCallback()}t.handleShellBack=!s?.shellBack;this.removeTransitionMessages();const e=r.getResourceBundleFor("sap.fe.core");this.resetHoldKeys();return new Promise((o,n)=>{setTimeout(()=>{this.base._routing.navigateToMessagePage(s?.isDataReceivedError===true?e.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"):e.getText("C_MESSAGE_HANDLING_SAPFE_503_TITLE"),t).then(o).catch(n)},0)})}else{return this.showMessageDialog(s)}};return c}(c),P(w.prototype,"getShowBoundMessagesInMessageDialog",[h,d],Object.getOwnPropertyDescriptor(w.prototype,"getShowBoundMessagesInMessageDialog"),w.prototype),P(w.prototype,"showMessageDialog",[f,p],Object.getOwnPropertyDescriptor(w.prototype,"showMessageDialog"),w.prototype),P(w.prototype,"removeTransitionMessages",[M],Object.getOwnPropertyDescriptor(w.prototype,"removeTransitionMessages"),w.prototype),P(w.prototype,"showMessages",[T,y],Object.getOwnPropertyDescriptor(w.prototype,"showMessages"),w.prototype),w))||m);return _},false);
//# sourceMappingURL=MessageHandler.js.map