{"version":3,"names":["COLLABORATION","CONNECTION","CURRENTDRAFTID","WEBSOCKETSTATUS","WEBSOCKET_STATUS","_exports","isCollaborationConnected","internalModel","getProperty","CONNECTED","initializeCollaboration","user","draftUUID","receiveCallback","view","sendUserInfo","arguments","length","undefined","endCollaboration","activeUsers","setProperty","activities","additionalParameters","draft","URLSearchParams","window","location","search","get","id","initialName","webSocket","createWebSocket","ChannelType","CollaborationDraft","getModel","CONNECTING","attachMessage","event","message","getParameter","attachOpen","attachError","includes","resourceModel","getResourceModel","lostOfConnectionText","getText","MessageBox","warning","actions","Action","OK","emphasizedAction","ERROR","attachClose","CLOSED","broadcastCollaborationMessage","action","content","triggeredActionName","refreshListBinding","requestedProperties","send","clientAction","clientContent","clientTriggeredActionName","clientRefreshListBinding","clientRequestedProperties","Activity","Activate","Discard","CLOSING","close"],"sourceRoot":".","sources":["ActivityBase.ts"],"sourcesContent":["import type { FEView } from \"sap/fe/core/BaseController\";\nimport type { Message, User } from \"sap/fe/core/controllerextensions/collaboration/CollaborationCommon\";\nimport { Activity } from \"sap/fe/core/controllerextensions/collaboration/CollaborationCommon\";\nimport { getResourceModel } from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport type { WebSocketParameter } from \"sap/fe/core/helpers/WebSocket\";\nimport { ChannelType, createWebSocket } from \"sap/fe/core/helpers/WebSocket\";\nimport MessageBox from \"sap/m/MessageBox\";\nimport type Event from \"sap/ui/base/Event\";\nimport type SapPcpWebSocket from \"sap/ui/core/ws/SapPcpWebSocket\";\nimport type { WebSocket$MessageEvent } from \"sap/ui/core/ws/WebSocket\";\nimport type JSONModel from \"sap/ui/model/json/JSONModel\";\n\nconst COLLABORATION = \"/collaboration\";\nconst CONNECTION = \"/collaboration/connection\";\nconst CURRENTDRAFTID = \"/collaboration/DraftID\";\nconst WEBSOCKETSTATUS = \"/collaboration/websocket_status\";\n\nexport enum WEBSOCKET_STATUS {\n\tCLOSED = 0,\n\tCLOSING = 1,\n\tCONNECTING = 2,\n\tCONNECTED = 3,\n\tERROR = 4\n}\n\nexport function isCollaborationConnected(internalModel: JSONModel): boolean {\n\treturn internalModel.getProperty(WEBSOCKETSTATUS) === WEBSOCKET_STATUS.CONNECTED;\n}\n\n/**\n * Initializes the collaboration websocket.\n * @param user\n * @param draftUUID\n * @param internalModel\n * @param receiveCallback\n * @param view\n * @param sendUserInfo\n * @returns True if a new websocket was created\n */\nexport function initializeCollaboration(\n\tuser: User,\n\tdraftUUID: string,\n\tinternalModel: JSONModel,\n\treceiveCallback: (_: Message) => void,\n\tview: FEView,\n\tsendUserInfo = false\n): boolean {\n\tif (internalModel.getProperty(CONNECTION)) {\n\t\t// A connection is already established\n\t\tif (internalModel.getProperty(CURRENTDRAFTID) === draftUUID) {\n\t\t\t// Connection corresponds to the same draft -> nothing to do\n\t\t\treturn false;\n\t\t} else {\n\t\t\t// There was a connection to another draft -> we close it before creating a new one\n\t\t\t// This can happen e.g. when switching between items in FCL\n\t\t\tendCollaboration(internalModel);\n\t\t}\n\t}\n\n\tconst activeUsers: User[] = [user];\n\tinternalModel.setProperty(COLLABORATION, { activeUsers: activeUsers, activities: {} });\n\n\tconst additionalParameters: WebSocketParameter = {\n\t\tdraft: draftUUID\n\t};\n\tif (sendUserInfo || new URLSearchParams(window.location.search).get(\"useFLPUser\") === \"true\") {\n\t\t// used for internal testing\n\t\tadditionalParameters[\"userID\"] = user.id;\n\t\tadditionalParameters[\"userName\"] = user.initialName ?? \"\";\n\t}\n\n\tconst webSocket = createWebSocket(ChannelType.CollaborationDraft, view.getModel(), additionalParameters);\n\n\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CONNECTING);\n\tinternalModel.setProperty(CONNECTION, webSocket);\n\tinternalModel.setProperty(CURRENTDRAFTID, draftUUID);\n\n\twebSocket.attachMessage(function (event: WebSocket$MessageEvent & Event<{ pcpFields?: Message }>): void {\n\t\tconst message = event.getParameter(\"pcpFields\");\n\t\tif (message) {\n\t\t\treceiveCallback(message);\n\t\t}\n\t});\n\n\twebSocket.attachOpen(function () {\n\t\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CONNECTED);\n\t});\n\n\twebSocket.attachError(function () {\n\t\tif ([WEBSOCKET_STATUS.CONNECTING, WEBSOCKET_STATUS.CONNECTED].includes(internalModel.getProperty(WEBSOCKETSTATUS))) {\n\t\t\tconst resourceModel = getResourceModel(view);\n\t\t\tconst lostOfConnectionText = resourceModel.getText(\"C_COLLABORATIONDRAFT_CONNECTION_LOST\");\n\n\t\t\tMessageBox.warning(lostOfConnectionText, {\n\t\t\t\tactions: [MessageBox.Action.OK],\n\t\t\t\temphasizedAction: MessageBox.Action.OK\n\t\t\t});\n\t\t}\n\t\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.ERROR);\n\t});\n\n\twebSocket.attachClose(function () {\n\t\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CLOSED);\n\t});\n\n\treturn true;\n}\n\nexport function broadcastCollaborationMessage(\n\taction: Activity,\n\tcontent: string | undefined,\n\tinternalModel: JSONModel,\n\ttriggeredActionName?: string,\n\trefreshListBinding?: boolean,\n\trequestedProperties?: string\n): void {\n\tif (isCollaborationConnected(internalModel)) {\n\t\tconst webSocket = internalModel.getProperty(CONNECTION) as SapPcpWebSocket;\n\n\t\twebSocket.send(\"\", {\n\t\t\tclientAction: action,\n\t\t\tclientContent: content,\n\t\t\tclientTriggeredActionName: triggeredActionName,\n\t\t\tclientRefreshListBinding: refreshListBinding,\n\t\t\tclientRequestedProperties: requestedProperties\n\t\t});\n\n\t\tif (action === Activity.Activate || action === Activity.Discard) {\n\t\t\tendCollaboration(internalModel);\n\t\t}\n\t}\n}\n\nexport function endCollaboration(internalModel: JSONModel): void {\n\tconst webSocket = internalModel.getProperty(CONNECTION) as SapPcpWebSocket | undefined;\n\tinternalModel.setProperty(COLLABORATION, {});\n\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CLOSING);\n\twebSocket?.close();\n}\n"],"mappings":"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","ignoreList":[],"file":"ActivityBase-dbg.js"}