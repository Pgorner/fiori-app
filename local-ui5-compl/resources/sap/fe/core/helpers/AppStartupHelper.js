/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","../converters/MetaModelConverter","./ModelHelper","./SemanticKeyHelper"],function(e,t,n,a,s){"use strict";var r=n.getInvolvedDataModelObjects;const o={_getKeysFromStartupParams:function(e,t){let n=true;const a=e.map(e=>{if(t?.[e]&&t[e].length===1){return{name:e,value:t[e][0]}}else{n=false;return{name:e,value:""}}});return n?a:undefined},_createFilterFromKeys:function(n,s,r){const o=a.isFilteringCaseSensitive(r);let i=false;const c=n.map(n=>{if(n.name==="IsActiveEntity"){i=true}return new e({path:n.name,operator:t.EQ,value1:n.value,caseSensitive:o})});if(s&&!i){const t=new e({filters:[new e("IsActiveEntity","EQ",false),new e("SiblingEntity/IsActiveEntity","EQ",null)],and:false});c.push(t)}return new e(c,true)},_sanitizeKeys:function(e,t){e.forEach(e=>{const n=t[e.name].$Type;switch(n){case"Edm.Boolean":if(e.value!=="true"&&e.value!=="false"){e.value=e.value.trim().length?"true":"false"}break;case"Edm.Guid":{const t=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/.exec(e.value);e.value=t?t[0]:e.value;break}default:}})},_requestObjectsFromParameters:async function(e,t){const n=e.map(async e=>{const n=t.getMetaModel().getObject(`${e.contextPath}/`);if(e.technicalKeys){this._sanitizeKeys(e.technicalKeys,n);const a=`${e.contextPath}(${s.getPathContent(e.technicalKeys,n)})`;const r=t.bindContext(a).getBoundContext();return Promise.resolve([r])}else{const a=e.semanticKeys??[];this._sanitizeKeys(a,n);const s=this._createFilterFromKeys(a,e.draftMode,t.getMetaModel());const r=t.bindList(e.contextPath,undefined,undefined,s,{$select:a.map(e=>e.name).join(",")});return r.requestContexts(0,2)}});return Promise.all(n)},_getReachablePageInfoFromRoute:function(e,t,n,a){let s=e.pattern.replace(":?query:","");s=s.replace(/\/$/,"");if(!s||!s.endsWith(")")){return undefined}s=s.replace(/\(\{[^}]*\}\)/g,"(#)");const o=Array.isArray(e.target)?e.target[e.target.length-1]:e.target;const i=t?.targets?.[o];const c=s.split("/");const l=c.length-1;if(l!==0&&i?.options?.settings?.allowDeepLinking!==true){return undefined}let u="";if(i?.options?.settings?.entitySet){u=`/${i.options.settings.entitySet}`}else if(i?.options?.settings?.contextPath){const e=a.createBindingContext(i.options.settings.contextPath);const t=r(e);if(t.targetEntitySet){u=`/${t.targetEntitySet.name}`}}if(!u){return undefined}const f=u&&a.getObject(`/$EntityContainer${u}/`);if(!f){return undefined}let g=a.getObject(`/$EntityContainer${u}/@com.sap.vocabularies.Common.v1.SemanticKey`)?.map(e=>e.$PropertyPath);const p=f["$Key"];if(l===0&&g&&g.length===p.length&&g.every(e=>p.includes(e))){g=undefined}const d=g?this._getKeysFromStartupParams(g,n):undefined;const h=!d&&l===0?this._getKeysFromStartupParams(p,n):undefined;if(d===undefined&&h===undefined){return undefined}const m=a.getObject(`/$EntityContainer${u}@com.sap.vocabularies.Common.v1.DraftRoot`)||a.getObject(`/$EntityContainer${u}@com.sap.vocabularies.Common.v1.DraftNode`)?true:false;return{pattern:s,contextPath:u,draftMode:m,technicalKeys:h,semanticKeys:d,target:o,pageLevel:l}},_getReachablePages:function(e,t,n){const a=e?.routes??[];const s={};a.forEach(a=>{const r=this._getReachablePageInfoFromRoute(a,e,t,n);if(r){if(!s[r.pageLevel]){s[r.pageLevel]=[]}s[r.pageLevel].push(r)}});const r=[];let o=0;while(s[o]){r.push(s[o]);o++}return r},_getStartupPagesFromStartupParams:function(e,t,n){const a=this._getReachablePages(e,t,n);if(a.length===0){return[]}let s=[];const r=[];function o(e){const t=a[e];const n=r.length?r[r.length-1]:undefined;if(t){t.forEach(function(t){if(!n||t.pattern.indexOf(n.pattern)===0){r.push(t);o(e+1);r.pop()}})}if(r.length>s.length){s=r.slice()}}o(0);return s},_getDeepLinkObject:function(e,t){if(t.length===1){return{context:t[0]}}else if(t.length>1){let n=e[e.length-1].pattern;t.forEach(function(e){n=n.replace("(#)",`(${e.getPath().split("(")[1]}`)});return{hash:n}}else{return{}}},getDeepLinkStartupHash:async function(e,t,n){await n.getMetaModel().requestObject("/$EntityContainer/");const a=this._getStartupPagesFromStartupParams(e,t,n.getMetaModel());const s=await this._requestObjectsFromParameters(a,n);if(s.length){const e=[];s.forEach(function(t){if(t.length===1){e.push(t[0])}});return e.length===s.length?this._getDeepLinkObject(a,e):{}}else{return{}}},getCreateStartupHash:async function(e,t,n,a){return a.requestObject(`${t}@`).then(s=>{let r="";let o=true;if(s["@com.sap.vocabularies.Common.v1.DraftRoot"]&&s["@com.sap.vocabularies.Common.v1.DraftRoot"]["NewAction"]){r=`${t}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction@Org.OData.Core.V1.OperationAvailable`}else if(s["@com.sap.vocabularies.Session.v1.StickySessionSupported"]&&s["@com.sap.vocabularies.Session.v1.StickySessionSupported"]["NewAction"]){r=`${t}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction@Org.OData.Core.V1.OperationAvailable`}if(r){const e=a.getObject(r);if(e===false){o=false}}else{const e=s["@Org.OData.Capabilities.V1.InsertRestrictions"];if(e&&e.Insertable===false){o=false}}if(o){return this.getDefaultCreateHash(e,t,n)}else{return""}})},getDefaultCreateHash:function(e,t,n){let a=e&&e.preferredMode?e.preferredMode[0]:"create";let s="";a=a.includes(":")&&a.length>a.indexOf(":")+1?a.substring(0,a.indexOf(":")):"create";s=`${t.substring(1)}(...)?i-action=${a}`;if(n.getRouteInfoByHash(s)){return s}else{throw new Error(`No route match for creating a new ${t.substring(1)}`)}},verifyEditAnnotations:async function(e,t){const n=await t.requestObject(`${e}@`);const a=n?.["@com.sap.vocabularies.UI.v1.UpdateHidden"];let s=true;if(n?.["@com.sap.vocabularies.Common.v1.DraftRoot"]?.["EditAction"]){s=t.getObject(`${e}@com.sap.vocabularies.Common.v1.DraftRoot/EditAction@Org.OData.Core.V1.OperationAvailable`)}return s!==false&&a!==true}};return o},false);
//# sourceMappingURL=AppStartupHelper.js.map