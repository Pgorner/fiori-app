/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/controls/Any","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/ActionHelper","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType","./controls/AnyElement","./converters/ConverterContext","./converters/MetaModelConverter","./converters/objectPage/HeaderAndFooterAction"],function(e,t,n,o,a,i,s,r,l,c,d,g,p,f,u){"use strict";var b=u.getHiddenExpression;var y=u.getEditButtonEnabled;var A=f.convertTypes;var m=r.getIsActionCriticalExpression;var E=s.isEntitySet;var P=n.transformRecursively;var C=n.isConstant;var h=n.equal;var M=n.constant;var x=n.compileExpression;var v=n.compileConstant;const $={_addMessageForActionParameter:function(e){l.addMessages(e.map(e=>{const t=e.actionParameterInfo.field.getBinding(e.actionParameterInfo.isMultiValue?"items":"value");return new c({message:e.message,type:d.Error,processor:t?.getModel()??undefined,persistent:true,target:t?.getResolvedPath()})}))},validateProperties:async function(e,t){await Promise.allSettled(e.map(e=>e.validationPromise));const n=e.filter(e=>e.field.getRequired());const o=l.getMessageModel().getData();const a=n.filter(e=>{const t=e.field.getId();const n=o.filter(e=>e.getControlIds().some(e=>e.includes(t)));if(n.length>0){return false}else if(e.isMultiValue){return e.value===undefined||!e.value.length}else{const t=e.field.getValue();const n=Array.isArray(e.field.getValue());if(n){return t[0]===null||t[0]===""}return t===undefined||t===null||t===""}});if(a.length){this._addMessageForActionParameter(a.map(e=>({actionParameterInfo:e,message:t.getText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_MISSING_MANDATORY_MSG",[(e.field.getParent()?.getAggregation("label")).getText()])})))}const i=e.find(e=>e.field.getVisible()&&(e.hasError||e.field.getValueState()==="Error"||a.includes(e)));if(i){i.field.setVisible(true);i.field.focus();return false}else{return true}},setActionEnablement:async function(e,t,n,a){let i=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;const s=[];for(const r in t){let l=[];e.setProperty(r,false);if(a==="table"){e.setProperty(`dynamicActions/${r}/aApplicable`,[]);e.setProperty(`dynamicActions/${r}/aNotApplicable`,[]);if(i){e.setProperty(`dynamicActions/${r}/bEnabledForContextMenu`,false)}else{e.setProperty(`dynamicActions/${r}/bEnabled`,false)}}const c=t[r];for(const t of n){const n=t;if(n){const t=n.getObject();if(a==="chart"){if(c===null&&!!t[`#${r}`]||n.getObject(c)){e.setProperty(r,true);break}}else if(a==="table"){l=this._setActionEnablementForTable(n,e,r,c,l,i)}}}if(a==="table"){if(!n.length){e.setProperty(`dynamicActions/${r}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]});s.push(o.setContextsBasedOnOperationAvailable(e,[],i))}else if(n.length&&typeof c==="string"){s.push(o.setContextsBasedOnOperationAvailable(e,l,i))}}}return Promise.all(s)},setActionEnablementAfterPatch:function(e,t,n){const o=n?.getObject();const a=o?.controls||{};for(const n in a){if(a[n]&&a[n].controlId){const o=e.byId(n);if(o&&o.isA("sap.ui.mdc.Table")){const e=o.getRowBinding();if(e==t){$.setActionEnablement(o.getBindingContext("internal"),JSON.parse(o.data("operationAvailableMap").customData),o.getSelectedContexts(),"table")}}}}},updateEditButtonVisibilityAndEnablement(e){const n=e.getViewData()?.viewLevel,a=o.getIsEditable(e);if(n>1&&a!==true){const n=e.getBindingContext();const a=o.getAppComponent(e);const s=i.getMetaPathForContext(n);const r=i.getRootEntitySetPath(s);const l=n?.getModel().getMetaModel()?.getContext(n?.getPath());const c=p?.createConverterContextForMacro(r,l,a.getDiagnostics(),t);const d=c.getEntitySet();const g=c.getEntityType();let f;const u=E(d)&&d.annotations.UI?.UpdateHidden?.valueOf();if(u!==true){f=i.isUpdateHidden(d,g)}const A=y(c);const m=i.getDraftRootPath(n);const P=i.getStickyRootPath(n);const C=m||P;const M=e.getBindingContext("internal");if(C){const t=e.getModel().bindContext(C).getBoundContext();if(f!==undefined){const n=x(h(b(c,f),false));this.updateEditModelContext(n,e,t,"rootEditVisible",M)}if(A){this.updateEditModelContext(A,e,t,"rootEditEnabled",M)}}}},updateEditModelContext:function(e,t,n,o,a){if(e){const i=new g({anyText:e});i.setBindingContext(null);t.addDependent(i);i.getBinding("anyText");const s=i.getModel()?.bindContext(n.getPath(),n,{$$groupId:"$auto.Heroes"})?.getBoundContext();i.setBindingContext(s);i?.getBinding("anyText")?.attachChange(e=>{const t=e.getSource().getExternalValue();a.setProperty(o,t)})}},_setActionEnablementForTable:function(e,t,n,a,i){let s=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;const r=s?"bEnabledForContextMenu":"bEnabled",l=t.getProperty(`dynamicActions/${n}/aApplicable`)||[],c=t.getProperty(`dynamicActions/${n}/aNotApplicable`)||[];let d=t.getProperty(`dynamicActions/${n}/${r}`)||false;if(!s){t.setProperty(`dynamicActions/${n}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]})}else{t.setProperty(`dynamicActions/${n}`,{bEnabled:t.getProperty(`dynamicActions/${n}/bEnabled`),aApplicable:t.getProperty(`dynamicActions/${n}/aApplicable`),aNotApplicable:t.getProperty(`dynamicActions/${n}/aNotApplicable`),bEnabledForContextMenu:false,aApplicableForContextMenu:[],aNotApplicableForContextMenu:[]})}const g=`${t.getPath()}/dynamicActions/${n}/${r}`;if(typeof a==="object"&&a!==null&&a!==undefined){if(e){const n=e.getObject();const o=P(a,"PathInModel",function(e){return n?M(n[e.path]):M(false)},true);const i=x(o);d=d||i==="true";t.getModel().setProperty(g,d);(i==="true"?l:c).push(e)}o.setDynamicActionContexts(t,n,l,c,s)}else{const s=e?.getObject();if(a===null&&!!s[`#${n}`]){t.getModel().setProperty(g,true)}else if(e!==undefined){i.push(o.requestProperty(e,n,a,g))}}return i},getIsActionCritical:async function(t,n){let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];let i=true;const s=A(t);const r=s.resolvePath(n);const l=r.target;if(!l){return i}const c=m(l,s);if(C(c)){i=v(c,false,undefined,true)}else if(o.length>0){i=new Promise(t=>{try{const e=new a({anyBoolean:x(c)});e.setModel(o[0].getModel());const n=e.getBinding("anyBoolean");const i=function(){const o=n.getExternalValue();e.destroy();t(o)};n.attachEventOnce("change",i);e.setBindingContext(o[0])}catch(o){const a=o instanceof Error?o.message:String(o);e.error(`FE : Actions : Error while resolving IsActionCritical for ${n} : ${a}`);t(true)}})}return i}};return $},false);
//# sourceMappingURL=ActionRuntime.js.map