/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/helpers/ConfigurableObject","../../helpers/TypeGuards","../ManifestSettings","../controls/Common/DataVisualization","../controls/Common/KPI","../helpers/ID"],function(t,e,n,i,a,o,r,s,l){"use strict";var c={};var u=l.getTableID;var f=l.getIconTabBarID;var d=l.getFilterVariantManagementID;var p=l.getFilterBarID;var y=l.getDynamicListReportID;var h=l.getCustomTabID;var m=l.getChartID;var g=s.getKPIDefinitions;var v=r.isSelectionPresentationCompliant;var C=r.isPresentationCompliant;var b=r.getSelectionVariant;var T=r.getSelectionPresentationVariant;var P=r.getDefaultLineItem;var w=r.getDefaultChart;var I=r.getDataVisualizationConfiguration;var V=o.VisualizationType;var S=o.VariantManagementType;var E=o.TemplateType;var M=a.isAnnotationOfType;var z=i.insertCustomElements;var D=n.getSelectionFields;var A=n.getManifestFilterFields;var F=n.getFilterBarHideBasicSearch;var L=e.getActionsFromManifest;var k=t.getExpressionFromAnnotation;var x=t.compileExpression;var B=function(t){t["Multi"]="Multi";t["Combined"]="Combined";t["Custom"]="Custom";t["Default"]="Default";return t}(B||{});var R=function(t){t["SingleTable"]="SingleTable";t["SingleChart"]="SingleChart";t["Combined"]="Combined";t["Custom"]="Custom";return t}(R||{});const H=function(t,e){return t.type===e};const W=function(t,e){return t.viewType===e};function $(t){const e=[];t.forEach(function(t){if(!W(t,R.Custom)){const n=W(t,R.Combined)?t.secondaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===V.Table){e.push(t)}})}});return e}function O(t){const e=[];t.forEach(function(t){if(!W(t,R.Custom)){const n=W(t,R.Combined)?t.primaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===V.Chart){e.push(t)}})}});return e}const j=function(t){const e={};for(const n in t){if(t[n]?.settings?.defaultValues?.length){e[n]=t[n]?.settings?.defaultValues}}return e};function U(t,e,n){const i=e.getManifestWrapper().getDefaultTemplateAnnotationPath();const a=T(t,i,e);const o="ALP flavor needs both chart and table to load the application";if(a){if(i){const t=a.PresentationVariant;if(!t){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest")}if(!C(t,n)){if(n){throw new Error(o)}return undefined}}if(v(a,n)===true){return a}else if(n){throw new Error(o)}}const r=t.annotations?.UI?.PresentationVariant;if(r){if(C(r,n)){return r}else if(n){throw new Error(o)}}if(!n){return P(t)}return undefined}const N=function(t,e,n){const i=K(t[0],true);const a=K(t[1]?t[1]:t[0],false);if(i&&a){const t={primaryVisualization:i,secondaryVisualization:a,tableControlId:a.visualizations[0]?.type===V.Table?a.visualizations[0].annotation?.id:"",chartControlId:i.visualizations[0]?.type===V.Chart?i.visualizations[0].id:"",defaultPath:e,viewType:R.Combined,visible:H(n,B.Multi)?n.visible:undefined};return t}};const Q=function(t,e,n){const i=X(e,V.Table)?.annotation.id;const a={presentation:e,title:Y(t,n),selectionVariantPath:Z(n),visible:H(n,B.Multi)?n.visible:undefined};if(i){return{...a,...{tableControlId:i,viewType:R.SingleTable}}}return{...a,...{chartControlId:X(e,V.Chart)?.id,viewType:R.SingleChart}}};const K=function(t,e){const n=Object.assign({},t);const i=t.visualizations.find(t=>!!e&&t.type===V.Chart||!e&&t.type===V.Table);if(i){n.visualizations=[i]}else{const t=e?{visualization:"Primary",type:"chart"}:{visualization:"Secondary",type:"table"};throw new Error(`${t.visualization} visualization needs valid ${t.type}`)}return n};const q=function(t,e,n){const i=t.getEntityTypeAnnotation(e.annotationPath);const a=i.annotation;t=i.converterContext;const o=a;if(o||t.getTemplateType()===E.AnalyticalListPage){return I(o?t.getRelativeAnnotationPath(o.fullyQualifiedName,t.getEntityType()):"",t,{isCondensedTableLayoutCompliant:true,shouldCreateTemplateChartVisualization:true})}else{throw new Error(`Annotation Path for the ${n?"primary":"secondary"} visualization mentioned in the manifest is not found`)}};const G=function(t,e){for(const n of t.visualizations){switch(n.type){case V.Table:const t=n.control.filters||{};t.hiddenFilters=t.hiddenFilters||{paths:[]};if(!e.keepPreviousPersonalization){n.annotation.id=u(e.key??"","LineItem")}break;case V.Chart:n.id=m(e.key||"","Chart");n.multiViews=true;break;default:break}}};const J=function(t){return{title:t.label,fragment:t.template,type:t.type,customTabId:h(t.key??""),visible:t.visible,viewType:R.Custom}};const X=function(t,e){return t.visualizations.find(t=>t.type===e)};const Y=function(t,e){if(H(e,B.Multi)){const n=t.getEntityTypeAnnotation(e.annotationPath).annotation;return x(k(n.Text))}return""};const Z=function(t){if(H(t,B.Multi)){return t.annotation&&M(t.annotation,"com.sap.vocabularies.UI.v1.SelectionPresentationVariantType")?`@${t.annotation.SelectionVariant?.fullyQualifiedName.split("@")[1]}`:t.annotationPath}return undefined};const _=function(t){if(!H(t,B.Custom)){return!H(t,B.Combined)&&t.annotation?t.converterContext.getRelativeAnnotationPath(t.annotation.fullyQualifiedName,t.converterContext.getEntityType()):""}return""};const tt=function(t){if(!H(t,B.Custom)){const e=t.converterContext;const n=H(t,B.Multi)?{associatedSelectionVariant:t.selectionVariant,isMacroOrMultipleView:true}:{};const i=I(_(t),e,{...{isCondensedTableLayoutCompliant:true},...n});if(!H(t,B.Combined)&&i.visualizations.length===2&&e.getTemplateType()===E.AnalyticalListPage){const e=N([i],"both",t);if(e){return e}}else if(H(t,B.Combined)){const{primary:n,secondary:i}=t;if(n?.length&&i?.length){const a=N([q(e,n[0],true),q(e,i[0],false)],t.defaultPath,t);if(a){return a}}else if(e.getTemplateType()===E.AnalyticalListPage){throw new Error("SecondaryItems in the Views is not present")}}else if(H(t,B.Multi)){G(i,t)}const a=Q(e,i,t);a.presentation.inMultiView=!!n.isMacroOrMultipleView;return a}else{return J(t)}};const et=function(t,e){let n=[];const i=t.getManifestWrapper();if(e){e.paths.forEach(a=>{if(i.isCombinedViewConfiguration(a)){if(e.paths.length>1){throw new Error("ALP flavor cannot have multiple views")}else{n.push({converterContext:t,primary:a.primary,secondary:a.secondary,defaultPath:a.defaultPath,type:B.Combined})}}else if(i.isCustomViewConfiguration(a)){n.push({key:a.key,label:a.label,template:a.template,type:B.Custom,visible:a.visible})}else{const e=t.getConverterContextFor(a.contextPath||a.entitySet&&`/${a.entitySet}`||t.getContextPath()),i=e.getEntityType();if(i&&e){let t;const o=e.getEntityTypeAnnotation(a.annotationPath);const r=o.annotation;if(r){t=r.term==="com.sap.vocabularies.UI.v1.SelectionVariant"?U(i,e,false):r;n.push({selectionVariant:r.term==="com.sap.vocabularies.UI.v1.SelectionVariant"?r:undefined,converterContext:e,annotation:t,annotationPath:a.annotationPath,keepPreviousPersonalization:a.keepPreviousPersonalization,key:a.key,visible:a.visible,type:B.Multi})}}else{}}})}else{const e=t.getEntityType();if(t.getTemplateType()===E.AnalyticalListPage){n=it(t,n)}else{n.push({annotation:U(e,t,false),converterContext:t,type:B.Default})}}return n.map(t=>tt(t))};const nt=function(t,e){const n=t.getManifestWrapper();const i=n.getViewConfiguration();if(e.length>1&&!at(t)){return{showTabCounts:i?i.showCounts??n.hasMultipleEntitySets():undefined,id:f()}}return undefined};function it(t,e){const n=t.getEntityType();const i=U(n,t,true);let a,o;if(i){e.push({annotation:i,converterContext:t,type:B.Default})}else{a=w(n);o=P(n);if(a&&o){const n=[{annotationPath:"@"+a.term}];const i=[{annotationPath:"@"+o.term}];e.push({converterContext:t,primary:n,secondary:i,defaultPath:"both",type:B.Combined})}else{throw new Error("ALP flavor needs both chart and table to load the application")}}return e}function at(t){return t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===E.AnalyticalListPage}const ot=function(t){const e=t.getManifestWrapper();return z([],L(e.getHeaderActions(),t).actions)};c.getHeaderActions=ot;const rt=function(t,e){t.forEach(t=>{if(!W(t,R.Custom)&&!W(t,R.Combined)){t.presentation.visualizations.forEach(t=>{if(t.type===V.Chart&&t.filterId!==e){t.filterId=e}})}})};const st=function(t,e){const n=t.getEntityType();const i=t.getContextPath();if(!i){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.")}const a=t.getManifestWrapper();const o=a.getViewConfiguration();const r=a.hasMultipleEntitySets();const s=et(t,o);const l=$(s);const c=O(s);const u=l.some(t=>t.control.type==="ResponsiveTable");let f="";let h="";const m=y();const v=p(i);const C=d(v);const T=a.getFilterConfiguration();const P=T?.initialLayout!==undefined?T?.initialLayout.toLowerCase():"compact";const w=T?.layout!==undefined?T?.layout.toLowerCase():"compact";const I=T.useSemanticDateRange!==undefined?T.useSemanticDateRange:true;const V=T.showClearButton!==undefined?T.showClearButton:false;const E=lt(s);if(E){h=E.chartId;f=E.tableId}const M=a.useHiddenFilterBar();const z=(a.isFilterBarHidden()||M)&&h==="";const L=D(t,l);const k=L.selectionFields;const x=L.sPropertyInfo;const B=F(l,c,t);const R=nt(t,s);const H=R?undefined:b(n,t);const W=I?j(A(n,t)):{};const U=ot(t);if(r){rt(s,v)}const N=l.map(t=>t.annotation.apiId).concat(c.map(t=>t.apiId));const Q=[...z&&!M?[]:[v],...a.getVariantManagement()!==S.Control?N:[],...R?[R.id]:[]];const K=R&&a.getStickyMultiTabHeaderConfiguration()?R.id:undefined;const q=l.every(t=>t.control.type==="TreeTable"||t.enableAnalytics||t.annotation.collection!==i);return{mainEntitySet:i,mainEntityType:`${i}/`,multiViewsControl:R,stickySubheaderProvider:K,singleTableId:f,singleChartId:h,dynamicListReportId:m,headerActions:U,easyFilterEnabled:!z&&e?.MagicFiltering,showPinnableToggle:u,filterBar:{propertyInfo:x,selectionFields:k,hideBasicSearch:B,showClearButton:V,disableDraftEditStateFilter:q},views:s,filterBarId:z&&!M?"":v,filterConditions:{selectionVariant:H,defaultSemanticDates:W},variantManagement:{id:C,targetControlIds:Q.join(",")},hasMultiVisualizations:at(t),templateType:a.getTemplateType(),useSemanticDateRange:I,filterInitialLayout:P,filterLayout:w,kpiDefinitions:g(t),hideFilterBar:z,useHiddenFilterBar:M}};c.convertPage=st;function lt(t){const e=t.find(t=>(W(t,R.Combined)||W(t,R.SingleTable))&&!!t.tableControlId)?.tableControlId??"",n=t.find(t=>(W(t,R.Combined)||W(t,R.SingleChart))&&!!t.chartControlId)?.chartControlId??"";if(e||n){return{chartId:n,tableId:e}}return undefined}return c},false);
//# sourceMappingURL=ListReportConverter.js.map