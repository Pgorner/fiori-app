/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/DataVisualization","sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/ListReport/VisualFilters","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","sap/m/library"],function(t,e,n,i,o,a,r,s,l,c,u){"use strict";var p={};var f=u.StandardDynamicDateRangeKeys;var d=c.getAssociatedUnitPropertyPath;var g=c.getAssociatedTimezonePropertyPath;var y=c.getAssociatedTextPropertyPath;var h=c.getAssociatedCurrencyPropertyPath;var v=l.getTargetNavigationPath;var m=l.getRelativePaths;var P=l.enhanceDataModelPath;var b=s.isNavigationProperty;var F=s.isMultipleNavigationProperty;var S=s.isEntitySet;var T=s.isComplexType;var D=a.KeyHelper;var E=o.IssueType;var C=o.IssueSeverity;var x=o.IssueCategory;var O=i.insertCustomElements;var I=i.Placement;var A=i.OverrideType;var R=n.getVisualFilters;var N=e.isFilteringCaseSensitive;var M=e.getTypeConfig;var U=e.getSelectionVariantConfiguration;var w=t.getSelectionVariant;var $=function(t){t["Default"]="Default";t["Slot"]="Slot";return t}($||{});const L="Edm.String";const j="sap.ui.model.odata.type.String";function k(t){const e={};t.Data.forEach(n=>{if(n.$Type==="com.sap.vocabularies.UI.v1.DataField"){e[n.Value.path]={group:t.fullyQualifiedName,groupLabel:t.Label?.toString()??t.annotations?.Common?.Label?.toString()??t.qualifier}}});return e}function V(t,e){const n=new Set;const i=e.getManifestWrapper().getFilterConfiguration().filterFields??{};const o=new Set([...(e.getDataModelObjectPath().targetEntityType?.annotations?.UI?.SelectionFields??[]).map(t=>t.value),...Object.keys(i).filter(t=>!!i[t].template)]);return new Set(t.map(t=>{const i=t.control.filters;if(!i){return[]}return[...i.hiddenFilters?.paths??[],...i.quickFilters?.paths??[]].map(t=>{const i=t.annotationPath;if(!n.has(i)){n.add(i);const t=U(i,e);if(t){t.propertyNames=t.propertyNames.filter(t=>!o.has(t));return t.propertyNames}}return[]})}).flat(2))}const q=function(t,e){const n=e.split("/");let i;let o="";while(n.length){let e=n.shift();i=i?`${i}/${e}`:e;const a=t.resolvePath(i);if(F(a)){e+="*"}o=o?`${o}/${e}`:e}return o};const H=function(t,e,n,i,o){if(e&&e.targetType===undefined&&(i||e.annotations?.UI?.Hidden?.valueOf()!==true)){const i=o.getAnnotationEntityType(e),a={key:D.getSelectionFieldKeyFromPath(n),annotationPath:o.getAbsoluteAnnotationPath(n),conditionPath:q(t,n),availability:e.annotations?.UI?.HiddenFilter?.valueOf()===true?"Hidden":"Adaptation",label:e.annotations.Common?.Label?.toString()??e.name,group:i.name,groupLabel:i?.annotations?.Common?.Label?.toString()??i.name};W(a);return a}return undefined};const W=function(t){if(t.key==="DraftAdministrativeData::CreationDateTime"||t.key==="DraftAdministrativeData::LastChangeDateTime"){const e=[f.TO,f.TOMORROW,f.NEXTWEEK,f.NEXTMONTH,f.NEXTQUARTER,f.NEXTYEAR];t.settings={operatorConfiguration:[{path:"key",equals:e.join(","),exclude:true}]}}};const B=function(t,e,n,i,o){const a={};if(n){n.forEach(n=>{const r=n.name;const s=(e?`${e}/`:"")+r;const l=H(t,n,s,i,o);if(l){a[s]=l}})}return a};const K=function(t,e,n,i){let o={};if(e){e.forEach(e=>{let a={};const r=P(i.getDataModelObjectPath(),e);const s=r.targetObject;if(s===undefined||!n&&r.navigationProperties.find(t=>t.annotations?.UI?.Hidden?.valueOf()===true)){return}if(b(s)){a=B(t,e,s.targetType.entityProperties,n,i)}else if(T(s.targetType)){a=B(t,e,s.targetType.properties,n,i)}else{a=B(t,v(r,true),[s],n,i)}o={...o,...a}})}return o};const G=function(t,e,n,i){let o=t[e];if(o){delete t[e]}else{o=H(i,i.resolvePath(e),e,true,n)}if(!o){n.getDiagnostics()?.addIssue(x.Annotation,C.High,E.MISSING_SELECTIONFIELD)}if(o){o.availability=o.availability==="Hidden"?"Hidden":"Default";o.isParameter=!!i.annotations?.Common?.ResultContext}return o};const X=function(t,e,n,i,o){const a=[];const r={};const s=e.entityProperties;o?.forEach(t=>{r[t.value]=true});if(t&&t.length>0){t?.forEach(t=>{const r=t.PropertyName;const s=r?.value;const l={};o?.forEach(t=>{l[t.value]=true});if(s&&!i.has(s)){if(!(s in l)){const t=_(s,n,e);if(t){a.push(t)}}}})}else if(s){s.forEach(t=>{const o=t.annotations?.Common?.FilterDefaultValue;const s=t.name;if(!(s in i)){if(o&&!(s in r)){const t=_(s,n,e);if(t){a.push(t)}}}})}return a};function J(t){const e=t.getDataModelObjectPath();const n=e.startingEntitySet.entityType;const i=!!n.annotations?.Common?.ResultContext&&!e.targetEntitySet;const o=i&&t.getConverterContextFor(`/${e.startingEntitySet.name}`);return o?n.entityProperties.map(function(t){return G({},t.name,o,n)}):[]}const z=function(t,e,n){const i=e.length===0||e.every(t=>!t.applySupported.enableSearch);const o=t.length===0||t.every(t=>(t.enableAnalytics||t.control.type==="TreeTable")&&!t.enableBasicSearch);const a=n.getContextPath();if(a&&i&&o){return true}else{return false}};p.getFilterBarHideBasicSearch=z;const Q=function(t,e,n){const i=e.getManifestWrapper();const o=i.getContextPath()||(i.getEntitySet()?`/${i.getEntitySet()}`:undefined);const a=Y(e,o,n);let r={};r=i.getFilterConfiguration(a);const s=r?.filterFields||{};const l=K(t,Object.keys(s).map(t=>s[t].property??D.getPathFromSelectionFieldKey(t)),true,e);const c={};for(const n in s){const i=s[n];const o=i.property??D.getPathFromSelectionFieldKey(n);const a=l[o];const r=i.type==="Slot"?$.Slot:$.Default;const u=i&&i?.visualFilter?R(t,e,n,s):undefined;if(i.template||i.type===$.Slot){if(i.settings){i.settings.isCustomFilter=true}else{i.settings={isCustomFilter:true}}}c[n]={key:n,type:r,slotName:i?.slotName||n,annotationPath:a?.annotationPath,conditionPath:i.property?D.getPathFromSelectionFieldKey(n):a?.conditionPath||o,documentRefText:i.property&&e.fetchTextFromMetaModel("{metaModel>"+i.property+"@com.sap.vocabularies.Common.v1.DocumentationRef}"),template:i.template,label:e.fetchTextFromMetaModel(i.label),position:i.position||{placement:I.After},availability:i.availability||"Default",settings:i.settings,visualFilter:u,required:i.required}}return c};p.getManifestFilterFields=Q;const Y=function(t,e,n){let i;const o=t.getContextPath();const a=`${o}/${n}`;if(e&&a?.startsWith(e)&&n){i=a.replace(`${e}/`,"")}else{i=n}return i?i:undefined};const _=function(t,e,n){return G({},t,e,n)};p.getFilterField=_;const Z=function(t,e){let n=[];if(t&&t[e]){n=t[e].map(function(t){return t.value})}return n};p.getFilterRestrictions=Z;const tt=function(t){const e={};if(t&&t.FilterExpressionRestrictions){t.FilterExpressionRestrictions.forEach(function(t){if(t.Property?.value&&t.AllowedExpressions){if(e[t.Property?.value]){e[t.Property?.value].push(t.AllowedExpressions.toString())}else{e[t.Property?.value]=[t.AllowedExpressions.toString()]}}})}return e};p.getFilterAllowedExpression=tt;const et=function(){return{name:"$search",path:"$search",dataType:j,maxConditions:1}};const nt=function(){return{name:"$editState",path:"$editState",groupLabel:"",group:"",dataType:j,hiddenFilter:false}};const it=function(t){const e=t.getEntitySet();return S(e)?e.annotations.Capabilities?.SearchRestrictions:undefined};const ot=function(t,e){const n=t.getEntitySet()?.annotations?.Capabilities?.NavigationRestrictions;const i=n&&n.RestrictedProperties;return i&&i.find(function(t){return t&&t.NavigationProperty&&t.NavigationProperty.value===e})};p.getNavigationRestrictions=ot;const at=function(t){return{key:t.key,annotationPath:t.annotationPath,conditionPath:t.conditionPath,name:t.conditionPath,label:t.label,hiddenFilter:t.availability==="Hidden",display:"Value",isParameter:t.isParameter,caseSensitive:t.caseSensitive,availability:t.availability,position:t.position,type:t.type,template:t.template,menu:t.menu,required:t.required,isCustomFilter:t.settings?.isCustomFilter}};const rt=function(t,e){t.forEach(t=>{if(e.hasOwnProperty(t.key)&&!e[t.key].label){e[t.key].label=t.label}})};const st=function(t){const e=["SingleValue","MultiValue","SingleRange","MultiRange","SearchExpression","MultiRangeOrSearchExpression"];t.sort(function(t,n){return e.indexOf(t)-e.indexOf(n)});return t[0]};p.getSpecificAllowedExpression=st;const lt=function(t,e){const n=t?.Common?.Text,i=n&&(t&&t?.Common?.Text?.annotations?.UI?.TextArrangement||e&&e?.UI?.TextArrangement);if(i){if(i.valueOf()==="UI.TextArrangementType/TextOnly"){return"Description"}else if(i.valueOf()==="UI.TextArrangementType/TextLast"){return"ValueDescription"}return"DescriptionValue"}return n?"DescriptionValue":"Value"};p.displayMode=lt;const ct=function(t,e,n){let i=at(e);const o=e.annotationPath;if(!o){return i}const a=t.getConverterContextFor(o).getDataModelObjectPath().targetObject;const r=a?.annotations;const s=t?.getDataModelObjectPath().targetObject?.annotations;const l=n.formatOptions;const c=n.constraints;i=Object.assign(i,{formatOptions:l,constraints:c,display:lt(r,s)});return i};p.fetchPropertyInfo=ct;const ut=function(t){let e=true;switch(t.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":e=false;break;default:break}if(t.type&&t.type.indexOf("Boolean")>0){e=false}return e};p.isMultiValue=ut;const pt=function(t){return(t.$Type==="com.sap.vocabularies.UI.v1.DataField"||t.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"||t.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath")&&t.Value.path?.includes("/")};const ft=function(t,e,n){const i=t.Value?.$target;if(i){const t=y(i)||h(i)||d(i)||g(i);const o=t?P(e.getDataModelObjectPath(),t).navigationProperties:undefined;if(o?.length){const t=o[0].name;if(!n.includes(t)){n.push(t)}}}};const dt=function(t,e,n){switch(e.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":if(e.Target?.$target?.$Type==="com.sap.vocabularies.UI.v1.FieldGroupType"){e.Target.$target.Data?.forEach(e=>{dt(t,e,n)})}break;case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":if(pt(e)){const i=m(P(n.getDataModelObjectPath(),e.Value.path),true).join("/");if(!t.includes(i)){t.push(i)}}ft(e,n,t);break;default:break}return t};const gt=function(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;let o=arguments.length>4?arguments[4]:undefined;const a=V(e,t);const s=t.getEntityType();const l=n&&t.getEntityTypeAnnotation(n)?.annotation||s.annotations?.UI?.SelectionFields||[];let c=[];if(e.length===0&&!!o){t.getEntityTypeAnnotation(o).annotation?.forEach(e=>{c=dt(c,e,t)})}if(r.isDraftRoot(t.getEntitySet())){c.push("DraftAdministrativeData/CreationDateTime","DraftAdministrativeData/CreatedByUser","DraftAdministrativeData/LastChangeDateTime","DraftAdministrativeData/LastChangedByUser")}const u={...B(s,"",s.entityProperties,i,t),...K(s,c,false,t),...K(s,t.getManifestWrapper().getFilterConfiguration().navigationProperties,i,t)};let p=[];const f=w(s,t);if(f){p=f.SelectOptions}const d=l?.reduce((e,i)=>{const o=i.value;if(!a.has(o)){let i;if(n?.startsWith("@com.sap.vocabularies.UI.v1.SelectionFields")){i=""}else{i=n?.split("/@com.sap.vocabularies.UI.v1.SelectionFields")[0]}const a=i?i+"/"+o:o;const r=G(u,a,t,s);if(r){r.group="";r.groupLabel="";e.push(r)}}return e},[])||[];const g=X(p,s,t,a,l);return{excludedFilterProperties:a,entityType:s,annotatedSelectionFields:l,filterFields:u,propertyInfoFields:d,defaultFilterFields:g}};const yt=function(t){const e=M(t,t?.type);if(t?.type===L&&(e.constraints.nullable===undefined||e.constraints.nullable===true)){e.formatOptions.parseKeepsEmptyString=false}return e};p.fetchTypeConfig=yt;const ht=function(t,e,n,i){let o=ct(e,t,i[t.key]),a="";if(t.conditionPath){a=t.conditionPath.replace(/\+|\*/g,"")}if(o){o=Object.assign(o,{maxConditions:!o.isParameter&&ut(o)?-1:1,required:t.required??(o.isParameter||n.includes(a)),caseSensitive:N(e),dataType:i[t.key].type})}return o};p.assignDataTypeToPropertyInfo=ht;const vt=function(t,e,n){const i={};if(n){t=t.concat(n)}t.forEach(function(t){if(t.annotationPath){const n=e.getConverterContextFor(t.annotationPath);const o=n.getDataModelObjectPath().targetObject;const a=yt(o);i[t.key]=a}else{i[t.key]={type:j}}});const o=e.getEntitySet();const a=S(o)?o.annotations.Capabilities?.FilterRestrictions:undefined;const s={};s.RequiredProperties=Z(a,"RequiredProperties")||[];s.NonFilterableProperties=Z(a,"NonFilterableProperties")||[];s.FilterAllowedExpressions=tt(a);const l=e.getContextPath();const c=l.split("/");if(c.length>2){const t=c[c.length-1];c.splice(-1,1);const n=ot(e,t);const i=n&&n.FilterRestrictions;s.RequiredProperties=s.RequiredProperties.concat(Z(i,"RequiredProperties")||[]);s.NonFilterableProperties=s.NonFilterableProperties.concat(Z(i,"NonFilterableProperties")||[]);s.FilterAllowedExpressions={...tt(i)||{},...s.FilterAllowedExpressions}}const u=s.RequiredProperties;const p=s.NonFilterableProperties;const f=[];t.forEach(function(t){const n=t.conditionPath.replace(/[+*]/g,"");if(!p.includes(n)){const n=ht(t,e,u,i);f.push(n)}});const d=e.getDataModelObjectPath();if(r.isObjectPathDraftSupported(d)){f.push(nt())}const g=it(e);const y=Boolean(g&&!g.Searchable);if(l&&y!==true){if(!g||g?.Searchable){f.push(et())}}return f};p.processSelectionFields=vt;const mt=function(t,e,n,i){const o=Q(e,n,i);rt(t,o);return O(t,o,{availability:A.overwrite,label:A.overwrite,type:A.overwrite,position:A.overwrite,slotName:A.overwrite,documentRefText:A.overwrite,template:A.overwrite,settings:A.overwrite,visualFilter:A.overwrite,required:A.overwrite})};p.insertCustomManifestElements=mt;const Pt=t=>{t.sort(function(t,e){const n=t.groupLabel!==undefined&&t.groupLabel!==null;const i=e.groupLabel!==undefined&&e.groupLabel!==null;if(!n&&!i){return 0}if(n&&!i){return-1}if(!n&&i){return 1}return t.groupLabel.localeCompare(e.groupLabel)})};p.sortPropertyInfosByGroupLabel=Pt;const bt=function(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let i=arguments.length>3?arguments[3]:undefined;let o=arguments.length>4?arguments[4]:undefined;const a=gt(t,e,n,i,o);const r=J(t);let s=a.propertyInfoFields;const l=a.entityType;s=r.concat(s);s=mt(s,l,t,n);const c=vt(s,t,a.defaultFilterFields);Pt(c);let u=JSON.stringify(c);u=u.replace(/\{/g,"\\{");u=u.replace(/\}/g,"\\}");const p=u;let f=JSON.parse(JSON.stringify(a.propertyInfoFields));f=r.concat(f);const d=a.excludedFilterProperties;const g=l?.annotations?.UI?.FilterFacets;let y={};const h=t.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.FieldGroup");if(g===undefined||g.length<0){for(const t in h){y={...y,...k(h[t])}}}else{y=g.reduce((t,e)=>{for(let n=0;n<e?.Target?.$target?.Data?.length;n++){t[e?.Target?.$target?.Data[n]?.Value?.path]={group:e?.ID?.toString(),groupLabel:e?.Label?.toString()}}return t},{})}const v=a.filterFields;const m=f.concat(Object.keys(v).filter(t=>!d.has(t)).map(t=>Object.assign(v[t],y[t])));const P=mt(m,l,t,n);const b=N(t);P.forEach(t=>{t.caseSensitive=b});return{selectionFields:P,sPropertyInfo:p}};p.getSelectionFields=bt;const Ft=function(t,e,n){const i=Z(e,"RequiredProperties");const o=it(t);const a=Boolean(o&&!o.Searchable);if(i.length>0||a||n?.FetchValues===2){return true}return false};p.getExpandFilterFields=Ft;return p},false);
//# sourceMappingURL=FilterBar.js.map