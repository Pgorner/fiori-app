/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/Placeholder","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/controllerextensions/routing/NavigationReason","sap/fe/core/helpers/AppStartupHelper","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ManifestHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/base/BindingParser","sap/ui/base/EventProvider","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/model/odata/v4/ODataUtils","sap/ui/util/openWindow","../converters/MetaModelConverter"],function(e,t,n,o,i,a,r,s,u,c,h,l,f,g,p,d,m,v){"use strict";var P,C,R,y,M,_,b;function L(e){return new Promise((t,n)=>{sap.ui.require([e],n=>{if(!(n&&n.__esModule)){n=n===null||!(typeof n==="object"&&e.endsWith("/library"))?{default:n}:n;Object.defineProperty(n,"__esModule",{value:true})}t(n)},e=>{n(e)})})}var x={};var T=u.getRouteTargetNames;var S=t.event;var w=t.defineUI5Class;function E(e,t,n,o){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(o):void 0})}function I(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,A(e,t)}function A(e,t){return A=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},A(e,t)}function H(e,t,n,o,i){var a={};return Object.keys(o).forEach(function(e){a[e]=o[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=n.slice().reverse().reduce(function(n,o){return o(e,t,n)||n},a),i&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(i):void 0,a.initializer=void 0),void 0===a.initializer?(Object.defineProperty(e,t,a),null):a}function O(e,t){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let F=(P=w("sap.fe.core.services.RoutingServiceEventing"),C=S(),R=S(),P(y=(M=function(e){function t(){var t;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++){o[i]=arguments[i]}t=e.call(this,...o)||this;E(t,"routeMatched",_,t);E(t,"afterRouteMatched",b,t);return t}I(t,e);return t}(f),_=H(M.prototype,"routeMatched",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),b=H(M.prototype,"afterRouteMatched",[R],{configurable:true,enumerable:true,writable:true,initializer:null}),M))||y);let k=function(t){function u(){var e;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++){o[i]=arguments[i]}e=t.call(this,...o)||this;e.navigationInfoQueue=[];e.enabled=false;return e}x.RoutingService=u;I(u,t);var f=u.prototype;f.init=function e(){const t=this.getContext();if(t.scopeType==="component"){this.oAppComponent=t.scopeObject;this.oModel=this.oAppComponent.getModel();this.oMetaModel=this.oModel?.getMetaModel();this.oRouter=this.oAppComponent.getRouter();this.oRouterProxy=this.oAppComponent.getRouterProxy();this.eventProvider=new F;const e=this.oAppComponent.getManifestEntry("sap.ui5").routing;this._parseRoutingConfiguration(e);const n=this.oAppComponent.getManifestEntry("sap.app");this.outbounds=n.crossNavigation?.outbounds??{}}this.initPromise=Promise.resolve(this)};f.beforeExit=function e(){this.enabled=false;this.oRouter.detachRouteMatched(this._fnOnRouteMatched,this);this.eventProvider.fireEvent("routeMatched",{})};f.exit=function e(){this.eventProvider.destroy()};f._parseRoutingConfiguration=function t(n){const o=n?.config?.routerClass==="sap.f.routing.Router";this._mTargets={};if(n?.targets){for(const e of Object.keys(n.targets)){this._mTargets[e]=Object.assign({targetName:e},n.targets[e]);const t=this._mTargets[e].contextPattern;if(t!==undefined){this._mTargets[e].viewLevel=this._getViewLevelFromPattern(t,0)}}}this._mRoutes={};if(n?.routes){for(const t of n.routes){const n=T(t.target),i=t.name,a=t.pattern;if(!a){continue}if(a.length<8||a.indexOf(":?query:")!==a.length-8){e.warning(`Pattern for route ${i} doesn't end with ':?query:' : ${a}`)}const r=this._getViewLevelFromPattern(a,0);this._mRoutes[i]={name:i,pattern:a,targets:n,routeLevel:r};for(const e of n){const t=this._mTargets[e].parent;if(t){n.push(t)}}if(!o){const e=this._mTargets[n[0]].viewLevel;if(e===undefined||e<r){this._mTargets[n[0]].viewLevel=r}this._mTargets[n[0]].FCLLevel=-1}else if(n.length===1&&this._mTargets[n[0]].controlAggregation!=="beginColumnPages"){this._mTargets[n[0]].FCLLevel=3}else{n.forEach(e=>{switch(this._mTargets[e].controlAggregation){case"beginColumnPages":this._mTargets[e].FCLLevel=0;break;case"midColumnPages":this._mTargets[e].FCLLevel=1;break;default:this._mTargets[e].FCLLevel=2}})}}}Object.keys(this._mTargets).forEach(e=>{let t=this._mTargets[e].parent;while(t){this._mTargets[t].viewLevel=this._mTargets[t].viewLevel||this._mTargets[e].viewLevel;this._mTargets[t].contextPattern=this._mTargets[t].contextPattern||this._mTargets[e].contextPattern;this._mTargets[t].FCLLevel=this._mTargets[t].FCLLevel||this._mTargets[e].FCLLevel;this._mTargets[t].controlAggregation=this._mTargets[t].controlAggregation||this._mTargets[e].controlAggregation;e=t;t=this._mTargets[e].parent}});const i=[];const a=[];let r;for(const e in this._mRoutes){const t=this._mRoutes[e].routeLevel;if(t===0){i.push(e)}else if(t===1){a.push(e)}}if(i.length===1){r=i[0]}else if(a.length===1){r=a[0]}if(r){const t=this._mRoutes[r].targets.slice(-1)[0];this.sContextPath="";const n=this._mTargets[t].options?.settings;if(n){this.sContextPath=n.contextPath||`/${n.entitySet}`}if(!this.sContextPath){e.warning(`Cannot determine default contextPath: contextPath or entitySet missing in default target: ${t}`)}}else{e.warning("Cannot determine default contextPath: no default route found.")}Object.keys(this._mTargets).map(e=>this._mTargets[e]).sort((e,t)=>e.viewLevel!==undefined&&t.viewLevel!==undefined&&e.viewLevel<t.viewLevel?-1:1).forEach(e=>{if(e.options){const t=e.options.settings;const n=t.contextPath||(t.entitySet?`/${t.entitySet}`:"");if(!t.fullContextPath&&n){t.fullContextPath=`${n}/`}Object.keys(t.navigation||{}).forEach(n=>{const o=this._mRoutes[t.navigation[n].detail?.route];if(o&&o.targets){o.targets.forEach(o=>{if(this._mTargets[o].options?.settings&&!this._mTargets[o].options?.settings?.fullContextPath){if(this._mTargets[o].options.settings.contextPath){this._mTargets[o].options.settings.fullContextPath=this._mTargets[o].options.settings.contextPath+"/"}else if(e.viewLevel===0){this._mTargets[o].options.settings.fullContextPath=`${(n.startsWith("/")?"":"/")+n}/`}else{this._mTargets[o].options.settings.fullContextPath=`${t.fullContextPath+n}/`}}})}})}})};f._getViewLevelFromPattern=function e(t,n){t=t.replace(":?query:","");const o=new RegExp("/[^/]*$");if(t&&t[0]!=="/"&&t[0]!=="?"){t=`/${t}`}if(t.length){t=t.replace(o,"");if(this.oRouter.match(t)||t===""){return this._getViewLevelFromPattern(t,++n)}else{return this._getViewLevelFromPattern(t,n)}}else{return n}};f._getRouteInformation=function e(t){if(t===undefined){return undefined}return this._mRoutes[t]};f._getTargetInformation=function e(t){if(t===undefined){return undefined}return this._mTargets[t]};f._getComponentId=function e(t,n){if(n.indexOf(`${t}---`)===0){return n.substring(t.length+3)}return n};f.getTargetInformationFor=function e(t){const n=this._getComponentId(t._sOwnerId,t.getId());let o;Object.keys(this._mTargets).forEach(e=>{if(this._mTargets[e].id===n||this._mTargets[e].viewId===n){o=e}});return this._getTargetInformation(o)};f.getLastSemanticMapping=function e(){return this.oLastSemanticMapping};f.setLastSemanticMapping=function e(t){this.oLastSemanticMapping=t};f.getHashFromRoute=async function e(t,n,o){if(!this.enabled){return Promise.resolve("")}let i;if(!o){i=Promise.resolve(h.getSemanticPath(t))}else{i=this.prepareParameters(o,n,t).then(e=>this.oRouter.getURL(n,e))}return await i};f.navigateTo=async function e(t,n,o,i,a){if(!this.enabled){return Promise.resolve()}let r,s;if(t.getModel()&&t.getModel().getMetaModel&&t.getModel().getMetaModel()){s=c.isStickySessionSupported(t.getModel().getMetaModel())}if(!o){r=Promise.resolve(h.getSemanticPath(t))}else{r=this.prepareParameters(o,n,t).then(e=>this.oRouter.getURL(n,e))}const u=await r;const l=()=>{this.oRouterProxy.navToHash(u,i,false,false,!s)};if(a===true){return l}else{return l()}};f.prepareParameters=async function t(n,o,i){let a;try{const e=i.getPath();const t=i.getModel().getMetaModel();const o=e.split("/");const r=Object.keys(n).map(async e=>{const a=n[e];const r=l.complexParser(a);const s=r.parts||[r];const u=s.map(async function(e){const n=e.path.split("../");const a=o.slice(0,o.length-n.length+1);const r=a.join("/");const s=r===i.getPath()?i:i.getModel().bindContext(r).getBoundContext();const u=t.getMetaContext(r+"/"+n[n.length-1]);return s.requestProperty(n[n.length-1]).then(function(e){const t=u.getObject();const n=t.$Type;return d.formatLiteral(e,n)})});return Promise.all(u).then(t=>{const n=r.formatter?r.formatter.apply(this,t):t.join("");return{key:e,value:n}})});a=Promise.all(r).then(function(e){const t={};e.forEach(function(e){t[e.key]=e.value});return t})}catch(t){e.error(`Could not parse the parameters for the navigation to route ${o}`);a=Promise.resolve({})}return a};f._fireRouteMatchEvents=function e(t){this.eventProvider.fireEvent("routeMatched",t);this.eventProvider.fireEvent("afterRouteMatched",t);s.cleanProcessedEditState()};f.navigateToContext=async function e(t){let n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};let o=arguments.length>2?arguments[2]:undefined;let a=arguments.length>3?arguments[3]:undefined;if(!this.enabled){return Promise.resolve(false)}let r="";let s;const u=c.isStickySessionSupported(this.oMetaModel);if(n?.targetPath&&o?.navigation){const e=o.navigation;const i=e[n.targetPath].detail;r=i.route;if(i.parameters&&t.isA("sap.ui.model.odata.v4.Context")){s=this.prepareParameters(i.parameters,r,t)}}let h=this._getPathFromContext(t,n);if(h.length===0&&this.bExitOnNavigateBackToRoot){this.oRouterProxy.exitFromApp();return Promise.resolve(true)}if(n?.createOnNavigateParameters){h+="(...)"}const l=this._calculateLayout(h,n);if(l){h+=`?layout=${l}`}const f={createOnNavigateParameters:n.createOnNavigateParameters,bTargetEditable:n?.editable,bPersistOPScroll:n?.persistOPScroll,bShowPlaceholder:n?.showPlaceholder!==undefined?n?.showPlaceholder:true,reason:n?.reason,redirectedToNonDraft:n.redirectedToNonDraft};if(n?.updateFCLLevel!==-1&&n?.recreateContext!==true){if(t.isA("sap.ui.model.odata.v4.Context")){f.useContext=t}}if(n?.checkNoHashChange){const e=this.oRouterProxy.getHash().replace(/[&?]{1}sap-iapp-state=[A-Z0-9]+/,"");if(h===e){const e=this.oRouter.getRouteInfoByHash(this.oRouterProxy.getHash());let t={config:{}};if(e){t={...e,config:{}};t.navigationInfo=f;t.routeInformation=this._getRouteInformation(this.sCurrentRouteName);t.routePattern=this.sCurrentRoutePattern;t.views=this.aCurrentViews}this.oRouterProxy.setFocusForced(!!n.forceFocus);this._fireRouteMatchEvents(t);return Promise.resolve(true)}}if(n?.transient&&!!n.editable&&!h.includes("(...)")){if(h.includes("?")){h+="&i-action=create"}else{h+="?i-action=create"}}if(n.navMode==="openInNewTab"){sap.ui.require(["sap/ushell/Container"],async e=>{const t=this.oAppComponent.getShellServices();const n=t.parseShellHash(document.location.hash);const o=await e.getServiceAsync("Navigation");const i=await o.getHref({target:{semanticObject:n.semanticObject,action:n.action}});const a=await t.getInframeUrl();let r,s;if(a){r=new URL(a);s=a.replace(r.hash,`${i}&/${encodeURI(h)}`)}else{r=new URL(window.location.href);s=`${r.origin}${r.pathname}${i}&/${encodeURI(h)}`}m(s)});return Promise.resolve(true)}else{if(a?.name==="sap.fe.templates.ListReport"){const e=this.oRouter.getRouteInfoByHash(h);if(e){const t=this._getRouteInformation(e.name);if(t&&t.targets&&t.targets.length>0){const e=t.targets[t.targets.length-1];const n=this._getTargetInformation(e);if(n&&n.name==="sap.fe.templates.ObjectPage"){i.removeUnboundTransitionMessages()}}}}this.navigationInfoQueue.push(f);if(r&&s){return s.then(e=>{Object.assign(e,{bIsStickyMode:u});this.oRouter.navTo(r,e);return true})}return this.oRouterProxy.navToHash(h,!!n.preserveHistory,n?.noPreservationCache,n?.forceFocus,!u).then(e=>{if(!e){this.navigationInfoQueue.pop()}return e})}};f.navigateToRoute=async function e(t,n){if(!this.enabled){return Promise.resolve(false)}this.setLastSemanticMapping(undefined);const o=this.oRouter.getURL(t,n);return this.oRouterProxy.navToHash(o,undefined,undefined,undefined,!n?.bIsStickyMode)};f.isCurrentStateImpactedBy=function e(t){const n=t.getPath();if(this.oRouterProxy.isCurrentStateImpactedBy(n)){return true}else if(/^[^()]+\([^()]+\)$/.test(n)){let e;if(this.oLastSemanticMapping&&this.oLastSemanticMapping.technicalPath===n){e=this.oLastSemanticMapping.semanticPath}else{e=h.getSemanticPath(t)}return e!=n?this.oRouterProxy.isCurrentStateImpactedBy(e):false}else{return false}};f._findPathToNavigate=function e(t){const n=new RegExp("/[^/]*$");t=t.replace(n,"");if(this.oRouter.match(t)||t===""){return t}else{return this._findPathToNavigate(t)}};f._checkIfContextSupportsSemanticPath=function e(t){if(!/^\/[^(]+\([^)]+\)$/.test(t.getPath())){return false}const n=t.getModel().getMetaModel();const o=v.getInvolvedDataModelObjects(n.getMetaContext(t.getPath())).targetObject;if(!c.isDraftRoot(o)){return false}if(t.getProperty("IsActiveEntity")===false&&t.getProperty("HasActiveEntity")===false){return false}const i=o.name;return h.getSemanticKeys(n,i)!==undefined};f._getPathFromContext=function e(t,n){let o="";if(t.isA("sap.ui.model.odata.v4.ODataListBinding")){o=t.getHeaderContext()?.getPath()??""}else{o=t.getPath();if(n.updateFCLLevel===-1){o=this._findPathToNavigate(o);if(this.oLastSemanticMapping?.technicalPath===o){o=this.oLastSemanticMapping.semanticPath}}else if(this._checkIfContextSupportsSemanticPath(t)){const e=h.getSemanticPath(t,true);if(!e){this.setLastSemanticMapping(undefined)}else if(e!==o){this.setLastSemanticMapping({technicalPath:o,semanticPath:e});o=e}}}if(o[0]==="/"){o=o.substring(1)}return o};f._calculateLayout=function e(t,n){if(n.navMode==="openInNewTab"&&n.FCLLevel!==-1){return n.FCLLevel===0?"MidColumnFullScreen":"EndColumnFullScreen"}let o=n.FCLLevel??0;if(n.updateFCLLevel){o+=n.updateFCLLevel;if(o<0){o=0}}if(n.updateFCLLevel!==undefined&&n.updateFCLLevel<0&&!n.layout){n.layout=this.oRouterProxy.findLayoutForHash(t)}return this.oAppComponent.getRootViewController().calculateLayout(o,t,n.layout,n.keepCurrentLayout)};f._beforeRouteMatched=function e(){const t=(new o).isPlaceholderEnabled();if(!t){const e=this.oAppComponent.getRootControl();n.lock(e)}};f._isNavigationTriggeredByRouterProxy=function e(){return history.state?.feLevel!==undefined};f._onRouteMatched=function t(i){const r=this.oAppComponent.getAppStateHandler(),s=this.oAppComponent.getRootControl();const u=(new o).isPlaceholderEnabled();if(n.isLocked(s)&&!u){n.unlock(s)}const c=i.getParameters();if(this.navigationInfoQueue.length){c.navigationInfo=this.navigationInfoQueue[0];this.navigationInfoQueue=this.navigationInfoQueue.slice(1)}else{c.navigationInfo={}}if(r.checkIfRouteChangedByIApp()){c.navigationInfo.reason=a.AppStateChanged;r.resetRouteChangedByIApp()}else if(this.oRouterProxy.checkRestoreHistoryWasTriggered()){c.navigationInfo.reason=a.RestoreHistory;this.oRouterProxy.resetRestoreHistoryFlag()}this.sCurrentRouteName=i.getParameter("name");this.sCurrentRoutePattern=c.config.pattern;this.aCurrentViews=i.getParameter("views");c.routeInformation=this._getRouteInformation(this.sCurrentRouteName);c.routePattern=this.sCurrentRoutePattern;this._fireRouteMatchEvents(c);if(!this._isNavigationTriggeredByRouterProxy()){this.oRouterProxy.restoreHistory().then(()=>{this.oRouterProxy.resolveRouteMatch();return}).catch(function(t){e.error("Error while restoring history",t)})}else{this.oRouterProxy.resolveRouteMatch()}};f.attachRouteMatched=function e(t,n,o){this.eventProvider.attachEvent("routeMatched",t,n,o)};f.detachRouteMatched=function e(t,n){this.eventProvider.detachEvent("routeMatched",t,n)};f.attachAfterRouteMatched=function e(t,n,o){this.eventProvider.attachEvent("afterRouteMatched",t,n,o)};f.detachAfterRouteMatched=function e(t,n){this.eventProvider.detachEvent("afterRouteMatched",t,n)};f.initializeRouting=async function e(){this.enabled=true;if(this.oAppComponent.getEnvironmentCapabilities().getCapabilities().Collaboration){const{default:e}=await L("sap/suite/ui/commons/collaboration/CollaborationHelper");await e.processAndExpandHash()}this._fnOnRouteMatched=this._onRouteMatched.bind(this);this.oRouter.attachRouteMatched(this._fnOnRouteMatched,this);const t=(new o).isPlaceholderEnabled();if(!t){this.oRouter.attachBeforeRouteMatched(this._beforeRouteMatched.bind(this))}this.navigationInfoQueue=[];s.resetEditState();this.bExitOnNavigateBackToRoot=!this.oRouter.match("");await this.manageStartupMode()};f.onRestore=function e(){this.manageStartupMode()};f.manageStartupMode=async function t(){const n=this.oRouter.getHashChanger().getHash().includes("sap-iapp-state");try{const e=await this.oAppComponent.getStartupParameters();const t=e!==undefined&&Object.keys(e).length!==0;const o=this.oRouter.getHashChanger().getHash();if(!n&&t&&!o){if(e.preferredMode&&e.preferredMode[0].toUpperCase().includes("CREATE")){await this._manageCreateStartup(e)}else{await this._manageDeepLinkStartup(e)}}await this._managedPreferredModeEdit(e)}catch(t){e.error("Error during routing initialization",t)}};f.getDefaultCreateHash=function e(t){return r.getDefaultCreateHash(t,this.getContextPath(),this.oRouter)};f._manageCreateStartup=async function e(t){return r.getCreateStartupHash(t,this.getContextPath(),this.oRouter,this.oMetaModel).then(e=>{if(e){this.oRouter.getHashChanger().replaceHash(e);if(t?.preferredMode&&t.preferredMode[0].toUpperCase().includes("AUTOCREATE")){this.oAppComponent.setStartupModeAutoCreate()}else{this.oAppComponent.setStartupModeCreate()}this.bExitOnNavigateBackToRoot=true}return})};f._manageDeepLinkStartup=async function e(t){return r.getDeepLinkStartupHash(this.oAppComponent.getManifestEntry("sap.ui5").routing,t,this.oModel).then(e=>{let t;if(e.context){const n=e.context.getPath();const o=this._checkIfContextSupportsSemanticPath(e.context)?h.getSemanticPath(e.context,false):n;if(o!==n){this.setLastSemanticMapping({technicalPath:n,semanticPath:o})}t=o.substring(1)}else if(e.hash){t=e.hash}if(t){this.oRouter.getHashChanger().replaceHash(t);this.oAppComponent.setStartupModeDeeplink()}return})};f._managedPreferredModeEdit=async function e(t){const n=this.oRouter.getHashChanger().getHash();const o=!!t.preferredMode?.[0]?.toUpperCase()?.includes("EDIT");const i=await r.verifyEditAnnotations(this.getContextPath(),this.oMetaModel);if(n&&o&&i){const e=(n.includes("?")?"&":"?")+"i-action=edit";this.oRouter.getHashChanger().replaceHash(n+e)}};f.getOutbounds=function e(){return this.outbounds};f.getContextPath=function e(){return this.sContextPath};f.getInterface=function e(){return this};return u}(g);x.RoutingService=k;let j=function(e){function t(){return e.apply(this,arguments)||this}I(t,e);var n=t.prototype;n.createInstance=async function e(t){const n=new k(t);return n.initPromise};return t}(p);return j},false);
//# sourceMappingURL=RoutingServiceFactory.js.map