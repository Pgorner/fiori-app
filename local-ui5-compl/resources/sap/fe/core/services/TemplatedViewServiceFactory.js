/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/fe/core/CommonUtils","sap/fe/core/TemplateModel","sap/fe/core/converters/ManifestSettings","sap/fe/core/definition/FEDefinition","sap/fe/core/helpers/LoaderUtils","sap/fe/core/helpers/ModelHelper","sap/fe/core/manifestMerger/ChangePageConfiguration","sap/ui/Device","sap/ui/VersionInfo","sap/ui/core/Core","sap/ui/core/mvc/View","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/json/JSONModel","../helpers/DynamicAnnotationPathHelper"],function(e,t,n,o,i,r,s,a,c,l,u,g,p,f,d,h,v,m){"use strict";var C=m.resolveDynamicExpression;var y=c.applyPageConfigurationChanges;var w=s.requireDependencies;var b=r.DefinitionContext;var M=i.TemplateType;function V(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,I(e,t)}function I(e,t){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},I(e,t)}let P=function(i){function r(){return i.apply(this,arguments)||this}V(r,i);var s=r.prototype;s.init=function e(){const o=[];const i=this.getContext();const r=i.scopeObject;const s=n.getAppComponent(r);const a=s.getMetaModel();this.pageId=s.getLocalId(r.getId());const c=`${s.getMetadata().getComponentName()}::${this.pageId}`;const l=r.getEnhanceI18n()||[];let p;this.oFactory=i.factory;if(l){p=s.getMetadata().getComponentName();for(let e=0;e<l.length;e++){const t=s.getModel(l[e]);if(t&&t.isA("sap.ui.model.resource.ResourceModel")){l[e]=t}else{l[e]=`${p}.${l[e].replace(".properties","")}`}}}const f=`${s.getMetadata().getName()}_${c}_${t.getLanguageTag()}`;o.push(h.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:r,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.macros.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:l,modelName:"sap.fe.i18n"}}).then(e=>{this.oResourceModelService=e;return e.getResourceModel()}));o.push(h.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:a,appComponent:s,component:r}}).then(async e=>{this.oCacheHandlerService=e;return e.validateCacheKey(f,r,s.getEnvironmentCapabilities())}));o.push(u.load().then(function(e){let t="";if(!e.libraries){t=g?.buildinfo?.buildtime??"<NOVALUE>"}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(){return"<NOVALUE>"}));this.initPromise=Promise.all(o).then(async e=>{const t=e[0];const n=e[1];const[o,i]=await w(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"]);return this.createView(t,c,n,o,i)}).then(function(e){const t=h.get("sap.fe.core.services.CacheHandlerService").getInstance(a);t.invalidateIfNeeded(e,f,r,s.getEnvironmentCapabilities());return})};s.refreshView=async function t(n){const o=n.getRootControl();if(o){o.destroy()}else if(this.oView){this.oView.destroy()}return this.createView(this.resourceModel,this.stableId,"",this.TemplateConverter,this.MetaModelConverter).then(function(){n.getUIArea().invalidate();return}).catch(function(t){n.getUIArea().invalidate();e.error(t)})};s._getViewSettings=function e(t,n,o,i,r,s,a){let c=n.viewType||o.getViewType()||"XML";if(c!=="XML"){c=undefined}return{type:c,preprocessors:{xml:t,controls:{}},id:i.stableId,viewName:n.viewName||o.getViewName?.(),viewData:i,cache:{keys:[r],additionalData:{getAdditionalCacheData:()=>s.getData(),setAdditionalCacheData:e=>{s.setData(e)}}},models:{"sap.fe.i18n":a},height:"100%"}};s._createErrorPage=async function t(n,o,i,r,s){e.error(n.message,n);o.viewName=i;if(o.preprocessors){o.preprocessors.xml.models["error"]=new v(n)}return r.runAsOwner(async()=>p.create(o).then(e=>{this.oView=e;this.oView.setModel(new v(this.oView),"$view");r.setAggregation("rootControl",this.oView);r.getAppComponent().getRootControl().getController().getPlaceholder().hideRootPlaceholder();return s}))};s.createView=async function t(i,r,s,c,u){this.resourceModel=i;this.stableId=r;this.TemplateConverter=c;this.MetaModelConverter=u;const g=this.getContext();const f=g.settings;const d=f.converterType;const h=g.scopeObject;const m=n.getAppComponent(h);let y=m.getRoutingService().getTargetInformationFor(h)?.options?.settings?.fullContextPath??"";if(!y){y=h.getContextPath()??""}const w=m.getMetaModel();const V=m.getManifest();const I=new v(l).setDefaultBindingMode("OneWay");const P=new v(V);let x,D,O;try{const t=await m.getService("routingService");const n=t.getTargetInformationFor(h);const g=V["sap.app"]&&V["sap.app"].crossNavigation&&V["sap.app"].crossNavigation.outbounds||{};const N=h.getNavigation()||{};this._enhanceNavigationConfig(N,g);const T=u.convertTypes(w,m.getEnvironmentCapabilities().getCapabilities());const E=new b(T);E.addApplicationManifest(V);O={appComponent:m,navigation:N,viewLevel:n?.viewLevel,stableId:r,contentDensities:V["sap.ui5"]?.contentDensities,resourceModel:i,fullContextPath:y,isDesktop:l.system.desktop,isPhone:l.system.phone,converterType:M.FreeStylePage};if(h.getViewData){Object.assign(O,h.getViewData());O=S.setPageConfigurationChanges(V,O,m,this.pageId)}O.isShareButtonVisibleForMyInbox=S.getShareButtonVisibilityForMyInbox(m);const F=m.getShellServices();O.converterType=d;O.shellContentDensity=F.getContentDensity();const j=V["sap.fe"];O.sapFeManifestConfiguration=V["sap.fe"];O.retrieveTextFromValueList=j?.form?j?.form?.retrieveTextFromValueList:undefined;D=new v(O);if(O.controlConfiguration){for(const e in O.controlConfiguration){if(e.includes("[")){const t=C(e,w);O.controlConfiguration[t]=O.controlConfiguration[e]}}}x=new o(()=>{try{const t=m.getDiagnostics();const n=t.getIssues().length;const o=c.convertPage(d,w,O,t,y,m.getEnvironmentCapabilities().getCapabilities(),h);const i=t.getIssues();const r=i.slice(n);if(r.length>0){e.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core")}return o}catch(t){e.error(t,t);return{}}},w);const A=y.split("/");const _=this._getFullPathToEntitySet(A,w);const $={bindingContexts:{entitySet:_?w.createBindingContext(_):null,fullContextPath:y?w.createBindingContext(y):null,contextPath:y?w.createBindingContext(y):null,converterContext:x.createBindingContext("/",undefined,{noResolve:true}),viewData:O?D.createBindingContext("/"):null},models:{entitySet:w,fullContextPath:w,contextPath:w,"sap.fe.i18n":i,metaModel:w,device:I,manifest:P,converterContext:x,viewData:D},fullContextPath:y,getConvertedMetadata:()=>T,getDefinitionContext(){return E},getDefinitionForPage(){let e=y;if(e.endsWith("/")){e=e.substring(0,e.length-1)}return E.getPageFor(e)},appComponent:m,viewId:r},R=this._getViewSettings($,f,h,O,s,x,i);h.setModel(x,"_pageModel");h.setPreprocessorContext($);return h.runAsOwner(async()=>p.create(R).then(e=>{this.oView=e;const t=new v(this.oView);a.enhanceViewJSONModel(t);this.oView.setModel(t,"$view");this.oView.setModel(D,"viewData");h.setAggregation("rootControl",this.oView);return s}).catch(async e=>this._createErrorPage(e,R,f.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage",h,s)).catch(t=>e.error(t.message,t)))}catch(t){e.error(t.message,t);throw new Error(`Error while creating view : ${t}`)}};s._enhanceNavigationConfig=function e(t,n){Object.keys(t).forEach(function(e){const o=t[e];let i;if(o.detail&&o.detail.outbound&&n[o.detail.outbound]){i=n[o.detail.outbound];o.detail.outboundDetail={semanticObject:i.semanticObject,action:i.action,parameters:i.parameters}}if(o.create&&o.create.outbound&&n[o.create.outbound]){i=n[o.create.outbound];o.create.outboundDetail={semanticObject:i.semanticObject,action:i.action,parameters:i.parameters}}})};s._getFullPathToEntitySet=function e(t,n){return t.reduce(function(e,t){if(t===""){return e}if(e===""){e=`/${t}`}else{const o=n.getObject(`${e}/$NavigationPropertyBinding/${t}`);if(o&&Object.keys(o).length>0){e+="/$NavigationPropertyBinding"}e+=`/${t}`}return e},"")};s.getView=function e(){return this.oView};s.getInterface=function e(){return this};s.exit=function e(){if(this.oResourceModelService){this.oResourceModelService.destroy()}if(this.oCacheHandlerService){this.oCacheHandlerService.destroy()}this.oFactory.removeGlobalInstance()};return r}(f);let S=function(e){function t(){var t;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++){o[i]=arguments[i]}t=e.call(this,...o)||this;t._oInstanceRegistry={};return t}V(t,e);var n=t.prototype;n.createInstance=async function e(n){t.iCreatingViews++;const o=new P(Object.assign({factory:this},n));return o.initPromise.then(function(){t.iCreatingViews--;return o})};n.removeGlobalInstance=function e(){this._oInstanceRegistry={}};t.getShareButtonVisibilityForMyInbox=function e(t){const n=t.getComponentData();if(n!==undefined&&n.feEnvironment){return n.feEnvironment.getShareControlVisibility()}return undefined};t.getNumberOfViewsInCreationState=function e(){return t.iCreatingViews};t.setPageConfigurationChanges=function e(t,n,o,i){const r=t?.["sap.ui5"]?.routing?.targets??{};let s="";for(const e in r){if(r[e].id===i){s=e;break}}if(s===""){s=i}const a=t?.["sap.ui5"]?.routing?.targets?.[s]?.options?.settings||{};return y(a,n,o,i)};return t}(d);return S},false);
//# sourceMappingURL=TemplatedViewServiceFactory.js.map