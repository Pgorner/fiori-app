/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2024 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/BaseController","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/Placeholder","sap/fe/core/controllerextensions/ViewState","sap/fe/core/helpers/ManifestHelper","sap/fe/core/helpers/SizeHelper","sap/ui/base/BindingParser","sap/ui/core/Element","sap/ui/core/routing/HashChanger","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/thirdparty/URI","../controls/Any"],function(e,t,o,n,i,r,a,s,c,u,l,h,f,g,p){"use strict";var d,m,y,C,P,b,R;var w=a.getRouteTargetNames;var I=t.usingExtension;var v=t.defineUI5Class;function H(e,t,o,n){o&&Object.defineProperty(e,t,{enumerable:o.enumerable,configurable:o.configurable,writable:o.writable,value:o.initializer?o.initializer.call(n):void 0})}function T(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_(e,t)}function _(e,t){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_(e,t)}function M(e,t,o,n,i){var r={};return Object.keys(n).forEach(function(e){r[e]=n[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=o.slice().reverse().reduce(function(o,n){return n(e,t,o)||o},r),i&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(i):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}function A(e,t){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let V=(d=v("sap.fe.core.rootView.RootViewBaseController"),m=I(i),y=I(r),d(C=(P=function(t){function o(){var e;for(var o=arguments.length,n=new Array(o),i=0;i<o;i++){n[i]=arguments[i]}e=t.call(this,...n)||this;H(e,"oPlaceholder",b,e);H(e,"viewState",R,e);e.bIsComputingTitleHierachy=false;return e}T(o,t);var i=o.prototype;i.onInit=function e(){s.init();this._aHelperModels=[]};i.getPlaceholder=function e(){return this.oPlaceholder};i.attachRouteMatchers=function e(){this.oPlaceholder.attachRouteMatchers();this.getAppComponent().getRoutingService().attachAfterRouteMatched({},this._onAfterRouteMatched,this)};i.onExit=function e(){this.getAppComponent().getRoutingService().detachAfterRouteMatched(this._onAfterRouteMatched,this);this.oRouter=undefined;s.exit();this._aHelperModels.forEach(function(e){e.destroy()})};i.getViewFromContainer=function e(t){const o=t.isA("sap.ui.core.ComponentContainer")?t.getComponentInstance().getRootControl():t;return o?.isA("sap.ui.core.mvc.View")?o:undefined};i.getViewsFromPages=function e(t){const o=[];t.forEach(e=>{const t=this.getViewFromContainer(e);if(t!==undefined){o.push(t)}});return o};i.getResourceBundle=function e(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()};i.getRouter=function e(){if(!this.oRouter){this.oRouter=this.getAppComponent().getRouter()}return this.oRouter};i._createHelperModel=function e(){const t=new h;this._aHelperModels.push(t);return t};i.routingIsComplete=async function e(){await(this._oRouteMatchedPromise||Promise.resolve())};i.waitForRightMostViewReady=async function e(t){return new Promise(function(e){const o=t.getParameter("views")??[],n=[];o.forEach(function(e){let t=e;if(e&&e.getComponentInstance){const o=e.getComponentInstance();t=o.getRootControl()}if(t&&t.getController()&&t.getController().pageReady){n.push(t)}});const i=n[n.length-1];if(i&&i.getController().pageReady.isPageReady()){e(i)}else if(i){i.getController().pageReady.attachEventOnce("pageReady",function(){e(i)})}})};i.restoreFocusFromHistory=function e(){switch(history.state.focusInfo.type){case"Row":const e=u.getElementById(history.state.focusInfo.tableId);const t=e.getRowBinding().getCurrentContexts().findIndex(e=>e.getPath()===history.state.focusInfo.contextPathFocus);if(t!==-1){e.focusRow(t)}break;default:u.getElementById(history.state.focusInfo.controlId)?.focus()}history.replaceState(Object.assign(history.state,{focusInfo:null}),"")};i._onAfterRouteMatched=function t(o){if(!this._oRouteMatchedPromise){this._oRouteMatchedPromise=this.waitForRightMostViewReady(o).then(e=>{const t=this.getView().getContent()[0];if(t&&t.getAutoFocus&&!t.getAutoFocus()){t.setProperty("autoFocus",true,true)}const o=this.getAppComponent();this._scrollTablesToLastNavigatedItems();if(o.getEnvironmentCapabilities().getCapabilities().UShell){this.computeTitleHierarchy(e)}const n=o.getRouterProxy().isFocusForced();o.getRouterProxy().setFocusForced(false);if(e.getController()&&e.getController().onPageReady&&e.getParent().onPageReady){e.getParent().onPageReady({forceFocus:n})}if(history.state.focusInfo){this.restoreFocusFromHistory()}else if(!n){o.getRouterProxy().restoreFocusForCurrentHash()}if(this.onContainerReady){this.onContainerReady()}return}).catch(function(t){e.error("An error occurs while computing the title hierarchy and calling focus method",t)}).finally(()=>{this._oRouteMatchedPromise=undefined})}};i._getTitleHierarchyCache=function e(){if(!this.oTitleHierarchyCache){this.oTitleHierarchyCache={}}return this.oTitleHierarchyCache};i.clearTitleHierarchyCache=function e(t){delete this._getTitleHierarchyCache()[t]};i._computeTitleInfo=function e(t,o,n){let i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:"";const r=n.split("/");if(!r[r.length-1].includes("?")){n+="?restoreHistory=true"}else{n+="&restoreHistory=true"}return{title:t,subtitle:o,intent:n,icon:i}};i._formatTitle=function e(t,o,n){let i="";switch(t){case"Value":i=`${o}`;break;case"ValueDescription":i=`${o} (${n})`;break;case"DescriptionValue":i=`${n} (${o})`;break;case"Description":i=`${n}`;break;default:}return i};i._fetchTitleValue=async function t(o){const i=this.getAppComponent(),r=this.getView().getModel(),a=i.getMetaModel(),s=a.getMetaPath(o),u=r.createBindingContext(o),l=a.getObject(`${s}/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value`),h=f.format(l,{context:a.createBindingContext("/")});if(!h){return Promise.resolve("")}if(l.$Function==="odata.concat"){const e=new p({any:h});e.setModel(r);e.setBindingContext(u);const t=e.getBinding("any");if(t?.isA("sap.ui.model.CompositeBinding")){await Promise.all(t.getBindings().map(e=>e.requestValue?.()))}const o=e.getAny();e.destroy();return Promise.resolve(o)}const g=f.format(a.getObject(`${s}/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value/$Path@com.sap.vocabularies.Common.v1.Text`),{context:a.createBindingContext("/")}),d=a.getObject(`${s}/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value/$Path@`),m=[],y=c.complexParser(h),C=new Promise(function(e){const t=n.computeDisplayMode(d);e(t)});m.push(C);const P=y.parts?y.parts[0].path:y.path,b=y.formatter,R=r.bindProperty(P,u,{$$groupId:"$auto.Heroes"});R.initialize();const w=new Promise(function(e){const t=function(o){const n=b?b(o.getSource().getValue()):o.getSource().getValue();R.detachChange(t);e(n)};R.attachChange(t)});m.push(w);if(g){const e=c.complexParser(g);let t=e.parts?e.parts[0].path:e.path;t=P.lastIndexOf("/")>-1?`${P.slice(0,P.lastIndexOf("/"))}/${t}`:t;const o=e.formatter,n=r.bindProperty(t,u,{$$groupId:"$auto.Heroes"});n.initialize();const i=new Promise(function(e){const t=function(i){const r=o?o(i.getSource().getValue()):i.getSource().getValue();n.detachChange(t);e(r)};n.attachChange(t)});m.push(i)}try{const e=await Promise.all(m);let t="";if(typeof e!=="string"){t=this._formatTitle(e[0],e[1],e[2])}return t}catch(t){e.error("Error while fetching the title from the header info :"+t)}return""};i.getAppSpecificHash=function e(){const t=l.getInstance();return t.hrefForAppSpecificHash?g.decode(t.hrefForAppSpecificHash("")):"#/"};i._getHash=function e(){return l.getInstance().getHash()};i.getTitleInfoFromPath=async function e(t){const o=this._getTitleHierarchyCache();if(o[t]){return Promise.resolve(o[t])}const n=this.getAppComponent().getMetaModel();const i=n.getMetaPath(t);const r=n.getObject(`${i}/@com.sap.vocabularies.UI.v1.HeaderInfo/TypeName`);const a=this.getAppSpecificHash();const s=a+t.slice(1);return this._fetchTitleValue(t).then(e=>{const n=this._computeTitleInfo(r,e,s);o[t]=n;return n})};i._ensureHierarchyElementsAreStrings=function e(t){const o=[];for(const e in t){const n=t[e];const i={};for(const e in n){i[e]=typeof n[e]!=="string"?String(n[e]):n[e]}o.push(i)}return o};i._getTargetTypeFromHash=function e(t){const o=this.getAppComponent();let n="";const i=o.getManifestEntry("sap.ui5").routing?.routes??[];for(const e of i){const i=o.getRouter().getRoute(e.name);if(i?.match(t)){const t=w(e.target)[0];n=o.getRouter().getTarget(t)._oOptions.name;break}}return n};i.computeTitleHierarchy=async function t(o){const n=this.getAppComponent(),i=o.getBindingContext(),r=o.getParent(),a=[],s=this.getAppSpecificHash(),c=n.getManifestEntry("sap.app"),u=c.title||"",l=c.subTitle||"",h=c.icon||"";let f,g;if(r&&r._getPageTitleInformation){if(i){if(this._getTargetTypeFromHash("")==="sap.fe.templates.ListReport"){a.push(Promise.resolve(this._computeTitleInfo(u,l,s,h)))}g=i.getPath();const e=g.split("/");let t="";e.shift();e.pop();e.forEach(e=>{t+=`/${e}`;if(!n.getRouter().getRouteInfoByHash(t)){return}const o=n.getMetaModel(),i=o.getMetaPath(t),r=o.getObject(`${i}/@com.sap.vocabularies.Common.v1.ResultContext`);if(!r){a.push(this.getTitleInfoFromPath(t))}})}f=r._getPageTitleInformation();f=this._computeTitleInfo(f.title??"",f.subtitle??"",s+this._getHash());if(i&&g){this._getTitleHierarchyCache()[g]=f}else{this._getTitleHierarchyCache()[s]=f}}else{a.push(Promise.reject("Title information missing in HeaderInfo"))}return Promise.all(a).then(async e=>{const t=this._ensureHierarchyElementsAreStrings(e),o=f.title??"";t.reverse();await n.getShellServices().setHierarchy(t);await this._setShellMenuTitle(n,o,u);return}).catch(function(t){e.error(t)}).finally(()=>{this.bIsComputingTitleHierachy=false}).catch(function(t){e.error(t)})};i.calculateLayout=function e(t,o,n){let i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return""};i.onContextBoundToView=function e(t){if(t){const e=this.getView().getModel("internal").getProperty("/deepestPath"),o=t.getPath();if(!e||e.indexOf(o)!==0){this.getView().getModel("internal").setProperty("/deepestPath",o,undefined,true)}}};i.displayErrorPage=async function e(t,o){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return Promise.resolve(true)};i.updateUIStateForView=function e(t,o){};i.getInstancedViews=function e(){return[]};i.getVisibleViews=function e(){return[]};i._scrollTablesToLastNavigatedItems=function e(){};i.isFclEnabled=function e(){return false};i._setShellMenuTitle=async function e(t,o,n){await t.getShellServices().setTitle(o)};i.getAppContentContainer=function e(){const t=this.getAppComponent();const o=t.getManifestEntry("sap.ui5").routing?.config?.controlId??"appContent";return this.getView().byId(o)};return o}(o),b=M(P.prototype,"oPlaceholder",[m],{configurable:true,enumerable:true,writable:true,initializer:null}),R=M(P.prototype,"viewState",[y],{configurable:true,enumerable:true,writable:true,initializer:null}),P))||C);return V},false);
//# sourceMappingURL=RootViewBaseController.js.map